{"version":3,"names":["AuthService","Token","constructor","this","subscribers","subscribe","callback","push","unsubscribe","filter","sub","notifySubscribers","payload","forEach","signOut","app_store","is_signed_in","checkout_store","userFormData","firstName","lastName","email","mobile_number","country_phone_prefix","manageAnchorSession","login","includes","currentPage","token","CommonService","getBEToken","app_data","Object","assign","params","signIn","getToken","option","rest","__rest","MissingTokenError","data","axios","post","state","error","Error","loginToken","method","isLoggedIn","propertyService","PropertyService","setToken","getExposedGuest","signUp","initializeFacebookSignIn","window","fbAsyncInit","FB","init","appId","cookie","xfbml","version","AppEvents","logPageView","d","s","id","js","fjs","getElementsByTagName","getElementById","createElement","src","parentNode","insertBefore","document","handleCredentialResponse","response","google_token","credential","console","loginWithFacebook","authResponse","log","api","fields","getLoginStatus","createFakeGoogleWrapper","googleLoginWrapper","style","display","classList","add","body","appendChild","google","accounts","renderButton","type","width","googleLoginWrapperButton","querySelector","click","loadGoogleSignInScript","element","script","async","defer","onload","initializeGoogleSignIn","head","initialize","client_id","auto_select","ux_mode","handleGoogleLogin"],"sources":["src/services/api/auth.service.ts"],"sourcesContent":["import { MissingTokenError, Token } from '@/models/Token';\r\nimport app_store from '@/stores/app.store';\r\nimport { TSignInValidator, TSignUpValidator } from '@/validators/auth.validator';\r\nimport axios from 'axios';\r\nimport { PropertyService } from './property.service';\r\nimport { manageAnchorSession } from '@/utils/utils';\r\nimport { checkout_store } from '@/stores/checkout.store';\r\nimport { CommonService } from './common.service';\r\ninterface BaseLoginParams {\r\n  option: 'google' | 'direct';\r\n}\r\n\r\ninterface GoogleLoginParams extends BaseLoginParams {\r\n  option: 'google';\r\n  google_token: string;\r\n}\r\n\r\ninterface DirectLoginParams extends BaseLoginParams {\r\n  option: 'direct';\r\n  params: TSignInValidator;\r\n}\r\n\r\ntype LoginParams = GoogleLoginParams | DirectLoginParams;\r\ninterface LoginSuccessPayload {\r\n  state: 'success';\r\n  token: string;\r\n  payload: {\r\n    method: 'google' | 'direct';\r\n    token?: string;\r\n    params?: TSignInValidator;\r\n  };\r\n}\r\n\r\ninterface LoginFailurePayload {\r\n  state: 'failed';\r\n  error: string;\r\n}\r\n\r\ntype LoginEventPayload = LoginSuccessPayload | LoginFailurePayload;\r\n\r\nexport class AuthService extends Token {\r\n  private subscribers: ((result: LoginEventPayload) => void)[] = [];\r\n\r\n  // public onLoginCompleted(listener: (result: LoginEventPayload) => void) {\r\n  //   this.loginResylt.emit('loginCompleted', listener);\r\n  // }\r\n  public subscribe(callback: (result: LoginEventPayload) => void) {\r\n    this.subscribers.push(callback);\r\n  }\r\n\r\n  public unsubscribe(callback: (result: LoginEventPayload) => void) {\r\n    this.subscribers = this.subscribers.filter(sub => sub !== callback);\r\n  }\r\n\r\n  private notifySubscribers(payload: LoginEventPayload) {\r\n    this.subscribers.forEach(callback => callback(payload));\r\n  }\r\n  public async signOut() {\r\n    app_store.is_signed_in = false;\r\n    checkout_store.userFormData = {\r\n      firstName: null,\r\n      lastName: null,\r\n      email: null,\r\n      mobile_number: null,\r\n      country_phone_prefix: null,\r\n    };\r\n    manageAnchorSession({ login: null }, 'remove');\r\n    if (!['booking', 'checkout'].includes(app_store.currentPage)) {\r\n      app_store.currentPage = 'booking';\r\n    }\r\n    const token = await new CommonService().getBEToken();\r\n    app_store.app_data = { ...app_store.app_data, token };\r\n  }\r\n  public async login(params: LoginParams, signIn: boolean = true) {\r\n    const token = this.getToken();\r\n    const { option, ...rest } = params;\r\n    if (!token) {\r\n      throw new MissingTokenError();\r\n    }\r\n    const { data } = await axios.post(`/Exposed_Guest_SignIn?Ticket=${token}`, option === 'direct' ? (rest as DirectLoginParams).params : { ...rest });\r\n    if (data['ExceptionMsg'] !== '') {\r\n      this.notifySubscribers({\r\n        state: 'failed',\r\n        error: data['ExceptionMsg'],\r\n      });\r\n      throw new Error(data['ExceptionMsg']);\r\n    }\r\n    const loginToken = data['My_Result'];\r\n    if (signIn) {\r\n      app_store.app_data.token = loginToken;\r\n      app_store.is_signed_in = true;\r\n      manageAnchorSession({ login: { method: option, ...rest, isLoggedIn: true, token: loginToken } });\r\n    }\r\n    const propertyService = new PropertyService();\r\n    propertyService.setToken(loginToken);\r\n    propertyService.getExposedGuest();\r\n    this.notifySubscribers({\r\n      state: 'success',\r\n      token: loginToken,\r\n      payload: {\r\n        method: option,\r\n        ...rest,\r\n      },\r\n    });\r\n    return data['My_Result'];\r\n  }\r\n\r\n  public async signUp(params: TSignUpValidator) {\r\n    const token = this.getToken();\r\n    if (!token) {\r\n      throw new MissingTokenError();\r\n    }\r\n    const { data } = await axios.post(`/Exposed_Guest_SignUp?Ticket=${token}`, params);\r\n    if (data['ExceptionMsg'] !== '') {\r\n      throw new Error(data['ExceptionMsg']);\r\n    }\r\n    app_store.app_data.token = data['My_Result'];\r\n  }\r\n\r\n  public initializeFacebookSignIn() {\r\n    window.fbAsyncInit = () => {\r\n      FB.init({\r\n        appId: '1630011277802654',\r\n        cookie: true,\r\n        xfbml: true,\r\n        version: 'v19.0',\r\n      });\r\n\r\n      FB.AppEvents.logPageView();\r\n    };\r\n\r\n    (function (d, s, id) {\r\n      var js,\r\n        fjs = d.getElementsByTagName(s)[0];\r\n      if (d.getElementById(id)) {\r\n        return;\r\n      }\r\n      js = d.createElement(s);\r\n      js.id = id;\r\n      js.src = 'https://connect.facebook.net/en_US/sdk.js';\r\n      fjs.parentNode.insertBefore(js, fjs);\r\n    })(document, 'script', 'facebook-jssdk');\r\n  }\r\n\r\n  private async handleCredentialResponse(response) {\r\n    try {\r\n      const token = await this.login({ option: 'google', google_token: response.credential });\r\n      return { state: 'success', token };\r\n    } catch (error) {\r\n      console.error('Error during Google Sign-In:', error);\r\n      return { state: 'failed', token: '' };\r\n    }\r\n  }\r\n  public async loginWithFacebook() {\r\n    FB.login(function (response) {\r\n      if (response.authResponse) {\r\n        console.log('Welcome!  Fetching your information.... ');\r\n        FB.api('/me', { fields: 'name, email, id' }, function (response) {\r\n          console.log(response);\r\n        });\r\n      } else {\r\n        console.log('User cancelled login or did not fully authorize.');\r\n      }\r\n    });\r\n    FB.getLoginStatus(response => {\r\n      console.log('login status', response);\r\n    });\r\n  }\r\n\r\n  createFakeGoogleWrapper() {\r\n    const googleLoginWrapper = document.createElement('div');\r\n    googleLoginWrapper.style.display = 'none';\r\n    googleLoginWrapper.classList.add('custom-google-button');\r\n    document.body.appendChild(googleLoginWrapper);\r\n    window.google.accounts.id.renderButton(googleLoginWrapper, {\r\n      type: 'icon',\r\n      width: '200',\r\n    });\r\n    const googleLoginWrapperButton = googleLoginWrapper.querySelector('div[role=button]');\r\n    return {\r\n      click: () => {\r\n        (googleLoginWrapperButton as any).click();\r\n      },\r\n    };\r\n  }\r\n  loadGoogleSignInScript(element: any) {\r\n    const script = document.createElement('script');\r\n    script.src = 'https://accounts.google.com/gsi/client';\r\n    script.async = true;\r\n    script.defer = true;\r\n    script.onload = () => this.initializeGoogleSignIn(element);\r\n    document.head.appendChild(script);\r\n  }\r\n  initializeGoogleSignIn(element: any) {\r\n    window.google.accounts.id.initialize({\r\n      client_id: '1035240403483-60urt17notg4vmvjbq739p0soqup0o87.apps.googleusercontent.com',\r\n      callback: async response => {\r\n        this.handleCredentialResponse(response);\r\n      },\r\n      auto_select: true,\r\n      ux_mode: 'popup',\r\n    });\r\n\r\n    element = this.createFakeGoogleWrapper();\r\n    (window as any).handleGoogleLogin = () => {\r\n      element.click();\r\n    };\r\n  }\r\n}\r\n"],"mappings":"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","ignoreList":[]}