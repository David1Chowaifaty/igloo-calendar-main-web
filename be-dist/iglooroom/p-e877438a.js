import{b as e,i as t,V as r}from"./p-813a21ec.js";import{a as n}from"./p-d90a6658.js";import{d as o}from"./p-ba341b0b.js";import{b as i}from"./p-21ce2044.js";import{u as l,c as a}from"./p-f16bb7cf.js";class s{convertPickup(e){let t={};const[r,n]=e.arrival_time.split(":");t={booking_nbr:null,is_remove:false,currency:e.currency,date:e.arrival_date,details:e.flight_details||null,hour:Number(r),minute:Number(n),nbr_of_units:e.number_of_vehicles,selected_option:e.selected_option,total:Number(e.due_upon_booking)};return t}updateBookingStore(t){try{const r=t.My_Result;const{adult_nbr:n,child_nbr:o}=t.My_Params_Check_Availability;const i=this.sortRoomTypes(r,{adult_nbr:n,child_nbr:o});e.roomTypes=[...i.map((e=>{var t;return Object.assign(Object.assign({},e),{rateplans:(t=e.rateplans)===null||t===void 0?void 0:t.map((e=>{var t;return Object.assign(Object.assign({},e),{variations:this.sortVariations((t=e===null||e===void 0?void 0:e.variations)!==null&&t!==void 0?t:[])})}))})}))];e.tax_statement={message:t.My_Result.tax_statement};e.enableBooking=true}catch(e){console.error(e)}}collectRoomTypeIds(e){return e.rt_id?[e.rt_id]:[]}collectRatePlanIds(e){return e.rp_id?[e.rp_id]:[]}generateDays(e,t,r){const n=t;let i=e;const l=[];while(i<n){l.push({date:o.format(i,"yyyy-MM-dd"),amount:r,cost:null});i=o.addDays(i,1)}return l}extractFirstNameAndLastName(e,t){const r=t[e].split(" ");return{first_name:r[0]||null,last_name:r[1]||null}}async fetchAvailabilityData(e,t,r){const o=await n.post(`/Check_Availability`,Object.assign(Object.assign({},e),{room_type_ids:t,rate_plan_ids:r,skip_getting_assignable_units:true,is_specific_variation:true,is_backend:false}));const i=o.data;if(i.ExceptionMsg!==""){throw new Error(i.ExceptionMsg)}return i}sortRoomTypes(e,t){return e.sort(((e,r)=>{var n,o,i,l;if(e.is_available_to_book&&!r.is_available_to_book)return-1;if(!e.is_available_to_book&&r.is_available_to_book)return 1;const a=(n=e.rateplans)===null||n===void 0?void 0:n.some((e=>{var t;return(t=e.variations)===null||t===void 0?void 0:t.some((e=>e.discounted_amount===0||e.discounted_amount===null))}));const s=(o=r.rateplans)===null||o===void 0?void 0:o.some((e=>{var t;return(t=e.variations)===null||t===void 0?void 0:t.some((e=>e.discounted_amount===0||e.discounted_amount===null))}));if(a&&!s)return 1;if(!a&&s)return-1;const u=(i=e.rateplans)===null||i===void 0?void 0:i.some((e=>{var r;return(r=e.variations)===null||r===void 0?void 0:r.some((e=>e.adult_nbr===t.adult_nbr&&e.child_nbr===t.child_nbr))}));const d=(l=r.rateplans)===null||l===void 0?void 0:l.some((e=>{var r;return(r=e.variations)===null||r===void 0?void 0:r.some((e=>e.adult_nbr===t.adult_nbr&&e.child_nbr===t.child_nbr))}));if(u&&!d)return-1;if(!u&&d)return 1;const c=Math.max(...e.rateplans.flatMap((e=>{var t;return(t=e.variations)===null||t===void 0?void 0:t.map((e=>{var t;return(t=e.discounted_amount)!==null&&t!==void 0?t:0}))})));const _=Math.max(...r.rateplans.flatMap((e=>{var t;return(t=e.variations)===null||t===void 0?void 0:t.map((e=>{var t;return(t=e.discounted_amount)!==null&&t!==void 0?t:0}))})));if(c<_)return-1;if(c>_)return 1;return 0}))}sortVariations(e){return e.sort(((e,t)=>{if(t.adult_nbr!==e.adult_nbr){return t.adult_nbr-e.adult_nbr}return t.child_nbr-e.child_nbr}))}}class u{hexToRgb(e){e=e.replace(/^#/,"");var t=parseInt(e.substring(0,2),16);var r=parseInt(e.substring(2,4),16);var n=parseInt(e.substring(4,6),16);return{r:t,g:r,b:n}}rgbToHsl(e){let t=parseInt(e.r);let r=parseInt(e.g);let n=parseInt(e.b);t/=255;r/=255;n/=255;let o=Math.min(t,r,n),i=Math.max(t,r,n),l=i-o,a=0,s=0,u=0;if(l==0)a=0;else if(i==t)a=(r-n)/l%6;else if(i==r)a=(n-t)/l+2;else a=(t-r)/l+4;a=Math.round(a*60);if(a<0)a+=360;u=(i+o)/2;s=l==0?0:l/(1-Math.abs(2*u-1));s=+(s*100).toFixed(1);u=+(u*100).toFixed(1);return{h:Math.round(a),s:Math.round(s),l:Math.round(u)}}hexToHSL(e){const t=this.hexToRgb(e);return this.rgbToHsl(t)}generateColorShades(e){const{h:t,s:r,l:n}=this.hexToHSL(e);let o=[];for(let e=-3;e<=6;e++){let i=n+e*4;o.push({h:t,s:r,l:Math.min(Math.max(i,0),100)})}return o}initTheme(e){let t="#e93e57";let r=null;if(e.space_theme){t=e.space_theme.button_bg_color;r=e.space_theme.button_border_radius}const n=document.documentElement;const o=this.generateColorShades(t);let i=900;o.forEach(((e,t)=>{n.style.setProperty(`--brand-${i}`,`${e.h}, ${e.s}%, ${e.l}%`);if(t===9){i=25}else if(t===8){i=50}else{i=i-100}}));if(!r){return}n.style.setProperty("--radius",r+"px")}}class d{constructor(){this.propertyHelpers=new s;this.colors=new u}async getExposedProperty(r,o=true){var l,a,s,u;const{data:c}=await n.post(`/Get_Exposed_Property`,Object.assign(Object.assign({},r),{currency:i.userPreferences.currency_id,include_sales_rate_plans:true}));const _=c;if(_.ExceptionMsg!==""){throw new Error(_.ExceptionMsg)}if(_.My_Result.tags&&!d.initialized){d.initialized=true;_.My_Result.tags.map((({key:e,value:r})=>{if(!r){return}switch(e){case"header":return t(r,"head","first");case"body":return t(r,"body","first");case"footer":return t(r,"body","last")}}))}if(!i.fetchedBooking){e.roomTypes=[...(a=(l=_.My_Result)===null||l===void 0?void 0:l.roomtypes)!==null&&a!==void 0?a:[]]}if(!i.fetchedBooking){e.roomTypes=[...(u=(s=_.My_Result)===null||s===void 0?void 0:s.roomtypes)!==null&&u!==void 0?u:[]]}if(r.aname||r.perma_link){i.app_data=Object.assign(Object.assign({},i.app_data),{property_id:_.My_Result.id})}i.app_data.displayMode=_.My_Result.be_listing_mode==="grid"?"grid":"default";i.property=Object.assign({},_.My_Result);i.app_data.property_id=_.My_Result.id;if(o){this.colors.initTheme(_.My_Result)}return _.My_Result}async getExposedNonBookableNights(e){var t;const{data:r}=await n.post(`/Get_Exposed_Non_Bookable_Nights`,e);if(r.ExceptionMsg!==""){throw new Error(r.ExceptionMsg)}const o={};(t=r.My_Result)===null||t===void 0?void 0:t.forEach((e=>{o[e.night]=true}));i.nonBookableNights=o;return r.My_Result}async getExposedBookingAvailability(e){const t=this.propertyHelpers.collectRoomTypeIds(e);const r=this.propertyHelpers.collectRatePlanIds(e);const n=await this.propertyHelpers.fetchAvailabilityData(e,t,r);this.propertyHelpers.updateBookingStore(n);return n}async getExposedBooking(e,t=true){const{data:r}=await n.post(`/Get_Exposed_Booking`,Object.assign(Object.assign({},e),{extras:t?[{key:"payment_code",value:""},{key:"prepayment_amount",value:""},{key:"payment_code",value:""},{key:"agent_payment_mode",value:""}]:null}));const o=r;if(o.ExceptionMsg!==""){throw new Error(o.ExceptionMsg)}return o.My_Result}async fetchSetupEntries(){if(i.setup_entries){return i.setup_entries}const{data:e}=await n.post(`/Get_Setup_Entries_By_TBL_NAME_MULTI`,{TBL_NAMES:["_ARRIVAL_TIME","_RATE_PRICING_MODE","_BED_PREFERENCE_TYPE"]});if(e.ExceptionMsg!==""){throw new Error(e.ExceptionMsg)}const t=e.My_Result;const r={arrivalTime:t.filter((e=>e.TBL_NAME==="_ARRIVAL_TIME")),ratePricingMode:t.filter((e=>e.TBL_NAME==="_RATE_PRICING_MODE")),bedPreferenceType:t.filter((e=>e.TBL_NAME==="_BED_PREFERENCE_TYPE"))};i.setup_entries=r;l("arrival_time",r.arrivalTime[0].CODE_NAME);return r}filterRooms(){let t=[];const n=new r;Object.values(e.ratePlanSelections).map((r=>{Object.values(r).map((r=>{if(r.reserved>0){[...new Array(r.reserved)].map(((i,l)=>{var a;const{first_name:s,last_name:u}=this.propertyHelpers.extractFirstNameAndLastName(l,r.guestName);const d=n.getVariationBasedOnInfants({baseVariation:r.checkoutVariations[l],variations:r.ratePlan.variations,infants:r.infant_nbr[l]});t.push({identifier:null,roomtype:r.roomtype,rateplan:r.ratePlan,prepayment_amount_gross:(a=r===null||r===void 0?void 0:r.selected_variation)===null||a===void 0?void 0:a.prepayment_amount_gross,unit:null,smoking_option:r.checkoutSmokingSelection[l],occupancy:{adult_nbr:r.checkoutVariations[l].adult_nbr,children_nbr:r.checkoutVariations[l].child_nbr-r.infant_nbr[l],infant_nbr:r.infant_nbr[l]},bed_preference:r.is_bed_configuration_enabled?r.checkoutBedSelection[l]:null,from_date:o.format(e.bookingAvailabilityParams.from_date,"yyyy-MM-dd"),to_date:o.format(e.bookingAvailabilityParams.to_date,"yyyy-MM-dd"),notes:null,days:d.nights.map((e=>({date:e.night,amount:e.discounted_amount,cost:null}))),guest:{email:null,first_name:s,last_name:u,country_id:null,city:null,mobile:null,address:null,dob:null,subscribe_to_news_letter:null,cci:null}})}))}}))}));return t}async editExposedGuest(e,t){const{data:r}=await n.post(`/Edit_Exposed_Guest`,Object.assign(Object.assign({},e),{book_nbr:t}));if(r.ExceptionMsg!==""){throw new Error(r.ExceptionMsg)}return r.My_Result}async bookUser(){var t,r,l,s,u,d,c,_,v,y,p,f;const b=a.prepaymentAmount;try{let m={email:a.userFormData.email,first_name:a.userFormData.firstName,last_name:a.userFormData.lastName,country_id:a.userFormData.country_id,city:null,mobile:a.userFormData.mobile_number,address:"",country_phone_prefix:a.userFormData.country_phone_prefix,dob:null,subscribe_to_news_letter:true,cci:e.bookingAvailabilityParams.agent&&((r=(t=e.bookingAvailabilityParams.agent)===null||t===void 0?void 0:t.payment_mode)===null||r===void 0?void 0:r.code)==="001"?null:((l=a.payment)===null||l===void 0?void 0:l.code)==="001"?{nbr:(u=(s=a.payment)===null||s===void 0?void 0:s.cardNumber)===null||u===void 0?void 0:u.replace(/ /g,""),holder_name:(d=a.payment)===null||d===void 0?void 0:d.cardHolderName,expiry_month:(c=a.payment)===null||c===void 0?void 0:c.expiry_month.split("/")[0],expiry_year:(_=a.payment)===null||_===void 0?void 0:_.expiry_year.split("/")[1],cvc:a.payment.cvc}:null};const h={assign_units:false,check_in:false,is_pms:false,is_direct:true,language:(y=(v=i===null||i===void 0?void 0:i.userPreferences)===null||v===void 0?void 0:v.language_id)!==null&&y!==void 0?y:"en",agent:e.bookingAvailabilityParams.agent?{id:(p=e.bookingAvailabilityParams.agent)===null||p===void 0?void 0:p.id}:null,is_in_loyalty_mode:e.bookingAvailabilityParams.loyalty,promo_key:(f=e.bookingAvailabilityParams.coupon)!==null&&f!==void 0?f:null,booking:{booking_nbr:"",from_date:o.format(e.bookingAvailabilityParams.from_date,"yyyy-MM-dd"),to_date:o.format(e.bookingAvailabilityParams.to_date,"yyyy-MM-dd"),remark:a.userFormData.message||null,property:{id:i.app_data.property_id},source:{code:i.app_data.isFromGhs?"ghs":new URL(window.location.href).origin,tag:i.app_data.stag,description:""},referrer_site:i.app_data.affiliate?`https://${i.app_data.affiliate.sites[0].url}`:"www.igloorooms.com",currency:i.currencies.find((e=>e.code.toString().toLowerCase()===i.userPreferences.currency_id.toLowerCase())),arrival:{code:a.userFormData.arrival_time},guest:m,rooms:this.filterRooms()},extras:[{key:"payment_code",value:a.payment.code},b>0?{key:"prepayment_amount",value:b}:null,e.bookingAvailabilityParams.agent?{key:"agent_payment_mode",value:e.bookingAvailabilityParams.agent.payment_mode.code}:null,{key:"selected_currency",value:i.userPreferences.currency_id}].filter((e=>e!==null)),pickup_info:a.pickup.location?this.propertyHelpers.convertPickup(a.pickup):null};const{data:E}=await n.post(`/DoReservation`,h);if(E.ExceptionMsg!==""){throw new Error(E.ExceptionMsg)}return E["My_Result"]}catch(e){console.error(e);throw new Error(e)}}async getExposedGuest(){const{data:e}=await n.post(`/Get_Exposed_Guest`,{email:null});if(e.ExceptionMsg!==""){throw new Error(e.ExceptionMsg)}const t=e.My_Result;if(t===null){i.is_signed_in=false;return}a.userFormData=Object.assign(Object.assign({},a.userFormData),{country_id:t.country_id,email:t.email,firstName:t.first_name,lastName:t.last_name,mobile_number:t.mobile,country_phone_prefix:t.country_phone_prefix,id:t.id})}}d.initialized=false;export{d as P};
//# sourceMappingURL=p-e877438a.js.map