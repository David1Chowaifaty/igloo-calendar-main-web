import{a as e}from"./p-d90a6658.js";import{b as n}from"./p-8e40500a.js";import{b as t}from"./p-a62fb862.js";import{d as o}from"./p-ba341b0b.js";class a{constructor(){this.baseUrl="https://gateway.igloorooms.com/IRBE";e.defaults.baseURL=this.baseUrl}initialize(){if(a.isInterceptorAdded){return}e.interceptors.request.use((e=>{if(!a.token){throw new r}e.headers.Authorization=a.token;return e}));a.isInterceptorAdded=true}setToken(e){if(e===a.token){return}a.token=e;this.initialize()}}a.token="";a.isInterceptorAdded=false;class r extends Error{constructor(e="Missing token!!"){super(e);this.name="MissingTokenError"}}class i{async getExposedCancelationDueAmount(n){const{data:t}=await e.post(`/Get_Exposed_Cancelation_Due_Amount`,Object.assign({},n));if(t["ExceptionMsg"]!==""){throw new Error(t.ExceptionMsg)}const o=t["My_Result"];return o}async GeneratePaymentCaller({token:t,params:o,onRedirect:a,onScriptRun:i}){if(!t){throw new r}const{data:s}=await e.post(`/Generate_Payment_Caller`,Object.assign(Object.assign({},o),{callback_url:`https://${n.property.perma_link}.bookingmystay.com/invoice`}));if(s["ExceptionMsg"]!==""){throw new Error(s.ExceptionMsg)}const l=s["My_Result"];if(l.type===1){a(l.caller)}else{i(l.caller)}return l}async RequestBookingCancelation(n){const{data:t}=await e.post(`/Request_Booking_Cancelation`,{BOOK_NBR:n});if(t["ExceptionMsg"]!==""){throw new Error(t.ExceptionMsg)}return t["My_Result"]}async GetExposedApplicablePolicies({params:n,book_date:t}){const{data:o}=await e.post(`/Get_Exposed_Applicable_Policies`,n);if(o["ExceptionMsg"]!==""){throw new Error(o.ExceptionMsg)}const a=o["My_Result"];return{data:a,amount:this.processAlicablePolicies(a,t).amount,room_type_id:n.room_type_id,rate_plan_id:n.rate_plan_id}}processAlicablePolicies(e,n){var t,a,r,i;let s=false;const l=((a=(t=e.find((e=>e.type==="guarantee")))===null||t===void 0?void 0:t.brackets[0])===null||a===void 0?void 0:a.gross_amount)||0;let c=e.find((e=>{var t;return e.type==="cancelation"&&((t=e===null||e===void 0?void 0:e.brackets)===null||t===void 0?void 0:t.some((e=>o.isBefore(n,new Date(e.due_on))),n))}));if(c){s=true;const e=(i=(r=c.brackets.find((e=>o.isBefore(new Date(e.due_on),n))))===null||r===void 0?void 0:r.gross_amount)!==null&&i!==void 0?i:null;return{amount:e>l?e:l,isInFreeCancelationZone:s}}return{amount:l,isInFreeCancelationZone:s}}async fetchCancelationMessage(e){var o,a;let r;if("data"in e&&e.data){r=e.data}else{console.log("fetching cancelation message");const{id:a,roomTypeId:i,bookingNbr:s=((o=t.fictus_booking_nbr)===null||o===void 0?void 0:o.nbr)}=e;const l=await this.GetExposedApplicablePolicies({book_date:new Date,params:{booking_nbr:s,currency_id:n.currencies.find((e=>e.code.toLowerCase()===(n.userPreferences.currency_id.toLowerCase()||"usd"))).id,language:n.userPreferences.language_id,property_id:n.app_data.property_id,rate_plan_id:a,room_type_id:i}});r=l.data}const i=(a=r.find((e=>e.type==="cancelation")))===null||a===void 0?void 0:a.combined_statement;return{message:i?`${e.showCancelation?"<b><u>Cancellation: </u></b>":""}${i}<br/>`:"<span></span>",data:r}}async getBookingPrepaymentAmount(e){var t,o;const a=this.setUpBooking(e);let r=await Promise.all(a.map((t=>this.GetExposedApplicablePolicies({book_date:new Date(e.booked_on.date),params:{booking_nbr:t.booking_nbr,currency_id:e.currency.id,language:n.userPreferences.language_id,rate_plan_id:t.ratePlanId,room_type_id:t.roomTypeId,property_id:n.property.id}}))));const i=(t=r[0].data.find((e=>e.type==="cancelation")))===null||t===void 0?void 0:t.combined_statement;const s=(o=r[0].data.find((e=>e.type==="guarantee")))===null||o===void 0?void 0:o.combined_statement;const l=r.map(((e,n)=>{const t=e.data.find((e=>e.type==="cancelation"));const{rp_name:o,rt_name:r}=a[n];if(t){return{statement:t.combined_statement,rp_name:o,rt_name:r}}return null})).filter((e=>e!==null));return{amount:r.reduce(((e,n)=>e+n.amount),0),cancelation_message:i,guarantee_message:s,cancelation_policies:l}}setUpBooking(e){let n=[];e.rooms.map((t=>n.push({booking_nbr:e.booking_nbr,ratePlanId:t.rateplan.id,roomTypeId:t.roomtype.id,rp_name:t.rateplan.name,rt_name:t.roomtype.name})));return n}findClosestDate(e){let n=null;for(const t of e){const e=o.parseISO(t.due_on);if(!n||o.isBefore(e,o.parseISO(n.due_on))){n=t}}return n}}export{i as P,a as T};
//# sourceMappingURL=p-e16a1b3d.js.map