import{P as t,M as e,a as r,T as n}from"./p-7fc610bc.js";import{d as o,e as i,i as s,g as a,h as l}from"./p-e859690b.js";import{a as c}from"./p-f81fec0f.js";import{d as u}from"./p-474fd416.js";import{c as d}from"./p-f8394db0.js";class _{constructor(){this.paymentService=new t}validateModeProps(t){if(t.mode===_.MODE_MODIFY_RT&&(!t.rp_id||!t.rt_id)){throw new Error("Missing property: rp_id or rt_id is required in modify_rt mode")}}convertPickup(t){let e={};const[r,n]=t.arrival_time.split(":");e={booking_nbr:null,is_remove:false,currency:t.currency,date:t.arrival_date,details:t.flight_details||null,hour:Number(r),minute:Number(n),nbr_of_units:t.number_of_vehicles,selected_option:t.selected_option,total:Number(t.due_upon_booking)};return e}updateBookingStore(t,e){try{let r=[...o.roomTypes];const n=t.My_Result.roomtypes;if(e.mode===_.MODE_DEFAULT){r=this.updateInventory(r,n);r=this.sortRoomTypes(r,{adult_nbr:e.params.adult_nbr,child_nbr:e.params.child_nbr})}else{r=this.updateRoomTypeRatePlans(r,n,e)}o.roomTypes=r;o.tax_statement={message:t.My_Result.tax_statement};o.enableBooking=true}catch(t){console.error(t)}}validateToken(t){if(!t){throw new e}}collectRoomTypeIds(t){return t.rt_id?[t.rt_id]:[]}collectRatePlanIds(t){return t.rp_id?[t.rp_id]:[]}generateDays(t,e,r){const n=e;let o=t;const i=[];while(o<n){i.push({date:u.format(o,"yyyy-MM-dd"),amount:r,cost:null});o=u.addDays(o,1)}return i}extractFirstNameAndLastName(t,e){const r=e[t].split(" ");return{first_name:r[0]||null,last_name:r[1]||null}}async fetchAvailabilityData(t,e,n,o){const s=await r.post(`/Get_Exposed_Booking_Availability?Ticket=${t}`,Object.assign(Object.assign({},e.params),{identifier:e.identifier,room_type_ids:n,rate_plan_ids:o,skip_getting_assignable_units:true,is_specific_variation:true,is_backend:false}));const a=s.data;if(a.ExceptionMsg!==""){throw new Error(a.ExceptionMsg)}if(a.My_Result.booking_nbr){i("fictus_booking_nbr",{nbr:a.My_Result.booking_nbr});this.validateFreeCancelationZone(t,a.My_Result.booking_nbr)}return a}async validateFreeCancelationZone(t,e){this.paymentService.setToken(t);console.log(c.currencies.find((t=>{var e;return t.code.toLowerCase()===((e=c.userPreferences.currency_id)===null||e===void 0?void 0:e.toLowerCase())})));const r=await this.paymentService.GetExposedApplicablePolicies({book_date:new Date,params:{booking_nbr:e,currency_id:c.currencies.find((t=>t.code.toLowerCase()===(c.userPreferences.currency_id.toLowerCase()||"usd"))).id,language:c.userPreferences.language_id,property_id:c.app_data.property_id,rate_plan_id:0,room_type_id:0},token:t});console.log("applicable policies",r);if(!r){o.isInFreeCancelationZone=true}if(r){const{isInFreeCancelationZone:t}=this.paymentService.processAlicablePolicies(r.data,new Date);console.log(r,t);o.isInFreeCancelationZone=t}}updateInventory(t,e){const r=new Map(e.map((t=>[t.id,t])));return t.reduce(((t,e)=>{const n=r.get(e.id);if(!n){return t}const o=Object.assign(Object.assign({},e),{inventory:n.inventory,pre_payment_amount:n.pre_payment_amount,rateplans:e.rateplans.reduce(((t,e)=>{const r=n.rateplans.find((t=>t.id===e.id));if(!r||!r.is_active||!r.is_booking_engine_enabled){return t}t.push(Object.assign(Object.assign({},r),{variations:e.variations,selected_variation:r.variations?r.variations[0]:null}));return t}),[])});t.push(o);return t}),[])}sortRoomTypes(t,e){return t.sort(((t,r)=>{if(t.inventory===0&&r.inventory!==0)return 1;if(t.inventory!==0&&r.inventory===0)return-1;const n=t.rateplans.some((t=>t.variations.some((t=>t.is_calculated&&(t.amount===0||t.amount===null)))));const o=r.rateplans.some((t=>t.variations.some((t=>t.is_calculated&&(t.amount===0||t.amount===null)))));if(n&&!o)return 1;if(!n&&o)return-1;const i=t.rateplans.some((t=>t.variations.some((t=>t.adult_nbr===e.adult_nbr&&t.child_nbr===e.child_nbr))));const s=r.rateplans.some((t=>t.variations.some((t=>t.adult_nbr===e.adult_nbr&&t.child_nbr===e.child_nbr))));if(i&&!s)return-1;if(!i&&s)return 1;const a=Math.max(...t.rateplans.flatMap((t=>t.variations.map((t=>t.amount)))));const l=Math.max(...r.rateplans.flatMap((t=>t.variations.map((t=>t.amount)))));if(a<l)return-1;if(a>l)return 1;return 0}))}updateRoomTypeRatePlans(t,e,r){var n;const o=t.findIndex((t=>t.id===r.rt_id));if(o===-1){throw new Error("Invalid RoomType")}const i=e.findIndex((t=>t.id===r.rt_id));if(o===-1){throw new Error("Invalid RoomType")}if(i===-1){throw new Error("Invalid New RoomType")}const s=(n=e[i].rateplans)===null||n===void 0?void 0:n.find((t=>t.id===r.rp_id));if(!s){throw new Error("Invalid New Rateplan")}const a=s.variations.find((t=>t.adult_child_offering===r.adultChildConstraint));console.log(s.variations,r.adultChildConstraint);if(!a){throw new Error("Missing variation")}t[o]=Object.assign(Object.assign({},t[o]),{rateplans:t[o].rateplans.map((t=>Object.assign(Object.assign({},t),{variations:t.variations.map((e=>{if(e.adult_child_offering===r.adultChildConstraint&&t.id===r.rp_id){return a}return e}))})))});return t}}_.MODE_MODIFY_RT="modify_rt";_.MODE_DEFAULT="default";const f={userFormData:{},modifiedGuestName:false,pickup:{arrival_date:u.format(new Date,"yyyy-MM-dd")},payment:null,agreed_to_services:false};const{state:y,onChange:p}=d(f);function h(t,e){y.userFormData=Object.assign(Object.assign({},y.userFormData),{[t]:e})}function b(t,e){if(t==="location"&&e===null){y.pickup={arrival_date:u.format(new Date,"yyyy-MM-dd"),location:null}}else{y.pickup=Object.assign(Object.assign({},y.pickup),{[t]:e})}}function m(t){y.pickup=Object.assign(Object.assign({},y.pickup),t)}class w{hexToRgb(t){t=t.replace(/^#/,"");var e=parseInt(t.substring(0,2),16);var r=parseInt(t.substring(2,4),16);var n=parseInt(t.substring(4,6),16);return{r:e,g:r,b:n}}rgbToHsl(t){let e=parseInt(t.r);let r=parseInt(t.g);let n=parseInt(t.b);e/=255;r/=255;n/=255;let o=Math.min(e,r,n),i=Math.max(e,r,n),s=i-o,a=0,l=0,c=0;if(s==0)a=0;else if(i==e)a=(r-n)/s%6;else if(i==r)a=(n-e)/s+2;else a=(e-r)/s+4;a=Math.round(a*60);if(a<0)a+=360;c=(i+o)/2;l=s==0?0:s/(1-Math.abs(2*c-1));l=+(l*100).toFixed(1);c=+(c*100).toFixed(1);return{h:Math.round(a),s:Math.round(l),l:Math.round(c)}}hexToHSL(t){const e=this.hexToRgb(t);return this.rgbToHsl(e)}generateColorShades(t){const{h:e,s:r,l:n}=this.hexToHSL(t);let o=[];for(let t=-3;t<=6;t++){let i=n+t*4;o.push({h:e,s:r,l:Math.min(Math.max(i,0),100)})}return o}initTheme(t){if(t.space_theme){const e=document.documentElement;const r=this.generateColorShades(t.space_theme.button_bg_color);let n=900;r.forEach(((t,r)=>{e.style.setProperty(`--brand-${n}`,`${t.h}, ${t.s}%, ${t.l}%`);if(r===9){n=25}else if(r===8){n=50}else{n=n-100}}));e.style.setProperty("--radius",t.space_theme.button_border_radius+"px")}}}class v extends n{constructor(){super(...arguments);this.propertyHelpers=new _;this.colors=new w}async getExposedProperty(t,n=true){const i=this.getToken();if(!i){throw new e}const{data:a}=await r.post(`/Get_Exposed_Property?Ticket=${i}`,Object.assign(Object.assign({},t),{currency:c.userPreferences.currency_id,include_sales_rate_plans:!!o.bookingAvailabilityParams.agent}));const l=a;if(l.ExceptionMsg!==""){throw new Error(l.ExceptionMsg)}if(l.My_Result.tags){l.My_Result.tags.map((({key:t,value:e})=>{if(!e){return}switch(t){case"header":return s(e,"head","first");case"body":return s(e,"body","first");case"footer":return s(e,"body","last")}}))}if(!c.fetchedBooking){o.roomTypes=[...l.My_Result.roomtypes]}if(t.aname||t.perma_link){c.app_data=Object.assign(Object.assign({},c.app_data),{property_id:l.My_Result.id})}c.property=Object.assign({},l.My_Result);if(n){this.colors.initTheme(l.My_Result)}return l.My_Result}async getExposedBookingAvailability(t){const e=this.getToken();this.propertyHelpers.validateToken(e);this.propertyHelpers.validateModeProps(t);const r=this.propertyHelpers.collectRoomTypeIds(t);const n=this.propertyHelpers.collectRatePlanIds(t);const o=await this.propertyHelpers.fetchAvailabilityData(e,t,r,n);this.propertyHelpers.updateBookingStore(o,t);return o}async getExposedBooking(t,n=true){const o=this.getToken();if(!o){throw new e}const{data:i}=await r.post(`/Get_Exposed_Booking?Ticket=${o}`,Object.assign(Object.assign({},t),{extras:n?[{key:"payment_code",value:""},{key:"prepayment_amount",value:""}]:null}));const s=i;if(s.ExceptionMsg!==""){throw new Error(s.ExceptionMsg)}return s.My_Result}async fetchSetupEntries(){try{const t=this.getToken();if(t){if(c.setup_entries){return c.setup_entries}const{data:e}=await r.post(`/Get_Setup_Entries_By_TBL_NAME_MULTI?Ticket=${t}`,{TBL_NAMES:["_ARRIVAL_TIME","_RATE_PRICING_MODE","_BED_PREFERENCE_TYPE"]});if(e.ExceptionMsg!==""){throw new Error(e.ExceptionMsg)}const n=e.My_Result;const o={arrivalTime:n.filter((t=>t.TBL_NAME==="_ARRIVAL_TIME")),ratePricingMode:n.filter((t=>t.TBL_NAME==="_RATE_PRICING_MODE")),bedPreferenceType:n.filter((t=>t.TBL_NAME==="_BED_PREFERENCE_TYPE"))};c.setup_entries=o;h("arrival_time",o.arrivalTime[0].CODE_NAME);return o}}catch(t){console.error(t);throw new Error(t)}}filterRooms(){let t=[];Object.values(o.ratePlanSelections).map((e=>{Object.values(e).map((e=>{if(e.reserved>0){[...new Array(e.reserved)].map(((r,n)=>{var i;const{first_name:s,last_name:l}=this.propertyHelpers.extractFirstNameAndLastName(n,e.guestName);t.push({identifier:null,roomtype:e.roomtype,rateplan:e.ratePlan,unit:null,smoking_option:e.checkoutSmokingSelection[n],occupancy:{adult_nbr:e.checkoutVariations[n].adult_nbr,children_nbr:e.checkoutVariations[n].child_nbr,infant_nbr:null},bed_preference:e.is_bed_configuration_enabled?e.checkoutBedSelection[n]:null,from_date:u.format(o.bookingAvailabilityParams.from_date,"yyyy-MM-dd"),to_date:u.format(o.bookingAvailabilityParams.to_date,"yyyy-MM-dd"),notes:null,days:this.propertyHelpers.generateDays(o.bookingAvailabilityParams.from_date,o.bookingAvailabilityParams.to_date,+e.checkoutVariations[n].amount/a(o.bookingAvailabilityParams.from_date,o.bookingAvailabilityParams.to_date)),guest:{email:null,first_name:s,last_name:l,country_id:null,city:null,mobile:null,address:null,dob:null,subscribe_to_news_letter:null,cci:["001","004"].includes((i=y.payment)===null||i===void 0?void 0:i.code)?()=>{const t=y.payment;return{nbr:t===null||t===void 0?void 0:t.cardNumber,holder_name:t===null||t===void 0?void 0:t.cardHolderName,expiry_month:t===null||t===void 0?void 0:t.expiry_month.split("/")[0],expiry_year:t===null||t===void 0?void 0:t.expiry_year.split("/")[1],cvc:(t===null||t===void 0?void 0:t.code)==="001"?t.cvc:null}}:null}})}))}}))}));return t}async editExposedGuest(t,e){try{const n=this.getToken();if(n!==null){const{data:o}=await r.post(`/Edit_Exposed_Guest?Ticket=${n}`,Object.assign(Object.assign({},t),{book_nbr:e}));if(o.ExceptionMsg!==""){throw new Error(o.ExceptionMsg)}return o.My_Result}}catch(t){console.log(t);throw new Error(t)}}async bookUser(){var t;const{prePaymentAmount:n}=l();try{const i=this.getToken();if(!i){throw new e}let s={email:y.userFormData.email,first_name:y.userFormData.firstName,last_name:y.userFormData.lastName,country_id:y.userFormData.country_id,city:null,mobile:y.userFormData.mobile_number,address:"",country_phone_prefix:y.userFormData.country_phone_prefix,dob:null,subscribe_to_news_letter:true,cci:null};const a={assign_units:false,check_in:false,is_pms:false,is_direct:true,agent:o.bookingAvailabilityParams.agent?{id:o.bookingAvailabilityParams.agent}:null,is_in_loyalty_mode:o.bookingAvailabilityParams.loyalty,promo_key:(t=o.bookingAvailabilityParams.coupon)!==null&&t!==void 0?t:null,booking:{booking_nbr:"",from_date:u.format(o.bookingAvailabilityParams.from_date,"yyyy-MM-dd"),to_date:u.format(o.bookingAvailabilityParams.to_date,"yyyy-MM-dd"),remark:y.userFormData.message||null,property:{id:c.app_data.property_id},source:c.app_data.source,referrer_site:c.app_data.affiliate?`https://${c.app_data.affiliate.sites[0].url}`:"www.igloorooms.com",currency:c.property.currency,arrival:{code:y.userFormData.arrival_time},guest:s,rooms:this.filterRooms()},extras:[{key:"payment_code",value:y.payment.code},{key:"prepayment_amount",value:n}],pickup_info:y.pickup.location?this.propertyHelpers.convertPickup(y.pickup):null};const{data:l}=await r.post(`/DoReservation?Ticket=${i}`,a);if(l.ExceptionMsg!==""){throw new Error(l.ExceptionMsg)}return l["My_Result"]}catch(t){console.error(t);throw new Error(t)}}async getExposedGuest(){const t=this.getToken();if(!t){throw new e}const{data:n}=await r.post(`/Get_Exposed_Guest?Ticket=${t}`,{email:null});if(n.ExceptionMsg!==""){throw new Error(n.ExceptionMsg)}const o=n.My_Result;if(o===null){c.is_signed_in=false;return}y.userFormData=Object.assign(Object.assign({},y.userFormData),{country_id:o.country_id,email:o.email,firstName:o.first_name,lastName:o.last_name,mobile_number:o.mobile,country_phone_prefix:o.country_phone_prefix,id:o.id})}}export{v as P,b as a,m as b,y as c,p as o,h as u};
//# sourceMappingURL=p-02388b03.js.map