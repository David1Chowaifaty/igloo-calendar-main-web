import{b as e,m as t,i as r,d as n}from"./p-a62fb862.js";import{a as o}from"./p-d90a6658.js";import{P as i}from"./p-e16a1b3d.js";import{b as a}from"./p-8e40500a.js";import{d as s}from"./p-ba341b0b.js";import{u as l,c as u}from"./p-3f95adf7.js";class d{constructor(){this.paymentService=new i}validateModeProps(e){if(e.mode===d.MODE_MODIFY_RT&&(!e.rp_id||!e.rt_id)){throw new Error("Missing property: rp_id or rt_id is required in modify_rt mode")}}convertPickup(e){let t={};const[r,n]=e.arrival_time.split(":");t={booking_nbr:null,is_remove:false,currency:e.currency,date:e.arrival_date,details:e.flight_details||null,hour:Number(r),minute:Number(n),nbr_of_units:e.number_of_vehicles,selected_option:e.selected_option,total:Number(e.due_upon_booking)};return t}updateBookingStore(t,r){try{let n=[...e.roomTypes];const o=t.My_Result.roomtypes;if(r.mode===d.MODE_DEFAULT){n=this.updateInventory(n,o);n=this.sortRoomTypes(n,{adult_nbr:r.params.adult_nbr,child_nbr:r.params.child_nbr})}else{n=this.updateRoomTypeRatePlans(n,o,r)}e.roomTypes=n;e.tax_statement={message:t.My_Result.tax_statement};e.enableBooking=true}catch(e){console.error(e)}}collectRoomTypeIds(e){return e.rt_id?[e.rt_id]:[]}collectRatePlanIds(e){return e.rp_id?[e.rp_id]:[]}generateDays(e,t,r){const n=t;let o=e;const i=[];while(o<n){i.push({date:s.format(o,"yyyy-MM-dd"),amount:r,cost:null});o=s.addDays(o,1)}return i}extractFirstNameAndLastName(e,t){const r=t[e].split(" ");return{first_name:r[0]||null,last_name:r[1]||null}}async fetchAvailabilityData(e,r,n){const i=await o.post(`/Get_Exposed_Booking_Availability`,Object.assign(Object.assign({},e.params),{identifier:e.identifier,room_type_ids:r,rate_plan_ids:n,skip_getting_assignable_units:true,is_specific_variation:true,is_backend:false}));const a=i.data;if(a.ExceptionMsg!==""){throw new Error(a.ExceptionMsg)}if(a.My_Result.booking_nbr){t("fictus_booking_nbr",{nbr:a.My_Result.booking_nbr});this.validateFreeCancelationZone(a.My_Result.booking_nbr)}return a}async validateFreeCancelationZone(t){const r=await this.paymentService.GetExposedApplicablePolicies({book_date:new Date,params:{booking_nbr:t,currency_id:a.currencies.find((e=>e.code.toLowerCase()===(a.userPreferences.currency_id.toLowerCase()||"usd"))).id,language:a.userPreferences.language_id,property_id:a.app_data.property_id,rate_plan_id:0,room_type_id:0}});console.log("applicable policies",r);if(!r){e.isInFreeCancelationZone=true}if(r){const{isInFreeCancelationZone:t}=this.paymentService.processAlicablePolicies(r.data,new Date);e.isInFreeCancelationZone=t}}updateInventory(e,t){const r=new Map(t.map((e=>[e.id,e])));return e.reduce(((e,t)=>{const n=r.get(t.id);if(!n){return e}const o=Object.assign(Object.assign({},t),{inventory:n.inventory,pre_payment_amount:n.pre_payment_amount,rateplans:this.updateRatePlan(t.rateplans,n)});e.push(o);return e}),[])}updateRatePlan(t,r){const n=!!e.bookingAvailabilityParams.agent;return t.reduce(((e,t)=>{var o,i;const a=(o=r.rateplans)===null||o===void 0?void 0:o.find((e=>e.id===t.id));if(!a||!a.is_active||!a.is_booking_engine_enabled){return e}e.push(Object.assign(Object.assign({},a),{variations:n?a.variations:t.variations,selected_variation:((i=a.variations)===null||i===void 0?void 0:i.length)>0?a.variations[0]:null}));return e}),[])}sortRoomTypes(e,t){return e.sort(((e,r)=>{var n,o,i,a,s,l;if(e.inventory===0&&r.inventory!==0)return 1;if(e.inventory!==0&&r.inventory===0)return-1;const u=(n=e.rateplans)===null||n===void 0?void 0:n.every((e=>e.is_closed));const d=(o=r.rateplans)===null||o===void 0?void 0:o.every((e=>e.is_closed));if(u&&!d)return 1;if(!u&&d)return-1;const c=(i=e.rateplans)===null||i===void 0?void 0:i.some((e=>{var t;return(t=e===null||e===void 0?void 0:e.variations)===null||t===void 0?void 0:t.some((e=>e.is_calculated&&(e.amount===0||e.amount===null)))}));const _=(a=r.rateplans)===null||a===void 0?void 0:a.some((e=>{var t;return(t=e===null||e===void 0?void 0:e.variations)===null||t===void 0?void 0:t.some((e=>e.is_calculated&&(e.amount===0||e.amount===null)))}));if(c&&!_)return 1;if(!c&&_)return-1;const p=(s=e.rateplans)===null||s===void 0?void 0:s.some((e=>{var r;return(r=e.variations)===null||r===void 0?void 0:r.some((e=>e.adult_nbr===t.adult_nbr&&e.child_nbr===t.child_nbr))}));const v=(l=r.rateplans)===null||l===void 0?void 0:l.some((e=>{var r;return(r=e.variations)===null||r===void 0?void 0:r.some((e=>e.adult_nbr===t.adult_nbr&&e.child_nbr===t.child_nbr))}));if(p&&!v)return-1;if(!p&&v)return 1;const y=Math.max(...e.rateplans.flatMap((e=>{var t;return(t=e===null||e===void 0?void 0:e.variations)===null||t===void 0?void 0:t.map((e=>e.amount))})));const f=Math.max(...r.rateplans.flatMap((e=>{var t;return(t=e===null||e===void 0?void 0:e.variations)===null||t===void 0?void 0:t.map((e=>e.amount))})));if(y<f)return-1;if(y>f)return 1;return 0}))}updateRoomTypeRatePlans(e,t,r){var n;const o=e.findIndex((e=>e.id===r.rt_id));if(o===-1){throw new Error("Invalid RoomType")}const i=t.findIndex((e=>e.id===r.rt_id));if(o===-1){throw new Error("Invalid RoomType")}if(i===-1){throw new Error("Invalid New RoomType")}const a=(n=t[i].rateplans)===null||n===void 0?void 0:n.find((e=>e.id===r.rp_id));if(!a){throw new Error("Invalid New Rateplan")}const s=a.variations.find((e=>e.adult_child_offering===r.adultChildConstraint));if(!s){throw new Error("Missing variation")}e[o]=Object.assign(Object.assign({},e[o]),{rateplans:e[o].rateplans.map((e=>Object.assign(Object.assign({},e),{variations:e.variations.map((t=>{if(t.adult_child_offering===r.adultChildConstraint&&e.id===r.rp_id){return s}return t}))})))});return e}}d.MODE_MODIFY_RT="modify_rt";d.MODE_DEFAULT="default";class c{hexToRgb(e){e=e.replace(/^#/,"");var t=parseInt(e.substring(0,2),16);var r=parseInt(e.substring(2,4),16);var n=parseInt(e.substring(4,6),16);return{r:t,g:r,b:n}}rgbToHsl(e){let t=parseInt(e.r);let r=parseInt(e.g);let n=parseInt(e.b);t/=255;r/=255;n/=255;let o=Math.min(t,r,n),i=Math.max(t,r,n),a=i-o,s=0,l=0,u=0;if(a==0)s=0;else if(i==t)s=(r-n)/a%6;else if(i==r)s=(n-t)/a+2;else s=(t-r)/a+4;s=Math.round(s*60);if(s<0)s+=360;u=(i+o)/2;l=a==0?0:a/(1-Math.abs(2*u-1));l=+(l*100).toFixed(1);u=+(u*100).toFixed(1);return{h:Math.round(s),s:Math.round(l),l:Math.round(u)}}hexToHSL(e){const t=this.hexToRgb(e);return this.rgbToHsl(t)}generateColorShades(e){const{h:t,s:r,l:n}=this.hexToHSL(e);let o=[];for(let e=-3;e<=6;e++){let i=n+e*4;o.push({h:t,s:r,l:Math.min(Math.max(i,0),100)})}return o}initTheme(e){let t="#e93e57";let r=null;if(e.space_theme){t=e.space_theme.button_bg_color;r=e.space_theme.button_border_radius}const n=document.documentElement;const o=this.generateColorShades(t);let i=900;o.forEach(((e,t)=>{n.style.setProperty(`--brand-${i}`,`${e.h}, ${e.s}%, ${e.l}%`);if(t===9){i=25}else if(t===8){i=50}else{i=i-100}}));if(!r){return}n.style.setProperty("--radius",r+"px")}}class _{constructor(){this.propertyHelpers=new d;this.colors=new c}async getExposedProperty(t,n=true){var i,s;const{data:l}=await o.post(`/Get_Exposed_Property`,Object.assign(Object.assign({},t),{currency:a.userPreferences.currency_id,include_sales_rate_plans:true}));const u=l;if(u.ExceptionMsg!==""){throw new Error(u.ExceptionMsg)}if(u.My_Result.tags){u.My_Result.tags.map((({key:e,value:t})=>{if(!t){return}switch(e){case"header":return r(t,"head","first");case"body":return r(t,"body","first");case"footer":return r(t,"body","last")}}))}if(!a.fetchedBooking){e.roomTypes=[...(s=(i=u.My_Result)===null||i===void 0?void 0:i.roomtypes)!==null&&s!==void 0?s:[]]}if(t.aname||t.perma_link){a.app_data=Object.assign(Object.assign({},a.app_data),{property_id:u.My_Result.id})}a.app_data.displayMode=u.My_Result.be_listing_mode==="grid"?"grid":"default";a.property=Object.assign({},u.My_Result);a.app_data.property_id=u.My_Result.id;if(n){this.colors.initTheme(u.My_Result)}return u.My_Result}async getExposedNonBookableNights(e){var t;const{data:r}=await o.post(`/Get_Exposed_Non_Bookable_Nights`,e);if(r.ExceptionMsg!==""){throw new Error(r.ExceptionMsg)}const n={};(t=r.My_Result)===null||t===void 0?void 0:t.forEach((e=>{n[e.night]=true}));a.nonBookableNights=n;return r.My_Result}async getExposedBookingAvailability(e){this.propertyHelpers.validateModeProps(e);const t=this.propertyHelpers.collectRoomTypeIds(e);const r=this.propertyHelpers.collectRatePlanIds(e);const n=await this.propertyHelpers.fetchAvailabilityData(e,t,r);this.propertyHelpers.updateBookingStore(n,e);return n}async getExposedBooking(e,t=true){const{data:r}=await o.post(`/Get_Exposed_Booking`,Object.assign(Object.assign({},e),{extras:t?[{key:"payment_code",value:""},{key:"prepayment_amount",value:""},{key:"payment_code",value:""}]:null}));const n=r;if(n.ExceptionMsg!==""){throw new Error(n.ExceptionMsg)}return n.My_Result}async fetchSetupEntries(){if(a.setup_entries){return a.setup_entries}const{data:e}=await o.post(`/Get_Setup_Entries_By_TBL_NAME_MULTI`,{TBL_NAMES:["_ARRIVAL_TIME","_RATE_PRICING_MODE","_BED_PREFERENCE_TYPE"]});if(e.ExceptionMsg!==""){throw new Error(e.ExceptionMsg)}const t=e.My_Result;const r={arrivalTime:t.filter((e=>e.TBL_NAME==="_ARRIVAL_TIME")),ratePricingMode:t.filter((e=>e.TBL_NAME==="_RATE_PRICING_MODE")),bedPreferenceType:t.filter((e=>e.TBL_NAME==="_BED_PREFERENCE_TYPE"))};a.setup_entries=r;l("arrival_time",r.arrivalTime[0].CODE_NAME);return r}filterRooms(){let t=[];Object.values(e.ratePlanSelections).map((r=>{Object.values(r).map((r=>{if(r.reserved>0){[...new Array(r.reserved)].map(((o,i)=>{const{first_name:a,last_name:l}=this.propertyHelpers.extractFirstNameAndLastName(i,r.guestName);t.push({identifier:null,roomtype:r.roomtype,rateplan:r.ratePlan,unit:null,smoking_option:r.checkoutSmokingSelection[i],occupancy:{adult_nbr:r.checkoutVariations[i].adult_nbr,children_nbr:r.checkoutVariations[i].child_nbr,infant_nbr:null},bed_preference:r.is_bed_configuration_enabled?r.checkoutBedSelection[i]:null,from_date:s.format(e.bookingAvailabilityParams.from_date,"yyyy-MM-dd"),to_date:s.format(e.bookingAvailabilityParams.to_date,"yyyy-MM-dd"),notes:null,days:this.propertyHelpers.generateDays(e.bookingAvailabilityParams.from_date,e.bookingAvailabilityParams.to_date,+r.checkoutVariations[i].amount/n(e.bookingAvailabilityParams.from_date,e.bookingAvailabilityParams.to_date)),guest:{email:null,first_name:a,last_name:l,country_id:null,city:null,mobile:null,address:null,dob:null,subscribe_to_news_letter:null,cci:null}})}))}}))}));return t}async editExposedGuest(e,t){const{data:r}=await o.post(`/Edit_Exposed_Guest`,Object.assign(Object.assign({},e),{book_nbr:t}));if(r.ExceptionMsg!==""){throw new Error(r.ExceptionMsg)}return r.My_Result}async bookUser(){var t,r,n,i,l,d;const c=u.prepaymentAmount;try{console.log("payment",u.payment);let _={email:u.userFormData.email,first_name:u.userFormData.firstName,last_name:u.userFormData.lastName,country_id:u.userFormData.country_id,city:null,mobile:u.userFormData.mobile_number,address:"",country_phone_prefix:u.userFormData.country_phone_prefix,dob:null,subscribe_to_news_letter:true,cci:((t=u.payment)===null||t===void 0?void 0:t.code)==="001"?{nbr:(r=u.payment)===null||r===void 0?void 0:r.cardNumber.replace(/ /g,""),holder_name:(n=u.payment)===null||n===void 0?void 0:n.cardHolderName,expiry_month:(i=u.payment)===null||i===void 0?void 0:i.expiry_month.split("/")[0],expiry_year:(l=u.payment)===null||l===void 0?void 0:l.expiry_year.split("/")[1],cvc:u.payment.cvc}:null};const p={assign_units:false,check_in:false,is_pms:false,is_direct:true,agent:e.bookingAvailabilityParams.agent?{id:e.bookingAvailabilityParams.agent}:null,is_in_loyalty_mode:e.bookingAvailabilityParams.loyalty,promo_key:(d=e.bookingAvailabilityParams.coupon)!==null&&d!==void 0?d:null,booking:{booking_nbr:"",from_date:s.format(e.bookingAvailabilityParams.from_date,"yyyy-MM-dd"),to_date:s.format(e.bookingAvailabilityParams.to_date,"yyyy-MM-dd"),remark:u.userFormData.message||null,property:{id:a.app_data.property_id},source:{code:a.app_data.isFromGhs?"ghs":window.location.href,tag:a.app_data.stag,description:""},referrer_site:a.app_data.affiliate?`https://${a.app_data.affiliate.sites[0].url}`:"www.igloorooms.com",currency:a.currencies.find((e=>e.code.toString().toLowerCase()===a.userPreferences.currency_id.toLowerCase())),arrival:{code:u.userFormData.arrival_time},guest:_,rooms:this.filterRooms()},extras:[c>0?{key:"payment_code",value:u.payment.code}:null,c>0?{key:"prepayment_amount",value:c}:null,{key:"selected_currency",value:a.userPreferences.currency_id}].filter((e=>e!==null)),pickup_info:u.pickup.location?this.propertyHelpers.convertPickup(u.pickup):null};console.log("body");const{data:v}=await o.post(`/DoReservation`,p);if(v.ExceptionMsg!==""){throw new Error(v.ExceptionMsg)}return v["My_Result"]}catch(e){console.error(e);throw new Error(e)}}async getExposedGuest(){const{data:e}=await o.post(`/Get_Exposed_Guest`,{email:null});if(e.ExceptionMsg!==""){throw new Error(e.ExceptionMsg)}const t=e.My_Result;if(t===null){a.is_signed_in=false;return}u.userFormData=Object.assign(Object.assign({},u.userFormData),{country_id:t.country_id,email:t.email,firstName:t.first_name,lastName:t.last_name,mobile_number:t.mobile,country_phone_prefix:t.country_phone_prefix,id:t.id})}}export{_ as P};
//# sourceMappingURL=p-59ab3c21.js.map