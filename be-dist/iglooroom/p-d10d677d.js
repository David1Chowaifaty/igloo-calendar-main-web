import{b as e,a}from"./p-21ce2044.js";import{r as n,b as t}from"./p-813a21ec.js";import{a as o}from"./p-d90a6658.js";import{d as r}from"./p-ba341b0b.js";class i{async getExposedCancelationDueAmount(e){const{data:a}=await o.post(`/Get_Exposed_Cancelation_Due_Amount`,Object.assign({},e));if(a["ExceptionMsg"]!==""){throw new Error(a.ExceptionMsg)}const n=a["My_Result"];return n}async GeneratePaymentCaller({token:a,params:t,onRedirect:r,onScriptRun:i}){const{data:l}=await o.post("/Generate_Payment_Caller",Object.assign(Object.assign({},t),{callback_url:n(e.property.perma_link)}),{headers:{Authorization:a}});if(l["ExceptionMsg"]!==""){throw new Error(l.ExceptionMsg)}const s=l["My_Result"];if(s.type===1){r(s.caller)}else{i(s.caller)}return s}async RequestBookingCancellation(e){const{data:a}=await o.post(`/Request_Booking_Cancelation`,{BOOK_NBR:e});if(a["ExceptionMsg"]!==""){throw new Error(a.ExceptionMsg)}return a["My_Result"]}async GetExposedApplicablePolicies({params:e,book_date:a}){const{data:n}=await o.post(`/Get_Exposed_Applicable_Policies`,e);if(n["ExceptionMsg"]!==""){throw new Error(n.ExceptionMsg)}const t=n["My_Result"];return{data:t,amount:this.processAlicablePolicies(t,a).amount,room_type_id:e.room_type_id,rate_plan_id:e.rate_plan_id}}processAlicablePolicies(e,a){var n,t,o,i;const l=((t=(n=e.find((e=>e.type==="guarantee")))===null||n===void 0?void 0:n.brackets[0])===null||t===void 0?void 0:t.gross_amount)||0;let s=e.find((e=>{var n;return e.type==="cancelation"&&((n=e===null||e===void 0?void 0:e.brackets)===null||n===void 0?void 0:n.some((e=>r.isBefore(new Date(e.due_on),a)||r.isSameDay(new Date(e.due_on),a))))}));if(s){const e=(i=(o=s.brackets.find((e=>r.isBefore(new Date(e.due_on),a)||r.isSameDay(new Date(e.due_on),a))))===null||o===void 0?void 0:o.gross_amount)!==null&&i!==void 0?i:null;return{amount:e>l?e:l}}return{amount:l}}checkFreeCancelationZone(e){const a=new Date;let n=false;let t=e===null||e===void 0?void 0:e.find((e=>{var n;return e.type==="cancelation"&&((n=e===null||e===void 0?void 0:e.brackets)===null||n===void 0?void 0:n.some((e=>r.isBefore(new Date(e.due_on),a)||r.isSameDay(new Date(e.due_on),a))))}));if(!t){n=true}return n}getCancelationMessage(e,n=false,t=true){var o,r;const i=(o=e.find((e=>e.type==="cancelation")))===null||o===void 0?void 0:o.combined_statement;let l=i?`${n?`<b><u>${a.entries.Lcz_Cancelation}: </u></b>`:""}${i}<br/>`:"<span></span>";if(t){const t=(r=e.find((e=>e.type==="guarantee")))===null||r===void 0?void 0:r.combined_statement;if(t){l+=`${n?`<b><u>${a.entries.Lcz_Guarantee}: </u></b>`:""}${t}<br/>`}}return{message:l,data:e}}async fetchCancelationMessage(a){var n,o;let r;if("data"in a&&a.data){r=a.data}else{const{id:o,roomTypeId:i,bookingNbr:l=((n=t.fictus_booking_nbr)===null||n===void 0?void 0:n.nbr)}=a;const s=await this.GetExposedApplicablePolicies({book_date:new Date,params:{booking_nbr:l,currency_id:e.currencies.find((a=>a.code.toLowerCase()===(e.userPreferences.currency_id.toLowerCase()||"usd"))).id,language:e.userPreferences.language_id,property_id:e.app_data.property_id,rate_plan_id:o,room_type_id:i}});r=s.data}const i=(o=r.find((e=>e.type==="cancelation")))===null||o===void 0?void 0:o.combined_statement;return{message:i?`${a.showCancelation?"<b><u>Cancellation: </u></b>":""}${i}<br/>`:"<span></span>",data:r}}async getBookingPrepaymentAmount(a){var n,t;const o=this.setUpBooking(a);let r=await Promise.all(o.map((n=>this.GetExposedApplicablePolicies({book_date:new Date(a.booked_on.date),params:{booking_nbr:n.booking_nbr,currency_id:a.currency.id,language:e.userPreferences.language_id,rate_plan_id:n.ratePlanId,room_type_id:n.roomTypeId,property_id:e.property.id}}))));const i=(n=r[0].data.find((e=>e.type==="cancelation")))===null||n===void 0?void 0:n.combined_statement;const l=(t=r[0].data.find((e=>e.type==="guarantee")))===null||t===void 0?void 0:t.combined_statement;const s=r.map(((e,a)=>{const n=e.data.find((e=>e.type==="cancelation"));const{rp_name:t,rt_name:r}=o[a];if(n){return{statement:n.combined_statement,rp_name:t,rt_name:r}}return null})).filter((e=>e!==null));return{amount:r.reduce(((e,a)=>e+a.amount),0),cancelation_message:i,guarantee_message:l,cancelation_policies:s}}setUpBooking(e){let a=[];e.rooms.map((n=>a.push({booking_nbr:e.booking_nbr,ratePlanId:n.rateplan.id,roomTypeId:n.roomtype.id,rp_name:n.rateplan.name,rt_name:n.roomtype.name})));return a}findClosestDate(e){let a=null;for(const n of e){const e=r.parseISO(n.due_on);if(!a||r.isBefore(e,r.parseISO(a.due_on))){a=n}}return a}}export{i as P};
//# sourceMappingURL=p-d10d677d.js.map