{"file":"auth.service.js","mappings":"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","names":[],"sources":["src/services/api/auth.service.ts"],"sourcesContent":["import { MissingTokenError, Token } from '@/models/Token';\r\nimport app_store from '@/stores/app.store';\r\nimport { TSignInValidator, TSignUpValidator } from '@/validators/auth.validator';\r\nimport axios from 'axios';\r\nimport { PropertyService } from './property.service';\r\nimport { manageAnchorSession } from '@/utils/utils';\r\ninterface BaseLoginParams {\r\n  option: 'google' | 'direct';\r\n}\r\n\r\ninterface GoogleLoginParams extends BaseLoginParams {\r\n  option: 'google';\r\n  token: string;\r\n}\r\n\r\ninterface DirectLoginParams extends BaseLoginParams {\r\n  option: 'direct';\r\n  params: TSignInValidator;\r\n}\r\n\r\ntype LoginParams = GoogleLoginParams | DirectLoginParams;\r\ninterface LoginSuccessPayload {\r\n  state: 'success';\r\n  token: string;\r\n  payload: {\r\n    method: 'google' | 'direct';\r\n    token?: string;\r\n    params?: TSignInValidator;\r\n  };\r\n}\r\n\r\ninterface LoginFailurePayload {\r\n  state: 'failed';\r\n  error: string;\r\n}\r\n\r\ntype LoginEventPayload = LoginSuccessPayload | LoginFailurePayload;\r\n\r\nexport class AuthService extends Token {\r\n  private subscribers: ((result: LoginEventPayload) => void)[] = [];\r\n\r\n  // public onLoginCompleted(listener: (result: LoginEventPayload) => void) {\r\n  //   this.loginResylt.emit('loginCompleted', listener);\r\n  // }\r\n  public subscribe(callback: (result: LoginEventPayload) => void) {\r\n    this.subscribers.push(callback);\r\n  }\r\n\r\n  public unsubscribe(callback: (result: LoginEventPayload) => void) {\r\n    this.subscribers = this.subscribers.filter(sub => sub !== callback);\r\n  }\r\n\r\n  private notifySubscribers(payload: LoginEventPayload) {\r\n    this.subscribers.forEach(callback => callback(payload));\r\n  }\r\n\r\n  public async login(params: LoginParams, signIn: boolean = true) {\r\n    const token = this.getToken();\r\n    const { option, ...rest } = params;\r\n    if (!token) {\r\n      throw new MissingTokenError();\r\n    }\r\n    const { data } = await axios.post(`/Exposed_Guest_SignIn?Ticket=${token}`, option === 'direct' ? (rest as DirectLoginParams).params : { ...rest });\r\n    if (data['ExceptionMsg'] !== '') {\r\n      this.notifySubscribers({\r\n        state: 'failed',\r\n        error: data['ExceptionMsg'],\r\n      });\r\n      throw new Error(data['ExceptionMsg']);\r\n    }\r\n    const loginToken = data['My_Result'];\r\n    if (signIn) {\r\n      localStorage.setItem('ir-token', loginToken);\r\n      app_store.app_data.token = loginToken;\r\n      app_store.is_signed_in = true;\r\n      manageAnchorSession({ login: { method: option, ...rest, isLoggedIn: true, token: loginToken } });\r\n    }\r\n    const propertyService = new PropertyService();\r\n    propertyService.setToken(loginToken);\r\n    propertyService.getExposedGuest();\r\n    this.notifySubscribers({\r\n      state: 'success',\r\n      token: loginToken,\r\n      payload: {\r\n        method: option,\r\n        ...rest,\r\n      },\r\n    });\r\n    return data['My_Result'];\r\n  }\r\n\r\n  public async signUp(params: TSignUpValidator) {\r\n    const token = this.getToken();\r\n    if (!token) {\r\n      throw new MissingTokenError();\r\n    }\r\n    const { data } = await axios.post(`/Exposed_Guest_SignUp?Ticket=${token}`, params);\r\n    if (data['ExceptionMsg'] !== '') {\r\n      throw new Error(data['ExceptionMsg']);\r\n    }\r\n    localStorage.setItem('ir-token', data['My_Result']);\r\n    app_store.app_data.token = data['My_Result'];\r\n  }\r\n\r\n  public initializeFacebookSignIn() {\r\n    window.fbAsyncInit = () => {\r\n      FB.init({\r\n        appId: '1630011277802654',\r\n        cookie: true,\r\n        xfbml: true,\r\n        version: 'v19.0',\r\n      });\r\n\r\n      FB.AppEvents.logPageView();\r\n    };\r\n\r\n    (function (d, s, id) {\r\n      var js,\r\n        fjs = d.getElementsByTagName(s)[0];\r\n      if (d.getElementById(id)) {\r\n        return;\r\n      }\r\n      js = d.createElement(s);\r\n      js.id = id;\r\n      js.src = 'https://connect.facebook.net/en_US/sdk.js';\r\n      fjs.parentNode.insertBefore(js, fjs);\r\n    })(document, 'script', 'facebook-jssdk');\r\n  }\r\n\r\n  private async handleCredentialResponse(response) {\r\n    try {\r\n      const token = await this.login({ option: 'google', token: response.credential });\r\n      return { state: 'success', token };\r\n    } catch (error) {\r\n      console.error('Error during Google Sign-In:', error);\r\n      return { state: 'failed', token: '' };\r\n    }\r\n  }\r\n  public async loginWithFacebook() {\r\n    FB.login(function (response) {\r\n      if (response.authResponse) {\r\n        console.log('Welcome!  Fetching your information.... ');\r\n        FB.api('/me', { fields: 'name, email, id' }, function (response) {\r\n          console.log(response);\r\n        });\r\n      } else {\r\n        console.log('User cancelled login or did not fully authorize.');\r\n      }\r\n    });\r\n    FB.getLoginStatus(response => {\r\n      console.log('login status', response);\r\n    });\r\n  }\r\n\r\n  createFakeGoogleWrapper() {\r\n    const googleLoginWrapper = document.createElement('div');\r\n    googleLoginWrapper.style.display = 'none';\r\n    googleLoginWrapper.classList.add('custom-google-button');\r\n    document.body.appendChild(googleLoginWrapper);\r\n    window.google.accounts.id.renderButton(googleLoginWrapper, {\r\n      type: 'icon',\r\n      width: '200',\r\n    });\r\n    const googleLoginWrapperButton = googleLoginWrapper.querySelector('div[role=button]');\r\n    return {\r\n      click: () => {\r\n        (googleLoginWrapperButton as any).click();\r\n      },\r\n    };\r\n  }\r\n  loadGoogleSignInScript(element: any) {\r\n    const script = document.createElement('script');\r\n    script.src = 'https://accounts.google.com/gsi/client';\r\n    script.async = true;\r\n    script.defer = true;\r\n    script.onload = () => this.initializeGoogleSignIn(element);\r\n    document.head.appendChild(script);\r\n  }\r\n  initializeGoogleSignIn(element: any) {\r\n    window.google.accounts.id.initialize({\r\n      client_id: '1035240403483-60urt17notg4vmvjbq739p0soqup0o87.apps.googleusercontent.com',\r\n      callback: async response => {\r\n        this.handleCredentialResponse(response);\r\n      },\r\n      auto_select: true,\r\n      ux_mode: 'popup',\r\n    });\r\n\r\n    element = this.createFakeGoogleWrapper();\r\n    (window as any).handleGoogleLogin = () => {\r\n      element.click();\r\n    };\r\n  }\r\n}\r\n"],"version":3}