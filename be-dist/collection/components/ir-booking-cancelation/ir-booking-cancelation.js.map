{"version":3,"file":"ir-booking-cancelation.js","sourceRoot":"","sources":["../../../src/components/ir-booking-cancelation/ir-booking-cancelation.tsx"],"names":[],"mappings":"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","sourcesContent":["import { Component, Event, EventEmitter, Fragment, h, Method, Prop, State } from '@stencil/core';\r\nimport { isRequestPending } from '@/stores/ir-interceptor.store';\r\nimport { PaymentService, TBookingInfo } from '@/services/api/payment.service';\r\nimport { formatAmount } from '@/utils/utils';\r\nimport { Booking } from '@/models/booking.dto';\r\nimport localizedWords from '@/stores/localization.store';\r\nimport app_store from '@/stores/app.store';\r\nimport { isBefore, isSameDay } from 'date-fns';\r\n\r\n@Component({\r\n  tag: 'ir-booking-cancelation',\r\n  styleUrl: 'ir-booking-cancelation.css',\r\n  shadow: true,\r\n})\r\nexport class IrBookingCancelation {\r\n  @Prop() booking_nbr: string;\r\n  @Prop() cancelation: string;\r\n  @Prop() cancelation_policies: TBookingInfo[] = [];\r\n  @Prop() currency: { code: string; id: number };\r\n  @Prop() booking: Booking;\r\n  @State() paymentAmount: number;\r\n  @State() isLoading: boolean;\r\n  @State() isOpen = false;\r\n  @State() policies: TBookingInfo[] = [];\r\n\r\n  @Event() openChange: EventEmitter<boolean>;\r\n  @Event() cancelationResult: EventEmitter<{ state: 'failed' | 'success'; booking_nbr: string }>;\r\n\r\n  private alertDialog: HTMLIrAlertDialogElement;\r\n  private paymentService = new PaymentService();\r\n\r\n  async setOverdueAmount() {\r\n    try {\r\n      const res = await this.paymentService.GetExposedApplicablePolicies({\r\n        book_date: new Date(),\r\n        params: {\r\n          booking_nbr: this.booking_nbr,\r\n          property_id: this.booking.property.id,\r\n          room_type_id: 0,\r\n          rate_plan_id: 0,\r\n          currency_id: this.booking.currency.id,\r\n          language: app_store.userPreferences.language_id,\r\n        },\r\n      });\r\n      const { data } = res;\r\n      const cancelationBrackets = data.find(d => d.type === 'cancelation');\r\n      const book_date = new Date();\r\n      if (cancelationBrackets) {\r\n        this.paymentAmount = cancelationBrackets.brackets.find(b => isBefore(new Date(b.due_on), book_date) || isSameDay(new Date(b.due_on), book_date))?.gross_amount ?? 0;\r\n      }\r\n      // const res = await this.paymentService.getExposedCancelationDueAmount({\r\n      //   booking_nbr: this.booking_nbr,\r\n      //   currency_id: this.currency.id,\r\n      // });\r\n\r\n      // const overdueResult = res.find(f => f.type === 'overdue');\r\n      // if (overdueResult) {\r\n      //   this.paymentAmount = overdueResult.amount;\r\n      // }\r\n    } catch (error) {\r\n      console.error('Error fetching overdue amount:', error);\r\n    }\r\n  }\r\n  async init() {\r\n    try {\r\n      this.policies = this.cancelation_policies;\r\n      const requests = [];\r\n      if (this.cancelation_policies.length === 0 && this.booking) {\r\n        const prepaymentPromise = this.paymentService.getBookingPrepaymentAmount(this.booking);\r\n        requests.push(prepaymentPromise);\r\n      }\r\n      const overdueAmountPromise = this.setOverdueAmount();\r\n      requests.push(overdueAmountPromise);\r\n      const results = await Promise.all(requests);\r\n      if (this.cancelation_policies.length === 0 && this.booking) {\r\n        const prepaymentResult = results.length > 1 ? results[0] : null;\r\n        if (prepaymentResult) {\r\n          this.policies = prepaymentResult.cancelation_policies ?? this.policies;\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('Error during initialization:', error);\r\n    }\r\n  }\r\n  @Method()\r\n  async openDialog() {\r\n    this.openChange.emit(true);\r\n    this.alertDialog.openModal();\r\n    await this.init();\r\n  }\r\n\r\n  private closeAlertDialog() {\r\n    this.alertDialog.closeModal();\r\n    this.openChange.emit(false);\r\n  }\r\n\r\n  render() {\r\n    const isPending = isRequestPending('/Get_Exposed_Applicable_Policies');\r\n    // const isPending = isRequestPending('/Get_Exposed_Cancelation_Due_Amount');\r\n    return (\r\n      <div>\r\n        <ir-alert-dialog\r\n          ref={el => (this.alertDialog = el)}\r\n          onOpenChange={e => {\r\n            if (!e.detail && this.isOpen) {\r\n              this.isOpen = false;\r\n            }\r\n          }}\r\n        >\r\n          <h2 slot=\"modal-title\" class=\"text-lg font-medium\">\r\n            {localizedWords.entries.Lcz_BookingCancellation}\r\n          </h2>\r\n          <div class=\"py-3\" slot=\"modal-body\">\r\n            {isPending ? (\r\n              <div class=\"h-24\">\r\n                <ir-skeleton class=\"mb-2.5 h-4 w-60\"></ir-skeleton>\r\n              </div>\r\n            ) : (\r\n              <Fragment>\r\n                {this.paymentAmount > 0 ? (\r\n                  <p class=\"mb-2.5 font-semibold\">{`If you cancel now, the penalty will be ${formatAmount(this.paymentAmount, this.currency?.code || 'usd')}.`}</p>\r\n                ) : (\r\n                  <p class=\"mb-2.5 font-semibold\">{localizedWords.entries.Lcz_NoPenalityIsApplied}</p>\r\n                )}\r\n                <button\r\n                  onClick={() => {\r\n                    this.isOpen = !this.isOpen;\r\n                  }}\r\n                  class=\"flex w-full items-center justify-between rounded-md  py-1 \"\r\n                >\r\n                  <p>{localizedWords.entries.Lcz_MoreDetails}</p>\r\n                  <ir-icons name={this.isOpen ? 'angle_up' : 'angle_down'} svgClassName=\"h-3\"></ir-icons>\r\n                </button>\r\n                {this.isOpen && (\r\n                  <Fragment>\r\n                    <div class={'divide-y py-2'}>\r\n                      {this.policies?.map(d => (\r\n                        <div class=\"space-y-1.5 py-2.5\">\r\n                          <p class={'font-medium'}>\r\n                            {d.rt_name} {d.rp_name}\r\n                          </p>\r\n                          <p class=\"text-xs text-gray-500\">{d.statement}</p>\r\n                        </div>\r\n                      ))}\r\n                    </div>\r\n                  </Fragment>\r\n                )}\r\n              </Fragment>\r\n            )}\r\n          </div>\r\n\r\n          <div slot=\"modal-footer\">\r\n            <ir-button\r\n              label={localizedWords.entries.Lcz_Cancel}\r\n              variants=\"outline\"\r\n              onButtonClick={() => {\r\n                this.closeAlertDialog();\r\n              }}\r\n              size=\"md\"\r\n            ></ir-button>\r\n            <ir-button\r\n              disabled={isPending}\r\n              size=\"md\"\r\n              label={localizedWords.entries.Lcz_AcceptAndConfirm}\r\n              isLoading={isRequestPending('/Request_Booking_Cancelation')}\r\n              onButtonClick={async () => {\r\n                try {\r\n                  await this.paymentService.RequestBookingCancelation(this.booking_nbr);\r\n                  this.cancelationResult.emit({ state: 'success', booking_nbr: this.booking_nbr });\r\n                  this.closeAlertDialog();\r\n                } catch (error) {\r\n                  console.error(error);\r\n                  this.cancelationResult.emit({ state: 'failed', booking_nbr: this.booking_nbr });\r\n                }\r\n              }}\r\n            ></ir-button>\r\n          </div>\r\n        </ir-alert-dialog>\r\n      </div>\r\n    );\r\n  }\r\n}\r\n"]}