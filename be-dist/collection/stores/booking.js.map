{"version":3,"file":"booking.js","sourceRoot":"","sources":["../../src/stores/booking.ts"],"names":[],"mappings":"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","sourcesContent":["import { RoomType } from '@/models/property';\r\nimport { createStore } from '@stencil/store';\r\n\r\nexport interface IRatePlanSelection {\r\n  reserved: number;\r\n  visibleInventory: number;\r\n}\r\n\r\nexport interface IRoomTypeSelection {\r\n  [ratePlanId: number]: IRatePlanSelection;\r\n}\r\nexport interface IBookinAvailabilityParams {\r\n  from_date: Date | null;\r\n  to_date: Date | null;\r\n  adult_nbr: number;\r\n  child_nbr: number;\r\n}\r\ninterface BookingStore {\r\n  roomTypes: RoomType[];\r\n  enableBooking: boolean;\r\n  ratePlanSelections: { [roomTypeId: number]: IRoomTypeSelection };\r\n  bookingAvailabilityParams: IBookinAvailabilityParams;\r\n}\r\n\r\nconst initialState: BookingStore = {\r\n  roomTypes: undefined,\r\n  enableBooking: false,\r\n  ratePlanSelections: {},\r\n  bookingAvailabilityParams: {\r\n    from_date: null,\r\n    to_date: null,\r\n    adult_nbr: 1,\r\n    child_nbr: 0,\r\n  },\r\n};\r\n\r\nexport const { state: booking_store, onChange: onRoomTypeChange } = createStore<BookingStore>(initialState);\r\n\r\nonRoomTypeChange('roomTypes', (newValue: RoomType[]) => {\r\n  booking_store.ratePlanSelections = {};\r\n  let ratePlanSelections: { [roomTypeId: number]: IRoomTypeSelection } = {};\r\n  newValue.forEach(roomType => {\r\n    if (roomType.is_active) {\r\n      ratePlanSelections[roomType.id] = {};\r\n      roomType.rateplans.forEach(ratePlan => {\r\n        if (ratePlan.is_active && ratePlan.variations) {\r\n          ratePlanSelections[roomType.id][ratePlan.id] = {\r\n            reserved: 0,\r\n            visibleInventory: roomType.inventory === 1 ? 2 : roomType.inventory,\r\n          };\r\n        }\r\n      });\r\n    }\r\n  });\r\n\r\n  booking_store.ratePlanSelections = { ...ratePlanSelections };\r\n  console.log(booking_store.ratePlanSelections);\r\n});\r\n\r\nexport function updateInventory(roomTypeId: number) {\r\n  const roomTypeSelection = booking_store.ratePlanSelections[roomTypeId];\r\n  const calculateTotalSelectedRoomsExcludingIndex = (excludedRatePlanId: number) => {\r\n    return Object.entries(roomTypeSelection).reduce((acc, [ratePlanId, ratePlan]) => {\r\n      return Number(ratePlanId) !== excludedRatePlanId ? acc + ratePlan.reserved : acc;\r\n    }, 0);\r\n  };\r\n  const newRatePlans = Object.fromEntries(\r\n    Object.entries(roomTypeSelection).map(([ratePlanId, ratePlan]) => {\r\n      const totalSelectedRoomsExcludingCurrent = calculateTotalSelectedRoomsExcludingIndex(Number(ratePlanId));\r\n      const roomTypeData = booking_store.roomTypes.find(rt => rt.id === roomTypeId);\r\n      const availableRooms = roomTypeData ? (roomTypeData.inventory === 1 ? 2 : roomTypeData.inventory) - totalSelectedRoomsExcludingCurrent : 0;\r\n\r\n      return [\r\n        ratePlanId,\r\n        {\r\n          ...ratePlan,\r\n          visibleInventory: availableRooms > 0 ? availableRooms : 0,\r\n        },\r\n      ];\r\n    }),\r\n  );\r\n  if (JSON.stringify(roomTypeSelection) !== JSON.stringify(newRatePlans)) {\r\n    booking_store.ratePlanSelections = {\r\n      ...booking_store.ratePlanSelections,\r\n      [roomTypeId]: newRatePlans,\r\n    };\r\n  }\r\n}\r\n\r\nexport function reserveRooms(roomTypeId: number, ratePlanId: number, rooms: number) {\r\n  if (!booking_store.ratePlanSelections[roomTypeId]) {\r\n    booking_store.ratePlanSelections[roomTypeId] = {};\r\n  }\r\n\r\n  if (!booking_store.ratePlanSelections[roomTypeId][ratePlanId]) {\r\n    booking_store.ratePlanSelections[roomTypeId][ratePlanId] = { reserved: 0, visibleInventory: 0 };\r\n  }\r\n\r\n  booking_store.ratePlanSelections = {\r\n    ...booking_store.ratePlanSelections,\r\n    [roomTypeId]: {\r\n      ...booking_store.ratePlanSelections[roomTypeId],\r\n      [ratePlanId]: { ...booking_store.ratePlanSelections[roomTypeId][ratePlanId], reserved: rooms },\r\n    },\r\n  };\r\n  updateInventory(roomTypeId);\r\n}\r\n\r\nexport function getVisibleInventory(roomTypeId: number, ratePlanId: number) {\r\n  if (!booking_store.ratePlanSelections || !booking_store.ratePlanSelections[roomTypeId]) {\r\n    return { reserved: 0, visibleInventory: 0 };\r\n  }\r\n  return booking_store.ratePlanSelections[roomTypeId][ratePlanId];\r\n}\r\n\r\nexport function modifyBookingStore(key: keyof BookingStore, value: any) {\r\n  booking_store[key] = value;\r\n}\r\n\r\nexport default booking_store;\r\n"]}