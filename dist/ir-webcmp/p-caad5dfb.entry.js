import{r as t,h as i,H as s,F as e,g as n,c as o}from"./p-53d64953.js";import{T as l}from"./p-a93581f3.js";import{a}from"./p-bf44a732.js";import{B as r,u as c,b as h,o as d,a as u}from"./p-5c247e2c.js";import{R as p}from"./p-8d7aa8e0.js";import{l as g}from"./p-71768c2d.js";import{R as f,A as m,f as v,N as b}from"./p-b48062fd.js";import{h as _}from"./p-6c4ba7c0.js";import{a as y}from"./p-84f11abc.js";import{i as k,c as w}from"./p-c226aa13.js";import{B as x}from"./p-862ebc0f.js";import{P as Y,l as D}from"./p-921432c8.js";import{v as C}from"./p-4ed69de7.js";import{H as M,h as O,u as j}from"./p-b6c1681e.js";import{s as S,u as T,h as P,c as E,a as A}from"./p-206c3d55.js";import{i as I}from"./p-2e94af0d.js";import{U as R}from"./p-e482d1ef.js";import"./p-a973aec7.js";import"./p-b859bcd5.js";const B=".sc-ir-booking-email-logs-h{display:block}";const N=B;const F=class{constructor(i){t(this,i);this.token=new l}componentWillLoad(){if(this.ticket){this.token.setToken(this.ticket)}}handleTicketChange(){if(this.ticket){this.token.setToken(this.ticket)}}render(){return i(s,{key:"35523c9b17d929fafdcf59f8d42b9512258fe213",class:"p-1"},i("ir-interceptor",{key:"80f1a49eecdba5d690549e4931ac7fdabe003690",handledEndpoints:["/Get_Email_log_By_BOOK_NBR"]}),i("ir-toast",{key:"f180737eff98fde63ef42eb590737da6d5121a2c"}),i("div",{key:"8d362bb9eb7398daa1662e392af224d9109d008a",class:"d-flex align-items-center mb-1",style:{gap:"0.5rem"}},i("ir-input-text",{key:"54460685c5d505413f5b49a1ec99cd5da2d13c34",class:"m-0",inputContainerStyle:{margin:"0"},value:this.bookingNumber,onTextChange:t=>this.bookingNumber=t.detail,placeholder:"booking number"}),i("ir-button",{key:"d6f976a931ac5e87e1d83ce3f9a7d290cd9195d8",size:"sm",text:"search",onClickHandler:async()=>{const{data:t}=await a.post("/Get_Email_log_By_BOOK_NBR",{BOOK_NBR:this.bookingNumber});if(t.ExceptionMsg){return}this.data=t.My_Result}})),i("p",{key:"ee11f5c5438899c956ce2c76324713e2495d6888"},JSON.stringify(this.data,null,2)))}static get watchers(){return{ticket:["handleTicketChange"]}}};F.style=N;function L(){const t=new URLSearchParams(window.location.search);const i={};for(const[s,e]of t.entries()){i[s]=e}return i}const z=".sc-ir-booking-listing-h{display:block;height:100%}.logo.sc-ir-booking-listing{height:2rem;width:2rem}.card.sc-ir-booking-listing{overflow-x:auto}.secondary-p.sc-ir-booking-listing{font-size:12px !important}.room-service.sc-ir-booking-listing{display:flex;align-items:center;justify-content:space-between;gap:0.5rem;width:100%;padding:0.25rem 0}.room-name-container.sc-ir-booking-listing{background:#acecff;padding:0.1rem 0.3rem;border-radius:5px}.h-screen.sc-ir-booking-listing{height:100%}.price-span.sc-ir-booking-listing{margin:0;margin-right:5px}.main-container.sc-ir-booking-listing{height:100%;overflow-y:auto}.badge.ct_ir_badge.sc-ir-booking-listing{padding:0.2rem 0.3rem}.yellow_dot.sc-ir-booking-listing{height:0.5rem;width:0.5rem;height:0.5rem;width:0.8rem;border-radius:50%;background:rgb(244, 213, 82);margin-left:0.5rem;display:inline-flex;padding:0;margin:0}.booking_name.sc-ir-booking-listing{display:flex;align-items:center;gap:0.4rem}.bg-ir-red.sc-ir-booking-listing{background:#ff4961;padding:0.2rem 0.3rem}.due-btn.sc-ir-booking-listing{border:1px solid #ff4961;color:#ff4961;cursor:pointer;padding:1px 0.25rem !important;font-size:12px !important}.due-btn.sc-ir-booking-listing:hover{background:#ff4961;color:white}.booking_number.sc-ir-booking-listing{all:unset;cursor:pointer}.booking_number.sc-ir-booking-listing:hover{color:#1e9ff2}.in-out.sc-ir-booking-listing{width:150px !important}.booking_guest_name.sc-ir-booking-listing{width:fit-content;padding:0 !important;margin:0}.booking_guest_name.sc-ir-booking-listing .button-text.sc-ir-booking-listing{padding:0 !important}.buttons-container.sc-ir-booking-listing{gap:10px}td.sc-ir-booking-listing ul.sc-ir-booking-listing{width:max-content !important}td.sc-ir-booking-listing{width:max-content !important}.date-p.sc-ir-booking-listing{width:max-content !important;min-width:100%;text-align:center !important}.booking-label-gap.sc-ir-booking-listing{gap:5px}@media (min-width: 1024px){.yellow_dot.sc-ir-booking-listing{height:0.5rem;width:0.5rem}}";const H=z;const $=class{constructor(i){t(this,i);this.language="";this.ticket="";this.rowCount=10;this.isLoading=false;this.currentPage=1;this.totalPages=1;this.oldStartValue=0;this.editBookingItem=null;this.showCost=false;this.bookingListingService=new r;this.bookingService=new x;this.roomService=new p;this.propertyService=new Y;this.token=new l;this.statusColors={"001":"badge-warning","002":"badge-success","003":"badge-danger","004":"badge-danger"}}componentWillLoad(){if(this.baseUrl){this.token.setBaseUrl(this.baseUrl)}c("end_row",this.rowCount);h.rowCount=this.rowCount;if(this.ticket!==""){h.token=this.ticket;this.token.setToken(this.ticket);this.initializeApp()}d("userSelection",(async t=>{const i=t.total_count;this.totalPages=Math.ceil(i/this.rowCount)}));d("bookings",(async t=>{this.showCost=t.some((t=>t.financial.gross_cost!==null&&t.financial.gross_cost>0))}))}ticketChanged(t,i){if(t===i){return}this.token.setToken(this.ticket);h.token=this.ticket;this.initializeApp()}async initializeApp(){var t;try{this.isLoading=true;this.havePrivilege=f(this.userType);let i=this.propertyid;if(!this.havePrivilege){if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}if(!i){const t=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true});i=t.My_Result.id}}const s=[this.bookingService.getSetupEntriesByTableNameMulti(["_PAY_TYPE","_PAY_TYPE_GROUP","_PAY_METHOD"]),this.bookingListingService.getExposedBookingsCriteria(this.havePrivilege?null:i),this.roomService.fetchLanguage(this.language,["_BOOKING_LIST_FRONT"])];let e=null;if(this.propertyid&&!this.havePrivilege){s.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true}))}if(this.havePrivilege){e=s.length;s.push(this.propertyService.getExposedAllowedProperties())}const n=await Promise.all(s);const[o]=n;const{pay_type:l,pay_type_group:a,pay_method:r}=this.bookingService.groupEntryTablesResult(o);this.paymentEntries={groups:a,methods:r,types:l};this.allowedProperties=e!==null?(t=n[e])===null||t===void 0?void 0:t.map((t=>t.id)):null;c("property_id",i);u({property_ids:this.allowedProperties,userTypeCode:this.userType});await this.bookingListingService.getExposedBookings(Object.assign(Object.assign({},h.userSelection),{is_to_export:false}))}catch(t){console.error("Error initializing app:",t)}finally{this.isLoading=false}}handleSideBarToggle(t){if(t.detail){this.editBookingItem=null}}geSearchFiltersFromParams(){const t=L();if(t){console.log("update params");let i={};if(t.e){i["end_row"]=Number(t.e)}if(t.s){i["start_row"]=Number(t.s)}if(t.status){i["booking_status"]=t.status}if(t.filter){i["filter_type"]=t.filter}if(t.from){i["from"]=t.from}if(t.to){i["to"]=t.to}u(i)}console.log("params=>",t)}getPaginationBounds(){const t=h.userSelection.total_count;const i=(this.currentPage-1)*this.rowCount;let s=this.currentPage*this.rowCount;s=s>t?t:s;return{startItem:i,endItem:s,totalCount:t}}openModal(){this.listingModalTimeout=setTimeout((()=>{this.listingModal=this.el.querySelector("ir-listing-modal");this.listingModal.editBooking=this.editBookingItem;this.listingModal.openModal()}),100)}disconnectedCallback(){clearTimeout(this.listingModalTimeout)}async handleResetData(t){t.stopImmediatePropagation();t.stopPropagation();await this.bookingListingService.getExposedBookings(Object.assign(Object.assign({},h.userSelection),{is_to_export:false}))}async handleResetStoreData(t){t.stopImmediatePropagation();t.stopPropagation();await this.bookingListingService.getExposedBookings(Object.assign(Object.assign({},h.userSelection),{is_to_export:false}))}handleBookingChanged(t){t.stopImmediatePropagation();t.stopPropagation();h.bookings=[...h.bookings.map((i=>{if(i.booking_nbr===t.detail.booking_nbr){return t.detail}return i}))]}renderItemRange(){const{endItem:t,startItem:i,totalCount:s}=this.getPaginationBounds();return`${g.entries.Lcz_View} ${i+1} - ${t} ${g.entries.Lcz_Of} ${s}`}async updateData(){const{endItem:t,startItem:i}=this.getPaginationBounds();await this.bookingListingService.getExposedBookings(Object.assign(Object.assign({},h.userSelection),{is_to_export:false,start_row:i,end_row:t}))}calculateTotalPersons(t){const i=({adult_nbr:t,children_nbr:i,infant_nbr:s})=>(t!==null&&t!==void 0?t:0)+(i!==null&&i!==void 0?i:0)+(s!==null&&s!==void 0?s:0);return t.rooms.reduce(((t,s)=>i(s.occupancy)+t),0)}render(){var t,n,o,l,a,r,c,d,u,p,f,b,w,x,Y,D,C,M,O,j,S,T,P;if(this.isLoading||this.ticket===""){return i("ir-loading-screen",null)}return i(s,null,i("ir-interceptor",null),i("ir-toast",null),i("div",{class:"p-1 main-container"},i("ir-listing-header",{propertyId:this.propertyid,p:this.p,language:this.language}),i("section",null,i("div",{class:"card p-1 flex-fill m-0 mt-2"},i("table",{class:"table table-striped table-bordered no-footer dataTable"},i("thead",null,i("tr",null,this.havePrivilege&&i("th",{class:"text-left"},"Property"),i("th",{scope:"col",class:"text-center"},(t=g.entries)===null||t===void 0?void 0:t.Lcz_Booking,"#"),i("th",{scope:"col"},(n=g.entries)===null||n===void 0?void 0:n.Lcz_BookedOn),i("th",{scope:"col"},(o=g.entries)===null||o===void 0?void 0:o.Lcz_GuestSource),i("th",{scope:"col",class:"text-left services-cell"},(l=g.entries)===null||l===void 0?void 0:l.Lcz_Services),i("th",{scope:"col",class:"in-out"},(a=g.entries)===null||a===void 0?void 0:a.Lcz_Dates),i("th",{scope:"col"},i("span",{class:"price-span"},(r=g.entries)===null||r===void 0?void 0:r.Lcz_Amount),i("ir-tooltip",{customSlot:true,message:`<span style="width:100%;display:block;">${(c=g.entries)===null||c===void 0?void 0:c.Lcz_BookingBalance}</span><span>${(d=g.entries)===null||d===void 0?void 0:d.Lcz_ClickToSettle}</span>`},i("span",{slot:"tooltip-trigger",class:"m-0 btn due-btn"},(u=g.entries)===null||u===void 0?void 0:u.Lcz_Balance))),this.showCost&&i("th",{scope:"col",class:"services-cell"},(p=g.entries)===null||p===void 0?void 0:p.Lcz_Cost),i("th",{scope:"col"},(f=g.entries)===null||f===void 0?void 0:f.Lcz_Status),i("th",{scope:"col"},i("p",{class:"sr-only"},"actions")))),i("tbody",{class:""},h.bookings.length===0&&i("tr",null,i("td",{colSpan:this.havePrivilege?9:8},(b=g.entries)===null||b===void 0?void 0:b.Lcz_NoDataAvailable)),(w=h.bookings)===null||w===void 0?void 0:w.map((t=>{var s,n,o,l,a;let r=this.statusColors[t.is_requested_to_cancel?"003":t.status.code];const c=t.ota_manipulations?t.ota_manipulations[t.ota_manipulations.length-1]:null;const h=this.calculateTotalPersons(t);return i("tr",{key:t.booking_nbr},this.havePrivilege&&i("td",{class:"text-left"},t.property.name),i("td",{class:"text-left"},i("ir-button",{btn_color:"link",btnStyle:{padding:"0",margin:"0"},onClickHandler:()=>this.editBookingItem={booking:t,cause:"edit"},text:t.booking_nbr}),t.channel_booking_nbr&&i("p",{class:"p-0 m-0 text-center secondary-p"},t.channel_booking_nbr)),i("td",null,i("p",{class:"p-0 m-0 date-p"},_(t.booked_on.date,"YYYY-MM-DD").format("DD-MMM-YYYY")),i("p",{class:"p-0 m-0 secondary-p"},y(t.booked_on.hour.toString(),t.booked_on.minute.toString()))),i("td",null,i("div",{class:"h-100 d-flex align-items-center ",style:{width:"max-content"}},i("img",{class:"mr-2 logo",src:t.origin.Icon,alt:t.origin.Label}),i("div",{class:"text-left"},i("div",{class:"d-flex align-items-center"},i("div",{class:"booking_name m-0 p-0"},i("ir-button",{btn_color:"link",onClickHandler:()=>this.editBookingItem={booking:t,cause:"guest"},text:`${t.guest.first_name} ${(s=t.guest.last_name)!==null&&s!==void 0?s:""}`,btnStyle:{width:"fit-content",padding:"0",margin:"0"},labelStyle:{padding:"0"}}),t.guest.nbr_confirmed_bookings>1&&!t.agent&&i("div",{class:"m-0 p-0"},i("ir-tooltip",{message:`${g.entries.Lcz_BookingsNbr}`.replace("%1",t.guest.nbr_confirmed_bookings.toString()),customSlot:true},i("div",{class:"d-flex align-items-center my-0 p-0",slot:"tooltip-trigger"},i("ir-icons",{style:{"--icon-size":"0.875rem"},color:"#FB0AAD",name:"heart-fill"})))),i("span",{class:"p-0 m-0"},h,g.entries.Lcz_P),m(t.extras)&&i("span",{class:"yellow_dot"}))),i("div",{class:"d-flex align-items-center booking-label-gap"},i("p",{class:"p-0 m-0 secondary-p"},t.origin.Label),t.is_in_loyalty_mode&&!t.promo_key&&i("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512",height:18,width:18},i("title",null,g.entries.Lcz_LoyaltyDiscountApplied),i("path",{fill:"#fc6c85",d:"M225.8 468.2l-2.5-2.3L48.1 303.2C17.4 274.7 0 234.7 0 192.8v-3.3c0-70.4 50-130.8 119.2-144C158.6 37.9 198.9 47 231 69.6c9 6.4 17.4 13.8 25 22.3c4.2-4.8 8.7-9.2 13.5-13.3c3.7-3.2 7.5-6.2 11.5-9c0 0 0 0 0 0C313.1 47 353.4 37.9 392.8 45.4C462 58.6 512 119.1 512 189.5v3.3c0 41.9-17.4 81.9-48.1 110.4L288.7 465.9l-2.5 2.3c-8.2 7.6-19 11.9-30.2 11.9s-22-4.2-30.2-11.9zM239.1 145c-.4-.3-.7-.7-1-1.1l-17.8-20c0 0-.1-.1-.1-.1c0 0 0 0 0 0c-23.1-25.9-58-37.7-92-31.2C81.6 101.5 48 142.1 48 189.5v3.3c0 28.5 11.9 55.8 32.8 75.2L256 430.7 431.2 268c20.9-19.4 32.8-46.7 32.8-75.2v-3.3c0-47.3-33.6-88-80.1-96.9c-34-6.5-69 5.4-92 31.2c0 0 0 0-.1 .1s0 0-.1 .1l-17.8 20c-.3 .4-.7 .7-1 1.1c-4.5 4.5-10.6 7-16.9 7s-12.4-2.5-16.9-7z"})),t.promo_key&&i("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",height:18,width:18},i("title",null,g.entries.Lcz_Coupon+":"+t.promo_key),i("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M16.5 6v.75m0 3v.75m0 3v.75m0 3V18m-9-5.25h5.25M7.5 15h3M3.375 5.25c-.621 0-1.125.504-1.125 1.125v3.026a2.999 2.999 0 0 1 0 5.198v3.026c0 .621.504 1.125 1.125 1.125h17.25c.621 0 1.125-.504 1.125-1.125v-3.026a2.999 2.999 0 0 1 0-5.198V6.375c0-.621-.504-1.125-1.125-1.125H3.375Z"})))))),i("td",null,i("ul",null,t.rooms.map((t=>{var s,e,n,o,l,a,r;return i("li",null,i("div",{class:"room-service"},i("p",{class:"m-0 p-0"},t.roomtype.name),t.unit&&!k(t.roomtype.id)&&(((e=(s=t.unit)===null||s===void 0?void 0:s.name)===null||e===void 0?void 0:e.length)>4?i("ir-tooltip",{customSlot:true,message:(n=t.unit)===null||n===void 0?void 0:n.name},i("p",{class:"room-name-container cursor-pointer m-0",slot:"tooltip-trigger"},(l=(o=t.unit)===null||o===void 0?void 0:o.name)===null||l===void 0?void 0:l.substring(0,4))):i("p",{class:"room-name-container  m-0"},(r=(a=t.unit)===null||a===void 0?void 0:a.name)===null||r===void 0?void 0:r.substring(0,4)))))})),t.extra_services&&i("li",null,g.entries.Lcz_ExtraServices))),i("td",null,i("p",{class:"p-0 m-0 date-p"},_(t.from_date,"YYYY-MM-DD").format("DD-MMM-YYYY")),i("p",{class:"p-0 m-0 date-p"},_(t.to_date,"YYYY-MM-DD").format("DD-MMM-YYYY"))),i("td",null,i("p",{class:"p-0 m-0",style:{whiteSpace:"nowrap"}},v(t.currency.symbol,(o=(n=t.financial)===null||n===void 0?void 0:n.gross_total)!==null&&o!==void 0?o:0)),i(e,null,["003","004"].includes(t.status.code)?t.financial.cancelation_penality_as_if_today!==0&&i("button",{onClick:()=>{this.editBookingItem={booking:t,cause:"payment"};this.openModal()},style:{whiteSpace:"nowrap"},class:"btn p-0 m-0 due-btn"},i("span",null,t.financial.cancelation_penality_as_if_today<0?"Refund":"Charge"," "),v(t.currency.symbol,Math.abs(t.financial.cancelation_penality_as_if_today))):t.financial.due_amount!==0&&i("button",{onClick:()=>{this.editBookingItem={booking:t,cause:"payment"};this.openModal()},style:{whiteSpace:"nowrap"},class:"btn p-0 m-0 due-btn"},v(t.currency.symbol,t.financial.due_amount)))),this.showCost&&i("td",null,t.financial.gross_cost!==null&&t.financial.gross_cost===0?"_":v(t.currency.symbol,t.financial.gross_cost)),i("td",null,i("p",{class:`m-0 badge ${r} ct_ir_badge`},t.is_requested_to_cancel?(l=g===null||g===void 0?void 0:g.entries)===null||l===void 0?void 0:l.Lcz_CancellationRequested:t.status.description),!c&&((a=t.events)===null||a===void 0?void 0:a.length)>0&&t.events[0].type.toLowerCase()==="modified"&&i("p",{class:"mx-0 p-0 small",style:{marginTop:"0.25rem",marginBottom:"0"}},"Modified"),c&&i("ir-popover",{trigger:"hover",content:`Modified by ${c.user} at ${c.date} ${c.hour}:${c.minute}`},i("p",{class:"mx-0 p-0 small text-danger",style:{marginTop:"0.25rem",marginBottom:"0"}},i("b",null,"Modified")))),i("td",null,i("div",{class:"d-flex justify-content-center align-items-center",style:{gap:"8px"}},i("ir-button",{title:"Edit booking",variant:"icon",icon_name:"edit",onClickHandler:()=>this.editBookingItem={booking:t,cause:"edit"}}),i("ir-button",{title:"Delete booking",style:{"--icon-button-color":"#ff4961","--icon-button-hover-color":"#FF1635"},variant:"icon",icon_name:"trash",onClickHandler:()=>{this.editBookingItem={booking:t,cause:"delete"};this.openModal()}}))))})))),this.totalPages>1&&i("section",{class:"d-flex flex-column flex-md-row align-items-center justify-content-between pagination-container"},i("p",{class:"m-0 mb-1 mb-md-0"},this.renderItemRange()),i("div",{class:"d-flex align-items-center buttons-container"},i("ir-button",{size:"sm",btn_disabled:this.currentPage===1,onClickHandler:async()=>{this.currentPage=1;await this.updateData()},icon_name:"angles_left",style:{"--icon-size":"0.875rem"}}),i("ir-button",{size:"sm",btn_disabled:this.currentPage===1,onClickHandler:async()=>{this.currentPage=this.currentPage-1;await this.updateData()},icon_name:"angle_left",style:{"--icon-size":"0.875rem"}}),i("ir-select",{selectedValue:this.currentPage.toString(),showFirstOption:false,onSelectChange:async t=>{this.currentPage=+t.detail;await this.updateData()},data:Array.from(Array(this.totalPages),((t,i)=>i+1)).map((t=>({text:t.toString(),value:t.toString()})))}),i("ir-button",{size:"sm",btn_disabled:this.currentPage===this.totalPages,onClickHandler:async()=>{this.currentPage=this.currentPage+1;await this.updateData()},icon_name:"angle_right",style:{"--icon-size":"0.875rem"}}),i("ir-button",{size:"sm",btn_disabled:this.currentPage===this.totalPages,onClickHandler:async()=>{this.currentPage=this.totalPages;console.log(this.currentPage);await this.updateData()},icon_name:"angles_right",style:{"--icon-size":"0.875rem"}})))))),this.editBookingItem&&i("ir-listing-modal",{paymentEntries:this.paymentEntries,onModalClosed:()=>this.editBookingItem=null}),i("ir-sidebar",{onIrSidebarToggle:this.handleSideBarToggle.bind(this),open:this.editBookingItem!==null&&["edit","guest"].includes(this.editBookingItem.cause),showCloseButton:false,sidebarStyles:((x=this.editBookingItem)===null||x===void 0?void 0:x.cause)==="guest"?{background:"white"}:{width:this.editBookingItem?"80rem":"var(--sidebar-width,40rem)",background:"#F2F3F8"}},((Y=this.editBookingItem)===null||Y===void 0?void 0:Y.cause)==="edit"&&i("ir-booking-details",{slot:"sidebar-body",p:this.p,hasPrint:true,hasReceipt:true,is_from_front_desk:true,propertyid:(M=(C=(D=this.editBookingItem)===null||D===void 0?void 0:D.booking)===null||C===void 0?void 0:C.property)===null||M===void 0?void 0:M.id,hasRoomEdit:true,hasRoomDelete:true,hasCloseButton:true,onCloseSidebar:()=>this.editBookingItem=null,bookingNumber:this.editBookingItem.booking.booking_nbr,ticket:this.ticket,language:this.language,hasRoomAdd:true}),((O=this.editBookingItem)===null||O===void 0?void 0:O.cause)==="guest"&&i("ir-guest-info",{slot:"sidebar-body",isInSideBar:true,headerShown:true,booking_nbr:(S=(j=this.editBookingItem)===null||j===void 0?void 0:j.booking)===null||S===void 0?void 0:S.booking_nbr,email:(P=(T=this.editBookingItem)===null||T===void 0?void 0:T.booking)===null||P===void 0?void 0:P.guest.email,language:this.language,onCloseSideBar:()=>this.editBookingItem=null})))}get el(){return n(this)}static get watchers(){return{ticket:["ticketChanged"]}}};$.style=H;const U=".sc-ir-daily-revenue-h{display:block}.daily-revenue__meta.sc-ir-daily-revenue{display:flex;flex-direction:column;gap:1rem}.daily-revenue__table.sc-ir-daily-revenue{flex:1 1 0%}@media (min-width: 768px){.daily-revenue__meta.sc-ir-daily-revenue{flex-direction:row}}";const W=U;const K=class{constructor(i){t(this,i);this.preventPageLoad=o(this,"preventPageLoad",7);this.language="";this.ticket="";this.filters={date:_().format("YYYY-MM-DD"),users:null};this.tokenService=new l;this.roomService=new p;this.propertyService=new Y;this.bookingService=new x;this.handleSidebarClose=t=>{t.stopImmediatePropagation();t.stopPropagation();this.sideBarEvent=null}}componentWillLoad(){if(this.ticket){this.tokenService.setToken(this.ticket);this.initializeApp()}}ticketChanged(t,i){if(t===i){return}this.tokenService.setToken(this.ticket);this.initializeApp()}handleOpenSidebar(t){t.stopImmediatePropagation();t.stopPropagation();this.sideBarEvent=t.detail}handleFetchNewReports(t){t.stopImmediatePropagation();t.stopPropagation();this.filters=Object.assign({},t.detail);this.getPaymentReports()}async handleResetBooking(t){t.stopPropagation();t.stopImmediatePropagation();this.getPaymentReports(false,true)}renderSidebarBody(){if(!this.sideBarEvent){return}switch(this.sideBarEvent.type){case"booking":return i("ir-booking-details",{slot:"sidebar-body",hasPrint:true,hasReceipt:true,hasCloseButton:true,onCloseSidebar:this.handleSidebarClose,is_from_front_desk:true,propertyid:this.property_id,hasRoomEdit:true,hasRoomDelete:true,bookingNumber:this.sideBarEvent.payload.bookingNumber.toString(),ticket:this.ticket,language:this.language,hasRoomAdd:true});default:return null}}async initializeApp(){this.isPageLoading=true;try{let t=this.propertyid;if(!t&&!this.p){throw new Error("Property ID or username is required")}if(!t){const i=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});t=i.My_Result.id}this.property_id=t;const i=[this.bookingService.getSetupEntriesByTableNameMulti(["_PAY_TYPE","_PAY_TYPE_GROUP","_PAY_METHOD"]),this.getPaymentReports(),this.roomService.fetchLanguage(this.language)];if(t){i.push(this.roomService.getExposedProperty({id:t,language:this.language,is_backend:true,include_units_hk_status:true}))}const[s]=await Promise.all(i);const{pay_type:e,pay_type_group:n,pay_method:o}=this.bookingService.groupEntryTablesResult(s);this.paymentEntries={groups:n,methods:o,types:e}}catch(t){console.log(t)}finally{this.isPageLoading=false}}groupPaymentsByName(t){var i;const s=new Map;for(const e of t){const t=`${e.payTypeCode}_${e.payMethodCode}`;const n=(i=s.get(t))!==null&&i!==void 0?i:[];s.set(t,[...n,e])}return new Map([...s.entries()].sort((([t],[i])=>{const s=Number(t);const e=Number(i);if(!isNaN(s)&&!isNaN(e)){return s-e}return t.localeCompare(i)})))}async getPaymentReports(t=false,i=false){var s,e,n,o;try{const l=t=>({method:t.METHOD,payTypeCode:t.PAY_TYPE_CODE,payMethodCode:t.PAY_METHOD_CODE,amount:t.AMOUNT,date:t.DATE,hour:t.HOUR,minute:t.MINUTE,user:t.USER,currency:t.CURRENCY,bookingNbr:t.BOOKING_NBR,id:C()});this.isLoading=t?"export":"filter";const a=[this.propertyService.getDailyRevenueReport({date:this.filters.date,property_id:(s=this.property_id)===null||s===void 0?void 0:s.toString(),is_export_to_excel:t})];if(!t&&!i){a.push(this.propertyService.getDailyRevenueReport({date:_(this.filters.date,"YYYY-MM-DD").add(-1,"days").format("YYYY-MM-DD"),property_id:(e=this.property_id)===null||e===void 0?void 0:e.toString(),is_export_to_excel:t}))}const r=await Promise.all(a);if(!t){if(r[0]){this.groupedPayment=this.groupPaymentsByName((n=r[0])===null||n===void 0?void 0:n.map(l))}else{this.groupedPayment=new Map}if(r[1])this.previousDateGroupedPayments=this.groupPaymentsByName((o=r[1])===null||o===void 0?void 0:o.map(l))}}catch(t){console.log(t)}finally{this.isLoading=null}}render(){var t,e,n;if(this.isPageLoading){return i("ir-loading-screen",null)}return i(s,null,i("ir-toast",null),i("ir-interceptor",null),i("section",{class:"p-2 d-flex flex-column",style:{gap:"1rem"}},i("div",{class:"d-flex align-items-center justify-content-between"},i("h3",{class:"mb-1 mb-md-0"},"Daily Revenue"),i("ir-button",{size:"sm",btn_color:"outline",isLoading:this.isLoading==="export",text:(t=g.entries)===null||t===void 0?void 0:t.Lcz_Export,onClickHandler:async t=>{t.stopImmediatePropagation();t.stopPropagation();await this.getPaymentReports(true)},btnStyle:{height:"100%"},iconPosition:"right",icon_name:"file",icon_style:{"--icon-size":"14px"}})),i("ir-revenue-summary",{previousDateGroupedPayments:this.previousDateGroupedPayments,groupedPayments:this.groupedPayment,paymentEntries:this.paymentEntries}),i("div",{class:"daily-revenue__meta"},i("ir-daily-revenue-filters",{isLoading:this.isLoading==="filter",payments:this.groupedPayment}),i("ir-revenue-table",{filters:this.filters,class:"daily-revenue__table",paymentEntries:this.paymentEntries,payments:this.groupedPayment}))),i("ir-sidebar",{sidebarStyles:{width:((e=this.sideBarEvent)===null||e===void 0?void 0:e.type)==="booking"?"80rem":"var(--sidebar-width,40rem)",background:((n=this.sideBarEvent)===null||n===void 0?void 0:n.type)==="booking"?"#F2F3F8":"white"},open:Boolean(this.sideBarEvent),showCloseButton:false,onIrSidebarToggle:this.handleSidebarClose},this.renderSidebarBody()))}static get watchers(){return{ticket:["ticketChanged"]}}};K.style=W;const q=".sc-ir-hk-tasks-h{display:block;box-sizing:border-box}.sc-ir-hk-tasks-h *.sc-ir-hk-tasks{box-sizing:border-box}.tasks-view.sc-ir-hk-tasks{display:flex;flex-direction:column}@media (min-width: 1024px){.tasks-view.sc-ir-hk-tasks{flex-direction:row}}";const G=q;const V=class{constructor(i){t(this,i);this.clearSelectedHkTasks=o(this,"clearSelectedHkTasks",7);this.language="";this.ticket="";this.isLoading=false;this.isCleaningLoading=false;this.selectedDuration="";this.selectedHouseKeeper="0";this.selectedRoom=null;this.archiveOpened=false;this.hkNameCache={};this.roomService=new p;this.houseKeepingService=new M;this.token=new l;this.table_sorting=new Map}componentWillLoad(){if(this.baseUrl){this.token.setBaseUrl(this.baseUrl)}if(this.ticket!==""){this.token.setToken(this.ticket);this.init()}}ticketChanged(t,i){if(t===i){return}this.token.setToken(this.ticket);this.init()}handleCloseSidebar(t){t.stopImmediatePropagation();t.stopPropagation();this.isSidebarOpen=false}handleSortingChanged(t){t.stopImmediatePropagation();t.stopPropagation();const{field:i,direction:s}=t.detail;console.log(t.detail);if(i==="date"){return}this.table_sorting.set(i,s)}handleSkipSelectedTask(t){var i;t.stopImmediatePropagation();t.stopPropagation();this.modalCauses={task:t.detail,cause:"skip"};(i=this.modal)===null||i===void 0?void 0:i.openModal()}async init(){var t,i,s,e,n,o,l;try{this.isLoading=true;S(true);let a=this.propertyid;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}if(!a){console.log(a);const t=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});a=t.My_Result.id}this.property_id=a;const r=[this.houseKeepingService.getExposedHKSetup(this.property_id),this.roomService.fetchLanguage(this.language)];if(this.propertyid){r.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true,include_units_hk_status:true}))}await Promise.all(r);const c=await this.houseKeepingService.getHkTasks({property_id:this.property_id,from_date:_().format("YYYY-MM-DD"),to_date:_().format("YYYY-MM-DD"),housekeepers:[],cleaning_frequency:(s=(t=w.cleaning_frequency)!==null&&t!==void 0?t:(i=O===null||O===void 0?void 0:O.hk_criteria)===null||i===void 0?void 0:i.cleaning_frequencies[0])===null||s===void 0?void 0:s.code,dusty_window:(n=(e=O===null||O===void 0?void 0:O.hk_criteria)===null||e===void 0?void 0:e.dusty_periods[0])===null||n===void 0?void 0:n.code,highlight_window:(l=(o=O===null||O===void 0?void 0:O.hk_criteria)===null||o===void 0?void 0:o.highlight_checkin_options[0])===null||l===void 0?void 0:l.code});if(c===null||c===void 0?void 0:c.tasks){this.updateTasks(c.tasks)}}catch(t){console.log(t)}finally{this.isLoading=false;S(false)}}buildHousekeeperNameCache(){var t,i;this.hkNameCache={};(i=(t=O.hk_criteria)===null||t===void 0?void 0:t.housekeepers)===null||i===void 0?void 0:i.forEach((t=>{if(t.id!=null&&t.name!=null){this.hkNameCache[t.id]=t.name}}))}updateTasks(t){this.buildHousekeeperNameCache();T(t.map((t=>Object.assign(Object.assign({},t),{id:C(),housekeeper:(()=>{var i,s,e;const n=this.hkNameCache[t.hkm_id];if(n){return n}const o=(e=(s=(i=O.hk_criteria)===null||i===void 0?void 0:i.housekeepers)===null||s===void 0?void 0:s.find((i=>i.id===t.hkm_id)))===null||e===void 0?void 0:e.name;this.hkNameCache[t.hkm_id]=o;return o})()}))))}async handleHeaderButtonPress(t){var i;t.stopImmediatePropagation();t.stopPropagation();const{name:s}=t.detail;switch(s){case"cleaned":case"clean-inspect":(i=this.modal)===null||i===void 0?void 0:i.openModal();this.modalCauses={task:null,cause:"clean",status:s==="clean-inspect"?"004":"001"};break;case"export":const t=Array.from(this.table_sorting.entries()).map((([t,i])=>({key:t,value:i})));console.log(t);const{url:e}=await this.fetchTasksWithFilters(true);b(e);break;case"archive":this.isSidebarOpen=true;break}}handleSelectedTaskCleaningEvent(t){var i;t.stopImmediatePropagation();t.stopPropagation();this.modalCauses=Object.assign(Object.assign({},t.detail),{cause:"clean"});(i=this.modal)===null||i===void 0?void 0:i.openModal()}async handleModalConfirmation(t){var i;try{t.stopImmediatePropagation();t.stopPropagation();if(P.selectedTasks.length===0){return}this.isCleaningLoading=true;if(((i=this.modalCauses)===null||i===void 0?void 0:i.cause)==="skip"){const{booking_nbr:t,date:i,unit:s}=this.modalCauses.task;await this.houseKeepingService.editHkSkip({BOOK_NBR:t,DATE:i,COMMENT:"",HK_SKIP_ID:-1,HK_SKIP_REASON_CODE:"001",PR_ID:s.id})}else{await this.houseKeepingService.executeHKAction({actions:P.selectedTasks.map((t=>{var i,s;return{description:"Cleaned",hkm_id:t.hkm_id===0?null:t.hkm_id,unit_id:t.unit.id,booking_nbr:t.booking_nbr,status:(s=(i=this.modalCauses)===null||i===void 0?void 0:i.status)!==null&&s!==void 0?s:"001"}}))})}await this.fetchTasksWithFilters()}finally{E();if(this.modalCauses){this.modalCauses=null}this.isCleaningLoading=false;this.modal.closeModal()}}async applyFilters(t){try{this.isApplyFiltersLoading=true;t.stopImmediatePropagation();t.stopPropagation();this.filters=Object.assign({},t.detail);await this.fetchTasksWithFilters()}catch(t){console.log(t)}finally{this.isApplyFiltersLoading=false}}async fetchTasksWithFilters(t=false){var i;const{cleaning_periods:s,housekeepers:e,cleaning_frequencies:n,dusty_units:o,highlight_check_ins:l}=(i=this.filters)!==null&&i!==void 0?i:{};const{tasks:a,url:r}=await this.houseKeepingService.getHkTasks({housekeepers:e,cleaning_frequency:n===null||n===void 0?void 0:n.code,dusty_window:o===null||o===void 0?void 0:o.code,highlight_window:l===null||l===void 0?void 0:l.code,property_id:this.property_id,from_date:_().format("YYYY-MM-DD"),to_date:(s===null||s===void 0?void 0:s.code)||_().format("YYYY-MM-DD"),is_export_to_excel:t});console.log(a);if(a){this.updateTasks(a)}return{tasks:a,url:r}}render(){var t,e,n,o;if(this.isLoading){return i("ir-loading-screen",null)}return i(s,{"data-testid":"hk_tasks_base"},i("ir-toast",null),i("ir-interceptor",null),i("section",{class:"p-1 d-flex flex-column",style:{gap:"1rem"}},i("h3",null,"Housekeeping Tasks"),i("div",{class:"tasks-view ",style:{gap:"1rem"}},i("ir-tasks-filters",{isLoading:this.isApplyFiltersLoading,onApplyFilters:t=>{this.applyFilters(t)}}),i("div",{class:"d-flex w-100 flex-column",style:{gap:"1rem"}},i("ir-tasks-table",{onRowSelectChange:t=>{t.stopImmediatePropagation();t.stopPropagation();A(t.detail)},class:"flex-grow-1 w-100"})))),i("ir-modal",{autoClose:false,ref:t=>this.modal=t,isLoading:this.isCleaningLoading,onConfirmModal:this.handleModalConfirmation.bind(this),onCancelModal:()=>{if(this.modalCauses){E();this.modalCauses=null}},iconAvailable:true,icon:"ft-alert-triangle danger h1",leftBtnText:g.entries.Lcz_Cancel,rightBtnText:g.entries.Lcz_Confirm,leftBtnColor:"secondary",rightBtnColor:"primary",modalTitle:g.entries.Lcz_Confirmation,modalBody:this.modalCauses?((t=this.modalCauses)===null||t===void 0?void 0:t.cause)==="clean"?this.modalCauses.task?`Update ${(o=(n=(e=this.modalCauses)===null||e===void 0?void 0:e.task)===null||n===void 0?void 0:n.unit)===null||o===void 0?void 0:o.name} to Clean`:"Update selected unit(s) to Clean":"Skip cleaning and reschedule for tomorrow.":"Update selected unit(s) to Clean"}),i("ir-sidebar",{open:this.isSidebarOpen,id:"editGuestInfo",onIrSidebarToggle:t=>{t.stopImmediatePropagation();t.stopPropagation();this.isSidebarOpen=false},showCloseButton:false},this.isSidebarOpen&&i("ir-hk-archive",{ticket:this.token.getToken(),propertyId:this.property_id,slot:"sidebar-body"})))}get el(){return n(this)}static get watchers(){return{ticket:["ticketChanged"]}}};V.style=G;const J=".sc-ir-housekeeping-h{display:block}";const Z=J;const Q=class{constructor(i){t(this,i);this.toast=o(this,"toast",7);this.language="";this.ticket="";this.isLoading=false;this.roomService=new p;this.houseKeepingService=new M;this.propertyService=new Y;this.token=new l}componentWillLoad(){if(this.baseUrl){this.token.setBaseUrl(this.baseUrl)}if(this.ticket!==""){this.token.setToken(this.ticket);this.initializeApp()}}async handleResetData(t){t.stopImmediatePropagation();t.stopPropagation();await this.houseKeepingService.getExposedHKSetup(this.propertyid)}ticketChanged(t,i){if(t===i){return}this.token.setToken(this.ticket);this.initializeApp()}async initializeApp(){var t;try{this.isLoading=true;let i=this.propertyid;if(!i){const t=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_sales_rate_plans:true});i=t.My_Result.id}j("default_properties",{token:this.ticket,property_id:i,language:this.language});const s=[];if(w.housekeeping_enabled){s.push(this.houseKeepingService.getExposedHKSetup(i))}s.push(this.roomService.fetchLanguage(this.language,["_HK_FRONT","_PMS_FRONT"]));if(this.propertyid){s.push(this.roomService.getExposedProperty({id:i,language:this.language,is_backend:true,include_sales_rate_plans:true}))}await Promise.all(s);this.selectedCleaningFrequency=(t=w.cleaning_frequency)===null||t===void 0?void 0:t.code}catch(t){console.error(t)}finally{this.isLoading=false}}async saveAutomaticCheckInCheckout(t){t.stopImmediatePropagation();t.stopPropagation();try{await this.roomService.SetAutomaticCheckInOut({property_id:O.default_properties.property_id,flag:t.detail==="auto"});this.toast.emit({position:"top-right",title:"Saved Successfully",description:"",type:"success"})}catch(t){console.log(t)}}async saveCleaningFrequency(t){t.stopImmediatePropagation();t.stopPropagation();try{await this.propertyService.setExposedCleaningFrequency({property_id:O.default_properties.property_id,code:this.selectedCleaningFrequency});w.cleaning_frequency={code:this.selectedCleaningFrequency,description:""};this.toast.emit({position:"top-right",title:"Saved Successfully",description:"",type:"success"});this.modal.closeModal()}catch(t){console.log(t)}}render(){var t;if(this.isLoading){return i("ir-loading-screen",null)}console.log(w.cleaning_frequency);return i(s,null,i("ir-interceptor",null),i("ir-toast",null),i("section",{class:"p-1"},i("h3",{class:"mb-2"},g.entries.Lcz_HouseKeepingAndCheckInSetup),i("div",{class:"card p-1"},i("ir-title",{borderShown:true,label:"Operations Settings"}),i("div",{class:"d-flex align-items-center mb-1"},i("p",{class:"my-0 py-0 mr-1"},g.entries.Lcz_CheckInOutGuestsAutomatically),i("ir-select",{showFirstOption:false,selectedValue:w.is_automatic_check_in_out?"auto":"manual",onSelectChange:t=>this.saveAutomaticCheckInCheckout(t),data:[{text:g.entries.Lcz_YesAsPerPropertyPolicy,value:"auto"},{text:g.entries.Lcz_NoIWillDoItManually,value:"manual"}]})),i("div",{class:"d-flex align-items-center"},i("p",{class:"my-0 py-0 mr-1"},g.entries.Lcz_CleaningFrequency,":"),i("ir-select",{showFirstOption:false,selectedValue:this.selectedCleaningFrequency,onSelectChange:t=>{t.stopImmediatePropagation();t.stopPropagation();this.selectedCleaningFrequency=t.detail;this.modal.openModal()},data:(t=O===null||O===void 0?void 0:O.hk_criteria)===null||t===void 0?void 0:t.cleaning_frequencies.map((t=>({text:t.description,value:t.code})))}))),w.housekeeping_enabled&&i("ir-hk-team",{class:"mb-1"}),i("ir-modal",{autoClose:false,ref:t=>this.modal=t,isLoading:I("/Set_Exposed_Cleaning_Frequency"),onConfirmModal:this.saveCleaningFrequency.bind(this),iconAvailable:true,onCancelModal:()=>{var t;this.selectedCleaningFrequency=(t=w.cleaning_frequency)===null||t===void 0?void 0:t.code},icon:"ft-alert-triangle danger h1",leftBtnText:g.entries.Lcz_Cancel,rightBtnText:g.entries.Lcz_Confirm,leftBtnColor:"secondary",rightBtnColor:"primary",modalTitle:g.entries.Lcz_Confirmation,modalBody:"This action will reschedule all cleaning tasks. Do you want to continue?"})))}static get watchers(){return{ticket:["ticketChanged"]}}};Q.style=Z;const X=".sc-ir-monthly-bookings-report-h{display:block}";const tt=X;var it=undefined&&undefined.__rest||function(t,i){var s={};for(var e in t)if(Object.prototype.hasOwnProperty.call(t,e)&&i.indexOf(e)<0)s[e]=t[e];if(t!=null&&typeof Object.getOwnPropertySymbols==="function")for(var n=0,e=Object.getOwnPropertySymbols(t);n<e.length;n++){if(i.indexOf(e[n])<0&&Object.prototype.propertyIsEnumerable.call(t,e[n]))s[e[n]]=t[e[n]]}return s};const st=class{constructor(i){t(this,i);this.language="";this.ticket="";this.isPageLoading=true;this.isLoading=null;this.reports=[];this.tokenService=new l;this.roomService=new p;this.propertyService=new Y}componentWillLoad(){this.baseFilters={date:{description:_().format("MMMM YYYY"),firstOfMonth:_().startOf("month").format("YYYY-MM-DD"),lastOfMonth:_().endOf("month").format("YYYY-MM-DD")},include_previous_year:false};this.filters=this.baseFilters;if(this.ticket){this.tokenService.setToken(this.ticket);this.init()}}handleTicketChange(t,i){if(t!==i){this.tokenService.setToken(this.ticket);this.init()}}handleApplyFiltersChange(t){t.stopImmediatePropagation();t.stopPropagation();this.filters=t.detail;this.getReports()}async init(){try{let t=this.propertyid;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}if(!t){console.log(t);const i=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});t=i.My_Result.id}this.property_id=t;const i=[this.roomService.fetchLanguage(this.language),this.getReports()];if(this.propertyid){i.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true,include_units_hk_status:true}))}await Promise.all(i)}catch(t){console.log(t)}finally{this.isPageLoading=false}}async getReports(t=false){try{const i=t=>({day:t.Date,units_booked:t.Units_booked,occupancy_percent:t.Occupancy,adr:t.ADR,rooms_revenue:t.Rooms_Revenue,total_guests:t===null||t===void 0?void 0:t.Total_Guests});this.isLoading=t?"export":"filter";const{date:s,include_previous_year:e}=this.filters;const n=[this.propertyService.getMonthlyStats({from_date:s.firstOfMonth,to_date:s.lastOfMonth,property_id:this.property_id,is_export_to_excel:t})];if(e){n.push(this.propertyService.getMonthlyStats({from_date:_(s.firstOfMonth,"YYYY-MM-DD").add(-1,"year").format("YYYY-MM-DD"),to_date:_(s.lastOfMonth,"YYYY-MM-DD").add(-1,"years").format("YYYY-MM-DD"),property_id:this.property_id}))}const o=await Promise.all(n);const l=o[0];let a=[];const{DailyStats:r}=l,c=it(l,["DailyStats"]);this.stats=Object.assign({},c);if(e&&o[t?0:1]){const s=o[t?0:1];let e=s.DailyStats.map(i);a=r.map(i).map((t=>{const i=e.find((i=>i.day===_(t.day,"YYYY-MM-DD").add(-1,"years").format("YYYY-MM-DD")));return Object.assign(Object.assign({},t),{last_year:i!==null&&i!==void 0?i:null})}))}else{a=r.map(i)}this.reports=[...a]}catch(t){console.log(t)}finally{this.isLoading=null}}render(){var t,e,n,o,l,a,r,c,h,d,u,p,f;if(this.isPageLoading){return i("ir-loading-screen",null)}return i(s,null,i("ir-toast",null),i("ir-interceptor",null),i("section",{class:"p-2 d-flex flex-column",style:{gap:"1rem"}},i("div",{class:"d-flex align-items-center justify-content-between"},i("h3",{class:"mb-1 mb-md-0"},"Daily Occupancy"),i("ir-button",{size:"sm",btn_color:"outline",isLoading:this.isLoading==="export",text:(t=g.entries)===null||t===void 0?void 0:t.Lcz_Export,onClickHandler:async t=>{t.stopImmediatePropagation();t.stopPropagation();await this.getReports(true)},btnStyle:{height:"100%"},iconPosition:"right",icon_name:"file",icon_style:{"--icon-size":"14px"}})),i("section",null,i("div",{class:"d-flex flex-column flex-md-row w-100",style:{gap:"1rem",alignItems:"stretch"}},i("ir-stats-card",{icon:((e=this.stats)===null||e===void 0?void 0:e.Occupancy_Difference_From_Previous_Month)<0?"arrow-trend-down":"arrow-trend-up",cardTitle:"Average Occupancy",value:this.stats.AverageOccupancy?((n=this.stats)===null||n===void 0?void 0:n.AverageOccupancy.toFixed(2))+"%":null,subtitle:`${((o=this.stats)===null||o===void 0?void 0:o.Occupancy_Difference_From_Previous_Month)<0?"":"+"}${(l=this.stats)===null||l===void 0?void 0:l.Occupancy_Difference_From_Previous_Month.toFixed(2)}% from last month`}),i("ir-stats-card",{icon:"hotel",cardTitle:"Total Units",value:((a=this.stats)===null||a===void 0?void 0:a.TotalUnitsBooked)?(r=this.stats)===null||r===void 0?void 0:r.TotalUnitsBooked.toString():null,subtitle:"Booked"}),i("ir-stats-card",{icon:"user_group",cardTitle:"Total Guests",value:(h=(c=this.stats)===null||c===void 0?void 0:c.Total_Guests)===null||h===void 0?void 0:h.toString(),subtitle:"Stayed"}),i("ir-stats-card",{icon:"calendar",cardTitle:"Peak Days",value:((d=this.stats)===null||d===void 0?void 0:d.PeakDays.length)===0?null:(p=(u=this.stats)===null||u===void 0?void 0:u.PeakDays)===null||p===void 0?void 0:p.map((t=>_(t.Date,"YYYY-MM-DD").format("D").concat("th"))).join(" - "),subtitle:`${Math.max(...((f=this.stats.PeakDays)===null||f===void 0?void 0:f.map((t=>t.OccupancyPercent)))||[])}% occupancy`})),i("div",{class:"d-flex flex-column flex-lg-row mt-1 ",style:{gap:"1rem"}},i("ir-monthly-bookings-report-filter",{isLoading:this.isLoading==="filter",class:"filters-card",baseFilters:this.baseFilters}),i("ir-monthly-bookings-report-table",{reports:this.reports})))))}static get watchers(){return{ticket:["handleTicketChange"]}}};st.style=tt;const et=".sc-ir-sales-by-channel-h{display:block}";const nt=et;var ot=undefined&&undefined.__rest||function(t,i){var s={};for(var e in t)if(Object.prototype.hasOwnProperty.call(t,e)&&i.indexOf(e)<0)s[e]=t[e];if(t!=null&&typeof Object.getOwnPropertySymbols==="function")for(var n=0,e=Object.getOwnPropertySymbols(t);n<e.length;n++){if(i.indexOf(e[n])<0&&Object.prototype.propertyIsEnumerable.call(t,e[n]))s[e[n]]=t[e[n]]}return s};const lt=class{constructor(i){t(this,i);this.language="";this.ticket="";this.isLoading=null;this.isPageLoading=true;this.allowedProperties=[];this.token=new l;this.roomService=new p;this.propertyService=new Y;this.baseFilters={FROM_DATE:_().add(-7,"days").format("YYYY-MM-DD"),TO_DATE:_().format("YYYY-MM-DD"),BOOK_CASE:"001",WINDOW:7,include_previous_year:false,is_export_to_excel:false}}componentWillLoad(){this.channelSalesFilters=this.baseFilters;if(this.ticket){this.token.setToken(this.ticket);this.initializeApp()}}ticketChanged(t,i){if(t===i){return}this.token.setToken(this.ticket);this.initializeApp()}async initializeApp(){var t,i;try{if(!this.mode){throw new Error("Missing required 'mode'. Please set it to either 'property' or 'mpo'.")}if(!this.propertyid&&this.mode==="property"&&!this.p){throw new Error("Missing Property ID or aname")}if(this.mode==="property"){const i=await this.propertyService.getExposedProperty({id:Number((t=this.propertyid)!==null&&t!==void 0?t:0),aname:this.p,language:this.language,is_backend:true});this.propertyID=i.My_Result.id}const s=[,this.roomService.fetchLanguage(this.language)];if(this.mode==="mpo"){s.unshift(this.propertyService.getExposedAllowedProperties());const[t]=await Promise.all(s);this.allowedProperties=[...t]}this.baseFilters=Object.assign(Object.assign({},this.baseFilters),{LIST_AC_ID:(i=this.allowedProperties)===null||i===void 0?void 0:i.map((t=>t.id))});this.channelSalesFilters=Object.assign({},this.baseFilters);await this.getChannelSales()}catch(t){console.log(t)}finally{this.isPageLoading=false}}async getChannelSales(t=false){try{const i=this.channelSalesFilters,{include_previous_year:s,LIST_AC_ID:e}=i,n=ot(i,["include_previous_year","LIST_AC_ID"]);this.isLoading=t?"export":"filter";const o=await this.propertyService.getChannelSales(Object.assign(Object.assign(Object.assign(Object.assign({is_export_to_excel:t},n),{AC_ID:this.propertyID?this.propertyID.toString():undefined}),n),{LIST_AC_ID:this.propertyID?null:e}));const l=!t&&s;let a=[];if(l){const t=await this.propertyService.getChannelSales(Object.assign(Object.assign({AC_ID:this.propertyID?this.propertyID.toString():undefined},n),{LIST_AC_ID:this.propertyID?null:e,FROM_DATE:_(n.FROM_DATE).subtract(1,"year").format("YYYY-MM-DD"),TO_DATE:_(n.TO_DATE).subtract(1,"year").format("YYYY-MM-DD")}));a=o.map((i=>{const s=t.find((t=>t.SOURCE.toLowerCase()===i.SOURCE.toLowerCase()));return Object.assign(Object.assign({},i),{last_year:s?s:null})}))}else{a=o.map((t=>Object.assign(Object.assign({},t),{last_year:null})))}const r=t=>{if(!t||t.length===0)return t;const i=t=>{var i;return(i=t===null||t===void 0?void 0:t.currency)!==null&&i!==void 0?i:null};const s=t=>{const s=t.SOURCE.toString().toLowerCase().trim();const e=i(t);return`${s}__${e!==null&&e!==void 0?e:"null"}`};const e=(t,i)=>(t!==null&&t!==void 0?t:0)+(i!==null&&i!==void 0?i:0);const n=(t,i)=>{if(!i)return t;if(!t)return Object.assign({},i);return{NIGHTS:e(t.NIGHTS,i.NIGHTS),PCT:e(t.PCT,i.PCT),REVENUE:e(t.REVENUE,i.REVENUE),SOURCE:t.SOURCE,PROPERTY_ID:t.PROPERTY_ID,PROPERTY_NAME:t.PROPERTY_NAME,currency:t.currency}};const o=new Map;for(const i of t){const t=s(i);const l=o.get(t);if(!l){o.set(t,Object.assign({},i))}else{const s=Object.assign(Object.assign({},l),{NIGHTS:e(l.NIGHTS,i.NIGHTS),PCT:0,REVENUE:e(l.REVENUE,i.REVENUE),last_year:n(l.last_year,i.last_year)});o.set(t,s)}}const l=Array.from(o.values());const a=l.reduce(((t,i)=>{var s;return t+((s=i.REVENUE)!==null&&s!==void 0?s:0)}),0);if(a>0){for(const t of l){t.PCT=t.REVENUE/a*100;if(t.last_year){const i=l.reduce(((t,i)=>{var s,e;return t+((e=(s=i.last_year)===null||s===void 0?void 0:s.REVENUE)!==null&&e!==void 0?e:0)}),0);if(i>0){t.last_year.PCT=t.last_year.REVENUE/i*100}}}}return l};this.salesData=[...r(a)]}catch(t){console.error("Failed to fetch sales data:",t)}finally{this.isLoading=null}}render(){if(this.isPageLoading){return i("ir-loading-screen",null)}return i(s,null,i("ir-toast",null),i("ir-interceptor",null),i("section",{class:"p-2 d-flex flex-column",style:{gap:"1rem"}},i("div",{class:"d-flex align-items-center justify-content-between"},i("h3",{class:"mb-1 mb-md-0"},"Sales by Channel"),i("ir-button",{size:"sm",btn_color:"outline",isLoading:this.isLoading==="export",text:g.entries.Lcz_Export,onClickHandler:async t=>{t.stopImmediatePropagation();t.stopPropagation();await this.getChannelSales(true)},btnStyle:{height:"100%"},iconPosition:"right",icon_name:"file",icon_style:{"--icon-size":"14px"}})),i("div",{class:"d-flex flex-column flex-lg-row mt-1 ",style:{gap:"1rem"}},i("ir-sales-by-channel-filters",{isLoading:this.isLoading==="filter",onApplyFilters:t=>{t.stopImmediatePropagation();t.stopPropagation();this.channelSalesFilters=Object.assign({},t.detail);this.getChannelSales()},allowedProperties:this.allowedProperties,baseFilters:this.baseFilters}),i("ir-sales-by-channel-table",{mode:this.mode,allowedProperties:this.allowedProperties,class:"card mb-0",records:this.salesData}))))}static get watchers(){return{ticket:["ticketChanged"]}}};lt.style=nt;const at=".sc-ir-sales-by-country-h{display:block}";const rt=at;var ct=undefined&&undefined.__rest||function(t,i){var s={};for(var e in t)if(Object.prototype.hasOwnProperty.call(t,e)&&i.indexOf(e)<0)s[e]=t[e];if(t!=null&&typeof Object.getOwnPropertySymbols==="function")for(var n=0,e=Object.getOwnPropertySymbols(t);n<e.length;n++){if(i.indexOf(e[n])<0&&Object.prototype.propertyIsEnumerable.call(t,e[n]))s[e[n]]=t[e[n]]}return s};const ht=class{constructor(i){t(this,i);this.language="";this.ticket="";this.isLoading=null;this.isPageLoading=true;this.countries=new Map;this.token=new l;this.roomService=new p;this.propertyService=new Y;this.bookingService=new x;this.baseFilters={FROM_DATE:_().add(-7,"days").format("YYYY-MM-DD"),TO_DATE:_().format("YYYY-MM-DD"),BOOK_CASE:"001",WINDOW:7,include_previous_year:false}}componentWillLoad(){this.salesFilters=this.baseFilters;if(this.ticket){this.token.setToken(this.ticket);this.initializeApp()}}ticketChanged(t,i){if(t===i){return}this.token.setToken(this.ticket);this.initializeApp()}async initializeApp(){try{let t=this.propertyid;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}if(!t){console.log(t);const i=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});t=i.My_Result.id}this.property_id=t;const i=[this.bookingService.getCountries(this.language),this.roomService.fetchLanguage(this.language),this.getCountrySales()];if(this.propertyid){i.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true,include_units_hk_status:true}))}const[s]=await Promise.all(i);const e=new Map;s.map((t=>{e.set(t.id,{flag:t.flag,name:t.name})}));this.countries=e}catch(t){console.log(t)}finally{this.isPageLoading=false}}async getCountrySales(t=false){const i=t=>({country:t.COUNTRY,country_id:t.COUNTRY_ID,nights:t.NIGHTS,percentage:t.PCT,revenue:t.REVENUE,number_of_guests:t.Total_Guests});try{const s=this.salesFilters,{include_previous_year:e}=s,n=ct(s,["include_previous_year"]);this.isLoading=t?"export":"filter";const o=await this.propertyService.getCountrySales(Object.assign({AC_ID:this.property_id,is_export_to_excel:t},n));const l=!t&&e;let a=[];if(l){const t=await this.propertyService.getCountrySales(Object.assign(Object.assign({AC_ID:this.property_id,is_export_to_excel:false},n),{FROM_DATE:_(n.FROM_DATE).subtract(1,"year").format("YYYY-MM-DD"),TO_DATE:_(n.TO_DATE).subtract(1,"year").format("YYYY-MM-DD")}));a=o.map((s=>{const e=t.find((t=>t.COUNTRY.toLowerCase()===s.COUNTRY.toLowerCase()));return Object.assign(Object.assign({id:C()},i(s)),{last_year:e?i(e):null})}))}else{a=o.map((t=>Object.assign(Object.assign({id:C()},i(t)),{last_year:null})))}this.salesData=[...a]}catch(t){console.error("Failed to fetch sales data:",t)}finally{this.isLoading=null}}render(){if(this.isPageLoading){return i("ir-loading-screen",null)}return i(s,null,i("ir-toast",null),i("ir-interceptor",null),i("section",{class:"p-2 d-flex flex-column",style:{gap:"1rem"}},i("div",{class:"d-flex align-items-center justify-content-between"},i("h3",{class:"mb-1 mb-md-0"},"Sales by Country"),i("ir-button",{size:"sm",btn_color:"outline",isLoading:this.isLoading==="export",text:g.entries.Lcz_Export,onClickHandler:async t=>{t.stopImmediatePropagation();t.stopPropagation();await this.getCountrySales(true)},btnStyle:{height:"100%"},iconPosition:"right",icon_name:"file",icon_style:{"--icon-size":"14px"}})),i("ir-sales-by-country-summary",{salesReports:this.salesData}),i("div",{class:"d-flex flex-column flex-lg-row mt-1 ",style:{gap:"1rem"}},i("ir-sales-filters",{isLoading:this.isLoading==="filter",onApplyFilters:t=>{t.stopImmediatePropagation();t.stopPropagation();this.salesFilters=t.detail;this.getCountrySales()},class:"filters-card",baseFilters:this.baseFilters}),i("ir-sales-table",{mappedCountries:this.countries,class:"card mb-0",records:this.salesData}))))}static get watchers(){return{ticket:["ticketChanged"]}}};ht.style=rt;const dt=".sc-ir-user-management-h{display:block;height:100%}";const ut=dt;const pt=class{constructor(i){t(this,i);this.language="";this.isSuperAdmin=true;this.isLoading=true;this.users=[];this.allowedUsersTypes=[];this.token=new l;this.roomService=new p;this.userService=new R;this.bookingService=new x;this.userTypes=new Map;this.superAdminId="5"}componentWillLoad(){if(this.baseUrl){this.token.setBaseUrl(this.baseUrl)}if(this.ticket){this.token.setToken(this.ticket);this.initializeApp()}}ticketChanged(t,i){if(t===i){return}this.token.setToken(this.ticket);this.initializeApp()}async handleResetData(t){t.stopImmediatePropagation();t.stopPropagation();await this.fetchUsers()}async initializeApp(){try{if(this.baseUrl){this.token.setBaseUrl(this.baseUrl)}this.isLoading=true;let t=this.propertyid;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}if(!t){console.log(t);const i=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});t=i.My_Result.id}this.property_id=t;const i=[this.fetchUserTypes(),this.fetchUsers(),this.roomService.fetchLanguage(this.language,["_USER_MGT"])];if(this.propertyid){i.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true,include_units_hk_status:true}))}await Promise.all(i);this.socket=D("https://realtime.igloorooms.com/");this.socket.on("MSG",(async t=>{await this.handleSocketMessage(t)}))}catch(t){console.log(t)}finally{this.isLoading=false}}async handleSocketMessage(t){const i=JSON.parse(t);if(!i){return}const{REASON:s,KEY:e,PAYLOAD:n}=i;if(e.toString()!==this.property_id.toString()){return}let o=JSON.parse(n);console.log(e,o);const l={EMAIL_VERIFIED:this.updateUserVerificationStatus};const a=l[s];if(a){await a.call(this,o)}else{console.warn(`Unhandled REASON: ${s}`)}}updateUserVerificationStatus(t){const i=[...this.users];const s=i.findIndex((i=>i.id===t.id));if(s===-1){console.warn(`User ${t.id} not found`);return}i[s]=Object.assign(Object.assign({},i[s]),{is_email_verified:true});this.users=i}async fetchUsers(){const t=await this.userService.getExposedPropertyUsers({property_id:this.propertyid});this.users=[...t].sort(((t,i)=>{const s=t=>{const i=t.type.toString();if(i===this.superAdminId)return 0;if(i==="17")return 1;return 2};const e=s(t),n=s(i);if(e!==n){return e-n}return t.username.localeCompare(i.username)}))}async fetchUserTypes(){var t,i,s,e;const n=await Promise.all([this.bookingService.getSetupEntriesByTableName("_USER_TYPE"),this.bookingService.getLov()]);const o=(i=(t=n[1])===null||t===void 0?void 0:t.My_Result)===null||i===void 0?void 0:i.allowed_user_types;for(const t of n[0]){const i=t[`CODE_VALUE_${(e=(s=this.language)===null||s===void 0?void 0:s.toUpperCase())!==null&&e!==void 0?e:"EN"}`];if(o.find((i=>i.code===t.CODE_NAME))){this.allowedUsersTypes.push({code:t.CODE_NAME,value:i})}this.userTypes.set(t.CODE_NAME.toString(),i)}}disconnectedCallback(){this.socket.disconnect()}render(){var t,e;if(this.isLoading){return i(s,null,i("ir-toast",null),i("ir-interceptor",null),i("ir-loading-screen",null))}return i(s,null,i("ir-toast",null),i("ir-interceptor",{suppressToastEndpoints:["/Change_User_Pwd","/Handle_Exposed_User"]}),i("section",{class:"p-2 d-flex flex-column",style:{gap:"1rem"}},i("div",{class:"d-flex  pb-2 align-items-center justify-content-between"},i("h3",{class:"mb-1 mb-md-0"},g.entries.Lcz_ExtranetUsers)),i("div",{class:"",style:{gap:"1rem"}},i("ir-user-management-table",{property_id:this.property_id,baseUserTypeCode:this.baseUserTypeCode,allowedUsersTypes:this.allowedUsersTypes,userTypeCode:this.userTypeCode,haveAdminPrivileges:[this.superAdminId,"17"].includes((t=this.userTypeCode)===null||t===void 0?void 0:t.toString()),userTypes:this.userTypes,class:"card",isSuperAdmin:((e=this.userTypeCode)===null||e===void 0?void 0:e.toString())===this.superAdminId,users:this.users}))))}static get watchers(){return{ticket:["ticketChanged"]}}};pt.style=ut;export{F as ir_booking_email_logs,$ as ir_booking_listing,K as ir_daily_revenue,V as ir_hk_tasks,Q as ir_housekeeping,st as ir_monthly_bookings_report,lt as ir_sales_by_channel,ht as ir_sales_by_country,pt as ir_user_management};
//# sourceMappingURL=p-caad5dfb.entry.js.map