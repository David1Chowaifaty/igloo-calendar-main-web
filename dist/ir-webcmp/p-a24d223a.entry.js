import{r as t,c as s,h as i,H as e,a}from"./p-ChgcZQN7.js";import{T as n}from"./p-BnpC3RGN.js";import{H as r,h as l,u as o}from"./p-BOUz-UPV.js";import{R as h}from"./p-DLJRYEeZ.js";import{i as c}from"./p-C2Jqsl24.js";import{l as d}from"./p-nL6Cb5fb.js";import{h as u}from"./p-Mki5YqAR.js";import{j as p}from"./p-DOc0XUDq.js";import{v as f}from"./p-DD3477fe.js";import{c as m}from"./p-mtEzY3tV.js";import"./p-BSI30sps.js";import"./p-BFTU3MAI.js";import"./p-BUqSlr60.js";import"./p-DeW5X45W.js";const k=".sc-ir-hk-tasks-h{display:block}@media only screen and (max-width: 900px){.table-container.sc-ir-hk-tasks{width:max-content !important}}";const g=class{constructor(i){t(this,i);this.clearSelectedHkTasks=s(this,"clearSelectedHkTasks");this.language="";this.ticket="";this.isLoading=false;this.selectedDuration="";this.selectedHouseKeeper="0";this.selectedRoom=null;this.archiveOpened=false;this.tasks=[];this.selectedTasks=[];this.hkNameCache={};this.roomService=new h;this.houseKeepingService=new r;this.token=new n;this.table_sorting=new Map}componentWillLoad(){if(this.ticket!==""){this.token.setToken(this.ticket);this.init()}}ticketChanged(t,s){if(t===s){return}this.token.setToken(this.ticket);this.init()}handleCloseSidebar(t){t.stopImmediatePropagation();t.stopPropagation();this.isSidebarOpen=false}handleSortingChanged(t){t.stopImmediatePropagation();t.stopPropagation();const{field:s,direction:i}=t.detail;console.log(t.detail);if(s==="date"){return}this.table_sorting.set(s,i)}async init(){try{this.isLoading=true;let t=this.propertyid;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}if(!t){console.log(t);const s=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});t=s.My_Result.id}this.property_id=t;const s=[this.houseKeepingService.getHkTasks({property_id:this.property_id,from_date:u().format("YYYY-MM-DD"),to_date:u().format("YYYY-MM-DD")}),this.houseKeepingService.getExposedHKSetup(this.property_id),this.roomService.fetchLanguage(this.language)];if(this.propertyid){s.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true,include_units_hk_status:true}))}const i=await Promise.all(s);const e=i[0];if(e===null||e===void 0?void 0:e.tasks){this.updateTasks(e.tasks)}}catch(t){console.log(t)}finally{this.isLoading=false}}buildHousekeeperNameCache(){var t,s;this.hkNameCache={};(s=(t=l.hk_criteria)===null||t===void 0?void 0:t.housekeepers)===null||s===void 0?void 0:s.forEach((t=>{if(t.id!=null&&t.name!=null){this.hkNameCache[t.id]=t.name}}))}updateTasks(t){this.buildHousekeeperNameCache();this.tasks=t.map((t=>Object.assign(Object.assign({},t),{id:f(),housekeeper:(()=>{var s,i,e;const a=this.hkNameCache[t.hkm_id];if(a){return a}const n=(e=(i=(s=l.hk_criteria)===null||s===void 0?void 0:s.housekeepers)===null||i===void 0?void 0:i.find((s=>s.id===t.hkm_id)))===null||e===void 0?void 0:e.name;this.hkNameCache[t.hkm_id]=n;return n})()})))}async handleHeaderButtonPress(t){var s;t.stopImmediatePropagation();t.stopPropagation();const{name:i}=t.detail;switch(i){case"cleaned":(s=this.modal)===null||s===void 0?void 0:s.openModal();break;case"export":const t=Array.from(this.table_sorting.entries()).map((([t,s])=>({key:t,value:s})));console.log(t);const{url:i}=await this.fetchTasksWithFilters(true);p(i);break;case"archive":this.isSidebarOpen=true;break}}async handleModalConfirmation(t){try{t.stopImmediatePropagation();t.stopPropagation();if(this.selectedTasks.length===0){return}await this.houseKeepingService.executeHKAction({actions:this.selectedTasks.map((t=>({description:"Cleaned",hkm_id:t.hkm_id===0?null:t.hkm_id,unit_id:t.unit.id,booking_nbr:t.booking_nbr})))});await this.fetchTasksWithFilters()}finally{this.selectedTasks=[];this.clearSelectedHkTasks.emit();this.modal.closeModal()}}async applyFilters(t){try{this.isApplyFiltersLoading=true;t.stopImmediatePropagation();t.stopPropagation();this.filters=Object.assign({},t.detail);await this.fetchTasksWithFilters()}catch(t){console.log(t)}finally{this.isApplyFiltersLoading=false}}async fetchTasksWithFilters(t=false){var s;const{cleaning_periods:i,housekeepers:e,cleaning_frequencies:a,dusty_units:n,highlight_check_ins:r}=(s=this.filters)!==null&&s!==void 0?s:{};const{tasks:l,url:o}=await this.houseKeepingService.getHkTasks({housekeepers:e,cleaning_frequencies:a===null||a===void 0?void 0:a.code,dusty_units:n===null||n===void 0?void 0:n.code,highlight_window:r===null||r===void 0?void 0:r.code,property_id:this.property_id,from_date:u().format("YYYY-MM-DD"),to_date:(i===null||i===void 0?void 0:i.code)||u().format("YYYY-MM-DD"),is_export_to_excel:t});if(l){this.updateTasks(l)}return{tasks:l,url:o}}render(){if(this.isLoading){return i("ir-loading-screen",null)}return i(e,{"data-testid":"hk_tasks_base"},i("ir-toast",null),i("ir-interceptor",null),i("section",{class:"p-2 d-flex flex-column",style:{gap:"1rem"}},i("ir-tasks-header",{onHeaderButtonPress:this.handleHeaderButtonPress.bind(this),isCleanedEnabled:this.selectedTasks.length>0}),i("div",{class:"d-flex flex-column flex-md-row mt-1 ",style:{gap:"1rem"}},i("ir-tasks-filters",{isLoading:this.isApplyFiltersLoading,onApplyFilters:t=>{this.applyFilters(t)}}),i("ir-tasks-table",{onRowSelectChange:t=>{t.stopImmediatePropagation();t.stopPropagation();this.selectedTasks=t.detail},class:"flex-grow-1 w-100",tasks:this.tasks}))),i("ir-modal",{autoClose:false,ref:t=>this.modal=t,isLoading:c("/Execute_HK_Action"),onConfirmModal:this.handleModalConfirmation.bind(this),iconAvailable:true,icon:"ft-alert-triangle danger h1",leftBtnText:d.entries.Lcz_NO,rightBtnText:d.entries.Lcz_Yes,leftBtnColor:"secondary",rightBtnColor:"primary",modalTitle:d.entries.Lcz_Confirmation,modalBody:"Update selected unit(s) to Clean"}),i("ir-sidebar",{open:this.isSidebarOpen,id:"editGuestInfo",onIrSidebarToggle:t=>{t.stopImmediatePropagation();t.stopPropagation();this.isSidebarOpen=false},showCloseButton:false},this.isSidebarOpen&&i("ir-hk-archive",{ticket:this.token.getToken(),propertyId:this.property_id,slot:"sidebar-body"})))}get el(){return a(this)}static get watchers(){return{ticket:["ticketChanged"]}}};g.style=k;const _=".sc-ir-housekeeping-h{display:block}";const y=class{constructor(i){t(this,i);this.toast=s(this,"toast");this.language="";this.ticket="";this.isLoading=false;this.roomService=new h;this.houseKeepingService=new r;this.token=new n}componentWillLoad(){if(this.ticket!==""){this.token.setToken(this.ticket);this.initializeApp()}}async handleResetData(t){t.stopImmediatePropagation();t.stopPropagation();await this.houseKeepingService.getExposedHKSetup(this.propertyid)}ticketChanged(t,s){if(t===s){return}this.token.setToken(this.ticket);this.initializeApp()}async initializeApp(){try{this.isLoading=true;let t=this.propertyid;if(!t){const s=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_sales_rate_plans:true});t=s.My_Result.id}o("default_properties",{token:this.ticket,property_id:t,language:this.language});const s=[this.houseKeepingService.getExposedHKSetup(t),this.roomService.fetchLanguage(this.language,["_HK_FRONT"])];if(this.propertyid){s.unshift(this.roomService.getExposedProperty({id:t,language:this.language,is_backend:true,include_sales_rate_plans:true}))}await Promise.all(s)}catch(t){console.error(t)}finally{this.isLoading=false}}saveAutomaticCheckInCheckout(t){t.stopImmediatePropagation();t.stopPropagation();try{this.roomService.SetAutomaticCheckInOut({property_id:this.propertyid,flag:t.detail==="auto"});this.toast.emit({position:"top-right",title:"Saved Successfully",description:"",type:"success"})}catch(t){console.log(t)}}render(){if(this.isLoading){return i("ir-loading-screen",null)}return i(e,null,i("ir-interceptor",null),i("ir-toast",null),i("section",{class:"p-1"},i("h3",{class:"mb-2"},"Housekeeping & Check-In Setup"),i("div",{class:"card p-1"},i("ir-title",{borderShown:true,label:"Check-In Mode"}),i("div",{class:"d-flex align-items-center"},i("p",{class:"my-0 py-0 mr-1  "},"Check in & Check out guests automatically:"),i("ir-select",{LabelAvailable:false,showFirstOption:false,selectedValue:m.is_automatic_check_in_out?"auto":"manual",onSelectChange:t=>this.saveAutomaticCheckInCheckout(t),data:[{text:`Yes, as per the property's policy.`,value:"auto"},{text:"No, I will do it manually. ",value:"manual"}]}))),i("ir-hk-team",{class:"mb-1"})))}static get watchers(){return{ticket:["ticketChanged"]}}};y.style=_;export{g as ir_hk_tasks,y as ir_housekeeping};
//# sourceMappingURL=p-a24d223a.entry.js.map