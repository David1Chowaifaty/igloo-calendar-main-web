import{r as t,h as e,H as i,g as s,c as n}from"./p-acddcbeb.js";import{T as a}from"./p-f8b7c0cd.js";import{B as r}from"./p-0ca0bfce.js";import{R as o}from"./p-ac9c6afc.js";import{c as l,o as h,a as c,d,i as u,e as p}from"./p-49728458.js";import{c as g}from"./p-d6d6fb27.js";import{a as f}from"./p-bf44a732.js";import{B as y,u as m,b as _,s as k,o as b,a as w,c as C,d as v}from"./p-e001f906.js";import{S as Y,O as P}from"./p-da35159f.js";import{P as D,l as S}from"./p-85b4d3ff.js";import{l as x}from"./p-e58470d9.js";import{h as E}from"./p-6c4ba7c0.js";import{v as M}from"./p-4ed69de7.js";import{o as T,d as R,b as A,i as O,c as N,e as I}from"./p-f0241a0b.js";import{H as B,h as F,u as L}from"./p-da752fba.js";import{s as z,u as U,h as H,c as j,a as G}from"./p-aaeca94b.js";import{i as q}from"./p-3b76fc4f.js";import{U as K}from"./p-4e569987.js";import"./p-e7d273da.js";import"./p-2925ded6.js";const W=".page-title.sc-ir-arrivals{font-family:var(--wa-font-family-heading);font-weight:var(--wa-font-weight-heading);line-height:var(--wa-line-height-condensed);text-wrap:balance;font-size:var(--wa-font-size-xl)}";const $=W;const V=class{constructor(e){t(this,e)}ticket;propertyid;language="en";p;pageSize=20;bookingNumber;booking;paymentEntries;isPageLoading;payment;roomGuestState=null;countries;tokenService=new a;roomService=new o;bookingService=new r;paymentFolioRef;componentWillLoad(){if(this.ticket){this.tokenService.setToken(this.ticket);this.init()}l(this.pageSize);h("today",(t=>{this.getBookings()}))}handlePageSizeChange(t,e){if(t!==e)l(t)}handleTicketChange(t,e){if(t!==e&&t){this.tokenService.setToken(this.ticket);this.init()}}handleBookingPayment(t){t.stopImmediatePropagation();t.stopPropagation();const{booking_nbr:e,payment:i}=t.detail;this.booking=c.bookings.find((t=>t.booking_nbr===e));const s=this.paymentEntries.types.find((t=>t.CODE_NAME===i.payment_type.code));this.payment={...i,payment_type:{code:s.CODE_NAME,description:s.CODE_VALUE_EN,operation:s.NOTES}};this.paymentFolioRef.openFolio()}handleOpen(t){this.bookingNumber=t.detail}async handleResetExposedCancellationDueAmount(t){t.stopImmediatePropagation();t.stopPropagation();await this.getBookings()}async init(){try{this.isPageLoading=true;if(!this.propertyid&&!this.p){throw new Error("Missing credentials")}let t=this.propertyid;if(!t){await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true})}const[e,i,s,n]=await Promise.all([g?.property?Promise.resolve(null):this.roomService.getExposedProperty({id:this.propertyid||0,language:this.language,aname:this.p}),this.roomService.fetchLanguage(this.language),this.bookingService.getCountries(this.language),this.bookingService.getSetupEntriesByTableNameMulti(["_BED_PREFERENCE_TYPE","_DEPARTURE_TIME","_PAY_TYPE","_PAY_TYPE_GROUP","_PAY_METHOD"]),this.getBookings()]);this.countries=s;const{pay_type:a,pay_type_group:r,pay_method:o}=this.bookingService.groupEntryTablesResult(n);this.paymentEntries={types:a,groups:r,methods:o}}catch(t){}finally{this.isPageLoading=false}}async getBookings(){const{bookings:t,total_count:e}=await this.bookingService.getRoomsToCheckIn({property_id:g.property?.id?.toString()||this.propertyid?.toString(),check_in_date:c.today,page_index:c.pagination.currentPage,page_size:c.pagination.pageSize});d(e??0);u(t)}async handlePaginationChange(t){t.stopImmediatePropagation();t.stopPropagation();const e=t.detail?.currentPage??1;if(e===c.pagination.currentPage){return}p(e);await this.getBookings()}async handlePaginationPageSizeChange(t){t.stopImmediatePropagation();t.stopPropagation();const e=t.detail?.pageSize;if(!Number.isFinite(e)){return}const i=Math.floor(Number(e));if(i===c.pagination.pageSize){return}l(i);await this.getBookings()}handleCheckingRoom(t){t.stopImmediatePropagation();t.stopPropagation();this.roomGuestState=t.detail}handleResetBooking(t){t.stopImmediatePropagation();t.stopPropagation();this.getBookings()}render(){if(this.isPageLoading){return e("ir-loading-screen",null)}return e(i,null,e("ir-toast",null),e("ir-interceptor",{handledEndpoints:["/Get_Rooms_To_Check_in"]}),e("div",{class:"ir-page__container"},e("h3",{class:"page-title"},"Check-ins"),e("ir-arrivals-table",{onCheckInRoom:t=>this.handleCheckingRoom(t),onRequestPageChange:t=>this.handlePaginationChange(t),onRequestPageSizeChange:t=>this.handlePaginationPageSizeChange(t)}),e("ir-drawer",{onDrawerHide:t=>{t.stopImmediatePropagation();t.stopPropagation();this.bookingNumber=null},withoutHeader:true,open:!!this.bookingNumber,style:{"--ir-drawer-width":"80rem","--ir-drawer-background-color":"#F2F3F8","--ir-drawer-padding-left":"0","--ir-drawer-padding-top":"0","--ir-drawer-padding-bottom":"0","--ir-drawer-padding-right":"0"}},this.bookingNumber&&e("ir-booking-details",{hasPrint:true,hasReceipt:true,hasCloseButton:true,onCloseSidebar:()=>this.bookingNumber=null,is_from_front_desk:true,propertyid:this.propertyid,hasRoomEdit:true,hasRoomDelete:true,bookingNumber:this.bookingNumber.toString(),ticket:this.ticket,language:this.language,hasRoomAdd:true})),e("ir-payment-folio",{style:{height:"auto"},bookingNumber:this.booking?.booking_nbr,paymentEntries:this.paymentEntries,payment:this.payment,mode:"payment-action",ref:t=>this.paymentFolioRef=t,onCloseModal:()=>{this.booking=null;this.payment=null}}),e("ir-room-guests",{open:this.roomGuestState!==null,countries:this.countries,language:this.language,identifier:this.roomGuestState?.identifier,bookingNumber:this.roomGuestState?.booking_nbr?.toString(),roomName:this.roomGuestState?.roomName,totalGuests:this.roomGuestState?.totalGuests,sharedPersons:this.roomGuestState?.sharing_persons,checkIn:this.roomGuestState?.checkin,onCloseModal:()=>this.roomGuestState=null})))}static get watchers(){return{pageSize:["handlePageSizeChange"],ticket:["handleTicketChange"]}}};V.style=$;const J=".sc-ir-booking-email-logs-h{display:block}";const Q=J;const X=class{constructor(e){t(this,e)}ticket;data;bookingNumber;token=new a;componentWillLoad(){if(this.ticket){this.token.setToken(this.ticket)}}handleTicketChange(){if(this.ticket){this.token.setToken(this.ticket)}}render(){return e(i,{key:"97960cd202ac6c0141afff0ab3a27a555792db92",class:"p-1"},e("ir-interceptor",{key:"80cdcdeff1fb84a75dbe1ca172084aa1f756733a",handledEndpoints:["/Get_Email_log_By_BOOK_NBR"]}),e("ir-toast",{key:"d001d93d439df613b066400e4f2df64c2a1cae08"}),e("div",{key:"495da73a00ab306aa17860e3f8b2a1d96bd50f60",class:"d-flex align-items-center mb-1",style:{gap:"0.5rem"}},e("ir-input-text",{key:"ef79ae9e212fd6b8fbe4c21fb1329377355213bf",class:"m-0",inputContainerStyle:{margin:"0"},value:this.bookingNumber,onTextChange:t=>this.bookingNumber=t.detail,placeholder:"booking number"}),e("ir-button",{key:"0f70e01952c87d8c6ec1de1bc543f732f4334485",size:"sm",text:"search",onClickHandler:async()=>{const{data:t}=await f.post("/Get_Email_log_By_BOOK_NBR",{BOOK_NBR:this.bookingNumber});if(t.ExceptionMsg){return}this.data=t.My_Result}})),e("p",{key:"62811caf29dee49f1c856d3ce95b9257905bdc85"},JSON.stringify(this.data,null,2)))}static get watchers(){return{ticket:["handleTicketChange"]}}};X.style=Q;function Z(){const t=new URLSearchParams(window.location.search);const e={};for(const[i,s]of t.entries()){e[i]=s}return e}const tt=".sc-ir-booking-listing-h{display:block;padding:var(--wa-space-l);position:relative}";const et=tt;const it=class{constructor(e){t(this,e)}get el(){return s(this)}language="";ticket="";propertyid;rowCount=20;p;baseUrl;userType;isLoading=false;editBookingItem=null;showCost=false;paymentEntries;payment;booking;bookingListingService=new y;bookingService=new r;roomService=new o;propertyService=new D;token=new a;listingModal;listingModalTimeout;allowedProperties;havePrivilege;paymentFolioRef;componentWillLoad(){if(this.baseUrl){this.token.setBaseUrl(this.baseUrl)}m("end_row",this.rowCount);_.rowCount=this.rowCount;k(this.rowCount);if(this.ticket!==""){_.token=this.ticket;this.token.setToken(this.ticket);this.initializeApp()}b("userSelection",(t=>{w(t)}));b("bookings",(t=>{this.showCost=t.some((t=>t.financial.gross_cost!==null&&t.financial.gross_cost>0))}))}ticketChanged(t,e){if(t===e){return}this.token.setToken(this.ticket);_.token=this.ticket;this.initializeApp()}async fetchBookings(){await this.bookingListingService.getExposedBookings({..._.userSelection,is_to_export:false})}async initializeApp(){try{this.isLoading=true;this.havePrivilege=Y(this.userType);let t=this.propertyid;if(!this.havePrivilege){if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}if(!t){const e=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true});t=e.My_Result.id}}const e=[this.bookingService.getSetupEntriesByTableNameMulti(["_PAY_TYPE","_PAY_TYPE_GROUP","_PAY_METHOD"]),this.bookingListingService.getExposedBookingsCriteria(this.havePrivilege?null:t),this.roomService.fetchLanguage(this.language,["_BOOKING_LIST_FRONT"])];let i=null;if(this.propertyid&&!this.havePrivilege){e.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true}))}if(this.havePrivilege){i=e.length;e.push(this.propertyService.getExposedAllowedProperties())}const s=await Promise.all(e);const[n]=s;const{pay_type:a,pay_type_group:r,pay_method:o}=this.bookingService.groupEntryTablesResult(n);this.paymentEntries={groups:r,methods:o,types:a};this.allowedProperties=i!==null?s[i]?.map((t=>t.id)):null;m("property_id",t);C({property_ids:this.allowedProperties,userTypeCode:this.userType});await this.fetchBookings()}catch(t){console.error("Error initializing app:",t)}finally{this.isLoading=false}}handleSideBarToggle(t){if(t.detail){this.editBookingItem=null}}geSearchFiltersFromParams(){const t=Z();if(t){console.log("update params");let e={};if(t.e){e["end_row"]=Number(t.e)}if(t.s){e["start_row"]=Number(t.s)}if(t.status){e["booking_status"]=t.status}if(t.filter){e["filter_type"]=t.filter}if(t.from){e["from"]=t.from}if(t.to){e["to"]=t.to}C(e)}console.log("params=>",t)}openModal(){this.listingModalTimeout=setTimeout((()=>{this.listingModal=this.el.querySelector("ir-listing-modal");this.listingModal.editBooking=this.editBookingItem;this.listingModal.openModal()}),100)}disconnectedCallback(){clearTimeout(this.listingModalTimeout)}async handlePaginationChange(t){t.stopImmediatePropagation();t.stopPropagation();if(!t.detail){return}v(t.detail.currentPage);await this.fetchBookings()}async handlePaginationPageSizeChange(t){if(!t.detail||!t.detail.pageSize){return}t.stopImmediatePropagation();t.stopPropagation();k(t.detail.pageSize);await this.fetchBookings()}async handleResetStoreData(t){t.stopImmediatePropagation();t.stopPropagation();await this.fetchBookings()}handleBookingChanged(t){t.stopImmediatePropagation();t.stopPropagation();_.bookings=[..._.bookings.map((e=>{if(e.booking_nbr===t.detail.booking_nbr){return t.detail}return e}))]}handleBookingPayment(t){t.stopImmediatePropagation();t.stopPropagation();const{booking_nbr:e,payment:i}=t.detail;this.booking=this.findBooking(e);const s=this.paymentEntries.types.find((t=>t.CODE_NAME===i.payment_type.code));this.payment={...i,payment_type:{code:s.CODE_NAME,description:s.CODE_VALUE_EN,operation:s.NOTES}};this.paymentFolioRef.openFolio()}handleSelectGuestEvent(t){t.stopImmediatePropagation();t.stopPropagation();const e=this.findBooking(t.detail);if(!e){return}this.editBookingItem={booking:e,cause:"guest"}}handleOpen(t){t.stopImmediatePropagation();const e=this.findBooking(t.detail);if(!e){return}this.editBookingItem={booking:e,cause:"edit"}}async handleResetExposedCancellationDueAmount(t){t.stopImmediatePropagation();t.stopPropagation();await this.fetchBookings()}handleGuestChanged(t){t.stopImmediatePropagation();t.stopPropagation();_.bookings=_.bookings.map((e=>{const i={...e.guest};const s=t.detail;if(i.id===s.id){return{...e,guest:{...i,...s}}}return e}))}findBooking(t){return _.bookings.find((e=>e.booking_nbr===t))}render(){if(this.isLoading||this.ticket===""){return e("ir-loading-screen",null)}return e(i,null,e("ir-interceptor",null),e("ir-toast",null),e("div",{class:"main-container"},e("ir-listing-header",{propertyId:this.propertyid,p:this.p,language:this.language}),e("section",{class:"mt-2"},e("ir-booking-listing-table",null))),e("ir-drawer",{style:{"--ir-drawer-width":"80rem","--ir-drawer-background-color":"#F2F3F8","--ir-drawer-padding-left":"0","--ir-drawer-padding-top":"0","--ir-drawer-padding-bottom":"0","--ir-drawer-padding-right":"0"},onDrawerHide:t=>{t.stopImmediatePropagation();t.stopPropagation();this.editBookingItem=null},withoutHeader:true,open:this.editBookingItem?.cause==="edit"},this.editBookingItem?.booking&&e("ir-booking-details",{hasPrint:true,hasReceipt:true,hasCloseButton:true,onCloseSidebar:()=>this.editBookingItem=null,is_from_front_desk:true,propertyid:this.propertyid,hasRoomEdit:true,hasRoomDelete:true,bookingNumber:this.editBookingItem.booking?.booking_nbr.toString(),ticket:this.ticket,language:this.language,hasRoomAdd:true})),e("ir-guest-info-drawer",{onGuestInfoDrawerClosed:()=>{this.editBookingItem=null},booking_nbr:this.editBookingItem?.booking?.booking_nbr,email:this.editBookingItem?.booking?.guest.email,language:this.language,open:this.editBookingItem?.cause==="guest"}),e("ir-payment-folio",{style:{height:"auto"},bookingNumber:this.booking?.booking_nbr,paymentEntries:this.paymentEntries,payment:this.payment,mode:"payment-action",ref:t=>this.paymentFolioRef=t,onCloseModal:()=>{this.booking=null;this.payment=null}}))}static get watchers(){return{ticket:["ticketChanged"]}}};it.style=et;const st=".sc-ir-daily-revenue-h{display:block}.daily-revenue__meta.sc-ir-daily-revenue{display:flex;flex-direction:column;gap:1rem}.daily-revenue__table.sc-ir-daily-revenue{flex:1 1 0%}@media (min-width: 768px){.daily-revenue__meta.sc-ir-daily-revenue{flex-direction:row}}";const nt=st;const at=class{constructor(e){t(this,e);this.preventPageLoad=n(this,"preventPageLoad",7)}language="";ticket="";propertyid;p;isPageLoading;property_id;groupedPayment;previousDateGroupedPayments;isLoading;filters={date:E().format("YYYY-MM-DD"),users:null};sideBarEvent;tokenService=new a;roomService=new o;propertyService=new D;bookingService=new r;paymentEntries;preventPageLoad;componentWillLoad(){if(this.ticket){this.tokenService.setToken(this.ticket);this.initializeApp()}}ticketChanged(t,e){if(t===e){return}this.tokenService.setToken(this.ticket);this.initializeApp()}handleOpenSidebar(t){t.stopImmediatePropagation();t.stopPropagation();this.sideBarEvent=t.detail}handleFetchNewReports(t){t.stopImmediatePropagation();t.stopPropagation();this.filters={...t.detail};this.getPaymentReports()}async handleResetBooking(t){t.stopPropagation();t.stopImmediatePropagation();this.getPaymentReports(false,true)}handleSidebarClose=t=>{t.stopImmediatePropagation();t.stopPropagation();this.sideBarEvent=null};renderSidebarBody(){if(!this.sideBarEvent){return}switch(this.sideBarEvent.type){case"booking":return e("ir-booking-details",{slot:"sidebar-body",hasPrint:true,hasReceipt:true,hasCloseButton:true,onCloseSidebar:this.handleSidebarClose,is_from_front_desk:true,propertyid:this.property_id,hasRoomEdit:true,hasRoomDelete:true,bookingNumber:this.sideBarEvent.payload.bookingNumber.toString(),ticket:this.ticket,language:this.language,hasRoomAdd:true});default:return null}}async initializeApp(){this.isPageLoading=true;try{let t=this.propertyid;if(!t&&!this.p){throw new Error("Property ID or username is required")}if(!t){const e=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});t=e.My_Result.id}this.property_id=t;const e=[this.bookingService.getSetupEntriesByTableNameMulti(["_PAY_TYPE","_PAY_TYPE_GROUP","_PAY_METHOD"]),this.getPaymentReports(),this.roomService.fetchLanguage(this.language)];if(t){e.push(this.roomService.getExposedProperty({id:t,language:this.language,is_backend:true,include_units_hk_status:true}))}const[i]=await Promise.all(e);const{pay_type:s,pay_type_group:n,pay_method:a}=this.bookingService.groupEntryTablesResult(i);this.paymentEntries={groups:n,methods:a,types:s}}catch(t){console.log(t)}finally{this.isPageLoading=false}}groupPaymentsByName(t){const e=new Map;for(const i of t){const t=`${i.payTypeCode}_${i.payMethodCode}`;const s=e.get(t)??[];e.set(t,[...s,i])}return new Map([...e.entries()].sort((([t],[e])=>{const i=Number(t);const s=Number(e);if(!isNaN(i)&&!isNaN(s)){return i-s}return t.localeCompare(e)})))}async getPaymentReports(t=false,e=false){try{const i=t=>({method:t.METHOD,payTypeCode:t.PAY_TYPE_CODE,payMethodCode:t.PAY_METHOD_CODE,amount:t.AMOUNT,date:t.DATE,hour:t.HOUR,minute:t.MINUTE,user:t.USER,currency:t.CURRENCY,bookingNbr:t.BOOKING_NBR,id:M()});this.isLoading=t?"export":"filter";const s=[this.propertyService.getDailyRevenueReport({date:this.filters.date,property_id:this.property_id?.toString(),is_export_to_excel:t})];if(!t&&!e){s.push(this.propertyService.getDailyRevenueReport({date:E(this.filters.date,"YYYY-MM-DD").add(-1,"days").format("YYYY-MM-DD"),property_id:this.property_id?.toString(),is_export_to_excel:t}))}const n=await Promise.all(s);if(!t){if(n[0]){this.groupedPayment=this.groupPaymentsByName(n[0]?.map(i))}else{this.groupedPayment=new Map}if(n[1])this.previousDateGroupedPayments=this.groupPaymentsByName(n[1]?.map(i))}}catch(t){console.log(t)}finally{this.isLoading=null}}render(){if(this.isPageLoading){return e("ir-loading-screen",null)}return e(i,null,e("ir-toast",null),e("ir-interceptor",null),e("section",{class:"p-2 d-flex flex-column",style:{gap:"1rem"}},e("div",{class:"d-flex align-items-center justify-content-between"},e("h3",{class:"mb-1 mb-md-0"},"Daily Revenue"),e("ir-button",{size:"sm",btn_color:"outline",isLoading:this.isLoading==="export",text:x.entries?.Lcz_Export,onClickHandler:async t=>{t.stopImmediatePropagation();t.stopPropagation();await this.getPaymentReports(true)},btnStyle:{height:"100%"},iconPosition:"right",icon_name:"file",icon_style:{"--icon-size":"14px"}})),e("ir-revenue-summary",{previousDateGroupedPayments:this.previousDateGroupedPayments,groupedPayments:this.groupedPayment,paymentEntries:this.paymentEntries}),e("div",{class:"daily-revenue__meta"},e("ir-daily-revenue-filters",{isLoading:this.isLoading==="filter",payments:this.groupedPayment}),e("ir-revenue-table",{filters:this.filters,class:"daily-revenue__table",paymentEntries:this.paymentEntries,payments:this.groupedPayment}))),e("ir-sidebar",{sidebarStyles:{width:this.sideBarEvent?.type==="booking"?"80rem":"var(--sidebar-width,40rem)",background:this.sideBarEvent?.type==="booking"?"#F2F3F8":"white"},open:Boolean(this.sideBarEvent),showCloseButton:false,onIrSidebarToggle:this.handleSidebarClose},this.renderSidebarBody()))}static get watchers(){return{ticket:["ticketChanged"]}}};at.style=nt;const rt=".page-title.sc-ir-departures{font-family:var(--wa-font-family-heading);font-weight:var(--wa-font-weight-heading);line-height:var(--wa-line-height-condensed);text-wrap:balance;font-size:var(--wa-font-size-xl)}";const ot=rt;const lt=class{constructor(e){t(this,e)}ticket;propertyid;language="en";p;bookingNumber;booking;paymentEntries;isPageLoading;payment;checkoutState=null;invoiceState=null;tokenService=new a;roomService=new o;bookingService=new r;paymentFolioRef;componentWillLoad(){if(this.ticket){this.tokenService.setToken(this.ticket);this.init()}T("today",(t=>{this.getBookings()}))}handleTicketChange(t,e){if(t!==e){this.tokenService.setToken(this.ticket);this.init()}}handleOpen(t){this.bookingNumber=t.detail}handleBookingPayment(t){t.stopImmediatePropagation();t.stopPropagation();const{booking_nbr:e,payment:i}=t.detail;this.booking=R.bookings.find((t=>t.booking_nbr===e));const s=this.paymentEntries.types.find((t=>t.CODE_NAME===i.payment_type.code));this.payment={...i,payment_type:{code:s.CODE_NAME,description:s.CODE_VALUE_EN,operation:s.NOTES}};this.paymentFolioRef.openFolio()}async handleResetExposedCancellationDueAmount(t){t.stopImmediatePropagation();t.stopPropagation();await this.getBookings()}async init(){try{this.isPageLoading=true;if(!this.propertyid&&!this.p){throw new Error("Missing credentials")}let t=this.propertyid;if(!t){await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true})}const[e,i,s]=await Promise.all([g?.property?Promise.resolve(null):this.roomService.getExposedProperty({id:this.propertyid||0,language:this.language,aname:this.p}),this.roomService.fetchLanguage(this.language),this.bookingService.getSetupEntriesByTableNameMulti(["_BED_PREFERENCE_TYPE","_DEPARTURE_TIME","_PAY_TYPE","_PAY_TYPE_GROUP","_PAY_METHOD"]),this.getBookings()]);const{pay_type:n,pay_type_group:a,pay_method:r}=this.bookingService.groupEntryTablesResult(s);this.paymentEntries={types:n,groups:a,methods:r}}catch(t){}finally{this.isPageLoading=false}}async getBookings(){const{bookings:t,total_count:e}=await this.bookingService.getRoomsToCheckout({property_id:g.property?.id?.toString()||this.propertyid?.toString(),check_out_date:R.today,page_index:R.pagination.currentPage,page_size:R.pagination.pageSize});A(e??0);O(t)}handleCheckoutRoom(t){t.stopImmediatePropagation();t.stopPropagation();this.checkoutState=t.detail}async handlePaginationChange(t){t.stopImmediatePropagation();t.stopPropagation();const e=t.detail?.currentPage??1;if(e===R.pagination.currentPage){return}N(e);await this.getBookings()}async handleCheckoutDialogClosed(t){t.stopImmediatePropagation();t.stopPropagation();const e={...this.checkoutState};this.checkoutState=null;switch(t.detail.reason){case"checkout":await this.getBookings();break;case"openInvoice":this.invoiceState={...e};await this.getBookings();break}}async handlePaginationPageSizeChange(t){t.stopImmediatePropagation();t.stopPropagation();const e=t.detail?.pageSize;if(!Number.isFinite(e)){return}const i=Math.floor(Number(e));if(i===R.pagination.pageSize){return}I(i);await this.getBookings()}handleInvoiceClose(t){t.stopImmediatePropagation();t.stopPropagation();this.invoiceState=null}render(){if(this.isPageLoading){return e("ir-loading-screen",null)}return e(i,null,e("ir-toast",null),e("ir-interceptor",{handledEndpoints:["/Get_Rooms_To_Check_Out"]}),e("div",{class:"ir-page__container"},e("h3",{class:"page-title"},"Check-outs"),e("ir-departures-table",{onCheckoutRoom:t=>this.handleCheckoutRoom(t),onRequestPageChange:t=>this.handlePaginationChange(t),onRequestPageSizeChange:t=>this.handlePaginationPageSizeChange(t)})),e("ir-drawer",{onDrawerHide:t=>{t.stopImmediatePropagation();t.stopPropagation();this.bookingNumber=null},withoutHeader:true,open:!!this.bookingNumber,style:{"--ir-drawer-width":"80rem","--ir-drawer-background-color":"#F2F3F8","--ir-drawer-padding-left":"0","--ir-drawer-padding-right":"0","--ir-drawer-padding-top":"0","--ir-drawer-padding-bottom":"0"}},this.bookingNumber&&e("ir-booking-details",{hasPrint:true,hasReceipt:true,hasCloseButton:true,onCloseSidebar:()=>this.bookingNumber=null,is_from_front_desk:true,propertyid:this.propertyid,hasRoomEdit:true,hasRoomDelete:true,bookingNumber:this.bookingNumber.toString(),ticket:this.ticket,language:this.language,hasRoomAdd:true})),e("ir-payment-folio",{style:{height:"auto"},bookingNumber:this.booking?.booking_nbr,paymentEntries:this.paymentEntries,payment:this.payment,mode:"payment-action",ref:t=>this.paymentFolioRef=t,onCloseModal:()=>{this.booking=null;this.payment=null}}),e("ir-checkout-dialog",{booking:this.checkoutState?.booking,identifier:this.checkoutState?.identifier,open:this.checkoutState!==null,onCheckoutDialogClosed:t=>this.handleCheckoutDialogClosed(t)}),e("ir-invoice",{onInvoiceClose:t=>this.handleInvoiceClose(t),booking:this.invoiceState?.booking,roomIdentifier:this.invoiceState?.identifier,open:this.invoiceState!==null}))}static get watchers(){return{ticket:["handleTicketChange"]}}};lt.style=ot;const ht=".sc-ir-hk-tasks-h{display:block;box-sizing:border-box}.sc-ir-hk-tasks-h *.sc-ir-hk-tasks{box-sizing:border-box}.tasks-view.sc-ir-hk-tasks{display:flex;flex-direction:column}@media (min-width: 1024px){.tasks-view.sc-ir-hk-tasks{flex-direction:row}}";const ct=ht;const dt=class{constructor(e){t(this,e);this.clearSelectedHkTasks=n(this,"clearSelectedHkTasks",7)}get el(){return s(this)}language="";ticket="";propertyid;p;baseUrl;isLoading=false;isCleaningLoading=false;selectedDuration="";selectedHouseKeeper="0";selectedRoom=null;archiveOpened=false;property_id;isSidebarOpen;isApplyFiltersLoading;filters;modalCauses;clearSelectedHkTasks;hkNameCache={};roomService=new o;houseKeepingService=new B;token=new a;table_sorting=new Map;modal;componentWillLoad(){if(this.baseUrl){this.token.setBaseUrl(this.baseUrl)}if(this.ticket!==""){this.token.setToken(this.ticket);this.init()}}ticketChanged(t,e){if(t===e){return}this.token.setToken(this.ticket);this.init()}handleCloseSidebar(t){t.stopImmediatePropagation();t.stopPropagation();this.isSidebarOpen=false}handleSortingChanged(t){t.stopImmediatePropagation();t.stopPropagation();const{field:e,direction:i}=t.detail;console.log(t.detail);if(e==="date"){return}this.table_sorting.set(e,i)}handleSkipSelectedTask(t){t.stopImmediatePropagation();t.stopPropagation();this.modalCauses={task:t.detail,cause:"skip"};this.modal?.openModal()}async init(){try{this.isLoading=true;z(true);let t=this.propertyid;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}if(!t){console.log(t);const e=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});t=e.My_Result.id}this.property_id=t;const e=[this.houseKeepingService.getExposedHKSetup(this.property_id),this.roomService.fetchLanguage(this.language)];if(this.propertyid){e.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true,include_units_hk_status:true}))}await Promise.all(e);const i=await this.houseKeepingService.getHkTasks({property_id:this.property_id,from_date:E().format("YYYY-MM-DD"),to_date:E().format("YYYY-MM-DD"),housekeepers:[],cleaning_frequency:(g.cleaning_frequency??F?.hk_criteria?.cleaning_frequencies[0])?.code,dusty_window:F?.hk_criteria?.dusty_periods[0]?.code,highlight_window:F?.hk_criteria?.highlight_checkin_options[0]?.code});if(i?.tasks){this.updateTasks(i.tasks)}}catch(t){console.log(t)}finally{this.isLoading=false;z(false)}}buildHousekeeperNameCache(){this.hkNameCache={};F.hk_criteria?.housekeepers?.forEach((t=>{if(t.id!=null&&t.name!=null){this.hkNameCache[t.id]=t.name}}))}updateTasks(t){this.buildHousekeeperNameCache();U(t.map((t=>({...t,id:M(),housekeeper:(()=>{const e=this.hkNameCache[t.hkm_id];if(e){return e}const i=F.hk_criteria?.housekeepers?.find((e=>e.id===t.hkm_id))?.name;this.hkNameCache[t.hkm_id]=i;return i})()}))))}async handleHeaderButtonPress(t){t.stopImmediatePropagation();t.stopPropagation();const{name:e}=t.detail;switch(e){case"cleaned":case"clean-inspect":this.modal?.openModal();this.modalCauses={task:null,cause:"clean",status:e==="clean-inspect"?"004":"001"};break;case"export":const t=Array.from(this.table_sorting.entries()).map((([t,e])=>({key:t,value:e})));console.log(t);const{url:i}=await this.fetchTasksWithFilters(true);P(i);break;case"archive":this.isSidebarOpen=true;break}}handleSelectedTaskCleaningEvent(t){t.stopImmediatePropagation();t.stopPropagation();this.modalCauses={...t.detail,cause:"clean"};this.modal?.openModal()}async handleModalConfirmation(t){try{t.stopImmediatePropagation();t.stopPropagation();if(H.selectedTasks.length===0){return}this.isCleaningLoading=true;if(this.modalCauses?.cause==="skip"){const{booking_nbr:t,date:e,unit:i}=this.modalCauses.task;await this.houseKeepingService.editHkSkip({BOOK_NBR:t,DATE:e,COMMENT:"",HK_SKIP_ID:-1,HK_SKIP_REASON_CODE:"001",PR_ID:i.id})}else{await this.houseKeepingService.executeHKAction({actions:H.selectedTasks.map((t=>({description:"Cleaned",hkm_id:t.hkm_id===0?null:t.hkm_id,unit_id:t.unit.id,booking_nbr:t.booking_nbr,status:this.modalCauses?.status??"001"})))})}await this.fetchTasksWithFilters()}finally{j();if(this.modalCauses){this.modalCauses=null}this.isCleaningLoading=false;this.modal.closeModal()}}async applyFilters(t){try{this.isApplyFiltersLoading=true;t.stopImmediatePropagation();t.stopPropagation();this.filters={...t.detail};await this.fetchTasksWithFilters()}catch(t){console.log(t)}finally{this.isApplyFiltersLoading=false}}async fetchTasksWithFilters(t=false){const{cleaning_periods:e,housekeepers:i,cleaning_frequencies:s,dusty_units:n,highlight_check_ins:a}=this.filters??{};const{tasks:r,url:o}=await this.houseKeepingService.getHkTasks({housekeepers:i,cleaning_frequency:s?.code,dusty_window:n?.code,highlight_window:a?.code,property_id:this.property_id,from_date:E().format("YYYY-MM-DD"),to_date:e?.code||E().format("YYYY-MM-DD"),is_export_to_excel:t});console.log(r);if(r){this.updateTasks(r)}return{tasks:r,url:o}}render(){if(this.isLoading){return e("ir-loading-screen",null)}return e(i,{"data-testid":"hk_tasks_base"},e("ir-toast",null),e("ir-interceptor",null),e("section",{class:"p-1 d-flex flex-column",style:{gap:"1rem"}},e("h3",null,"Housekeeping Tasks"),e("div",{class:"tasks-view ",style:{gap:"1rem"}},e("ir-tasks-filters",{isLoading:this.isApplyFiltersLoading,onApplyFilters:t=>{this.applyFilters(t)}}),e("div",{class:"d-flex w-100 flex-column",style:{gap:"1rem"}},e("ir-tasks-table",{onRowSelectChange:t=>{t.stopImmediatePropagation();t.stopPropagation();G(t.detail)},class:"flex-grow-1 w-100"})))),e("ir-modal",{autoClose:false,ref:t=>this.modal=t,isLoading:this.isCleaningLoading,onConfirmModal:this.handleModalConfirmation.bind(this),onCancelModal:()=>{if(this.modalCauses){j();this.modalCauses=null}},iconAvailable:true,icon:"ft-alert-triangle danger h1",leftBtnText:x.entries.Lcz_Cancel,rightBtnText:x.entries.Lcz_Confirm,leftBtnColor:"secondary",rightBtnColor:"primary",modalTitle:x.entries.Lcz_Confirmation,modalBody:this.modalCauses?this.modalCauses?.cause==="clean"?this.modalCauses.task?`Update ${this.modalCauses?.task?.unit?.name} to Clean`:"Update selected unit(s) to Clean":"Skip cleaning and reschedule for tomorrow.":"Update selected unit(s) to Clean"}),e("ir-sidebar",{open:this.isSidebarOpen,id:"editGuestInfo",onIrSidebarToggle:t=>{t.stopImmediatePropagation();t.stopPropagation();this.isSidebarOpen=false},showCloseButton:false},this.isSidebarOpen&&e("ir-hk-archive",{ticket:this.token.getToken(),propertyId:this.property_id,slot:"sidebar-body"})))}static get watchers(){return{ticket:["ticketChanged"]}}};dt.style=ct;const ut=".sc-ir-housekeeping-h{display:block}";const pt=ut;const gt=class{constructor(e){t(this,e);this.toast=n(this,"toast",7)}language="";ticket="";propertyid;p;baseUrl;isLoading=false;toast;roomService=new o;houseKeepingService=new B;propertyService=new D;token=new a;modal;selectedCleaningFrequency;componentWillLoad(){if(this.baseUrl){this.token.setBaseUrl(this.baseUrl)}if(this.ticket!==""){this.token.setToken(this.ticket);this.initializeApp()}}async handleResetData(t){t.stopImmediatePropagation();t.stopPropagation();await this.houseKeepingService.getExposedHKSetup(this.propertyid)}ticketChanged(t,e){if(t===e){return}this.token.setToken(this.ticket);this.initializeApp()}async initializeApp(){try{this.isLoading=true;let t=this.propertyid;if(!t){const e=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_sales_rate_plans:true});t=e.My_Result.id}L("default_properties",{token:this.ticket,property_id:t,language:this.language});const e=[];if(g.housekeeping_enabled){e.push(this.houseKeepingService.getExposedHKSetup(t))}e.push(this.roomService.fetchLanguage(this.language,["_HK_FRONT","_PMS_FRONT"]));if(this.propertyid){e.push(this.roomService.getExposedProperty({id:t,language:this.language,is_backend:true,include_sales_rate_plans:true}))}await Promise.all(e);this.selectedCleaningFrequency=g.cleaning_frequency?.code}catch(t){console.error(t)}finally{this.isLoading=false}}async saveAutomaticCheckInCheckout(t){t.stopImmediatePropagation();t.stopPropagation();try{await this.roomService.SetAutomaticCheckInOut({property_id:F.default_properties.property_id,flag:t.detail==="auto"});this.toast.emit({position:"top-right",title:"Saved Successfully",description:"",type:"success"})}catch(t){console.log(t)}}async saveCleaningFrequency(t){t.stopImmediatePropagation();t.stopPropagation();try{await this.propertyService.setExposedCleaningFrequency({property_id:F.default_properties.property_id,code:this.selectedCleaningFrequency});g.cleaning_frequency={code:this.selectedCleaningFrequency,description:""};this.toast.emit({position:"top-right",title:"Saved Successfully",description:"",type:"success"});this.modal.closeModal()}catch(t){console.log(t)}}render(){if(this.isLoading){return e("ir-loading-screen",null)}console.log(g.cleaning_frequency);return e(i,null,e("ir-interceptor",null),e("ir-toast",null),e("section",{class:"p-1"},e("h3",{class:"mb-2"},x.entries.Lcz_HouseKeepingAndCheckInSetup),e("div",{class:"card p-1"},e("ir-title",{borderShown:true,label:"Operations Settings"}),e("div",{class:"d-flex align-items-center mb-1"},e("p",{class:"my-0 py-0 mr-1"},x.entries.Lcz_CheckInOutGuestsAutomatically),e("ir-select",{showFirstOption:false,selectedValue:g.is_automatic_check_in_out?"auto":"manual",onSelectChange:t=>this.saveAutomaticCheckInCheckout(t),data:[{text:x.entries.Lcz_YesAsPerPropertyPolicy,value:"auto"},{text:x.entries.Lcz_NoIWillDoItManually,value:"manual"}]})),e("div",{class:"d-flex align-items-center"},e("p",{class:"my-0 py-0 mr-1"},x.entries.Lcz_CleaningFrequency,":"),e("ir-select",{showFirstOption:false,selectedValue:this.selectedCleaningFrequency,onSelectChange:t=>{t.stopImmediatePropagation();t.stopPropagation();this.selectedCleaningFrequency=t.detail;this.modal.openModal()},data:F?.hk_criteria?.cleaning_frequencies.map((t=>({text:t.description,value:t.code})))}))),g.housekeeping_enabled&&e("ir-hk-team",{class:"mb-1"}),e("ir-modal",{autoClose:false,ref:t=>this.modal=t,isLoading:q("/Set_Exposed_Cleaning_Frequency"),onConfirmModal:this.saveCleaningFrequency.bind(this),iconAvailable:true,onCancelModal:()=>{this.selectedCleaningFrequency=g.cleaning_frequency?.code},icon:"ft-alert-triangle danger h1",leftBtnText:x.entries.Lcz_Cancel,rightBtnText:x.entries.Lcz_Confirm,leftBtnColor:"secondary",rightBtnColor:"primary",modalTitle:x.entries.Lcz_Confirmation,modalBody:"This action will reschedule all cleaning tasks. Do you want to continue?"})))}static get watchers(){return{ticket:["ticketChanged"]}}};gt.style=pt;const ft=".sc-ir-monthly-bookings-report-h{display:block}";const yt=ft;const mt=class{constructor(e){t(this,e)}language="";ticket="";propertyid;p;isPageLoading=true;isLoading=null;reports=[];filters;property_id;stats;baseFilters;tokenService=new a;roomService=new o;propertyService=new D;componentWillLoad(){this.baseFilters={date:{description:E().format("MMMM YYYY"),firstOfMonth:E().startOf("month").format("YYYY-MM-DD"),lastOfMonth:E().endOf("month").format("YYYY-MM-DD")},include_previous_year:false};this.filters=this.baseFilters;if(this.ticket){this.tokenService.setToken(this.ticket);this.init()}}handleTicketChange(t,e){if(t!==e){this.tokenService.setToken(this.ticket);this.init()}}handleApplyFiltersChange(t){t.stopImmediatePropagation();t.stopPropagation();this.filters=t.detail;this.getReports()}async init(){try{let t=this.propertyid;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}if(!t){console.log(t);const e=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});t=e.My_Result.id}this.property_id=t;const e=[this.roomService.fetchLanguage(this.language),this.getReports()];if(this.propertyid){e.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true,include_units_hk_status:true}))}await Promise.all(e)}catch(t){console.log(t)}finally{this.isPageLoading=false}}async getReports(t=false){try{const e=t=>({day:t.Date,units_booked:t.Units_booked,occupancy_percent:t.Occupancy,adr:t.ADR,rooms_revenue:t.Rooms_Revenue,total_guests:t?.Total_Guests});this.isLoading=t?"export":"filter";const{date:i,include_previous_year:s}=this.filters;const n=[this.propertyService.getMonthlyStats({from_date:i.firstOfMonth,to_date:i.lastOfMonth,property_id:this.property_id,is_export_to_excel:t})];if(s){n.push(this.propertyService.getMonthlyStats({from_date:E(i.firstOfMonth,"YYYY-MM-DD").add(-1,"year").format("YYYY-MM-DD"),to_date:E(i.lastOfMonth,"YYYY-MM-DD").add(-1,"years").format("YYYY-MM-DD"),property_id:this.property_id}))}const a=await Promise.all(n);const r=a[0];let o=[];const{DailyStats:l,...h}=r;this.stats={...h};if(s&&a[t?0:1]){const i=a[t?0:1];let s=i.DailyStats.map(e);o=l.map(e).map((t=>{const e=s.find((e=>e.day===E(t.day,"YYYY-MM-DD").add(-1,"years").format("YYYY-MM-DD")));return{...t,last_year:e??null}}))}else{o=l.map(e)}this.reports=[...o]}catch(t){console.log(t)}finally{this.isLoading=null}}render(){if(this.isPageLoading){return e("ir-loading-screen",null)}return e(i,null,e("ir-toast",null),e("ir-interceptor",null),e("section",{class:"p-2 d-flex flex-column",style:{gap:"1rem"}},e("div",{class:"d-flex align-items-center justify-content-between"},e("h3",{class:"mb-1 mb-md-0"},"Daily Occupancy"),e("ir-button",{size:"sm",btn_color:"outline",isLoading:this.isLoading==="export",text:x.entries?.Lcz_Export,onClickHandler:async t=>{t.stopImmediatePropagation();t.stopPropagation();await this.getReports(true)},btnStyle:{height:"100%"},iconPosition:"right",icon_name:"file",icon_style:{"--icon-size":"14px"}})),e("section",null,e("div",{class:"d-flex flex-column flex-md-row w-100",style:{gap:"1rem",alignItems:"stretch"}},e("ir-stats-card",{icon:this.stats?.Occupancy_Difference_From_Previous_Month<0?"arrow-trend-down":"arrow-trend-up",cardTitle:"Average Occupancy",value:this.stats.AverageOccupancy?this.stats?.AverageOccupancy.toFixed(2)+"%":null,subtitle:`${this.stats?.Occupancy_Difference_From_Previous_Month<0?"":"+"}${this.stats?.Occupancy_Difference_From_Previous_Month.toFixed(2)}% from last month`}),e("ir-stats-card",{icon:"hotel",cardTitle:"Total Units",value:this.stats?.TotalUnitsBooked?this.stats?.TotalUnitsBooked.toString():null,subtitle:"Booked"}),e("ir-stats-card",{icon:"user_group",cardTitle:"Total Guests",value:this.stats?.Total_Guests?.toString(),subtitle:"Stayed"}),e("ir-stats-card",{icon:"calendar",cardTitle:"Peak Days",value:this.stats?.PeakDays.length===0?null:this.stats?.PeakDays?.map((t=>E(t.Date,"YYYY-MM-DD").format("D").concat("th"))).join(" - "),subtitle:`${Math.max(...this.stats.PeakDays?.map((t=>t.OccupancyPercent))||[])}% occupancy`})),e("div",{class:"d-flex flex-column flex-lg-row mt-1 ",style:{gap:"1rem"}},e("ir-monthly-bookings-report-filter",{isLoading:this.isLoading==="filter",class:"filters-card",baseFilters:this.baseFilters}),e("ir-monthly-bookings-report-table",{reports:this.reports})))))}static get watchers(){return{ticket:["handleTicketChange"]}}};mt.style=yt;const _t=".sc-ir-sales-by-channel-h{display:block}";const kt=_t;const bt=class{constructor(e){t(this,e)}language="";ticket="";propertyid;p;mode;isLoading=null;isPageLoading=true;salesData;channelSalesFilters;allowedProperties=[];propertyID;token=new a;roomService=new o;propertyService=new D;baseFilters={FROM_DATE:E().add(-7,"days").format("YYYY-MM-DD"),TO_DATE:E().format("YYYY-MM-DD"),BOOK_CASE:"001",WINDOW:7,include_previous_year:false,is_export_to_excel:false};componentWillLoad(){this.channelSalesFilters=this.baseFilters;if(this.ticket){this.token.setToken(this.ticket);this.initializeApp()}}ticketChanged(t,e){if(t===e){return}this.token.setToken(this.ticket);this.initializeApp()}async initializeApp(){try{if(!this.mode){throw new Error("Missing required 'mode'. Please set it to either 'property' or 'mpo'.")}if(!this.propertyid&&this.mode==="property"&&!this.p){throw new Error("Missing Property ID or aname")}if(this.mode==="property"){const t=await this.propertyService.getExposedProperty({id:Number(this.propertyid??0),aname:this.p,language:this.language,is_backend:true});this.propertyID=t.My_Result.id}const t=[,this.roomService.fetchLanguage(this.language)];if(this.mode==="mpo"){t.unshift(this.propertyService.getExposedAllowedProperties());const[e]=await Promise.all(t);this.allowedProperties=[...e]}this.baseFilters={...this.baseFilters,LIST_AC_ID:this.allowedProperties?.map((t=>t.id))};this.channelSalesFilters={...this.baseFilters};await this.getChannelSales()}catch(t){console.log(t)}finally{this.isPageLoading=false}}async getChannelSales(t=false){try{const{include_previous_year:e,LIST_AC_ID:i,...s}=this.channelSalesFilters;this.isLoading=t?"export":"filter";const n=await this.propertyService.getChannelSales({is_export_to_excel:t,...s,AC_ID:this.propertyID?this.propertyID.toString():undefined,...s,LIST_AC_ID:this.propertyID?null:i});const a=!t&&e;let r=[];if(a){const t=await this.propertyService.getChannelSales({AC_ID:this.propertyID?this.propertyID.toString():undefined,...s,LIST_AC_ID:this.propertyID?null:i,FROM_DATE:E(s.FROM_DATE).subtract(1,"year").format("YYYY-MM-DD"),TO_DATE:E(s.TO_DATE).subtract(1,"year").format("YYYY-MM-DD")});r=n.map((e=>{const i=t.find((t=>t.SOURCE.toLowerCase()===e.SOURCE.toLowerCase()));return{...e,last_year:i?i:null}}))}else{r=n.map((t=>({...t,last_year:null})))}const o=t=>{if(!t||t.length===0)return t;const e=t=>t?.currency??null;const i=t=>{const i=t.SOURCE.toString().toLowerCase().trim();const s=e(t);return`${i}__${s??"null"}`};const s=(t,e)=>(t??0)+(e??0);const n=(t,e)=>{if(!e)return t;if(!t)return{...e};return{NIGHTS:s(t.NIGHTS,e.NIGHTS),PCT:s(t.PCT,e.PCT),REVENUE:s(t.REVENUE,e.REVENUE),SOURCE:t.SOURCE,PROPERTY_ID:t.PROPERTY_ID,PROPERTY_NAME:t.PROPERTY_NAME,currency:t.currency}};const a=new Map;for(const e of t){const t=i(e);const r=a.get(t);if(!r){a.set(t,{...e})}else{const i={...r,NIGHTS:s(r.NIGHTS,e.NIGHTS),PCT:0,REVENUE:s(r.REVENUE,e.REVENUE),last_year:n(r.last_year,e.last_year)};a.set(t,i)}}const r=Array.from(a.values());const o=r.reduce(((t,e)=>t+(e.REVENUE??0)),0);if(o>0){for(const t of r){t.PCT=t.REVENUE/o*100;if(t.last_year){const e=r.reduce(((t,e)=>t+(e.last_year?.REVENUE??0)),0);if(e>0){t.last_year.PCT=t.last_year.REVENUE/e*100}}}}return r};this.salesData=[...o(r)]}catch(t){console.error("Failed to fetch sales data:",t)}finally{this.isLoading=null}}render(){if(this.isPageLoading){return e("ir-loading-screen",null)}return e(i,null,e("ir-toast",null),e("ir-interceptor",null),e("section",{class:"p-2 d-flex flex-column",style:{gap:"1rem"}},e("div",{class:"d-flex align-items-center justify-content-between"},e("h3",{class:"mb-1 mb-md-0"},"Sales by Channel"),e("ir-button",{size:"sm",btn_color:"outline",isLoading:this.isLoading==="export",text:x.entries.Lcz_Export,onClickHandler:async t=>{t.stopImmediatePropagation();t.stopPropagation();await this.getChannelSales(true)},btnStyle:{height:"100%"},iconPosition:"right",icon_name:"file",icon_style:{"--icon-size":"14px"}})),e("div",{class:"d-flex flex-column flex-lg-row mt-1 ",style:{gap:"1rem"}},e("ir-sales-by-channel-filters",{isLoading:this.isLoading==="filter",onApplyFilters:t=>{t.stopImmediatePropagation();t.stopPropagation();this.channelSalesFilters={...t.detail};this.getChannelSales()},allowedProperties:this.allowedProperties,baseFilters:this.baseFilters}),e("ir-sales-by-channel-table",{mode:this.mode,allowedProperties:this.allowedProperties,class:"card mb-0",records:this.salesData}))))}static get watchers(){return{ticket:["ticketChanged"]}}};bt.style=kt;const wt=".sc-ir-sales-by-country-h{display:block}";const Ct=wt;const vt=class{constructor(e){t(this,e)}language="";ticket="";propertyid;p;isLoading=null;isPageLoading=true;property_id;salesData;salesFilters;countries=new Map;token=new a;roomService=new o;propertyService=new D;bookingService=new r;baseFilters={FROM_DATE:E().add(-7,"days").format("YYYY-MM-DD"),TO_DATE:E().format("YYYY-MM-DD"),BOOK_CASE:"001",WINDOW:7,include_previous_year:false};componentWillLoad(){this.salesFilters=this.baseFilters;if(this.ticket){this.token.setToken(this.ticket);this.initializeApp()}}ticketChanged(t,e){if(t===e){return}this.token.setToken(this.ticket);this.initializeApp()}async initializeApp(){try{let t=this.propertyid;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}if(!t){console.log(t);const e=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});t=e.My_Result.id}this.property_id=t;const e=[this.bookingService.getCountries(this.language),this.roomService.fetchLanguage(this.language),this.getCountrySales()];if(this.propertyid){e.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true,include_units_hk_status:true}))}const[i]=await Promise.all(e);const s=new Map;i.map((t=>{s.set(t.id,{flag:t.flag,name:t.name})}));this.countries=s}catch(t){console.log(t)}finally{this.isPageLoading=false}}async getCountrySales(t=false){const e=t=>({country:t.COUNTRY,country_id:t.COUNTRY_ID,nights:t.NIGHTS,percentage:t.PCT,revenue:t.REVENUE,number_of_guests:t.Total_Guests});try{const{include_previous_year:i,...s}=this.salesFilters;this.isLoading=t?"export":"filter";const n=await this.propertyService.getCountrySales({AC_ID:this.property_id,is_export_to_excel:t,...s});const a=!t&&i;let r=[];if(a){const t=await this.propertyService.getCountrySales({AC_ID:this.property_id,is_export_to_excel:false,...s,FROM_DATE:E(s.FROM_DATE).subtract(1,"year").format("YYYY-MM-DD"),TO_DATE:E(s.TO_DATE).subtract(1,"year").format("YYYY-MM-DD")});r=n.map((i=>{const s=t.find((t=>t.COUNTRY.toLowerCase()===i.COUNTRY.toLowerCase()));return{id:M(),...e(i),last_year:s?e(s):null}}))}else{r=n.map((t=>({id:M(),...e(t),last_year:null})))}this.salesData=[...r]}catch(t){console.error("Failed to fetch sales data:",t)}finally{this.isLoading=null}}render(){if(this.isPageLoading){return e("ir-loading-screen",null)}return e(i,null,e("ir-toast",null),e("ir-interceptor",null),e("section",{class:"p-2 d-flex flex-column",style:{gap:"1rem"}},e("div",{class:"d-flex align-items-center justify-content-between"},e("h3",{class:"mb-1 mb-md-0"},"Sales by Country"),e("ir-button",{size:"sm",btn_color:"outline",isLoading:this.isLoading==="export",text:x.entries.Lcz_Export,onClickHandler:async t=>{t.stopImmediatePropagation();t.stopPropagation();await this.getCountrySales(true)},btnStyle:{height:"100%"},iconPosition:"right",icon_name:"file",icon_style:{"--icon-size":"14px"}})),e("ir-sales-by-country-summary",{salesReports:this.salesData}),e("div",{class:"d-flex flex-column flex-lg-row mt-1 ",style:{gap:"1rem"}},e("ir-sales-filters",{isLoading:this.isLoading==="filter",onApplyFilters:t=>{t.stopImmediatePropagation();t.stopPropagation();this.salesFilters=t.detail;this.getCountrySales()},class:"filters-card",baseFilters:this.baseFilters}),e("ir-sales-table",{mappedCountries:this.countries,class:"card mb-0",records:this.salesData}))))}static get watchers(){return{ticket:["ticketChanged"]}}};vt.style=Ct;const Yt=".sc-ir-user-management-h{display:block;height:100%}";const Pt=Yt;const Dt=class{constructor(e){t(this,e)}language="";baseUrl;ticket;propertyid;p;isSuperAdmin=true;userTypeCode;baseUserTypeCode;userId;isLoading=true;users=[];property_id;allowedUsersTypes=[];token=new a;roomService=new o;userService=new K;bookingService=new r;userTypes=new Map;socket;superAdminId="5";componentWillLoad(){if(this.baseUrl){this.token.setBaseUrl(this.baseUrl)}if(this.ticket){this.token.setToken(this.ticket);this.initializeApp()}}ticketChanged(t,e){if(t===e){return}this.token.setToken(this.ticket);this.initializeApp()}async handleResetData(t){t.stopImmediatePropagation();t.stopPropagation();await this.fetchUsers()}async initializeApp(){try{if(this.baseUrl){this.token.setBaseUrl(this.baseUrl)}this.isLoading=true;let t=this.propertyid;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}if(!t){console.log(t);const e=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});t=e.My_Result.id}this.property_id=t;const e=[this.fetchUserTypes(),this.fetchUsers(),this.roomService.fetchLanguage(this.language,["_USER_MGT"])];if(this.propertyid){e.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true,include_units_hk_status:true}))}await Promise.all(e);this.socket=S("https://realtime.igloorooms.com/");this.socket.on("MSG",(async t=>{await this.handleSocketMessage(t)}))}catch(t){console.log(t)}finally{this.isLoading=false}}async handleSocketMessage(t){const e=JSON.parse(t);if(!e){return}const{REASON:i,KEY:s,PAYLOAD:n}=e;if(s.toString()!==this.property_id.toString()){return}let a=JSON.parse(n);console.log(s,a);const r={EMAIL_VERIFIED:this.updateUserVerificationStatus};const o=r[i];if(o){await o.call(this,a)}else{console.warn(`Unhandled REASON: ${i}`)}}updateUserVerificationStatus(t){const e=[...this.users];const i=e.findIndex((e=>e.id===t.id));if(i===-1){console.warn(`User ${t.id} not found`);return}e[i]={...e[i],is_email_verified:true};this.users=e}async fetchUsers(){const t=await this.userService.getExposedPropertyUsers({property_id:this.propertyid});this.users=[...t].sort(((t,e)=>{const i=t=>{const e=t.type.toString();if(e===this.superAdminId)return 0;if(e==="17")return 1;return 2};const s=i(t),n=i(e);if(s!==n){return s-n}return t.username.localeCompare(e.username)}))}async fetchUserTypes(){const t=await Promise.all([this.bookingService.getSetupEntriesByTableName("_USER_TYPE"),this.bookingService.getLov()]);const e=t[1]?.My_Result?.allowed_user_types;for(const i of t[0]){const t=i[`CODE_VALUE_${this.language?.toUpperCase()??"EN"}`];if(e.find((t=>t.code===i.CODE_NAME))){this.allowedUsersTypes.push({code:i.CODE_NAME,value:t})}this.userTypes.set(i.CODE_NAME.toString(),t)}}disconnectedCallback(){this.socket.disconnect()}render(){if(this.isLoading){return e(i,null,e("ir-toast",null),e("ir-interceptor",null),e("ir-loading-screen",null))}return e(i,null,e("ir-toast",null),e("ir-interceptor",{suppressToastEndpoints:["/Change_User_Pwd","/Handle_Exposed_User"]}),e("section",{class:"p-2 d-flex flex-column",style:{gap:"1rem"}},e("div",{class:"d-flex  pb-2 align-items-center justify-content-between"},e("h3",{class:"mb-1 mb-md-0"},x.entries.Lcz_ExtranetUsers)),e("div",{class:"",style:{gap:"1rem"}},e("ir-user-management-table",{property_id:this.property_id,baseUserTypeCode:this.baseUserTypeCode,allowedUsersTypes:this.allowedUsersTypes,userTypeCode:this.userTypeCode,haveAdminPrivileges:[this.superAdminId,"17"].includes(this.userTypeCode?.toString()),userTypes:this.userTypes,class:"card",isSuperAdmin:this.userTypeCode?.toString()===this.superAdminId,users:this.users}))))}static get watchers(){return{ticket:["ticketChanged"]}}};Dt.style=Pt;export{V as ir_arrivals,X as ir_booking_email_logs,it as ir_booking_listing,at as ir_daily_revenue,lt as ir_departures,dt as ir_hk_tasks,gt as ir_housekeeping,mt as ir_monthly_bookings_report,bt as ir_sales_by_channel,vt as ir_sales_by_country,Dt as ir_user_management};
//# sourceMappingURL=p-244cb01f.entry.js.map