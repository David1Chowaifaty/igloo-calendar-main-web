import{r as t,c as i,h as s,F as e,H as n,g as o}from"./p-53d64953.js";import{R as r}from"./p-429a4d65.js";import{B as h}from"./p-29be6d1c.js";import{n as a,o as l,p as c,b as d,q as u,u as f,w as p,x as g,y as b,d as m,z as y,a as v,A as _,c as w,B as k,C as O,D,E,f as C,F as x}from"./p-703a369a.js";import{E as Y}from"./p-a7a885c0.js";import{h as M}from"./p-6c4ba7c0.js";import{T as A}from"./p-27555e2c.js";import{l as j}from"./p-71768c2d.js";import{c as S,i as T}from"./p-00df8713.js";import{h as B,a as N,r as R}from"./p-25bd4703.js";import{T as P}from"./p-a93581f3.js";import{v as I}from"./p-4ed69de7.js";import{H as L,h as U,u as H}from"./p-b6c1681e.js";import{a as F}from"./p-bf44a732.js";import{B as $,u as z,b as G,o as K,a as V}from"./p-6fbb277c.js";import{a as q}from"./p-84f11abc.js";import{s as W,u as J,h as X,c as Q,a as Z}from"./p-8c949732.js";import{i as tt}from"./p-2e94af0d.js";import{U as it}from"./p-1624d941.js";import"./p-b859bcd5.js";import"./p-a973aec7.js";const st=Object.create(null);st["open"]="0";st["close"]="1";st["ping"]="2";st["pong"]="3";st["message"]="4";st["upgrade"]="5";st["noop"]="6";const et=Object.create(null);Object.keys(st).forEach((t=>{et[st[t]]=t}));const nt={type:"error",data:"parser error"};const ot=typeof Blob==="function"||typeof Blob!=="undefined"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]";const rt=typeof ArrayBuffer==="function";const ht=t=>typeof ArrayBuffer.isView==="function"?ArrayBuffer.isView(t):t&&t.buffer instanceof ArrayBuffer;const at=({type:t,data:i},s,e)=>{if(ot&&i instanceof Blob){if(s){return e(i)}else{return lt(i,e)}}else if(rt&&(i instanceof ArrayBuffer||ht(i))){if(s){return e(i)}else{return lt(new Blob([i]),e)}}return e(st[t]+(i||""))};const lt=(t,i)=>{const s=new FileReader;s.onload=function(){const t=s.result.split(",")[1];i("b"+(t||""))};return s.readAsDataURL(t)};function ct(t){if(t instanceof Uint8Array){return t}else if(t instanceof ArrayBuffer){return new Uint8Array(t)}else{return new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}}let dt;function ut(t,i){if(ot&&t.data instanceof Blob){return t.data.arrayBuffer().then(ct).then(i)}else if(rt&&(t.data instanceof ArrayBuffer||ht(t.data))){return i(ct(t.data))}at(t,false,(t=>{if(!dt){dt=new TextEncoder}i(dt.encode(t))}))}const ft="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";const pt=typeof Uint8Array==="undefined"?[]:new Uint8Array(256);for(let t=0;t<ft.length;t++){pt[ft.charCodeAt(t)]=t}const gt=t=>{let i=t.length*.75,s=t.length,e,n=0,o,r,h,a;if(t[t.length-1]==="="){i--;if(t[t.length-2]==="="){i--}}const l=new ArrayBuffer(i),c=new Uint8Array(l);for(e=0;e<s;e+=4){o=pt[t.charCodeAt(e)];r=pt[t.charCodeAt(e+1)];h=pt[t.charCodeAt(e+2)];a=pt[t.charCodeAt(e+3)];c[n++]=o<<2|r>>4;c[n++]=(r&15)<<4|h>>2;c[n++]=(h&3)<<6|a&63}return l};const bt=typeof ArrayBuffer==="function";const mt=(t,i)=>{if(typeof t!=="string"){return{type:"message",data:vt(t,i)}}const s=t.charAt(0);if(s==="b"){return{type:"message",data:yt(t.substring(1),i)}}const e=et[s];if(!e){return nt}return t.length>1?{type:et[s],data:t.substring(1)}:{type:et[s]}};const yt=(t,i)=>{if(bt){const s=gt(t);return vt(s,i)}else{return{base64:true,data:t}}};const vt=(t,i)=>{switch(i){case"blob":if(t instanceof Blob){return t}else{return new Blob([t])}case"arraybuffer":default:if(t instanceof ArrayBuffer){return t}else{return t.buffer}}};const _t=String.fromCharCode(30);const wt=(t,i)=>{const s=t.length;const e=new Array(s);let n=0;t.forEach(((t,o)=>{at(t,false,(t=>{e[o]=t;if(++n===s){i(e.join(_t))}}))}))};const kt=(t,i)=>{const s=t.split(_t);const e=[];for(let t=0;t<s.length;t++){const n=mt(s[t],i);e.push(n);if(n.type==="error"){break}}return e};function Ot(){return new TransformStream({transform(t,i){ut(t,(s=>{const e=s.length;let n;if(e<126){n=new Uint8Array(1);new DataView(n.buffer).setUint8(0,e)}else if(e<65536){n=new Uint8Array(3);const t=new DataView(n.buffer);t.setUint8(0,126);t.setUint16(1,e)}else{n=new Uint8Array(9);const t=new DataView(n.buffer);t.setUint8(0,127);t.setBigUint64(1,BigInt(e))}if(t.data&&typeof t.data!=="string"){n[0]|=128}i.enqueue(n);i.enqueue(s)}))}})}let Dt;function Et(t){return t.reduce(((t,i)=>t+i.length),0)}function Ct(t,i){if(t[0].length===i){return t.shift()}const s=new Uint8Array(i);let e=0;for(let n=0;n<i;n++){s[n]=t[0][e++];if(e===t[0].length){t.shift();e=0}}if(t.length&&e<t[0].length){t[0]=t[0].slice(e)}return s}function xt(t,i){if(!Dt){Dt=new TextDecoder}const s=[];let e=0;let n=-1;let o=false;return new TransformStream({transform(r,h){s.push(r);while(true){if(e===0){if(Et(s)<1){break}const t=Ct(s,1);o=(t[0]&128)===128;n=t[0]&127;if(n<126){e=3}else if(n===126){e=1}else{e=2}}else if(e===1){if(Et(s)<2){break}const t=Ct(s,2);n=new DataView(t.buffer,t.byteOffset,t.length).getUint16(0);e=3}else if(e===2){if(Et(s)<8){break}const t=Ct(s,8);const i=new DataView(t.buffer,t.byteOffset,t.length);const o=i.getUint32(0);if(o>Math.pow(2,53-32)-1){h.enqueue(nt);break}n=o*Math.pow(2,32)+i.getUint32(4);e=3}else{if(Et(s)<n){break}const t=Ct(s,n);h.enqueue(mt(o?t:Dt.decode(t),i));e=0}if(n===0||n>t){h.enqueue(nt);break}}}})}const Yt=4;function Mt(t){if(t)return At(t)}function At(t){for(var i in Mt.prototype){t[i]=Mt.prototype[i]}return t}Mt.prototype.on=Mt.prototype.addEventListener=function(t,i){this._callbacks=this._callbacks||{};(this._callbacks["$"+t]=this._callbacks["$"+t]||[]).push(i);return this};Mt.prototype.once=function(t,i){function s(){this.off(t,s);i.apply(this,arguments)}s.fn=i;this.on(t,s);return this};Mt.prototype.off=Mt.prototype.removeListener=Mt.prototype.removeAllListeners=Mt.prototype.removeEventListener=function(t,i){this._callbacks=this._callbacks||{};if(0==arguments.length){this._callbacks={};return this}var s=this._callbacks["$"+t];if(!s)return this;if(1==arguments.length){delete this._callbacks["$"+t];return this}var e;for(var n=0;n<s.length;n++){e=s[n];if(e===i||e.fn===i){s.splice(n,1);break}}if(s.length===0){delete this._callbacks["$"+t]}return this};Mt.prototype.emit=function(t){this._callbacks=this._callbacks||{};var i=new Array(arguments.length-1),s=this._callbacks["$"+t];for(var e=1;e<arguments.length;e++){i[e-1]=arguments[e]}if(s){s=s.slice(0);for(var e=0,n=s.length;e<n;++e){s[e].apply(this,i)}}return this};Mt.prototype.emitReserved=Mt.prototype.emit;Mt.prototype.listeners=function(t){this._callbacks=this._callbacks||{};return this._callbacks["$"+t]||[]};Mt.prototype.hasListeners=function(t){return!!this.listeners(t).length};const jt=(()=>{const t=typeof Promise==="function"&&typeof Promise.resolve==="function";if(t){return t=>Promise.resolve().then(t)}else{return(t,i)=>i(t,0)}})();const St=(()=>{if(typeof self!=="undefined"){return self}else if(typeof window!=="undefined"){return window}else{return Function("return this")()}})();const Tt="arraybuffer";function Bt(){}function Nt(t,...i){return i.reduce(((i,s)=>{if(t.hasOwnProperty(s)){i[s]=t[s]}return i}),{})}const Rt=St.setTimeout;const Pt=St.clearTimeout;function It(t,i){if(i.useNativeTimers){t.setTimeoutFn=Rt.bind(St);t.clearTimeoutFn=Pt.bind(St)}else{t.setTimeoutFn=St.setTimeout.bind(St);t.clearTimeoutFn=St.clearTimeout.bind(St)}}const Lt=1.33;function Ut(t){if(typeof t==="string"){return Ht(t)}return Math.ceil((t.byteLength||t.size)*Lt)}function Ht(t){let i=0,s=0;for(let e=0,n=t.length;e<n;e++){i=t.charCodeAt(e);if(i<128){s+=1}else if(i<2048){s+=2}else if(i<55296||i>=57344){s+=3}else{e++;s+=4}}return s}function Ft(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}function $t(t){let i="";for(let s in t){if(t.hasOwnProperty(s)){if(i.length)i+="&";i+=encodeURIComponent(s)+"="+encodeURIComponent(t[s])}}return i}function zt(t){let i={};let s=t.split("&");for(let t=0,e=s.length;t<e;t++){let e=s[t].split("=");i[decodeURIComponent(e[0])]=decodeURIComponent(e[1])}return i}class Gt extends Error{constructor(t,i,s){super(t);this.description=i;this.context=s;this.type="TransportError"}}class Kt extends Mt{constructor(t){super();this.writable=false;It(this,t);this.opts=t;this.query=t.query;this.socket=t.socket;this.supportsBinary=!t.forceBase64}onError(t,i,s){super.emitReserved("error",new Gt(t,i,s));return this}open(){this.readyState="opening";this.doOpen();return this}close(){if(this.readyState==="opening"||this.readyState==="open"){this.doClose();this.onClose()}return this}send(t){if(this.readyState==="open"){this.write(t)}}onOpen(){this.readyState="open";this.writable=true;super.emitReserved("open")}onData(t){const i=mt(t,this.socket.binaryType);this.onPacket(i)}onPacket(t){super.emitReserved("packet",t)}onClose(t){this.readyState="closed";super.emitReserved("close",t)}pause(t){}createUri(t,i={}){return t+"://"+this._hostname()+this._port()+this.opts.path+this._query(i)}_hostname(){const t=this.opts.hostname;return t.indexOf(":")===-1?t:"["+t+"]"}_port(){if(this.opts.port&&(this.opts.secure&&Number(this.opts.port!==443)||!this.opts.secure&&Number(this.opts.port)!==80)){return":"+this.opts.port}else{return""}}_query(t){const i=$t(t);return i.length?"?"+i:""}}class Vt extends Kt{constructor(){super(...arguments);this._polling=false}get name(){return"polling"}doOpen(){this._poll()}pause(t){this.readyState="pausing";const i=()=>{this.readyState="paused";t()};if(this._polling||!this.writable){let t=0;if(this._polling){t++;this.once("pollComplete",(function(){--t||i()}))}if(!this.writable){t++;this.once("drain",(function(){--t||i()}))}}else{i()}}_poll(){this._polling=true;this.doPoll();this.emitReserved("poll")}onData(t){const i=t=>{if("opening"===this.readyState&&t.type==="open"){this.onOpen()}if("close"===t.type){this.onClose({description:"transport closed by the server"});return false}this.onPacket(t)};kt(t,this.socket.binaryType).forEach(i);if("closed"!==this.readyState){this._polling=false;this.emitReserved("pollComplete");if("open"===this.readyState){this._poll()}}}doClose(){const t=()=>{this.write([{type:"close"}])};if("open"===this.readyState){t()}else{this.once("open",t)}}write(t){this.writable=false;wt(t,(t=>{this.doWrite(t,(()=>{this.writable=true;this.emitReserved("drain")}))}))}uri(){const t=this.opts.secure?"https":"http";const i=this.query||{};if(false!==this.opts.timestampRequests){i[this.opts.timestampParam]=Ft()}if(!this.supportsBinary&&!i.sid){i.b64=1}return this.createUri(t,i)}}let qt=false;try{qt=typeof XMLHttpRequest!=="undefined"&&"withCredentials"in new XMLHttpRequest}catch(t){}const Wt=qt;function Jt(){}class Xt extends Vt{constructor(t){super(t);if(typeof location!=="undefined"){const i="https:"===location.protocol;let s=location.port;if(!s){s=i?"443":"80"}this.xd=typeof location!=="undefined"&&t.hostname!==location.hostname||s!==t.port}}doWrite(t,i){const s=this.request({method:"POST",data:t});s.on("success",i);s.on("error",((t,i)=>{this.onError("xhr post error",t,i)}))}doPoll(){const t=this.request();t.on("data",this.onData.bind(this));t.on("error",((t,i)=>{this.onError("xhr poll error",t,i)}));this.pollXhr=t}}class Qt extends Mt{constructor(t,i,s){super();this.createRequest=t;It(this,s);this._opts=s;this._method=s.method||"GET";this._uri=i;this._data=undefined!==s.data?s.data:null;this._create()}_create(){var t;const i=Nt(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");i.xdomain=!!this._opts.xd;const s=this._xhr=this.createRequest(i);try{s.open(this._method,this._uri,true);try{if(this._opts.extraHeaders){s.setDisableHeaderCheck&&s.setDisableHeaderCheck(true);for(let t in this._opts.extraHeaders){if(this._opts.extraHeaders.hasOwnProperty(t)){s.setRequestHeader(t,this._opts.extraHeaders[t])}}}}catch(t){}if("POST"===this._method){try{s.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(t){}}try{s.setRequestHeader("Accept","*/*")}catch(t){}(t=this._opts.cookieJar)===null||t===void 0?void 0:t.addCookies(s);if("withCredentials"in s){s.withCredentials=this._opts.withCredentials}if(this._opts.requestTimeout){s.timeout=this._opts.requestTimeout}s.onreadystatechange=()=>{var t;if(s.readyState===3){(t=this._opts.cookieJar)===null||t===void 0?void 0:t.parseCookies(s.getResponseHeader("set-cookie"))}if(4!==s.readyState)return;if(200===s.status||1223===s.status){this._onLoad()}else{this.setTimeoutFn((()=>{this._onError(typeof s.status==="number"?s.status:0)}),0)}};s.send(this._data)}catch(t){this.setTimeoutFn((()=>{this._onError(t)}),0);return}if(typeof document!=="undefined"){this._index=Qt.requestsCount++;Qt.requests[this._index]=this}}_onError(t){this.emitReserved("error",t,this._xhr);this._cleanup(true)}_cleanup(t){if("undefined"===typeof this._xhr||null===this._xhr){return}this._xhr.onreadystatechange=Jt;if(t){try{this._xhr.abort()}catch(t){}}if(typeof document!=="undefined"){delete Qt.requests[this._index]}this._xhr=null}_onLoad(){const t=this._xhr.responseText;if(t!==null){this.emitReserved("data",t);this.emitReserved("success");this._cleanup()}}abort(){this._cleanup()}}Qt.requestsCount=0;Qt.requests={};if(typeof document!=="undefined"){if(typeof attachEvent==="function"){attachEvent("onunload",Zt)}else if(typeof addEventListener==="function"){const t="onpagehide"in St?"pagehide":"unload";addEventListener(t,Zt,false)}}function Zt(){for(let t in Qt.requests){if(Qt.requests.hasOwnProperty(t)){Qt.requests[t].abort()}}}const ti=function(){const t=si({xdomain:false});return t&&t.responseType!==null}();class ii extends Xt{constructor(t){super(t);const i=t&&t.forceBase64;this.supportsBinary=ti&&!i}request(t={}){Object.assign(t,{xd:this.xd},this.opts);return new Qt(si,this.uri(),t)}}function si(t){const i=t.xdomain;try{if("undefined"!==typeof XMLHttpRequest&&(!i||Wt)){return new XMLHttpRequest}}catch(t){}if(!i){try{return new(St[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(t){}}}const ei=typeof navigator!=="undefined"&&typeof navigator.product==="string"&&navigator.product.toLowerCase()==="reactnative";class ni extends Kt{get name(){return"websocket"}doOpen(){const t=this.uri();const i=this.opts.protocols;const s=ei?{}:Nt(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");if(this.opts.extraHeaders){s.headers=this.opts.extraHeaders}try{this.ws=this.createSocket(t,i,s)}catch(t){return this.emitReserved("error",t)}this.ws.binaryType=this.socket.binaryType;this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{if(this.opts.autoUnref){this.ws._socket.unref()}this.onOpen()};this.ws.onclose=t=>this.onClose({description:"websocket connection closed",context:t});this.ws.onmessage=t=>this.onData(t.data);this.ws.onerror=t=>this.onError("websocket error",t)}write(t){this.writable=false;for(let i=0;i<t.length;i++){const s=t[i];const e=i===t.length-1;at(s,this.supportsBinary,(t=>{try{this.doWrite(s,t)}catch(t){}if(e){jt((()=>{this.writable=true;this.emitReserved("drain")}),this.setTimeoutFn)}}))}}doClose(){if(typeof this.ws!=="undefined"){this.ws.onerror=()=>{};this.ws.close();this.ws=null}}uri(){const t=this.opts.secure?"wss":"ws";const i=this.query||{};if(this.opts.timestampRequests){i[this.opts.timestampParam]=Ft()}if(!this.supportsBinary){i.b64=1}return this.createUri(t,i)}}const oi=St.WebSocket||St.MozWebSocket;class ri extends ni{createSocket(t,i,s){return!ei?i?new oi(t,i):new oi(t):new oi(t,i,s)}doWrite(t,i){this.ws.send(i)}}class hi extends Kt{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(t){return this.emitReserved("error",t)}this._transport.closed.then((()=>{this.onClose()})).catch((t=>{this.onError("webtransport error",t)}));this._transport.ready.then((()=>{this._transport.createBidirectionalStream().then((t=>{const i=xt(Number.MAX_SAFE_INTEGER,this.socket.binaryType);const s=t.readable.pipeThrough(i).getReader();const e=Ot();e.readable.pipeTo(t.writable);this._writer=e.writable.getWriter();const n=()=>{s.read().then((({done:t,value:i})=>{if(t){return}this.onPacket(i);n()})).catch((t=>{}))};n();const o={type:"open"};if(this.query.sid){o.data=`{"sid":"${this.query.sid}"}`}this._writer.write(o).then((()=>this.onOpen()))}))}))}write(t){this.writable=false;for(let i=0;i<t.length;i++){const s=t[i];const e=i===t.length-1;this._writer.write(s).then((()=>{if(e){jt((()=>{this.writable=true;this.emitReserved("drain")}),this.setTimeoutFn)}}))}}doClose(){var t;(t=this._transport)===null||t===void 0?void 0:t.close()}}const ai={websocket:ri,webtransport:hi,polling:ii};const li=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/;const ci=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function di(t){if(t.length>8e3){throw"URI too long"}const i=t,s=t.indexOf("["),e=t.indexOf("]");if(s!=-1&&e!=-1){t=t.substring(0,s)+t.substring(s,e).replace(/:/g,";")+t.substring(e,t.length)}let n=li.exec(t||""),o={},r=14;while(r--){o[ci[r]]=n[r]||""}if(s!=-1&&e!=-1){o.source=i;o.host=o.host.substring(1,o.host.length-1).replace(/;/g,":");o.authority=o.authority.replace("[","").replace("]","").replace(/;/g,":");o.ipv6uri=true}o.pathNames=ui(o,o["path"]);o.queryKey=fi(o,o["query"]);return o}function ui(t,i){const s=/\/{2,9}/g,e=i.replace(s,"/").split("/");if(i.slice(0,1)=="/"||i.length===0){e.splice(0,1)}if(i.slice(-1)=="/"){e.splice(e.length-1,1)}return e}function fi(t,i){const s={};i.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,(function(t,i,e){if(i){s[i]=e}}));return s}const pi=typeof addEventListener==="function"&&typeof removeEventListener==="function";const gi=[];if(pi){addEventListener("offline",(()=>{gi.forEach((t=>t()))}),false)}class bi extends Mt{constructor(t,i){super();this.binaryType=Tt;this.writeBuffer=[];this._prevBufferLen=0;this._pingInterval=-1;this._pingTimeout=-1;this._maxPayload=-1;this._pingTimeoutTime=Infinity;if(t&&"object"===typeof t){i=t;t=null}if(t){const s=di(t);i.hostname=s.host;i.secure=s.protocol==="https"||s.protocol==="wss";i.port=s.port;if(s.query)i.query=s.query}else if(i.host){i.hostname=di(i.host).host}It(this,i);this.secure=null!=i.secure?i.secure:typeof location!=="undefined"&&"https:"===location.protocol;if(i.hostname&&!i.port){i.port=this.secure?"443":"80"}this.hostname=i.hostname||(typeof location!=="undefined"?location.hostname:"localhost");this.port=i.port||(typeof location!=="undefined"&&location.port?location.port:this.secure?"443":"80");this.transports=[];this._transportsByName={};i.transports.forEach((t=>{const i=t.prototype.name;this.transports.push(i);this._transportsByName[i]=t}));this.opts=Object.assign({path:"/engine.io",agent:false,withCredentials:false,upgrade:true,timestampParam:"t",rememberUpgrade:false,addTrailingSlash:true,rejectUnauthorized:true,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:false},i);this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":"");if(typeof this.opts.query==="string"){this.opts.query=zt(this.opts.query)}if(pi){if(this.opts.closeOnBeforeunload){this._beforeunloadEventListener=()=>{if(this.transport){this.transport.removeAllListeners();this.transport.close()}};addEventListener("beforeunload",this._beforeunloadEventListener,false)}if(this.hostname!=="localhost"){this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})};gi.push(this._offlineEventListener)}}if(this.opts.withCredentials){this._cookieJar=Bt()}this._open()}createTransport(t){const i=Object.assign({},this.opts.query);i.EIO=Yt;i.transport=t;if(this.id)i.sid=this.id;const s=Object.assign({},this.opts,{query:i,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[t]);return new this._transportsByName[t](s)}_open(){if(this.transports.length===0){this.setTimeoutFn((()=>{this.emitReserved("error","No transports available")}),0);return}const t=this.opts.rememberUpgrade&&bi.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1?"websocket":this.transports[0];this.readyState="opening";const i=this.createTransport(t);i.open();this.setTransport(i)}setTransport(t){if(this.transport){this.transport.removeAllListeners()}this.transport=t;t.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",(t=>this._onClose("transport close",t)))}onOpen(){this.readyState="open";bi.priorWebsocketSuccess="websocket"===this.transport.name;this.emitReserved("open");this.flush()}_onPacket(t){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState){this.emitReserved("packet",t);this.emitReserved("heartbeat");switch(t.type){case"open":this.onHandshake(JSON.parse(t.data));break;case"ping":this._sendPacket("pong");this.emitReserved("ping");this.emitReserved("pong");this._resetPingTimeout();break;case"error":const i=new Error("server error");i.code=t.data;this._onError(i);break;case"message":this.emitReserved("data",t.data);this.emitReserved("message",t.data);break}}}onHandshake(t){this.emitReserved("handshake",t);this.id=t.sid;this.transport.query.sid=t.sid;this._pingInterval=t.pingInterval;this._pingTimeout=t.pingTimeout;this._maxPayload=t.maxPayload;this.onOpen();if("closed"===this.readyState)return;this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const t=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+t;this._pingTimeoutTimer=this.setTimeoutFn((()=>{this._onClose("ping timeout")}),t);if(this.opts.autoUnref){this._pingTimeoutTimer.unref()}}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen);this._prevBufferLen=0;if(0===this.writeBuffer.length){this.emitReserved("drain")}else{this.flush()}}flush(){if("closed"!==this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const t=this._getWritablePackets();this.transport.send(t);this._prevBufferLen=t.length;this.emitReserved("flush")}}_getWritablePackets(){const t=this._maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1;if(!t){return this.writeBuffer}let i=1;for(let t=0;t<this.writeBuffer.length;t++){const s=this.writeBuffer[t].data;if(s){i+=Ut(s)}if(t>0&&i>this._maxPayload){return this.writeBuffer.slice(0,t)}i+=2}return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return true;const t=Date.now()>this._pingTimeoutTime;if(t){this._pingTimeoutTime=0;jt((()=>{this._onClose("ping timeout")}),this.setTimeoutFn)}return t}write(t,i,s){this._sendPacket("message",t,i,s);return this}send(t,i,s){this._sendPacket("message",t,i,s);return this}_sendPacket(t,i,s,e){if("function"===typeof i){e=i;i=undefined}if("function"===typeof s){e=s;s=null}if("closing"===this.readyState||"closed"===this.readyState){return}s=s||{};s.compress=false!==s.compress;const n={type:t,data:i,options:s};this.emitReserved("packetCreate",n);this.writeBuffer.push(n);if(e)this.once("flush",e);this.flush()}close(){const t=()=>{this._onClose("forced close");this.transport.close()};const i=()=>{this.off("upgrade",i);this.off("upgradeError",i);t()};const s=()=>{this.once("upgrade",i);this.once("upgradeError",i)};if("opening"===this.readyState||"open"===this.readyState){this.readyState="closing";if(this.writeBuffer.length){this.once("drain",(()=>{if(this.upgrading){s()}else{t()}}))}else if(this.upgrading){s()}else{t()}}return this}_onError(t){bi.priorWebsocketSuccess=false;if(this.opts.tryAllTransports&&this.transports.length>1&&this.readyState==="opening"){this.transports.shift();return this._open()}this.emitReserved("error",t);this._onClose("transport error",t)}_onClose(t,i){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState){this.clearTimeoutFn(this._pingTimeoutTimer);this.transport.removeAllListeners("close");this.transport.close();this.transport.removeAllListeners();if(pi){if(this._beforeunloadEventListener){removeEventListener("beforeunload",this._beforeunloadEventListener,false)}if(this._offlineEventListener){const t=gi.indexOf(this._offlineEventListener);if(t!==-1){gi.splice(t,1)}}}this.readyState="closed";this.id=null;this.emitReserved("close",t,i);this.writeBuffer=[];this._prevBufferLen=0}}}bi.protocol=Yt;class mi extends bi{constructor(){super(...arguments);this._upgrades=[]}onOpen(){super.onOpen();if("open"===this.readyState&&this.opts.upgrade){for(let t=0;t<this._upgrades.length;t++){this._probe(this._upgrades[t])}}}_probe(t){let i=this.createTransport(t);let s=false;bi.priorWebsocketSuccess=false;const e=()=>{if(s)return;i.send([{type:"ping",data:"probe"}]);i.once("packet",(t=>{if(s)return;if("pong"===t.type&&"probe"===t.data){this.upgrading=true;this.emitReserved("upgrading",i);if(!i)return;bi.priorWebsocketSuccess="websocket"===i.name;this.transport.pause((()=>{if(s)return;if("closed"===this.readyState)return;l();this.setTransport(i);i.send([{type:"upgrade"}]);this.emitReserved("upgrade",i);i=null;this.upgrading=false;this.flush()}))}else{const t=new Error("probe error");t.transport=i.name;this.emitReserved("upgradeError",t)}}))};function n(){if(s)return;s=true;l();i.close();i=null}const o=t=>{const s=new Error("probe error: "+t);s.transport=i.name;n();this.emitReserved("upgradeError",s)};function r(){o("transport closed")}function h(){o("socket closed")}function a(t){if(i&&t.name!==i.name){n()}}const l=()=>{i.removeListener("open",e);i.removeListener("error",o);i.removeListener("close",r);this.off("close",h);this.off("upgrading",a)};i.once("open",e);i.once("error",o);i.once("close",r);this.once("close",h);this.once("upgrading",a);if(this._upgrades.indexOf("webtransport")!==-1&&t!=="webtransport"){this.setTimeoutFn((()=>{if(!s){i.open()}}),200)}else{i.open()}}onHandshake(t){this._upgrades=this._filterUpgrades(t.upgrades);super.onHandshake(t)}_filterUpgrades(t){const i=[];for(let s=0;s<t.length;s++){if(~this.transports.indexOf(t[s]))i.push(t[s])}return i}}class yi extends mi{constructor(t,i={}){const s=typeof t==="object"?t:i;if(!s.transports||s.transports&&typeof s.transports[0]==="string"){s.transports=(s.transports||["polling","websocket","webtransport"]).map((t=>ai[t])).filter((t=>!!t))}super(t,s)}}function vi(t,i="",s){let e=t;s=s||typeof location!=="undefined"&&location;if(null==t)t=s.protocol+"//"+s.host;if(typeof t==="string"){if("/"===t.charAt(0)){if("/"===t.charAt(1)){t=s.protocol+t}else{t=s.host+t}}if(!/^(https?|wss?):\/\//.test(t)){if("undefined"!==typeof s){t=s.protocol+"//"+t}else{t="https://"+t}}e=di(t)}if(!e.port){if(/^(http|ws)$/.test(e.protocol)){e.port="80"}else if(/^(http|ws)s$/.test(e.protocol)){e.port="443"}}e.path=e.path||"/";const n=e.host.indexOf(":")!==-1;const o=n?"["+e.host+"]":e.host;e.id=e.protocol+"://"+o+":"+e.port+i;e.href=e.protocol+"://"+o+(s&&s.port===e.port?"":":"+e.port);return e}const _i=typeof ArrayBuffer==="function";const wi=t=>typeof ArrayBuffer.isView==="function"?ArrayBuffer.isView(t):t.buffer instanceof ArrayBuffer;const ki=Object.prototype.toString;const Oi=typeof Blob==="function"||typeof Blob!=="undefined"&&ki.call(Blob)==="[object BlobConstructor]";const Di=typeof File==="function"||typeof File!=="undefined"&&ki.call(File)==="[object FileConstructor]";function Ei(t){return _i&&(t instanceof ArrayBuffer||wi(t))||Oi&&t instanceof Blob||Di&&t instanceof File}function Ci(t,i){if(!t||typeof t!=="object"){return false}if(Array.isArray(t)){for(let i=0,s=t.length;i<s;i++){if(Ci(t[i])){return true}}return false}if(Ei(t)){return true}if(t.toJSON&&typeof t.toJSON==="function"&&arguments.length===1){return Ci(t.toJSON(),true)}for(const i in t){if(Object.prototype.hasOwnProperty.call(t,i)&&Ci(t[i])){return true}}return false}function xi(t){const i=[];const s=t.data;const e=t;e.data=Yi(s,i);e.attachments=i.length;return{packet:e,buffers:i}}function Yi(t,i){if(!t)return t;if(Ei(t)){const s={_placeholder:true,num:i.length};i.push(t);return s}else if(Array.isArray(t)){const s=new Array(t.length);for(let e=0;e<t.length;e++){s[e]=Yi(t[e],i)}return s}else if(typeof t==="object"&&!(t instanceof Date)){const s={};for(const e in t){if(Object.prototype.hasOwnProperty.call(t,e)){s[e]=Yi(t[e],i)}}return s}return t}function Mi(t,i){t.data=Ai(t.data,i);delete t.attachments;return t}function Ai(t,i){if(!t)return t;if(t&&t._placeholder===true){const s=typeof t.num==="number"&&t.num>=0&&t.num<i.length;if(s){return i[t.num]}else{throw new Error("illegal attachments")}}else if(Array.isArray(t)){for(let s=0;s<t.length;s++){t[s]=Ai(t[s],i)}}else if(typeof t==="object"){for(const s in t){if(Object.prototype.hasOwnProperty.call(t,s)){t[s]=Ai(t[s],i)}}}return t}const ji=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"];const Si=5;var Ti;(function(t){t[t["CONNECT"]=0]="CONNECT";t[t["DISCONNECT"]=1]="DISCONNECT";t[t["EVENT"]=2]="EVENT";t[t["ACK"]=3]="ACK";t[t["CONNECT_ERROR"]=4]="CONNECT_ERROR";t[t["BINARY_EVENT"]=5]="BINARY_EVENT";t[t["BINARY_ACK"]=6]="BINARY_ACK"})(Ti||(Ti={}));class Bi{constructor(t){this.replacer=t}encode(t){if(t.type===Ti.EVENT||t.type===Ti.ACK){if(Ci(t)){return this.encodeAsBinary({type:t.type===Ti.EVENT?Ti.BINARY_EVENT:Ti.BINARY_ACK,nsp:t.nsp,data:t.data,id:t.id})}}return[this.encodeAsString(t)]}encodeAsString(t){let i=""+t.type;if(t.type===Ti.BINARY_EVENT||t.type===Ti.BINARY_ACK){i+=t.attachments+"-"}if(t.nsp&&"/"!==t.nsp){i+=t.nsp+","}if(null!=t.id){i+=t.id}if(null!=t.data){i+=JSON.stringify(t.data,this.replacer)}return i}encodeAsBinary(t){const i=xi(t);const s=this.encodeAsString(i.packet);const e=i.buffers;e.unshift(s);return e}}function Ni(t){return Object.prototype.toString.call(t)==="[object Object]"}class Ri extends Mt{constructor(t){super();this.reviver=t}add(t){let i;if(typeof t==="string"){if(this.reconstructor){throw new Error("got plaintext data when reconstructing a packet")}i=this.decodeString(t);const s=i.type===Ti.BINARY_EVENT;if(s||i.type===Ti.BINARY_ACK){i.type=s?Ti.EVENT:Ti.ACK;this.reconstructor=new Pi(i);if(i.attachments===0){super.emitReserved("decoded",i)}}else{super.emitReserved("decoded",i)}}else if(Ei(t)||t.base64){if(!this.reconstructor){throw new Error("got binary data when not reconstructing a packet")}else{i=this.reconstructor.takeBinaryData(t);if(i){this.reconstructor=null;super.emitReserved("decoded",i)}}}else{throw new Error("Unknown type: "+t)}}decodeString(t){let i=0;const s={type:Number(t.charAt(0))};if(Ti[s.type]===undefined){throw new Error("unknown packet type "+s.type)}if(s.type===Ti.BINARY_EVENT||s.type===Ti.BINARY_ACK){const e=i+1;while(t.charAt(++i)!=="-"&&i!=t.length){}const n=t.substring(e,i);if(n!=Number(n)||t.charAt(i)!=="-"){throw new Error("Illegal attachments")}s.attachments=Number(n)}if("/"===t.charAt(i+1)){const e=i+1;while(++i){const s=t.charAt(i);if(","===s)break;if(i===t.length)break}s.nsp=t.substring(e,i)}else{s.nsp="/"}const e=t.charAt(i+1);if(""!==e&&Number(e)==e){const e=i+1;while(++i){const s=t.charAt(i);if(null==s||Number(s)!=s){--i;break}if(i===t.length)break}s.id=Number(t.substring(e,i+1))}if(t.charAt(++i)){const e=this.tryParse(t.substr(i));if(Ri.isPayloadValid(s.type,e)){s.data=e}else{throw new Error("invalid payload")}}return s}tryParse(t){try{return JSON.parse(t,this.reviver)}catch(t){return false}}static isPayloadValid(t,i){switch(t){case Ti.CONNECT:return Ni(i);case Ti.DISCONNECT:return i===undefined;case Ti.CONNECT_ERROR:return typeof i==="string"||Ni(i);case Ti.EVENT:case Ti.BINARY_EVENT:return Array.isArray(i)&&(typeof i[0]==="number"||typeof i[0]==="string"&&ji.indexOf(i[0])===-1);case Ti.ACK:case Ti.BINARY_ACK:return Array.isArray(i)}}destroy(){if(this.reconstructor){this.reconstructor.finishedReconstruction();this.reconstructor=null}}}class Pi{constructor(t){this.packet=t;this.buffers=[];this.reconPack=t}takeBinaryData(t){this.buffers.push(t);if(this.buffers.length===this.reconPack.attachments){const t=Mi(this.reconPack,this.buffers);this.finishedReconstruction();return t}return null}finishedReconstruction(){this.reconPack=null;this.buffers=[]}}const Ii=Object.freeze({__proto__:null,protocol:Si,get PacketType(){return Ti},Encoder:Bi,Decoder:Ri});function Li(t,i,s){t.on(i,s);return function e(){t.off(i,s)}}const Ui=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class Hi extends Mt{constructor(t,i,s){super();this.connected=false;this.recovered=false;this.receiveBuffer=[];this.sendBuffer=[];this._queue=[];this._queueSeq=0;this.ids=0;this.acks={};this.flags={};this.io=t;this.nsp=i;if(s&&s.auth){this.auth=s.auth}this._opts=Object.assign({},s);if(this.io._autoConnect)this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const t=this.io;this.subs=[Li(t,"open",this.onopen.bind(this)),Li(t,"packet",this.onpacket.bind(this)),Li(t,"error",this.onerror.bind(this)),Li(t,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){if(this.connected)return this;this.subEvents();if(!this.io["_reconnecting"])this.io.open();if("open"===this.io._readyState)this.onopen();return this}open(){return this.connect()}send(...t){t.unshift("message");this.emit.apply(this,t);return this}emit(t,...i){var s,e,n;if(Ui.hasOwnProperty(t)){throw new Error('"'+t.toString()+'" is a reserved event name')}i.unshift(t);if(this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile){this._addToQueue(i);return this}const o={type:Ti.EVENT,data:i};o.options={};o.options.compress=this.flags.compress!==false;if("function"===typeof i[i.length-1]){const t=this.ids++;const s=i.pop();this._registerAckCallback(t,s);o.id=t}const r=(e=(s=this.io.engine)===null||s===void 0?void 0:s.transport)===null||e===void 0?void 0:e.writable;const h=this.connected&&!((n=this.io.engine)===null||n===void 0?void 0:n._hasPingExpired());const a=this.flags.volatile&&!r;if(a);else if(h){this.notifyOutgoingListeners(o);this.packet(o)}else{this.sendBuffer.push(o)}this.flags={};return this}_registerAckCallback(t,i){var s;const e=(s=this.flags.timeout)!==null&&s!==void 0?s:this._opts.ackTimeout;if(e===undefined){this.acks[t]=i;return}const n=this.io.setTimeoutFn((()=>{delete this.acks[t];for(let i=0;i<this.sendBuffer.length;i++){if(this.sendBuffer[i].id===t){this.sendBuffer.splice(i,1)}}i.call(this,new Error("operation has timed out"))}),e);const o=(...t)=>{this.io.clearTimeoutFn(n);i.apply(this,t)};o.withError=true;this.acks[t]=o}emitWithAck(t,...i){return new Promise(((s,e)=>{const n=(t,i)=>t?e(t):s(i);n.withError=true;i.push(n);this.emit(t,...i)}))}_addToQueue(t){let i;if(typeof t[t.length-1]==="function"){i=t.pop()}const s={id:this._queueSeq++,tryCount:0,pending:false,args:t,flags:Object.assign({fromQueue:true},this.flags)};t.push(((t,...e)=>{if(s!==this._queue[0]){return}const n=t!==null;if(n){if(s.tryCount>this._opts.retries){this._queue.shift();if(i){i(t)}}}else{this._queue.shift();if(i){i(null,...e)}}s.pending=false;return this._drainQueue()}));this._queue.push(s);this._drainQueue()}_drainQueue(t=false){if(!this.connected||this._queue.length===0){return}const i=this._queue[0];if(i.pending&&!t){return}i.pending=true;i.tryCount++;this.flags=i.flags;this.emit.apply(this,i.args)}packet(t){t.nsp=this.nsp;this.io._packet(t)}onopen(){if(typeof this.auth=="function"){this.auth((t=>{this._sendConnectPacket(t)}))}else{this._sendConnectPacket(this.auth)}}_sendConnectPacket(t){this.packet({type:Ti.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},t):t})}onerror(t){if(!this.connected){this.emitReserved("connect_error",t)}}onclose(t,i){this.connected=false;delete this.id;this.emitReserved("disconnect",t,i);this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach((t=>{const i=this.sendBuffer.some((i=>String(i.id)===t));if(!i){const i=this.acks[t];delete this.acks[t];if(i.withError){i.call(this,new Error("socket has been disconnected"))}}}))}onpacket(t){const i=t.nsp===this.nsp;if(!i)return;switch(t.type){case Ti.CONNECT:if(t.data&&t.data.sid){this.onconnect(t.data.sid,t.data.pid)}else{this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"))}break;case Ti.EVENT:case Ti.BINARY_EVENT:this.onevent(t);break;case Ti.ACK:case Ti.BINARY_ACK:this.onack(t);break;case Ti.DISCONNECT:this.ondisconnect();break;case Ti.CONNECT_ERROR:this.destroy();const i=new Error(t.data.message);i.data=t.data.data;this.emitReserved("connect_error",i);break}}onevent(t){const i=t.data||[];if(null!=t.id){i.push(this.ack(t.id))}if(this.connected){this.emitEvent(i)}else{this.receiveBuffer.push(Object.freeze(i))}}emitEvent(t){if(this._anyListeners&&this._anyListeners.length){const i=this._anyListeners.slice();for(const s of i){s.apply(this,t)}}super.emit.apply(this,t);if(this._pid&&t.length&&typeof t[t.length-1]==="string"){this._lastOffset=t[t.length-1]}}ack(t){const i=this;let s=false;return function(...e){if(s)return;s=true;i.packet({type:Ti.ACK,id:t,data:e})}}onack(t){const i=this.acks[t.id];if(typeof i!=="function"){return}delete this.acks[t.id];if(i.withError){t.data.unshift(null)}i.apply(this,t.data)}onconnect(t,i){this.id=t;this.recovered=i&&this._pid===i;this._pid=i;this.connected=true;this.emitBuffered();this.emitReserved("connect");this._drainQueue(true)}emitBuffered(){this.receiveBuffer.forEach((t=>this.emitEvent(t)));this.receiveBuffer=[];this.sendBuffer.forEach((t=>{this.notifyOutgoingListeners(t);this.packet(t)}));this.sendBuffer=[]}ondisconnect(){this.destroy();this.onclose("io server disconnect")}destroy(){if(this.subs){this.subs.forEach((t=>t()));this.subs=undefined}this.io["_destroy"](this)}disconnect(){if(this.connected){this.packet({type:Ti.DISCONNECT})}this.destroy();if(this.connected){this.onclose("io client disconnect")}return this}close(){return this.disconnect()}compress(t){this.flags.compress=t;return this}get volatile(){this.flags.volatile=true;return this}timeout(t){this.flags.timeout=t;return this}onAny(t){this._anyListeners=this._anyListeners||[];this._anyListeners.push(t);return this}prependAny(t){this._anyListeners=this._anyListeners||[];this._anyListeners.unshift(t);return this}offAny(t){if(!this._anyListeners){return this}if(t){const i=this._anyListeners;for(let s=0;s<i.length;s++){if(t===i[s]){i.splice(s,1);return this}}}else{this._anyListeners=[]}return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(t){this._anyOutgoingListeners=this._anyOutgoingListeners||[];this._anyOutgoingListeners.push(t);return this}prependAnyOutgoing(t){this._anyOutgoingListeners=this._anyOutgoingListeners||[];this._anyOutgoingListeners.unshift(t);return this}offAnyOutgoing(t){if(!this._anyOutgoingListeners){return this}if(t){const i=this._anyOutgoingListeners;for(let s=0;s<i.length;s++){if(t===i[s]){i.splice(s,1);return this}}}else{this._anyOutgoingListeners=[]}return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(t){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const i=this._anyOutgoingListeners.slice();for(const s of i){s.apply(this,t.data)}}}}function Fi(t){t=t||{};this.ms=t.min||100;this.max=t.max||1e4;this.factor=t.factor||2;this.jitter=t.jitter>0&&t.jitter<=1?t.jitter:0;this.attempts=0}Fi.prototype.duration=function(){var t=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var i=Math.random();var s=Math.floor(i*this.jitter*t);t=(Math.floor(i*10)&1)==0?t-s:t+s}return Math.min(t,this.max)|0};Fi.prototype.reset=function(){this.attempts=0};Fi.prototype.setMin=function(t){this.ms=t};Fi.prototype.setMax=function(t){this.max=t};Fi.prototype.setJitter=function(t){this.jitter=t};class $i extends Mt{constructor(t,i){var s;super();this.nsps={};this.subs=[];if(t&&"object"===typeof t){i=t;t=undefined}i=i||{};i.path=i.path||"/socket.io";this.opts=i;It(this,i);this.reconnection(i.reconnection!==false);this.reconnectionAttempts(i.reconnectionAttempts||Infinity);this.reconnectionDelay(i.reconnectionDelay||1e3);this.reconnectionDelayMax(i.reconnectionDelayMax||5e3);this.randomizationFactor((s=i.randomizationFactor)!==null&&s!==void 0?s:.5);this.backoff=new Fi({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()});this.timeout(null==i.timeout?2e4:i.timeout);this._readyState="closed";this.uri=t;const e=i.parser||Ii;this.encoder=new e.Encoder;this.decoder=new e.Decoder;this._autoConnect=i.autoConnect!==false;if(this._autoConnect)this.open()}reconnection(t){if(!arguments.length)return this._reconnection;this._reconnection=!!t;if(!t){this.skipReconnect=true}return this}reconnectionAttempts(t){if(t===undefined)return this._reconnectionAttempts;this._reconnectionAttempts=t;return this}reconnectionDelay(t){var i;if(t===undefined)return this._reconnectionDelay;this._reconnectionDelay=t;(i=this.backoff)===null||i===void 0?void 0:i.setMin(t);return this}randomizationFactor(t){var i;if(t===undefined)return this._randomizationFactor;this._randomizationFactor=t;(i=this.backoff)===null||i===void 0?void 0:i.setJitter(t);return this}reconnectionDelayMax(t){var i;if(t===undefined)return this._reconnectionDelayMax;this._reconnectionDelayMax=t;(i=this.backoff)===null||i===void 0?void 0:i.setMax(t);return this}timeout(t){if(!arguments.length)return this._timeout;this._timeout=t;return this}maybeReconnectOnOpen(){if(!this._reconnecting&&this._reconnection&&this.backoff.attempts===0){this.reconnect()}}open(t){if(~this._readyState.indexOf("open"))return this;this.engine=new yi(this.uri,this.opts);const i=this.engine;const s=this;this._readyState="opening";this.skipReconnect=false;const e=Li(i,"open",(function(){s.onopen();t&&t()}));const n=i=>{this.cleanup();this._readyState="closed";this.emitReserved("error",i);if(t){t(i)}else{this.maybeReconnectOnOpen()}};const o=Li(i,"error",n);if(false!==this._timeout){const t=this._timeout;const s=this.setTimeoutFn((()=>{e();n(new Error("timeout"));i.close()}),t);if(this.opts.autoUnref){s.unref()}this.subs.push((()=>{this.clearTimeoutFn(s)}))}this.subs.push(e);this.subs.push(o);return this}connect(t){return this.open(t)}onopen(){this.cleanup();this._readyState="open";this.emitReserved("open");const t=this.engine;this.subs.push(Li(t,"ping",this.onping.bind(this)),Li(t,"data",this.ondata.bind(this)),Li(t,"error",this.onerror.bind(this)),Li(t,"close",this.onclose.bind(this)),Li(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(t){try{this.decoder.add(t)}catch(t){this.onclose("parse error",t)}}ondecoded(t){jt((()=>{this.emitReserved("packet",t)}),this.setTimeoutFn)}onerror(t){this.emitReserved("error",t)}socket(t,i){let s=this.nsps[t];if(!s){s=new Hi(this,t,i);this.nsps[t]=s}else if(this._autoConnect&&!s.active){s.connect()}return s}_destroy(t){const i=Object.keys(this.nsps);for(const t of i){const i=this.nsps[t];if(i.active){return}}this._close()}_packet(t){const i=this.encoder.encode(t);for(let s=0;s<i.length;s++){this.engine.write(i[s],t.options)}}cleanup(){this.subs.forEach((t=>t()));this.subs.length=0;this.decoder.destroy()}_close(){this.skipReconnect=true;this._reconnecting=false;this.onclose("forced close")}disconnect(){return this._close()}onclose(t,i){var s;this.cleanup();(s=this.engine)===null||s===void 0?void 0:s.close();this.backoff.reset();this._readyState="closed";this.emitReserved("close",t,i);if(this._reconnection&&!this.skipReconnect){this.reconnect()}}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const t=this;if(this.backoff.attempts>=this._reconnectionAttempts){this.backoff.reset();this.emitReserved("reconnect_failed");this._reconnecting=false}else{const i=this.backoff.duration();this._reconnecting=true;const s=this.setTimeoutFn((()=>{if(t.skipReconnect)return;this.emitReserved("reconnect_attempt",t.backoff.attempts);if(t.skipReconnect)return;t.open((i=>{if(i){t._reconnecting=false;t.reconnect();this.emitReserved("reconnect_error",i)}else{t.onreconnect()}}))}),i);if(this.opts.autoUnref){s.unref()}this.subs.push((()=>{this.clearTimeoutFn(s)}))}}onreconnect(){const t=this.backoff.attempts;this._reconnecting=false;this.backoff.reset();this.emitReserved("reconnect",t)}}const zi={};function Gi(t,i){if(typeof t==="object"){i=t;t=undefined}i=i||{};const s=vi(t,i.path||"/socket.io");const e=s.source;const n=s.id;const o=s.path;const r=zi[n]&&o in zi[n]["nsps"];const h=i.forceNew||i["force new connection"]||false===i.multiplex||r;let a;if(h){a=new $i(e,i)}else{if(!zi[n]){zi[n]=new $i(e,i)}a=zi[n]}if(s.query&&!i.query){i.query=s.queryKey}return a.socket(s.path,i)}Object.assign(Gi,{Manager:$i,Socket:Hi,io:Gi,connect:Gi});class Ki{constructor(t,i){this.queue=[];this.isProcessing=false;this.flushTimer=null;this.processor=t;this.options=Object.assign({maxQueueSize:1e4,onError:t=>console.error("Queue processing error:",t),onBatchProcessed:()=>{}},i)}offer(t){if(this.queue.length>=this.options.maxQueueSize){return false}const i={data:t,timestamp:Date.now(),id:this.generateId()};this.queue.push(i);this.scheduleFlush();return true}offerAll(t){let i=0;for(const s of t){if(this.offer(s)){i++}else{break}}return i}size(){return this.queue.length}isEmpty(){return this.queue.length===0}async flush(){if(this.flushTimer){clearTimeout(this.flushTimer);this.flushTimer=null}await this.processBatch()}clear(){this.queue=[];if(this.flushTimer){clearTimeout(this.flushTimer);this.flushTimer=null}}async shutdown(){await this.flush()}scheduleFlush(){if(this.queue.length>=this.options.batchSize){this.processBatch();return}if(!this.flushTimer){this.flushTimer=setTimeout((()=>{this.processBatch()}),this.options.flushInterval)}}async processBatch(){if(this.isProcessing||this.queue.length===0){return}this.isProcessing=true;try{const t=Math.min(this.options.batchSize,this.queue.length);const i=this.queue.splice(0,t);const s=i.map((t=>t.data));const e=Date.now();await this.processor(s);const n=Date.now()-e;this.options.onBatchProcessed(t,n);if(this.flushTimer){clearTimeout(this.flushTimer);this.flushTimer=null}if(this.queue.length>0){this.scheduleFlush()}}catch(t){this.options.onError(t)}finally{this.isProcessing=false}}generateId(){return I()}}const Vi=".sc-igloo-calendar-h{display:block;position:relative;background-color:#ffffff;height:100%;text-align:center}.igl-calendar.sc-igloo-calendar{display:grid;grid-template-columns:1fr;height:100%}.calendarScrollContainer.sc-igloo-calendar{width:100%;height:100%;overflow:auto;position:relative;white-space:nowrap;border-left:2px solid grey}.showToBeAssigned.sc-igloo-calendar,.showLegend.sc-igloo-calendar{grid-template-columns:330px 1fr}#calendarContainer.sc-igloo-calendar{position:absolute}.legendContainer.sc-igloo-calendar,.tobeAssignedContainer.sc-igloo-calendar{display:none;height:100%;overflow-y:auto;padding-left:0.5em !important;padding-right:0.5em !important}.showToBeAssigned.sc-igloo-calendar .tobeAssignedContainer.sc-igloo-calendar{display:block}.showLegend.sc-igloo-calendar .legendContainer.sc-igloo-calendar{display:block}.tobeBooked.sc-igloo-calendar{padding-top:8px;padding-bottom:8px;text-align:left}";const qi=Vi;var Wi=undefined&&undefined.__rest||function(t,i){var s={};for(var e in t)if(Object.prototype.hasOwnProperty.call(t,e)&&i.indexOf(e)<0)s[e]=t[e];if(t!=null&&typeof Object.getOwnPropertySymbols==="function")for(var n=0,e=Object.getOwnPropertySymbols(t);n<e.length;n++){if(i.indexOf(e[n])<0&&Object.prototype.propertyIsEnumerable.call(t,e[n]))s[e[n]]=t[e[n]]}return s};const Ji=class{constructor(s){t(this,s);this.dragOverHighlightElement=i(this,"dragOverHighlightElement",7);this.moveBookingTo=i(this,"moveBookingTo",7);this.calculateUnassignedDates=i(this,"calculateUnassignedDates",7);this.reduceAvailableUnitEvent=i(this,"reduceAvailableUnitEvent",7);this.revertBooking=i(this,"revertBooking",7);this.openCalendarSidebar=i(this,"openCalendarSidebar",7);this.showRoomNightsDialog=i(this,"showRoomNightsDialog",7);this.ticket="";this.calendarData=new Object;this.days=new Array;this.scrollViewDragging=false;this.dialogData=null;this.bookingItem=null;this.editBookingItem=null;this.showLegend=false;this.showPaymentDetails=false;this.showToBeAssigned=false;this.unassignedDates={};this.roomNightsData=null;this.renderAgain=false;this.showBookProperty=false;this.isAuthenticated=false;this.bookingService=new h;this.roomService=new r;this.eventsService=new Y;this.toBeAssignedService=new A;this.housekeepingService=new L;this.countries=[];this.visibleCalendarCells={x:[],y:[]};this.today="";this.reachedEndOfCalendar=false;this.token=new P;this.salesQueue=new Ki(this.processSalesBatch.bind(this),{batchSize:50,flushInterval:1e3,maxQueueSize:5e3,onError:t=>console.error("Batch Sales Update Error:",t)});this.availabilityQueue=new Ki(this.processAvailabilityBatch.bind(this),{batchSize:50,flushInterval:1e3,maxQueueSize:5e3,onError:t=>console.error("Batch Availability Update Error:",t)});this.roomTypeIdsCache=new Map;this.scrollViewDragPos={top:0,left:0,x:0,y:0};this.onScrollContentMoveHandler=t=>{if(t.buttons!==1){return}const i=t.clientX-this.scrollViewDragPos.x;const s=t.clientY-this.scrollViewDragPos.y;this.scrollContainer.scrollTop=this.scrollViewDragPos.top-s;this.scrollContainer.scrollLeft=this.scrollViewDragPos.left-i;if(Math.abs(i)>5||Math.abs(s)>5){this.scrollViewDragging=true}};this.onScrollContentMoveEndHandler=()=>{document.removeEventListener("mousemove",this.onScrollContentMoveHandler);document.removeEventListener("mouseup",this.onScrollContentMoveEndHandler)}}componentWillLoad(){if(this.baseUrl){this.token.setBaseUrl(this.baseUrl)}this.init()}componentDidLoad(){this.scrollToElement(this.today)}async handleDeleteEvent(t){try{t.stopImmediatePropagation();t.preventDefault();await this.eventsService.deleteEvent(t.detail)}catch(t){}}async handleCalendarSidebarEvents(t){console.log("hit ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥");t.stopImmediatePropagation();t.stopPropagation();this.calendarSidebarState=t.detail}scrollPageToRoom(t){let i=t.detail.refClass;this.scrollContainer=this.scrollContainer||this.element.querySelector(".calendarScrollContainer");const s=this.element.querySelector(".topLeftCell");const e=this.element.querySelector("."+i);if(e){this.scrollContainer.scrollTo({top:0});const t=e.getBoundingClientRect();const i=this.scrollContainer.getBoundingClientRect();const n=s.getBoundingClientRect();this.scrollContainer.scrollTo({top:t.top-i.top-n.height-t.height})}}handleShowDialog(t){var i;t.stopImmediatePropagation();t.stopPropagation();this.dialogData=t.detail;(i=this.calendarModalEl)===null||i===void 0?void 0:i.openModal()}handleShowRoomNightsDialog(t){this.roomNightsData=t.detail}handleBookingDatasChange(t){t.stopPropagation();t.stopImmediatePropagation();let i=[...this.calendarData.bookingEvents];i=i.filter((t=>t.ID!=="NEW_TEMP_EVENT"));i.push(...t.detail.filter((t=>t.STATUS==="PENDING-CONFIRMATION")));this.updateBookingEventsDateRange(t.detail);this.calendarData=Object.assign(Object.assign({},this.calendarData),{bookingEvents:i})}handleUpdateBookingEvent(t){t.stopPropagation();t.stopImmediatePropagation();const i=t.detail;this.calendarData=Object.assign(Object.assign({},this.calendarData),{bookingEvents:this.calendarData.bookingEvents.map((t=>{if(i.ID===t.ID){return i}return t}))})}showBookingPopupEventDataHandler(t){t.preventDefault();t.stopImmediatePropagation();this.onOptionSelect(t)}updateEventDataHandler(t){let i=this.calendarData.bookingEvents.find((i=>i.id===t.detail.id));if(i&&t.detail&&t.detail.data){Object.entries(t.detail.data).forEach((([t,s])=>{i[t]=s}))}}dragOverEventDataHandler(t){if(t.detail.id==="CALCULATE_DRAG_OVER_BOUNDS"){let i=document.querySelector("igl-cal-header .topLeftCell");let s=document.querySelectorAll(".headersContainer .headerCell");let e=document.querySelectorAll(".bodyContainer .roomRow .roomTitle");this.visibleCalendarCells={x:[],y:[]};s.forEach((t=>{const s=t;this.visibleCalendarCells.x.push({left:s.offsetLeft+i.offsetWidth,width:s.offsetWidth,id:s.getAttribute("data-day")})}));e.forEach((t=>{const i=t;this.visibleCalendarCells.y.push({top:i.offsetTop,height:i.offsetHeight,id:i.getAttribute("data-room")})}));this.highlightDragOver(true,t.detail.data)}else if(t.detail.id==="DRAG_OVER"){this.highlightDragOver(true,t.detail.data)}else if(t.detail.id==="DRAG_OVER_END"){this.highlightDragOver(false,t.detail.data)}else if(t.detail.id==="STRETCH_OVER_END"){this.highlightDragOver(false,t.detail.data)}}ticketChanged(t,i){if(t===i){return}this.token.setToken(this.ticket);this.initializeApp()}init(){this.calDates={from:this.from_date,to:this.to_date};if(this.ticket!==""){this.token.setToken(this.ticket);this.initializeApp()}this.calDates={from:this.from_date,to:this.to_date};B("unassigned_dates",(t=>{if(Object.keys(t).length===0&&this.highlightedDate!==""){this.highlightedDate=""}}))}renderModalBody(){var t,i;switch((t=this.dialogData)===null||t===void 0?void 0:t.reason){case"checkin":{return`Are you sure you want to Check In this unit?`}case"checkout":{return"Are you sure you want to Check Out this unit?"}case"reallocate":return((i=this.dialogData)===null||i===void 0?void 0:i.description)||"";case"stretch":return"Warning ";default:return"Unknown modal content"}}setUpCalendarData(t,i){this.calendarData.currency=t["My_Result"].currency;this.calendarData.allowedBookingSources=t["My_Result"].allowed_booking_sources;this.calendarData.adultChildConstraints=t["My_Result"].adult_child_constraints;this.calendarData.legendData=this.getLegendData(t);this.calendarData.is_vacation_rental=t["My_Result"].is_vacation_rental;this.calendarData.from_date=i.My_Params_Get_Rooming_Data.FROM;this.calendarData.to_date=i.My_Params_Get_Rooming_Data.TO;this.calendarData.startingDate=new Date(i.My_Params_Get_Rooming_Data.FROM).getTime();this.calendarData.endingDate=new Date(i.My_Params_Get_Rooming_Data.TO).getTime();this.calendarData.formattedLegendData=a(this.calendarData.legendData);let s=i.myBookings||[];s=s.filter((t=>{const i=M(t.TO_DATE,"YYYY-MM-DD");const s=M(t.FROM_DATE,"YYYY-MM-DD");return!i.isSame(s)}));this.calendarData.bookingEvents=s;this.calendarData.toBeAssignedEvents=[]}async initializeApp(){try{let t=this.propertyid;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}let i=null;if(!t){console.log(t);const s=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true,include_sales_rate_plans:true});i=s;t=s.My_Result.id}this.property_id=t;const s=[this.bookingService.getCalendarData(t,this.from_date,this.to_date),this.bookingService.getCountries(this.language),this.roomService.fetchLanguage(this.language),this.housekeepingService.getExposedHKSetup(this.property_id)];if(this.propertyid){s.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true,include_units_hk_status:true,include_sales_rate_plans:true}))}const e=await Promise.all(s);this.tasksEndDate=M().add(30,"days").format("YYYY-MM-DD");this.getHousekeepingTasks({from_date:M().format("YYYY-MM-DD"),to_date:this.tasksEndDate});if(!i){i=e[e.length-1]}const[n,o]=e;l.days=n.days;l.months=n.months;this.setRoomsData(i);this.countries=o;this.setUpCalendarData(i,n);let r=i["My_Result"]["allowed_payment_methods"];this.showPaymentDetails=r.some((t=>t.code==="001"||t.code==="004"));this.updateBookingEventsDateRange(this.calendarData.bookingEvents);this.updateBookingEventsDateRange(this.calendarData.toBeAssignedEvents);this.today=this.transformDateForScroll(new Date);let h=new Date(this.calendarData.startingDate);h.setHours(0,0,0,0);this.days=n.days;this.calendarData.days=this.days;this.calendarData.monthsInfo=n.months;l.fromDate=this.calendarData.from_date;l.toDate=this.calendarData.to_date;setTimeout((()=>{this.scrollToElement(this.today)}),200);if(!this.calendarData.is_vacation_rental){const t=await this.toBeAssignedService.getUnassignedDates(this.property_id,this.from_date,this.to_date);this.unassignedDates={fromDate:this.from_date,toDate:this.to_date,data:Object.assign(Object.assign({},this.unassignedDates),t)};this.calendarData=Object.assign(Object.assign({},this.calendarData),{unassignedDates:t});N(t)}this.socket=Gi("https://realtime.igloorooms.com/");this.socket.on("MSG",(async t=>{await this.handleSocketMessage(t)}))}catch(t){console.error("Initializing Calendar Error",t)}}async getHousekeepingTasks({from_date:t,to_date:i}){var s,e,n,o,r,h,a;const{tasks:l}=await this.housekeepingService.getHkTasks({property_id:this.property_id,from_date:t,to_date:i,housekeepers:[],cleaning_frequency:(n=(s=S.cleaning_frequency)!==null&&s!==void 0?s:(e=U===null||U===void 0?void 0:U.hk_criteria)===null||e===void 0?void 0:e.cleaning_frequencies[0])===null||n===void 0?void 0:n.code,dusty_window:(r=(o=U===null||U===void 0?void 0:U.hk_criteria)===null||o===void 0?void 0:o.dusty_periods[0])===null||r===void 0?void 0:r.code,highlight_window:(a=(h=U===null||U===void 0?void 0:U.hk_criteria)===null||h===void 0?void 0:h.highlight_checkin_options[0])===null||a===void 0?void 0:a.code});c(l)}async handleSocketMessage(t){const i=JSON.parse(t);if(!i){return}const{REASON:s,KEY:e,PAYLOAD:n}=i;if(e.toString()!==this.property_id.toString()){return}let o;if(["DELETE_CALENDAR_POOL","GET_UNASSIGNED_DATES"].includes(s)){o=n}else{o=JSON.parse(n)}console.log({[s]:o});const r={DORESERVATION:this.handleDoReservation,BLOCK_EXPOSED_UNIT:this.handleBlockExposedUnit,ASSIGN_EXPOSED_ROOM:this.handleAssignExposedRoom,REALLOCATE_EXPOSED_ROOM_BLOCK:this.handleReallocateExposedRoomBlock,DELETE_CALENDAR_POOL:this.handleDeleteCalendarPool,GET_UNASSIGNED_DATES:this.handleGetUnassignedDates,UPDATE_CALENDAR_AVAILABILITY:t=>this.availabilityQueue.offer(t),CHANGE_IN_DUE_AMOUNT:this.handleChangeInDueAmount,CHANGE_IN_BOOK_STATUS:this.handleChangeInBookStatus,NON_TECHNICAL_CHANGE_IN_BOOKING:this.handleNonTechnicalChangeInBooking,ROOM_STATUS_CHANGED:this.handleRoomStatusChanged,UNIT_HK_STATUS_CHANGED:this.handleUnitHKStatusChanged,SHARING_PERSONS_UPDATED:this.handleSharingPersonsUpdated,ROOM_TYPE_CLOSE:t=>this.salesQueue.offer(Object.assign(Object.assign({},t),{is_available_to_book:false})),ROOM_TYPE_OPEN:t=>this.salesQueue.offer(Object.assign(Object.assign({},t),{is_available_to_book:true})),HK_SKIP:this.handleHkSkip};const h=r[s];if(h){await h.call(this,o)}else{console.warn(`Unhandled REASON: ${s}`)}}handleSharingPersonsUpdated(t){console.log("sharing persons updated",t);this.calendarData=Object.assign(Object.assign({},this.calendarData),{bookingEvents:[...this.calendarData.bookingEvents.map((i=>{var s;if(i.IDENTIFIER===t.identifier){const e=(s=t.guests)===null||s===void 0?void 0:s.find((t=>t.is_main));return Object.assign(Object.assign({},i),{NAME:d(e.first_name,e.last_name),ROOM_INFO:Object.assign(Object.assign({},i.ROOM_INFO),{sharing_persons:t.guests})})}return i}))]})}handleRoomStatusChanged(t){this.calendarData=Object.assign(Object.assign({},this.calendarData),{bookingEvents:[...this.calendarData.bookingEvents.map((i=>{if(i.IDENTIFIER===t.room_identifier){const s=u({from_date:i.FROM_DATE,to_date:i.TO_DATE,in_out:Object.assign(Object.assign({},i.ROOM_INFO.in_out),{code:t.status}),status_code:i.BASE_STATUS_CODE});return Object.assign(Object.assign({},i),{CHECKIN:t.status==="001",CHECKOUT:t.status==="002",STATUS:s})}return i}))]})}handleHkSkip(t){f({date:t.DATE,unitId:t.PR_ID})}handleUnitHKStatusChanged(t){console.log("hk unit change",t);const i=[...this.calendarData.roomsInfo];const s=i.findIndex((i=>i.id===t.ROOM_CATEGORY_ID));if(s!==-1){const e=Object.assign({},i[s]);const n=e.physicalrooms.findIndex((i=>i.id===t.PR_ID));if(n!==-1){const o=[...e.physicalrooms];const r=Object.assign({},o[n]);r.hk_status=t.HKS_CODE;o[n]=r;e.physicalrooms=o;i[s]=e;this.calendarData=Object.assign(Object.assign({},this.calendarData),{roomsInfo:i})}}const e={date:M().format("YYYY-MM-DD"),unitId:t.PR_ID};if(t.HKS_CODE==="002"){p(e)}else{f(e)}}async handleDoReservation(t){const i=g(t);this.AddOrUpdateRoomBookings(i)}async handleBlockExposedUnit(t){const i=[await b(t)];this.AddOrUpdateRoomBookings(i)}async handleAssignExposedRoom(t){console.log(t);const i=g(t);this.AddOrUpdateRoomBookings(i)}async handleReallocateExposedRoomBlock(t){await this.handleBlockExposedUnit(t)}async handleDeleteCalendarPool(t){console.log("delete calendar pool");this.calendarData=Object.assign(Object.assign({},this.calendarData),{bookingEvents:this.calendarData.bookingEvents.filter((i=>i.POOL!==t))})}async handleGetUnassignedDates(t){const i=this.parseDateRange(t);if(!this.calendarData.is_vacation_rental&&new Date(i.FROM_DATE).getTime()>=this.calendarData.startingDate&&new Date(i.TO_DATE).getTime()<=this.calendarData.endingDate){const t=await this.toBeAssignedService.getUnassignedDates(this.property_id,m(new Date(i.FROM_DATE)),m(new Date(i.TO_DATE)));N(t);this.unassignedDates={fromDate:m(new Date(i.FROM_DATE)),toDate:m(new Date(i.TO_DATE)),data:t};if(Object.keys(t).length===0){R(m(new Date(i.FROM_DATE)),m(new Date(i.TO_DATE)));this.reduceAvailableUnitEvent.emit({fromDate:m(new Date(i.FROM_DATE)),toDate:m(new Date(i.TO_DATE))})}}}parseDateRange(t){const i={};const s=t.split("|");s.forEach((t=>{const s=t.split(":");i[s[0]]=s[1]}));return i}handleChangeInDueAmount(t){this.calendarData=Object.assign(Object.assign({},this.calendarData),{bookingEvents:this.calendarData.bookingEvents.map((i=>{if(t.pools.includes(i.ID)){return Object.assign(Object.assign({},i),{BALANCE:t.due_amount})}return i}))})}handleChangeInBookStatus(t){this.calendarData=Object.assign(Object.assign({},this.calendarData),{bookingEvents:this.calendarData.bookingEvents.map((i=>{if(t.pools.includes(i.ID)){return Object.assign(Object.assign({},i),{STATUS:i.STATUS!=="IN-HOUSE"?y[t.status_code]:t.status_code==="001"?y[t.status_code]:"IN-HOUSE"})}return i}))})}handleNonTechnicalChangeInBooking(t){this.calendarData=Object.assign(Object.assign({},this.calendarData),{bookingEvents:this.calendarData.bookingEvents.map((i=>{if(i.BOOKING_NUMBER===t.booking_nbr){return Object.assign(Object.assign({},i),{PRIVATE_NOTE:v(t.extras)})}return i}))})}checkBookingAvailability(t){return this.calendarData.bookingEvents.some((i=>i.ID===t.ID||i.FROM_DATE===t.FROM_DATE&&i.TO_DATE===t.TO_DATE&&i.PR_ID===t.PR_ID))}updateBookingEventsDateRange(t){t.forEach((t=>{var i;t.legendData=this.calendarData.formattedLegendData;t.defaultDateRange={};t.defaultDateRange.fromDate=new Date(t.FROM_DATE+"T00:00:00");t.defaultDateRange.fromDateStr=this.getDateStr(t.defaultDateRange.fromDate);t.defaultDateRange.fromDateTimeStamp=t.defaultDateRange.fromDate.getTime();t.defaultDateRange.toDate=new Date(t.TO_DATE+"T00:00:00");t.defaultDateRange.toDateStr=this.getDateStr(t.defaultDateRange.toDate);t.defaultDateRange.toDateTimeStamp=t.defaultDateRange.toDate.getTime();t.defaultDateRange.dateDifference=t.NO_OF_DAYS;t.roomsInfo=[...this.calendarData.roomsInfo];if(!_(t.STATUS_CODE)){t.STATUS=u({in_out:(i=t.ROOM_INFO)===null||i===void 0?void 0:i.in_out,from_date:t.FROM_DATE,to_date:t.TO_DATE,status_code:t.BASE_STATUS_CODE})}}))}processSalesBatch(t){const i=[...l.days];const s=new Map(l.disabled_cells);for(const e of t){const t=i.findIndex((t=>t.value===e.night));if(t===-1){console.warn(`Couldn't find day ${e.night}`);continue}let n=this.roomTypeIdsCache.get(e.rate_plan_id);if(n==="skip"){continue}if(!n){const s=i[t].rate.findIndex((t=>t.rateplans.some((t=>t.id===e.rate_plan_id))));if(s===-1){this.roomTypeIdsCache.set(e.rate_plan_id,"skip");console.warn(`Couldn't find room type for rate plan ${e.rate_plan_id}`);continue}const o=i[t].rate[s];const r=o.rateplans.findIndex((t=>t.id===e.rate_plan_id));n={id:s,index:r};this.roomTypeIdsCache.set(e.rate_plan_id,n)}const{id:o,index:r}=n;const h=i[t].rate[o];const a=h.rateplans.map(((t,i)=>i===r?Object.assign(Object.assign({},t),{is_available_to_book:e.is_available_to_book}):t));const l=a.some((t=>t.is_available_to_book));i[t].rate[o]=Object.assign(Object.assign({},h),{rateplans:a,is_available_to_book:l});for(const e of h.physicalrooms){const n=`${e.id}_${i[t].value}`;s.set(n,{disabled:!l,reason:"stop_sale"})}}l["disabled_cells"]=new Map(s);l.days=i}processAvailabilityBatch(t){let i=[...l.days];const s=new Map(l.disabled_cells);for(const e of t){const t=i.findIndex((t=>t.value===e.date));if(t===-1){console.warn(`Couldn't find day ${e.date}`);return}const n=i[t].rate.findIndex((t=>t.id===e.room_type_id));if(n===-1){console.warn(`Couldn't find room type ${e.room_type_id}`);return}const o=i[t].rate[n];o.exposed_inventory.rts=e.availability;const r=o.rateplans.every((t=>!t.is_available_to_book));for(const t of o.physicalrooms){const i=`${t.id}_${e.date}`;s.set(i,{disabled:e.availability===0,reason:r?"stop_sale":"inventory"})}}l["disabled_cells"]=new Map(s);l.days=[...i]}setRoomsData(t){var i,s;let e=new Array;if((s=(i=t.My_Result)===null||i===void 0?void 0:i.roomtypes)===null||s===void 0?void 0:s.length){e=t.My_Result.roomtypes;t.My_Result.roomtypes.forEach((t=>{t.expanded=true}))}S.roomsInfo=e;this.calendarData.roomsInfo=e}getLegendData(t){return t["My_Result"].calendar_legends}getDateStr(t,i="default"){return t.getDate()+" "+t.toLocaleString(i,{month:"short"})+" "+t.getFullYear()}scrollToElement(t){this.scrollContainer=this.scrollContainer||this.element.querySelector(".calendarScrollContainer");const i=this.element.querySelector(".topLeftCell");const s=this.element.querySelector(".day-"+t);if(s){this.scrollContainer.scrollTo({left:0});const t=s.getBoundingClientRect();const e=this.scrollContainer.getBoundingClientRect();const n=i.getBoundingClientRect();this.scrollContainer.scrollTo({left:t.left-e.left-n.width-t.width})}}AddOrUpdateRoomBookings(t,i=undefined){let s=[...this.calendarData.bookingEvents];t.forEach((t=>{if(!this.checkBookingAvailability(t)){s=s.filter((i=>i.ID!==t.ID))}}));this.updateBookingEventsDateRange(t);if(i){s=s.filter((t=>t.POOL===i))}t.forEach((t=>{if(!s.some((i=>i.ID===t.ID))){s.push(t)}}));this.calendarData=Object.assign(Object.assign({},this.calendarData),{bookingEvents:s});const e=t=>{const i=M(this.tasksEndDate,"YYYY-MM-DD");return M(t.FROM_DATE,"YYYY-MM-DD").isSameOrBefore(i,"date")||M(t.TO_DATE,"YYYY-MM-DD").isSameOrBefore(i,"date")};if(t.some(e)){this.getHousekeepingTasks({from_date:M().format("YYYY-MM-DD"),to_date:this.tasksEndDate})}}transformDateForScroll(t){return M(t).format("D_M_YYYY")}shouldRenderCalendarView(){return this.calendarData&&this.calendarData.days&&this.calendarData.days.length}onOptionSelect(t){const i=t.detail;const s=this.element.querySelector("#iglooCalendar");switch(i.key){case"showAssigned":s.classList.remove("showLegend");s.classList.remove("showToBeAssigned");s.classList.toggle("showToBeAssigned");this.showLegend=false;this.showToBeAssigned=true;break;case"showLegend":s.classList.remove("showToBeAssigned");s.classList.remove("showLegend");s.classList.toggle("showLegend");this.showLegend=true;this.showToBeAssigned=false;break;case"calendar":let t=new Date;if(i.data.start!==undefined&&i.data.end!==undefined){t=i.data.start.toDate();this.handleDateSearch(i.data)}else{t=new Date(i.data);t.setDate(t.getDate()+1);if(!(i===null||i===void 0?void 0:i.noScroll)){this.scrollToElement(t.getDate()+"_"+(t.getMonth()+1)+"_"+t.getFullYear())}}this.highlightedDate=this.transformDateForScroll(t);break;case"search":break;case"bulk":this.calendarSidebarState={type:"bulk-blocks",payload:null};break;case"add":if(i.data.event_type!=="EDIT_BOOKING"){this.bookingItem=i.data}else{this.editBookingItem=i.data}break;case"gotoToday":this.scrollToElement(this.today);break;case"closeSideMenu":this.closeSideMenu();this.highlightedDate="";this.showBookProperty=false;break}}async addDatesToCalendar(t,i){const[s]=await Promise.all([this.bookingService.getCalendarData(this.property_id,t,i)]);const e=s.myBookings||[];this.updateBookingEventsDateRange(e);if(new Date(t).getTime()<new Date(this.calendarData.startingDate).getTime()){this.calendarData.startingDate=new Date(t).getTime();this.calendarData.from_date=t;l.fromDate=this.calendarData.from_date;this.days=[...s.days,...this.days];let n=[...s.months];if(this.calendarData.monthsInfo[0].monthName===s.months[s.months.length-1].monthName){this.calendarData.monthsInfo[0].daysCount=this.calendarData.monthsInfo[0].daysCount+s.months[s.months.length-1].daysCount;n.pop()}let o=JSON.parse(JSON.stringify(e));o=o.filter((t=>{const i=this.calendarData.bookingEvents.findIndex((i=>i.ID===t.ID));if(i!==-1){this.calendarData.bookingEvents[i].FROM_DATE=t.FROM_DATE;this.calendarData.bookingEvents[i].NO_OF_DAYS=w(t.FROM_DATE,this.calendarData.bookingEvents[i].TO_DATE);return false}return true}));l.days=this.days;this.calendarData=Object.assign(Object.assign({},this.calendarData),{days:this.days,monthsInfo:[...n,...this.calendarData.monthsInfo],bookingEvents:[...this.calendarData.bookingEvents,...o]});if(Math.abs(M().diff(M(t,"YYYY-MM-DD"),"days"))<=10){const s=await this.toBeAssignedService.getUnassignedDates(this.property_id,t,i);this.calendarData.unassignedDates=Object.assign(Object.assign({},this.calendarData.unassignedDates),s);this.unassignedDates={fromDate:t,toDate:i,data:s};N(s)}}else{this.calendarData.endingDate=new Date(i).getTime();this.calendarData.to_date=i;l.toDate=this.calendarData.to_date;let n=[...s.months];this.days=[...this.days,...s.days];if(this.calendarData.monthsInfo[this.calendarData.monthsInfo.length-1].monthName===s.months[0].monthName){this.calendarData.monthsInfo[this.calendarData.monthsInfo.length-1].daysCount=this.calendarData.monthsInfo[this.calendarData.monthsInfo.length-1].daysCount+s.months[0].daysCount;n.shift()}let o=JSON.parse(JSON.stringify(e));o=o.filter((t=>{const i=this.calendarData.bookingEvents.findIndex((i=>i.ID===t.ID));if(i!==-1){this.calendarData.bookingEvents[i].TO_DATE=t.TO_DATE;this.calendarData.bookingEvents[i].NO_OF_DAYS=w(this.calendarData.bookingEvents[i].FROM_DATE,t.TO_DATE);return false}return true}));l.days=this.days;this.calendarData=Object.assign(Object.assign({},this.calendarData),{days:this.days,monthsInfo:[...this.calendarData.monthsInfo,...n],bookingEvents:[...this.calendarData.bookingEvents,...o]});const r=await this.toBeAssignedService.getUnassignedDates(this.property_id,t,i);this.calendarData.unassignedDates=Object.assign(Object.assign({},this.calendarData.unassignedDates),r);this.unassignedDates={fromDate:t,toDate:i,data:r};N(r)}}async handleDateSearch(t){const i=M(t.start).toDate();const s=M(this.calDates.from).toDate();const e=t.end.toDate();const n=this.calendarData.endingDate;if(i.getTime()<new Date(this.calDates.from).getTime()){await this.addDatesToCalendar(M(i).add(-1,"days").format("YYYY-MM-DD"),M(s).add(-1,"days").format("YYYY-MM-DD"));this.calDates=Object.assign(Object.assign({},this.calDates),{from:t.start.add(-1,"days").format("YYYY-MM-DD")});this.scrollToElement(this.transformDateForScroll(i))}else if(i.getTime()>s.getTime()&&i.getTime()<n&&e.getTime()<n){this.scrollToElement(this.transformDateForScroll(i))}else if(i.getTime()>n){const t=k(new Date(this.calendarData.endingDate));await this.addDatesToCalendar(t,M(e).add(2,"months").format("YYYY-MM-DD"));this.scrollToElement(this.transformDateForScroll(i))}}closeSideMenu(){this.showLegend=false;this.showToBeAssigned=false}dragScrollContent(t){this.scrollViewDragging=false;let i=t&&t.target?this.hasAncestorWithClass(t.target,"preventPageScroll"):false;if(!i&&t.buttons===1){this.scrollViewDragPos={left:this.scrollContainer.scrollLeft,top:this.scrollContainer.scrollTop,x:t.clientX,y:t.clientY};document.addEventListener("mousemove",this.onScrollContentMoveHandler);document.addEventListener("mouseup",this.onScrollContentMoveEndHandler)}}calendarScrolling(){if(this.scrollContainer){if(this.highlightedDate){const t=document.querySelector(`.day-${this.highlightedDate}`);if(t){const{left:i,right:s}=t.getBoundingClientRect();const e=i>=0&&s<=window.innerWidth;if(!e){this.highlightedDate=""}}}const t=this.scrollContainer.getBoundingClientRect();let i=170;let s=t.width-i;let e=t.x+i;let n=t.x+t.width;let o=Array.from(this.element.querySelectorAll(".monthCell"));if(o.length){o.map((async t=>{let i=t.getBoundingClientRect();if(o.indexOf(t)===o.length-1){if(i.x+i.width<=n&&!this.reachedEndOfCalendar){this.reachedEndOfCalendar=true;const t=O(new Date(this.calendarData.endingDate));const i=k(new Date(this.calendarData.endingDate));await this.addDatesToCalendar(i,t);this.reachedEndOfCalendar=false}}if(i.x+i.width<e);else if(i.x>n);else{let o=t.querySelector(".monthTitle");let r=0;let h=i.width;if(i.x<e){r=Math.abs(i.x)-e;r=i.x<0?Math.abs(i.x)+e:Math.abs(r);h=i.x+i.width>n?s:i.x+i.width-e}else{h=s-h>h?h:s-i.x+e}o.style.marginLeft=r+"px";o.style.width=h+"px"}}))}}}hasAncestorWithClass(t,i){let s=t;while(s!==null){if(s.matches(`.${i}`)){return true}s=s.parentElement}return false}async highlightDragOver(t,i){let s,e;if(i){s=this.visibleCalendarCells.x.find((t=>t.left<i.x&&i.x<=t.left+t.width));e=this.visibleCalendarCells.y.find((t=>t.top<i.y&&i.y<=t.top+t.height))}if(t&&s&&e){this.dragOverHighlightElement.emit({dragOverElement:e.id+"_"+s.id})}else{this.dragOverHighlightElement.emit({dragOverElement:""})}if(!t){this.moveBookingTo.emit({bookingId:i.id,fromRoomId:i.fromRoomId,toRoomId:e&&e.id||"revert",moveToDay:s&&s.id||"revert",pool:i.pool,from_date:D(s&&s.id),to_date:E(s&&s.id,i.nbOfDays)})}}handleModalConfirm(){var t;const i=()=>{this.dialogData=null};try{switch((t=this.dialogData)===null||t===void 0?void 0:t.reason){case"checkin":case"checkout":{const{bookingNumber:t,roomIdentifier:s}=this.dialogData;const e=this.dialogData.reason==="checkin"?"001":"002";this.bookingService.handleExposedRoomInOut({booking_nbr:t,room_identifier:s,status:e}).finally(i);if(this.dialogData.reason==="checkin"){this.openCalendarSidebar.emit({type:"room-guests",payload:this.dialogData.sidebarPayload})}break}case"stretch":const t=this.dialogData,s=Wi(t,["reason"]);this.showRoomNightsDialog.emit(s);break;case"reallocate":{if(!this.dialogData){console.warn("No dialog data available for reallocation.");return}const{pool:t,toRoomId:s,from_date:e,to_date:n}=this.dialogData;this.eventsService.reallocateEvent(t,s,e,n).then(i).catch((()=>{console.error("Reallocation failed. Reverting booking.");this.revertBooking.emit(t)})).finally(i);break}default:i();break}}catch(t){console.error("Error handling modal confirm:",t);i()}}handleModalCancel(){var t;if(((t=this.dialogData)===null||t===void 0?void 0:t.reason)==="reallocate"||this.dialogData.reason==="stretch"){this.revertBooking.emit(this.dialogData.pool)}this.dialogData=null}handleRoomNightsDialogClose(t){if(t.detail.type==="cancel"){this.revertBooking.emit(this.roomNightsData.pool)}this.roomNightsData=null}handleSideBarToggle(t){var i;if(t.detail){this.calendarSidebarState=null;if(this.editBookingItem){this.editBookingItem=null}if(this.roomNightsData){this.revertBooking.emit(this.roomNightsData.pool);this.roomNightsData=null}if(((i=this.dialogData)===null||i===void 0?void 0:i.reason)==="reallocate"){this.revertBooking.emit(this.dialogData.pool);this.dialogData=null}}}handleCloseBookingWindow(){this.bookingItem=null}render(){var t,i,o,r,h,a,l,c,d,u,f,p,g,b,m,y,v;return s(n,{key:"95d5df566e22bd5d1de71ce7a06cec969edc629c"},s("ir-toast",{key:"eeed200fa854f1c648d1302578cc9b18234e5264"}),s("ir-interceptor",{key:"179e2239daa46338c6660e7d5a8368ba2fb4835e"}),s("div",{key:"9d7d84ff18b406e150d71ce6754187cc851be8f4",id:"iglooCalendar",class:{"igl-calendar":true,showToBeAssigned:this.showToBeAssigned,showLegend:this.showLegend}},this.shouldRenderCalendarView()?s(e,{"data-testid":"ir-calendar"},this.showToBeAssigned&&s("igl-to-be-assigned",{unassignedDatesProp:this.unassignedDates,to_date:this.to_date,from_date:this.from_date,propertyid:this.property_id,class:"tobeAssignedContainer",calendarData:this.calendarData,onOptionEvent:t=>this.onOptionSelect(t)}),this.showLegend&&s("igl-legends",{class:"legendContainer",legendData:this.calendarData.legendData,onOptionEvent:t=>this.onOptionSelect(t)}),s("div",{class:"calendarScrollContainer",onMouseDown:t=>this.dragScrollContent(t),onScroll:()=>this.calendarScrolling()},s("div",{id:"calendarContainer"},s("igl-cal-header",{unassignedDates:this.unassignedDates,to_date:this.to_date,propertyid:this.property_id,today:this.today,calendarData:this.calendarData,highlightedDate:this.highlightedDate,onOptionEvent:t=>this.onOptionSelect(t)}),s("igl-cal-body",{propertyId:this.property_id,language:this.language,countries:this.countries,currency:this.calendarData.currency,today:this.today,highlightedDate:this.highlightedDate,isScrollViewDragging:this.scrollViewDragging,calendarData:this.calendarData}),s("igl-cal-footer",{highlightedDate:this.highlightedDate,today:this.today,calendarData:this.calendarData,onOptionEvent:t=>this.onOptionSelect(t)})))):s("ir-loading-screen",{message:"Preparing Calendar Data"})),this.bookingItem&&s("igl-book-property",{key:"350222faed1bce682b377f8efafb5331914e16e5",allowedBookingSources:this.calendarData.allowedBookingSources,adultChildConstraints:this.calendarData.adultChildConstraints,showPaymentDetails:this.showPaymentDetails,countries:this.countries,currency:this.calendarData.currency,language:this.language,propertyid:this.property_id,bookingData:this.bookingItem,onCloseBookingWindow:()=>this.handleCloseBookingWindow()}),s("ir-sidebar",{key:"1ce38758686ab1417a297058fa7ab78ccfbad1d2",onIrSidebarToggle:this.handleSideBarToggle.bind(this),open:!!this.calendarSidebarState||this.roomNightsData!==null||this.editBookingItem&&this.editBookingItem.event_type==="EDIT_BOOKING",showCloseButton:false,sidebarStyles:{width:((t=this.calendarSidebarState)===null||t===void 0?void 0:t.type)==="room-guests"?"60rem":this.editBookingItem?"80rem":"var(--sidebar-width,40rem)",background:this.editBookingItem?"#F2F3F8":"white"}},this.roomNightsData&&s("ir-room-nights",{key:"cfd13228415e414ef72b70b725570f57a551bd7d",slot:"sidebar-body",pool:this.roomNightsData.pool,onCloseRoomNightsDialog:this.handleRoomNightsDialogClose.bind(this),language:this.language,bookingNumber:this.roomNightsData.bookingNumber,identifier:this.roomNightsData.identifier,toDate:this.roomNightsData.to_date,fromDate:this.roomNightsData.from_date,defaultDates:this.roomNightsData.defaultDates,ticket:this.ticket,propertyId:this.property_id}),this.editBookingItem&&this.editBookingItem.event_type==="EDIT_BOOKING"&&s("ir-booking-details",{key:"cf11d9d2d8cbe796d6288e0eef422f846f0b577b",slot:"sidebar-body",hasPrint:true,hasReceipt:true,hasCloseButton:true,onCloseSidebar:()=>this.editBookingItem=null,is_from_front_desk:true,propertyid:this.property_id,hasRoomEdit:true,hasRoomDelete:true,bookingNumber:this.editBookingItem.BOOKING_NUMBER,ticket:this.ticket,language:this.language,hasRoomAdd:true}),((i=this.calendarSidebarState)===null||i===void 0?void 0:i.type)==="room-guests"&&s("ir-room-guests",{key:"510e69860bbf788287f898325e5ee227fc032f1f",countries:this.countries,language:this.language,identifier:(r=(o=this.calendarSidebarState)===null||o===void 0?void 0:o.payload)===null||r===void 0?void 0:r.identifier,bookingNumber:(h=this.calendarSidebarState)===null||h===void 0?void 0:h.payload.bookingNumber,roomName:(l=(a=this.calendarSidebarState)===null||a===void 0?void 0:a.payload)===null||l===void 0?void 0:l.roomName,totalGuests:(d=(c=this.calendarSidebarState)===null||c===void 0?void 0:c.payload)===null||d===void 0?void 0:d.totalGuests,sharedPersons:(f=(u=this.calendarSidebarState)===null||u===void 0?void 0:u.payload)===null||f===void 0?void 0:f.sharing_persons,slot:"sidebar-body",checkIn:(g=(p=this.calendarSidebarState)===null||p===void 0?void 0:p.payload)===null||g===void 0?void 0:g.checkin,onCloseModal:()=>this.calendarSidebarState=null}),((b=this.calendarSidebarState)===null||b===void 0?void 0:b.type)==="bulk-blocks"&&s("igl-bulk-operations",{key:"f19e0fc0cce58228c33e9d8bc1fa0ee4fa4a9964",slot:"sidebar-body",property_id:this.property_id,onCloseModal:()=>this.calendarSidebarState=null})),s("ir-modal",{key:"ff4a565277db26130d08546b65a3afafed8286dc",ref:t=>this.calendarModalEl=t,modalTitle:"",rightBtnActive:((m=this.dialogData)===null||m===void 0?void 0:m.reason)==="reallocate"?!this.dialogData.hideConfirmButton:true,leftBtnText:(y=j===null||j===void 0?void 0:j.entries)===null||y===void 0?void 0:y.Lcz_Cancel,rightBtnText:(v=j===null||j===void 0?void 0:j.entries)===null||v===void 0?void 0:v.Lcz_Confirm,modalBody:this.renderModalBody(),onConfirmModal:this.handleModalConfirm.bind(this),onCancelModal:this.handleModalCancel.bind(this)}))}get element(){return o(this)}static get watchers(){return{ticket:["ticketChanged"]}}};Ji.style=qi;const Xi=".sc-ir-booking-email-logs-h{display:block}";const Qi=Xi;const Zi=class{constructor(i){t(this,i);this.token=new P}componentWillLoad(){if(this.ticket){this.token.setToken(this.ticket)}}handleTicketChange(){if(this.ticket){this.token.setToken(this.ticket)}}render(){return s(n,{key:"4924d3ea073d1c2770282b5d8c202ac95dd05fb5",class:"p-1"},s("ir-interceptor",{key:"62f014023b136d4ce3fecd6984a31e40c91ba4d1",handledEndpoints:["/Get_Email_log_By_BOOK_NBR"]}),s("ir-toast",{key:"2ff24519ac6df584cb329e3debb3df6c2e156622"}),s("div",{key:"dfb82d4c2bfdb6fd38faf4aee483a98b6037ee17",class:"d-flex align-items-center mb-1",style:{gap:"0.5rem"}},s("ir-input-text",{key:"8ccbca52eece073f1647a2c9bd09f19321455df4",class:"m-0",inputContainerStyle:{margin:"0"},value:this.bookingNumber,onTextChange:t=>this.bookingNumber=t.detail,placeholder:"booking number"}),s("ir-button",{key:"7abe1c9aeb90e36a130cc2fce7602f53410b81ce",size:"sm",text:"search",onClickHandler:async()=>{const{data:t}=await F.post("/Get_Email_log_By_BOOK_NBR",{BOOK_NBR:this.bookingNumber});if(t.ExceptionMsg){return}this.data=t.My_Result}})),s("p",{key:"f6de6e54bb3e713df9167c7258ead05bce302bf0"},JSON.stringify(this.data,null,2)))}static get watchers(){return{ticket:["handleTicketChange"]}}};Zi.style=Qi;function ts(){const t=new URLSearchParams(window.location.search);const i={};for(const[s,e]of t.entries()){i[s]=e}return i}const is=".sc-ir-booking-listing-h{display:block;height:100%}.logo.sc-ir-booking-listing{height:2rem;width:2rem}.card.sc-ir-booking-listing{overflow-x:auto}.secondary-p.sc-ir-booking-listing{font-size:12px !important}.room-service.sc-ir-booking-listing{display:flex;align-items:center;justify-content:space-between;gap:0.5rem;width:100%;padding:0.25rem 0}.room-name-container.sc-ir-booking-listing{background:#acecff;padding:0.1rem 0.3rem;border-radius:5px}.h-screen.sc-ir-booking-listing{height:100%}.price-span.sc-ir-booking-listing{margin:0;margin-right:5px}.main-container.sc-ir-booking-listing{height:100%;overflow-y:auto}.badge.ct_ir_badge.sc-ir-booking-listing{padding:0.2rem 0.3rem}.yellow_dot.sc-ir-booking-listing{height:0.5rem;width:0.5rem;height:0.5rem;width:0.8rem;border-radius:50%;background:rgb(244, 213, 82);margin-left:0.5rem;display:inline-flex;padding:0;margin:0}.booking_name.sc-ir-booking-listing{display:flex;align-items:center;gap:0.4rem}.bg-ir-red.sc-ir-booking-listing{background:#ff4961;padding:0.2rem 0.3rem}.due-btn.sc-ir-booking-listing{border:1px solid #ff4961;color:#ff4961;cursor:pointer;padding:1px 0.25rem !important;font-size:12px !important}.due-btn.sc-ir-booking-listing:hover{background:#ff4961;color:white}.booking_number.sc-ir-booking-listing{all:unset;cursor:pointer}.booking_number.sc-ir-booking-listing:hover{color:#1e9ff2}.in-out.sc-ir-booking-listing{width:150px !important}.booking_guest_name.sc-ir-booking-listing{width:fit-content;padding:0 !important;margin:0}.booking_guest_name.sc-ir-booking-listing .button-text.sc-ir-booking-listing{padding:0 !important}.buttons-container.sc-ir-booking-listing{gap:10px}td.sc-ir-booking-listing ul.sc-ir-booking-listing{width:max-content !important}td.sc-ir-booking-listing{width:max-content !important}.date-p.sc-ir-booking-listing{width:max-content !important;min-width:100%;text-align:center !important}.booking-label-gap.sc-ir-booking-listing{gap:5px}@media (min-width: 1024px){.yellow_dot.sc-ir-booking-listing{height:0.5rem;width:0.5rem}}";const ss=is;const es=class{constructor(i){t(this,i);this.language="";this.ticket="";this.rowCount=10;this.isLoading=false;this.currentPage=1;this.totalPages=1;this.oldStartValue=0;this.editBookingItem=null;this.showCost=false;this.bookingListingService=new $;this.bookingService=new h;this.roomService=new r;this.token=new P;this.statusColors={"001":"badge-warning","002":"badge-success","003":"badge-danger","004":"badge-danger"}}componentWillLoad(){if(this.baseUrl){this.token.setBaseUrl(this.baseUrl)}z("end_row",this.rowCount);G.rowCount=this.rowCount;if(this.ticket!==""){G.token=this.ticket;this.token.setToken(this.ticket);this.initializeApp()}K("userSelection",(async t=>{const i=t.total_count;this.totalPages=Math.ceil(i/this.rowCount)}));K("bookings",(async t=>{this.showCost=t.some((t=>t.financial.gross_cost!==null&&t.financial.gross_cost>0))}))}ticketChanged(t,i){if(t===i){return}this.token.setToken(this.ticket);G.token=this.ticket;this.initializeApp()}async initializeApp(){try{this.isLoading=true;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}let t=this.propertyid;if(!t){const i=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true});t=i.My_Result.id}const i=[this.bookingService.getSetupEntriesByTableNameMulti(["_PAY_TYPE","_PAY_TYPE_GROUP","_PAY_METHOD"]),this.bookingListingService.getExposedBookingsCriteria(t),this.roomService.fetchLanguage(this.language,["_BOOKING_LIST_FRONT"])];if(this.propertyid){i.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true}))}const[s]=await Promise.all(i);const{pay_type:e,pay_type_group:n,pay_method:o}=this.bookingService.groupEntryTablesResult(s);this.paymentEntries={groups:n,methods:o,types:e};z("property_id",t);await this.bookingListingService.getExposedBookings(Object.assign(Object.assign({},G.userSelection),{is_to_export:false}))}catch(t){console.error(t)}finally{this.isLoading=false}}handleSideBarToggle(t){if(t.detail){this.editBookingItem=null}}geSearchFiltersFromParams(){const t=ts();if(t){console.log("update params");let i={};if(t.e){i["end_row"]=Number(t.e)}if(t.s){i["start_row"]=Number(t.s)}if(t.status){i["booking_status"]=t.status}if(t.filter){i["filter_type"]=t.filter}if(t.from){i["from"]=t.from}if(t.to){i["to"]=t.to}V(i)}console.log("params=>",t)}getPaginationBounds(){const t=G.userSelection.total_count;const i=(this.currentPage-1)*this.rowCount;let s=this.currentPage*this.rowCount;s=s>t?t:s;return{startItem:i,endItem:s,totalCount:t}}openModal(){this.listingModalTimeout=setTimeout((()=>{this.listingModal=this.el.querySelector("ir-listing-modal");this.listingModal.editBooking=this.editBookingItem;this.listingModal.openModal()}),100)}disconnectedCallback(){clearTimeout(this.listingModalTimeout)}async handleResetData(t){t.stopImmediatePropagation();t.stopPropagation();await this.bookingListingService.getExposedBookings(Object.assign(Object.assign({},G.userSelection),{is_to_export:false}))}async handleResetStoreData(t){t.stopImmediatePropagation();t.stopPropagation();await this.bookingListingService.getExposedBookings(Object.assign(Object.assign({},G.userSelection),{is_to_export:false}))}handleBookingChanged(t){t.stopImmediatePropagation();t.stopPropagation();G.bookings=[...G.bookings.map((i=>{if(i.booking_nbr===t.detail.booking_nbr){return t.detail}return i}))]}renderItemRange(){const{endItem:t,startItem:i,totalCount:s}=this.getPaginationBounds();return`${j.entries.Lcz_View} ${i+1} - ${t} ${j.entries.Lcz_Of} ${s}`}async updateData(){const{endItem:t,startItem:i}=this.getPaginationBounds();await this.bookingListingService.getExposedBookings(Object.assign(Object.assign({},G.userSelection),{is_to_export:false,start_row:i,end_row:t}))}calculateTotalPersons(t){const i=({adult_nbr:t,children_nbr:i,infant_nbr:s})=>(t!==null&&t!==void 0?t:0)+(i!==null&&i!==void 0?i:0)+(s!==null&&s!==void 0?s:0);return t.rooms.reduce(((t,s)=>i(s.occupancy)+t),0)}render(){var t,i,o,r,h,a,l,c,d,u,f,p,g,b,m,y,_,w,k,O;if(this.isLoading||this.ticket===""){return s("ir-loading-screen",null)}return s(n,null,s("ir-interceptor",null),s("ir-toast",null),s("div",{class:"p-1 main-container"},s("ir-listing-header",{propertyId:this.propertyid,p:this.p,language:this.language}),s("section",null,s("div",{class:"card p-1 flex-fill m-0 mt-2"},s("table",{class:"table table-striped table-bordered no-footer dataTable"},s("thead",null,s("tr",null,s("th",{scope:"col",class:"text-center"},(t=j.entries)===null||t===void 0?void 0:t.Lcz_Booking,"#"),s("th",{scope:"col"},(i=j.entries)===null||i===void 0?void 0:i.Lcz_BookedOn),s("th",{scope:"col"},(o=j.entries)===null||o===void 0?void 0:o.Lcz_GuestSource),s("th",{scope:"col",class:"text-left services-cell"},(r=j.entries)===null||r===void 0?void 0:r.Lcz_Services),s("th",{scope:"col",class:"in-out"},(h=j.entries)===null||h===void 0?void 0:h.Lcz_Dates),s("th",{scope:"col"},s("span",{class:"price-span"},(a=j.entries)===null||a===void 0?void 0:a.Lcz_Amount),s("ir-tooltip",{customSlot:true,message:`<span style="width:100%;display:block;">${(l=j.entries)===null||l===void 0?void 0:l.Lcz_BookingBalance}</span><span>${(c=j.entries)===null||c===void 0?void 0:c.Lcz_ClickToSettle}</span>`},s("span",{slot:"tooltip-trigger",class:"m-0 btn due-btn"},(d=j.entries)===null||d===void 0?void 0:d.Lcz_Balance))),this.showCost&&s("th",{scope:"col",class:"services-cell"},(u=j.entries)===null||u===void 0?void 0:u.Lcz_Cost),s("th",{scope:"col"},(f=j.entries)===null||f===void 0?void 0:f.Lcz_Status),s("th",{scope:"col"},s("p",{class:"sr-only"},"actions")))),s("tbody",{class:""},G.bookings.length===0&&s("tr",null,s("td",{colSpan:8},(p=j.entries)===null||p===void 0?void 0:p.Lcz_NoDataAvailable)),(g=G.bookings)===null||g===void 0?void 0:g.map((t=>{var i,n,o,r,h;let a=this.statusColors[t.is_requested_to_cancel?"003":t.status.code];const l=t.ota_manipulations?t.ota_manipulations[t.ota_manipulations.length-1]:null;const c=this.calculateTotalPersons(t);return s("tr",{key:t.booking_nbr},s("td",{class:"text-left"},s("ir-button",{btn_color:"link",btnStyle:{padding:"0",margin:"0"},onClickHandler:()=>this.editBookingItem={booking:t,cause:"edit"},text:t.booking_nbr}),t.channel_booking_nbr&&s("p",{class:"p-0 m-0 text-center secondary-p"},t.channel_booking_nbr)),s("td",null,s("p",{class:"p-0 m-0 date-p"},M(t.booked_on.date,"YYYY-MM-DD").format("DD-MMM-YYYY")),s("p",{class:"p-0 m-0 secondary-p"},q(t.booked_on.hour.toString(),t.booked_on.minute.toString()))),s("td",null,s("div",{class:"h-100 d-flex align-items-center ",style:{width:"max-content"}},s("img",{class:"mr-2 logo",src:t.origin.Icon,alt:t.origin.Label}),s("div",{class:"text-left"},s("div",{class:"d-flex align-items-center"},s("div",{class:"booking_name m-0 p-0"},s("ir-button",{btn_color:"link",onClickHandler:()=>this.editBookingItem={booking:t,cause:"guest"},text:`${t.guest.first_name} ${(i=t.guest.last_name)!==null&&i!==void 0?i:""}`,btnStyle:{width:"fit-content",padding:"0",margin:"0"},labelStyle:{padding:"0"}}),t.guest.nbr_confirmed_bookings>1&&!t.agent&&s("div",{class:"m-0 p-0"},s("ir-tooltip",{message:`${j.entries.Lcz_BookingsNbr}`.replace("%1",t.guest.nbr_confirmed_bookings.toString()),customSlot:true},s("div",{class:"d-flex align-items-center my-0 p-0",slot:"tooltip-trigger"},s("ir-icons",{style:{"--icon-size":"0.875rem"},color:"#FB0AAD",name:"heart-fill"})))),s("span",{class:"p-0 m-0"},c,j.entries.Lcz_P),v(t.extras)&&s("span",{class:"yellow_dot"}))),s("div",{class:"d-flex align-items-center booking-label-gap"},s("p",{class:"p-0 m-0 secondary-p"},t.origin.Label),t.is_in_loyalty_mode&&!t.promo_key&&s("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512",height:18,width:18},s("title",null,j.entries.Lcz_LoyaltyDiscountApplied),s("path",{fill:"#fc6c85",d:"M225.8 468.2l-2.5-2.3L48.1 303.2C17.4 274.7 0 234.7 0 192.8v-3.3c0-70.4 50-130.8 119.2-144C158.6 37.9 198.9 47 231 69.6c9 6.4 17.4 13.8 25 22.3c4.2-4.8 8.7-9.2 13.5-13.3c3.7-3.2 7.5-6.2 11.5-9c0 0 0 0 0 0C313.1 47 353.4 37.9 392.8 45.4C462 58.6 512 119.1 512 189.5v3.3c0 41.9-17.4 81.9-48.1 110.4L288.7 465.9l-2.5 2.3c-8.2 7.6-19 11.9-30.2 11.9s-22-4.2-30.2-11.9zM239.1 145c-.4-.3-.7-.7-1-1.1l-17.8-20c0 0-.1-.1-.1-.1c0 0 0 0 0 0c-23.1-25.9-58-37.7-92-31.2C81.6 101.5 48 142.1 48 189.5v3.3c0 28.5 11.9 55.8 32.8 75.2L256 430.7 431.2 268c20.9-19.4 32.8-46.7 32.8-75.2v-3.3c0-47.3-33.6-88-80.1-96.9c-34-6.5-69 5.4-92 31.2c0 0 0 0-.1 .1s0 0-.1 .1l-17.8 20c-.3 .4-.7 .7-1 1.1c-4.5 4.5-10.6 7-16.9 7s-12.4-2.5-16.9-7z"})),t.promo_key&&s("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",height:18,width:18},s("title",null,j.entries.Lcz_Coupon+":"+t.promo_key),s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M16.5 6v.75m0 3v.75m0 3v.75m0 3V18m-9-5.25h5.25M7.5 15h3M3.375 5.25c-.621 0-1.125.504-1.125 1.125v3.026a2.999 2.999 0 0 1 0 5.198v3.026c0 .621.504 1.125 1.125 1.125h17.25c.621 0 1.125-.504 1.125-1.125v-3.026a2.999 2.999 0 0 1 0-5.198V6.375c0-.621-.504-1.125-1.125-1.125H3.375Z"})))))),s("td",null,s("ul",null,t.rooms.map((t=>{var i,e,n,o,r,h,a;return s("li",null,s("div",{class:"room-service"},s("p",{class:"m-0 p-0"},t.roomtype.name),t.unit&&!T(t.roomtype.id)&&(((e=(i=t.unit)===null||i===void 0?void 0:i.name)===null||e===void 0?void 0:e.length)>4?s("ir-tooltip",{customSlot:true,message:(n=t.unit)===null||n===void 0?void 0:n.name},s("p",{class:"room-name-container cursor-pointer m-0",slot:"tooltip-trigger"},(r=(o=t.unit)===null||o===void 0?void 0:o.name)===null||r===void 0?void 0:r.substring(0,4))):s("p",{class:"room-name-container  m-0"},(a=(h=t.unit)===null||h===void 0?void 0:h.name)===null||a===void 0?void 0:a.substring(0,4)))))})),t.extra_services&&s("li",null,j.entries.Lcz_ExtraServices))),s("td",null,s("p",{class:"p-0 m-0 date-p"},M(t.from_date,"YYYY-MM-DD").format("DD-MMM-YYYY")),s("p",{class:"p-0 m-0 date-p"},M(t.to_date,"YYYY-MM-DD").format("DD-MMM-YYYY"))),s("td",null,s("p",{class:"p-0 m-0",style:{whiteSpace:"nowrap"}},C(t.currency.symbol,(o=(n=t.financial)===null||n===void 0?void 0:n.gross_total)!==null&&o!==void 0?o:0)),t.financial.due_amount!==0&&s("button",{onClick:()=>{this.editBookingItem={booking:t,cause:"payment"};this.openModal()},style:{whiteSpace:"nowrap"},class:"btn p-0 m-0 due-btn"},t.status.code==="003"?t.financial.cancelation_penality_as_if_today!==0&&s(e,null,s("span",null,t.financial.cancelation_penality_as_if_today<0?"Refund":"Charge"," "),C(t.currency.symbol,Math.abs(t.financial.cancelation_penality_as_if_today))):C(t.currency.symbol,t.financial.due_amount))),this.showCost&&s("td",null,t.financial.gross_cost!==null&&t.financial.gross_cost===0?"_":C(t.currency.symbol,t.financial.gross_cost)),s("td",null,s("p",{class:`m-0 badge ${a} ct_ir_badge`},t.is_requested_to_cancel?(r=j===null||j===void 0?void 0:j.entries)===null||r===void 0?void 0:r.Lcz_CancellationRequested:t.status.description),!l&&((h=t.events)===null||h===void 0?void 0:h.length)>0&&t.events[0].type.toLowerCase()==="modified"&&s("p",{class:"mx-0 p-0 small",style:{marginTop:"0.25rem",marginBottom:"0"}},"Modified"),l&&s("ir-popover",{trigger:"hover",content:`Modified by ${l.user} at ${l.date} ${l.hour}:${l.minute}`},s("p",{class:"mx-0 p-0 small text-danger",style:{marginTop:"0.25rem",marginBottom:"0"}},s("b",null,"Modified")))),s("td",null,s("div",{class:"d-flex justify-content-center align-items-center",style:{gap:"8px"}},s("ir-button",{title:"Edit booking",variant:"icon",icon_name:"edit",onClickHandler:()=>this.editBookingItem={booking:t,cause:"edit"}}),s("ir-button",{title:"Delete booking",style:{"--icon-button-color":"#ff4961","--icon-button-hover-color":"#FF1635"},variant:"icon",icon_name:"trash",onClickHandler:()=>{this.editBookingItem={booking:t,cause:"delete"};this.openModal()}}))))})))),this.totalPages>1&&s("section",{class:"d-flex flex-column flex-md-row align-items-center justify-content-between pagination-container"},s("p",{class:"m-0 mb-1 mb-md-0"},this.renderItemRange()),s("div",{class:"d-flex align-items-center buttons-container"},s("ir-button",{size:"sm",btn_disabled:this.currentPage===1,onClickHandler:async()=>{this.currentPage=1;await this.updateData()},icon_name:"angles_left",style:{"--icon-size":"0.875rem"}}),s("ir-button",{size:"sm",btn_disabled:this.currentPage===1,onClickHandler:async()=>{this.currentPage=this.currentPage-1;await this.updateData()},icon_name:"angle_left",style:{"--icon-size":"0.875rem"}}),s("ir-select",{selectedValue:this.currentPage.toString(),showFirstOption:false,onSelectChange:async t=>{this.currentPage=+t.detail;await this.updateData()},data:Array.from(Array(this.totalPages),((t,i)=>i+1)).map((t=>({text:t.toString(),value:t.toString()})))}),s("ir-button",{size:"sm",btn_disabled:this.currentPage===this.totalPages,onClickHandler:async()=>{this.currentPage=this.currentPage+1;await this.updateData()},icon_name:"angle_right",style:{"--icon-size":"0.875rem"}}),s("ir-button",{size:"sm",btn_disabled:this.currentPage===this.totalPages,onClickHandler:async()=>{this.currentPage=this.totalPages;console.log(this.currentPage);await this.updateData()},icon_name:"angles_right",style:{"--icon-size":"0.875rem"}})))))),this.editBookingItem&&s("ir-listing-modal",{paymentEntries:this.paymentEntries,onModalClosed:()=>this.editBookingItem=null}),s("ir-sidebar",{onIrSidebarToggle:this.handleSideBarToggle.bind(this),open:this.editBookingItem!==null&&["edit","guest"].includes(this.editBookingItem.cause),showCloseButton:false,sidebarStyles:((b=this.editBookingItem)===null||b===void 0?void 0:b.cause)==="guest"?{background:"white"}:{width:this.editBookingItem?"80rem":"var(--sidebar-width,40rem)",background:"#F2F3F8"}},((m=this.editBookingItem)===null||m===void 0?void 0:m.cause)==="edit"&&s("ir-booking-details",{slot:"sidebar-body",p:this.p,hasPrint:true,hasReceipt:true,is_from_front_desk:true,propertyid:this.propertyid,hasRoomEdit:true,hasRoomDelete:true,hasCloseButton:true,onCloseSidebar:()=>this.editBookingItem=null,bookingNumber:this.editBookingItem.booking.booking_nbr,ticket:this.ticket,language:this.language,hasRoomAdd:true}),((y=this.editBookingItem)===null||y===void 0?void 0:y.cause)==="guest"&&s("ir-guest-info",{slot:"sidebar-body",isInSideBar:true,headerShown:true,booking_nbr:(w=(_=this.editBookingItem)===null||_===void 0?void 0:_.booking)===null||w===void 0?void 0:w.booking_nbr,email:(O=(k=this.editBookingItem)===null||k===void 0?void 0:k.booking)===null||O===void 0?void 0:O.guest.email,language:this.language,onCloseSideBar:()=>this.editBookingItem=null})))}get el(){return o(this)}static get watchers(){return{ticket:["ticketChanged"]}}};es.style=ss;class ns{async getExposedProperty(t){var i,s;try{const{data:e}=await F.post(`/Get_Exposed_Property`,t);if(e.ExceptionMsg!==""){throw new Error(e.ExceptionMsg)}const n=e.My_Result;S.adultChildConstraints=n.adult_child_constraints;S.allowedBookingSources=n.allowed_booking_sources;S.allowed_payment_methods=n.allowed_payment_methods;S.currency=n.currency;S.is_vacation_rental=n.is_vacation_rental;S.pickup_service=n.pickup_service;S.max_nights=n.max_nights;S.roomsInfo=n.roomtypes;S.taxes=n.taxes;S.id=n.id;S.country=n.country;S.name=n.name;S.is_automatic_check_in_out=n.is_automatic_check_in_out;S.tax_statement=n.tax_statement;S.is_frontdesk_enabled=n.is_frontdesk_enabled;S.is_pms_enabled=n.is_pms_enabled;const o=(s=(i=n===null||n===void 0?void 0:n.time_constraints)===null||i===void 0?void 0:i.check_out_till)===null||s===void 0?void 0:s.split(":");S.checkin_checkout_hours={offset:n.city.gmt_offset,hour:Number(o[0]||0),minute:Number(o[1]||0)};return e}catch(t){console.log(t);throw new Error(t)}}async getCountrySales(t){const{data:i}=await F.post("/Get_Country_Sales",t);if(i.ExceptionMsg!==""){throw new Error(i.ExceptionMsg)}if(t.is_export_to_excel){x(i.My_Params_Get_Country_Sales.Link_excel)}return i.My_Result}async getDailyRevenueReport(t){const{data:i}=await F.post("/Get_Daily_Revenue_Report",t);if(i.ExceptionMsg!==""){throw new Error(i.ExceptionMsg)}if(t.is_export_to_excel){x(i.My_Params_Get_Daily_Revenue_Report.Link_excel)}return i.My_Result}async setExposedCleaningFrequency(t){const{data:i}=await F.post("/Set_Exposed_Cleaning_Frequency",t);if(i.ExceptionMsg!==""){throw new Error(i.ExceptionMsg)}return i.My_Result}async getMonthlyStats(t){const{data:i}=await F.post("/Get_Monthly_Stats",t);if(i.ExceptionMsg!==""){throw new Error(i.ExceptionMsg)}if(t.is_export_to_excel){x(i.My_Params_Get_Monthly_Stats.Link_excel)}return i.My_Result}}const os=".sc-ir-daily-revenue-h{display:block}.daily-revenue__meta.sc-ir-daily-revenue{display:flex;flex-direction:column;gap:1rem}.daily-revenue__table.sc-ir-daily-revenue{flex:1 1 0%}@media (min-width: 768px){.daily-revenue__meta.sc-ir-daily-revenue{flex-direction:row}}";const rs=os;const hs=class{constructor(s){t(this,s);this.preventPageLoad=i(this,"preventPageLoad",7);this.language="";this.ticket="";this.filters={date:M().format("YYYY-MM-DD"),users:null};this.tokenService=new P;this.roomService=new r;this.propertyService=new ns;this.bookingService=new h;this.handleSidebarClose=t=>{t.stopImmediatePropagation();t.stopPropagation();this.sideBarEvent=null}}componentWillLoad(){if(this.ticket){this.tokenService.setToken(this.ticket);this.initializeApp()}}ticketChanged(t,i){if(t===i){return}this.tokenService.setToken(this.ticket);this.initializeApp()}handleOpenSidebar(t){t.stopImmediatePropagation();t.stopPropagation();this.sideBarEvent=t.detail}handleFetchNewReports(t){t.stopImmediatePropagation();t.stopPropagation();this.filters=Object.assign({},t.detail);this.getPaymentReports()}async handleResetBooking(t){t.stopPropagation();t.stopImmediatePropagation();this.getPaymentReports(false,true)}renderSidebarBody(){if(!this.sideBarEvent){return}switch(this.sideBarEvent.type){case"booking":return s("ir-booking-details",{slot:"sidebar-body",hasPrint:true,hasReceipt:true,hasCloseButton:true,onCloseSidebar:this.handleSidebarClose,is_from_front_desk:true,propertyid:this.property_id,hasRoomEdit:true,hasRoomDelete:true,bookingNumber:this.sideBarEvent.payload.bookingNumber.toString(),ticket:this.ticket,language:this.language,hasRoomAdd:true});default:return null}}async initializeApp(){this.isPageLoading=true;try{let t=this.propertyid;if(!t&&!this.p){throw new Error("Property ID or username is required")}if(!t){const i=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});t=i.My_Result.id}this.property_id=t;const i=[this.bookingService.getSetupEntriesByTableNameMulti(["_PAY_TYPE","_PAY_TYPE_GROUP","_PAY_METHOD"]),this.getPaymentReports(),this.roomService.fetchLanguage(this.language)];if(t){i.push(this.roomService.getExposedProperty({id:t,language:this.language,is_backend:true,include_units_hk_status:true}))}const[s]=await Promise.all(i);const{pay_type:e,pay_type_group:n,pay_method:o}=this.bookingService.groupEntryTablesResult(s);this.paymentEntries={groups:n,methods:o,types:e}}catch(t){console.log(t)}finally{this.isPageLoading=false}}groupPaymentsByName(t){var i;const s=new Map;for(const e of t){const t=`${e.payTypeCode}_${e.payMethodCode}`;const n=(i=s.get(t))!==null&&i!==void 0?i:[];s.set(t,[...n,e])}return new Map([...s.entries()].sort((([t],[i])=>{const s=Number(t);const e=Number(i);if(!isNaN(s)&&!isNaN(e)){return s-e}return t.localeCompare(i)})))}async getPaymentReports(t=false,i=false){var s,e,n,o;try{const r=t=>({method:t.METHOD,payTypeCode:t.PAY_TYPE_CODE,payMethodCode:t.PAY_METHOD_CODE,amount:t.AMOUNT,date:t.DATE,hour:t.HOUR,minute:t.MINUTE,user:t.USER,currency:t.CURRENCY,bookingNbr:t.BOOKING_NBR,id:I()});this.isLoading=t?"export":"filter";const h=[this.propertyService.getDailyRevenueReport({date:this.filters.date,property_id:(s=this.property_id)===null||s===void 0?void 0:s.toString(),is_export_to_excel:t})];if(!t&&!i){h.push(this.propertyService.getDailyRevenueReport({date:M(this.filters.date,"YYYY-MM-DD").add(-1,"days").format("YYYY-MM-DD"),property_id:(e=this.property_id)===null||e===void 0?void 0:e.toString(),is_export_to_excel:t}))}const a=await Promise.all(h);if(!t){if(a[0]){this.groupedPayment=this.groupPaymentsByName((n=a[0])===null||n===void 0?void 0:n.map(r))}else{this.groupedPayment=new Map}if(a[1])this.previousDateGroupedPayments=this.groupPaymentsByName((o=a[1])===null||o===void 0?void 0:o.map(r))}}catch(t){console.log(t)}finally{this.isLoading=null}}render(){var t,i,e;if(this.isPageLoading){return s("ir-loading-screen",null)}return s(n,null,s("ir-toast",null),s("ir-interceptor",null),s("section",{class:"p-2 d-flex flex-column",style:{gap:"1rem"}},s("div",{class:"d-flex align-items-center justify-content-between"},s("h3",{class:"mb-1 mb-md-0"},"Daily Revenue"),s("ir-button",{size:"sm",btn_color:"outline",isLoading:this.isLoading==="export",text:(t=j.entries)===null||t===void 0?void 0:t.Lcz_Export,onClickHandler:async t=>{t.stopImmediatePropagation();t.stopPropagation();await this.getPaymentReports(true)},btnStyle:{height:"100%"},iconPosition:"right",icon_name:"file",icon_style:{"--icon-size":"14px"}})),s("ir-revenue-summary",{previousDateGroupedPayments:this.previousDateGroupedPayments,groupedPayments:this.groupedPayment,paymentEntries:this.paymentEntries}),s("div",{class:"daily-revenue__meta"},s("ir-daily-revenue-filters",{isLoading:this.isLoading==="filter",payments:this.groupedPayment}),s("ir-revenue-table",{filters:this.filters,class:"daily-revenue__table",paymentEntries:this.paymentEntries,payments:this.groupedPayment}))),s("ir-sidebar",{sidebarStyles:{width:((i=this.sideBarEvent)===null||i===void 0?void 0:i.type)==="booking"?"80rem":"var(--sidebar-width,40rem)",background:((e=this.sideBarEvent)===null||e===void 0?void 0:e.type)==="booking"?"#F2F3F8":"white"},open:Boolean(this.sideBarEvent),showCloseButton:false,onIrSidebarToggle:this.handleSidebarClose},this.renderSidebarBody()))}static get watchers(){return{ticket:["ticketChanged"]}}};hs.style=rs;const as=".sc-ir-hk-tasks-h{display:block;box-sizing:border-box}.sc-ir-hk-tasks-h *.sc-ir-hk-tasks{box-sizing:border-box}.tasks-view.sc-ir-hk-tasks{display:flex;flex-direction:column}@media (min-width: 1024px){.tasks-view.sc-ir-hk-tasks{flex-direction:row}}";const ls=as;const cs=class{constructor(s){t(this,s);this.clearSelectedHkTasks=i(this,"clearSelectedHkTasks",7);this.language="";this.ticket="";this.isLoading=false;this.isCleaningLoading=false;this.selectedDuration="";this.selectedHouseKeeper="0";this.selectedRoom=null;this.archiveOpened=false;this.hkNameCache={};this.roomService=new r;this.houseKeepingService=new L;this.token=new P;this.table_sorting=new Map}componentWillLoad(){if(this.baseUrl){this.token.setBaseUrl(this.baseUrl)}if(this.ticket!==""){this.token.setToken(this.ticket);this.init()}}ticketChanged(t,i){if(t===i){return}this.token.setToken(this.ticket);this.init()}handleCloseSidebar(t){t.stopImmediatePropagation();t.stopPropagation();this.isSidebarOpen=false}handleSortingChanged(t){t.stopImmediatePropagation();t.stopPropagation();const{field:i,direction:s}=t.detail;console.log(t.detail);if(i==="date"){return}this.table_sorting.set(i,s)}handleSkipSelectedTask(t){var i;t.stopImmediatePropagation();t.stopPropagation();this.modalCauses={task:t.detail,cause:"skip"};(i=this.modal)===null||i===void 0?void 0:i.openModal()}async init(){var t,i,s,e,n,o,r;try{this.isLoading=true;W(true);let h=this.propertyid;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}if(!h){console.log(h);const t=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});h=t.My_Result.id}this.property_id=h;const a=[this.houseKeepingService.getExposedHKSetup(this.property_id),this.roomService.fetchLanguage(this.language)];if(this.propertyid){a.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true,include_units_hk_status:true}))}await Promise.all(a);const l=await this.houseKeepingService.getHkTasks({property_id:this.property_id,from_date:M().format("YYYY-MM-DD"),to_date:M().format("YYYY-MM-DD"),housekeepers:[],cleaning_frequency:(s=(t=S.cleaning_frequency)!==null&&t!==void 0?t:(i=U===null||U===void 0?void 0:U.hk_criteria)===null||i===void 0?void 0:i.cleaning_frequencies[0])===null||s===void 0?void 0:s.code,dusty_window:(n=(e=U===null||U===void 0?void 0:U.hk_criteria)===null||e===void 0?void 0:e.dusty_periods[0])===null||n===void 0?void 0:n.code,highlight_window:(r=(o=U===null||U===void 0?void 0:U.hk_criteria)===null||o===void 0?void 0:o.highlight_checkin_options[0])===null||r===void 0?void 0:r.code});if(l===null||l===void 0?void 0:l.tasks){this.updateTasks(l.tasks)}}catch(t){console.log(t)}finally{this.isLoading=false;W(false)}}buildHousekeeperNameCache(){var t,i;this.hkNameCache={};(i=(t=U.hk_criteria)===null||t===void 0?void 0:t.housekeepers)===null||i===void 0?void 0:i.forEach((t=>{if(t.id!=null&&t.name!=null){this.hkNameCache[t.id]=t.name}}))}updateTasks(t){this.buildHousekeeperNameCache();J(t.map((t=>Object.assign(Object.assign({},t),{id:I(),housekeeper:(()=>{var i,s,e;const n=this.hkNameCache[t.hkm_id];if(n){return n}const o=(e=(s=(i=U.hk_criteria)===null||i===void 0?void 0:i.housekeepers)===null||s===void 0?void 0:s.find((i=>i.id===t.hkm_id)))===null||e===void 0?void 0:e.name;this.hkNameCache[t.hkm_id]=o;return o})()}))))}async handleHeaderButtonPress(t){var i;t.stopImmediatePropagation();t.stopPropagation();const{name:s}=t.detail;switch(s){case"cleaned":case"clean-inspect":(i=this.modal)===null||i===void 0?void 0:i.openModal();this.modalCauses={task:null,cause:"clean",status:s==="clean-inspect"?"004":"001"};break;case"export":const t=Array.from(this.table_sorting.entries()).map((([t,i])=>({key:t,value:i})));console.log(t);const{url:e}=await this.fetchTasksWithFilters(true);x(e);break;case"archive":this.isSidebarOpen=true;break}}handleSelectedTaskCleaningEvent(t){var i;t.stopImmediatePropagation();t.stopPropagation();this.modalCauses=Object.assign(Object.assign({},t.detail),{cause:"clean"});(i=this.modal)===null||i===void 0?void 0:i.openModal()}async handleModalConfirmation(t){var i;try{t.stopImmediatePropagation();t.stopPropagation();if(X.selectedTasks.length===0){return}this.isCleaningLoading=true;if(((i=this.modalCauses)===null||i===void 0?void 0:i.cause)==="skip"){const{booking_nbr:t,date:i,unit:s}=this.modalCauses.task;await this.houseKeepingService.editHkSkip({BOOK_NBR:t,DATE:i,COMMENT:"",HK_SKIP_ID:-1,HK_SKIP_REASON_CODE:"001",PR_ID:s.id})}else{await this.houseKeepingService.executeHKAction({actions:X.selectedTasks.map((t=>{var i,s;return{description:"Cleaned",hkm_id:t.hkm_id===0?null:t.hkm_id,unit_id:t.unit.id,booking_nbr:t.booking_nbr,status:(s=(i=this.modalCauses)===null||i===void 0?void 0:i.status)!==null&&s!==void 0?s:"001"}}))})}await this.fetchTasksWithFilters()}finally{Q();if(this.modalCauses){this.modalCauses=null}this.isCleaningLoading=false;this.modal.closeModal()}}async applyFilters(t){try{this.isApplyFiltersLoading=true;t.stopImmediatePropagation();t.stopPropagation();this.filters=Object.assign({},t.detail);await this.fetchTasksWithFilters()}catch(t){console.log(t)}finally{this.isApplyFiltersLoading=false}}async fetchTasksWithFilters(t=false){var i;const{cleaning_periods:s,housekeepers:e,cleaning_frequencies:n,dusty_units:o,highlight_check_ins:r}=(i=this.filters)!==null&&i!==void 0?i:{};const{tasks:h,url:a}=await this.houseKeepingService.getHkTasks({housekeepers:e,cleaning_frequency:n===null||n===void 0?void 0:n.code,dusty_window:o===null||o===void 0?void 0:o.code,highlight_window:r===null||r===void 0?void 0:r.code,property_id:this.property_id,from_date:M().format("YYYY-MM-DD"),to_date:(s===null||s===void 0?void 0:s.code)||M().format("YYYY-MM-DD"),is_export_to_excel:t});console.log(h);if(h){this.updateTasks(h)}return{tasks:h,url:a}}render(){var t,i,e,o;if(this.isLoading){return s("ir-loading-screen",null)}return s(n,{"data-testid":"hk_tasks_base"},s("ir-toast",null),s("ir-interceptor",null),s("section",{class:"p-1 d-flex flex-column",style:{gap:"1rem"}},s("h3",null,"Housekeeping Tasks"),s("div",{class:"tasks-view ",style:{gap:"1rem"}},s("ir-tasks-filters",{isLoading:this.isApplyFiltersLoading,onApplyFilters:t=>{this.applyFilters(t)}}),s("div",{class:"d-flex w-100 flex-column",style:{gap:"1rem"}},s("ir-tasks-table",{onRowSelectChange:t=>{t.stopImmediatePropagation();t.stopPropagation();Z(t.detail)},class:"flex-grow-1 w-100"})))),s("ir-modal",{autoClose:false,ref:t=>this.modal=t,isLoading:this.isCleaningLoading,onConfirmModal:this.handleModalConfirmation.bind(this),onCancelModal:()=>{if(this.modalCauses){Q();this.modalCauses=null}},iconAvailable:true,icon:"ft-alert-triangle danger h1",leftBtnText:j.entries.Lcz_Cancel,rightBtnText:j.entries.Lcz_Confirm,leftBtnColor:"secondary",rightBtnColor:"primary",modalTitle:j.entries.Lcz_Confirmation,modalBody:this.modalCauses?((t=this.modalCauses)===null||t===void 0?void 0:t.cause)==="clean"?this.modalCauses.task?`Update ${(o=(e=(i=this.modalCauses)===null||i===void 0?void 0:i.task)===null||e===void 0?void 0:e.unit)===null||o===void 0?void 0:o.name} to Clean`:"Update selected unit(s) to Clean":"Skip cleaning and reschedule for tomorrow.":"Update selected unit(s) to Clean"}),s("ir-sidebar",{open:this.isSidebarOpen,id:"editGuestInfo",onIrSidebarToggle:t=>{t.stopImmediatePropagation();t.stopPropagation();this.isSidebarOpen=false},showCloseButton:false},this.isSidebarOpen&&s("ir-hk-archive",{ticket:this.token.getToken(),propertyId:this.property_id,slot:"sidebar-body"})))}get el(){return o(this)}static get watchers(){return{ticket:["ticketChanged"]}}};cs.style=ls;const ds=".sc-ir-housekeeping-h{display:block}";const us=ds;const fs=class{constructor(s){t(this,s);this.toast=i(this,"toast",7);this.language="";this.ticket="";this.isLoading=false;this.roomService=new r;this.houseKeepingService=new L;this.propertyService=new ns;this.token=new P}componentWillLoad(){if(this.baseUrl){this.token.setBaseUrl(this.baseUrl)}if(this.ticket!==""){this.token.setToken(this.ticket);this.initializeApp()}}async handleResetData(t){t.stopImmediatePropagation();t.stopPropagation();await this.houseKeepingService.getExposedHKSetup(this.propertyid)}ticketChanged(t,i){if(t===i){return}this.token.setToken(this.ticket);this.initializeApp()}async initializeApp(){var t;try{this.isLoading=true;let i=this.propertyid;if(!i){const t=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_sales_rate_plans:true});i=t.My_Result.id}H("default_properties",{token:this.ticket,property_id:i,language:this.language});const s=[];if(S.housekeeping_enabled){s.push(this.houseKeepingService.getExposedHKSetup(i))}s.push(this.roomService.fetchLanguage(this.language,["_HK_FRONT","_PMS_FRONT"]));if(this.propertyid){s.push(this.roomService.getExposedProperty({id:i,language:this.language,is_backend:true,include_sales_rate_plans:true}))}await Promise.all(s);this.selectedCleaningFrequency=(t=S.cleaning_frequency)===null||t===void 0?void 0:t.code}catch(t){console.error(t)}finally{this.isLoading=false}}async saveAutomaticCheckInCheckout(t){t.stopImmediatePropagation();t.stopPropagation();try{await this.roomService.SetAutomaticCheckInOut({property_id:U.default_properties.property_id,flag:t.detail==="auto"});this.toast.emit({position:"top-right",title:"Saved Successfully",description:"",type:"success"})}catch(t){console.log(t)}}async saveCleaningFrequency(t){t.stopImmediatePropagation();t.stopPropagation();try{await this.propertyService.setExposedCleaningFrequency({property_id:U.default_properties.property_id,code:this.selectedCleaningFrequency});S.cleaning_frequency={code:this.selectedCleaningFrequency,description:""};this.toast.emit({position:"top-right",title:"Saved Successfully",description:"",type:"success"});this.modal.closeModal()}catch(t){console.log(t)}}render(){var t;if(this.isLoading){return s("ir-loading-screen",null)}console.log(S.cleaning_frequency);return s(n,null,s("ir-interceptor",null),s("ir-toast",null),s("section",{class:"p-1"},s("h3",{class:"mb-2"},j.entries.Lcz_HouseKeepingAndCheckInSetup),s("div",{class:"card p-1"},s("ir-title",{borderShown:true,label:"Operations Settings"}),s("div",{class:"d-flex align-items-center mb-1"},s("p",{class:"my-0 py-0 mr-1"},j.entries.Lcz_CheckInOutGuestsAutomatically),s("ir-select",{showFirstOption:false,selectedValue:S.is_automatic_check_in_out?"auto":"manual",onSelectChange:t=>this.saveAutomaticCheckInCheckout(t),data:[{text:j.entries.Lcz_YesAsPerPropertyPolicy,value:"auto"},{text:j.entries.Lcz_NoIWillDoItManually,value:"manual"}]})),s("div",{class:"d-flex align-items-center"},s("p",{class:"my-0 py-0 mr-1"},j.entries.Lcz_CleaningFrequency,":"),s("ir-select",{showFirstOption:false,selectedValue:this.selectedCleaningFrequency,onSelectChange:t=>{t.stopImmediatePropagation();t.stopPropagation();this.selectedCleaningFrequency=t.detail;this.modal.openModal()},data:(t=U===null||U===void 0?void 0:U.hk_criteria)===null||t===void 0?void 0:t.cleaning_frequencies.map((t=>({text:t.description,value:t.code})))}))),S.housekeeping_enabled&&s("ir-hk-team",{class:"mb-1"}),s("ir-modal",{autoClose:false,ref:t=>this.modal=t,isLoading:tt("/Set_Exposed_Cleaning_Frequency"),onConfirmModal:this.saveCleaningFrequency.bind(this),iconAvailable:true,onCancelModal:()=>{var t;this.selectedCleaningFrequency=(t=S.cleaning_frequency)===null||t===void 0?void 0:t.code},icon:"ft-alert-triangle danger h1",leftBtnText:j.entries.Lcz_Cancel,rightBtnText:j.entries.Lcz_Confirm,leftBtnColor:"secondary",rightBtnColor:"primary",modalTitle:j.entries.Lcz_Confirmation,modalBody:"This action will reschedule all cleaning tasks. Do you want to continue?"})))}static get watchers(){return{ticket:["ticketChanged"]}}};fs.style=us;const ps=".sc-ir-monthly-bookings-report-h{display:block}";const gs=ps;var bs=undefined&&undefined.__rest||function(t,i){var s={};for(var e in t)if(Object.prototype.hasOwnProperty.call(t,e)&&i.indexOf(e)<0)s[e]=t[e];if(t!=null&&typeof Object.getOwnPropertySymbols==="function")for(var n=0,e=Object.getOwnPropertySymbols(t);n<e.length;n++){if(i.indexOf(e[n])<0&&Object.prototype.propertyIsEnumerable.call(t,e[n]))s[e[n]]=t[e[n]]}return s};const ms=class{constructor(i){t(this,i);this.language="";this.ticket="";this.isPageLoading=true;this.isLoading=null;this.reports=[];this.tokenService=new P;this.roomService=new r;this.propertyService=new ns}componentWillLoad(){this.baseFilters={date:{description:M().format("MMMM YYYY"),firstOfMonth:M().startOf("month").format("YYYY-MM-DD"),lastOfMonth:M().endOf("month").format("YYYY-MM-DD")},include_previous_year:false};this.filters=this.baseFilters;if(this.ticket){this.tokenService.setToken(this.ticket);this.init()}}handleTicketChange(t,i){if(t!==i){this.tokenService.setToken(this.ticket);this.init()}}handleApplyFiltersChange(t){t.stopImmediatePropagation();t.stopPropagation();this.filters=t.detail;this.getReports()}async init(){try{let t=this.propertyid;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}if(!t){console.log(t);const i=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});t=i.My_Result.id}this.property_id=t;const i=[this.roomService.fetchLanguage(this.language),this.getReports()];if(this.propertyid){i.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true,include_units_hk_status:true}))}await Promise.all(i)}catch(t){console.log(t)}finally{this.isPageLoading=false}}async getReports(t=false){try{const i=t=>({day:t.Date,units_booked:t.Units_booked,occupancy_percent:t.Occupancy,adr:t.ADR,rooms_revenue:t.Rooms_Revenue,total_guests:t===null||t===void 0?void 0:t.Total_Guests});this.isLoading=t?"export":"filter";const{date:s,include_previous_year:e}=this.filters;const n=[this.propertyService.getMonthlyStats({from_date:s.firstOfMonth,to_date:s.lastOfMonth,property_id:this.property_id,is_export_to_excel:t})];if(e){n.push(this.propertyService.getMonthlyStats({from_date:M(s.firstOfMonth,"YYYY-MM-DD").add(-1,"year").format("YYYY-MM-DD"),to_date:M(s.lastOfMonth,"YYYY-MM-DD").add(-1,"years").format("YYYY-MM-DD"),property_id:this.property_id}))}const o=await Promise.all(n);const r=o[0];let h=[];const{DailyStats:a}=r,l=bs(r,["DailyStats"]);this.stats=Object.assign({},l);if(e&&o[t?0:1]){const s=o[t?0:1];let e=s.DailyStats.map(i);h=a.map(i).map((t=>{const i=e.find((i=>i.day===M(t.day,"YYYY-MM-DD").add(-1,"years").format("YYYY-MM-DD")));return Object.assign(Object.assign({},t),{last_year:i!==null&&i!==void 0?i:null})}))}else{h=a.map(i)}this.reports=[...h]}catch(t){console.log(t)}finally{this.isLoading=null}}render(){var t,i,e,o,r,h,a,l,c,d,u,f,p;if(this.isPageLoading){return s("ir-loading-screen",null)}return s(n,null,s("ir-toast",null),s("ir-interceptor",null),s("section",{class:"p-2 d-flex flex-column",style:{gap:"1rem"}},s("div",{class:"d-flex align-items-center justify-content-between"},s("h3",{class:"mb-1 mb-md-0"},"Daily Occupancy"),s("ir-button",{size:"sm",btn_color:"outline",isLoading:this.isLoading==="export",text:(t=j.entries)===null||t===void 0?void 0:t.Lcz_Export,onClickHandler:async t=>{t.stopImmediatePropagation();t.stopPropagation();await this.getReports(true)},btnStyle:{height:"100%"},iconPosition:"right",icon_name:"file",icon_style:{"--icon-size":"14px"}})),s("section",null,s("div",{class:"d-flex flex-column flex-md-row w-100",style:{gap:"1rem",alignItems:"stretch"}},s("ir-stats-card",{icon:((i=this.stats)===null||i===void 0?void 0:i.Occupancy_Difference_From_Previous_Month)<0?"arrow-trend-down":"arrow-trend-up",cardTitle:"Average Occupancy",value:this.stats.AverageOccupancy?((e=this.stats)===null||e===void 0?void 0:e.AverageOccupancy.toFixed(2))+"%":null,subtitle:`${((o=this.stats)===null||o===void 0?void 0:o.Occupancy_Difference_From_Previous_Month)<0?"":"+"}${(r=this.stats)===null||r===void 0?void 0:r.Occupancy_Difference_From_Previous_Month.toFixed(2)}% from last month`}),s("ir-stats-card",{icon:"hotel",cardTitle:"Total Units",value:((h=this.stats)===null||h===void 0?void 0:h.TotalUnitsBooked)?(a=this.stats)===null||a===void 0?void 0:a.TotalUnitsBooked.toString():null,subtitle:"Booked"}),s("ir-stats-card",{icon:"user_group",cardTitle:"Total Guests",value:(c=(l=this.stats)===null||l===void 0?void 0:l.Total_Guests)===null||c===void 0?void 0:c.toString(),subtitle:"Stayed"}),s("ir-stats-card",{icon:"calendar",cardTitle:"Peak Days",value:((d=this.stats)===null||d===void 0?void 0:d.PeakDays.length)===0?null:(f=(u=this.stats)===null||u===void 0?void 0:u.PeakDays)===null||f===void 0?void 0:f.map((t=>M(t.Date,"YYYY-MM-DD").format("D").concat("th"))).join(" - "),subtitle:`${Math.max(...((p=this.stats.PeakDays)===null||p===void 0?void 0:p.map((t=>t.OccupancyPercent)))||[])}% occupancy`})),s("div",{class:"d-flex flex-column flex-lg-row mt-1 ",style:{gap:"1rem"}},s("ir-monthly-bookings-report-filter",{isLoading:this.isLoading==="filter",class:"filters-card",baseFilters:this.baseFilters}),s("ir-monthly-bookings-report-table",{reports:this.reports})))))}static get watchers(){return{ticket:["handleTicketChange"]}}};ms.style=gs;const ys=".sc-ir-sales-by-country-h{display:block}";const vs=ys;var _s=undefined&&undefined.__rest||function(t,i){var s={};for(var e in t)if(Object.prototype.hasOwnProperty.call(t,e)&&i.indexOf(e)<0)s[e]=t[e];if(t!=null&&typeof Object.getOwnPropertySymbols==="function")for(var n=0,e=Object.getOwnPropertySymbols(t);n<e.length;n++){if(i.indexOf(e[n])<0&&Object.prototype.propertyIsEnumerable.call(t,e[n]))s[e[n]]=t[e[n]]}return s};const ws=class{constructor(i){t(this,i);this.language="";this.ticket="";this.isLoading=null;this.isPageLoading=true;this.countries=new Map;this.token=new P;this.roomService=new r;this.propertyService=new ns;this.bookingService=new h;this.baseFilters={FROM_DATE:M().add(-7,"days").format("YYYY-MM-DD"),TO_DATE:M().format("YYYY-MM-DD"),BOOK_CASE:"001",WINDOW:7,include_previous_year:false}}componentWillLoad(){this.salesFilters=this.baseFilters;if(this.ticket){this.token.setToken(this.ticket);this.initializeApp()}}ticketChanged(t,i){if(t===i){return}this.token.setToken(this.ticket);this.initializeApp()}async initializeApp(){try{let t=this.propertyid;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}if(!t){console.log(t);const i=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});t=i.My_Result.id}this.property_id=t;const i=[this.bookingService.getCountries(this.language),this.roomService.fetchLanguage(this.language),this.getCountrySales()];if(this.propertyid){i.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true,include_units_hk_status:true}))}const[s]=await Promise.all(i);const e=new Map;s.map((t=>{e.set(t.id,{flag:t.flag,name:t.name})}));this.countries=e}catch(t){console.log(t)}finally{this.isPageLoading=false}}async getCountrySales(t=false){const i=t=>({country:t.COUNTRY,country_id:t.COUNTRY_ID,nights:t.NIGHTS,percentage:t.PCT,revenue:t.REVENUE,number_of_guests:t.Total_Guests});try{const s=this.salesFilters,{include_previous_year:e}=s,n=_s(s,["include_previous_year"]);this.isLoading=t?"export":"filter";const o=await this.propertyService.getCountrySales(Object.assign({AC_ID:this.property_id,is_export_to_excel:t},n));const r=!t&&e;let h=[];if(r){const t=await this.propertyService.getCountrySales(Object.assign(Object.assign({AC_ID:this.property_id,is_export_to_excel:false},n),{FROM_DATE:M(n.FROM_DATE).subtract(1,"year").format("YYYY-MM-DD"),TO_DATE:M(n.TO_DATE).subtract(1,"year").format("YYYY-MM-DD")}));h=o.map((s=>{const e=t.find((t=>t.COUNTRY.toLowerCase()===s.COUNTRY.toLowerCase()));return Object.assign(Object.assign({id:I()},i(s)),{last_year:e?i(e):null})}))}else{h=o.map((t=>Object.assign(Object.assign({id:I()},i(t)),{last_year:null})))}this.salesData=[...h]}catch(t){console.error("Failed to fetch sales data:",t)}finally{this.isLoading=null}}render(){if(this.isPageLoading){return s("ir-loading-screen",null)}return s(n,null,s("ir-toast",null),s("ir-interceptor",null),s("section",{class:"p-2 d-flex flex-column",style:{gap:"1rem"}},s("div",{class:"d-flex align-items-center justify-content-between"},s("h3",{class:"mb-1 mb-md-0"},"Sales by Country"),s("ir-button",{size:"sm",btn_color:"outline",isLoading:this.isLoading==="export",text:j.entries.Lcz_Export,onClickHandler:async t=>{t.stopImmediatePropagation();t.stopPropagation();await this.getCountrySales(true)},btnStyle:{height:"100%"},iconPosition:"right",icon_name:"file",icon_style:{"--icon-size":"14px"}})),s("ir-sales-by-country-summary",{salesReports:this.salesData}),s("div",{class:"d-flex flex-column flex-lg-row mt-1 ",style:{gap:"1rem"}},s("ir-sales-filters",{isLoading:this.isLoading==="filter",onApplyFilters:t=>{t.stopImmediatePropagation();t.stopPropagation();this.salesFilters=t.detail;this.getCountrySales()},class:"filters-card",baseFilters:this.baseFilters}),s("ir-sales-table",{mappedCountries:this.countries,class:"card mb-0",records:this.salesData}))))}static get watchers(){return{ticket:["ticketChanged"]}}};ws.style=vs;const ks=".sc-ir-user-management-h{display:block;height:100%}";const Os=ks;const Ds=class{constructor(i){t(this,i);this.language="";this.isSuperAdmin=true;this.isLoading=true;this.users=[];this.allowedUsersTypes=[];this.token=new P;this.roomService=new r;this.userService=new it;this.bookingService=new h;this.userTypes=new Map;this.superAdminId="5"}componentWillLoad(){if(this.baseUrl){this.token.setBaseUrl(this.baseUrl)}if(this.ticket){this.token.setToken(this.ticket);this.initializeApp()}}ticketChanged(t,i){if(t===i){return}this.token.setToken(this.ticket);this.initializeApp()}async handleResetData(t){t.stopImmediatePropagation();t.stopPropagation();await this.fetchUsers()}async initializeApp(){try{if(this.baseUrl){this.token.setBaseUrl(this.baseUrl)}this.isLoading=true;let t=this.propertyid;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}if(!t){console.log(t);const i=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});t=i.My_Result.id}this.property_id=t;const i=[this.fetchUserTypes(),this.fetchUsers(),this.roomService.fetchLanguage(this.language,["_USER_MGT"])];if(this.propertyid){i.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true,include_units_hk_status:true}))}await Promise.all(i);this.socket=Gi("https://realtime.igloorooms.com/");this.socket.on("MSG",(async t=>{await this.handleSocketMessage(t)}))}catch(t){console.log(t)}finally{this.isLoading=false}}async handleSocketMessage(t){const i=JSON.parse(t);if(!i){return}const{REASON:s,KEY:e,PAYLOAD:n}=i;if(e.toString()!==this.property_id.toString()){return}let o=JSON.parse(n);console.log(e,o);const r={EMAIL_VERIFIED:this.updateUserVerificationStatus};const h=r[s];if(h){await h.call(this,o)}else{console.warn(`Unhandled REASON: ${s}`)}}updateUserVerificationStatus(t){const i=[...this.users];const s=i.findIndex((i=>i.id===t.id));if(s===-1){console.warn(`User ${t.id} not found`);return}i[s]=Object.assign(Object.assign({},i[s]),{is_email_verified:true});this.users=i}async fetchUsers(){const t=await this.userService.getExposedPropertyUsers({property_id:this.propertyid});this.users=[...t].sort(((t,i)=>{const s=t=>{const i=t.type.toString();if(i===this.superAdminId)return 0;if(i==="17")return 1;return 2};const e=s(t),n=s(i);if(e!==n){return e-n}return t.username.localeCompare(i.username)}))}async fetchUserTypes(){var t,i,s,e;const n=await Promise.all([this.bookingService.getSetupEntriesByTableName("_USER_TYPE"),this.bookingService.getLov()]);const o=(i=(t=n[1])===null||t===void 0?void 0:t.My_Result)===null||i===void 0?void 0:i.allowed_user_types;for(const t of n[0]){const i=t[`CODE_VALUE_${(e=(s=this.language)===null||s===void 0?void 0:s.toUpperCase())!==null&&e!==void 0?e:"EN"}`];if(o.find((i=>i.code===t.CODE_NAME))){this.allowedUsersTypes.push({code:t.CODE_NAME,value:i})}this.userTypes.set(t.CODE_NAME.toString(),i)}}disconnectedCallback(){this.socket.disconnect()}render(){var t,i;if(this.isLoading){return s(n,null,s("ir-toast",null),s("ir-interceptor",null),s("ir-loading-screen",null))}return s(n,null,s("ir-toast",null),s("ir-interceptor",{suppressToastEndpoints:["/Change_User_Pwd","/Handle_Exposed_User"]}),s("section",{class:"p-2 d-flex flex-column",style:{gap:"1rem"}},s("div",{class:"d-flex  pb-2 align-items-center justify-content-between"},s("h3",{class:"mb-1 mb-md-0"},j.entries.Lcz_ExtranetUsers)),s("div",{class:"",style:{gap:"1rem"}},s("ir-user-management-table",{property_id:this.property_id,baseUserTypeCode:this.baseUserTypeCode,allowedUsersTypes:this.allowedUsersTypes,userTypeCode:this.userTypeCode,haveAdminPrivileges:[this.superAdminId,"17"].includes((t=this.userTypeCode)===null||t===void 0?void 0:t.toString()),userTypes:this.userTypes,class:"card",isSuperAdmin:((i=this.userTypeCode)===null||i===void 0?void 0:i.toString())===this.superAdminId,users:this.users}))))}static get watchers(){return{ticket:["ticketChanged"]}}};Ds.style=Os;export{Ji as igloo_calendar,Zi as ir_booking_email_logs,es as ir_booking_listing,hs as ir_daily_revenue,cs as ir_hk_tasks,fs as ir_housekeeping,ms as ir_monthly_bookings_report,ws as ir_sales_by_country,Ds as ir_user_management};
//# sourceMappingURL=p-efaf5b80.entry.js.map