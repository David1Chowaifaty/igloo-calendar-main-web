{"version":3,"names":["initialState","bookings","filteredBookings","paginatedBookings","needsCheckOutBookings","futureRooms","outBookings","searchTerm","pagination","page","pageSize","total","totalPages","currentPage","showing","from","to","today","getTodayString","state","departuresStore","onChange","onDeparturesStoreChange","createStore","initializeDeparturesStore","Array","isArray","runDeparturesPipeline","setDepartureTotal","normalizedTotal","Number","isFinite","Math","floor","calculateTotalPages","safePage","clampPage","max","calculateShowing","ceil","normalizedPage","min","start","setDeparturesSearchTerm","term","setDeparturesPage","setDeparturesPageSize","normalizedPageSize","setDeparturesReferenceDate","date","moment","format","searchedBookings","filterBookingsBySearch","split","splitBookingsByStatus","needsCheckOut","out","normalizedTerm","trim","toLowerCase","filter","booking","matchesSearchTerm","bookingNumber","booking_nbr","includes","buildName","guest","rooms","some","room","reduce","acc","needsCheckoutRooms","isNeedsCheckOut","length","push","isOutRooms","isOut","isFuture","canCheckout","to_date","inOutCode","in_out","code","isBefore","person","full","first_name","last_name"],"sources":["src/stores/departures.store.ts"],"sourcesContent":["import { PaginationRange } from '@/components/ir-pagination/ir-pagination';\nimport { Booking, Room } from '@/models/booking.dto';\nimport { canCheckout } from '@/utils/utils';\nimport { createStore } from '@stencil/store';\nimport moment from 'moment';\n\nexport interface DeparturesPagination {\n  page: number;\n  pageSize: number;\n  total: number;\n  totalPages: number;\n  currentPage: number;\n  showing: PaginationRange;\n}\n\nexport interface DeparturesStore {\n  bookings: Booking[];\n  filteredBookings: Booking[];\n  paginatedBookings: Booking[];\n  needsCheckOutBookings: Booking[];\n  futureRooms: Booking[];\n  outBookings: Booking[];\n  searchTerm: string;\n  pagination: DeparturesPagination;\n  today: string;\n}\n\nconst initialState: DeparturesStore = {\n  bookings: [],\n  filteredBookings: [],\n  paginatedBookings: [],\n  needsCheckOutBookings: [],\n  futureRooms: [],\n  outBookings: [],\n  searchTerm: '',\n  pagination: {\n    page: 1,\n    pageSize: 20,\n    total: 0,\n    totalPages: 1,\n    currentPage: 1,\n    showing: { from: 0, to: 0 },\n  },\n  today: getTodayString(),\n};\n\nexport const { state: departuresStore, onChange: onDeparturesStoreChange } = createStore<DeparturesStore>(initialState);\n\nexport function initializeDeparturesStore(bookings: Booking[] = []) {\n  departuresStore.bookings = Array.isArray(bookings) ? [...bookings] : [];\n  runDeparturesPipeline();\n}\n\nexport function setDepartureTotal(total: number) {\n  const normalizedTotal = Number.isFinite(total) && total > 0 ? Math.floor(total) : 0;\n  const totalPages = calculateTotalPages(normalizedTotal, departuresStore.pagination.pageSize);\n  const safePage = clampPage(departuresStore.pagination.currentPage, Math.max(totalPages, 1));\n  departuresStore.pagination = {\n    ...departuresStore.pagination,\n    total: normalizedTotal,\n    totalPages: Math.max(totalPages, 1),\n    currentPage: safePage,\n    showing: calculateShowing(safePage, departuresStore.pagination.pageSize, normalizedTotal),\n  };\n}\n\nfunction calculateTotalPages(total: number, pageSize: number) {\n  if (!total || !pageSize) {\n    return 0;\n  }\n  return Math.ceil(total / pageSize);\n}\n\nfunction clampPage(page: number, totalPages: number) {\n  if (!Number.isFinite(page) || page <= 0) {\n    return 1;\n  }\n  const normalizedPage = Math.floor(page);\n  return Math.min(Math.max(normalizedPage, 1), Math.max(totalPages, 1));\n}\n\nfunction calculateShowing(page: number, pageSize: number, total: number): PaginationRange {\n  if (!total || !pageSize) {\n    return { from: 0, to: 0 };\n  }\n  const start = (page - 1) * pageSize + 1;\n  return {\n    from: Math.max(start, 1),\n    to: Math.min(start + pageSize - 1, total),\n  };\n}\nexport function setDeparturesSearchTerm(term: string) {\n  departuresStore.searchTerm = term ?? '';\n  runDeparturesPipeline();\n}\n\nexport function setDeparturesPage(page: number) {\n  const safePage = clampPage(page, Math.max(departuresStore.pagination.totalPages, 1));\n  departuresStore.pagination = {\n    ...departuresStore.pagination,\n    currentPage: safePage,\n    showing: calculateShowing(safePage, departuresStore.pagination.pageSize, departuresStore.pagination.total),\n  };\n  runDeparturesPipeline();\n}\n\nexport function setDeparturesPageSize(pageSize: number) {\n  if (!Number.isFinite(pageSize) || pageSize <= 0) {\n    return;\n  }\n  const normalizedPageSize = Math.floor(pageSize);\n  departuresStore.pagination = {\n    ...departuresStore.pagination,\n    pageSize: normalizedPageSize,\n    currentPage: 1,\n    showing: calculateShowing(1, normalizedPageSize, departuresStore.pagination.total),\n  };\n  runDeparturesPipeline();\n}\n\nexport function setDeparturesReferenceDate(date: string | Date) {\n  departuresStore.today = moment(date, 'YYYY-MM-DD').format('YYYY-MM-DD');\n  runDeparturesPipeline();\n}\n\nfunction runDeparturesPipeline() {\n  const searchedBookings = filterBookingsBySearch(departuresStore.searchTerm);\n  departuresStore.filteredBookings = searchedBookings;\n  departuresStore.paginatedBookings = searchedBookings;\n\n  const split = splitBookingsByStatus(searchedBookings);\n  departuresStore.needsCheckOutBookings = split.needsCheckOut;\n  departuresStore.outBookings = split.out;\n  departuresStore.futureRooms = split.futureRooms;\n}\n\nfunction filterBookingsBySearch(term: string) {\n  const bookings = departuresStore.bookings;\n  const normalizedTerm = term?.trim().toLowerCase();\n  if (!normalizedTerm) {\n    return bookings;\n  }\n  return bookings.filter(booking => matchesSearchTerm(booking, normalizedTerm));\n}\n\nfunction matchesSearchTerm(booking: Booking, term: string) {\n  if (!term) {\n    return true;\n  }\n  const bookingNumber = booking.booking_nbr?.toLowerCase() ?? '';\n  if (bookingNumber.includes(term)) {\n    return true;\n  }\n  if (buildName(booking.guest).includes(term)) {\n    return true;\n  }\n  return (booking.rooms ?? []).some(room => buildName(room.guest).includes(term));\n}\n\nfunction splitBookingsByStatus(bookings: Booking[]) {\n  return bookings.reduce(\n    (acc, booking) => {\n      const rooms = booking.rooms ?? [];\n      const needsCheckoutRooms = rooms.filter(room => isNeedsCheckOut(room));\n      if (needsCheckoutRooms.length) {\n        acc.needsCheckOut.push({ ...booking, rooms: needsCheckoutRooms });\n      }\n      const isOutRooms = rooms.filter(room => isOut(room));\n      if (isOutRooms.length) {\n        acc.out.push({ ...booking, rooms: isOutRooms });\n      }\n      const futureRooms = rooms.filter(room => isFuture(room));\n      if (futureRooms.length) {\n        acc.out.push({ ...booking, rooms: futureRooms });\n      }\n      return acc;\n    },\n    { needsCheckOut: [] as Booking[], out: [] as Booking[], futureRooms: [] as Booking[] },\n  );\n}\n\nfunction isNeedsCheckOut(room: Room) {\n  return canCheckout({ to_date: room.to_date, inOutCode: room.in_out.code });\n}\n\nfunction isOut(room: Room) {\n  return room.in_out?.code === '002';\n}\nfunction isFuture(room: Room) {\n  return moment().isBefore(moment(room.to_date, 'YYYY-MM-DD'), 'date');\n}\n\nfunction buildName(person?: { first_name?: string | null; last_name?: string | null } | null) {\n  const full = `${person?.first_name ?? ''} ${person?.last_name ?? ''}`.trim();\n  return full.toLowerCase();\n}\n\nfunction getTodayString() {\n  return moment().format('YYYY-MM-DD');\n}\n\ninitializeDeparturesStore();\n"],"mappings":"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","ignoreList":[]}