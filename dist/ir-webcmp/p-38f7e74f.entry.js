import{r as t,c as i,h as s,H as e,a}from"./p-jhiFt_tX.js";import{T as r}from"./p-DXG1YoZP.js";import{H as o,h as n}from"./p-BzKC_TV3.js";import{R as h}from"./p-CY1Ud2NS.js";import{i as l}from"./p-CZSi6r0A.js";import{l as d}from"./p-DRfRlSCW.js";import{h as c}from"./p-Mki5YqAR.js";import{v as u}from"./p-DD3477fe.js";import"./p-BdhGE_xS.js";import"./p-E-ZsRS8r.js";import"./p-vROPuQAY.js";import"./p-CT3GgrvE.js";const p=".sc-ir-hk-tasks-h{display:block}@media only screen and (max-width: 900px){.table-container.sc-ir-hk-tasks{width:max-content !important}}";const f=class{constructor(s){t(this,s);this.clearSelectedHkTasks=i(this,"clearSelectedHkTasks");this.language="";this.ticket="";this.isLoading=false;this.selectedDuration="";this.selectedHouseKeeper="0";this.selectedRoom=null;this.archiveOpened=false;this.tasks=[];this.selectedTasks=[];this.hkNameCache={};this.roomService=new h;this.houseKeepingService=new o;this.token=new r}componentWillLoad(){if(this.ticket!==""){this.token.setToken(this.ticket);this.init()}}ticketChanged(t,i){if(t===i){return}this.token.setToken(this.ticket);this.init()}handleCloseSidebar(t){t.stopImmediatePropagation();t.stopPropagation();this.isSidebarOpen=false}async init(){try{this.isLoading=true;let t=this.propertyid;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}if(!t){console.log(t);const i=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});t=i.My_Result.id}this.property_id=t;const i=[this.houseKeepingService.getHkTasks({property_id:this.property_id,from_date:c().format("YYYY-MM-DD"),to_date:c().format("YYYY-MM-DD")}),this.houseKeepingService.getExposedHKSetup(this.property_id),this.roomService.fetchLanguage(this.language)];if(this.propertyid){i.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true,include_units_hk_status:true}))}const s=await Promise.all(i);const e=s[0];if(e){this.updateTasks(e)}}catch(t){console.log(t)}finally{this.isLoading=false}}buildHousekeeperNameCache(){var t,i;this.hkNameCache={};(i=(t=n.hk_criteria)===null||t===void 0?void 0:t.housekeepers)===null||i===void 0?void 0:i.forEach((t=>{if(t.id!=null&&t.name!=null){this.hkNameCache[t.id]=t.name}}))}updateTasks(t){this.buildHousekeeperNameCache();this.tasks=t.map((t=>Object.assign(Object.assign({},t),{id:u(),housekeeper:(()=>{var i,s,e;const a=this.hkNameCache[t.hkm_id];if(a){return a}const r=(e=(s=(i=n.hk_criteria)===null||i===void 0?void 0:i.housekeepers)===null||s===void 0?void 0:s.find((i=>i.id===t.hkm_id)))===null||e===void 0?void 0:e.name;this.hkNameCache[t.hkm_id]=r;return r})()})))}handleHeaderButtonPress(t){var i;t.stopImmediatePropagation();t.stopPropagation();const{name:s}=t.detail;switch(s){case"cleaned":(i=this.modal)===null||i===void 0?void 0:i.openModal();break;case"export":break;case"archive":this.isSidebarOpen=true;break}}async handleModalConfirmation(t){try{t.stopImmediatePropagation();t.stopPropagation();if(this.selectedTasks.length===0){return}await this.houseKeepingService.executeHKAction({actions:this.selectedTasks.map((t=>({description:"Cleaned",hkm_id:t.hkm_id===0?null:t.hkm_id,unit_id:t.unit.id,booking_nbr:t.booking_nbr})))});await this.fetchTasksWithFilters()}finally{this.selectedTasks=[];this.clearSelectedHkTasks.emit();this.modal.closeModal()}}async applyFilters(t){try{this.isApplyFiltersLoading=true;t.stopImmediatePropagation();t.stopPropagation();this.filters=Object.assign({},t.detail);await this.fetchTasksWithFilters()}catch(t){console.log(t)}finally{this.isApplyFiltersLoading=false}}async fetchTasksWithFilters(){var t;const{cleaning_periods:i,housekeepers:s,cleaning_frequencies:e,dusty_units:a,highlight_check_ins:r}=(t=this.filters)!==null&&t!==void 0?t:{};const o=await this.houseKeepingService.getHkTasks({housekeepers:s,cleaning_frequencies:e===null||e===void 0?void 0:e.code,dusty_units:a===null||a===void 0?void 0:a.code,highlight_window:r===null||r===void 0?void 0:r.code,property_id:this.property_id,from_date:c().format("YYYY-MM-DD"),to_date:(i===null||i===void 0?void 0:i.code)||c().format("YYYY-MM-DD")});if(o){this.updateTasks(o)}}render(){if(this.isLoading){return s("ir-loading-screen",null)}return s(e,{"data-testid":"hk_tasks_base"},s("ir-toast",null),s("ir-interceptor",null),s("section",{class:"p-2 d-flex flex-column",style:{gap:"1rem"}},s("ir-tasks-header",{onHeaderButtonPress:this.handleHeaderButtonPress.bind(this),isCleanedEnabled:this.selectedTasks.length>0}),s("div",{class:"d-flex flex-column flex-md-row mt-1 ",style:{gap:"1rem"}},s("ir-tasks-filters",{isLoading:this.isApplyFiltersLoading,onApplyFilters:t=>{this.applyFilters(t)}}),s("ir-tasks-table",{onRowSelectChange:t=>{t.stopImmediatePropagation();t.stopPropagation();this.selectedTasks=t.detail},class:"flex-grow-1 w-100",tasks:this.tasks}))),s("ir-modal",{autoClose:false,ref:t=>this.modal=t,isLoading:l("/Execute_HK_Action"),onConfirmModal:this.handleModalConfirmation.bind(this),iconAvailable:true,icon:"ft-alert-triangle danger h1",leftBtnText:d.entries.Lcz_NO,rightBtnText:d.entries.Lcz_Yes,leftBtnColor:"secondary",rightBtnColor:"primary",modalTitle:d.entries.Lcz_Confirmation,modalBody:"Update selected unit(s) to Clean"}),s("ir-sidebar",{open:this.isSidebarOpen,side:"right",id:"editGuestInfo",onIrSidebarToggle:t=>{t.stopImmediatePropagation();t.stopPropagation();this.isSidebarOpen=false},showCloseButton:false},this.isSidebarOpen&&s("ir-hk-archive",{propertyId:this.property_id,slot:"sidebar-body"})))}get el(){return a(this)}static get watchers(){return{ticket:["ticketChanged"]}}};f.style=p;export{f as ir_hk_tasks};
//# sourceMappingURL=p-38f7e74f.entry.js.map