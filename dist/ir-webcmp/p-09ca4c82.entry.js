import{r as t,c as i,h as e,F as s,H as o,g as n}from"./p-53d64953.js";import{R as a}from"./p-429a4d65.js";import{B as l}from"./p-6c4c7d65.js";import{j as r,k as h,l as c,n as d,o as u,p as f,q as g,t as p,r as b,d as m,u as v,v as _,w as y,f as k,x as w,y as D,A as O,B as Y,i as C,C as M}from"./p-3931150a.js";import{l as x}from"./p-eb747876.js";import{E}from"./p-0edcd378.js";import{h as S}from"./p-6c4ba7c0.js";import{T as j}from"./p-093817b3.js";import{l as T}from"./p-71768c2d.js";import{c as A,i as N}from"./p-00df8713.js";import{h as B,a as R,r as I}from"./p-25bd4703.js";import{T as P}from"./p-a93581f3.js";import{v as L}from"./p-4ed69de7.js";import{H,h as F,u as U}from"./p-b6c1681e.js";import{a as z}from"./p-bf44a732.js";import{B as G,u as $,b as K,o as W,a as q}from"./p-ecd5640c.js";import{_ as V}from"./p-b2679b77.js";import{s as J,u as Q,h as X,c as Z,a as tt}from"./p-8c949732.js";import{a as it}from"./p-5b45ff50.js";import"./p-a973aec7.js";class et{constructor(t,i){this.queue=[];this.isProcessing=false;this.flushTimer=null;this.processor=t;this.options=Object.assign({maxQueueSize:1e4,onError:t=>console.error("Queue processing error:",t),onBatchProcessed:()=>{}},i)}offer(t){if(this.queue.length>=this.options.maxQueueSize){return false}const i={data:t,timestamp:Date.now(),id:this.generateId()};this.queue.push(i);this.scheduleFlush();return true}offerAll(t){let i=0;for(const e of t){if(this.offer(e)){i++}else{break}}return i}size(){return this.queue.length}isEmpty(){return this.queue.length===0}async flush(){if(this.flushTimer){clearTimeout(this.flushTimer);this.flushTimer=null}await this.processBatch()}clear(){this.queue=[];if(this.flushTimer){clearTimeout(this.flushTimer);this.flushTimer=null}}async shutdown(){await this.flush()}scheduleFlush(){if(this.queue.length>=this.options.batchSize){this.processBatch();return}if(!this.flushTimer){this.flushTimer=setTimeout((()=>{this.processBatch()}),this.options.flushInterval)}}async processBatch(){if(this.isProcessing||this.queue.length===0){return}this.isProcessing=true;try{const t=Math.min(this.options.batchSize,this.queue.length);const i=this.queue.splice(0,t);const e=i.map((t=>t.data));const s=Date.now();await this.processor(e);const o=Date.now()-s;this.options.onBatchProcessed(t,o);if(this.flushTimer){clearTimeout(this.flushTimer);this.flushTimer=null}if(this.queue.length>0){this.scheduleFlush()}}catch(t){this.options.onError(t)}finally{this.isProcessing=false}}generateId(){return L()}}const st=".sc-igloo-calendar-h{display:block;position:relative;background-color:#ffffff;height:100%;text-align:center}.igl-calendar.sc-igloo-calendar{display:grid;grid-template-columns:1fr;height:100%}.calendarScrollContainer.sc-igloo-calendar{width:100%;height:100%;overflow:auto;position:relative;white-space:nowrap;border-left:2px solid grey}.showToBeAssigned.sc-igloo-calendar,.showLegend.sc-igloo-calendar{grid-template-columns:330px 1fr}#calendarContainer.sc-igloo-calendar{position:absolute}.legendContainer.sc-igloo-calendar,.tobeAssignedContainer.sc-igloo-calendar{display:none;height:100%;overflow-y:auto;padding-left:0.5em !important;padding-right:0.5em !important}.showToBeAssigned.sc-igloo-calendar .tobeAssignedContainer.sc-igloo-calendar{display:block}.showLegend.sc-igloo-calendar .legendContainer.sc-igloo-calendar{display:block}.tobeBooked.sc-igloo-calendar{padding-top:8px;padding-bottom:8px;text-align:left}";const ot=st;var nt=undefined&&undefined.__rest||function(t,i){var e={};for(var s in t)if(Object.prototype.hasOwnProperty.call(t,s)&&i.indexOf(s)<0)e[s]=t[s];if(t!=null&&typeof Object.getOwnPropertySymbols==="function")for(var o=0,s=Object.getOwnPropertySymbols(t);o<s.length;o++){if(i.indexOf(s[o])<0&&Object.prototype.propertyIsEnumerable.call(t,s[o]))e[s[o]]=t[s[o]]}return e};const at=class{constructor(e){t(this,e);this.dragOverHighlightElement=i(this,"dragOverHighlightElement",7);this.moveBookingTo=i(this,"moveBookingTo",7);this.calculateUnassignedDates=i(this,"calculateUnassignedDates",7);this.reduceAvailableUnitEvent=i(this,"reduceAvailableUnitEvent",7);this.revertBooking=i(this,"revertBooking",7);this.openCalendarSidebar=i(this,"openCalendarSidebar",7);this.showRoomNightsDialog=i(this,"showRoomNightsDialog",7);this.ticket="";this.calendarData=new Object;this.days=new Array;this.scrollViewDragging=false;this.dialogData=null;this.bookingItem=null;this.editBookingItem=null;this.showLegend=false;this.showPaymentDetails=false;this.showToBeAssigned=false;this.unassignedDates={};this.roomNightsData=null;this.renderAgain=false;this.showBookProperty=false;this.isAuthenticated=false;this.bookingService=new l;this.roomService=new a;this.eventsService=new E;this.toBeAssignedService=new j;this.housekeepingService=new H;this.countries=[];this.visibleCalendarCells={x:[],y:[]};this.today="";this.reachedEndOfCalendar=false;this.token=new P;this.salesQueue=new et(this.processSalesBatch.bind(this),{batchSize:50,flushInterval:1e3,maxQueueSize:5e3,onError:t=>console.error("Batch Sales Update Error:",t)});this.availabilityQueue=new et(this.processAvailabilityBatch.bind(this),{batchSize:50,flushInterval:1e3,maxQueueSize:5e3,onError:t=>console.error("Batch Availability Update Error:",t)});this.roomTypeIdsCache=new Map;this.scrollViewDragPos={top:0,left:0,x:0,y:0};this.onScrollContentMoveHandler=t=>{if(t.buttons!==1){return}const i=t.clientX-this.scrollViewDragPos.x;const e=t.clientY-this.scrollViewDragPos.y;this.scrollContainer.scrollTop=this.scrollViewDragPos.top-e;this.scrollContainer.scrollLeft=this.scrollViewDragPos.left-i;if(Math.abs(i)>5||Math.abs(e)>5){this.scrollViewDragging=true}};this.onScrollContentMoveEndHandler=()=>{document.removeEventListener("mousemove",this.onScrollContentMoveHandler);document.removeEventListener("mouseup",this.onScrollContentMoveEndHandler)}}componentWillLoad(){if(this.baseUrl){this.token.setBaseUrl(this.baseUrl)}this.init()}componentDidLoad(){this.scrollToElement(this.today)}async handleDeleteEvent(t){try{t.stopImmediatePropagation();t.preventDefault();await this.eventsService.deleteEvent(t.detail)}catch(t){}}async handleCalendarSidebarEvents(t){console.log("hit ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥");t.stopImmediatePropagation();t.stopPropagation();this.calendarSidebarState=t.detail}scrollPageToRoom(t){let i=t.detail.refClass;this.scrollContainer=this.scrollContainer||this.element.querySelector(".calendarScrollContainer");const e=this.element.querySelector(".topLeftCell");const s=this.element.querySelector("."+i);if(s){this.scrollContainer.scrollTo({top:0});const t=s.getBoundingClientRect();const i=this.scrollContainer.getBoundingClientRect();const o=e.getBoundingClientRect();this.scrollContainer.scrollTo({top:t.top-i.top-o.height-t.height})}}handleShowDialog(t){var i;t.stopImmediatePropagation();t.stopPropagation();this.dialogData=t.detail;(i=this.calendarModalEl)===null||i===void 0?void 0:i.openModal()}handleShowRoomNightsDialog(t){this.roomNightsData=t.detail}handleBookingDatasChange(t){t.stopPropagation();t.stopImmediatePropagation();let i=[...this.calendarData.bookingEvents];i=i.filter((t=>t.ID!=="NEW_TEMP_EVENT"));i.push(...t.detail.filter((t=>t.STATUS==="PENDING-CONFIRMATION")));this.updateBookingEventsDateRange(t.detail);this.calendarData=Object.assign(Object.assign({},this.calendarData),{bookingEvents:i})}handleUpdateBookingEvent(t){t.stopPropagation();t.stopImmediatePropagation();const i=t.detail;this.calendarData=Object.assign(Object.assign({},this.calendarData),{bookingEvents:this.calendarData.bookingEvents.map((t=>{if(i.ID===t.ID){return i}return t}))})}showBookingPopupEventDataHandler(t){t.preventDefault();t.stopImmediatePropagation();this.onOptionSelect(t)}updateEventDataHandler(t){let i=this.calendarData.bookingEvents.find((i=>i.id===t.detail.id));if(i&&t.detail&&t.detail.data){Object.entries(t.detail.data).forEach((([t,e])=>{i[t]=e}))}}dragOverEventDataHandler(t){if(t.detail.id==="CALCULATE_DRAG_OVER_BOUNDS"){let i=document.querySelector("igl-cal-header .topLeftCell");let e=document.querySelectorAll(".headersContainer .headerCell");let s=document.querySelectorAll(".bodyContainer .roomRow .roomTitle");this.visibleCalendarCells={x:[],y:[]};e.forEach((t=>{const e=t;this.visibleCalendarCells.x.push({left:e.offsetLeft+i.offsetWidth,width:e.offsetWidth,id:e.getAttribute("data-day")})}));s.forEach((t=>{const i=t;this.visibleCalendarCells.y.push({top:i.offsetTop,height:i.offsetHeight,id:i.getAttribute("data-room")})}));this.highlightDragOver(true,t.detail.data)}else if(t.detail.id==="DRAG_OVER"){this.highlightDragOver(true,t.detail.data)}else if(t.detail.id==="DRAG_OVER_END"){this.highlightDragOver(false,t.detail.data)}else if(t.detail.id==="STRETCH_OVER_END"){this.highlightDragOver(false,t.detail.data)}}ticketChanged(t,i){if(t===i){return}this.token.setToken(this.ticket);this.initializeApp()}init(){this.calDates={from:this.from_date,to:this.to_date};if(this.ticket!==""){this.token.setToken(this.ticket);this.initializeApp()}this.calDates={from:this.from_date,to:this.to_date};B("unassigned_dates",(t=>{if(Object.keys(t).length===0&&this.highlightedDate!==""){this.highlightedDate=""}}))}renderModalBody(){var t,i;switch((t=this.dialogData)===null||t===void 0?void 0:t.reason){case"checkin":{return`Are you sure you want to Check In this unit?`}case"checkout":{return"Are you sure you want to Check Out this unit?"}case"reallocate":return((i=this.dialogData)===null||i===void 0?void 0:i.description)||"";case"stretch":return"Warning ";default:return"Unknown modal content"}}setUpCalendarData(t,i){this.calendarData.currency=t["My_Result"].currency;this.calendarData.allowedBookingSources=t["My_Result"].allowed_booking_sources;this.calendarData.adultChildConstraints=t["My_Result"].adult_child_constraints;this.calendarData.legendData=this.getLegendData(t);this.calendarData.is_vacation_rental=t["My_Result"].is_vacation_rental;this.calendarData.from_date=i.My_Params_Get_Rooming_Data.FROM;this.calendarData.to_date=i.My_Params_Get_Rooming_Data.TO;this.calendarData.startingDate=new Date(i.My_Params_Get_Rooming_Data.FROM).getTime();this.calendarData.endingDate=new Date(i.My_Params_Get_Rooming_Data.TO).getTime();this.calendarData.formattedLegendData=r(this.calendarData.legendData);let e=i.myBookings||[];e=e.filter((t=>{const i=S(t.TO_DATE,"YYYY-MM-DD");const e=S(t.FROM_DATE,"YYYY-MM-DD");return!i.isSame(e)}));this.calendarData.bookingEvents=e;this.calendarData.toBeAssignedEvents=[]}async initializeApp(){try{let t=this.propertyid;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}let i=null;if(!t){console.log(t);const e=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true,include_sales_rate_plans:true});i=e;t=e.My_Result.id}this.property_id=t;const e=[this.bookingService.getCalendarData(t,this.from_date,this.to_date),this.bookingService.getCountries(this.language),this.roomService.fetchLanguage(this.language),this.housekeepingService.getExposedHKSetup(this.property_id)];if(this.propertyid){e.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true,include_units_hk_status:true,include_sales_rate_plans:true}))}const s=await Promise.all(e);this.tasksEndDate=S().add(30,"days").format("YYYY-MM-DD");this.getHousekeepingTasks({from_date:S().format("YYYY-MM-DD"),to_date:this.tasksEndDate});if(!i){i=s[s.length-1]}const[o,n]=s;h.days=o.days;h.months=o.months;this.setRoomsData(i);this.countries=n;this.setUpCalendarData(i,o);let a=i["My_Result"]["allowed_payment_methods"];this.showPaymentDetails=a.some((t=>t.code==="001"||t.code==="004"));this.updateBookingEventsDateRange(this.calendarData.bookingEvents);this.updateBookingEventsDateRange(this.calendarData.toBeAssignedEvents);this.today=this.transformDateForScroll(new Date);let l=new Date(this.calendarData.startingDate);l.setHours(0,0,0,0);this.days=o.days;this.calendarData.days=this.days;this.calendarData.monthsInfo=o.months;h.fromDate=this.calendarData.from_date;h.toDate=this.calendarData.to_date;setTimeout((()=>{this.scrollToElement(this.today)}),200);if(!this.calendarData.is_vacation_rental){const t=await this.toBeAssignedService.getUnassignedDates(this.property_id,this.from_date,this.to_date);this.unassignedDates={fromDate:this.from_date,toDate:this.to_date,data:Object.assign(Object.assign({},this.unassignedDates),t)};this.calendarData=Object.assign(Object.assign({},this.calendarData),{unassignedDates:t});R(t)}this.socket=x("https://realtime.igloorooms.com/");this.socket.on("MSG",(async t=>{await this.handleSocketMessage(t)}))}catch(t){console.error("Initializing Calendar Error",t)}}async getHousekeepingTasks({from_date:t,to_date:i}){var e,s,o,n,a,l,r;const{tasks:h}=await this.housekeepingService.getHkTasks({property_id:this.property_id,from_date:t,to_date:i,housekeepers:[],cleaning_frequency:(o=(e=A.cleaning_frequency)!==null&&e!==void 0?e:(s=F===null||F===void 0?void 0:F.hk_criteria)===null||s===void 0?void 0:s.cleaning_frequencies[0])===null||o===void 0?void 0:o.code,dusty_window:(a=(n=F===null||F===void 0?void 0:F.hk_criteria)===null||n===void 0?void 0:n.dusty_periods[0])===null||a===void 0?void 0:a.code,highlight_window:(r=(l=F===null||F===void 0?void 0:F.hk_criteria)===null||l===void 0?void 0:l.highlight_checkin_options[0])===null||r===void 0?void 0:r.code});c(h)}async handleSocketMessage(t){const i=JSON.parse(t);if(!i){return}const{REASON:e,KEY:s,PAYLOAD:o}=i;if(s.toString()!==this.property_id.toString()){return}let n;if(["DELETE_CALENDAR_POOL","GET_UNASSIGNED_DATES"].includes(e)){n=o}else{n=JSON.parse(o)}console.log({[e]:n});const a={DORESERVATION:this.handleDoReservation,BLOCK_EXPOSED_UNIT:this.handleBlockExposedUnit,ASSIGN_EXPOSED_ROOM:this.handleAssignExposedRoom,REALLOCATE_EXPOSED_ROOM_BLOCK:this.handleReallocateExposedRoomBlock,DELETE_CALENDAR_POOL:this.handleDeleteCalendarPool,GET_UNASSIGNED_DATES:this.handleGetUnassignedDates,UPDATE_CALENDAR_AVAILABILITY:t=>this.availabilityQueue.offer(t),CHANGE_IN_DUE_AMOUNT:this.handleChangeInDueAmount,CHANGE_IN_BOOK_STATUS:this.handleChangeInBookStatus,NON_TECHNICAL_CHANGE_IN_BOOKING:this.handleNonTechnicalChangeInBooking,ROOM_STATUS_CHANGED:this.handleRoomStatusChanged,UNIT_HK_STATUS_CHANGED:this.handleUnitHKStatusChanged,SHARING_PERSONS_UPDATED:this.handleSharingPersonsUpdated,ROOM_TYPE_CLOSE:t=>this.salesQueue.offer(Object.assign(Object.assign({},t),{is_available_to_book:false})),ROOM_TYPE_OPEN:t=>this.salesQueue.offer(Object.assign(Object.assign({},t),{is_available_to_book:true})),HK_SKIP:this.handleHkSkip};const l=a[e];if(l){await l.call(this,n)}else{console.warn(`Unhandled REASON: ${e}`)}}handleSharingPersonsUpdated(t){console.log("sharing persons updated",t);this.calendarData=Object.assign(Object.assign({},this.calendarData),{bookingEvents:[...this.calendarData.bookingEvents.map((i=>{var e;if(i.IDENTIFIER===t.identifier){const s=(e=t.guests)===null||e===void 0?void 0:e.find((t=>t.is_main));return Object.assign(Object.assign({},i),{NAME:d(s.first_name,s.last_name),ROOM_INFO:Object.assign(Object.assign({},i.ROOM_INFO),{sharing_persons:t.guests})})}return i}))]})}handleRoomStatusChanged(t){this.calendarData=Object.assign(Object.assign({},this.calendarData),{bookingEvents:[...this.calendarData.bookingEvents.map((i=>{if(i.IDENTIFIER===t.room_identifier){const e=u({from_date:i.FROM_DATE,to_date:i.TO_DATE,in_out:Object.assign(Object.assign({},i.ROOM_INFO.in_out),{code:t.status}),status_code:i.BASE_STATUS_CODE});return Object.assign(Object.assign({},i),{CHECKIN:t.status==="001",CHECKOUT:t.status==="002",STATUS:e})}return i}))]})}handleHkSkip(t){f({date:t.DATE,unitId:t.PR_ID})}handleUnitHKStatusChanged(t){console.log("hk unit change",t);const i=[...this.calendarData.roomsInfo];const e=i.findIndex((i=>i.id===t.ROOM_CATEGORY_ID));if(e!==-1){const s=Object.assign({},i[e]);const o=s.physicalrooms.findIndex((i=>i.id===t.PR_ID));if(o!==-1){const n=[...s.physicalrooms];const a=Object.assign({},n[o]);a.hk_status=t.HKS_CODE;n[o]=a;s.physicalrooms=n;i[e]=s;this.calendarData=Object.assign(Object.assign({},this.calendarData),{roomsInfo:i})}}const s={date:S().format("YYYY-MM-DD"),unitId:t.PR_ID};if(t.HKS_CODE==="002"){g(s)}else{f(s)}}async handleDoReservation(t){const i=p(t);this.AddOrUpdateRoomBookings(i)}async handleBlockExposedUnit(t){const i=[await b(t)];this.AddOrUpdateRoomBookings(i)}async handleAssignExposedRoom(t){console.log(t);const i=p(t);this.AddOrUpdateRoomBookings(i)}async handleReallocateExposedRoomBlock(t){await this.handleBlockExposedUnit(t)}async handleDeleteCalendarPool(t){console.log("delete calendar pool");this.calendarData=Object.assign(Object.assign({},this.calendarData),{bookingEvents:this.calendarData.bookingEvents.filter((i=>i.POOL!==t))})}async handleGetUnassignedDates(t){const i=this.parseDateRange(t);if(!this.calendarData.is_vacation_rental&&new Date(i.FROM_DATE).getTime()>=this.calendarData.startingDate&&new Date(i.TO_DATE).getTime()<=this.calendarData.endingDate){const t=await this.toBeAssignedService.getUnassignedDates(this.property_id,m(new Date(i.FROM_DATE)),m(new Date(i.TO_DATE)));R(t);this.unassignedDates={fromDate:m(new Date(i.FROM_DATE)),toDate:m(new Date(i.TO_DATE)),data:t};if(Object.keys(t).length===0){I(m(new Date(i.FROM_DATE)),m(new Date(i.TO_DATE)));this.reduceAvailableUnitEvent.emit({fromDate:m(new Date(i.FROM_DATE)),toDate:m(new Date(i.TO_DATE))})}}}parseDateRange(t){const i={};const e=t.split("|");e.forEach((t=>{const e=t.split(":");i[e[0]]=e[1]}));return i}handleChangeInDueAmount(t){this.calendarData=Object.assign(Object.assign({},this.calendarData),{bookingEvents:this.calendarData.bookingEvents.map((i=>{if(t.pools.includes(i.ID)){return Object.assign(Object.assign({},i),{BALANCE:t.due_amount})}return i}))})}handleChangeInBookStatus(t){this.calendarData=Object.assign(Object.assign({},this.calendarData),{bookingEvents:this.calendarData.bookingEvents.map((i=>{if(t.pools.includes(i.ID)){return Object.assign(Object.assign({},i),{STATUS:i.STATUS!=="IN-HOUSE"?v[t.status_code]:t.status_code==="001"?v[t.status_code]:"IN-HOUSE"})}return i}))})}handleNonTechnicalChangeInBooking(t){this.calendarData=Object.assign(Object.assign({},this.calendarData),{bookingEvents:this.calendarData.bookingEvents.map((i=>{if(i.BOOKING_NUMBER===t.booking_nbr){return Object.assign(Object.assign({},i),{PRIVATE_NOTE:_(t.extras)})}return i}))})}checkBookingAvailability(t){return this.calendarData.bookingEvents.some((i=>i.ID===t.ID||i.FROM_DATE===t.FROM_DATE&&i.TO_DATE===t.TO_DATE&&i.PR_ID===t.PR_ID))}updateBookingEventsDateRange(t){t.forEach((t=>{var i;t.legendData=this.calendarData.formattedLegendData;t.defaultDateRange={};t.defaultDateRange.fromDate=new Date(t.FROM_DATE+"T00:00:00");t.defaultDateRange.fromDateStr=this.getDateStr(t.defaultDateRange.fromDate);t.defaultDateRange.fromDateTimeStamp=t.defaultDateRange.fromDate.getTime();t.defaultDateRange.toDate=new Date(t.TO_DATE+"T00:00:00");t.defaultDateRange.toDateStr=this.getDateStr(t.defaultDateRange.toDate);t.defaultDateRange.toDateTimeStamp=t.defaultDateRange.toDate.getTime();t.defaultDateRange.dateDifference=t.NO_OF_DAYS;t.roomsInfo=[...this.calendarData.roomsInfo];if(!y(t.STATUS_CODE)){t.STATUS=u({in_out:(i=t.ROOM_INFO)===null||i===void 0?void 0:i.in_out,from_date:t.FROM_DATE,to_date:t.TO_DATE,status_code:t.BASE_STATUS_CODE})}}))}processSalesBatch(t){const i=[...h.days];const e=new Map(h.disabled_cells);for(const s of t){const t=i.findIndex((t=>t.value===s.night));if(t===-1){console.warn(`Couldn't find day ${s.night}`);continue}let o=this.roomTypeIdsCache.get(s.rate_plan_id);if(o==="skip"){continue}if(!o){const e=i[t].rate.findIndex((t=>t.rateplans.some((t=>t.id===s.rate_plan_id))));if(e===-1){this.roomTypeIdsCache.set(s.rate_plan_id,"skip");console.warn(`Couldn't find room type for rate plan ${s.rate_plan_id}`);continue}const n=i[t].rate[e];const a=n.rateplans.findIndex((t=>t.id===s.rate_plan_id));o={id:e,index:a};this.roomTypeIdsCache.set(s.rate_plan_id,o)}const{id:n,index:a}=o;const l=i[t].rate[n];const r=l.rateplans.map(((t,i)=>i===a?Object.assign(Object.assign({},t),{is_available_to_book:s.is_available_to_book}):t));const h=r.some((t=>t.is_available_to_book));i[t].rate[n]=Object.assign(Object.assign({},l),{rateplans:r,is_available_to_book:h});for(const s of l.physicalrooms){const o=`${s.id}_${i[t].value}`;e.set(o,{disabled:!h,reason:"stop_sale"})}}h["disabled_cells"]=new Map(e);h.days=i}processAvailabilityBatch(t){let i=[...h.days];const e=new Map(h.disabled_cells);for(const s of t){const t=i.findIndex((t=>t.value===s.date));if(t===-1){console.warn(`Couldn't find day ${s.date}`);return}const o=i[t].rate.findIndex((t=>t.id===s.room_type_id));if(o===-1){console.warn(`Couldn't find room type ${s.room_type_id}`);return}const n=i[t].rate[o];n.exposed_inventory.rts=s.availability;const a=n.rateplans.every((t=>!t.is_available_to_book));for(const t of n.physicalrooms){const i=`${t.id}_${s.date}`;e.set(i,{disabled:s.availability===0,reason:a?"stop_sale":"inventory"})}}h["disabled_cells"]=new Map(e);h.days=[...i]}setRoomsData(t){var i,e;let s=new Array;if((e=(i=t.My_Result)===null||i===void 0?void 0:i.roomtypes)===null||e===void 0?void 0:e.length){s=t.My_Result.roomtypes;t.My_Result.roomtypes.forEach((t=>{t.expanded=true}))}A.roomsInfo=s;this.calendarData.roomsInfo=s}getLegendData(t){return t["My_Result"].calendar_legends}getDateStr(t,i="default"){return t.getDate()+" "+t.toLocaleString(i,{month:"short"})+" "+t.getFullYear()}scrollToElement(t){this.scrollContainer=this.scrollContainer||this.element.querySelector(".calendarScrollContainer");const i=this.element.querySelector(".topLeftCell");const e=this.element.querySelector(".day-"+t);if(e){this.scrollContainer.scrollTo({left:0});const t=e.getBoundingClientRect();const s=this.scrollContainer.getBoundingClientRect();const o=i.getBoundingClientRect();this.scrollContainer.scrollTo({left:t.left-s.left-o.width-t.width})}}AddOrUpdateRoomBookings(t,i=undefined){let e=[...this.calendarData.bookingEvents];t.forEach((t=>{if(!this.checkBookingAvailability(t)){e=e.filter((i=>i.ID!==t.ID))}}));this.updateBookingEventsDateRange(t);if(i){e=e.filter((t=>t.POOL===i))}t.forEach((t=>{if(!e.some((i=>i.ID===t.ID))){e.push(t)}}));this.calendarData=Object.assign(Object.assign({},this.calendarData),{bookingEvents:e});const s=t=>{const i=S(this.tasksEndDate,"YYYY-MM-DD");return S(t.FROM_DATE,"YYYY-MM-DD").isSameOrBefore(i,"date")||S(t.TO_DATE,"YYYY-MM-DD").isSameOrBefore(i,"date")};if(t.some(s)){this.getHousekeepingTasks({from_date:S().format("YYYY-MM-DD"),to_date:this.tasksEndDate})}}transformDateForScroll(t){return S(t).format("D_M_YYYY")}shouldRenderCalendarView(){return this.calendarData&&this.calendarData.days&&this.calendarData.days.length}onOptionSelect(t){const i=t.detail;const e=this.element.querySelector("#iglooCalendar");switch(i.key){case"showAssigned":e.classList.remove("showLegend");e.classList.remove("showToBeAssigned");e.classList.toggle("showToBeAssigned");this.showLegend=false;this.showToBeAssigned=true;break;case"showLegend":e.classList.remove("showToBeAssigned");e.classList.remove("showLegend");e.classList.toggle("showLegend");this.showLegend=true;this.showToBeAssigned=false;break;case"calendar":let t=new Date;if(i.data.start!==undefined&&i.data.end!==undefined){t=i.data.start.toDate();this.handleDateSearch(i.data)}else{t=new Date(i.data);t.setDate(t.getDate()+1);if(!(i===null||i===void 0?void 0:i.noScroll)){this.scrollToElement(t.getDate()+"_"+(t.getMonth()+1)+"_"+t.getFullYear())}}this.highlightedDate=this.transformDateForScroll(t);break;case"search":break;case"bulk":this.calendarSidebarState={type:"bulk-blocks",payload:null};break;case"add":if(i.data.event_type!=="EDIT_BOOKING"){this.bookingItem=i.data}else{this.editBookingItem=i.data}break;case"gotoToday":this.scrollToElement(this.today);break;case"closeSideMenu":this.closeSideMenu();this.highlightedDate="";this.showBookProperty=false;break}}async addDatesToCalendar(t,i){const[e]=await Promise.all([this.bookingService.getCalendarData(this.property_id,t,i)]);const s=e.myBookings||[];this.updateBookingEventsDateRange(s);if(new Date(t).getTime()<new Date(this.calendarData.startingDate).getTime()){this.calendarData.startingDate=new Date(t).getTime();this.calendarData.from_date=t;h.fromDate=this.calendarData.from_date;this.days=[...e.days,...this.days];let o=[...e.months];if(this.calendarData.monthsInfo[0].monthName===e.months[e.months.length-1].monthName){this.calendarData.monthsInfo[0].daysCount=this.calendarData.monthsInfo[0].daysCount+e.months[e.months.length-1].daysCount;o.pop()}let n=JSON.parse(JSON.stringify(s));n=n.filter((t=>{const i=this.calendarData.bookingEvents.findIndex((i=>i.ID===t.ID));if(i!==-1){this.calendarData.bookingEvents[i].FROM_DATE=t.FROM_DATE;this.calendarData.bookingEvents[i].NO_OF_DAYS=k(t.FROM_DATE,this.calendarData.bookingEvents[i].TO_DATE);return false}return true}));h.days=this.days;this.calendarData=Object.assign(Object.assign({},this.calendarData),{days:this.days,monthsInfo:[...o,...this.calendarData.monthsInfo],bookingEvents:[...this.calendarData.bookingEvents,...n]});if(Math.abs(S().diff(S(t,"YYYY-MM-DD"),"days"))<=10){const e=await this.toBeAssignedService.getUnassignedDates(this.property_id,t,i);this.calendarData.unassignedDates=Object.assign(Object.assign({},this.calendarData.unassignedDates),e);this.unassignedDates={fromDate:t,toDate:i,data:e};R(e)}}else{this.calendarData.endingDate=new Date(i).getTime();this.calendarData.to_date=i;h.toDate=this.calendarData.to_date;let o=[...e.months];this.days=[...this.days,...e.days];if(this.calendarData.monthsInfo[this.calendarData.monthsInfo.length-1].monthName===e.months[0].monthName){this.calendarData.monthsInfo[this.calendarData.monthsInfo.length-1].daysCount=this.calendarData.monthsInfo[this.calendarData.monthsInfo.length-1].daysCount+e.months[0].daysCount;o.shift()}let n=JSON.parse(JSON.stringify(s));n=n.filter((t=>{const i=this.calendarData.bookingEvents.findIndex((i=>i.ID===t.ID));if(i!==-1){this.calendarData.bookingEvents[i].TO_DATE=t.TO_DATE;this.calendarData.bookingEvents[i].NO_OF_DAYS=k(this.calendarData.bookingEvents[i].FROM_DATE,t.TO_DATE);return false}return true}));h.days=this.days;this.calendarData=Object.assign(Object.assign({},this.calendarData),{days:this.days,monthsInfo:[...this.calendarData.monthsInfo,...o],bookingEvents:[...this.calendarData.bookingEvents,...n]});const a=await this.toBeAssignedService.getUnassignedDates(this.property_id,t,i);this.calendarData.unassignedDates=Object.assign(Object.assign({},this.calendarData.unassignedDates),a);this.unassignedDates={fromDate:t,toDate:i,data:a};R(a)}}async handleDateSearch(t){const i=S(t.start).toDate();const e=S(this.calDates.from).toDate();const s=t.end.toDate();const o=this.calendarData.endingDate;if(i.getTime()<new Date(this.calDates.from).getTime()){await this.addDatesToCalendar(S(i).add(-1,"days").format("YYYY-MM-DD"),S(e).add(-1,"days").format("YYYY-MM-DD"));this.calDates=Object.assign(Object.assign({},this.calDates),{from:t.start.add(-1,"days").format("YYYY-MM-DD")});this.scrollToElement(this.transformDateForScroll(i))}else if(i.getTime()>e.getTime()&&i.getTime()<o&&s.getTime()<o){this.scrollToElement(this.transformDateForScroll(i))}else if(i.getTime()>o){const t=w(new Date(this.calendarData.endingDate));await this.addDatesToCalendar(t,S(s).add(2,"months").format("YYYY-MM-DD"));this.scrollToElement(this.transformDateForScroll(i))}}closeSideMenu(){this.showLegend=false;this.showToBeAssigned=false}dragScrollContent(t){this.scrollViewDragging=false;let i=t&&t.target?this.hasAncestorWithClass(t.target,"preventPageScroll"):false;if(!i&&t.buttons===1){this.scrollViewDragPos={left:this.scrollContainer.scrollLeft,top:this.scrollContainer.scrollTop,x:t.clientX,y:t.clientY};document.addEventListener("mousemove",this.onScrollContentMoveHandler);document.addEventListener("mouseup",this.onScrollContentMoveEndHandler)}}calendarScrolling(){if(this.scrollContainer){if(this.highlightedDate){const t=document.querySelector(`.day-${this.highlightedDate}`);if(t){const{left:i,right:e}=t.getBoundingClientRect();const s=i>=0&&e<=window.innerWidth;if(!s){this.highlightedDate=""}}}const t=this.scrollContainer.getBoundingClientRect();let i=170;let e=t.width-i;let s=t.x+i;let o=t.x+t.width;let n=Array.from(this.element.querySelectorAll(".monthCell"));if(n.length){n.map((async t=>{let i=t.getBoundingClientRect();if(n.indexOf(t)===n.length-1){if(i.x+i.width<=o&&!this.reachedEndOfCalendar){this.reachedEndOfCalendar=true;const t=D(new Date(this.calendarData.endingDate));const i=w(new Date(this.calendarData.endingDate));await this.addDatesToCalendar(i,t);this.reachedEndOfCalendar=false}}if(i.x+i.width<s);else if(i.x>o);else{let n=t.querySelector(".monthTitle");let a=0;let l=i.width;if(i.x<s){a=Math.abs(i.x)-s;a=i.x<0?Math.abs(i.x)+s:Math.abs(a);l=i.x+i.width>o?e:i.x+i.width-s}else{l=e-l>l?l:e-i.x+s}n.style.marginLeft=a+"px";n.style.width=l+"px"}}))}}}hasAncestorWithClass(t,i){let e=t;while(e!==null){if(e.matches(`.${i}`)){return true}e=e.parentElement}return false}async highlightDragOver(t,i){let e,s;if(i){e=this.visibleCalendarCells.x.find((t=>t.left<i.x&&i.x<=t.left+t.width));s=this.visibleCalendarCells.y.find((t=>t.top<i.y&&i.y<=t.top+t.height))}if(t&&e&&s){this.dragOverHighlightElement.emit({dragOverElement:s.id+"_"+e.id})}else{this.dragOverHighlightElement.emit({dragOverElement:""})}if(!t){this.moveBookingTo.emit({bookingId:i.id,fromRoomId:i.fromRoomId,toRoomId:s&&s.id||"revert",moveToDay:e&&e.id||"revert",pool:i.pool,from_date:O(e&&e.id),to_date:Y(e&&e.id,i.nbOfDays)})}}handleModalConfirm(){var t;const i=()=>{this.dialogData=null};try{switch((t=this.dialogData)===null||t===void 0?void 0:t.reason){case"checkin":case"checkout":{const{bookingNumber:t,roomIdentifier:e}=this.dialogData;const s=this.dialogData.reason==="checkin"?"001":"002";this.bookingService.handleExposedRoomInOut({booking_nbr:t,room_identifier:e,status:s}).finally(i);if(this.dialogData.reason==="checkin"){this.openCalendarSidebar.emit({type:"room-guests",payload:this.dialogData.sidebarPayload})}break}case"stretch":const t=this.dialogData,e=nt(t,["reason"]);this.showRoomNightsDialog.emit(e);break;case"reallocate":{if(!this.dialogData){console.warn("No dialog data available for reallocation.");return}const{pool:t,toRoomId:e,from_date:s,to_date:o}=this.dialogData;this.eventsService.reallocateEvent(t,e,s,o).then(i).catch((()=>{console.error("Reallocation failed. Reverting booking.");this.revertBooking.emit(t)})).finally(i);break}default:i();break}}catch(t){console.error("Error handling modal confirm:",t);i()}}handleModalCancel(){var t;if(((t=this.dialogData)===null||t===void 0?void 0:t.reason)==="reallocate"||this.dialogData.reason==="stretch"){this.revertBooking.emit(this.dialogData.pool)}this.dialogData=null}handleRoomNightsDialogClose(t){if(t.detail.type==="cancel"){this.revertBooking.emit(this.roomNightsData.pool)}this.roomNightsData=null}handleSideBarToggle(t){var i;if(t.detail){this.calendarSidebarState=null;if(this.editBookingItem){this.editBookingItem=null}if(this.roomNightsData){this.revertBooking.emit(this.roomNightsData.pool);this.roomNightsData=null}if(((i=this.dialogData)===null||i===void 0?void 0:i.reason)==="reallocate"){this.revertBooking.emit(this.dialogData.pool);this.dialogData=null}}}handleCloseBookingWindow(){this.bookingItem=null}render(){var t,i,n,a,l,r,h,c,d,u,f,g,p,b,m,v,_;return e(o,{key:"95d5df566e22bd5d1de71ce7a06cec969edc629c"},e("ir-toast",{key:"eeed200fa854f1c648d1302578cc9b18234e5264"}),e("ir-interceptor",{key:"179e2239daa46338c6660e7d5a8368ba2fb4835e"}),e("div",{key:"9d7d84ff18b406e150d71ce6754187cc851be8f4",id:"iglooCalendar",class:{"igl-calendar":true,showToBeAssigned:this.showToBeAssigned,showLegend:this.showLegend}},this.shouldRenderCalendarView()?e(s,{"data-testid":"ir-calendar"},this.showToBeAssigned&&e("igl-to-be-assigned",{unassignedDatesProp:this.unassignedDates,to_date:this.to_date,from_date:this.from_date,propertyid:this.property_id,class:"tobeAssignedContainer",calendarData:this.calendarData,onOptionEvent:t=>this.onOptionSelect(t)}),this.showLegend&&e("igl-legends",{class:"legendContainer",legendData:this.calendarData.legendData,onOptionEvent:t=>this.onOptionSelect(t)}),e("div",{class:"calendarScrollContainer",onMouseDown:t=>this.dragScrollContent(t),onScroll:()=>this.calendarScrolling()},e("div",{id:"calendarContainer"},e("igl-cal-header",{unassignedDates:this.unassignedDates,to_date:this.to_date,propertyid:this.property_id,today:this.today,calendarData:this.calendarData,highlightedDate:this.highlightedDate,onOptionEvent:t=>this.onOptionSelect(t)}),e("igl-cal-body",{propertyId:this.property_id,language:this.language,countries:this.countries,currency:this.calendarData.currency,today:this.today,highlightedDate:this.highlightedDate,isScrollViewDragging:this.scrollViewDragging,calendarData:this.calendarData}),e("igl-cal-footer",{highlightedDate:this.highlightedDate,today:this.today,calendarData:this.calendarData,onOptionEvent:t=>this.onOptionSelect(t)})))):e("ir-loading-screen",{message:"Preparing Calendar Data"})),this.bookingItem&&e("igl-book-property",{key:"350222faed1bce682b377f8efafb5331914e16e5",allowedBookingSources:this.calendarData.allowedBookingSources,adultChildConstraints:this.calendarData.adultChildConstraints,showPaymentDetails:this.showPaymentDetails,countries:this.countries,currency:this.calendarData.currency,language:this.language,propertyid:this.property_id,bookingData:this.bookingItem,onCloseBookingWindow:()=>this.handleCloseBookingWindow()}),e("ir-sidebar",{key:"1ce38758686ab1417a297058fa7ab78ccfbad1d2",onIrSidebarToggle:this.handleSideBarToggle.bind(this),open:!!this.calendarSidebarState||this.roomNightsData!==null||this.editBookingItem&&this.editBookingItem.event_type==="EDIT_BOOKING",showCloseButton:false,sidebarStyles:{width:((t=this.calendarSidebarState)===null||t===void 0?void 0:t.type)==="room-guests"?"60rem":this.editBookingItem?"80rem":"var(--sidebar-width,40rem)",background:this.editBookingItem?"#F2F3F8":"white"}},this.roomNightsData&&e("ir-room-nights",{key:"cfd13228415e414ef72b70b725570f57a551bd7d",slot:"sidebar-body",pool:this.roomNightsData.pool,onCloseRoomNightsDialog:this.handleRoomNightsDialogClose.bind(this),language:this.language,bookingNumber:this.roomNightsData.bookingNumber,identifier:this.roomNightsData.identifier,toDate:this.roomNightsData.to_date,fromDate:this.roomNightsData.from_date,defaultDates:this.roomNightsData.defaultDates,ticket:this.ticket,propertyId:this.property_id}),this.editBookingItem&&this.editBookingItem.event_type==="EDIT_BOOKING"&&e("ir-booking-details",{key:"cf11d9d2d8cbe796d6288e0eef422f846f0b577b",slot:"sidebar-body",hasPrint:true,hasReceipt:true,hasCloseButton:true,onCloseSidebar:()=>this.editBookingItem=null,is_from_front_desk:true,propertyid:this.property_id,hasRoomEdit:true,hasRoomDelete:true,bookingNumber:this.editBookingItem.BOOKING_NUMBER,ticket:this.ticket,language:this.language,hasRoomAdd:true}),((i=this.calendarSidebarState)===null||i===void 0?void 0:i.type)==="room-guests"&&e("ir-room-guests",{key:"510e69860bbf788287f898325e5ee227fc032f1f",countries:this.countries,language:this.language,identifier:(a=(n=this.calendarSidebarState)===null||n===void 0?void 0:n.payload)===null||a===void 0?void 0:a.identifier,bookingNumber:(l=this.calendarSidebarState)===null||l===void 0?void 0:l.payload.bookingNumber,roomName:(h=(r=this.calendarSidebarState)===null||r===void 0?void 0:r.payload)===null||h===void 0?void 0:h.roomName,totalGuests:(d=(c=this.calendarSidebarState)===null||c===void 0?void 0:c.payload)===null||d===void 0?void 0:d.totalGuests,sharedPersons:(f=(u=this.calendarSidebarState)===null||u===void 0?void 0:u.payload)===null||f===void 0?void 0:f.sharing_persons,slot:"sidebar-body",checkIn:(p=(g=this.calendarSidebarState)===null||g===void 0?void 0:g.payload)===null||p===void 0?void 0:p.checkin,onCloseModal:()=>this.calendarSidebarState=null}),((b=this.calendarSidebarState)===null||b===void 0?void 0:b.type)==="bulk-blocks"&&e("igl-bulk-operations",{key:"f19e0fc0cce58228c33e9d8bc1fa0ee4fa4a9964",slot:"sidebar-body",property_id:this.property_id,onCloseModal:()=>this.calendarSidebarState=null})),e("ir-modal",{key:"ff4a565277db26130d08546b65a3afafed8286dc",ref:t=>this.calendarModalEl=t,modalTitle:"",rightBtnActive:((m=this.dialogData)===null||m===void 0?void 0:m.reason)==="reallocate"?!this.dialogData.hideConfirmButton:true,leftBtnText:(v=T===null||T===void 0?void 0:T.entries)===null||v===void 0?void 0:v.Lcz_Cancel,rightBtnText:(_=T===null||T===void 0?void 0:T.entries)===null||_===void 0?void 0:_.Lcz_Confirm,modalBody:this.renderModalBody(),onConfirmModal:this.handleModalConfirm.bind(this),onCancelModal:this.handleModalCancel.bind(this)}))}get element(){return n(this)}static get watchers(){return{ticket:["ticketChanged"]}}};at.style=ot;const lt=".sc-ir-booking-email-logs-h{display:block}";const rt=lt;const ht=class{constructor(i){t(this,i);this.token=new P}componentWillLoad(){if(this.ticket){this.token.setToken(this.ticket)}}handleTicketChange(){if(this.ticket){this.token.setToken(this.ticket)}}render(){return e(o,{key:"4698b1cdf59870071d560bdc6d6717863ab0fcd5",class:"p-1"},e("ir-interceptor",{key:"fd8435727c46d174023d4c612f0b5b73b473ca27",handledEndpoints:["/Get_Email_log_By_BOOK_NBR"]}),e("ir-toast",{key:"9b07f0cc8888477f34c97ff7b6bafc5257aa7462"}),e("div",{key:"86bd292ed205f9bad0cf0554194ae90b990c12d2",class:"d-flex align-items-center mb-1",style:{gap:"0.5rem"}},e("ir-input-text",{key:"e80d28192f47a202db694f4f559cf65052b5de8c",class:"m-0",inputContainerStyle:{margin:"0"},value:this.bookingNumber,onTextChange:t=>this.bookingNumber=t.detail,placeholder:"booking number"}),e("ir-button",{key:"24a40cbf5e6d695cbd37362dc23db879f08b0802",size:"sm",text:"search",onClickHandler:async()=>{const{data:t}=await z.post("/Get_Email_log_By_BOOK_NBR",{BOOK_NBR:this.bookingNumber});if(t.ExceptionMsg){return}this.data=t.My_Result}})),e("p",{key:"0127d323e113cd6b615fe9f2b6ae9fc900112a8c"},JSON.stringify(this.data,null,2)))}static get watchers(){return{ticket:["handleTicketChange"]}}};ht.style=rt;function ct(){const t=new URLSearchParams(window.location.search);const i={};for(const[e,s]of t.entries()){i[e]=s}return i}const dt=".sc-ir-booking-listing-h{display:block;height:100%}.logo.sc-ir-booking-listing{height:2rem;width:2rem}.card.sc-ir-booking-listing{overflow-x:auto}.secondary-p.sc-ir-booking-listing{font-size:12px !important}.room-service.sc-ir-booking-listing{display:flex;align-items:center;justify-content:space-between;gap:0.5rem;width:100%;padding:0.25rem 0}.room-name-container.sc-ir-booking-listing{background:#acecff;padding:0.1rem 0.3rem;border-radius:5px}.h-screen.sc-ir-booking-listing{height:100%}.price-span.sc-ir-booking-listing{margin:0;margin-right:5px}.main-container.sc-ir-booking-listing{height:100%;overflow-y:auto}.badge.ct_ir_badge.sc-ir-booking-listing{padding:0.2rem 0.3rem}.yellow_dot.sc-ir-booking-listing{height:0.5rem;width:0.5rem;height:0.5rem;width:0.8rem;border-radius:50%;background:rgb(244, 213, 82);margin-left:0.5rem;display:inline-flex;padding:0;margin:0}.booking_name.sc-ir-booking-listing{display:flex;align-items:center;gap:0.4rem}.bg-ir-red.sc-ir-booking-listing{background:#ff4961;padding:0.2rem 0.3rem}.due-btn.sc-ir-booking-listing{border:1px solid #ff4961;color:#ff4961;cursor:pointer;padding:1px 0.25rem !important;font-size:12px !important}.due-btn.sc-ir-booking-listing:hover{background:#ff4961;color:white}.booking_number.sc-ir-booking-listing{all:unset;cursor:pointer}.booking_number.sc-ir-booking-listing:hover{color:#1e9ff2}.in-out.sc-ir-booking-listing{width:150px !important}.booking_guest_name.sc-ir-booking-listing{width:fit-content;padding:0 !important;margin:0}.booking_guest_name.sc-ir-booking-listing .button-text.sc-ir-booking-listing{padding:0 !important}.buttons-container.sc-ir-booking-listing{gap:10px}td.sc-ir-booking-listing ul.sc-ir-booking-listing{width:max-content !important}td.sc-ir-booking-listing{width:max-content !important}.date-p.sc-ir-booking-listing{width:max-content !important;min-width:100%;text-align:center !important}.booking-label-gap.sc-ir-booking-listing{gap:5px}@media (min-width: 1024px){.yellow_dot.sc-ir-booking-listing{height:0.5rem;width:0.5rem}}";const ut=dt;const ft=class{constructor(i){t(this,i);this.language="";this.ticket="";this.rowCount=10;this.isLoading=false;this.currentPage=1;this.totalPages=1;this.oldStartValue=0;this.editBookingItem=null;this.showCost=false;this.bookingListingService=new G;this.bookingService=new l;this.roomService=new a;this.token=new P;this.statusColors={"001":"badge-warning","002":"badge-success","003":"badge-danger","004":"badge-danger"}}componentWillLoad(){if(this.baseUrl){this.token.setBaseUrl(this.baseUrl)}$("end_row",this.rowCount);K.rowCount=this.rowCount;if(this.ticket!==""){K.token=this.ticket;this.token.setToken(this.ticket);this.initializeApp()}W("userSelection",(async t=>{const i=t.total_count;this.totalPages=Math.ceil(i/this.rowCount)}));W("bookings",(async t=>{this.showCost=t.some((t=>t.financial.gross_cost!==null&&t.financial.gross_cost>0))}))}ticketChanged(t,i){if(t===i){return}this.token.setToken(this.ticket);K.token=this.ticket;this.initializeApp()}async initializeApp(){try{this.isLoading=true;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}let t=this.propertyid;if(!t){const i=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true});t=i.My_Result.id}const i=[this.bookingService.getSetupEntriesByTableNameMulti(["_PAY_TYPE","_PAY_TYPE_GROUP","_PAY_METHOD"]),this.bookingListingService.getExposedBookingsCriteria(t),this.roomService.fetchLanguage(this.language,["_BOOKING_LIST_FRONT"])];if(this.propertyid){i.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true}))}const[e]=await Promise.all(i);const{pay_type:s,pay_type_group:o,pay_method:n}=this.bookingService.groupEntryTablesResult(e);this.paymentEntries={groups:o,methods:n,types:s};$("property_id",t);await this.bookingListingService.getExposedBookings(Object.assign(Object.assign({},K.userSelection),{is_to_export:false}))}catch(t){console.error(t)}finally{this.isLoading=false}}handleSideBarToggle(t){if(t.detail){this.editBookingItem=null}}geSearchFiltersFromParams(){const t=ct();if(t){console.log("update params");let i={};if(t.e){i["end_row"]=Number(t.e)}if(t.s){i["start_row"]=Number(t.s)}if(t.status){i["booking_status"]=t.status}if(t.filter){i["filter_type"]=t.filter}if(t.from){i["from"]=t.from}if(t.to){i["to"]=t.to}q(i)}console.log("params=>",t)}getPaginationBounds(){const t=K.userSelection.total_count;const i=(this.currentPage-1)*this.rowCount;let e=this.currentPage*this.rowCount;e=e>t?t:e;return{startItem:i,endItem:e,totalCount:t}}openModal(){this.listingModalTimeout=setTimeout((()=>{this.listingModal=this.el.querySelector("ir-listing-modal");this.listingModal.editBooking=this.editBookingItem;this.listingModal.openModal()}),100)}disconnectedCallback(){clearTimeout(this.listingModalTimeout)}async handleResetData(t){t.stopImmediatePropagation();t.stopPropagation();await this.bookingListingService.getExposedBookings(Object.assign(Object.assign({},K.userSelection),{is_to_export:false}))}async handleResetStoreData(t){t.stopImmediatePropagation();t.stopPropagation();await this.bookingListingService.getExposedBookings(Object.assign(Object.assign({},K.userSelection),{is_to_export:false}))}handleBookingChanged(t){t.stopImmediatePropagation();t.stopPropagation();K.bookings=[...K.bookings.map((i=>{if(i.booking_nbr===t.detail.booking_nbr){return t.detail}return i}))]}renderItemRange(){const{endItem:t,startItem:i,totalCount:e}=this.getPaginationBounds();return`${T.entries.Lcz_View} ${i+1} - ${t} ${T.entries.Lcz_Of} ${e}`}async updateData(){const{endItem:t,startItem:i}=this.getPaginationBounds();await this.bookingListingService.getExposedBookings(Object.assign(Object.assign({},K.userSelection),{is_to_export:false,start_row:i,end_row:t}))}calculateTotalPersons(t){const i=({adult_nbr:t,children_nbr:i,infant_nbr:e})=>(t!==null&&t!==void 0?t:0)+(i!==null&&i!==void 0?i:0)+(e!==null&&e!==void 0?e:0);return t.rooms.reduce(((t,e)=>i(e.occupancy)+t),0)}render(){var t,i,n,a,l,r,h,c,d,u,f,g,p,b,m,v,y,k,w,D;if(this.isLoading||this.ticket===""){return e("ir-loading-screen",null)}return e(o,null,e("ir-interceptor",null),e("ir-toast",null),e("div",{class:"p-1 main-container"},e("ir-listing-header",{propertyId:this.propertyid,p:this.p,language:this.language}),e("section",null,e("div",{class:"card p-1 flex-fill m-0 mt-2"},e("table",{class:"table table-striped table-bordered no-footer dataTable"},e("thead",null,e("tr",null,e("th",{scope:"col",class:"text-center"},(t=T.entries)===null||t===void 0?void 0:t.Lcz_Booking,"#"),e("th",{scope:"col"},(i=T.entries)===null||i===void 0?void 0:i.Lcz_BookedOn),e("th",{scope:"col"},(n=T.entries)===null||n===void 0?void 0:n.Lcz_GuestSource),e("th",{scope:"col",class:"text-left services-cell"},(a=T.entries)===null||a===void 0?void 0:a.Lcz_Services),e("th",{scope:"col",class:"in-out"},(l=T.entries)===null||l===void 0?void 0:l.Lcz_Dates),e("th",{scope:"col"},e("span",{class:"price-span"},(r=T.entries)===null||r===void 0?void 0:r.Lcz_Amount),e("ir-tooltip",{customSlot:true,message:`<span style="width:100%;display:block;">${(h=T.entries)===null||h===void 0?void 0:h.Lcz_BookingBalance}</span><span>${(c=T.entries)===null||c===void 0?void 0:c.Lcz_ClickToSettle}</span>`},e("span",{slot:"tooltip-trigger",class:"m-0 btn due-btn"},(d=T.entries)===null||d===void 0?void 0:d.Lcz_Balance))),this.showCost&&e("th",{scope:"col",class:"services-cell"},(u=T.entries)===null||u===void 0?void 0:u.Lcz_Cost),e("th",{scope:"col"},(f=T.entries)===null||f===void 0?void 0:f.Lcz_Status),e("th",{scope:"col"},e("p",{class:"sr-only"},"actions")))),e("tbody",{class:""},K.bookings.length===0&&e("tr",null,e("td",{colSpan:8},(g=T.entries)===null||g===void 0?void 0:g.Lcz_NoDataAvailable)),(p=K.bookings)===null||p===void 0?void 0:p.map((t=>{var i,o,n,a,l;let r=this.statusColors[t.is_requested_to_cancel?"003":t.status.code];const h=t.ota_manipulations?t.ota_manipulations[t.ota_manipulations.length-1]:null;const c=this.calculateTotalPersons(t);return e("tr",{key:t.booking_nbr},e("td",{class:"text-left"},e("ir-button",{btn_color:"link",btnStyle:{padding:"0",margin:"0"},onClickHandler:()=>this.editBookingItem={booking:t,cause:"edit"},text:t.booking_nbr}),t.channel_booking_nbr&&e("p",{class:"p-0 m-0 text-center secondary-p"},t.channel_booking_nbr)),e("td",null,e("p",{class:"p-0 m-0 date-p"},S(t.booked_on.date,"YYYY-MM-DD").format("DD-MMM-YYYY")),e("p",{class:"p-0 m-0 secondary-p"},V(t.booked_on.hour.toString(),t.booked_on.minute.toString()))),e("td",null,e("div",{class:"h-100 d-flex align-items-center ",style:{width:"max-content"}},e("img",{class:"mr-2 logo",src:t.origin.Icon,alt:t.origin.Label}),e("div",{class:"text-left"},e("div",{class:"d-flex align-items-center"},e("div",{class:"booking_name m-0 p-0"},e("ir-button",{btn_color:"link",onClickHandler:()=>this.editBookingItem={booking:t,cause:"guest"},text:`${t.guest.first_name} ${(i=t.guest.last_name)!==null&&i!==void 0?i:""}`,btnStyle:{width:"fit-content",padding:"0",margin:"0"},labelStyle:{padding:"0"}}),t.guest.nbr_confirmed_bookings>1&&!t.agent&&e("div",{class:"m-0 p-0"},e("ir-tooltip",{message:`${T.entries.Lcz_BookingsNbr}`.replace("%1",t.guest.nbr_confirmed_bookings.toString()),customSlot:true},e("div",{class:"d-flex align-items-center my-0 p-0",slot:"tooltip-trigger"},e("ir-icons",{style:{"--icon-size":"0.875rem"},color:"#FB0AAD",name:"heart-fill"})))),e("span",{class:"p-0 m-0"},c,T.entries.Lcz_P),_(t.extras)&&e("span",{class:"yellow_dot"}))),e("div",{class:"d-flex align-items-center booking-label-gap"},e("p",{class:"p-0 m-0 secondary-p"},t.origin.Label),t.is_in_loyalty_mode&&!t.promo_key&&e("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512",height:18,width:18},e("title",null,T.entries.Lcz_LoyaltyDiscountApplied),e("path",{fill:"#fc6c85",d:"M225.8 468.2l-2.5-2.3L48.1 303.2C17.4 274.7 0 234.7 0 192.8v-3.3c0-70.4 50-130.8 119.2-144C158.6 37.9 198.9 47 231 69.6c9 6.4 17.4 13.8 25 22.3c4.2-4.8 8.7-9.2 13.5-13.3c3.7-3.2 7.5-6.2 11.5-9c0 0 0 0 0 0C313.1 47 353.4 37.9 392.8 45.4C462 58.6 512 119.1 512 189.5v3.3c0 41.9-17.4 81.9-48.1 110.4L288.7 465.9l-2.5 2.3c-8.2 7.6-19 11.9-30.2 11.9s-22-4.2-30.2-11.9zM239.1 145c-.4-.3-.7-.7-1-1.1l-17.8-20c0 0-.1-.1-.1-.1c0 0 0 0 0 0c-23.1-25.9-58-37.7-92-31.2C81.6 101.5 48 142.1 48 189.5v3.3c0 28.5 11.9 55.8 32.8 75.2L256 430.7 431.2 268c20.9-19.4 32.8-46.7 32.8-75.2v-3.3c0-47.3-33.6-88-80.1-96.9c-34-6.5-69 5.4-92 31.2c0 0 0 0-.1 .1s0 0-.1 .1l-17.8 20c-.3 .4-.7 .7-1 1.1c-4.5 4.5-10.6 7-16.9 7s-12.4-2.5-16.9-7z"})),t.promo_key&&e("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",height:18,width:18},e("title",null,T.entries.Lcz_Coupon+":"+t.promo_key),e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M16.5 6v.75m0 3v.75m0 3v.75m0 3V18m-9-5.25h5.25M7.5 15h3M3.375 5.25c-.621 0-1.125.504-1.125 1.125v3.026a2.999 2.999 0 0 1 0 5.198v3.026c0 .621.504 1.125 1.125 1.125h17.25c.621 0 1.125-.504 1.125-1.125v-3.026a2.999 2.999 0 0 1 0-5.198V6.375c0-.621-.504-1.125-1.125-1.125H3.375Z"})))))),e("td",null,e("ul",null,t.rooms.map((t=>{var i,s,o,n,a,l,r;return e("li",null,e("div",{class:"room-service"},e("p",{class:"m-0 p-0"},t.roomtype.name),t.unit&&!N(t.roomtype.id)&&(((s=(i=t.unit)===null||i===void 0?void 0:i.name)===null||s===void 0?void 0:s.length)>4?e("ir-tooltip",{customSlot:true,message:(o=t.unit)===null||o===void 0?void 0:o.name},e("p",{class:"room-name-container cursor-pointer m-0",slot:"tooltip-trigger"},(a=(n=t.unit)===null||n===void 0?void 0:n.name)===null||a===void 0?void 0:a.substring(0,4))):e("p",{class:"room-name-container  m-0"},(r=(l=t.unit)===null||l===void 0?void 0:l.name)===null||r===void 0?void 0:r.substring(0,4)))))})),t.extra_services&&e("li",null,T.entries.Lcz_ExtraServices))),e("td",null,e("p",{class:"p-0 m-0 date-p"},S(t.from_date,"YYYY-MM-DD").format("DD-MMM-YYYY")),e("p",{class:"p-0 m-0 date-p"},S(t.to_date,"YYYY-MM-DD").format("DD-MMM-YYYY"))),e("td",null,e("p",{class:"p-0 m-0",style:{whiteSpace:"nowrap"}},C(t.currency.symbol,(n=(o=t.financial)===null||o===void 0?void 0:o.gross_total)!==null&&n!==void 0?n:0)),e(s,null,["003","004"].includes(t.status.code)?t.financial.cancelation_penality_as_if_today!==0&&e("button",{onClick:()=>{this.editBookingItem={booking:t,cause:"payment"};this.openModal()},style:{whiteSpace:"nowrap"},class:"btn p-0 m-0 due-btn"},e("span",null,t.financial.cancelation_penality_as_if_today<0?"Refund":"Charge"," "),C(t.currency.symbol,Math.abs(t.financial.cancelation_penality_as_if_today))):t.financial.due_amount!==0&&e("button",{onClick:()=>{this.editBookingItem={booking:t,cause:"payment"};this.openModal()},style:{whiteSpace:"nowrap"},class:"btn p-0 m-0 due-btn"},C(t.currency.symbol,t.financial.due_amount)))),this.showCost&&e("td",null,t.financial.gross_cost!==null&&t.financial.gross_cost===0?"_":C(t.currency.symbol,t.financial.gross_cost)),e("td",null,e("p",{class:`m-0 badge ${r} ct_ir_badge`},t.is_requested_to_cancel?(a=T===null||T===void 0?void 0:T.entries)===null||a===void 0?void 0:a.Lcz_CancellationRequested:t.status.description),!h&&((l=t.events)===null||l===void 0?void 0:l.length)>0&&t.events[0].type.toLowerCase()==="modified"&&e("p",{class:"mx-0 p-0 small",style:{marginTop:"0.25rem",marginBottom:"0"}},"Modified"),h&&e("ir-popover",{trigger:"hover",content:`Modified by ${h.user} at ${h.date} ${h.hour}:${h.minute}`},e("p",{class:"mx-0 p-0 small text-danger",style:{marginTop:"0.25rem",marginBottom:"0"}},e("b",null,"Modified")))),e("td",null,e("div",{class:"d-flex justify-content-center align-items-center",style:{gap:"8px"}},e("ir-button",{title:"Edit booking",variant:"icon",icon_name:"edit",onClickHandler:()=>this.editBookingItem={booking:t,cause:"edit"}}),e("ir-button",{title:"Delete booking",style:{"--icon-button-color":"#ff4961","--icon-button-hover-color":"#FF1635"},variant:"icon",icon_name:"trash",onClickHandler:()=>{this.editBookingItem={booking:t,cause:"delete"};this.openModal()}}))))})))),this.totalPages>1&&e("section",{class:"d-flex flex-column flex-md-row align-items-center justify-content-between pagination-container"},e("p",{class:"m-0 mb-1 mb-md-0"},this.renderItemRange()),e("div",{class:"d-flex align-items-center buttons-container"},e("ir-button",{size:"sm",btn_disabled:this.currentPage===1,onClickHandler:async()=>{this.currentPage=1;await this.updateData()},icon_name:"angles_left",style:{"--icon-size":"0.875rem"}}),e("ir-button",{size:"sm",btn_disabled:this.currentPage===1,onClickHandler:async()=>{this.currentPage=this.currentPage-1;await this.updateData()},icon_name:"angle_left",style:{"--icon-size":"0.875rem"}}),e("ir-select",{selectedValue:this.currentPage.toString(),showFirstOption:false,onSelectChange:async t=>{this.currentPage=+t.detail;await this.updateData()},data:Array.from(Array(this.totalPages),((t,i)=>i+1)).map((t=>({text:t.toString(),value:t.toString()})))}),e("ir-button",{size:"sm",btn_disabled:this.currentPage===this.totalPages,onClickHandler:async()=>{this.currentPage=this.currentPage+1;await this.updateData()},icon_name:"angle_right",style:{"--icon-size":"0.875rem"}}),e("ir-button",{size:"sm",btn_disabled:this.currentPage===this.totalPages,onClickHandler:async()=>{this.currentPage=this.totalPages;console.log(this.currentPage);await this.updateData()},icon_name:"angles_right",style:{"--icon-size":"0.875rem"}})))))),this.editBookingItem&&e("ir-listing-modal",{paymentEntries:this.paymentEntries,onModalClosed:()=>this.editBookingItem=null}),e("ir-sidebar",{onIrSidebarToggle:this.handleSideBarToggle.bind(this),open:this.editBookingItem!==null&&["edit","guest"].includes(this.editBookingItem.cause),showCloseButton:false,sidebarStyles:((b=this.editBookingItem)===null||b===void 0?void 0:b.cause)==="guest"?{background:"white"}:{width:this.editBookingItem?"80rem":"var(--sidebar-width,40rem)",background:"#F2F3F8"}},((m=this.editBookingItem)===null||m===void 0?void 0:m.cause)==="edit"&&e("ir-booking-details",{slot:"sidebar-body",p:this.p,hasPrint:true,hasReceipt:true,is_from_front_desk:true,propertyid:this.propertyid,hasRoomEdit:true,hasRoomDelete:true,hasCloseButton:true,onCloseSidebar:()=>this.editBookingItem=null,bookingNumber:this.editBookingItem.booking.booking_nbr,ticket:this.ticket,language:this.language,hasRoomAdd:true}),((v=this.editBookingItem)===null||v===void 0?void 0:v.cause)==="guest"&&e("ir-guest-info",{slot:"sidebar-body",isInSideBar:true,headerShown:true,booking_nbr:(k=(y=this.editBookingItem)===null||y===void 0?void 0:y.booking)===null||k===void 0?void 0:k.booking_nbr,email:(D=(w=this.editBookingItem)===null||w===void 0?void 0:w.booking)===null||D===void 0?void 0:D.guest.email,language:this.language,onCloseSideBar:()=>this.editBookingItem=null})))}get el(){return n(this)}static get watchers(){return{ticket:["ticketChanged"]}}};ft.style=ut;class gt{async getExposedProperty(t){var i,e;try{const{data:s}=await z.post(`/Get_Exposed_Property`,t);if(s.ExceptionMsg!==""){throw new Error(s.ExceptionMsg)}const o=s.My_Result;A.adultChildConstraints=o.adult_child_constraints;A.allowedBookingSources=o.allowed_booking_sources;A.allowed_payment_methods=o.allowed_payment_methods;A.currency=o.currency;A.is_vacation_rental=o.is_vacation_rental;A.pickup_service=o.pickup_service;A.max_nights=o.max_nights;A.roomsInfo=o.roomtypes;A.taxes=o.taxes;A.id=o.id;A.country=o.country;A.name=o.name;A.is_automatic_check_in_out=o.is_automatic_check_in_out;A.tax_statement=o.tax_statement;A.is_frontdesk_enabled=o.is_frontdesk_enabled;A.is_pms_enabled=o.is_pms_enabled;const n=(e=(i=o===null||o===void 0?void 0:o.time_constraints)===null||i===void 0?void 0:i.check_out_till)===null||e===void 0?void 0:e.split(":");A.checkin_checkout_hours={offset:o.city.gmt_offset,hour:Number(n[0]||0),minute:Number(n[1]||0)};return s}catch(t){console.log(t);throw new Error(t)}}async getCountrySales(t){const{data:i}=await z.post("/Get_Country_Sales",t);if(i.ExceptionMsg!==""){throw new Error(i.ExceptionMsg)}if(t.is_export_to_excel){M(i.My_Params_Get_Country_Sales.Link_excel)}return i.My_Result}async getDailyRevenueReport(t){const{data:i}=await z.post("/Get_Daily_Revenue_Report",t);if(i.ExceptionMsg!==""){throw new Error(i.ExceptionMsg)}if(t.is_export_to_excel){M(i.My_Params_Get_Daily_Revenue_Report.Link_excel)}return i.My_Result}async setExposedCleaningFrequency(t){const{data:i}=await z.post("/Set_Exposed_Cleaning_Frequency",t);if(i.ExceptionMsg!==""){throw new Error(i.ExceptionMsg)}return i.My_Result}async getMonthlyStats(t){const{data:i}=await z.post("/Get_Monthly_Stats",t);if(i.ExceptionMsg!==""){throw new Error(i.ExceptionMsg)}if(t.is_export_to_excel){M(i.My_Params_Get_Monthly_Stats.Link_excel)}return i.My_Result}}const pt=".sc-ir-daily-revenue-h{display:block}.daily-revenue__meta.sc-ir-daily-revenue{display:flex;flex-direction:column;gap:1rem}.daily-revenue__table.sc-ir-daily-revenue{flex:1 1 0%}@media (min-width: 768px){.daily-revenue__meta.sc-ir-daily-revenue{flex-direction:row}}";const bt=pt;const mt=class{constructor(e){t(this,e);this.preventPageLoad=i(this,"preventPageLoad",7);this.language="";this.ticket="";this.filters={date:S().format("YYYY-MM-DD"),users:null};this.tokenService=new P;this.roomService=new a;this.propertyService=new gt;this.bookingService=new l;this.handleSidebarClose=t=>{t.stopImmediatePropagation();t.stopPropagation();this.sideBarEvent=null}}componentWillLoad(){if(this.ticket){this.tokenService.setToken(this.ticket);this.initializeApp()}}ticketChanged(t,i){if(t===i){return}this.tokenService.setToken(this.ticket);this.initializeApp()}handleOpenSidebar(t){t.stopImmediatePropagation();t.stopPropagation();this.sideBarEvent=t.detail}handleFetchNewReports(t){t.stopImmediatePropagation();t.stopPropagation();this.filters=Object.assign({},t.detail);this.getPaymentReports()}async handleResetBooking(t){t.stopPropagation();t.stopImmediatePropagation();this.getPaymentReports(false,true)}renderSidebarBody(){if(!this.sideBarEvent){return}switch(this.sideBarEvent.type){case"booking":return e("ir-booking-details",{slot:"sidebar-body",hasPrint:true,hasReceipt:true,hasCloseButton:true,onCloseSidebar:this.handleSidebarClose,is_from_front_desk:true,propertyid:this.property_id,hasRoomEdit:true,hasRoomDelete:true,bookingNumber:this.sideBarEvent.payload.bookingNumber.toString(),ticket:this.ticket,language:this.language,hasRoomAdd:true});default:return null}}async initializeApp(){this.isPageLoading=true;try{let t=this.propertyid;if(!t&&!this.p){throw new Error("Property ID or username is required")}if(!t){const i=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});t=i.My_Result.id}this.property_id=t;const i=[this.bookingService.getSetupEntriesByTableNameMulti(["_PAY_TYPE","_PAY_TYPE_GROUP","_PAY_METHOD"]),this.getPaymentReports(),this.roomService.fetchLanguage(this.language)];if(t){i.push(this.roomService.getExposedProperty({id:t,language:this.language,is_backend:true,include_units_hk_status:true}))}const[e]=await Promise.all(i);const{pay_type:s,pay_type_group:o,pay_method:n}=this.bookingService.groupEntryTablesResult(e);this.paymentEntries={groups:o,methods:n,types:s}}catch(t){console.log(t)}finally{this.isPageLoading=false}}groupPaymentsByName(t){var i;const e=new Map;for(const s of t){const t=`${s.payTypeCode}_${s.payMethodCode}`;const o=(i=e.get(t))!==null&&i!==void 0?i:[];e.set(t,[...o,s])}return new Map([...e.entries()].sort((([t],[i])=>{const e=Number(t);const s=Number(i);if(!isNaN(e)&&!isNaN(s)){return e-s}return t.localeCompare(i)})))}async getPaymentReports(t=false,i=false){var e,s,o,n;try{const a=t=>({method:t.METHOD,payTypeCode:t.PAY_TYPE_CODE,payMethodCode:t.PAY_METHOD_CODE,amount:t.AMOUNT,date:t.DATE,hour:t.HOUR,minute:t.MINUTE,user:t.USER,currency:t.CURRENCY,bookingNbr:t.BOOKING_NBR,id:L()});this.isLoading=t?"export":"filter";const l=[this.propertyService.getDailyRevenueReport({date:this.filters.date,property_id:(e=this.property_id)===null||e===void 0?void 0:e.toString(),is_export_to_excel:t})];if(!t&&!i){l.push(this.propertyService.getDailyRevenueReport({date:S(this.filters.date,"YYYY-MM-DD").add(-1,"days").format("YYYY-MM-DD"),property_id:(s=this.property_id)===null||s===void 0?void 0:s.toString(),is_export_to_excel:t}))}const r=await Promise.all(l);if(!t){if(r[0]){this.groupedPayment=this.groupPaymentsByName((o=r[0])===null||o===void 0?void 0:o.map(a))}else{this.groupedPayment=new Map}if(r[1])this.previousDateGroupedPayments=this.groupPaymentsByName((n=r[1])===null||n===void 0?void 0:n.map(a))}}catch(t){console.log(t)}finally{this.isLoading=null}}render(){var t,i,s;if(this.isPageLoading){return e("ir-loading-screen",null)}return e(o,null,e("ir-toast",null),e("ir-interceptor",null),e("section",{class:"p-2 d-flex flex-column",style:{gap:"1rem"}},e("div",{class:"d-flex align-items-center justify-content-between"},e("h3",{class:"mb-1 mb-md-0"},"Daily Revenue"),e("ir-button",{size:"sm",btn_color:"outline",isLoading:this.isLoading==="export",text:(t=T.entries)===null||t===void 0?void 0:t.Lcz_Export,onClickHandler:async t=>{t.stopImmediatePropagation();t.stopPropagation();await this.getPaymentReports(true)},btnStyle:{height:"100%"},iconPosition:"right",icon_name:"file",icon_style:{"--icon-size":"14px"}})),e("ir-revenue-summary",{previousDateGroupedPayments:this.previousDateGroupedPayments,groupedPayments:this.groupedPayment,paymentEntries:this.paymentEntries}),e("div",{class:"daily-revenue__meta"},e("ir-daily-revenue-filters",{isLoading:this.isLoading==="filter",payments:this.groupedPayment}),e("ir-revenue-table",{filters:this.filters,class:"daily-revenue__table",paymentEntries:this.paymentEntries,payments:this.groupedPayment}))),e("ir-sidebar",{sidebarStyles:{width:((i=this.sideBarEvent)===null||i===void 0?void 0:i.type)==="booking"?"80rem":"var(--sidebar-width,40rem)",background:((s=this.sideBarEvent)===null||s===void 0?void 0:s.type)==="booking"?"#F2F3F8":"white"},open:Boolean(this.sideBarEvent),showCloseButton:false,onIrSidebarToggle:this.handleSidebarClose},this.renderSidebarBody()))}static get watchers(){return{ticket:["ticketChanged"]}}};mt.style=bt;const vt=".sc-ir-hk-tasks-h{display:block;box-sizing:border-box}.sc-ir-hk-tasks-h *.sc-ir-hk-tasks{box-sizing:border-box}.tasks-view.sc-ir-hk-tasks{display:flex;flex-direction:column}@media (min-width: 1024px){.tasks-view.sc-ir-hk-tasks{flex-direction:row}}";const _t=vt;const yt=class{constructor(e){t(this,e);this.clearSelectedHkTasks=i(this,"clearSelectedHkTasks",7);this.language="";this.ticket="";this.isLoading=false;this.isCleaningLoading=false;this.selectedDuration="";this.selectedHouseKeeper="0";this.selectedRoom=null;this.archiveOpened=false;this.hkNameCache={};this.roomService=new a;this.houseKeepingService=new H;this.token=new P;this.table_sorting=new Map}componentWillLoad(){if(this.baseUrl){this.token.setBaseUrl(this.baseUrl)}if(this.ticket!==""){this.token.setToken(this.ticket);this.init()}}ticketChanged(t,i){if(t===i){return}this.token.setToken(this.ticket);this.init()}handleCloseSidebar(t){t.stopImmediatePropagation();t.stopPropagation();this.isSidebarOpen=false}handleSortingChanged(t){t.stopImmediatePropagation();t.stopPropagation();const{field:i,direction:e}=t.detail;console.log(t.detail);if(i==="date"){return}this.table_sorting.set(i,e)}handleSkipSelectedTask(t){var i;t.stopImmediatePropagation();t.stopPropagation();this.modalCauses={task:t.detail,cause:"skip"};(i=this.modal)===null||i===void 0?void 0:i.openModal()}async init(){var t,i,e,s,o,n,a;try{this.isLoading=true;J(true);let l=this.propertyid;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}if(!l){console.log(l);const t=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});l=t.My_Result.id}this.property_id=l;const r=[this.houseKeepingService.getExposedHKSetup(this.property_id),this.roomService.fetchLanguage(this.language)];if(this.propertyid){r.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true,include_units_hk_status:true}))}await Promise.all(r);const h=await this.houseKeepingService.getHkTasks({property_id:this.property_id,from_date:S().format("YYYY-MM-DD"),to_date:S().format("YYYY-MM-DD"),housekeepers:[],cleaning_frequency:(e=(t=A.cleaning_frequency)!==null&&t!==void 0?t:(i=F===null||F===void 0?void 0:F.hk_criteria)===null||i===void 0?void 0:i.cleaning_frequencies[0])===null||e===void 0?void 0:e.code,dusty_window:(o=(s=F===null||F===void 0?void 0:F.hk_criteria)===null||s===void 0?void 0:s.dusty_periods[0])===null||o===void 0?void 0:o.code,highlight_window:(a=(n=F===null||F===void 0?void 0:F.hk_criteria)===null||n===void 0?void 0:n.highlight_checkin_options[0])===null||a===void 0?void 0:a.code});if(h===null||h===void 0?void 0:h.tasks){this.updateTasks(h.tasks)}}catch(t){console.log(t)}finally{this.isLoading=false;J(false)}}buildHousekeeperNameCache(){var t,i;this.hkNameCache={};(i=(t=F.hk_criteria)===null||t===void 0?void 0:t.housekeepers)===null||i===void 0?void 0:i.forEach((t=>{if(t.id!=null&&t.name!=null){this.hkNameCache[t.id]=t.name}}))}updateTasks(t){this.buildHousekeeperNameCache();Q(t.map((t=>Object.assign(Object.assign({},t),{id:L(),housekeeper:(()=>{var i,e,s;const o=this.hkNameCache[t.hkm_id];if(o){return o}const n=(s=(e=(i=F.hk_criteria)===null||i===void 0?void 0:i.housekeepers)===null||e===void 0?void 0:e.find((i=>i.id===t.hkm_id)))===null||s===void 0?void 0:s.name;this.hkNameCache[t.hkm_id]=n;return n})()}))))}async handleHeaderButtonPress(t){var i;t.stopImmediatePropagation();t.stopPropagation();const{name:e}=t.detail;switch(e){case"cleaned":case"clean-inspect":(i=this.modal)===null||i===void 0?void 0:i.openModal();this.modalCauses={task:null,cause:"clean",status:e==="clean-inspect"?"004":"001"};break;case"export":const t=Array.from(this.table_sorting.entries()).map((([t,i])=>({key:t,value:i})));console.log(t);const{url:s}=await this.fetchTasksWithFilters(true);M(s);break;case"archive":this.isSidebarOpen=true;break}}handleSelectedTaskCleaningEvent(t){var i;t.stopImmediatePropagation();t.stopPropagation();this.modalCauses=Object.assign(Object.assign({},t.detail),{cause:"clean"});(i=this.modal)===null||i===void 0?void 0:i.openModal()}async handleModalConfirmation(t){var i;try{t.stopImmediatePropagation();t.stopPropagation();if(X.selectedTasks.length===0){return}this.isCleaningLoading=true;if(((i=this.modalCauses)===null||i===void 0?void 0:i.cause)==="skip"){const{booking_nbr:t,date:i,unit:e}=this.modalCauses.task;await this.houseKeepingService.editHkSkip({BOOK_NBR:t,DATE:i,COMMENT:"",HK_SKIP_ID:-1,HK_SKIP_REASON_CODE:"001",PR_ID:e.id})}else{await this.houseKeepingService.executeHKAction({actions:X.selectedTasks.map((t=>{var i,e;return{description:"Cleaned",hkm_id:t.hkm_id===0?null:t.hkm_id,unit_id:t.unit.id,booking_nbr:t.booking_nbr,status:(e=(i=this.modalCauses)===null||i===void 0?void 0:i.status)!==null&&e!==void 0?e:"001"}}))})}await this.fetchTasksWithFilters()}finally{Z();if(this.modalCauses){this.modalCauses=null}this.isCleaningLoading=false;this.modal.closeModal()}}async applyFilters(t){try{this.isApplyFiltersLoading=true;t.stopImmediatePropagation();t.stopPropagation();this.filters=Object.assign({},t.detail);await this.fetchTasksWithFilters()}catch(t){console.log(t)}finally{this.isApplyFiltersLoading=false}}async fetchTasksWithFilters(t=false){var i;const{cleaning_periods:e,housekeepers:s,cleaning_frequencies:o,dusty_units:n,highlight_check_ins:a}=(i=this.filters)!==null&&i!==void 0?i:{};const{tasks:l,url:r}=await this.houseKeepingService.getHkTasks({housekeepers:s,cleaning_frequency:o===null||o===void 0?void 0:o.code,dusty_window:n===null||n===void 0?void 0:n.code,highlight_window:a===null||a===void 0?void 0:a.code,property_id:this.property_id,from_date:S().format("YYYY-MM-DD"),to_date:(e===null||e===void 0?void 0:e.code)||S().format("YYYY-MM-DD"),is_export_to_excel:t});console.log(l);if(l){this.updateTasks(l)}return{tasks:l,url:r}}render(){var t,i,s,n;if(this.isLoading){return e("ir-loading-screen",null)}return e(o,{"data-testid":"hk_tasks_base"},e("ir-toast",null),e("ir-interceptor",null),e("section",{class:"p-1 d-flex flex-column",style:{gap:"1rem"}},e("h3",null,"Housekeeping Tasks"),e("div",{class:"tasks-view ",style:{gap:"1rem"}},e("ir-tasks-filters",{isLoading:this.isApplyFiltersLoading,onApplyFilters:t=>{this.applyFilters(t)}}),e("div",{class:"d-flex w-100 flex-column",style:{gap:"1rem"}},e("ir-tasks-table",{onRowSelectChange:t=>{t.stopImmediatePropagation();t.stopPropagation();tt(t.detail)},class:"flex-grow-1 w-100"})))),e("ir-modal",{autoClose:false,ref:t=>this.modal=t,isLoading:this.isCleaningLoading,onConfirmModal:this.handleModalConfirmation.bind(this),onCancelModal:()=>{if(this.modalCauses){Z();this.modalCauses=null}},iconAvailable:true,icon:"ft-alert-triangle danger h1",leftBtnText:T.entries.Lcz_Cancel,rightBtnText:T.entries.Lcz_Confirm,leftBtnColor:"secondary",rightBtnColor:"primary",modalTitle:T.entries.Lcz_Confirmation,modalBody:this.modalCauses?((t=this.modalCauses)===null||t===void 0?void 0:t.cause)==="clean"?this.modalCauses.task?`Update ${(n=(s=(i=this.modalCauses)===null||i===void 0?void 0:i.task)===null||s===void 0?void 0:s.unit)===null||n===void 0?void 0:n.name} to Clean`:"Update selected unit(s) to Clean":"Skip cleaning and reschedule for tomorrow.":"Update selected unit(s) to Clean"}),e("ir-sidebar",{open:this.isSidebarOpen,id:"editGuestInfo",onIrSidebarToggle:t=>{t.stopImmediatePropagation();t.stopPropagation();this.isSidebarOpen=false},showCloseButton:false},this.isSidebarOpen&&e("ir-hk-archive",{ticket:this.token.getToken(),propertyId:this.property_id,slot:"sidebar-body"})))}get el(){return n(this)}static get watchers(){return{ticket:["ticketChanged"]}}};yt.style=_t;const kt=".sc-ir-housekeeping-h{display:block}";const wt=kt;const Dt=class{constructor(e){t(this,e);this.toast=i(this,"toast",7);this.language="";this.ticket="";this.isLoading=false;this.roomService=new a;this.houseKeepingService=new H;this.propertyService=new gt;this.token=new P}componentWillLoad(){if(this.baseUrl){this.token.setBaseUrl(this.baseUrl)}if(this.ticket!==""){this.token.setToken(this.ticket);this.initializeApp()}}async handleResetData(t){t.stopImmediatePropagation();t.stopPropagation();await this.houseKeepingService.getExposedHKSetup(this.propertyid)}ticketChanged(t,i){if(t===i){return}this.token.setToken(this.ticket);this.initializeApp()}async initializeApp(){var t;try{this.isLoading=true;let i=this.propertyid;if(!i){const t=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_sales_rate_plans:true});i=t.My_Result.id}U("default_properties",{token:this.ticket,property_id:i,language:this.language});const e=[];if(A.housekeeping_enabled){e.push(this.houseKeepingService.getExposedHKSetup(i))}e.push(this.roomService.fetchLanguage(this.language,["_HK_FRONT","_PMS_FRONT"]));if(this.propertyid){e.push(this.roomService.getExposedProperty({id:i,language:this.language,is_backend:true,include_sales_rate_plans:true}))}await Promise.all(e);this.selectedCleaningFrequency=(t=A.cleaning_frequency)===null||t===void 0?void 0:t.code}catch(t){console.error(t)}finally{this.isLoading=false}}async saveAutomaticCheckInCheckout(t){t.stopImmediatePropagation();t.stopPropagation();try{await this.roomService.SetAutomaticCheckInOut({property_id:F.default_properties.property_id,flag:t.detail==="auto"});this.toast.emit({position:"top-right",title:"Saved Successfully",description:"",type:"success"})}catch(t){console.log(t)}}async saveCleaningFrequency(t){t.stopImmediatePropagation();t.stopPropagation();try{await this.propertyService.setExposedCleaningFrequency({property_id:F.default_properties.property_id,code:this.selectedCleaningFrequency});A.cleaning_frequency={code:this.selectedCleaningFrequency,description:""};this.toast.emit({position:"top-right",title:"Saved Successfully",description:"",type:"success"});this.modal.closeModal()}catch(t){console.log(t)}}render(){var t;if(this.isLoading){return e("ir-loading-screen",null)}console.log(A.cleaning_frequency);return e(o,null,e("ir-interceptor",null),e("ir-toast",null),e("section",{class:"p-1"},e("h3",{class:"mb-2"},T.entries.Lcz_HouseKeepingAndCheckInSetup),e("div",{class:"card p-1"},e("ir-title",{borderShown:true,label:"Operations Settings"}),e("div",{class:"d-flex align-items-center mb-1"},e("p",{class:"my-0 py-0 mr-1"},T.entries.Lcz_CheckInOutGuestsAutomatically),e("ir-select",{showFirstOption:false,selectedValue:A.is_automatic_check_in_out?"auto":"manual",onSelectChange:t=>this.saveAutomaticCheckInCheckout(t),data:[{text:T.entries.Lcz_YesAsPerPropertyPolicy,value:"auto"},{text:T.entries.Lcz_NoIWillDoItManually,value:"manual"}]})),e("div",{class:"d-flex align-items-center"},e("p",{class:"my-0 py-0 mr-1"},T.entries.Lcz_CleaningFrequency,":"),e("ir-select",{showFirstOption:false,selectedValue:this.selectedCleaningFrequency,onSelectChange:t=>{t.stopImmediatePropagation();t.stopPropagation();this.selectedCleaningFrequency=t.detail;this.modal.openModal()},data:(t=F===null||F===void 0?void 0:F.hk_criteria)===null||t===void 0?void 0:t.cleaning_frequencies.map((t=>({text:t.description,value:t.code})))}))),A.housekeeping_enabled&&e("ir-hk-team",{class:"mb-1"}),e("ir-modal",{autoClose:false,ref:t=>this.modal=t,isLoading:it("/Set_Exposed_Cleaning_Frequency"),onConfirmModal:this.saveCleaningFrequency.bind(this),iconAvailable:true,onCancelModal:()=>{var t;this.selectedCleaningFrequency=(t=A.cleaning_frequency)===null||t===void 0?void 0:t.code},icon:"ft-alert-triangle danger h1",leftBtnText:T.entries.Lcz_Cancel,rightBtnText:T.entries.Lcz_Confirm,leftBtnColor:"secondary",rightBtnColor:"primary",modalTitle:T.entries.Lcz_Confirmation,modalBody:"This action will reschedule all cleaning tasks. Do you want to continue?"})))}static get watchers(){return{ticket:["ticketChanged"]}}};Dt.style=wt;const Ot=".sc-ir-monthly-bookings-report-h{display:block}";const Yt=Ot;var Ct=undefined&&undefined.__rest||function(t,i){var e={};for(var s in t)if(Object.prototype.hasOwnProperty.call(t,s)&&i.indexOf(s)<0)e[s]=t[s];if(t!=null&&typeof Object.getOwnPropertySymbols==="function")for(var o=0,s=Object.getOwnPropertySymbols(t);o<s.length;o++){if(i.indexOf(s[o])<0&&Object.prototype.propertyIsEnumerable.call(t,s[o]))e[s[o]]=t[s[o]]}return e};const Mt=class{constructor(i){t(this,i);this.language="";this.ticket="";this.isPageLoading=true;this.isLoading=null;this.reports=[];this.tokenService=new P;this.roomService=new a;this.propertyService=new gt}componentWillLoad(){this.baseFilters={date:{description:S().format("MMMM YYYY"),firstOfMonth:S().startOf("month").format("YYYY-MM-DD"),lastOfMonth:S().endOf("month").format("YYYY-MM-DD")},include_previous_year:false};this.filters=this.baseFilters;if(this.ticket){this.tokenService.setToken(this.ticket);this.init()}}handleTicketChange(t,i){if(t!==i){this.tokenService.setToken(this.ticket);this.init()}}handleApplyFiltersChange(t){t.stopImmediatePropagation();t.stopPropagation();this.filters=t.detail;this.getReports()}async init(){try{let t=this.propertyid;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}if(!t){console.log(t);const i=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});t=i.My_Result.id}this.property_id=t;const i=[this.roomService.fetchLanguage(this.language),this.getReports()];if(this.propertyid){i.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true,include_units_hk_status:true}))}await Promise.all(i)}catch(t){console.log(t)}finally{this.isPageLoading=false}}async getReports(t=false){try{const i=t=>({day:t.Date,units_booked:t.Units_booked,occupancy_percent:t.Occupancy,adr:t.ADR,rooms_revenue:t.Rooms_Revenue,total_guests:t===null||t===void 0?void 0:t.Total_Guests});this.isLoading=t?"export":"filter";const{date:e,include_previous_year:s}=this.filters;const o=[this.propertyService.getMonthlyStats({from_date:e.firstOfMonth,to_date:e.lastOfMonth,property_id:this.property_id,is_export_to_excel:t})];if(s){o.push(this.propertyService.getMonthlyStats({from_date:S(e.firstOfMonth,"YYYY-MM-DD").add(-1,"year").format("YYYY-MM-DD"),to_date:S(e.lastOfMonth,"YYYY-MM-DD").add(-1,"years").format("YYYY-MM-DD"),property_id:this.property_id}))}const n=await Promise.all(o);const a=n[0];let l=[];const{DailyStats:r}=a,h=Ct(a,["DailyStats"]);this.stats=Object.assign({},h);if(s&&n[t?0:1]){const e=n[t?0:1];let s=e.DailyStats.map(i);l=r.map(i).map((t=>{const i=s.find((i=>i.day===S(t.day,"YYYY-MM-DD").add(-1,"years").format("YYYY-MM-DD")));return Object.assign(Object.assign({},t),{last_year:i!==null&&i!==void 0?i:null})}))}else{l=r.map(i)}this.reports=[...l]}catch(t){console.log(t)}finally{this.isLoading=null}}render(){var t,i,s,n,a,l,r,h,c,d,u,f,g;if(this.isPageLoading){return e("ir-loading-screen",null)}return e(o,null,e("ir-toast",null),e("ir-interceptor",null),e("section",{class:"p-2 d-flex flex-column",style:{gap:"1rem"}},e("div",{class:"d-flex align-items-center justify-content-between"},e("h3",{class:"mb-1 mb-md-0"},"Daily Occupancy"),e("ir-button",{size:"sm",btn_color:"outline",isLoading:this.isLoading==="export",text:(t=T.entries)===null||t===void 0?void 0:t.Lcz_Export,onClickHandler:async t=>{t.stopImmediatePropagation();t.stopPropagation();await this.getReports(true)},btnStyle:{height:"100%"},iconPosition:"right",icon_name:"file",icon_style:{"--icon-size":"14px"}})),e("section",null,e("div",{class:"d-flex flex-column flex-md-row w-100",style:{gap:"1rem",alignItems:"stretch"}},e("ir-stats-card",{icon:((i=this.stats)===null||i===void 0?void 0:i.Occupancy_Difference_From_Previous_Month)<0?"arrow-trend-down":"arrow-trend-up",cardTitle:"Average Occupancy",value:this.stats.AverageOccupancy?((s=this.stats)===null||s===void 0?void 0:s.AverageOccupancy.toFixed(2))+"%":null,subtitle:`${((n=this.stats)===null||n===void 0?void 0:n.Occupancy_Difference_From_Previous_Month)<0?"":"+"}${(a=this.stats)===null||a===void 0?void 0:a.Occupancy_Difference_From_Previous_Month.toFixed(2)}% from last month`}),e("ir-stats-card",{icon:"hotel",cardTitle:"Total Units",value:((l=this.stats)===null||l===void 0?void 0:l.TotalUnitsBooked)?(r=this.stats)===null||r===void 0?void 0:r.TotalUnitsBooked.toString():null,subtitle:"Booked"}),e("ir-stats-card",{icon:"user_group",cardTitle:"Total Guests",value:(c=(h=this.stats)===null||h===void 0?void 0:h.Total_Guests)===null||c===void 0?void 0:c.toString(),subtitle:"Stayed"}),e("ir-stats-card",{icon:"calendar",cardTitle:"Peak Days",value:((d=this.stats)===null||d===void 0?void 0:d.PeakDays.length)===0?null:(f=(u=this.stats)===null||u===void 0?void 0:u.PeakDays)===null||f===void 0?void 0:f.map((t=>S(t.Date,"YYYY-MM-DD").format("D").concat("th"))).join(" - "),subtitle:`${Math.max(...((g=this.stats.PeakDays)===null||g===void 0?void 0:g.map((t=>t.OccupancyPercent)))||[])}% occupancy`})),e("div",{class:"d-flex flex-column flex-lg-row mt-1 ",style:{gap:"1rem"}},e("ir-monthly-bookings-report-filter",{isLoading:this.isLoading==="filter",class:"filters-card",baseFilters:this.baseFilters}),e("ir-monthly-bookings-report-table",{reports:this.reports})))))}static get watchers(){return{ticket:["handleTicketChange"]}}};Mt.style=Yt;const xt=".sc-ir-sales-by-country-h{display:block}";const Et=xt;var St=undefined&&undefined.__rest||function(t,i){var e={};for(var s in t)if(Object.prototype.hasOwnProperty.call(t,s)&&i.indexOf(s)<0)e[s]=t[s];if(t!=null&&typeof Object.getOwnPropertySymbols==="function")for(var o=0,s=Object.getOwnPropertySymbols(t);o<s.length;o++){if(i.indexOf(s[o])<0&&Object.prototype.propertyIsEnumerable.call(t,s[o]))e[s[o]]=t[s[o]]}return e};const jt=class{constructor(i){t(this,i);this.language="";this.ticket="";this.isLoading=null;this.isPageLoading=true;this.countries=new Map;this.token=new P;this.roomService=new a;this.propertyService=new gt;this.bookingService=new l;this.baseFilters={FROM_DATE:S().add(-7,"days").format("YYYY-MM-DD"),TO_DATE:S().format("YYYY-MM-DD"),BOOK_CASE:"001",WINDOW:7,include_previous_year:false}}componentWillLoad(){this.salesFilters=this.baseFilters;if(this.ticket){this.token.setToken(this.ticket);this.initializeApp()}}ticketChanged(t,i){if(t===i){return}this.token.setToken(this.ticket);this.initializeApp()}async initializeApp(){try{let t=this.propertyid;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}if(!t){console.log(t);const i=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});t=i.My_Result.id}this.property_id=t;const i=[this.bookingService.getCountries(this.language),this.roomService.fetchLanguage(this.language),this.getCountrySales()];if(this.propertyid){i.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true,include_units_hk_status:true}))}const[e]=await Promise.all(i);const s=new Map;e.map((t=>{s.set(t.id,{flag:t.flag,name:t.name})}));this.countries=s}catch(t){console.log(t)}finally{this.isPageLoading=false}}async getCountrySales(t=false){const i=t=>({country:t.COUNTRY,country_id:t.COUNTRY_ID,nights:t.NIGHTS,percentage:t.PCT,revenue:t.REVENUE,number_of_guests:t.Total_Guests});try{const e=this.salesFilters,{include_previous_year:s}=e,o=St(e,["include_previous_year"]);this.isLoading=t?"export":"filter";const n=await this.propertyService.getCountrySales(Object.assign({AC_ID:this.property_id,is_export_to_excel:t},o));const a=!t&&s;let l=[];if(a){const t=await this.propertyService.getCountrySales(Object.assign(Object.assign({AC_ID:this.property_id,is_export_to_excel:false},o),{FROM_DATE:S(o.FROM_DATE).subtract(1,"year").format("YYYY-MM-DD"),TO_DATE:S(o.TO_DATE).subtract(1,"year").format("YYYY-MM-DD")}));l=n.map((e=>{const s=t.find((t=>t.COUNTRY.toLowerCase()===e.COUNTRY.toLowerCase()));return Object.assign(Object.assign({id:L()},i(e)),{last_year:s?i(s):null})}))}else{l=n.map((t=>Object.assign(Object.assign({id:L()},i(t)),{last_year:null})))}this.salesData=[...l]}catch(t){console.error("Failed to fetch sales data:",t)}finally{this.isLoading=null}}render(){if(this.isPageLoading){return e("ir-loading-screen",null)}return e(o,null,e("ir-toast",null),e("ir-interceptor",null),e("section",{class:"p-2 d-flex flex-column",style:{gap:"1rem"}},e("div",{class:"d-flex align-items-center justify-content-between"},e("h3",{class:"mb-1 mb-md-0"},"Sales by Country"),e("ir-button",{size:"sm",btn_color:"outline",isLoading:this.isLoading==="export",text:T.entries.Lcz_Export,onClickHandler:async t=>{t.stopImmediatePropagation();t.stopPropagation();await this.getCountrySales(true)},btnStyle:{height:"100%"},iconPosition:"right",icon_name:"file",icon_style:{"--icon-size":"14px"}})),e("ir-sales-by-country-summary",{salesReports:this.salesData}),e("div",{class:"d-flex flex-column flex-lg-row mt-1 ",style:{gap:"1rem"}},e("ir-sales-filters",{isLoading:this.isLoading==="filter",onApplyFilters:t=>{t.stopImmediatePropagation();t.stopPropagation();this.salesFilters=t.detail;this.getCountrySales()},class:"filters-card",baseFilters:this.baseFilters}),e("ir-sales-table",{mappedCountries:this.countries,class:"card mb-0",records:this.salesData}))))}static get watchers(){return{ticket:["ticketChanged"]}}};jt.style=Et;export{at as igloo_calendar,ht as ir_booking_email_logs,ft as ir_booking_listing,mt as ir_daily_revenue,yt as ir_hk_tasks,Dt as ir_housekeeping,Mt as ir_monthly_bookings_report,jt as ir_sales_by_country};
//# sourceMappingURL=p-09ca4c82.entry.js.map