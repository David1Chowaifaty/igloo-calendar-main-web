{"version":3,"names":["irUnbookableRoomsCss","IrUnbookableRoomsStyle0","IrUnbookableRooms","ticket","propertyid","mode","period_to_check","consecutive_period","isLoading","errorMessage","unbookableRooms","allowedProperties","filters","country","progressFilters","lastUpdatedLabel","isPageLoading","tokenService","Token","propertyService","PropertyService","componentWillLoad","this","normalizePositiveNumber","setToken","initializeApp","ticketChanged","newValue","oldValue","modeChanged","propertyIdChanged","resolveMode","periodToCheckChanged","consecutivePeriodChanged","value","fallback","parsed","Number","isFinite","Math","floor","getExposedAllowedProperties","fetchUnbookableRooms","error","console","propertyIds","getPropertyIds","length","results","fetchUnBookableRooms","property_ids","Date","toLocaleTimeString","hour","minute","map","property","id","propertyId","handleFiltersChange","event","detail","handleRefresh","async","handleFiltersReset","render","h","totalIssues","propertiesWithIssues","Set","entry","property_id","size","Host","class","onFiltersChange","onFiltersReset","onFiltersSave"],"sources":["src/components/ir-unbookable-rooms/ir-unbookable-rooms.css?tag=ir-unbookable-rooms&encapsulation=scoped","src/components/ir-unbookable-rooms/ir-unbookable-rooms.tsx"],"sourcesContent":[":host {\n  height: 100% !important;\n  overflow-y: auto !important;\n}\n.ir-page__container {\n  height: 100%;\n  overflow-y: auto;\n}\n.unbookable-rooms__content {\n  display: flex;\n  flex-direction: column;\n  gap: 1rem;\n}\n\n.summary {\n  display: grid;\n  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n  gap: 12px;\n}\n\n.summary__value {\n  display: block;\n  font-size: 1.3rem;\n  font-weight: 600;\n}\n\n.summary__label {\n  font-size: 0.82rem;\n  color: #6a6256;\n}\n\n@media (min-width: 768px) {\n  .unbookable-rooms__content {\n    flex-direction: row;\n    align-items: flex-start;\n  }\n}\n","import { Component, Host, Prop, State, Watch, h } from '@stencil/core';\nimport Token from '@/models/Token';\nimport { AllowedProperties, FetchUnBookableRoomsResult, PropertyService } from '@/services/property.service';\n\ntype UnbookableRoomsMode = 'default' | 'mpo';\ntype UnbookableRoomsFilters = { period_to_check: number; consecutive_period: number; country: string };\n\n@Component({\n  tag: 'ir-unbookable-rooms',\n  styleUrl: 'ir-unbookable-rooms.css',\n  scoped: true,\n})\nexport class IrUnbookableRooms {\n  @Prop() ticket: string = '';\n  @Prop() propertyid: number;\n  @Prop({ reflect: true }) mode: UnbookableRoomsMode = 'default';\n  //number in months\n  @Prop() period_to_check: number = 2;\n  //number in days\n  @Prop() consecutive_period: number = 14;\n\n  @State() isLoading = false;\n  @State() errorMessage: string = '';\n  @State() unbookableRooms: FetchUnBookableRoomsResult = [];\n  @State() allowedProperties: AllowedProperties = null;\n  @State() filters: UnbookableRoomsFilters = { period_to_check: 2, consecutive_period: 14, country: 'all' };\n  @State() progressFilters = { period_to_check: 2, consecutive_period: 14 };\n  @State() lastUpdatedLabel = '';\n  @State() isPageLoading = true;\n\n  private tokenService = new Token();\n  private propertyService = new PropertyService();\n\n  componentWillLoad() {\n    this.filters = {\n      country: 'all',\n      period_to_check: this.normalizePositiveNumber(this.period_to_check, 2),\n      consecutive_period: this.normalizePositiveNumber(this.consecutive_period, 14),\n    };\n\n    if (this.ticket) {\n      this.tokenService.setToken(this.ticket);\n      this.initializeApp();\n    }\n  }\n\n  @Watch('ticket')\n  ticketChanged(newValue: string, oldValue: string) {\n    if (newValue === oldValue) {\n      return;\n    }\n    this.tokenService.setToken(this.ticket);\n    this.initializeApp();\n  }\n\n  @Watch('mode')\n  modeChanged(newValue: UnbookableRoomsMode, oldValue: UnbookableRoomsMode) {\n    if (newValue === oldValue) {\n      return;\n    }\n    this.initializeApp();\n  }\n\n  @Watch('property_id')\n  propertyIdChanged(newValue: number, oldValue: number) {\n    if (newValue === oldValue) {\n      return;\n    }\n    if (this.resolveMode() === 'default') {\n      this.initializeApp();\n    }\n  }\n\n  @Watch('period_to_check')\n  periodToCheckChanged(newValue: number) {\n    this.filters = { ...this.filters, period_to_check: this.normalizePositiveNumber(newValue, this.filters.period_to_check) };\n  }\n\n  @Watch('consecutive_period')\n  consecutivePeriodChanged(newValue: number) {\n    this.filters = { ...this.filters, consecutive_period: this.normalizePositiveNumber(newValue, this.filters.consecutive_period) };\n  }\n\n  private normalizePositiveNumber(value: number, fallback: number) {\n    const parsed = Number(value);\n    if (Number.isFinite(parsed) && parsed > 0) {\n      return Math.floor(parsed);\n    }\n    return fallback;\n  }\n\n  private resolveMode(): UnbookableRoomsMode {\n    return this.mode === 'mpo' ? 'mpo' : 'default';\n  }\n\n  private async initializeApp() {\n    if (!this.ticket) {\n      return;\n    }\n    try {\n      this.errorMessage = '';\n      this.isLoading = true;\n      this.unbookableRooms = [];\n\n      if (this.resolveMode() === 'mpo') {\n        this.allowedProperties = await this.propertyService.getExposedAllowedProperties();\n      } else {\n        this.allowedProperties = null;\n      }\n\n      await this.fetchUnbookableRooms();\n    } catch (error) {\n      console.error('Failed to load unbookable rooms', error);\n      this.errorMessage = 'Unable to load unbookable rooms right now. Please try again.';\n    } finally {\n      this.isLoading = false;\n      if (this.isPageLoading) {\n        this.isPageLoading = false;\n      }\n    }\n  }\n\n  private async fetchUnbookableRooms() {\n    const propertyIds = this.getPropertyIds();\n    if (!propertyIds.length) {\n      this.unbookableRooms = [];\n      this.errorMessage = this.resolveMode() === 'mpo' ? 'No properties available to check.' : 'Property ID is required to load unbookable rooms.';\n      return;\n    }\n\n    const results = await this.propertyService.fetchUnBookableRooms({\n      property_ids: propertyIds,\n      period_to_check: this.filters.period_to_check * 30,\n      consecutive_period: this.filters.consecutive_period,\n    });\n\n    this.unbookableRooms = results ?? [];\n    this.lastUpdatedLabel = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\n  }\n\n  private getPropertyIds(): number[] {\n    if (this.resolveMode() === 'mpo') {\n      return this.allowedProperties?.map(property => property.id) ?? [];\n    }\n    const propertyId = Number(this.propertyid);\n    return Number.isFinite(propertyId) && propertyId > 0 ? [propertyId] : [];\n  }\n\n  private handleFiltersChange = (event: CustomEvent<Partial<UnbookableRoomsFilters>>) => {\n    this.filters = { ...this.filters, ...event.detail };\n  };\n\n  private handleRefresh = async () => {\n    this.isLoading = true;\n    this.errorMessage = '';\n    try {\n      if (this.resolveMode() === 'mpo' && !this.allowedProperties) {\n        this.allowedProperties = await this.propertyService.getExposedAllowedProperties();\n      }\n      await this.fetchUnbookableRooms();\n      this.progressFilters = {\n        period_to_check: this.filters.period_to_check,\n        consecutive_period: this.filters.consecutive_period,\n      };\n    } catch (error) {\n      console.error('Failed to refresh unbookable rooms', error);\n      this.errorMessage = 'Unable to refresh unbookable rooms right now.';\n    } finally {\n      this.isLoading = false;\n    }\n  };\n  private handleFiltersReset = () => {\n    this.filters = {\n      country: 'all',\n      consecutive_period: 14,\n      period_to_check: 2,\n    };\n    this.handleRefresh();\n  };\n\n  render() {\n    if (this.isPageLoading) {\n      return <ir-loading-screen></ir-loading-screen>;\n    }\n    const totalIssues = this.unbookableRooms?.length ?? 0;\n    const propertiesWithIssues = new Set(this.unbookableRooms?.map(entry => entry.property_id)).size;\n    return (\n      <Host>\n        <ir-toast></ir-toast>\n        <ir-interceptor></ir-interceptor>\n        <section class=\"ir-page__container\">\n          <h3 class=\"page-title\">Availability Alert</h3>\n\n          {this.mode === 'mpo' && (\n            <section class=\"summary\" aria-live=\"polite\">\n              <wa-card>\n                <span class=\"summary__value\">{totalIssues}</span>\n                <span class=\"summary__label\">room types affected</span>\n              </wa-card>\n              <wa-card>\n                <span class=\"summary__value\">{propertiesWithIssues}</span>\n                <span class=\"summary__label\">properties impacted</span>\n              </wa-card>\n            </section>\n          )}\n\n          {/* {this.errorMessage && <p class=\"error\">{this.errorMessage}</p>} */}\n\n          <section class=\"unbookable-rooms__content\">\n            <ir-unbookable-rooms-filters\n              mode={this.mode}\n              filters={this.filters}\n              unbookableRooms={this.unbookableRooms}\n              isLoading={this.isLoading}\n              onFiltersChange={this.handleFiltersChange}\n              onFiltersReset={this.handleFiltersReset}\n              onFiltersSave={this.handleRefresh}\n            ></ir-unbookable-rooms-filters>\n            <ir-unbookable-rooms-data\n              mode={this.mode}\n              isLoading={this.isLoading}\n              errorMessage={this.errorMessage}\n              unbookableRooms={this.unbookableRooms}\n              allowedProperties={this.allowedProperties}\n              filters={this.filters}\n              progressFilters={this.progressFilters}\n            ></ir-unbookable-rooms-data>\n          </section>\n        </section>\n      </Host>\n    );\n  }\n}\n"],"mappings":"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","ignoreList":[]}