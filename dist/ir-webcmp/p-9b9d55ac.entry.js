import{r as t,c as i,h as s,H as e,g as n}from"./p-53d64953.js";import{T as a}from"./p-a93581f3.js";import{H as o,h as l,u as r}from"./p-b6c1681e.js";import{R as h}from"./p-429a4d65.js";import{l as c}from"./p-71768c2d.js";import{h as d}from"./p-6c4ba7c0.js";import{N as u}from"./p-f4889f24.js";import{s as f,u as p,h as v,c as _,a as y}from"./p-8c949732.js";import{c as m}from"./p-00df8713.js";import{v as g}from"./p-4ed69de7.js";import{a as b}from"./p-bf44a732.js";import{i as w}from"./p-2e94af0d.js";import{B as k}from"./p-24572bbe.js";import{U as Y}from"./p-22463e47.js";import{l as x}from"./p-eb747876.js";import"./p-a973aec7.js";import"./p-b859bcd5.js";const M=".sc-ir-hk-tasks-h{display:block;box-sizing:border-box}.sc-ir-hk-tasks-h *.sc-ir-hk-tasks{box-sizing:border-box}.tasks-view.sc-ir-hk-tasks{display:flex;flex-direction:column}@media (min-width: 1024px){.tasks-view.sc-ir-hk-tasks{flex-direction:row}}";const D=M;const C=class{constructor(s){t(this,s);this.clearSelectedHkTasks=i(this,"clearSelectedHkTasks",7);this.language="";this.ticket="";this.isLoading=false;this.isCleaningLoading=false;this.selectedDuration="";this.selectedHouseKeeper="0";this.selectedRoom=null;this.archiveOpened=false;this.hkNameCache={};this.roomService=new h;this.houseKeepingService=new o;this.token=new a;this.table_sorting=new Map}componentWillLoad(){if(this.baseUrl){this.token.setBaseUrl(this.baseUrl)}if(this.ticket!==""){this.token.setToken(this.ticket);this.init()}}ticketChanged(t,i){if(t===i){return}this.token.setToken(this.ticket);this.init()}handleCloseSidebar(t){t.stopImmediatePropagation();t.stopPropagation();this.isSidebarOpen=false}handleSortingChanged(t){t.stopImmediatePropagation();t.stopPropagation();const{field:i,direction:s}=t.detail;console.log(t.detail);if(i==="date"){return}this.table_sorting.set(i,s)}handleSkipSelectedTask(t){var i;t.stopImmediatePropagation();t.stopPropagation();this.modalCauses={task:t.detail,cause:"skip"};(i=this.modal)===null||i===void 0?void 0:i.openModal()}async init(){var t,i,s,e,n,a,o;try{this.isLoading=true;f(true);let r=this.propertyid;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}if(!r){console.log(r);const t=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});r=t.My_Result.id}this.property_id=r;const h=[this.houseKeepingService.getExposedHKSetup(this.property_id),this.roomService.fetchLanguage(this.language)];if(this.propertyid){h.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true,include_units_hk_status:true}))}await Promise.all(h);const c=await this.houseKeepingService.getHkTasks({property_id:this.property_id,from_date:d().format("YYYY-MM-DD"),to_date:d().format("YYYY-MM-DD"),housekeepers:[],cleaning_frequency:(s=(t=m.cleaning_frequency)!==null&&t!==void 0?t:(i=l===null||l===void 0?void 0:l.hk_criteria)===null||i===void 0?void 0:i.cleaning_frequencies[0])===null||s===void 0?void 0:s.code,dusty_window:(n=(e=l===null||l===void 0?void 0:l.hk_criteria)===null||e===void 0?void 0:e.dusty_periods[0])===null||n===void 0?void 0:n.code,highlight_window:(o=(a=l===null||l===void 0?void 0:l.hk_criteria)===null||a===void 0?void 0:a.highlight_checkin_options[0])===null||o===void 0?void 0:o.code});if(c===null||c===void 0?void 0:c.tasks){this.updateTasks(c.tasks)}}catch(t){console.log(t)}finally{this.isLoading=false;f(false)}}buildHousekeeperNameCache(){var t,i;this.hkNameCache={};(i=(t=l.hk_criteria)===null||t===void 0?void 0:t.housekeepers)===null||i===void 0?void 0:i.forEach((t=>{if(t.id!=null&&t.name!=null){this.hkNameCache[t.id]=t.name}}))}updateTasks(t){this.buildHousekeeperNameCache();p(t.map((t=>Object.assign(Object.assign({},t),{id:g(),housekeeper:(()=>{var i,s,e;const n=this.hkNameCache[t.hkm_id];if(n){return n}const a=(e=(s=(i=l.hk_criteria)===null||i===void 0?void 0:i.housekeepers)===null||s===void 0?void 0:s.find((i=>i.id===t.hkm_id)))===null||e===void 0?void 0:e.name;this.hkNameCache[t.hkm_id]=a;return a})()}))))}async handleHeaderButtonPress(t){var i;t.stopImmediatePropagation();t.stopPropagation();const{name:s}=t.detail;switch(s){case"cleaned":case"clean-inspect":(i=this.modal)===null||i===void 0?void 0:i.openModal();this.modalCauses={task:null,cause:"clean",status:s==="clean-inspect"?"004":"001"};break;case"export":const t=Array.from(this.table_sorting.entries()).map((([t,i])=>({key:t,value:i})));console.log(t);const{url:e}=await this.fetchTasksWithFilters(true);u(e);break;case"archive":this.isSidebarOpen=true;break}}handleSelectedTaskCleaningEvent(t){var i;t.stopImmediatePropagation();t.stopPropagation();this.modalCauses=Object.assign(Object.assign({},t.detail),{cause:"clean"});(i=this.modal)===null||i===void 0?void 0:i.openModal()}async handleModalConfirmation(t){var i;try{t.stopImmediatePropagation();t.stopPropagation();if(v.selectedTasks.length===0){return}this.isCleaningLoading=true;if(((i=this.modalCauses)===null||i===void 0?void 0:i.cause)==="skip"){const{booking_nbr:t,date:i,unit:s}=this.modalCauses.task;await this.houseKeepingService.editHkSkip({BOOK_NBR:t,DATE:i,COMMENT:"",HK_SKIP_ID:-1,HK_SKIP_REASON_CODE:"001",PR_ID:s.id})}else{await this.houseKeepingService.executeHKAction({actions:v.selectedTasks.map((t=>{var i,s;return{description:"Cleaned",hkm_id:t.hkm_id===0?null:t.hkm_id,unit_id:t.unit.id,booking_nbr:t.booking_nbr,status:(s=(i=this.modalCauses)===null||i===void 0?void 0:i.status)!==null&&s!==void 0?s:"001"}}))})}await this.fetchTasksWithFilters()}finally{_();if(this.modalCauses){this.modalCauses=null}this.isCleaningLoading=false;this.modal.closeModal()}}async applyFilters(t){try{this.isApplyFiltersLoading=true;t.stopImmediatePropagation();t.stopPropagation();this.filters=Object.assign({},t.detail);await this.fetchTasksWithFilters()}catch(t){console.log(t)}finally{this.isApplyFiltersLoading=false}}async fetchTasksWithFilters(t=false){var i;const{cleaning_periods:s,housekeepers:e,cleaning_frequencies:n,dusty_units:a,highlight_check_ins:o}=(i=this.filters)!==null&&i!==void 0?i:{};const{tasks:l,url:r}=await this.houseKeepingService.getHkTasks({housekeepers:e,cleaning_frequency:n===null||n===void 0?void 0:n.code,dusty_window:a===null||a===void 0?void 0:a.code,highlight_window:o===null||o===void 0?void 0:o.code,property_id:this.property_id,from_date:d().format("YYYY-MM-DD"),to_date:(s===null||s===void 0?void 0:s.code)||d().format("YYYY-MM-DD"),is_export_to_excel:t});console.log(l);if(l){this.updateTasks(l)}return{tasks:l,url:r}}render(){var t,i,n,a;if(this.isLoading){return s("ir-loading-screen",null)}return s(e,{"data-testid":"hk_tasks_base"},s("ir-toast",null),s("ir-interceptor",null),s("section",{class:"p-1 d-flex flex-column",style:{gap:"1rem"}},s("h3",null,"Housekeeping Tasks"),s("div",{class:"tasks-view ",style:{gap:"1rem"}},s("ir-tasks-filters",{isLoading:this.isApplyFiltersLoading,onApplyFilters:t=>{this.applyFilters(t)}}),s("div",{class:"d-flex w-100 flex-column",style:{gap:"1rem"}},s("ir-tasks-table",{onRowSelectChange:t=>{t.stopImmediatePropagation();t.stopPropagation();y(t.detail)},class:"flex-grow-1 w-100"})))),s("ir-modal",{autoClose:false,ref:t=>this.modal=t,isLoading:this.isCleaningLoading,onConfirmModal:this.handleModalConfirmation.bind(this),onCancelModal:()=>{if(this.modalCauses){_();this.modalCauses=null}},iconAvailable:true,icon:"ft-alert-triangle danger h1",leftBtnText:c.entries.Lcz_Cancel,rightBtnText:c.entries.Lcz_Confirm,leftBtnColor:"secondary",rightBtnColor:"primary",modalTitle:c.entries.Lcz_Confirmation,modalBody:this.modalCauses?((t=this.modalCauses)===null||t===void 0?void 0:t.cause)==="clean"?this.modalCauses.task?`Update ${(a=(n=(i=this.modalCauses)===null||i===void 0?void 0:i.task)===null||n===void 0?void 0:n.unit)===null||a===void 0?void 0:a.name} to Clean`:"Update selected unit(s) to Clean":"Skip cleaning and reschedule for tomorrow.":"Update selected unit(s) to Clean"}),s("ir-sidebar",{open:this.isSidebarOpen,id:"editGuestInfo",onIrSidebarToggle:t=>{t.stopImmediatePropagation();t.stopPropagation();this.isSidebarOpen=false},showCloseButton:false},this.isSidebarOpen&&s("ir-hk-archive",{ticket:this.token.getToken(),propertyId:this.property_id,slot:"sidebar-body"})))}get el(){return n(this)}static get watchers(){return{ticket:["ticketChanged"]}}};C.style=D;class O{async getExposedProperty(t){var i,s;try{const{data:e}=await b.post(`/Get_Exposed_Property`,t);if(e.ExceptionMsg!==""){throw new Error(e.ExceptionMsg)}const n=e.My_Result;m.adultChildConstraints=n.adult_child_constraints;m.allowedBookingSources=n.allowed_booking_sources;m.allowed_payment_methods=n.allowed_payment_methods;m.currency=n.currency;m.is_vacation_rental=n.is_vacation_rental;m.pickup_service=n.pickup_service;m.max_nights=n.max_nights;m.roomsInfo=n.roomtypes;m.taxes=n.taxes;m.id=n.id;m.country=n.country;m.name=n.name;m.is_automatic_check_in_out=n.is_automatic_check_in_out;m.tax_statement=n.tax_statement;m.is_frontdesk_enabled=n.is_frontdesk_enabled;m.is_pms_enabled=n.is_pms_enabled;const a=(s=(i=n===null||n===void 0?void 0:n.time_constraints)===null||i===void 0?void 0:i.check_out_till)===null||s===void 0?void 0:s.split(":");m.checkin_checkout_hours={offset:n.city.gmt_offset,hour:Number(a[0]||0),minute:Number(a[1]||0)};return e}catch(t){console.log(t);throw new Error(t)}}async getCountrySales(t){const{data:i}=await b.post("/Get_Country_Sales",t);if(i.ExceptionMsg!==""){throw new Error(i.ExceptionMsg)}if(t.is_export_to_excel){u(i.My_Params_Get_Country_Sales.Link_excel)}return i.My_Result}async setExposedCleaningFrequency(t){const{data:i}=await b.post("/Set_Exposed_Cleaning_Frequency",t);if(i.ExceptionMsg!==""){throw new Error(i.ExceptionMsg)}return i.My_Result}async getMonthlyStats(t){const{data:i}=await b.post("/Get_Monthly_Stats",t);if(i.ExceptionMsg!==""){throw new Error(i.ExceptionMsg)}if(t.is_export_to_excel){u(i.My_Params_Get_Monthly_Stats.Link_excel)}return i.My_Result}}const j=".sc-ir-housekeeping-h{display:block}";const S=j;const T=class{constructor(s){t(this,s);this.toast=i(this,"toast",7);this.language="";this.ticket="";this.isLoading=false;this.roomService=new h;this.houseKeepingService=new o;this.propertyService=new O;this.token=new a}componentWillLoad(){if(this.baseUrl){this.token.setBaseUrl(this.baseUrl)}if(this.ticket!==""){this.token.setToken(this.ticket);this.initializeApp()}}async handleResetData(t){t.stopImmediatePropagation();t.stopPropagation();await this.houseKeepingService.getExposedHKSetup(this.propertyid)}ticketChanged(t,i){if(t===i){return}this.token.setToken(this.ticket);this.initializeApp()}async initializeApp(){var t;try{this.isLoading=true;let i=this.propertyid;if(!i){const t=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_sales_rate_plans:true});i=t.My_Result.id}r("default_properties",{token:this.ticket,property_id:i,language:this.language});const s=[];if(m.housekeeping_enabled){s.push(this.houseKeepingService.getExposedHKSetup(i))}s.push(this.roomService.fetchLanguage(this.language,["_HK_FRONT","_PMS_FRONT"]));if(this.propertyid){s.push(this.roomService.getExposedProperty({id:i,language:this.language,is_backend:true,include_sales_rate_plans:true}))}await Promise.all(s);this.selectedCleaningFrequency=(t=m.cleaning_frequency)===null||t===void 0?void 0:t.code}catch(t){console.error(t)}finally{this.isLoading=false}}async saveAutomaticCheckInCheckout(t){t.stopImmediatePropagation();t.stopPropagation();try{await this.roomService.SetAutomaticCheckInOut({property_id:l.default_properties.property_id,flag:t.detail==="auto"});this.toast.emit({position:"top-right",title:"Saved Successfully",description:"",type:"success"})}catch(t){console.log(t)}}async saveCleaningFrequency(t){t.stopImmediatePropagation();t.stopPropagation();try{await this.propertyService.setExposedCleaningFrequency({property_id:l.default_properties.property_id,code:this.selectedCleaningFrequency});m.cleaning_frequency={code:this.selectedCleaningFrequency,description:""};this.toast.emit({position:"top-right",title:"Saved Successfully",description:"",type:"success"});this.modal.closeModal()}catch(t){console.log(t)}}render(){var t;if(this.isLoading){return s("ir-loading-screen",null)}console.log(m.cleaning_frequency);return s(e,null,s("ir-interceptor",null),s("ir-toast",null),s("section",{class:"p-1"},s("h3",{class:"mb-2"},c.entries.Lcz_HouseKeepingAndCheckInSetup),s("div",{class:"card p-1"},s("ir-title",{borderShown:true,label:"Operations Settings"}),s("div",{class:"d-flex align-items-center mb-1"},s("p",{class:"my-0 py-0 mr-1"},c.entries.Lcz_CheckInOutGuestsAutomatically),s("ir-select",{LabelAvailable:false,showFirstOption:false,selectedValue:m.is_automatic_check_in_out?"auto":"manual",onSelectChange:t=>this.saveAutomaticCheckInCheckout(t),data:[{text:c.entries.Lcz_YesAsPerPropertyPolicy,value:"auto"},{text:c.entries.Lcz_NoIWillDoItManually,value:"manual"}]})),s("div",{class:"d-flex align-items-center"},s("p",{class:"my-0 py-0 mr-1"},c.entries.Lcz_CleaningFrequency,":"),s("ir-select",{LabelAvailable:false,showFirstOption:false,selectedValue:this.selectedCleaningFrequency,onSelectChange:t=>{t.stopImmediatePropagation();t.stopPropagation();this.selectedCleaningFrequency=t.detail;this.modal.openModal()},data:(t=l===null||l===void 0?void 0:l.hk_criteria)===null||t===void 0?void 0:t.cleaning_frequencies.map((t=>({text:t.description,value:t.code})))}))),m.housekeeping_enabled&&s("ir-hk-team",{class:"mb-1"}),s("ir-modal",{autoClose:false,ref:t=>this.modal=t,isLoading:w("/Set_Exposed_Cleaning_Frequency"),onConfirmModal:this.saveCleaningFrequency.bind(this),iconAvailable:true,onCancelModal:()=>{var t;this.selectedCleaningFrequency=(t=m.cleaning_frequency)===null||t===void 0?void 0:t.code},icon:"ft-alert-triangle danger h1",leftBtnText:c.entries.Lcz_Cancel,rightBtnText:c.entries.Lcz_Confirm,leftBtnColor:"secondary",rightBtnColor:"primary",modalTitle:c.entries.Lcz_Confirmation,modalBody:"This action will reschedule all cleaning tasks. Do you want to continue?"})))}static get watchers(){return{ticket:["ticketChanged"]}}};T.style=S;const E=".sc-ir-monthly-bookings-report-h{display:block}";const A=E;var P=undefined&&undefined.__rest||function(t,i){var s={};for(var e in t)if(Object.prototype.hasOwnProperty.call(t,e)&&i.indexOf(e)<0)s[e]=t[e];if(t!=null&&typeof Object.getOwnPropertySymbols==="function")for(var n=0,e=Object.getOwnPropertySymbols(t);n<e.length;n++){if(i.indexOf(e[n])<0&&Object.prototype.propertyIsEnumerable.call(t,e[n]))s[e[n]]=t[e[n]]}return s};const F=class{constructor(i){t(this,i);this.language="";this.ticket="";this.isPageLoading=true;this.isLoading=null;this.reports=[];this.tokenService=new a;this.roomService=new h;this.propertyService=new O}componentWillLoad(){this.baseFilters={date:{description:d().format("MMMM YYYY"),firstOfMonth:d().startOf("month").format("YYYY-MM-DD"),lastOfMonth:d().endOf("month").format("YYYY-MM-DD")},include_previous_year:false};this.filters=this.baseFilters;if(this.ticket){this.tokenService.setToken(this.ticket);this.init()}}handleTicketChange(t,i){if(t!==i){this.tokenService.setToken(this.ticket);this.init()}}handleApplyFiltersChange(t){t.stopImmediatePropagation();t.stopPropagation();this.filters=t.detail;this.getReports()}async init(){try{let t=this.propertyid;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}if(!t){console.log(t);const i=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});t=i.My_Result.id}this.property_id=t;const i=[this.roomService.fetchLanguage(this.language),this.getReports()];if(this.propertyid){i.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true,include_units_hk_status:true}))}await Promise.all(i)}catch(t){console.log(t)}finally{this.isPageLoading=false}}async getReports(t=false){try{const i=t=>({day:t.Date,units_booked:t.Units_booked,occupancy_percent:t.Occupancy,adr:t.ADR,rooms_revenue:t.Rooms_Revenue,total_guests:t===null||t===void 0?void 0:t.Total_Guests});this.isLoading=t?"export":"filter";const{date:s,include_previous_year:e}=this.filters;const n=[this.propertyService.getMonthlyStats({from_date:s.firstOfMonth,to_date:s.lastOfMonth,property_id:this.property_id,is_export_to_excel:t})];if(e){n.push(this.propertyService.getMonthlyStats({from_date:d(s.firstOfMonth,"YYYY-MM-DD").add(-1,"year").format("YYYY-MM-DD"),to_date:d(s.lastOfMonth,"YYYY-MM-DD").add(-1,"years").format("YYYY-MM-DD"),property_id:this.property_id}))}const a=await Promise.all(n);const o=a[0];let l=[];const{DailyStats:r}=o,h=P(o,["DailyStats"]);this.stats=Object.assign({},h);if(e&&a[t?0:1]){const s=a[t?0:1];let e=s.DailyStats.map(i);l=r.map(i).map((t=>{const i=e.find((i=>i.day===d(t.day,"YYYY-MM-DD").add(-1,"years").format("YYYY-MM-DD")));return Object.assign(Object.assign({},t),{last_year:i!==null&&i!==void 0?i:null})}))}else{l=r.map(i)}this.reports=[...l]}catch(t){console.log(t)}finally{this.isLoading=null}}render(){var t,i,n,a,o,l,r,h,u,f,p,v,_;if(this.isPageLoading){return s("ir-loading-screen",null)}return s(e,null,s("ir-toast",null),s("ir-interceptor",null),s("section",{class:"p-2 d-flex flex-column",style:{gap:"1rem"}},s("div",{class:"d-flex align-items-center justify-content-between"},s("h3",{class:"mb-1 mb-md-0"},"Daily Occupancy"),s("ir-button",{size:"sm",btn_color:"outline",isLoading:this.isLoading==="export",text:(t=c.entries)===null||t===void 0?void 0:t.Lcz_Export,onClickHandler:async t=>{t.stopImmediatePropagation();t.stopPropagation();await this.getReports(true)},btnStyle:{height:"100%"},iconPosition:"right",icon_name:"file",icon_style:{"--icon-size":"14px"}})),s("section",null,s("div",{class:"d-flex flex-column flex-md-row w-100",style:{gap:"1rem",alignItems:"stretch"}},s("ir-report-stats-card",{icon:((i=this.stats)===null||i===void 0?void 0:i.Occupancy_Difference_From_Previous_Month)<0?"arrow-trend-down":"arrow-trend-up",cardTitle:"Average Occupancy",value:this.stats.AverageOccupancy?((n=this.stats)===null||n===void 0?void 0:n.AverageOccupancy.toFixed(2))+"%":null,subtitle:`${((a=this.stats)===null||a===void 0?void 0:a.Occupancy_Difference_From_Previous_Month)<0?"":"+"}${(o=this.stats)===null||o===void 0?void 0:o.Occupancy_Difference_From_Previous_Month.toFixed(2)}% from last month`}),s("ir-report-stats-card",{icon:"hotel",cardTitle:"Total Units",value:((l=this.stats)===null||l===void 0?void 0:l.TotalUnitsBooked)?(r=this.stats)===null||r===void 0?void 0:r.TotalUnitsBooked.toString():null,subtitle:"Booked"}),s("ir-report-stats-card",{icon:"user_group",cardTitle:"Total Guests",value:(u=(h=this.reports)===null||h===void 0?void 0:h.reduce(((t,i)=>t+i.total_guests),0))===null||u===void 0?void 0:u.toString(),subtitle:"Stayed"}),s("ir-report-stats-card",{icon:"calendar",cardTitle:"Peak Days",value:((f=this.stats)===null||f===void 0?void 0:f.PeakDays.length)===0?null:(v=(p=this.stats)===null||p===void 0?void 0:p.PeakDays)===null||v===void 0?void 0:v.map((t=>d(t.Date,"YYYY-MM-DD").format("D").concat("th"))).join(" - "),subtitle:`${Math.max(...((_=this.stats.PeakDays)===null||_===void 0?void 0:_.map((t=>t.OccupancyPercent)))||[])}% occupancy`})),s("div",{class:"d-flex flex-column flex-lg-row mt-1 ",style:{gap:"1rem"}},s("ir-monthly-bookings-report-filter",{isLoading:this.isLoading==="filter",class:"filters-card",baseFilters:this.baseFilters}),s("ir-monthly-bookings-report-table",{reports:this.reports})))))}static get watchers(){return{ticket:["handleTicketChange"]}}};F.style=A;const I=".sc-ir-sales-by-country-h{display:block}";const B=I;var L=undefined&&undefined.__rest||function(t,i){var s={};for(var e in t)if(Object.prototype.hasOwnProperty.call(t,e)&&i.indexOf(e)<0)s[e]=t[e];if(t!=null&&typeof Object.getOwnPropertySymbols==="function")for(var n=0,e=Object.getOwnPropertySymbols(t);n<e.length;n++){if(i.indexOf(e[n])<0&&Object.prototype.propertyIsEnumerable.call(t,e[n]))s[e[n]]=t[e[n]]}return s};const R=class{constructor(i){t(this,i);this.language="";this.ticket="";this.isLoading=null;this.isPageLoading=true;this.countries=new Map;this.token=new a;this.roomService=new h;this.propertyService=new O;this.bookingService=new k;this.baseFilters={FROM_DATE:d().add(-7,"days").format("YYYY-MM-DD"),TO_DATE:d().format("YYYY-MM-DD"),BOOK_CASE:"001",WINDOW:7,include_previous_year:false}}componentWillLoad(){this.salesFilters=this.baseFilters;if(this.ticket){this.token.setToken(this.ticket);this.initializeApp()}}ticketChanged(t,i){if(t===i){return}this.token.setToken(this.ticket);this.initializeApp()}async initializeApp(){try{let t=this.propertyid;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}if(!t){console.log(t);const i=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});t=i.My_Result.id}this.property_id=t;const i=[this.bookingService.getCountries(this.language),this.roomService.fetchLanguage(this.language),this.getCountrySales()];if(this.propertyid){i.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true,include_units_hk_status:true}))}const[s]=await Promise.all(i);const e=new Map;s.map((t=>{e.set(t.id,{flag:t.flag,name:t.name})}));this.countries=e}catch(t){console.log(t)}finally{this.isPageLoading=false}}async getCountrySales(t=false){const i=t=>({country:t.COUNTRY,country_id:t.COUNTRY_ID,nights:t.NIGHTS,percentage:t.PCT,revenue:t.REVENUE,number_of_guests:t.Total_Guests});try{const s=this.salesFilters,{include_previous_year:e}=s,n=L(s,["include_previous_year"]);this.isLoading=t?"export":"filter";const a=await this.propertyService.getCountrySales(Object.assign({AC_ID:this.property_id,is_export_to_excel:t},n));const o=!t&&e;let l=[];if(o){const t=await this.propertyService.getCountrySales(Object.assign(Object.assign({AC_ID:this.property_id,is_export_to_excel:false},n),{FROM_DATE:d(n.FROM_DATE).subtract(1,"year").format("YYYY-MM-DD"),TO_DATE:d(n.TO_DATE).subtract(1,"year").format("YYYY-MM-DD")}));l=a.map((s=>{const e=t.find((t=>t.COUNTRY.toLowerCase()===s.COUNTRY.toLowerCase()));return Object.assign(Object.assign({id:g()},i(s)),{last_year:e?i(e):null})}))}else{l=a.map((t=>Object.assign(Object.assign({id:g()},i(t)),{last_year:null})))}this.salesData=[...l]}catch(t){console.error("Failed to fetch sales data:",t)}finally{this.isLoading=null}}render(){if(this.isPageLoading){return s("ir-loading-screen",null)}return s(e,null,s("ir-toast",null),s("ir-interceptor",null),s("section",{class:"p-2 d-flex flex-column",style:{gap:"1rem"}},s("div",{class:"d-flex align-items-center justify-content-between"},s("h3",{class:"mb-1 mb-md-0"},"Sales by Country"),s("ir-button",{size:"sm",btn_color:"outline",isLoading:this.isLoading==="export",text:c.entries.Lcz_Export,onClickHandler:async t=>{t.stopImmediatePropagation();t.stopPropagation();await this.getCountrySales(true)},btnStyle:{height:"100%"},iconPosition:"right",icon_name:"file",icon_style:{"--icon-size":"14px"}})),s("div",{class:"d-flex flex-column flex-lg-row mt-1 ",style:{gap:"1rem"}},s("ir-sales-filters",{isLoading:this.isLoading==="filter",onApplyFilters:t=>{t.stopImmediatePropagation();t.stopPropagation();this.salesFilters=t.detail;this.getCountrySales()},class:"filters-card",baseFilters:this.baseFilters}),s("ir-sales-table",{mappedCountries:this.countries,class:"card mb-0",records:this.salesData}))))}static get watchers(){return{ticket:["ticketChanged"]}}};R.style=B;const U=".sc-ir-user-management-h{display:block;height:100%}";const N=U;const H=class{constructor(i){t(this,i);this.language="";this.isSuperAdmin=true;this.isLoading=true;this.users=[];this.allowedUsersTypes=[];this.token=new a;this.roomService=new h;this.userService=new Y;this.bookingService=new k;this.userTypes=new Map;this.superAdminId="5"}componentWillLoad(){if(this.baseUrl){this.token.setBaseUrl(this.baseUrl)}if(this.ticket){this.token.setToken(this.ticket);this.initializeApp()}}ticketChanged(t,i){if(t===i){return}this.token.setToken(this.ticket);this.initializeApp()}async handleResetData(t){t.stopImmediatePropagation();t.stopPropagation();await this.fetchUsers()}async initializeApp(){try{if(this.baseUrl){this.token.setBaseUrl(this.baseUrl)}this.isLoading=true;let t=this.propertyid;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}if(!t){console.log(t);const i=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});t=i.My_Result.id}this.property_id=t;const i=[this.fetchUserTypes(),this.fetchUsers(),this.roomService.fetchLanguage(this.language,["_USER_MGT"])];if(this.propertyid){i.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true,include_units_hk_status:true}))}await Promise.all(i);this.socket=x("https://realtime.igloorooms.com/");this.socket.on("MSG",(async t=>{await this.handleSocketMessage(t)}))}catch(t){console.log(t)}finally{this.isLoading=false}}async handleSocketMessage(t){const i=JSON.parse(t);if(!i){return}const{REASON:s,KEY:e,PAYLOAD:n}=i;if(e.toString()!==this.property_id.toString()){return}let a=JSON.parse(n);console.log(e,a);const o={EMAIL_VERIFIED:this.updateUserVerificationStatus};const l=o[s];if(l){await l.call(this,a)}else{console.warn(`Unhandled REASON: ${s}`)}}updateUserVerificationStatus(t){const i=[...this.users];const s=i.findIndex((i=>i.id===t.id));if(s===-1){console.warn(`User ${t.id} not found`);return}i[s]=Object.assign(Object.assign({},i[s]),{is_email_verified:true});this.users=i}async fetchUsers(){const t=await this.userService.getExposedPropertyUsers({property_id:this.propertyid});this.users=[...t].sort(((t,i)=>{const s=t=>{const i=t.type.toString();if(i===this.superAdminId)return 0;if(i==="17")return 1;return 2};const e=s(t),n=s(i);if(e!==n){return e-n}return t.username.localeCompare(i.username)}))}async fetchUserTypes(){var t,i,s,e;const n=await Promise.all([this.bookingService.getSetupEntriesByTableName("_USER_TYPE"),this.bookingService.getLov()]);const a=(i=(t=n[1])===null||t===void 0?void 0:t.My_Result)===null||i===void 0?void 0:i.allowed_user_types;for(const t of n[0]){const i=t[`CODE_VALUE_${(e=(s=this.language)===null||s===void 0?void 0:s.toUpperCase())!==null&&e!==void 0?e:"EN"}`];if(a.find((i=>i.code===t.CODE_NAME))){this.allowedUsersTypes.push({code:t.CODE_NAME,value:i})}this.userTypes.set(t.CODE_NAME.toString(),i)}}disconnectedCallback(){this.socket.disconnect()}render(){var t,i;if(this.isLoading){return s(e,null,s("ir-toast",null),s("ir-interceptor",null),s("ir-loading-screen",null))}return s(e,null,s("ir-toast",null),s("ir-interceptor",{suppressToastEndpoints:["/Change_User_Pwd","/Handle_Exposed_User"]}),s("section",{class:"p-2 d-flex flex-column",style:{gap:"1rem"}},s("div",{class:"d-flex  pb-2 align-items-center justify-content-between"},s("h3",{class:"mb-1 mb-md-0"},c.entries.Lcz_ExtranetUsers)),s("div",{class:"",style:{gap:"1rem"}},s("ir-user-management-table",{property_id:this.property_id,baseUserTypeCode:this.baseUserTypeCode,allowedUsersTypes:this.allowedUsersTypes,userTypeCode:this.userTypeCode,haveAdminPrivileges:[this.superAdminId,"17"].includes((t=this.userTypeCode)===null||t===void 0?void 0:t.toString()),userTypes:this.userTypes,class:"card",isSuperAdmin:((i=this.userTypeCode)===null||i===void 0?void 0:i.toString())===this.superAdminId,users:this.users}))))}static get watchers(){return{ticket:["ticketChanged"]}}};H.style=N;export{C as ir_hk_tasks,T as ir_housekeeping,F as ir_monthly_bookings_report,R as ir_sales_by_country,H as ir_user_management};
//# sourceMappingURL=p-9b9d55ac.entry.js.map