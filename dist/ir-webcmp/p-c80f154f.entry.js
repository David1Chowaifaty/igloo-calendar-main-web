import{r as t,c as e,g as i,h as s,F as n,H as o}from"./p-acddcbeb.js";import{R as r}from"./p-ac9c6afc.js";import{B as a}from"./p-780f435e.js";import{u as h,w as l,x as c,i as u,y as d,z as f,A as p,B as g,C as y,d as m,D as _,a as b,E as w,c as k,F as D,G as v,H as E,I as C,q as S,J as A}from"./p-2cc619e5.js";import{E as O,P as T}from"./p-6edca0c7.js";import{h as Y}from"./p-6c4ba7c0.js";import{T as M}from"./p-bf960900.js";import{l as P}from"./p-e58470d9.js";import{c as x}from"./p-d6d6fb27.js";import{h as R,a as N,r as B}from"./p-1a4409f6.js";import{T as I}from"./p-f8b7c0cd.js";import{v as L}from"./p-4ed69de7.js";import{H as U,h as j,u as F}from"./p-da752fba.js";import{c as H,o as z,a as G,d as $,i as K,e as q}from"./p-f3585d99.js";import{a as V}from"./p-bf44a732.js";import{B as W,u as J,b as X,s as Q,o as Z,a as tt,c as et,d as it}from"./p-33f456cc.js";import{o as st,d as nt,b as ot,i as rt,c as at,e as ht}from"./p-e60046f2.js";import{s as lt,u as ct,h as ut,c as dt,a as ft}from"./p-aaeca94b.js";import{i as pt}from"./p-3b76fc4f.js";import{U as gt}from"./p-fa20cb74.js";import"./p-e7d273da.js";import"./p-2925ded6.js";const yt=Object.create(null);yt["open"]="0";yt["close"]="1";yt["ping"]="2";yt["pong"]="3";yt["message"]="4";yt["upgrade"]="5";yt["noop"]="6";const mt=Object.create(null);Object.keys(yt).forEach((t=>{mt[yt[t]]=t}));const _t={type:"error",data:"parser error"};const bt=typeof Blob==="function"||typeof Blob!=="undefined"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]";const wt=typeof ArrayBuffer==="function";const kt=t=>typeof ArrayBuffer.isView==="function"?ArrayBuffer.isView(t):t&&t.buffer instanceof ArrayBuffer;const Dt=({type:t,data:e},i,s)=>{if(bt&&e instanceof Blob){if(i){return s(e)}else{return vt(e,s)}}else if(wt&&(e instanceof ArrayBuffer||kt(e))){if(i){return s(e)}else{return vt(new Blob([e]),s)}}return s(yt[t]+(e||""))};const vt=(t,e)=>{const i=new FileReader;i.onload=function(){const t=i.result.split(",")[1];e("b"+(t||""))};return i.readAsDataURL(t)};function Et(t){if(t instanceof Uint8Array){return t}else if(t instanceof ArrayBuffer){return new Uint8Array(t)}else{return new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}}let Ct;function St(t,e){if(bt&&t.data instanceof Blob){return t.data.arrayBuffer().then(Et).then(e)}else if(wt&&(t.data instanceof ArrayBuffer||kt(t.data))){return e(Et(t.data))}Dt(t,false,(t=>{if(!Ct){Ct=new TextEncoder}e(Ct.encode(t))}))}const At="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";const Ot=typeof Uint8Array==="undefined"?[]:new Uint8Array(256);for(let t=0;t<At.length;t++){Ot[At.charCodeAt(t)]=t}const Tt=t=>{let e=t.length*.75,i=t.length,s,n=0,o,r,a,h;if(t[t.length-1]==="="){e--;if(t[t.length-2]==="="){e--}}const l=new ArrayBuffer(e),c=new Uint8Array(l);for(s=0;s<i;s+=4){o=Ot[t.charCodeAt(s)];r=Ot[t.charCodeAt(s+1)];a=Ot[t.charCodeAt(s+2)];h=Ot[t.charCodeAt(s+3)];c[n++]=o<<2|r>>4;c[n++]=(r&15)<<4|a>>2;c[n++]=(a&3)<<6|h&63}return l};const Yt=typeof ArrayBuffer==="function";const Mt=(t,e)=>{if(typeof t!=="string"){return{type:"message",data:xt(t,e)}}const i=t.charAt(0);if(i==="b"){return{type:"message",data:Pt(t.substring(1),e)}}const s=mt[i];if(!s){return _t}return t.length>1?{type:mt[i],data:t.substring(1)}:{type:mt[i]}};const Pt=(t,e)=>{if(Yt){const i=Tt(t);return xt(i,e)}else{return{base64:true,data:t}}};const xt=(t,e)=>{switch(e){case"blob":if(t instanceof Blob){return t}else{return new Blob([t])}case"arraybuffer":default:if(t instanceof ArrayBuffer){return t}else{return t.buffer}}};const Rt=String.fromCharCode(30);const Nt=(t,e)=>{const i=t.length;const s=new Array(i);let n=0;t.forEach(((t,o)=>{Dt(t,false,(t=>{s[o]=t;if(++n===i){e(s.join(Rt))}}))}))};const Bt=(t,e)=>{const i=t.split(Rt);const s=[];for(let t=0;t<i.length;t++){const n=Mt(i[t],e);s.push(n);if(n.type==="error"){break}}return s};function It(){return new TransformStream({transform(t,e){St(t,(i=>{const s=i.length;let n;if(s<126){n=new Uint8Array(1);new DataView(n.buffer).setUint8(0,s)}else if(s<65536){n=new Uint8Array(3);const t=new DataView(n.buffer);t.setUint8(0,126);t.setUint16(1,s)}else{n=new Uint8Array(9);const t=new DataView(n.buffer);t.setUint8(0,127);t.setBigUint64(1,BigInt(s))}if(t.data&&typeof t.data!=="string"){n[0]|=128}e.enqueue(n);e.enqueue(i)}))}})}let Lt;function Ut(t){return t.reduce(((t,e)=>t+e.length),0)}function jt(t,e){if(t[0].length===e){return t.shift()}const i=new Uint8Array(e);let s=0;for(let n=0;n<e;n++){i[n]=t[0][s++];if(s===t[0].length){t.shift();s=0}}if(t.length&&s<t[0].length){t[0]=t[0].slice(s)}return i}function Ft(t,e){if(!Lt){Lt=new TextDecoder}const i=[];let s=0;let n=-1;let o=false;return new TransformStream({transform(r,a){i.push(r);while(true){if(s===0){if(Ut(i)<1){break}const t=jt(i,1);o=(t[0]&128)===128;n=t[0]&127;if(n<126){s=3}else if(n===126){s=1}else{s=2}}else if(s===1){if(Ut(i)<2){break}const t=jt(i,2);n=new DataView(t.buffer,t.byteOffset,t.length).getUint16(0);s=3}else if(s===2){if(Ut(i)<8){break}const t=jt(i,8);const e=new DataView(t.buffer,t.byteOffset,t.length);const o=e.getUint32(0);if(o>Math.pow(2,53-32)-1){a.enqueue(_t);break}n=o*Math.pow(2,32)+e.getUint32(4);s=3}else{if(Ut(i)<n){break}const t=jt(i,n);a.enqueue(Mt(o?t:Lt.decode(t),e));s=0}if(n===0||n>t){a.enqueue(_t);break}}}})}const Ht=4;function zt(t){if(t)return Gt(t)}function Gt(t){for(var e in zt.prototype){t[e]=zt.prototype[e]}return t}zt.prototype.on=zt.prototype.addEventListener=function(t,e){this._callbacks=this._callbacks||{};(this._callbacks["$"+t]=this._callbacks["$"+t]||[]).push(e);return this};zt.prototype.once=function(t,e){function i(){this.off(t,i);e.apply(this,arguments)}i.fn=e;this.on(t,i);return this};zt.prototype.off=zt.prototype.removeListener=zt.prototype.removeAllListeners=zt.prototype.removeEventListener=function(t,e){this._callbacks=this._callbacks||{};if(0==arguments.length){this._callbacks={};return this}var i=this._callbacks["$"+t];if(!i)return this;if(1==arguments.length){delete this._callbacks["$"+t];return this}var s;for(var n=0;n<i.length;n++){s=i[n];if(s===e||s.fn===e){i.splice(n,1);break}}if(i.length===0){delete this._callbacks["$"+t]}return this};zt.prototype.emit=function(t){this._callbacks=this._callbacks||{};var e=new Array(arguments.length-1),i=this._callbacks["$"+t];for(var s=1;s<arguments.length;s++){e[s-1]=arguments[s]}if(i){i=i.slice(0);for(var s=0,n=i.length;s<n;++s){i[s].apply(this,e)}}return this};zt.prototype.emitReserved=zt.prototype.emit;zt.prototype.listeners=function(t){this._callbacks=this._callbacks||{};return this._callbacks["$"+t]||[]};zt.prototype.hasListeners=function(t){return!!this.listeners(t).length};const $t=(()=>{const t=typeof Promise==="function"&&typeof Promise.resolve==="function";if(t){return t=>Promise.resolve().then(t)}else{return(t,e)=>e(t,0)}})();const Kt=(()=>{if(typeof self!=="undefined"){return self}else if(typeof window!=="undefined"){return window}else{return Function("return this")()}})();const qt="arraybuffer";function Vt(){}function Wt(t,...e){return e.reduce(((e,i)=>{if(t.hasOwnProperty(i)){e[i]=t[i]}return e}),{})}const Jt=Kt.setTimeout;const Xt=Kt.clearTimeout;function Qt(t,e){if(e.useNativeTimers){t.setTimeoutFn=Jt.bind(Kt);t.clearTimeoutFn=Xt.bind(Kt)}else{t.setTimeoutFn=Kt.setTimeout.bind(Kt);t.clearTimeoutFn=Kt.clearTimeout.bind(Kt)}}const Zt=1.33;function te(t){if(typeof t==="string"){return ee(t)}return Math.ceil((t.byteLength||t.size)*Zt)}function ee(t){let e=0,i=0;for(let s=0,n=t.length;s<n;s++){e=t.charCodeAt(s);if(e<128){i+=1}else if(e<2048){i+=2}else if(e<55296||e>=57344){i+=3}else{s++;i+=4}}return i}function ie(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}function se(t){let e="";for(let i in t){if(t.hasOwnProperty(i)){if(e.length)e+="&";e+=encodeURIComponent(i)+"="+encodeURIComponent(t[i])}}return e}function ne(t){let e={};let i=t.split("&");for(let t=0,s=i.length;t<s;t++){let s=i[t].split("=");e[decodeURIComponent(s[0])]=decodeURIComponent(s[1])}return e}class oe extends Error{constructor(t,e,i){super(t);this.description=e;this.context=i;this.type="TransportError"}}class re extends zt{constructor(t){super();this.writable=false;Qt(this,t);this.opts=t;this.query=t.query;this.socket=t.socket;this.supportsBinary=!t.forceBase64}onError(t,e,i){super.emitReserved("error",new oe(t,e,i));return this}open(){this.readyState="opening";this.doOpen();return this}close(){if(this.readyState==="opening"||this.readyState==="open"){this.doClose();this.onClose()}return this}send(t){if(this.readyState==="open"){this.write(t)}}onOpen(){this.readyState="open";this.writable=true;super.emitReserved("open")}onData(t){const e=Mt(t,this.socket.binaryType);this.onPacket(e)}onPacket(t){super.emitReserved("packet",t)}onClose(t){this.readyState="closed";super.emitReserved("close",t)}pause(t){}createUri(t,e={}){return t+"://"+this._hostname()+this._port()+this.opts.path+this._query(e)}_hostname(){const t=this.opts.hostname;return t.indexOf(":")===-1?t:"["+t+"]"}_port(){if(this.opts.port&&(this.opts.secure&&Number(this.opts.port!==443)||!this.opts.secure&&Number(this.opts.port)!==80)){return":"+this.opts.port}else{return""}}_query(t){const e=se(t);return e.length?"?"+e:""}}class ae extends re{constructor(){super(...arguments);this._polling=false}get name(){return"polling"}doOpen(){this._poll()}pause(t){this.readyState="pausing";const e=()=>{this.readyState="paused";t()};if(this._polling||!this.writable){let t=0;if(this._polling){t++;this.once("pollComplete",(function(){--t||e()}))}if(!this.writable){t++;this.once("drain",(function(){--t||e()}))}}else{e()}}_poll(){this._polling=true;this.doPoll();this.emitReserved("poll")}onData(t){const e=t=>{if("opening"===this.readyState&&t.type==="open"){this.onOpen()}if("close"===t.type){this.onClose({description:"transport closed by the server"});return false}this.onPacket(t)};Bt(t,this.socket.binaryType).forEach(e);if("closed"!==this.readyState){this._polling=false;this.emitReserved("pollComplete");if("open"===this.readyState){this._poll()}}}doClose(){const t=()=>{this.write([{type:"close"}])};if("open"===this.readyState){t()}else{this.once("open",t)}}write(t){this.writable=false;Nt(t,(t=>{this.doWrite(t,(()=>{this.writable=true;this.emitReserved("drain")}))}))}uri(){const t=this.opts.secure?"https":"http";const e=this.query||{};if(false!==this.opts.timestampRequests){e[this.opts.timestampParam]=ie()}if(!this.supportsBinary&&!e.sid){e.b64=1}return this.createUri(t,e)}}let he=false;try{he=typeof XMLHttpRequest!=="undefined"&&"withCredentials"in new XMLHttpRequest}catch(t){}const le=he;function ce(){}class ue extends ae{constructor(t){super(t);if(typeof location!=="undefined"){const e="https:"===location.protocol;let i=location.port;if(!i){i=e?"443":"80"}this.xd=typeof location!=="undefined"&&t.hostname!==location.hostname||i!==t.port}}doWrite(t,e){const i=this.request({method:"POST",data:t});i.on("success",e);i.on("error",((t,e)=>{this.onError("xhr post error",t,e)}))}doPoll(){const t=this.request();t.on("data",this.onData.bind(this));t.on("error",((t,e)=>{this.onError("xhr poll error",t,e)}));this.pollXhr=t}}class de extends zt{constructor(t,e,i){super();this.createRequest=t;Qt(this,i);this._opts=i;this._method=i.method||"GET";this._uri=e;this._data=undefined!==i.data?i.data:null;this._create()}_create(){var t;const e=Wt(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");e.xdomain=!!this._opts.xd;const i=this._xhr=this.createRequest(e);try{i.open(this._method,this._uri,true);try{if(this._opts.extraHeaders){i.setDisableHeaderCheck&&i.setDisableHeaderCheck(true);for(let t in this._opts.extraHeaders){if(this._opts.extraHeaders.hasOwnProperty(t)){i.setRequestHeader(t,this._opts.extraHeaders[t])}}}}catch(t){}if("POST"===this._method){try{i.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(t){}}try{i.setRequestHeader("Accept","*/*")}catch(t){}(t=this._opts.cookieJar)===null||t===void 0?void 0:t.addCookies(i);if("withCredentials"in i){i.withCredentials=this._opts.withCredentials}if(this._opts.requestTimeout){i.timeout=this._opts.requestTimeout}i.onreadystatechange=()=>{var t;if(i.readyState===3){(t=this._opts.cookieJar)===null||t===void 0?void 0:t.parseCookies(i.getResponseHeader("set-cookie"))}if(4!==i.readyState)return;if(200===i.status||1223===i.status){this._onLoad()}else{this.setTimeoutFn((()=>{this._onError(typeof i.status==="number"?i.status:0)}),0)}};i.send(this._data)}catch(t){this.setTimeoutFn((()=>{this._onError(t)}),0);return}if(typeof document!=="undefined"){this._index=de.requestsCount++;de.requests[this._index]=this}}_onError(t){this.emitReserved("error",t,this._xhr);this._cleanup(true)}_cleanup(t){if("undefined"===typeof this._xhr||null===this._xhr){return}this._xhr.onreadystatechange=ce;if(t){try{this._xhr.abort()}catch(t){}}if(typeof document!=="undefined"){delete de.requests[this._index]}this._xhr=null}_onLoad(){const t=this._xhr.responseText;if(t!==null){this.emitReserved("data",t);this.emitReserved("success");this._cleanup()}}abort(){this._cleanup()}}de.requestsCount=0;de.requests={};if(typeof document!=="undefined"){if(typeof attachEvent==="function"){attachEvent("onunload",fe)}else if(typeof addEventListener==="function"){const t="onpagehide"in Kt?"pagehide":"unload";addEventListener(t,fe,false)}}function fe(){for(let t in de.requests){if(de.requests.hasOwnProperty(t)){de.requests[t].abort()}}}const pe=function(){const t=ye({xdomain:false});return t&&t.responseType!==null}();class ge extends ue{constructor(t){super(t);const e=t&&t.forceBase64;this.supportsBinary=pe&&!e}request(t={}){Object.assign(t,{xd:this.xd},this.opts);return new de(ye,this.uri(),t)}}function ye(t){const e=t.xdomain;try{if("undefined"!==typeof XMLHttpRequest&&(!e||le)){return new XMLHttpRequest}}catch(t){}if(!e){try{return new(Kt[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(t){}}}const me=typeof navigator!=="undefined"&&typeof navigator.product==="string"&&navigator.product.toLowerCase()==="reactnative";class _e extends re{get name(){return"websocket"}doOpen(){const t=this.uri();const e=this.opts.protocols;const i=me?{}:Wt(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");if(this.opts.extraHeaders){i.headers=this.opts.extraHeaders}try{this.ws=this.createSocket(t,e,i)}catch(t){return this.emitReserved("error",t)}this.ws.binaryType=this.socket.binaryType;this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{if(this.opts.autoUnref){this.ws._socket.unref()}this.onOpen()};this.ws.onclose=t=>this.onClose({description:"websocket connection closed",context:t});this.ws.onmessage=t=>this.onData(t.data);this.ws.onerror=t=>this.onError("websocket error",t)}write(t){this.writable=false;for(let e=0;e<t.length;e++){const i=t[e];const s=e===t.length-1;Dt(i,this.supportsBinary,(t=>{try{this.doWrite(i,t)}catch(t){}if(s){$t((()=>{this.writable=true;this.emitReserved("drain")}),this.setTimeoutFn)}}))}}doClose(){if(typeof this.ws!=="undefined"){this.ws.onerror=()=>{};this.ws.close();this.ws=null}}uri(){const t=this.opts.secure?"wss":"ws";const e=this.query||{};if(this.opts.timestampRequests){e[this.opts.timestampParam]=ie()}if(!this.supportsBinary){e.b64=1}return this.createUri(t,e)}}const be=Kt.WebSocket||Kt.MozWebSocket;class we extends _e{createSocket(t,e,i){return!me?e?new be(t,e):new be(t):new be(t,e,i)}doWrite(t,e){this.ws.send(e)}}class ke extends re{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(t){return this.emitReserved("error",t)}this._transport.closed.then((()=>{this.onClose()})).catch((t=>{this.onError("webtransport error",t)}));this._transport.ready.then((()=>{this._transport.createBidirectionalStream().then((t=>{const e=Ft(Number.MAX_SAFE_INTEGER,this.socket.binaryType);const i=t.readable.pipeThrough(e).getReader();const s=It();s.readable.pipeTo(t.writable);this._writer=s.writable.getWriter();const n=()=>{i.read().then((({done:t,value:e})=>{if(t){return}this.onPacket(e);n()})).catch((t=>{}))};n();const o={type:"open"};if(this.query.sid){o.data=`{"sid":"${this.query.sid}"}`}this._writer.write(o).then((()=>this.onOpen()))}))}))}write(t){this.writable=false;for(let e=0;e<t.length;e++){const i=t[e];const s=e===t.length-1;this._writer.write(i).then((()=>{if(s){$t((()=>{this.writable=true;this.emitReserved("drain")}),this.setTimeoutFn)}}))}}doClose(){var t;(t=this._transport)===null||t===void 0?void 0:t.close()}}const De={websocket:we,webtransport:ke,polling:ge};const ve=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/;const Ee=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function Ce(t){if(t.length>8e3){throw"URI too long"}const e=t,i=t.indexOf("["),s=t.indexOf("]");if(i!=-1&&s!=-1){t=t.substring(0,i)+t.substring(i,s).replace(/:/g,";")+t.substring(s,t.length)}let n=ve.exec(t||""),o={},r=14;while(r--){o[Ee[r]]=n[r]||""}if(i!=-1&&s!=-1){o.source=e;o.host=o.host.substring(1,o.host.length-1).replace(/;/g,":");o.authority=o.authority.replace("[","").replace("]","").replace(/;/g,":");o.ipv6uri=true}o.pathNames=Se(o,o["path"]);o.queryKey=Ae(o,o["query"]);return o}function Se(t,e){const i=/\/{2,9}/g,s=e.replace(i,"/").split("/");if(e.slice(0,1)=="/"||e.length===0){s.splice(0,1)}if(e.slice(-1)=="/"){s.splice(s.length-1,1)}return s}function Ae(t,e){const i={};e.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,(function(t,e,s){if(e){i[e]=s}}));return i}const Oe=typeof addEventListener==="function"&&typeof removeEventListener==="function";const Te=[];if(Oe){addEventListener("offline",(()=>{Te.forEach((t=>t()))}),false)}class Ye extends zt{constructor(t,e){super();this.binaryType=qt;this.writeBuffer=[];this._prevBufferLen=0;this._pingInterval=-1;this._pingTimeout=-1;this._maxPayload=-1;this._pingTimeoutTime=Infinity;if(t&&"object"===typeof t){e=t;t=null}if(t){const i=Ce(t);e.hostname=i.host;e.secure=i.protocol==="https"||i.protocol==="wss";e.port=i.port;if(i.query)e.query=i.query}else if(e.host){e.hostname=Ce(e.host).host}Qt(this,e);this.secure=null!=e.secure?e.secure:typeof location!=="undefined"&&"https:"===location.protocol;if(e.hostname&&!e.port){e.port=this.secure?"443":"80"}this.hostname=e.hostname||(typeof location!=="undefined"?location.hostname:"localhost");this.port=e.port||(typeof location!=="undefined"&&location.port?location.port:this.secure?"443":"80");this.transports=[];this._transportsByName={};e.transports.forEach((t=>{const e=t.prototype.name;this.transports.push(e);this._transportsByName[e]=t}));this.opts=Object.assign({path:"/engine.io",agent:false,withCredentials:false,upgrade:true,timestampParam:"t",rememberUpgrade:false,addTrailingSlash:true,rejectUnauthorized:true,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:false},e);this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":"");if(typeof this.opts.query==="string"){this.opts.query=ne(this.opts.query)}if(Oe){if(this.opts.closeOnBeforeunload){this._beforeunloadEventListener=()=>{if(this.transport){this.transport.removeAllListeners();this.transport.close()}};addEventListener("beforeunload",this._beforeunloadEventListener,false)}if(this.hostname!=="localhost"){this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})};Te.push(this._offlineEventListener)}}if(this.opts.withCredentials){this._cookieJar=Vt()}this._open()}createTransport(t){const e=Object.assign({},this.opts.query);e.EIO=Ht;e.transport=t;if(this.id)e.sid=this.id;const i=Object.assign({},this.opts,{query:e,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[t]);return new this._transportsByName[t](i)}_open(){if(this.transports.length===0){this.setTimeoutFn((()=>{this.emitReserved("error","No transports available")}),0);return}const t=this.opts.rememberUpgrade&&Ye.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1?"websocket":this.transports[0];this.readyState="opening";const e=this.createTransport(t);e.open();this.setTransport(e)}setTransport(t){if(this.transport){this.transport.removeAllListeners()}this.transport=t;t.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",(t=>this._onClose("transport close",t)))}onOpen(){this.readyState="open";Ye.priorWebsocketSuccess="websocket"===this.transport.name;this.emitReserved("open");this.flush()}_onPacket(t){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState){this.emitReserved("packet",t);this.emitReserved("heartbeat");switch(t.type){case"open":this.onHandshake(JSON.parse(t.data));break;case"ping":this._sendPacket("pong");this.emitReserved("ping");this.emitReserved("pong");this._resetPingTimeout();break;case"error":const e=new Error("server error");e.code=t.data;this._onError(e);break;case"message":this.emitReserved("data",t.data);this.emitReserved("message",t.data);break}}}onHandshake(t){this.emitReserved("handshake",t);this.id=t.sid;this.transport.query.sid=t.sid;this._pingInterval=t.pingInterval;this._pingTimeout=t.pingTimeout;this._maxPayload=t.maxPayload;this.onOpen();if("closed"===this.readyState)return;this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const t=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+t;this._pingTimeoutTimer=this.setTimeoutFn((()=>{this._onClose("ping timeout")}),t);if(this.opts.autoUnref){this._pingTimeoutTimer.unref()}}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen);this._prevBufferLen=0;if(0===this.writeBuffer.length){this.emitReserved("drain")}else{this.flush()}}flush(){if("closed"!==this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const t=this._getWritablePackets();this.transport.send(t);this._prevBufferLen=t.length;this.emitReserved("flush")}}_getWritablePackets(){const t=this._maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1;if(!t){return this.writeBuffer}let e=1;for(let t=0;t<this.writeBuffer.length;t++){const i=this.writeBuffer[t].data;if(i){e+=te(i)}if(t>0&&e>this._maxPayload){return this.writeBuffer.slice(0,t)}e+=2}return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return true;const t=Date.now()>this._pingTimeoutTime;if(t){this._pingTimeoutTime=0;$t((()=>{this._onClose("ping timeout")}),this.setTimeoutFn)}return t}write(t,e,i){this._sendPacket("message",t,e,i);return this}send(t,e,i){this._sendPacket("message",t,e,i);return this}_sendPacket(t,e,i,s){if("function"===typeof e){s=e;e=undefined}if("function"===typeof i){s=i;i=null}if("closing"===this.readyState||"closed"===this.readyState){return}i=i||{};i.compress=false!==i.compress;const n={type:t,data:e,options:i};this.emitReserved("packetCreate",n);this.writeBuffer.push(n);if(s)this.once("flush",s);this.flush()}close(){const t=()=>{this._onClose("forced close");this.transport.close()};const e=()=>{this.off("upgrade",e);this.off("upgradeError",e);t()};const i=()=>{this.once("upgrade",e);this.once("upgradeError",e)};if("opening"===this.readyState||"open"===this.readyState){this.readyState="closing";if(this.writeBuffer.length){this.once("drain",(()=>{if(this.upgrading){i()}else{t()}}))}else if(this.upgrading){i()}else{t()}}return this}_onError(t){Ye.priorWebsocketSuccess=false;if(this.opts.tryAllTransports&&this.transports.length>1&&this.readyState==="opening"){this.transports.shift();return this._open()}this.emitReserved("error",t);this._onClose("transport error",t)}_onClose(t,e){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState){this.clearTimeoutFn(this._pingTimeoutTimer);this.transport.removeAllListeners("close");this.transport.close();this.transport.removeAllListeners();if(Oe){if(this._beforeunloadEventListener){removeEventListener("beforeunload",this._beforeunloadEventListener,false)}if(this._offlineEventListener){const t=Te.indexOf(this._offlineEventListener);if(t!==-1){Te.splice(t,1)}}}this.readyState="closed";this.id=null;this.emitReserved("close",t,e);this.writeBuffer=[];this._prevBufferLen=0}}}Ye.protocol=Ht;class Me extends Ye{constructor(){super(...arguments);this._upgrades=[]}onOpen(){super.onOpen();if("open"===this.readyState&&this.opts.upgrade){for(let t=0;t<this._upgrades.length;t++){this._probe(this._upgrades[t])}}}_probe(t){let e=this.createTransport(t);let i=false;Ye.priorWebsocketSuccess=false;const s=()=>{if(i)return;e.send([{type:"ping",data:"probe"}]);e.once("packet",(t=>{if(i)return;if("pong"===t.type&&"probe"===t.data){this.upgrading=true;this.emitReserved("upgrading",e);if(!e)return;Ye.priorWebsocketSuccess="websocket"===e.name;this.transport.pause((()=>{if(i)return;if("closed"===this.readyState)return;l();this.setTransport(e);e.send([{type:"upgrade"}]);this.emitReserved("upgrade",e);e=null;this.upgrading=false;this.flush()}))}else{const t=new Error("probe error");t.transport=e.name;this.emitReserved("upgradeError",t)}}))};function n(){if(i)return;i=true;l();e.close();e=null}const o=t=>{const i=new Error("probe error: "+t);i.transport=e.name;n();this.emitReserved("upgradeError",i)};function r(){o("transport closed")}function a(){o("socket closed")}function h(t){if(e&&t.name!==e.name){n()}}const l=()=>{e.removeListener("open",s);e.removeListener("error",o);e.removeListener("close",r);this.off("close",a);this.off("upgrading",h)};e.once("open",s);e.once("error",o);e.once("close",r);this.once("close",a);this.once("upgrading",h);if(this._upgrades.indexOf("webtransport")!==-1&&t!=="webtransport"){this.setTimeoutFn((()=>{if(!i){e.open()}}),200)}else{e.open()}}onHandshake(t){this._upgrades=this._filterUpgrades(t.upgrades);super.onHandshake(t)}_filterUpgrades(t){const e=[];for(let i=0;i<t.length;i++){if(~this.transports.indexOf(t[i]))e.push(t[i])}return e}}class Pe extends Me{constructor(t,e={}){const i=typeof t==="object"?t:e;if(!i.transports||i.transports&&typeof i.transports[0]==="string"){i.transports=(i.transports||["polling","websocket","webtransport"]).map((t=>De[t])).filter((t=>!!t))}super(t,i)}}function xe(t,e="",i){let s=t;i=i||typeof location!=="undefined"&&location;if(null==t)t=i.protocol+"//"+i.host;if(typeof t==="string"){if("/"===t.charAt(0)){if("/"===t.charAt(1)){t=i.protocol+t}else{t=i.host+t}}if(!/^(https?|wss?):\/\//.test(t)){if("undefined"!==typeof i){t=i.protocol+"//"+t}else{t="https://"+t}}s=Ce(t)}if(!s.port){if(/^(http|ws)$/.test(s.protocol)){s.port="80"}else if(/^(http|ws)s$/.test(s.protocol)){s.port="443"}}s.path=s.path||"/";const n=s.host.indexOf(":")!==-1;const o=n?"["+s.host+"]":s.host;s.id=s.protocol+"://"+o+":"+s.port+e;s.href=s.protocol+"://"+o+(i&&i.port===s.port?"":":"+s.port);return s}const Re=typeof ArrayBuffer==="function";const Ne=t=>typeof ArrayBuffer.isView==="function"?ArrayBuffer.isView(t):t.buffer instanceof ArrayBuffer;const Be=Object.prototype.toString;const Ie=typeof Blob==="function"||typeof Blob!=="undefined"&&Be.call(Blob)==="[object BlobConstructor]";const Le=typeof File==="function"||typeof File!=="undefined"&&Be.call(File)==="[object FileConstructor]";function Ue(t){return Re&&(t instanceof ArrayBuffer||Ne(t))||Ie&&t instanceof Blob||Le&&t instanceof File}function je(t,e){if(!t||typeof t!=="object"){return false}if(Array.isArray(t)){for(let e=0,i=t.length;e<i;e++){if(je(t[e])){return true}}return false}if(Ue(t)){return true}if(t.toJSON&&typeof t.toJSON==="function"&&arguments.length===1){return je(t.toJSON(),true)}for(const e in t){if(Object.prototype.hasOwnProperty.call(t,e)&&je(t[e])){return true}}return false}function Fe(t){const e=[];const i=t.data;const s=t;s.data=He(i,e);s.attachments=e.length;return{packet:s,buffers:e}}function He(t,e){if(!t)return t;if(Ue(t)){const i={_placeholder:true,num:e.length};e.push(t);return i}else if(Array.isArray(t)){const i=new Array(t.length);for(let s=0;s<t.length;s++){i[s]=He(t[s],e)}return i}else if(typeof t==="object"&&!(t instanceof Date)){const i={};for(const s in t){if(Object.prototype.hasOwnProperty.call(t,s)){i[s]=He(t[s],e)}}return i}return t}function ze(t,e){t.data=Ge(t.data,e);delete t.attachments;return t}function Ge(t,e){if(!t)return t;if(t&&t._placeholder===true){const i=typeof t.num==="number"&&t.num>=0&&t.num<e.length;if(i){return e[t.num]}else{throw new Error("illegal attachments")}}else if(Array.isArray(t)){for(let i=0;i<t.length;i++){t[i]=Ge(t[i],e)}}else if(typeof t==="object"){for(const i in t){if(Object.prototype.hasOwnProperty.call(t,i)){t[i]=Ge(t[i],e)}}}return t}const $e=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"];const Ke=5;var qe;(function(t){t[t["CONNECT"]=0]="CONNECT";t[t["DISCONNECT"]=1]="DISCONNECT";t[t["EVENT"]=2]="EVENT";t[t["ACK"]=3]="ACK";t[t["CONNECT_ERROR"]=4]="CONNECT_ERROR";t[t["BINARY_EVENT"]=5]="BINARY_EVENT";t[t["BINARY_ACK"]=6]="BINARY_ACK"})(qe||(qe={}));class Ve{constructor(t){this.replacer=t}encode(t){if(t.type===qe.EVENT||t.type===qe.ACK){if(je(t)){return this.encodeAsBinary({type:t.type===qe.EVENT?qe.BINARY_EVENT:qe.BINARY_ACK,nsp:t.nsp,data:t.data,id:t.id})}}return[this.encodeAsString(t)]}encodeAsString(t){let e=""+t.type;if(t.type===qe.BINARY_EVENT||t.type===qe.BINARY_ACK){e+=t.attachments+"-"}if(t.nsp&&"/"!==t.nsp){e+=t.nsp+","}if(null!=t.id){e+=t.id}if(null!=t.data){e+=JSON.stringify(t.data,this.replacer)}return e}encodeAsBinary(t){const e=Fe(t);const i=this.encodeAsString(e.packet);const s=e.buffers;s.unshift(i);return s}}function We(t){return Object.prototype.toString.call(t)==="[object Object]"}class Je extends zt{constructor(t){super();this.reviver=t}add(t){let e;if(typeof t==="string"){if(this.reconstructor){throw new Error("got plaintext data when reconstructing a packet")}e=this.decodeString(t);const i=e.type===qe.BINARY_EVENT;if(i||e.type===qe.BINARY_ACK){e.type=i?qe.EVENT:qe.ACK;this.reconstructor=new Xe(e);if(e.attachments===0){super.emitReserved("decoded",e)}}else{super.emitReserved("decoded",e)}}else if(Ue(t)||t.base64){if(!this.reconstructor){throw new Error("got binary data when not reconstructing a packet")}else{e=this.reconstructor.takeBinaryData(t);if(e){this.reconstructor=null;super.emitReserved("decoded",e)}}}else{throw new Error("Unknown type: "+t)}}decodeString(t){let e=0;const i={type:Number(t.charAt(0))};if(qe[i.type]===undefined){throw new Error("unknown packet type "+i.type)}if(i.type===qe.BINARY_EVENT||i.type===qe.BINARY_ACK){const s=e+1;while(t.charAt(++e)!=="-"&&e!=t.length){}const n=t.substring(s,e);if(n!=Number(n)||t.charAt(e)!=="-"){throw new Error("Illegal attachments")}i.attachments=Number(n)}if("/"===t.charAt(e+1)){const s=e+1;while(++e){const i=t.charAt(e);if(","===i)break;if(e===t.length)break}i.nsp=t.substring(s,e)}else{i.nsp="/"}const s=t.charAt(e+1);if(""!==s&&Number(s)==s){const s=e+1;while(++e){const i=t.charAt(e);if(null==i||Number(i)!=i){--e;break}if(e===t.length)break}i.id=Number(t.substring(s,e+1))}if(t.charAt(++e)){const s=this.tryParse(t.substr(e));if(Je.isPayloadValid(i.type,s)){i.data=s}else{throw new Error("invalid payload")}}return i}tryParse(t){try{return JSON.parse(t,this.reviver)}catch(t){return false}}static isPayloadValid(t,e){switch(t){case qe.CONNECT:return We(e);case qe.DISCONNECT:return e===undefined;case qe.CONNECT_ERROR:return typeof e==="string"||We(e);case qe.EVENT:case qe.BINARY_EVENT:return Array.isArray(e)&&(typeof e[0]==="number"||typeof e[0]==="string"&&$e.indexOf(e[0])===-1);case qe.ACK:case qe.BINARY_ACK:return Array.isArray(e)}}destroy(){if(this.reconstructor){this.reconstructor.finishedReconstruction();this.reconstructor=null}}}class Xe{constructor(t){this.packet=t;this.buffers=[];this.reconPack=t}takeBinaryData(t){this.buffers.push(t);if(this.buffers.length===this.reconPack.attachments){const t=ze(this.reconPack,this.buffers);this.finishedReconstruction();return t}return null}finishedReconstruction(){this.reconPack=null;this.buffers=[]}}const Qe=Object.freeze({__proto__:null,protocol:Ke,get PacketType(){return qe},Encoder:Ve,Decoder:Je});function Ze(t,e,i){t.on(e,i);return function s(){t.off(e,i)}}const ti=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class ei extends zt{constructor(t,e,i){super();this.connected=false;this.recovered=false;this.receiveBuffer=[];this.sendBuffer=[];this._queue=[];this._queueSeq=0;this.ids=0;this.acks={};this.flags={};this.io=t;this.nsp=e;if(i&&i.auth){this.auth=i.auth}this._opts=Object.assign({},i);if(this.io._autoConnect)this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const t=this.io;this.subs=[Ze(t,"open",this.onopen.bind(this)),Ze(t,"packet",this.onpacket.bind(this)),Ze(t,"error",this.onerror.bind(this)),Ze(t,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){if(this.connected)return this;this.subEvents();if(!this.io["_reconnecting"])this.io.open();if("open"===this.io._readyState)this.onopen();return this}open(){return this.connect()}send(...t){t.unshift("message");this.emit.apply(this,t);return this}emit(t,...e){var i,s,n;if(ti.hasOwnProperty(t)){throw new Error('"'+t.toString()+'" is a reserved event name')}e.unshift(t);if(this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile){this._addToQueue(e);return this}const o={type:qe.EVENT,data:e};o.options={};o.options.compress=this.flags.compress!==false;if("function"===typeof e[e.length-1]){const t=this.ids++;const i=e.pop();this._registerAckCallback(t,i);o.id=t}const r=(s=(i=this.io.engine)===null||i===void 0?void 0:i.transport)===null||s===void 0?void 0:s.writable;const a=this.connected&&!((n=this.io.engine)===null||n===void 0?void 0:n._hasPingExpired());const h=this.flags.volatile&&!r;if(h);else if(a){this.notifyOutgoingListeners(o);this.packet(o)}else{this.sendBuffer.push(o)}this.flags={};return this}_registerAckCallback(t,e){var i;const s=(i=this.flags.timeout)!==null&&i!==void 0?i:this._opts.ackTimeout;if(s===undefined){this.acks[t]=e;return}const n=this.io.setTimeoutFn((()=>{delete this.acks[t];for(let e=0;e<this.sendBuffer.length;e++){if(this.sendBuffer[e].id===t){this.sendBuffer.splice(e,1)}}e.call(this,new Error("operation has timed out"))}),s);const o=(...t)=>{this.io.clearTimeoutFn(n);e.apply(this,t)};o.withError=true;this.acks[t]=o}emitWithAck(t,...e){return new Promise(((i,s)=>{const n=(t,e)=>t?s(t):i(e);n.withError=true;e.push(n);this.emit(t,...e)}))}_addToQueue(t){let e;if(typeof t[t.length-1]==="function"){e=t.pop()}const i={id:this._queueSeq++,tryCount:0,pending:false,args:t,flags:Object.assign({fromQueue:true},this.flags)};t.push(((t,...s)=>{if(i!==this._queue[0]){return}const n=t!==null;if(n){if(i.tryCount>this._opts.retries){this._queue.shift();if(e){e(t)}}}else{this._queue.shift();if(e){e(null,...s)}}i.pending=false;return this._drainQueue()}));this._queue.push(i);this._drainQueue()}_drainQueue(t=false){if(!this.connected||this._queue.length===0){return}const e=this._queue[0];if(e.pending&&!t){return}e.pending=true;e.tryCount++;this.flags=e.flags;this.emit.apply(this,e.args)}packet(t){t.nsp=this.nsp;this.io._packet(t)}onopen(){if(typeof this.auth=="function"){this.auth((t=>{this._sendConnectPacket(t)}))}else{this._sendConnectPacket(this.auth)}}_sendConnectPacket(t){this.packet({type:qe.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},t):t})}onerror(t){if(!this.connected){this.emitReserved("connect_error",t)}}onclose(t,e){this.connected=false;delete this.id;this.emitReserved("disconnect",t,e);this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach((t=>{const e=this.sendBuffer.some((e=>String(e.id)===t));if(!e){const e=this.acks[t];delete this.acks[t];if(e.withError){e.call(this,new Error("socket has been disconnected"))}}}))}onpacket(t){const e=t.nsp===this.nsp;if(!e)return;switch(t.type){case qe.CONNECT:if(t.data&&t.data.sid){this.onconnect(t.data.sid,t.data.pid)}else{this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"))}break;case qe.EVENT:case qe.BINARY_EVENT:this.onevent(t);break;case qe.ACK:case qe.BINARY_ACK:this.onack(t);break;case qe.DISCONNECT:this.ondisconnect();break;case qe.CONNECT_ERROR:this.destroy();const e=new Error(t.data.message);e.data=t.data.data;this.emitReserved("connect_error",e);break}}onevent(t){const e=t.data||[];if(null!=t.id){e.push(this.ack(t.id))}if(this.connected){this.emitEvent(e)}else{this.receiveBuffer.push(Object.freeze(e))}}emitEvent(t){if(this._anyListeners&&this._anyListeners.length){const e=this._anyListeners.slice();for(const i of e){i.apply(this,t)}}super.emit.apply(this,t);if(this._pid&&t.length&&typeof t[t.length-1]==="string"){this._lastOffset=t[t.length-1]}}ack(t){const e=this;let i=false;return function(...s){if(i)return;i=true;e.packet({type:qe.ACK,id:t,data:s})}}onack(t){const e=this.acks[t.id];if(typeof e!=="function"){return}delete this.acks[t.id];if(e.withError){t.data.unshift(null)}e.apply(this,t.data)}onconnect(t,e){this.id=t;this.recovered=e&&this._pid===e;this._pid=e;this.connected=true;this.emitBuffered();this.emitReserved("connect");this._drainQueue(true)}emitBuffered(){this.receiveBuffer.forEach((t=>this.emitEvent(t)));this.receiveBuffer=[];this.sendBuffer.forEach((t=>{this.notifyOutgoingListeners(t);this.packet(t)}));this.sendBuffer=[]}ondisconnect(){this.destroy();this.onclose("io server disconnect")}destroy(){if(this.subs){this.subs.forEach((t=>t()));this.subs=undefined}this.io["_destroy"](this)}disconnect(){if(this.connected){this.packet({type:qe.DISCONNECT})}this.destroy();if(this.connected){this.onclose("io client disconnect")}return this}close(){return this.disconnect()}compress(t){this.flags.compress=t;return this}get volatile(){this.flags.volatile=true;return this}timeout(t){this.flags.timeout=t;return this}onAny(t){this._anyListeners=this._anyListeners||[];this._anyListeners.push(t);return this}prependAny(t){this._anyListeners=this._anyListeners||[];this._anyListeners.unshift(t);return this}offAny(t){if(!this._anyListeners){return this}if(t){const e=this._anyListeners;for(let i=0;i<e.length;i++){if(t===e[i]){e.splice(i,1);return this}}}else{this._anyListeners=[]}return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(t){this._anyOutgoingListeners=this._anyOutgoingListeners||[];this._anyOutgoingListeners.push(t);return this}prependAnyOutgoing(t){this._anyOutgoingListeners=this._anyOutgoingListeners||[];this._anyOutgoingListeners.unshift(t);return this}offAnyOutgoing(t){if(!this._anyOutgoingListeners){return this}if(t){const e=this._anyOutgoingListeners;for(let i=0;i<e.length;i++){if(t===e[i]){e.splice(i,1);return this}}}else{this._anyOutgoingListeners=[]}return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(t){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const e=this._anyOutgoingListeners.slice();for(const i of e){i.apply(this,t.data)}}}}function ii(t){t=t||{};this.ms=t.min||100;this.max=t.max||1e4;this.factor=t.factor||2;this.jitter=t.jitter>0&&t.jitter<=1?t.jitter:0;this.attempts=0}ii.prototype.duration=function(){var t=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var e=Math.random();var i=Math.floor(e*this.jitter*t);t=(Math.floor(e*10)&1)==0?t-i:t+i}return Math.min(t,this.max)|0};ii.prototype.reset=function(){this.attempts=0};ii.prototype.setMin=function(t){this.ms=t};ii.prototype.setMax=function(t){this.max=t};ii.prototype.setJitter=function(t){this.jitter=t};class si extends zt{constructor(t,e){var i;super();this.nsps={};this.subs=[];if(t&&"object"===typeof t){e=t;t=undefined}e=e||{};e.path=e.path||"/socket.io";this.opts=e;Qt(this,e);this.reconnection(e.reconnection!==false);this.reconnectionAttempts(e.reconnectionAttempts||Infinity);this.reconnectionDelay(e.reconnectionDelay||1e3);this.reconnectionDelayMax(e.reconnectionDelayMax||5e3);this.randomizationFactor((i=e.randomizationFactor)!==null&&i!==void 0?i:.5);this.backoff=new ii({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()});this.timeout(null==e.timeout?2e4:e.timeout);this._readyState="closed";this.uri=t;const s=e.parser||Qe;this.encoder=new s.Encoder;this.decoder=new s.Decoder;this._autoConnect=e.autoConnect!==false;if(this._autoConnect)this.open()}reconnection(t){if(!arguments.length)return this._reconnection;this._reconnection=!!t;if(!t){this.skipReconnect=true}return this}reconnectionAttempts(t){if(t===undefined)return this._reconnectionAttempts;this._reconnectionAttempts=t;return this}reconnectionDelay(t){var e;if(t===undefined)return this._reconnectionDelay;this._reconnectionDelay=t;(e=this.backoff)===null||e===void 0?void 0:e.setMin(t);return this}randomizationFactor(t){var e;if(t===undefined)return this._randomizationFactor;this._randomizationFactor=t;(e=this.backoff)===null||e===void 0?void 0:e.setJitter(t);return this}reconnectionDelayMax(t){var e;if(t===undefined)return this._reconnectionDelayMax;this._reconnectionDelayMax=t;(e=this.backoff)===null||e===void 0?void 0:e.setMax(t);return this}timeout(t){if(!arguments.length)return this._timeout;this._timeout=t;return this}maybeReconnectOnOpen(){if(!this._reconnecting&&this._reconnection&&this.backoff.attempts===0){this.reconnect()}}open(t){if(~this._readyState.indexOf("open"))return this;this.engine=new Pe(this.uri,this.opts);const e=this.engine;const i=this;this._readyState="opening";this.skipReconnect=false;const s=Ze(e,"open",(function(){i.onopen();t&&t()}));const n=e=>{this.cleanup();this._readyState="closed";this.emitReserved("error",e);if(t){t(e)}else{this.maybeReconnectOnOpen()}};const o=Ze(e,"error",n);if(false!==this._timeout){const t=this._timeout;const i=this.setTimeoutFn((()=>{s();n(new Error("timeout"));e.close()}),t);if(this.opts.autoUnref){i.unref()}this.subs.push((()=>{this.clearTimeoutFn(i)}))}this.subs.push(s);this.subs.push(o);return this}connect(t){return this.open(t)}onopen(){this.cleanup();this._readyState="open";this.emitReserved("open");const t=this.engine;this.subs.push(Ze(t,"ping",this.onping.bind(this)),Ze(t,"data",this.ondata.bind(this)),Ze(t,"error",this.onerror.bind(this)),Ze(t,"close",this.onclose.bind(this)),Ze(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(t){try{this.decoder.add(t)}catch(t){this.onclose("parse error",t)}}ondecoded(t){$t((()=>{this.emitReserved("packet",t)}),this.setTimeoutFn)}onerror(t){this.emitReserved("error",t)}socket(t,e){let i=this.nsps[t];if(!i){i=new ei(this,t,e);this.nsps[t]=i}else if(this._autoConnect&&!i.active){i.connect()}return i}_destroy(t){const e=Object.keys(this.nsps);for(const t of e){const e=this.nsps[t];if(e.active){return}}this._close()}_packet(t){const e=this.encoder.encode(t);for(let i=0;i<e.length;i++){this.engine.write(e[i],t.options)}}cleanup(){this.subs.forEach((t=>t()));this.subs.length=0;this.decoder.destroy()}_close(){this.skipReconnect=true;this._reconnecting=false;this.onclose("forced close")}disconnect(){return this._close()}onclose(t,e){var i;this.cleanup();(i=this.engine)===null||i===void 0?void 0:i.close();this.backoff.reset();this._readyState="closed";this.emitReserved("close",t,e);if(this._reconnection&&!this.skipReconnect){this.reconnect()}}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const t=this;if(this.backoff.attempts>=this._reconnectionAttempts){this.backoff.reset();this.emitReserved("reconnect_failed");this._reconnecting=false}else{const e=this.backoff.duration();this._reconnecting=true;const i=this.setTimeoutFn((()=>{if(t.skipReconnect)return;this.emitReserved("reconnect_attempt",t.backoff.attempts);if(t.skipReconnect)return;t.open((e=>{if(e){t._reconnecting=false;t.reconnect();this.emitReserved("reconnect_error",e)}else{t.onreconnect()}}))}),e);if(this.opts.autoUnref){i.unref()}this.subs.push((()=>{this.clearTimeoutFn(i)}))}}onreconnect(){const t=this.backoff.attempts;this._reconnecting=false;this.backoff.reset();this.emitReserved("reconnect",t)}}const ni={};function oi(t,e){if(typeof t==="object"){e=t;t=undefined}e=e||{};const i=xe(t,e.path||"/socket.io");const s=i.source;const n=i.id;const o=i.path;const r=ni[n]&&o in ni[n]["nsps"];const a=e.forceNew||e["force new connection"]||false===e.multiplex||r;let h;if(a){h=new si(s,e)}else{if(!ni[n]){ni[n]=new si(s,e)}h=ni[n]}if(i.query&&!e.query){e.query=i.queryKey}return h.socket(i.path,e)}Object.assign(oi,{Manager:si,Socket:ei,io:oi,connect:oi});class ri{queue=[];isProcessing=false;flushTimer=null;options;processor;constructor(t,e){this.processor=t;this.options={maxQueueSize:1e4,onError:t=>console.error("Queue processing error:",t),onBatchProcessed:()=>{},...e}}offer(t){if(this.queue.length>=this.options.maxQueueSize){return false}const e={data:t,timestamp:Date.now(),id:this.generateId()};this.queue.push(e);this.scheduleFlush();return true}offerAll(t){let e=0;for(const i of t){if(this.offer(i)){e++}else{break}}return e}size(){return this.queue.length}isEmpty(){return this.queue.length===0}async flush(){if(this.flushTimer){clearTimeout(this.flushTimer);this.flushTimer=null}await this.processBatch()}clear(){this.queue=[];if(this.flushTimer){clearTimeout(this.flushTimer);this.flushTimer=null}}async shutdown(){await this.flush()}scheduleFlush(){if(this.queue.length>=this.options.batchSize){this.processBatch();return}if(!this.flushTimer){this.flushTimer=setTimeout((()=>{this.processBatch()}),this.options.flushInterval)}}async processBatch(){if(this.isProcessing||this.queue.length===0){return}this.isProcessing=true;try{const t=Math.min(this.options.batchSize,this.queue.length);const e=this.queue.splice(0,t);const i=e.map((t=>t.data));const s=Date.now();await this.processor(i);const n=Date.now()-s;this.options.onBatchProcessed(t,n);if(this.flushTimer){clearTimeout(this.flushTimer);this.flushTimer=null}if(this.queue.length>0){this.scheduleFlush()}}catch(t){this.options.onError(t)}finally{this.isProcessing=false}}generateId(){return L()}}const ai=".sc-igloo-calendar-h{display:block;position:relative;background-color:#ffffff;height:100%;text-align:center}.igl-calendar.sc-igloo-calendar{display:grid;grid-template-columns:1fr;height:100%}.calendarScrollContainer.sc-igloo-calendar{width:100%;height:100%;overflow:auto;position:relative;white-space:nowrap;border-left:2px solid grey}.showToBeAssigned.sc-igloo-calendar,.showLegend.sc-igloo-calendar{grid-template-columns:330px 1fr}#calendarContainer.sc-igloo-calendar{position:absolute}.legendContainer.sc-igloo-calendar,.tobeAssignedContainer.sc-igloo-calendar{display:none;height:100%;overflow-y:auto;padding-left:0.5em !important;padding-right:0.5em !important}.showToBeAssigned.sc-igloo-calendar .tobeAssignedContainer.sc-igloo-calendar{display:block}.showLegend.sc-igloo-calendar .legendContainer.sc-igloo-calendar{display:block}.tobeBooked.sc-igloo-calendar{padding-top:8px;padding-bottom:8px;text-align:left}";const hi=ai;const li=class{constructor(i){t(this,i);this.dragOverHighlightElement=e(this,"dragOverHighlightElement",7);this.moveBookingTo=e(this,"moveBookingTo",7);this.calculateUnassignedDates=e(this,"calculateUnassignedDates",7);this.reduceAvailableUnitEvent=e(this,"reduceAvailableUnitEvent",7);this.revertBooking=e(this,"revertBooking",7);this.openCalendarSidebar=e(this,"openCalendarSidebar",7);this.showRoomNightsDialog=e(this,"showRoomNightsDialog",7)}propertyid;from_date;to_date;language;loadingMessage;currencyName;ticket="";p;baseUrl;get element(){return i(this)}calendarData=new Object;property_id;days=new Array;scrollViewDragging=false;dialogData=null;bookingItem=null;editBookingItem=null;showLegend=false;showPaymentDetails=false;showToBeAssigned=false;unassignedDates={};roomNightsData=null;renderAgain=false;showBookProperty=false;highlightedDate;calDates;isAuthenticated=false;calendarSidebarState;dragOverHighlightElement;moveBookingTo;calculateUnassignedDates;reduceAvailableUnitEvent;revertBooking;openCalendarSidebar;showRoomNightsDialog;bookingService=new a;roomService=new r;eventsService=new O;toBeAssignedService=new M;housekeepingService=new U;countries=[];visibleCalendarCells={x:[],y:[]};scrollContainer;today="";reachedEndOfCalendar=false;socket;token=new I;calendarModalEl;salesQueue=new ri(this.processSalesBatch.bind(this),{batchSize:50,flushInterval:1e3,maxQueueSize:5e3,onError:t=>console.error("Batch Sales Update Error:",t)});availabilityQueue=new ri(this.processAvailabilityBatch.bind(this),{batchSize:50,flushInterval:1e3,maxQueueSize:5e3,onError:t=>console.error("Batch Availability Update Error:",t)});roomTypeIdsCache=new Map;tasksEndDate;dialogEl;componentWillLoad(){if(this.baseUrl){this.token.setBaseUrl(this.baseUrl)}this.init()}componentDidLoad(){this.scrollToElement(this.today)}async handleDeleteEvent(t){try{t.stopImmediatePropagation();t.preventDefault();await this.eventsService.deleteEvent(t.detail)}catch(t){}}async handleCalendarSidebarEvents(t){console.log("hit ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥");t.stopImmediatePropagation();t.stopPropagation();this.calendarSidebarState=t.detail}scrollPageToRoom(t){let e=t.detail.refClass;this.scrollContainer=this.scrollContainer||this.element.querySelector(".calendarScrollContainer");const i=this.element.querySelector(".topLeftCell");const s=this.element.querySelector("."+e);if(s){this.scrollContainer.scrollTo({top:0});const t=s.getBoundingClientRect();const e=this.scrollContainer.getBoundingClientRect();const n=i.getBoundingClientRect();this.scrollContainer.scrollTo({top:t.top-e.top-n.height-t.height})}}handleShowDialog(t){t.stopImmediatePropagation();t.stopPropagation();this.dialogData=t.detail;if(this.dialogData.reason!=="reallocate"){this.calendarModalEl?.openModal()}}handleShowRoomNightsDialog(t){this.roomNightsData=t.detail}handleBookingDatasChange(t){t.stopPropagation();t.stopImmediatePropagation();let e=[...this.calendarData.bookingEvents];e=e.filter((t=>t.ID!=="NEW_TEMP_EVENT"));e.push(...t.detail.filter((t=>t.STATUS==="PENDING-CONFIRMATION")));this.updateBookingEventsDateRange(t.detail);this.calendarData={...this.calendarData,bookingEvents:e}}handleUpdateBookingEvent(t){t.stopPropagation();t.stopImmediatePropagation();const e=t.detail;this.calendarData={...this.calendarData,bookingEvents:this.calendarData.bookingEvents.map((t=>{if(e.ID===t.ID){return e}return t}))}}showBookingPopupEventDataHandler(t){t.preventDefault();t.stopImmediatePropagation();this.onOptionSelect(t)}updateEventDataHandler(t){let e=this.calendarData.bookingEvents.find((e=>e.id===t.detail.id));if(e&&t.detail&&t.detail.data){Object.entries(t.detail.data).forEach((([t,i])=>{e[t]=i}))}}dragOverEventDataHandler(t){if(t.detail.id==="CALCULATE_DRAG_OVER_BOUNDS"){let e=document.querySelector("igl-cal-header .topLeftCell");let i=document.querySelectorAll(".headersContainer .headerCell");let s=document.querySelectorAll(".bodyContainer .roomRow .roomTitle");this.visibleCalendarCells={x:[],y:[]};i.forEach((t=>{const i=t;this.visibleCalendarCells.x.push({left:i.offsetLeft+e.offsetWidth,width:i.offsetWidth,id:i.getAttribute("data-day")})}));s.forEach((t=>{const e=t;this.visibleCalendarCells.y.push({top:e.offsetTop,height:e.offsetHeight,id:e.getAttribute("data-room")})}));this.highlightDragOver(true,t.detail.data)}else if(t.detail.id==="DRAG_OVER"){this.highlightDragOver(true,t.detail.data)}else if(t.detail.id==="DRAG_OVER_END"){this.highlightDragOver(false,t.detail.data)}else if(t.detail.id==="STRETCH_OVER_END"){this.highlightDragOver(false,t.detail.data)}}ticketChanged(t,e){if(t===e){return}this.token.setToken(this.ticket);this.initializeApp()}init(){this.calDates={from:this.from_date,to:this.to_date};if(this.ticket!==""){this.token.setToken(this.ticket);this.initializeApp()}this.calDates={from:this.from_date,to:this.to_date};R("unassigned_dates",(t=>{if(Object.keys(t).length===0&&this.highlightedDate!==""){this.highlightedDate=""}}))}renderModalBody(){switch(this.dialogData?.reason){case"checkin":{return`Are you sure you want to Check In this unit?`}case"checkout":{return"Are you sure you want to Check Out this unit?"}case"reallocate":return this.dialogData?.description||"";case"stretch":return"Warning ";default:return"Unknown modal content"}}setUpCalendarData(t,e){this.calendarData.currency=t["My_Result"].currency;this.calendarData.allowedBookingSources=t["My_Result"].allowed_booking_sources;this.calendarData.adultChildConstraints=t["My_Result"].adult_child_constraints;this.calendarData.legendData=this.getLegendData(t);this.calendarData.is_vacation_rental=t["My_Result"].is_vacation_rental;this.calendarData.from_date=e.My_Params_Get_Rooming_Data.FROM;this.calendarData.to_date=e.My_Params_Get_Rooming_Data.TO;this.calendarData.startingDate=new Date(e.My_Params_Get_Rooming_Data.FROM).getTime();this.calendarData.endingDate=new Date(e.My_Params_Get_Rooming_Data.TO).getTime();this.calendarData.formattedLegendData=h(this.calendarData.legendData);let i=e.myBookings||[];i=i.filter((t=>{const e=Y(t.TO_DATE,"YYYY-MM-DD");const i=Y(t.FROM_DATE,"YYYY-MM-DD");return!e.isSame(i)}));this.calendarData.bookingEvents=i;this.calendarData.toBeAssignedEvents=[]}async initializeApp(){try{let t=this.propertyid;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}let e=null;if(!t){console.log(t);const i=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true,include_sales_rate_plans:true});e=i;t=i.My_Result.id}this.property_id=t;const i=[this.bookingService.getCalendarData(t,this.from_date,this.to_date),this.bookingService.getCountries(this.language),this.roomService.fetchLanguage(this.language),this.housekeepingService.getExposedHKSetup(this.property_id)];if(this.propertyid){i.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true,include_units_hk_status:true,include_sales_rate_plans:true}))}const s=await Promise.all(i);this.tasksEndDate=Y().add(30,"days").format("YYYY-MM-DD");this.getHousekeepingTasks({from_date:Y().format("YYYY-MM-DD"),to_date:this.tasksEndDate});if(!e){e=s[s.length-1]}const[n,o]=s;l.days=n.days;l.months=n.months;this.setRoomsData(e);this.countries=o;this.setUpCalendarData(e,n);let r=e["My_Result"]["allowed_payment_methods"];this.showPaymentDetails=r.some((t=>t.code==="001"||t.code==="004"));this.updateBookingEventsDateRange(this.calendarData.bookingEvents);this.updateBookingEventsDateRange(this.calendarData.toBeAssignedEvents);this.today=this.transformDateForScroll(new Date);let a=new Date(this.calendarData.startingDate);a.setHours(0,0,0,0);this.days=n.days;this.calendarData.days=this.days;this.calendarData.monthsInfo=n.months;l.fromDate=this.calendarData.from_date;l.toDate=this.calendarData.to_date;setTimeout((()=>{this.scrollToElement(this.today)}),200);if(!this.calendarData.is_vacation_rental){const t=await this.toBeAssignedService.getUnassignedDates(this.property_id,this.from_date,this.to_date);this.unassignedDates={fromDate:this.from_date,toDate:this.to_date,data:{...this.unassignedDates,...t}};this.calendarData={...this.calendarData,unassignedDates:t};N(t)}this.socket=oi("https://realtime.igloorooms.com/");this.socket.on("MSG",(async t=>{await this.handleSocketMessage(t)}))}catch(t){console.error("Initializing Calendar Error",t)}}async getHousekeepingTasks({from_date:t,to_date:e}){const{tasks:i}=await this.housekeepingService.getHkTasks({property_id:this.property_id,from_date:t,to_date:e,housekeepers:[],cleaning_frequency:(x.cleaning_frequency??j?.hk_criteria?.cleaning_frequencies[0])?.code,dusty_window:j?.hk_criteria?.dusty_periods[0]?.code,highlight_window:j?.hk_criteria?.highlight_checkin_options[0]?.code});c(i)}async handleSocketMessage(t){const e=JSON.parse(t);if(!e){return}const{REASON:i,KEY:s,PAYLOAD:n}=e;if(s.toString()!==this.property_id.toString()){return}let o;if(["DELETE_CALENDAR_POOL","GET_UNASSIGNED_DATES"].includes(i)){o=n}else{o=JSON.parse(n)}console.log({[i]:o});const r={DORESERVATION:this.handleDoReservation,BLOCK_EXPOSED_UNIT:this.handleBlockExposedUnit,ASSIGN_EXPOSED_ROOM:this.handleAssignExposedRoom,REALLOCATE_EXPOSED_ROOM_BLOCK:this.handleReallocateExposedRoomBlock,DELETE_CALENDAR_POOL:this.handleDeleteCalendarPool,GET_UNASSIGNED_DATES:this.handleGetUnassignedDates,UPDATE_CALENDAR_AVAILABILITY:t=>this.availabilityQueue.offer(t),CHANGE_IN_DUE_AMOUNT:this.handleChangeInDueAmount,CHANGE_IN_BOOK_STATUS:this.handleChangeInBookStatus,NON_TECHNICAL_CHANGE_IN_BOOKING:this.handleNonTechnicalChangeInBooking,ROOM_STATUS_CHANGED:this.handleRoomStatusChanged,UNIT_HK_STATUS_CHANGED:this.handleUnitHKStatusChanged,SHARING_PERSONS_UPDATED:this.handleSharingPersonsUpdated,ROOM_TYPE_CLOSE:t=>this.salesQueue.offer({...t,is_available_to_book:false}),ROOM_TYPE_OPEN:t=>this.salesQueue.offer({...t,is_available_to_book:true}),HK_SKIP:this.handleHkSkip,SET_ROOM_CALENDAR_EXTRA:this.handleRoomCalendarExtra};const a=r[i];if(a){await a.call(this,o)}else{console.warn(`Unhandled REASON: ${i}`)}}handleRoomCalendarExtra(t){this.calendarData={...this.calendarData,bookingEvents:[...this.calendarData.bookingEvents.map((e=>{if(e.IDENTIFIER===t.room_identifier){const i=t.value?JSON.parse(t.value):null;const s=i?e.ROOM_INFO.calendar?{...e.ROOM_INFO.calendar,...i}:i:null;return{...e,ROOM_INFO:{...e.ROOM_INFO,calendar_extra:s}}}return e}))]}}handleSharingPersonsUpdated(t){console.log("sharing persons updated",t);this.calendarData={...this.calendarData,bookingEvents:[...this.calendarData.bookingEvents.map((e=>{if(e.IDENTIFIER===t.identifier){const i=t.guests?.find((t=>t.is_main));return{...e,NAME:u(i.first_name,i.last_name),ROOM_INFO:{...e.ROOM_INFO,sharing_persons:t.guests}}}return e}))]}}handleRoomStatusChanged(t){this.calendarData={...this.calendarData,bookingEvents:[...this.calendarData.bookingEvents.map((e=>{if(e.IDENTIFIER===t.room_identifier){const i=d({from_date:e.FROM_DATE,to_date:e.TO_DATE,in_out:{...e.ROOM_INFO.in_out,code:t.status},status_code:e.BASE_STATUS_CODE});return{...e,CHECKIN:t.status==="001",CHECKOUT:t.status==="002",STATUS:i}}return e}))]}}handleHkSkip(t){f({date:t.DATE,unitId:t.PR_ID})}handleUnitHKStatusChanged(t){console.log("hk unit change",t);const e=[...this.calendarData.roomsInfo];const i=e.findIndex((e=>e.id===t.ROOM_CATEGORY_ID));if(i!==-1){const s={...e[i]};const n=s.physicalrooms.findIndex((e=>e.id===t.PR_ID));if(n!==-1){const o=[...s.physicalrooms];const r={...o[n]};r.hk_status=t.HKS_CODE;o[n]=r;s.physicalrooms=o;e[i]=s;this.calendarData={...this.calendarData,roomsInfo:e}}}const s={date:Y().format("YYYY-MM-DD"),unitId:t.PR_ID};if(t.HKS_CODE==="002"){p(s)}else{f(s)}}async handleDoReservation(t){const e=g(t);this.AddOrUpdateRoomBookings(e)}async handleBlockExposedUnit(t){const e=[await y(t)];this.AddOrUpdateRoomBookings(e)}async handleAssignExposedRoom(t){console.log(t);const e=g(t);this.AddOrUpdateRoomBookings(e)}async handleReallocateExposedRoomBlock(t){await this.handleBlockExposedUnit(t)}async handleDeleteCalendarPool(t){console.log("delete calendar pool");this.calendarData={...this.calendarData,bookingEvents:this.calendarData.bookingEvents.filter((e=>e.POOL!==t))}}async handleGetUnassignedDates(t){const e=this.parseDateRange(t);if(!this.calendarData.is_vacation_rental&&new Date(e.FROM_DATE).getTime()>=this.calendarData.startingDate&&new Date(e.TO_DATE).getTime()<=this.calendarData.endingDate){const t=await this.toBeAssignedService.getUnassignedDates(this.property_id,m(new Date(e.FROM_DATE)),m(new Date(e.TO_DATE)));N(t);this.unassignedDates={fromDate:m(new Date(e.FROM_DATE)),toDate:m(new Date(e.TO_DATE)),data:t};if(Object.keys(t).length===0){B(m(new Date(e.FROM_DATE)),m(new Date(e.TO_DATE)));this.reduceAvailableUnitEvent.emit({fromDate:m(new Date(e.FROM_DATE)),toDate:m(new Date(e.TO_DATE))})}}}parseDateRange(t){const e={};const i=t.split("|");i.forEach((t=>{const i=t.split(":");e[i[0]]=i[1]}));return e}handleChangeInDueAmount(t){this.calendarData={...this.calendarData,bookingEvents:this.calendarData.bookingEvents.map((e=>{if(t.pools.includes(e.ID)){return{...e,BALANCE:t.due_amount}}return e}))}}handleChangeInBookStatus(t){this.calendarData={...this.calendarData,bookingEvents:this.calendarData.bookingEvents.map((e=>{if(t.pools.includes(e.ID)){return{...e,STATUS:e.STATUS!=="IN-HOUSE"?_[t.status_code]:t.status_code==="001"?_[t.status_code]:"IN-HOUSE"}}return e}))}}handleNonTechnicalChangeInBooking(t){this.calendarData={...this.calendarData,bookingEvents:this.calendarData.bookingEvents.map((e=>{if(e.BOOKING_NUMBER===t.booking_nbr){return{...e,PRIVATE_NOTE:b(t.extras)}}return e}))}}checkBookingAvailability(t){return this.calendarData.bookingEvents.some((e=>e.ID===t.ID||e.FROM_DATE===t.FROM_DATE&&e.TO_DATE===t.TO_DATE&&e.PR_ID===t.PR_ID))}updateBookingEventsDateRange(t){t.forEach((t=>{t.legendData=this.calendarData.formattedLegendData;t.defaultDateRange={};t.defaultDateRange.fromDate=new Date(t.FROM_DATE+"T00:00:00");t.defaultDateRange.fromDateStr=this.getDateStr(t.defaultDateRange.fromDate);t.defaultDateRange.fromDateTimeStamp=t.defaultDateRange.fromDate.getTime();t.defaultDateRange.toDate=new Date(t.TO_DATE+"T00:00:00");t.defaultDateRange.toDateStr=this.getDateStr(t.defaultDateRange.toDate);t.defaultDateRange.toDateTimeStamp=t.defaultDateRange.toDate.getTime();t.defaultDateRange.dateDifference=t.NO_OF_DAYS;t.roomsInfo=[...this.calendarData.roomsInfo];if(!w(t.STATUS_CODE)){t.STATUS=d({in_out:t.ROOM_INFO?.in_out,from_date:t.FROM_DATE,to_date:t.TO_DATE,status_code:t.BASE_STATUS_CODE})}}))}processSalesBatch(t){const e=[...l.days];const i=new Map(l.disabled_cells);for(const s of t){const t=e.findIndex((t=>t.value===s.night));if(t===-1){console.warn(`Couldn't find day ${s.night}`);continue}let n=this.roomTypeIdsCache.get(s.rate_plan_id);if(n==="skip"){continue}if(!n){const i=e[t].rate.findIndex((t=>t.rateplans.some((t=>t.id===s.rate_plan_id))));if(i===-1){this.roomTypeIdsCache.set(s.rate_plan_id,"skip");console.warn(`Couldn't find room type for rate plan ${s.rate_plan_id}`);continue}const o=e[t].rate[i];const r=o.rateplans.findIndex((t=>t.id===s.rate_plan_id));n={id:i,index:r};this.roomTypeIdsCache.set(s.rate_plan_id,n)}const{id:o,index:r}=n;const a=e[t].rate[o];const h=a.rateplans.map(((t,e)=>e===r?{...t,is_available_to_book:s.is_available_to_book}:t));const l=h.some((t=>t.is_available_to_book));e[t].rate[o]={...a,rateplans:h,is_available_to_book:l};for(const s of a.physicalrooms){const n=`${s.id}_${e[t].value}`;i.set(n,{disabled:!l,reason:"stop_sale"})}}l["disabled_cells"]=new Map(i);l.days=e}processAvailabilityBatch(t){let e=[...l.days];const i=new Map(l.disabled_cells);for(const s of t){const t=e.findIndex((t=>t.value===s.date));if(t===-1){console.warn(`Couldn't find day ${s.date}`);return}const n=e[t].rate.findIndex((t=>t.id===s.room_type_id));if(n===-1){console.warn(`Couldn't find room type ${s.room_type_id}`);return}const o=e[t].rate[n];o.exposed_inventory.rts=s.availability;const r=o.rateplans.every((t=>!t.is_available_to_book));for(const t of o.physicalrooms){const e=`${t.id}_${s.date}`;i.set(e,{disabled:s.availability===0,reason:r?"stop_sale":"inventory"})}}l["disabled_cells"]=new Map(i);l.days=[...e]}setRoomsData(t){let e=new Array;if(t.My_Result?.roomtypes?.length){e=t.My_Result.roomtypes;t.My_Result.roomtypes.forEach((t=>{t.expanded=true}))}x.roomsInfo=e;this.calendarData.roomsInfo=e}getLegendData(t){return t["My_Result"].calendar_legends}getDateStr(t,e="default"){return t.getDate()+" "+t.toLocaleString(e,{month:"short"})+" "+t.getFullYear()}scrollToElement(t){this.scrollContainer=this.scrollContainer||this.element.querySelector(".calendarScrollContainer");const e=this.element.querySelector(".topLeftCell");const i=this.element.querySelector(".day-"+t);if(i){this.scrollContainer.scrollTo({left:0});const t=i.getBoundingClientRect();const s=this.scrollContainer.getBoundingClientRect();const n=e.getBoundingClientRect();this.scrollContainer.scrollTo({left:t.left-s.left-n.width-t.width})}}AddOrUpdateRoomBookings(t,e=undefined){let i=[...this.calendarData.bookingEvents];t.forEach((t=>{if(!this.checkBookingAvailability(t)){i=i.filter((e=>e.ID!==t.ID))}}));this.updateBookingEventsDateRange(t);if(e){i=i.filter((t=>t.POOL===e))}t.forEach((t=>{if(!i.some((e=>e.ID===t.ID))){i.push(t)}}));this.calendarData={...this.calendarData,bookingEvents:i};const s=t=>{const e=Y(this.tasksEndDate,"YYYY-MM-DD");return Y(t.FROM_DATE,"YYYY-MM-DD").isSameOrBefore(e,"date")||Y(t.TO_DATE,"YYYY-MM-DD").isSameOrBefore(e,"date")};if(t.some(s)){this.getHousekeepingTasks({from_date:Y().format("YYYY-MM-DD"),to_date:this.tasksEndDate})}}transformDateForScroll(t){return Y(t).format("D_M_YYYY")}shouldRenderCalendarView(){return this.calendarData&&this.calendarData.days&&this.calendarData.days.length}onOptionSelect(t){const e=t.detail;const i=this.element.querySelector("#iglooCalendar");switch(e.key){case"showAssigned":i.classList.remove("showLegend");i.classList.remove("showToBeAssigned");i.classList.toggle("showToBeAssigned");this.showLegend=false;this.showToBeAssigned=true;break;case"showLegend":i.classList.remove("showToBeAssigned");i.classList.remove("showLegend");i.classList.toggle("showLegend");this.showLegend=!this.showLegend;this.showToBeAssigned=false;break;case"calendar":let t=new Date;if(e.data.start!==undefined&&e.data.end!==undefined){t=e.data.start.toDate();this.handleDateSearch(e.data)}else{t=new Date(e.data);t.setDate(t.getDate()+1);if(!e?.noScroll){this.scrollToElement(t.getDate()+"_"+(t.getMonth()+1)+"_"+t.getFullYear())}}this.highlightedDate=this.transformDateForScroll(t);break;case"search":break;case"bulk":this.calendarSidebarState={type:"bulk-blocks",payload:null};break;case"add":if(e.data.event_type!=="EDIT_BOOKING"){this.bookingItem=e.data}else{this.editBookingItem=e.data}break;case"gotoToday":this.scrollToElement(this.today);break;case"closeSideMenu":this.closeSideMenu();this.highlightedDate="";this.showBookProperty=false;break}}async addDatesToCalendar(t,e){const[i]=await Promise.all([this.bookingService.getCalendarData(this.property_id,t,e)]);const s=i.myBookings||[];this.updateBookingEventsDateRange(s);if(new Date(t).getTime()<new Date(this.calendarData.startingDate).getTime()){this.calendarData.startingDate=new Date(t).getTime();this.calendarData.from_date=t;l.fromDate=this.calendarData.from_date;this.days=[...i.days,...this.days];let n=[...i.months];if(this.calendarData.monthsInfo[0].monthName===i.months[i.months.length-1].monthName){this.calendarData.monthsInfo[0].daysCount=this.calendarData.monthsInfo[0].daysCount+i.months[i.months.length-1].daysCount;n.pop()}let o=JSON.parse(JSON.stringify(s));o=o.filter((t=>{const e=this.calendarData.bookingEvents.findIndex((e=>e.ID===t.ID));if(e!==-1){this.calendarData.bookingEvents[e].FROM_DATE=t.FROM_DATE;this.calendarData.bookingEvents[e].NO_OF_DAYS=k(t.FROM_DATE,this.calendarData.bookingEvents[e].TO_DATE);return false}return true}));l.days=this.days;this.calendarData={...this.calendarData,days:this.days,monthsInfo:[...n,...this.calendarData.monthsInfo],bookingEvents:[...this.calendarData.bookingEvents,...o]};if(Math.abs(Y().diff(Y(t,"YYYY-MM-DD"),"days"))<=10){const i=await this.toBeAssignedService.getUnassignedDates(this.property_id,t,e);this.calendarData.unassignedDates={...this.calendarData.unassignedDates,...i};this.unassignedDates={fromDate:t,toDate:e,data:i};N(i)}}else{this.calendarData.endingDate=new Date(e).getTime();this.calendarData.to_date=e;l.toDate=this.calendarData.to_date;let n=[...i.months];this.days=[...this.days,...i.days];if(this.calendarData.monthsInfo[this.calendarData.monthsInfo.length-1].monthName===i.months[0].monthName){this.calendarData.monthsInfo[this.calendarData.monthsInfo.length-1].daysCount=this.calendarData.monthsInfo[this.calendarData.monthsInfo.length-1].daysCount+i.months[0].daysCount;n.shift()}let o=JSON.parse(JSON.stringify(s));o=o.filter((t=>{const e=this.calendarData.bookingEvents.findIndex((e=>e.ID===t.ID));if(e!==-1){this.calendarData.bookingEvents[e].TO_DATE=t.TO_DATE;this.calendarData.bookingEvents[e].NO_OF_DAYS=k(this.calendarData.bookingEvents[e].FROM_DATE,t.TO_DATE);return false}return true}));l.days=this.days;this.calendarData={...this.calendarData,days:this.days,monthsInfo:[...this.calendarData.monthsInfo,...n],bookingEvents:[...this.calendarData.bookingEvents,...o]};const r=await this.toBeAssignedService.getUnassignedDates(this.property_id,t,e);this.calendarData.unassignedDates={...this.calendarData.unassignedDates,...r};this.unassignedDates={fromDate:t,toDate:e,data:r};N(r)}}async handleDateSearch(t){const e=Y(t.start).toDate();const i=Y(this.calDates.from).toDate();const s=t.end.toDate();const n=this.calendarData.endingDate;if(e.getTime()<new Date(this.calDates.from).getTime()){await this.addDatesToCalendar(Y(e).add(-1,"days").format("YYYY-MM-DD"),Y(i).add(-1,"days").format("YYYY-MM-DD"));this.calDates={...this.calDates,from:t.start.add(-1,"days").format("YYYY-MM-DD")};this.scrollToElement(this.transformDateForScroll(e))}else if(e.getTime()>i.getTime()&&e.getTime()<n&&s.getTime()<n){this.scrollToElement(this.transformDateForScroll(e))}else if(e.getTime()>n){const t=D(new Date(this.calendarData.endingDate));await this.addDatesToCalendar(t,Y(s).add(2,"months").format("YYYY-MM-DD"));this.scrollToElement(this.transformDateForScroll(e))}}closeSideMenu(){this.showLegend=false;this.showToBeAssigned=false}scrollViewDragPos={top:0,left:0,x:0,y:0};dragScrollContent(t){this.scrollViewDragging=false;let e=t&&t.target?this.hasAncestorWithClass(t.target,"preventPageScroll"):false;if(!e&&t.buttons===1){this.scrollViewDragPos={left:this.scrollContainer.scrollLeft,top:this.scrollContainer.scrollTop,x:t.clientX,y:t.clientY};document.addEventListener("mousemove",this.onScrollContentMoveHandler);document.addEventListener("mouseup",this.onScrollContentMoveEndHandler)}}onScrollContentMoveHandler=t=>{if(t.buttons!==1){return}const e=t.clientX-this.scrollViewDragPos.x;const i=t.clientY-this.scrollViewDragPos.y;this.scrollContainer.scrollTop=this.scrollViewDragPos.top-i;this.scrollContainer.scrollLeft=this.scrollViewDragPos.left-e;if(Math.abs(e)>5||Math.abs(i)>5){this.scrollViewDragging=true}};onScrollContentMoveEndHandler=()=>{document.removeEventListener("mousemove",this.onScrollContentMoveHandler);document.removeEventListener("mouseup",this.onScrollContentMoveEndHandler)};calendarScrolling(){if(this.scrollContainer){if(this.highlightedDate){const t=document.querySelector(`.day-${this.highlightedDate}`);if(t){const{left:e,right:i}=t.getBoundingClientRect();const s=e>=0&&i<=window.innerWidth;if(!s){this.highlightedDate=""}}}const t=this.scrollContainer.getBoundingClientRect();let e=170;let i=t.width-e;let s=t.x+e;let n=t.x+t.width;let o=Array.from(this.element.querySelectorAll(".monthCell"));if(o.length){o.map((async t=>{let e=t.getBoundingClientRect();if(o.indexOf(t)===o.length-1){if(e.x+e.width<=n&&!this.reachedEndOfCalendar){this.reachedEndOfCalendar=true;const t=v(new Date(this.calendarData.endingDate));const e=D(new Date(this.calendarData.endingDate));await this.addDatesToCalendar(e,t);this.reachedEndOfCalendar=false}}if(e.x+e.width<s);else if(e.x>n);else{let o=t.querySelector(".monthTitle");let r=0;let a=e.width;if(e.x<s){r=Math.abs(e.x)-s;r=e.x<0?Math.abs(e.x)+s:Math.abs(r);a=e.x+e.width>n?i:e.x+e.width-s}else{a=i-a>a?a:i-e.x+s}o.style.marginLeft=r+"px";o.style.width=a+"px"}}))}}}hasAncestorWithClass(t,e){let i=t;while(i!==null){if(i.matches(`.${e}`)){return true}i=i.parentElement}return false}async highlightDragOver(t,e){let i,s;if(e){i=this.visibleCalendarCells.x.find((t=>t.left<e.x&&e.x<=t.left+t.width));s=this.visibleCalendarCells.y.find((t=>t.top<e.y&&e.y<=t.top+t.height))}if(t&&i&&s){this.dragOverHighlightElement.emit({dragOverElement:s.id+"_"+i.id})}else{this.dragOverHighlightElement.emit({dragOverElement:""})}if(!t){this.moveBookingTo.emit({bookingId:e.id,fromRoomId:e.fromRoomId,toRoomId:s&&s.id||"revert",moveToDay:i&&i.id||"revert",pool:e.pool,from_date:E(i&&i.id),to_date:C(i&&i.id,e.nbOfDays)})}}handleModalConfirm(){const t=()=>{this.dialogData=null};try{switch(this.dialogData?.reason){case"checkin":case"checkout":{const{bookingNumber:e,roomIdentifier:i}=this.dialogData;const s=this.dialogData.reason==="checkin"?"001":"002";this.bookingService.handleExposedRoomInOut({booking_nbr:e,room_identifier:i,status:s}).finally(t);if(this.dialogData.reason==="checkin"){this.openCalendarSidebar.emit({type:"room-guests",payload:this.dialogData.sidebarPayload})}break}case"stretch":const{reason:e,...i}=this.dialogData;this.showRoomNightsDialog.emit(i);break;case"reallocate":{if(!this.dialogData){console.warn("No dialog data available for reallocation.");return}const{pool:e,toRoomId:i,from_date:s,to_date:n}=this.dialogData;this.eventsService.reallocateEvent(e,i,s,n).then(t).catch((()=>{console.error("Reallocation failed. Reverting booking.");this.revertBooking.emit(e)})).finally(t);break}default:t();break}}catch(e){console.error("Error handling modal confirm:",e);t()}}handleModalCancel(){if(this.dialogData?.reason==="reallocate"||this.dialogData?.reason==="stretch"){this.revertBooking.emit(this.dialogData.pool)}this.dialogData=null}handleRoomNightsDialogClose(t){if(t.detail.type==="cancel"){this.revertBooking.emit(this.roomNightsData.pool)}this.roomNightsData=null}handleSideBarToggle(t){if(t.detail){this.calendarSidebarState=null;if(this.editBookingItem){this.editBookingItem=null}if(this.roomNightsData){this.revertBooking.emit(this.roomNightsData.pool);this.roomNightsData=null}if(this.dialogData?.reason==="reallocate"){this.revertBooking.emit(this.dialogData.pool);this.dialogData=null}}}handleCloseBookingWindow(){this.bookingItem=null}get isSidebarOpen(){if(this.editBookingItem&&this.editBookingItem.event_type==="EDIT_BOOKING"){return true}if(this.roomNightsData){return true}if(this.calendarSidebarState){const t=this.calendarSidebarState.type;return t==="split"||t==="bulk-blocks"}return false}render(){return s(o,{key:"eeacca9bceed71d1ade7ddc4e280a88a33ff4dfa"},s("ir-toast",{key:"c3b34a4525c673fb2757067c45386bf06d5dac10"}),s("ir-interceptor",{key:"6d86e886d7009d91393f5eb0b458b20c0a0812e4"}),s("div",{key:"c6a2f775659ff23cef4559d25b38ee66bcdbf3b9",id:"iglooCalendar",class:{"igl-calendar":true,showToBeAssigned:this.showToBeAssigned,showLegend:this.showLegend}},this.shouldRenderCalendarView()?s(n,{"data-testid":"ir-calendar"},this.showToBeAssigned&&s("igl-to-be-assigned",{unassignedDatesProp:this.unassignedDates,to_date:this.to_date,from_date:this.from_date,propertyid:this.property_id,class:"tobeAssignedContainer",calendarData:this.calendarData,onOptionEvent:t=>this.onOptionSelect(t)}),this.showLegend&&s("igl-legends",{class:"legendContainer",legendData:this.calendarData.legendData,onOptionEvent:t=>this.onOptionSelect(t)}),s("div",{class:"calendarScrollContainer",onMouseDown:t=>this.dragScrollContent(t),onScroll:()=>this.calendarScrolling()},s("div",{id:"calendarContainer"},s("igl-cal-header",{unassignedDates:this.unassignedDates,to_date:this.to_date,propertyid:this.property_id,today:this.today,calendarData:this.calendarData,highlightedDate:this.highlightedDate,onOptionEvent:t=>this.onOptionSelect(t)}),s("igl-cal-body",{propertyId:this.property_id,language:this.language,countries:this.countries,currency:this.calendarData.currency,today:this.today,highlightedDate:this.highlightedDate,isScrollViewDragging:this.scrollViewDragging,calendarData:this.calendarData}),s("igl-cal-footer",{isLegendOpen:this.showLegend,highlightedDate:this.highlightedDate,today:this.today,calendarData:this.calendarData,onOptionEvent:t=>this.onOptionSelect(t)})))):s("ir-loading-screen",{message:"Preparing Calendar Data"})),this.bookingItem&&s("igl-book-property",{key:"17af79ed38df0d64f9064f80bce587c73c242dd5",allowedBookingSources:this.calendarData.allowedBookingSources,adultChildConstraints:this.calendarData.adultChildConstraints,showPaymentDetails:this.showPaymentDetails,countries:this.countries,currency:this.calendarData.currency,language:this.language,propertyid:this.property_id,bookingData:this.bookingItem,onCloseBookingWindow:()=>this.handleCloseBookingWindow()}),s("ir-sidebar",{key:"0dc41d8a3bdf0332d9a041cf215f5bd35a2de4a4",onIrSidebarToggle:this.handleSideBarToggle.bind(this),open:this.isSidebarOpen,showCloseButton:false,sidebarStyles:{width:this.calendarSidebarState?.type==="room-guests"?"60rem":this.editBookingItem?"80rem":"var(--sidebar-width,40rem)",background:this.editBookingItem?"#F2F3F8":"white"}},this.roomNightsData&&s("ir-room-nights",{key:"e4feef25890dc62fbf6c67be37129710edb83da2",slot:"sidebar-body",pool:this.roomNightsData.pool,onCloseRoomNightsDialog:this.handleRoomNightsDialogClose.bind(this),language:this.language,bookingNumber:this.roomNightsData.bookingNumber,identifier:this.roomNightsData.identifier,toDate:this.roomNightsData.to_date,fromDate:this.roomNightsData.from_date,defaultDates:this.roomNightsData.defaultDates,ticket:this.ticket,propertyId:this.property_id}),this.calendarSidebarState?.type==="split"&&s("igl-split-booking",{key:"54aede22c4ab512029275e83995187dfe06e6a41",slot:"sidebar-body",booking:this.calendarSidebarState?.payload?.booking,identifier:this.calendarSidebarState?.payload?.identifier,onCloseModal:()=>this.calendarSidebarState=null}),this.editBookingItem&&this.editBookingItem.event_type==="EDIT_BOOKING"&&s("ir-booking-details",{key:"03a4bfe0aa516040da98fe92dbc0b988979d5c33",slot:"sidebar-body",hasPrint:true,hasReceipt:true,hasCloseButton:true,onCloseSidebar:()=>this.editBookingItem=null,is_from_front_desk:true,propertyid:this.property_id,hasRoomEdit:true,hasRoomDelete:true,bookingNumber:this.editBookingItem.BOOKING_NUMBER,ticket:this.ticket,language:this.language,hasRoomAdd:true}),this.calendarSidebarState?.type==="bulk-blocks"&&s("igl-bulk-operations",{key:"c099a504e75145f83d47156c8be7dc5c95c0d2a7",slot:"sidebar-body",property_id:this.property_id,onCloseModal:()=>this.calendarSidebarState=null})),s("ir-room-guests",{key:"bcb7521dc9b6e8be8b2f2ba8a0a779ea8d5f3c7d",open:this.calendarSidebarState?.type==="room-guests",countries:this.countries,language:this.language,identifier:this.calendarSidebarState?.payload?.identifier,bookingNumber:this.calendarSidebarState?.payload?.bookingNumber,roomName:this.calendarSidebarState?.payload?.roomName,totalGuests:this.calendarSidebarState?.payload?.totalGuests,sharedPersons:this.calendarSidebarState?.payload?.sharing_persons,checkIn:this.calendarSidebarState?.payload?.checkin,onCloseModal:()=>this.calendarSidebarState=null}),s("igl-reallocation-dialog",{key:"55ba2fad584203dcaa84c9b55c7178835e7a05ee",onResetModalState:()=>this.dialogData=null,onDialogClose:()=>this.handleModalCancel(),data:this.dialogData?.reason==="reallocate"?this.dialogData:undefined}),s("ir-modal",{key:"4503c7d483f2690e2e2284364d3ebf9056f1eee9",ref:t=>this.calendarModalEl=t,modalTitle:"",rightBtnActive:this.dialogData?.reason==="reallocate"?!this.dialogData.hideConfirmButton:true,leftBtnText:P?.entries?.Lcz_Cancel,rightBtnText:P?.entries?.Lcz_Confirm,modalBody:this.renderModalBody(),onConfirmModal:this.handleModalConfirm.bind(this),onCancelModal:this.handleModalCancel.bind(this)}))}static get watchers(){return{ticket:["ticketChanged"]}}};li.style=hi;const ci=".page-title.sc-ir-arrivals{font-family:var(--wa-font-family-heading);font-weight:var(--wa-font-weight-heading);line-height:var(--wa-line-height-condensed);text-wrap:balance;font-size:var(--wa-font-size-xl)}";const ui=ci;const di=class{constructor(e){t(this,e)}ticket;propertyid;language="en";p;pageSize=20;bookingNumber;booking;paymentEntries;isPageLoading;payment;roomGuestState=null;countries;tokenService=new I;roomService=new r;bookingService=new a;paymentFolioRef;componentWillLoad(){if(this.ticket){this.tokenService.setToken(this.ticket);this.init()}H(this.pageSize);z("today",(t=>{this.getBookings()}))}handlePageSizeChange(t,e){if(t!==e)H(t)}handleTicketChange(t,e){if(t!==e&&t){this.tokenService.setToken(this.ticket);this.init()}}handleBookingPayment(t){t.stopImmediatePropagation();t.stopPropagation();const{booking_nbr:e,payment:i}=t.detail;this.booking=G.bookings.find((t=>t.booking_nbr===e));const s=this.paymentEntries.types.find((t=>t.CODE_NAME===i.payment_type.code));this.payment={...i,payment_type:{code:s.CODE_NAME,description:s.CODE_VALUE_EN,operation:s.NOTES}};this.paymentFolioRef.openFolio()}handleOpen(t){this.bookingNumber=t.detail}async handleResetExposedCancellationDueAmount(t){t.stopImmediatePropagation();t.stopPropagation();await this.getBookings()}async init(){try{this.isPageLoading=true;if(!this.propertyid&&!this.p){throw new Error("Missing credentials")}let t=this.propertyid;if(!t){await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true})}const[e,i,s,n]=await Promise.all([x?.property?Promise.resolve(null):this.roomService.getExposedProperty({id:this.propertyid||0,language:this.language,aname:this.p}),this.roomService.fetchLanguage(this.language),this.bookingService.getCountries(this.language),this.bookingService.getSetupEntriesByTableNameMulti(["_BED_PREFERENCE_TYPE","_DEPARTURE_TIME","_PAY_TYPE","_PAY_TYPE_GROUP","_PAY_METHOD"]),this.getBookings()]);this.countries=s;const{pay_type:o,pay_type_group:r,pay_method:a}=this.bookingService.groupEntryTablesResult(n);this.paymentEntries={types:o,groups:r,methods:a}}catch(t){}finally{this.isPageLoading=false}}async getBookings(){const{bookings:t,total_count:e}=await this.bookingService.getRoomsToCheckIn({property_id:x.property.id?.toString()??this.propertyid?.toString(),check_in_date:G.today,page_index:G.pagination.currentPage,page_size:G.pagination.pageSize});$(e??0);K(t)}async handlePaginationChange(t){t.stopImmediatePropagation();t.stopPropagation();const e=t.detail?.currentPage??1;if(e===G.pagination.currentPage){return}q(e);await this.getBookings()}async handlePaginationPageSizeChange(t){t.stopImmediatePropagation();t.stopPropagation();const e=t.detail?.pageSize;if(!Number.isFinite(e)){return}const i=Math.floor(Number(e));if(i===G.pagination.pageSize){return}H(i);await this.getBookings()}handleCheckingRoom(t){t.stopImmediatePropagation();t.stopPropagation();this.roomGuestState=t.detail}render(){if(this.isPageLoading){return s("ir-loading-screen",null)}return s(o,null,s("ir-toast",null),s("ir-interceptor",{handledEndpoints:["/Get_Rooms_To_Check_in"]}),s("div",{class:"ir-page__container"},s("h3",{class:"page-title"},"Arrivals"),s("ir-arrivals-table",{onCheckInRoom:t=>this.handleCheckingRoom(t),onRequestPageChange:t=>this.handlePaginationChange(t),onRequestPageSizeChange:t=>this.handlePaginationPageSizeChange(t)}),s("ir-drawer",{onDrawerHide:t=>{t.stopImmediatePropagation();t.stopPropagation();this.bookingNumber=null},withoutHeader:true,open:!!this.bookingNumber,style:{"--ir-drawer-width":"80rem","--ir-drawer-background-color":"#F2F3F8","--ir-drawer-padding-left":"0","--ir-drawer-padding-top":"0","--ir-drawer-padding-bottom":"0","--ir-drawer-padding-right":"0"}},this.bookingNumber&&s("ir-booking-details",{hasPrint:true,hasReceipt:true,hasCloseButton:true,onCloseSidebar:()=>this.bookingNumber=null,is_from_front_desk:true,propertyid:this.propertyid,hasRoomEdit:true,hasRoomDelete:true,bookingNumber:this.bookingNumber.toString(),ticket:this.ticket,language:this.language,hasRoomAdd:true})),s("ir-payment-folio",{style:{height:"auto"},bookingNumber:this.booking?.booking_nbr,paymentEntries:this.paymentEntries,payment:this.payment,mode:"payment-action",ref:t=>this.paymentFolioRef=t,onCloseModal:()=>{this.booking=null;this.payment=null}}),s("ir-room-guests",{open:this.roomGuestState!==null,countries:this.countries,language:this.language,identifier:this.roomGuestState?.identifier,bookingNumber:this.roomGuestState?.booking_nbr?.toString(),roomName:this.roomGuestState?.roomName,totalGuests:this.roomGuestState?.totalGuests,sharedPersons:this.roomGuestState?.sharing_persons,checkIn:this.roomGuestState?.checkin,onCloseModal:()=>this.roomGuestState=null})))}static get watchers(){return{pageSize:["handlePageSizeChange"],ticket:["handleTicketChange"]}}};di.style=ui;const fi=".sc-ir-booking-email-logs-h{display:block}";const pi=fi;const gi=class{constructor(e){t(this,e)}ticket;data;bookingNumber;token=new I;componentWillLoad(){if(this.ticket){this.token.setToken(this.ticket)}}handleTicketChange(){if(this.ticket){this.token.setToken(this.ticket)}}render(){return s(o,{key:"97960cd202ac6c0141afff0ab3a27a555792db92",class:"p-1"},s("ir-interceptor",{key:"80cdcdeff1fb84a75dbe1ca172084aa1f756733a",handledEndpoints:["/Get_Email_log_By_BOOK_NBR"]}),s("ir-toast",{key:"d001d93d439df613b066400e4f2df64c2a1cae08"}),s("div",{key:"495da73a00ab306aa17860e3f8b2a1d96bd50f60",class:"d-flex align-items-center mb-1",style:{gap:"0.5rem"}},s("ir-input-text",{key:"ef79ae9e212fd6b8fbe4c21fb1329377355213bf",class:"m-0",inputContainerStyle:{margin:"0"},value:this.bookingNumber,onTextChange:t=>this.bookingNumber=t.detail,placeholder:"booking number"}),s("ir-button",{key:"0f70e01952c87d8c6ec1de1bc543f732f4334485",size:"sm",text:"search",onClickHandler:async()=>{const{data:t}=await V.post("/Get_Email_log_By_BOOK_NBR",{BOOK_NBR:this.bookingNumber});if(t.ExceptionMsg){return}this.data=t.My_Result}})),s("p",{key:"62811caf29dee49f1c856d3ce95b9257905bdc85"},JSON.stringify(this.data,null,2)))}static get watchers(){return{ticket:["handleTicketChange"]}}};gi.style=pi;function yi(){const t=new URLSearchParams(window.location.search);const e={};for(const[i,s]of t.entries()){e[i]=s}return e}const mi=".sc-ir-booking-listing-h{display:block;padding:var(--wa-space-l);position:relative}";const _i=mi;const bi=class{constructor(e){t(this,e)}get el(){return i(this)}language="";ticket="";propertyid;rowCount=20;p;baseUrl;userType;isLoading=false;editBookingItem=null;showCost=false;paymentEntries;payment;booking;bookingListingService=new W;bookingService=new a;roomService=new r;propertyService=new T;token=new I;listingModal;listingModalTimeout;allowedProperties;havePrivilege;paymentFolioRef;componentWillLoad(){if(this.baseUrl){this.token.setBaseUrl(this.baseUrl)}J("end_row",this.rowCount);X.rowCount=this.rowCount;Q(this.rowCount);if(this.ticket!==""){X.token=this.ticket;this.token.setToken(this.ticket);this.initializeApp()}Z("userSelection",(t=>{tt(t)}));Z("bookings",(t=>{this.showCost=t.some((t=>t.financial.gross_cost!==null&&t.financial.gross_cost>0))}))}ticketChanged(t,e){if(t===e){return}this.token.setToken(this.ticket);X.token=this.ticket;this.initializeApp()}async fetchBookings(){await this.bookingListingService.getExposedBookings({...X.userSelection,is_to_export:false})}async initializeApp(){try{this.isLoading=true;this.havePrivilege=S(this.userType);let t=this.propertyid;if(!this.havePrivilege){if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}if(!t){const e=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true});t=e.My_Result.id}}const e=[this.bookingService.getSetupEntriesByTableNameMulti(["_PAY_TYPE","_PAY_TYPE_GROUP","_PAY_METHOD"]),this.bookingListingService.getExposedBookingsCriteria(this.havePrivilege?null:t),this.roomService.fetchLanguage(this.language,["_BOOKING_LIST_FRONT"])];let i=null;if(this.propertyid&&!this.havePrivilege){e.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true}))}if(this.havePrivilege){i=e.length;e.push(this.propertyService.getExposedAllowedProperties())}const s=await Promise.all(e);const[n]=s;const{pay_type:o,pay_type_group:r,pay_method:a}=this.bookingService.groupEntryTablesResult(n);this.paymentEntries={groups:r,methods:a,types:o};this.allowedProperties=i!==null?s[i]?.map((t=>t.id)):null;J("property_id",t);et({property_ids:this.allowedProperties,userTypeCode:this.userType});await this.fetchBookings()}catch(t){console.error("Error initializing app:",t)}finally{this.isLoading=false}}handleSideBarToggle(t){if(t.detail){this.editBookingItem=null}}geSearchFiltersFromParams(){const t=yi();if(t){console.log("update params");let e={};if(t.e){e["end_row"]=Number(t.e)}if(t.s){e["start_row"]=Number(t.s)}if(t.status){e["booking_status"]=t.status}if(t.filter){e["filter_type"]=t.filter}if(t.from){e["from"]=t.from}if(t.to){e["to"]=t.to}et(e)}console.log("params=>",t)}openModal(){this.listingModalTimeout=setTimeout((()=>{this.listingModal=this.el.querySelector("ir-listing-modal");this.listingModal.editBooking=this.editBookingItem;this.listingModal.openModal()}),100)}disconnectedCallback(){clearTimeout(this.listingModalTimeout)}async handlePaginationChange(t){t.stopImmediatePropagation();t.stopPropagation();if(!t.detail){return}it(t.detail.currentPage);await this.fetchBookings()}async handlePaginationPageSizeChange(t){if(!t.detail||!t.detail.pageSize){return}t.stopImmediatePropagation();t.stopPropagation();Q(t.detail.pageSize);await this.fetchBookings()}async handleResetStoreData(t){t.stopImmediatePropagation();t.stopPropagation();await this.fetchBookings()}handleBookingChanged(t){t.stopImmediatePropagation();t.stopPropagation();X.bookings=[...X.bookings.map((e=>{if(e.booking_nbr===t.detail.booking_nbr){return t.detail}return e}))]}handleBookingPayment(t){t.stopImmediatePropagation();t.stopPropagation();const{booking_nbr:e,payment:i}=t.detail;this.booking=this.findBooking(e);const s=this.paymentEntries.types.find((t=>t.CODE_NAME===i.payment_type.code));this.payment={...i,payment_type:{code:s.CODE_NAME,description:s.CODE_VALUE_EN,operation:s.NOTES}};this.paymentFolioRef.openFolio()}handleSelectGuestEvent(t){t.stopImmediatePropagation();t.stopPropagation();const e=this.findBooking(t.detail);if(!e){return}this.editBookingItem={booking:e,cause:"guest"}}handleOpen(t){t.stopImmediatePropagation();const e=this.findBooking(t.detail);if(!e){return}this.editBookingItem={booking:e,cause:"edit"}}async handleResetExposedCancellationDueAmount(t){t.stopImmediatePropagation();t.stopPropagation();await this.fetchBookings()}handleGuestChanged(t){t.stopImmediatePropagation();t.stopPropagation();X.bookings=X.bookings.map((e=>{const i={...e.guest};const s=t.detail;if(i.id===s.id){return{...e,guest:{...i,...s}}}return e}))}findBooking(t){return X.bookings.find((e=>e.booking_nbr===t))}render(){if(this.isLoading||this.ticket===""){return s("ir-loading-screen",null)}return s(o,null,s("ir-interceptor",null),s("ir-toast",null),s("div",{class:"main-container"},s("ir-listing-header",{propertyId:this.propertyid,p:this.p,language:this.language}),s("section",{class:"mt-2"},s("ir-booking-listing-table",null))),s("ir-drawer",{style:{"--ir-drawer-width":"80rem","--ir-drawer-background-color":"#F2F3F8","--ir-drawer-padding-left":"0","--ir-drawer-padding-top":"0","--ir-drawer-padding-bottom":"0","--ir-drawer-padding-right":"0"},onDrawerHide:t=>{t.stopImmediatePropagation();t.stopPropagation();this.editBookingItem=null},withoutHeader:true,open:this.editBookingItem?.cause==="edit"},this.editBookingItem?.booking&&s("ir-booking-details",{hasPrint:true,hasReceipt:true,hasCloseButton:true,onCloseSidebar:()=>this.editBookingItem=null,is_from_front_desk:true,propertyid:this.propertyid,hasRoomEdit:true,hasRoomDelete:true,bookingNumber:this.editBookingItem.booking?.booking_nbr.toString(),ticket:this.ticket,language:this.language,hasRoomAdd:true})),s("ir-guest-info-drawer",{onGuestInfoDrawerClosed:()=>{this.editBookingItem=null},booking_nbr:this.editBookingItem?.booking?.booking_nbr,email:this.editBookingItem?.booking?.guest.email,language:this.language,open:this.editBookingItem?.cause==="guest"}),s("ir-payment-folio",{style:{height:"auto"},bookingNumber:this.booking?.booking_nbr,paymentEntries:this.paymentEntries,payment:this.payment,mode:"payment-action",ref:t=>this.paymentFolioRef=t,onCloseModal:()=>{this.booking=null;this.payment=null}}))}static get watchers(){return{ticket:["ticketChanged"]}}};bi.style=_i;const wi=".sc-ir-daily-revenue-h{display:block}.daily-revenue__meta.sc-ir-daily-revenue{display:flex;flex-direction:column;gap:1rem}.daily-revenue__table.sc-ir-daily-revenue{flex:1 1 0%}@media (min-width: 768px){.daily-revenue__meta.sc-ir-daily-revenue{flex-direction:row}}";const ki=wi;const Di=class{constructor(i){t(this,i);this.preventPageLoad=e(this,"preventPageLoad",7)}language="";ticket="";propertyid;p;isPageLoading;property_id;groupedPayment;previousDateGroupedPayments;isLoading;filters={date:Y().format("YYYY-MM-DD"),users:null};sideBarEvent;tokenService=new I;roomService=new r;propertyService=new T;bookingService=new a;paymentEntries;preventPageLoad;componentWillLoad(){if(this.ticket){this.tokenService.setToken(this.ticket);this.initializeApp()}}ticketChanged(t,e){if(t===e){return}this.tokenService.setToken(this.ticket);this.initializeApp()}handleOpenSidebar(t){t.stopImmediatePropagation();t.stopPropagation();this.sideBarEvent=t.detail}handleFetchNewReports(t){t.stopImmediatePropagation();t.stopPropagation();this.filters={...t.detail};this.getPaymentReports()}async handleResetBooking(t){t.stopPropagation();t.stopImmediatePropagation();this.getPaymentReports(false,true)}handleSidebarClose=t=>{t.stopImmediatePropagation();t.stopPropagation();this.sideBarEvent=null};renderSidebarBody(){if(!this.sideBarEvent){return}switch(this.sideBarEvent.type){case"booking":return s("ir-booking-details",{slot:"sidebar-body",hasPrint:true,hasReceipt:true,hasCloseButton:true,onCloseSidebar:this.handleSidebarClose,is_from_front_desk:true,propertyid:this.property_id,hasRoomEdit:true,hasRoomDelete:true,bookingNumber:this.sideBarEvent.payload.bookingNumber.toString(),ticket:this.ticket,language:this.language,hasRoomAdd:true});default:return null}}async initializeApp(){this.isPageLoading=true;try{let t=this.propertyid;if(!t&&!this.p){throw new Error("Property ID or username is required")}if(!t){const e=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});t=e.My_Result.id}this.property_id=t;const e=[this.bookingService.getSetupEntriesByTableNameMulti(["_PAY_TYPE","_PAY_TYPE_GROUP","_PAY_METHOD"]),this.getPaymentReports(),this.roomService.fetchLanguage(this.language)];if(t){e.push(this.roomService.getExposedProperty({id:t,language:this.language,is_backend:true,include_units_hk_status:true}))}const[i]=await Promise.all(e);const{pay_type:s,pay_type_group:n,pay_method:o}=this.bookingService.groupEntryTablesResult(i);this.paymentEntries={groups:n,methods:o,types:s}}catch(t){console.log(t)}finally{this.isPageLoading=false}}groupPaymentsByName(t){const e=new Map;for(const i of t){const t=`${i.payTypeCode}_${i.payMethodCode}`;const s=e.get(t)??[];e.set(t,[...s,i])}return new Map([...e.entries()].sort((([t],[e])=>{const i=Number(t);const s=Number(e);if(!isNaN(i)&&!isNaN(s)){return i-s}return t.localeCompare(e)})))}async getPaymentReports(t=false,e=false){try{const i=t=>({method:t.METHOD,payTypeCode:t.PAY_TYPE_CODE,payMethodCode:t.PAY_METHOD_CODE,amount:t.AMOUNT,date:t.DATE,hour:t.HOUR,minute:t.MINUTE,user:t.USER,currency:t.CURRENCY,bookingNbr:t.BOOKING_NBR,id:L()});this.isLoading=t?"export":"filter";const s=[this.propertyService.getDailyRevenueReport({date:this.filters.date,property_id:this.property_id?.toString(),is_export_to_excel:t})];if(!t&&!e){s.push(this.propertyService.getDailyRevenueReport({date:Y(this.filters.date,"YYYY-MM-DD").add(-1,"days").format("YYYY-MM-DD"),property_id:this.property_id?.toString(),is_export_to_excel:t}))}const n=await Promise.all(s);if(!t){if(n[0]){this.groupedPayment=this.groupPaymentsByName(n[0]?.map(i))}else{this.groupedPayment=new Map}if(n[1])this.previousDateGroupedPayments=this.groupPaymentsByName(n[1]?.map(i))}}catch(t){console.log(t)}finally{this.isLoading=null}}render(){if(this.isPageLoading){return s("ir-loading-screen",null)}return s(o,null,s("ir-toast",null),s("ir-interceptor",null),s("section",{class:"p-2 d-flex flex-column",style:{gap:"1rem"}},s("div",{class:"d-flex align-items-center justify-content-between"},s("h3",{class:"mb-1 mb-md-0"},"Daily Revenue"),s("ir-button",{size:"sm",btn_color:"outline",isLoading:this.isLoading==="export",text:P.entries?.Lcz_Export,onClickHandler:async t=>{t.stopImmediatePropagation();t.stopPropagation();await this.getPaymentReports(true)},btnStyle:{height:"100%"},iconPosition:"right",icon_name:"file",icon_style:{"--icon-size":"14px"}})),s("ir-revenue-summary",{previousDateGroupedPayments:this.previousDateGroupedPayments,groupedPayments:this.groupedPayment,paymentEntries:this.paymentEntries}),s("div",{class:"daily-revenue__meta"},s("ir-daily-revenue-filters",{isLoading:this.isLoading==="filter",payments:this.groupedPayment}),s("ir-revenue-table",{filters:this.filters,class:"daily-revenue__table",paymentEntries:this.paymentEntries,payments:this.groupedPayment}))),s("ir-sidebar",{sidebarStyles:{width:this.sideBarEvent?.type==="booking"?"80rem":"var(--sidebar-width,40rem)",background:this.sideBarEvent?.type==="booking"?"#F2F3F8":"white"},open:Boolean(this.sideBarEvent),showCloseButton:false,onIrSidebarToggle:this.handleSidebarClose},this.renderSidebarBody()))}static get watchers(){return{ticket:["ticketChanged"]}}};Di.style=ki;const vi=".page-title.sc-ir-departures{font-family:var(--wa-font-family-heading);font-weight:var(--wa-font-weight-heading);line-height:var(--wa-line-height-condensed);text-wrap:balance;font-size:var(--wa-font-size-xl)}";const Ei=vi;const Ci=class{constructor(e){t(this,e)}ticket;propertyid;language="en";p;bookingNumber;booking;paymentEntries;isPageLoading;payment;checkoutState=null;invoiceState=null;tokenService=new I;roomService=new r;bookingService=new a;paymentFolioRef;componentWillLoad(){if(this.ticket){this.tokenService.setToken(this.ticket);this.init()}st("today",(t=>{this.getBookings()}))}handleTicketChange(t,e){if(t!==e){this.tokenService.setToken(this.ticket);this.init()}}handleOpen(t){this.bookingNumber=t.detail}handleBookingPayment(t){t.stopImmediatePropagation();t.stopPropagation();const{booking_nbr:e,payment:i}=t.detail;this.booking=nt.bookings.find((t=>t.booking_nbr===e));const s=this.paymentEntries.types.find((t=>t.CODE_NAME===i.payment_type.code));this.payment={...i,payment_type:{code:s.CODE_NAME,description:s.CODE_VALUE_EN,operation:s.NOTES}};this.paymentFolioRef.openFolio()}async handleResetExposedCancellationDueAmount(t){t.stopImmediatePropagation();t.stopPropagation();await this.getBookings()}async init(){try{this.isPageLoading=true;if(!this.propertyid&&!this.p){throw new Error("Missing credentials")}let t=this.propertyid;if(!t){await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true})}const[e,i,s]=await Promise.all([x?.property?Promise.resolve(null):this.roomService.getExposedProperty({id:this.propertyid||0,language:this.language,aname:this.p}),this.roomService.fetchLanguage(this.language),this.bookingService.getSetupEntriesByTableNameMulti(["_BED_PREFERENCE_TYPE","_DEPARTURE_TIME","_PAY_TYPE","_PAY_TYPE_GROUP","_PAY_METHOD"]),this.getBookings()]);const{pay_type:n,pay_type_group:o,pay_method:r}=this.bookingService.groupEntryTablesResult(s);this.paymentEntries={types:n,groups:o,methods:r}}catch(t){}finally{this.isPageLoading=false}}async getBookings(){const{bookings:t,total_count:e}=await this.bookingService.getRoomsToCheckout({property_id:x.property?.id?.toString()||this.propertyid?.toString(),check_out_date:nt.today,page_index:nt.pagination.currentPage,page_size:nt.pagination.pageSize});ot(e??0);rt(t)}handleCheckoutRoom(t){t.stopImmediatePropagation();t.stopPropagation();this.checkoutState=t.detail}async handlePaginationChange(t){t.stopImmediatePropagation();t.stopPropagation();const e=t.detail?.currentPage??1;if(e===nt.pagination.currentPage){return}at(e);await this.getBookings()}async handleCheckoutDialogClosed(t){t.stopImmediatePropagation();t.stopPropagation();const e={...this.checkoutState};this.checkoutState=null;switch(t.detail.reason){case"checkout":await this.getBookings();break;case"openInvoice":this.invoiceState={...e};await this.getBookings();break}}async handlePaginationPageSizeChange(t){t.stopImmediatePropagation();t.stopPropagation();const e=t.detail?.pageSize;if(!Number.isFinite(e)){return}const i=Math.floor(Number(e));if(i===nt.pagination.pageSize){return}ht(i);await this.getBookings()}handleInvoiceClose(t){t.stopImmediatePropagation();t.stopPropagation();this.invoiceState=null}render(){if(this.isPageLoading){return s("ir-loading-screen",null)}return s(o,null,s("ir-toast",null),s("ir-interceptor",{handledEndpoints:["/Get_Rooms_To_Check_Out"]}),s("div",{class:"ir-page__container"},s("h3",{class:"page-title"},"Departures"),s("ir-departures-table",{onCheckoutRoom:t=>this.handleCheckoutRoom(t),onRequestPageChange:t=>this.handlePaginationChange(t),onRequestPageSizeChange:t=>this.handlePaginationPageSizeChange(t)})),s("ir-drawer",{onDrawerHide:t=>{t.stopImmediatePropagation();t.stopPropagation();this.bookingNumber=null},withoutHeader:true,open:!!this.bookingNumber,style:{"--ir-drawer-width":"80rem","--ir-drawer-background-color":"#F2F3F8","--ir-drawer-padding-left":"0","--ir-drawer-padding-right":"0","--ir-drawer-padding-top":"0","--ir-drawer-padding-bottom":"0"}},this.bookingNumber&&s("ir-booking-details",{hasPrint:true,hasReceipt:true,hasCloseButton:true,onCloseSidebar:()=>this.bookingNumber=null,is_from_front_desk:true,propertyid:this.propertyid,hasRoomEdit:true,hasRoomDelete:true,bookingNumber:this.bookingNumber.toString(),ticket:this.ticket,language:this.language,hasRoomAdd:true})),s("ir-payment-folio",{style:{height:"auto"},bookingNumber:this.booking?.booking_nbr,paymentEntries:this.paymentEntries,payment:this.payment,mode:"payment-action",ref:t=>this.paymentFolioRef=t,onCloseModal:()=>{this.booking=null;this.payment=null}}),s("ir-checkout-dialog",{booking:this.checkoutState?.booking,identifier:this.checkoutState?.identifier,open:this.checkoutState!==null,onCheckoutDialogClosed:t=>this.handleCheckoutDialogClosed(t)}),s("ir-invoice",{onInvoiceClose:t=>this.handleInvoiceClose(t),booking:this.invoiceState?.booking,roomIdentifier:this.invoiceState?.identifier,open:this.invoiceState!==null}))}static get watchers(){return{ticket:["handleTicketChange"]}}};Ci.style=Ei;const Si=".sc-ir-hk-tasks-h{display:block;box-sizing:border-box}.sc-ir-hk-tasks-h *.sc-ir-hk-tasks{box-sizing:border-box}.tasks-view.sc-ir-hk-tasks{display:flex;flex-direction:column}@media (min-width: 1024px){.tasks-view.sc-ir-hk-tasks{flex-direction:row}}";const Ai=Si;const Oi=class{constructor(i){t(this,i);this.clearSelectedHkTasks=e(this,"clearSelectedHkTasks",7)}get el(){return i(this)}language="";ticket="";propertyid;p;baseUrl;isLoading=false;isCleaningLoading=false;selectedDuration="";selectedHouseKeeper="0";selectedRoom=null;archiveOpened=false;property_id;isSidebarOpen;isApplyFiltersLoading;filters;modalCauses;clearSelectedHkTasks;hkNameCache={};roomService=new r;houseKeepingService=new U;token=new I;table_sorting=new Map;modal;componentWillLoad(){if(this.baseUrl){this.token.setBaseUrl(this.baseUrl)}if(this.ticket!==""){this.token.setToken(this.ticket);this.init()}}ticketChanged(t,e){if(t===e){return}this.token.setToken(this.ticket);this.init()}handleCloseSidebar(t){t.stopImmediatePropagation();t.stopPropagation();this.isSidebarOpen=false}handleSortingChanged(t){t.stopImmediatePropagation();t.stopPropagation();const{field:e,direction:i}=t.detail;console.log(t.detail);if(e==="date"){return}this.table_sorting.set(e,i)}handleSkipSelectedTask(t){t.stopImmediatePropagation();t.stopPropagation();this.modalCauses={task:t.detail,cause:"skip"};this.modal?.openModal()}async init(){try{this.isLoading=true;lt(true);let t=this.propertyid;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}if(!t){console.log(t);const e=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});t=e.My_Result.id}this.property_id=t;const e=[this.houseKeepingService.getExposedHKSetup(this.property_id),this.roomService.fetchLanguage(this.language)];if(this.propertyid){e.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true,include_units_hk_status:true}))}await Promise.all(e);const i=await this.houseKeepingService.getHkTasks({property_id:this.property_id,from_date:Y().format("YYYY-MM-DD"),to_date:Y().format("YYYY-MM-DD"),housekeepers:[],cleaning_frequency:(x.cleaning_frequency??j?.hk_criteria?.cleaning_frequencies[0])?.code,dusty_window:j?.hk_criteria?.dusty_periods[0]?.code,highlight_window:j?.hk_criteria?.highlight_checkin_options[0]?.code});if(i?.tasks){this.updateTasks(i.tasks)}}catch(t){console.log(t)}finally{this.isLoading=false;lt(false)}}buildHousekeeperNameCache(){this.hkNameCache={};j.hk_criteria?.housekeepers?.forEach((t=>{if(t.id!=null&&t.name!=null){this.hkNameCache[t.id]=t.name}}))}updateTasks(t){this.buildHousekeeperNameCache();ct(t.map((t=>({...t,id:L(),housekeeper:(()=>{const e=this.hkNameCache[t.hkm_id];if(e){return e}const i=j.hk_criteria?.housekeepers?.find((e=>e.id===t.hkm_id))?.name;this.hkNameCache[t.hkm_id]=i;return i})()}))))}async handleHeaderButtonPress(t){t.stopImmediatePropagation();t.stopPropagation();const{name:e}=t.detail;switch(e){case"cleaned":case"clean-inspect":this.modal?.openModal();this.modalCauses={task:null,cause:"clean",status:e==="clean-inspect"?"004":"001"};break;case"export":const t=Array.from(this.table_sorting.entries()).map((([t,e])=>({key:t,value:e})));console.log(t);const{url:i}=await this.fetchTasksWithFilters(true);A(i);break;case"archive":this.isSidebarOpen=true;break}}handleSelectedTaskCleaningEvent(t){t.stopImmediatePropagation();t.stopPropagation();this.modalCauses={...t.detail,cause:"clean"};this.modal?.openModal()}async handleModalConfirmation(t){try{t.stopImmediatePropagation();t.stopPropagation();if(ut.selectedTasks.length===0){return}this.isCleaningLoading=true;if(this.modalCauses?.cause==="skip"){const{booking_nbr:t,date:e,unit:i}=this.modalCauses.task;await this.houseKeepingService.editHkSkip({BOOK_NBR:t,DATE:e,COMMENT:"",HK_SKIP_ID:-1,HK_SKIP_REASON_CODE:"001",PR_ID:i.id})}else{await this.houseKeepingService.executeHKAction({actions:ut.selectedTasks.map((t=>({description:"Cleaned",hkm_id:t.hkm_id===0?null:t.hkm_id,unit_id:t.unit.id,booking_nbr:t.booking_nbr,status:this.modalCauses?.status??"001"})))})}await this.fetchTasksWithFilters()}finally{dt();if(this.modalCauses){this.modalCauses=null}this.isCleaningLoading=false;this.modal.closeModal()}}async applyFilters(t){try{this.isApplyFiltersLoading=true;t.stopImmediatePropagation();t.stopPropagation();this.filters={...t.detail};await this.fetchTasksWithFilters()}catch(t){console.log(t)}finally{this.isApplyFiltersLoading=false}}async fetchTasksWithFilters(t=false){const{cleaning_periods:e,housekeepers:i,cleaning_frequencies:s,dusty_units:n,highlight_check_ins:o}=this.filters??{};const{tasks:r,url:a}=await this.houseKeepingService.getHkTasks({housekeepers:i,cleaning_frequency:s?.code,dusty_window:n?.code,highlight_window:o?.code,property_id:this.property_id,from_date:Y().format("YYYY-MM-DD"),to_date:e?.code||Y().format("YYYY-MM-DD"),is_export_to_excel:t});console.log(r);if(r){this.updateTasks(r)}return{tasks:r,url:a}}render(){if(this.isLoading){return s("ir-loading-screen",null)}return s(o,{"data-testid":"hk_tasks_base"},s("ir-toast",null),s("ir-interceptor",null),s("section",{class:"p-1 d-flex flex-column",style:{gap:"1rem"}},s("h3",null,"Housekeeping Tasks"),s("div",{class:"tasks-view ",style:{gap:"1rem"}},s("ir-tasks-filters",{isLoading:this.isApplyFiltersLoading,onApplyFilters:t=>{this.applyFilters(t)}}),s("div",{class:"d-flex w-100 flex-column",style:{gap:"1rem"}},s("ir-tasks-table",{onRowSelectChange:t=>{t.stopImmediatePropagation();t.stopPropagation();ft(t.detail)},class:"flex-grow-1 w-100"})))),s("ir-modal",{autoClose:false,ref:t=>this.modal=t,isLoading:this.isCleaningLoading,onConfirmModal:this.handleModalConfirmation.bind(this),onCancelModal:()=>{if(this.modalCauses){dt();this.modalCauses=null}},iconAvailable:true,icon:"ft-alert-triangle danger h1",leftBtnText:P.entries.Lcz_Cancel,rightBtnText:P.entries.Lcz_Confirm,leftBtnColor:"secondary",rightBtnColor:"primary",modalTitle:P.entries.Lcz_Confirmation,modalBody:this.modalCauses?this.modalCauses?.cause==="clean"?this.modalCauses.task?`Update ${this.modalCauses?.task?.unit?.name} to Clean`:"Update selected unit(s) to Clean":"Skip cleaning and reschedule for tomorrow.":"Update selected unit(s) to Clean"}),s("ir-sidebar",{open:this.isSidebarOpen,id:"editGuestInfo",onIrSidebarToggle:t=>{t.stopImmediatePropagation();t.stopPropagation();this.isSidebarOpen=false},showCloseButton:false},this.isSidebarOpen&&s("ir-hk-archive",{ticket:this.token.getToken(),propertyId:this.property_id,slot:"sidebar-body"})))}static get watchers(){return{ticket:["ticketChanged"]}}};Oi.style=Ai;const Ti=".sc-ir-housekeeping-h{display:block}";const Yi=Ti;const Mi=class{constructor(i){t(this,i);this.toast=e(this,"toast",7)}language="";ticket="";propertyid;p;baseUrl;isLoading=false;toast;roomService=new r;houseKeepingService=new U;propertyService=new T;token=new I;modal;selectedCleaningFrequency;componentWillLoad(){if(this.baseUrl){this.token.setBaseUrl(this.baseUrl)}if(this.ticket!==""){this.token.setToken(this.ticket);this.initializeApp()}}async handleResetData(t){t.stopImmediatePropagation();t.stopPropagation();await this.houseKeepingService.getExposedHKSetup(this.propertyid)}ticketChanged(t,e){if(t===e){return}this.token.setToken(this.ticket);this.initializeApp()}async initializeApp(){try{this.isLoading=true;let t=this.propertyid;if(!t){const e=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_sales_rate_plans:true});t=e.My_Result.id}F("default_properties",{token:this.ticket,property_id:t,language:this.language});const e=[];if(x.housekeeping_enabled){e.push(this.houseKeepingService.getExposedHKSetup(t))}e.push(this.roomService.fetchLanguage(this.language,["_HK_FRONT","_PMS_FRONT"]));if(this.propertyid){e.push(this.roomService.getExposedProperty({id:t,language:this.language,is_backend:true,include_sales_rate_plans:true}))}await Promise.all(e);this.selectedCleaningFrequency=x.cleaning_frequency?.code}catch(t){console.error(t)}finally{this.isLoading=false}}async saveAutomaticCheckInCheckout(t){t.stopImmediatePropagation();t.stopPropagation();try{await this.roomService.SetAutomaticCheckInOut({property_id:j.default_properties.property_id,flag:t.detail==="auto"});this.toast.emit({position:"top-right",title:"Saved Successfully",description:"",type:"success"})}catch(t){console.log(t)}}async saveCleaningFrequency(t){t.stopImmediatePropagation();t.stopPropagation();try{await this.propertyService.setExposedCleaningFrequency({property_id:j.default_properties.property_id,code:this.selectedCleaningFrequency});x.cleaning_frequency={code:this.selectedCleaningFrequency,description:""};this.toast.emit({position:"top-right",title:"Saved Successfully",description:"",type:"success"});this.modal.closeModal()}catch(t){console.log(t)}}render(){if(this.isLoading){return s("ir-loading-screen",null)}console.log(x.cleaning_frequency);return s(o,null,s("ir-interceptor",null),s("ir-toast",null),s("section",{class:"p-1"},s("h3",{class:"mb-2"},P.entries.Lcz_HouseKeepingAndCheckInSetup),s("div",{class:"card p-1"},s("ir-title",{borderShown:true,label:"Operations Settings"}),s("div",{class:"d-flex align-items-center mb-1"},s("p",{class:"my-0 py-0 mr-1"},P.entries.Lcz_CheckInOutGuestsAutomatically),s("ir-select",{showFirstOption:false,selectedValue:x.is_automatic_check_in_out?"auto":"manual",onSelectChange:t=>this.saveAutomaticCheckInCheckout(t),data:[{text:P.entries.Lcz_YesAsPerPropertyPolicy,value:"auto"},{text:P.entries.Lcz_NoIWillDoItManually,value:"manual"}]})),s("div",{class:"d-flex align-items-center"},s("p",{class:"my-0 py-0 mr-1"},P.entries.Lcz_CleaningFrequency,":"),s("ir-select",{showFirstOption:false,selectedValue:this.selectedCleaningFrequency,onSelectChange:t=>{t.stopImmediatePropagation();t.stopPropagation();this.selectedCleaningFrequency=t.detail;this.modal.openModal()},data:j?.hk_criteria?.cleaning_frequencies.map((t=>({text:t.description,value:t.code})))}))),x.housekeeping_enabled&&s("ir-hk-team",{class:"mb-1"}),s("ir-modal",{autoClose:false,ref:t=>this.modal=t,isLoading:pt("/Set_Exposed_Cleaning_Frequency"),onConfirmModal:this.saveCleaningFrequency.bind(this),iconAvailable:true,onCancelModal:()=>{this.selectedCleaningFrequency=x.cleaning_frequency?.code},icon:"ft-alert-triangle danger h1",leftBtnText:P.entries.Lcz_Cancel,rightBtnText:P.entries.Lcz_Confirm,leftBtnColor:"secondary",rightBtnColor:"primary",modalTitle:P.entries.Lcz_Confirmation,modalBody:"This action will reschedule all cleaning tasks. Do you want to continue?"})))}static get watchers(){return{ticket:["ticketChanged"]}}};Mi.style=Yi;const Pi=".sc-ir-monthly-bookings-report-h{display:block}";const xi=Pi;const Ri=class{constructor(e){t(this,e)}language="";ticket="";propertyid;p;isPageLoading=true;isLoading=null;reports=[];filters;property_id;stats;baseFilters;tokenService=new I;roomService=new r;propertyService=new T;componentWillLoad(){this.baseFilters={date:{description:Y().format("MMMM YYYY"),firstOfMonth:Y().startOf("month").format("YYYY-MM-DD"),lastOfMonth:Y().endOf("month").format("YYYY-MM-DD")},include_previous_year:false};this.filters=this.baseFilters;if(this.ticket){this.tokenService.setToken(this.ticket);this.init()}}handleTicketChange(t,e){if(t!==e){this.tokenService.setToken(this.ticket);this.init()}}handleApplyFiltersChange(t){t.stopImmediatePropagation();t.stopPropagation();this.filters=t.detail;this.getReports()}async init(){try{let t=this.propertyid;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}if(!t){console.log(t);const e=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});t=e.My_Result.id}this.property_id=t;const e=[this.roomService.fetchLanguage(this.language),this.getReports()];if(this.propertyid){e.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true,include_units_hk_status:true}))}await Promise.all(e)}catch(t){console.log(t)}finally{this.isPageLoading=false}}async getReports(t=false){try{const e=t=>({day:t.Date,units_booked:t.Units_booked,occupancy_percent:t.Occupancy,adr:t.ADR,rooms_revenue:t.Rooms_Revenue,total_guests:t?.Total_Guests});this.isLoading=t?"export":"filter";const{date:i,include_previous_year:s}=this.filters;const n=[this.propertyService.getMonthlyStats({from_date:i.firstOfMonth,to_date:i.lastOfMonth,property_id:this.property_id,is_export_to_excel:t})];if(s){n.push(this.propertyService.getMonthlyStats({from_date:Y(i.firstOfMonth,"YYYY-MM-DD").add(-1,"year").format("YYYY-MM-DD"),to_date:Y(i.lastOfMonth,"YYYY-MM-DD").add(-1,"years").format("YYYY-MM-DD"),property_id:this.property_id}))}const o=await Promise.all(n);const r=o[0];let a=[];const{DailyStats:h,...l}=r;this.stats={...l};if(s&&o[t?0:1]){const i=o[t?0:1];let s=i.DailyStats.map(e);a=h.map(e).map((t=>{const e=s.find((e=>e.day===Y(t.day,"YYYY-MM-DD").add(-1,"years").format("YYYY-MM-DD")));return{...t,last_year:e??null}}))}else{a=h.map(e)}this.reports=[...a]}catch(t){console.log(t)}finally{this.isLoading=null}}render(){if(this.isPageLoading){return s("ir-loading-screen",null)}return s(o,null,s("ir-toast",null),s("ir-interceptor",null),s("section",{class:"p-2 d-flex flex-column",style:{gap:"1rem"}},s("div",{class:"d-flex align-items-center justify-content-between"},s("h3",{class:"mb-1 mb-md-0"},"Daily Occupancy"),s("ir-button",{size:"sm",btn_color:"outline",isLoading:this.isLoading==="export",text:P.entries?.Lcz_Export,onClickHandler:async t=>{t.stopImmediatePropagation();t.stopPropagation();await this.getReports(true)},btnStyle:{height:"100%"},iconPosition:"right",icon_name:"file",icon_style:{"--icon-size":"14px"}})),s("section",null,s("div",{class:"d-flex flex-column flex-md-row w-100",style:{gap:"1rem",alignItems:"stretch"}},s("ir-stats-card",{icon:this.stats?.Occupancy_Difference_From_Previous_Month<0?"arrow-trend-down":"arrow-trend-up",cardTitle:"Average Occupancy",value:this.stats.AverageOccupancy?this.stats?.AverageOccupancy.toFixed(2)+"%":null,subtitle:`${this.stats?.Occupancy_Difference_From_Previous_Month<0?"":"+"}${this.stats?.Occupancy_Difference_From_Previous_Month.toFixed(2)}% from last month`}),s("ir-stats-card",{icon:"hotel",cardTitle:"Total Units",value:this.stats?.TotalUnitsBooked?this.stats?.TotalUnitsBooked.toString():null,subtitle:"Booked"}),s("ir-stats-card",{icon:"user_group",cardTitle:"Total Guests",value:this.stats?.Total_Guests?.toString(),subtitle:"Stayed"}),s("ir-stats-card",{icon:"calendar",cardTitle:"Peak Days",value:this.stats?.PeakDays.length===0?null:this.stats?.PeakDays?.map((t=>Y(t.Date,"YYYY-MM-DD").format("D").concat("th"))).join(" - "),subtitle:`${Math.max(...this.stats.PeakDays?.map((t=>t.OccupancyPercent))||[])}% occupancy`})),s("div",{class:"d-flex flex-column flex-lg-row mt-1 ",style:{gap:"1rem"}},s("ir-monthly-bookings-report-filter",{isLoading:this.isLoading==="filter",class:"filters-card",baseFilters:this.baseFilters}),s("ir-monthly-bookings-report-table",{reports:this.reports})))))}static get watchers(){return{ticket:["handleTicketChange"]}}};Ri.style=xi;const Ni=".sc-ir-sales-by-channel-h{display:block}";const Bi=Ni;const Ii=class{constructor(e){t(this,e)}language="";ticket="";propertyid;p;mode;isLoading=null;isPageLoading=true;salesData;channelSalesFilters;allowedProperties=[];propertyID;token=new I;roomService=new r;propertyService=new T;baseFilters={FROM_DATE:Y().add(-7,"days").format("YYYY-MM-DD"),TO_DATE:Y().format("YYYY-MM-DD"),BOOK_CASE:"001",WINDOW:7,include_previous_year:false,is_export_to_excel:false};componentWillLoad(){this.channelSalesFilters=this.baseFilters;if(this.ticket){this.token.setToken(this.ticket);this.initializeApp()}}ticketChanged(t,e){if(t===e){return}this.token.setToken(this.ticket);this.initializeApp()}async initializeApp(){try{if(!this.mode){throw new Error("Missing required 'mode'. Please set it to either 'property' or 'mpo'.")}if(!this.propertyid&&this.mode==="property"&&!this.p){throw new Error("Missing Property ID or aname")}if(this.mode==="property"){const t=await this.propertyService.getExposedProperty({id:Number(this.propertyid??0),aname:this.p,language:this.language,is_backend:true});this.propertyID=t.My_Result.id}const t=[,this.roomService.fetchLanguage(this.language)];if(this.mode==="mpo"){t.unshift(this.propertyService.getExposedAllowedProperties());const[e]=await Promise.all(t);this.allowedProperties=[...e]}this.baseFilters={...this.baseFilters,LIST_AC_ID:this.allowedProperties?.map((t=>t.id))};this.channelSalesFilters={...this.baseFilters};await this.getChannelSales()}catch(t){console.log(t)}finally{this.isPageLoading=false}}async getChannelSales(t=false){try{const{include_previous_year:e,LIST_AC_ID:i,...s}=this.channelSalesFilters;this.isLoading=t?"export":"filter";const n=await this.propertyService.getChannelSales({is_export_to_excel:t,...s,AC_ID:this.propertyID?this.propertyID.toString():undefined,...s,LIST_AC_ID:this.propertyID?null:i});const o=!t&&e;let r=[];if(o){const t=await this.propertyService.getChannelSales({AC_ID:this.propertyID?this.propertyID.toString():undefined,...s,LIST_AC_ID:this.propertyID?null:i,FROM_DATE:Y(s.FROM_DATE).subtract(1,"year").format("YYYY-MM-DD"),TO_DATE:Y(s.TO_DATE).subtract(1,"year").format("YYYY-MM-DD")});r=n.map((e=>{const i=t.find((t=>t.SOURCE.toLowerCase()===e.SOURCE.toLowerCase()));return{...e,last_year:i?i:null}}))}else{r=n.map((t=>({...t,last_year:null})))}const a=t=>{if(!t||t.length===0)return t;const e=t=>t?.currency??null;const i=t=>{const i=t.SOURCE.toString().toLowerCase().trim();const s=e(t);return`${i}__${s??"null"}`};const s=(t,e)=>(t??0)+(e??0);const n=(t,e)=>{if(!e)return t;if(!t)return{...e};return{NIGHTS:s(t.NIGHTS,e.NIGHTS),PCT:s(t.PCT,e.PCT),REVENUE:s(t.REVENUE,e.REVENUE),SOURCE:t.SOURCE,PROPERTY_ID:t.PROPERTY_ID,PROPERTY_NAME:t.PROPERTY_NAME,currency:t.currency}};const o=new Map;for(const e of t){const t=i(e);const r=o.get(t);if(!r){o.set(t,{...e})}else{const i={...r,NIGHTS:s(r.NIGHTS,e.NIGHTS),PCT:0,REVENUE:s(r.REVENUE,e.REVENUE),last_year:n(r.last_year,e.last_year)};o.set(t,i)}}const r=Array.from(o.values());const a=r.reduce(((t,e)=>t+(e.REVENUE??0)),0);if(a>0){for(const t of r){t.PCT=t.REVENUE/a*100;if(t.last_year){const e=r.reduce(((t,e)=>t+(e.last_year?.REVENUE??0)),0);if(e>0){t.last_year.PCT=t.last_year.REVENUE/e*100}}}}return r};this.salesData=[...a(r)]}catch(t){console.error("Failed to fetch sales data:",t)}finally{this.isLoading=null}}render(){if(this.isPageLoading){return s("ir-loading-screen",null)}return s(o,null,s("ir-toast",null),s("ir-interceptor",null),s("section",{class:"p-2 d-flex flex-column",style:{gap:"1rem"}},s("div",{class:"d-flex align-items-center justify-content-between"},s("h3",{class:"mb-1 mb-md-0"},"Sales by Channel"),s("ir-button",{size:"sm",btn_color:"outline",isLoading:this.isLoading==="export",text:P.entries.Lcz_Export,onClickHandler:async t=>{t.stopImmediatePropagation();t.stopPropagation();await this.getChannelSales(true)},btnStyle:{height:"100%"},iconPosition:"right",icon_name:"file",icon_style:{"--icon-size":"14px"}})),s("div",{class:"d-flex flex-column flex-lg-row mt-1 ",style:{gap:"1rem"}},s("ir-sales-by-channel-filters",{isLoading:this.isLoading==="filter",onApplyFilters:t=>{t.stopImmediatePropagation();t.stopPropagation();this.channelSalesFilters={...t.detail};this.getChannelSales()},allowedProperties:this.allowedProperties,baseFilters:this.baseFilters}),s("ir-sales-by-channel-table",{mode:this.mode,allowedProperties:this.allowedProperties,class:"card mb-0",records:this.salesData}))))}static get watchers(){return{ticket:["ticketChanged"]}}};Ii.style=Bi;const Li=".sc-ir-sales-by-country-h{display:block}";const Ui=Li;const ji=class{constructor(e){t(this,e)}language="";ticket="";propertyid;p;isLoading=null;isPageLoading=true;property_id;salesData;salesFilters;countries=new Map;token=new I;roomService=new r;propertyService=new T;bookingService=new a;baseFilters={FROM_DATE:Y().add(-7,"days").format("YYYY-MM-DD"),TO_DATE:Y().format("YYYY-MM-DD"),BOOK_CASE:"001",WINDOW:7,include_previous_year:false};componentWillLoad(){this.salesFilters=this.baseFilters;if(this.ticket){this.token.setToken(this.ticket);this.initializeApp()}}ticketChanged(t,e){if(t===e){return}this.token.setToken(this.ticket);this.initializeApp()}async initializeApp(){try{let t=this.propertyid;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}if(!t){console.log(t);const e=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});t=e.My_Result.id}this.property_id=t;const e=[this.bookingService.getCountries(this.language),this.roomService.fetchLanguage(this.language),this.getCountrySales()];if(this.propertyid){e.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true,include_units_hk_status:true}))}const[i]=await Promise.all(e);const s=new Map;i.map((t=>{s.set(t.id,{flag:t.flag,name:t.name})}));this.countries=s}catch(t){console.log(t)}finally{this.isPageLoading=false}}async getCountrySales(t=false){const e=t=>({country:t.COUNTRY,country_id:t.COUNTRY_ID,nights:t.NIGHTS,percentage:t.PCT,revenue:t.REVENUE,number_of_guests:t.Total_Guests});try{const{include_previous_year:i,...s}=this.salesFilters;this.isLoading=t?"export":"filter";const n=await this.propertyService.getCountrySales({AC_ID:this.property_id,is_export_to_excel:t,...s});const o=!t&&i;let r=[];if(o){const t=await this.propertyService.getCountrySales({AC_ID:this.property_id,is_export_to_excel:false,...s,FROM_DATE:Y(s.FROM_DATE).subtract(1,"year").format("YYYY-MM-DD"),TO_DATE:Y(s.TO_DATE).subtract(1,"year").format("YYYY-MM-DD")});r=n.map((i=>{const s=t.find((t=>t.COUNTRY.toLowerCase()===i.COUNTRY.toLowerCase()));return{id:L(),...e(i),last_year:s?e(s):null}}))}else{r=n.map((t=>({id:L(),...e(t),last_year:null})))}this.salesData=[...r]}catch(t){console.error("Failed to fetch sales data:",t)}finally{this.isLoading=null}}render(){if(this.isPageLoading){return s("ir-loading-screen",null)}return s(o,null,s("ir-toast",null),s("ir-interceptor",null),s("section",{class:"p-2 d-flex flex-column",style:{gap:"1rem"}},s("div",{class:"d-flex align-items-center justify-content-between"},s("h3",{class:"mb-1 mb-md-0"},"Sales by Country"),s("ir-button",{size:"sm",btn_color:"outline",isLoading:this.isLoading==="export",text:P.entries.Lcz_Export,onClickHandler:async t=>{t.stopImmediatePropagation();t.stopPropagation();await this.getCountrySales(true)},btnStyle:{height:"100%"},iconPosition:"right",icon_name:"file",icon_style:{"--icon-size":"14px"}})),s("ir-sales-by-country-summary",{salesReports:this.salesData}),s("div",{class:"d-flex flex-column flex-lg-row mt-1 ",style:{gap:"1rem"}},s("ir-sales-filters",{isLoading:this.isLoading==="filter",onApplyFilters:t=>{t.stopImmediatePropagation();t.stopPropagation();this.salesFilters=t.detail;this.getCountrySales()},class:"filters-card",baseFilters:this.baseFilters}),s("ir-sales-table",{mappedCountries:this.countries,class:"card mb-0",records:this.salesData}))))}static get watchers(){return{ticket:["ticketChanged"]}}};ji.style=Ui;const Fi=".sc-ir-user-management-h{display:block;height:100%}";const Hi=Fi;const zi=class{constructor(e){t(this,e)}language="";baseUrl;ticket;propertyid;p;isSuperAdmin=true;userTypeCode;baseUserTypeCode;userId;isLoading=true;users=[];property_id;allowedUsersTypes=[];token=new I;roomService=new r;userService=new gt;bookingService=new a;userTypes=new Map;socket;superAdminId="5";componentWillLoad(){if(this.baseUrl){this.token.setBaseUrl(this.baseUrl)}if(this.ticket){this.token.setToken(this.ticket);this.initializeApp()}}ticketChanged(t,e){if(t===e){return}this.token.setToken(this.ticket);this.initializeApp()}async handleResetData(t){t.stopImmediatePropagation();t.stopPropagation();await this.fetchUsers()}async initializeApp(){try{if(this.baseUrl){this.token.setBaseUrl(this.baseUrl)}this.isLoading=true;let t=this.propertyid;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}if(!t){console.log(t);const e=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});t=e.My_Result.id}this.property_id=t;const e=[this.fetchUserTypes(),this.fetchUsers(),this.roomService.fetchLanguage(this.language,["_USER_MGT"])];if(this.propertyid){e.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true,include_units_hk_status:true}))}await Promise.all(e);this.socket=oi("https://realtime.igloorooms.com/");this.socket.on("MSG",(async t=>{await this.handleSocketMessage(t)}))}catch(t){console.log(t)}finally{this.isLoading=false}}async handleSocketMessage(t){const e=JSON.parse(t);if(!e){return}const{REASON:i,KEY:s,PAYLOAD:n}=e;if(s.toString()!==this.property_id.toString()){return}let o=JSON.parse(n);console.log(s,o);const r={EMAIL_VERIFIED:this.updateUserVerificationStatus};const a=r[i];if(a){await a.call(this,o)}else{console.warn(`Unhandled REASON: ${i}`)}}updateUserVerificationStatus(t){const e=[...this.users];const i=e.findIndex((e=>e.id===t.id));if(i===-1){console.warn(`User ${t.id} not found`);return}e[i]={...e[i],is_email_verified:true};this.users=e}async fetchUsers(){const t=await this.userService.getExposedPropertyUsers({property_id:this.propertyid});this.users=[...t].sort(((t,e)=>{const i=t=>{const e=t.type.toString();if(e===this.superAdminId)return 0;if(e==="17")return 1;return 2};const s=i(t),n=i(e);if(s!==n){return s-n}return t.username.localeCompare(e.username)}))}async fetchUserTypes(){const t=await Promise.all([this.bookingService.getSetupEntriesByTableName("_USER_TYPE"),this.bookingService.getLov()]);const e=t[1]?.My_Result?.allowed_user_types;for(const i of t[0]){const t=i[`CODE_VALUE_${this.language?.toUpperCase()??"EN"}`];if(e.find((t=>t.code===i.CODE_NAME))){this.allowedUsersTypes.push({code:i.CODE_NAME,value:t})}this.userTypes.set(i.CODE_NAME.toString(),t)}}disconnectedCallback(){this.socket.disconnect()}render(){if(this.isLoading){return s(o,null,s("ir-toast",null),s("ir-interceptor",null),s("ir-loading-screen",null))}return s(o,null,s("ir-toast",null),s("ir-interceptor",{suppressToastEndpoints:["/Change_User_Pwd","/Handle_Exposed_User"]}),s("section",{class:"p-2 d-flex flex-column",style:{gap:"1rem"}},s("div",{class:"d-flex  pb-2 align-items-center justify-content-between"},s("h3",{class:"mb-1 mb-md-0"},P.entries.Lcz_ExtranetUsers)),s("div",{class:"",style:{gap:"1rem"}},s("ir-user-management-table",{property_id:this.property_id,baseUserTypeCode:this.baseUserTypeCode,allowedUsersTypes:this.allowedUsersTypes,userTypeCode:this.userTypeCode,haveAdminPrivileges:[this.superAdminId,"17"].includes(this.userTypeCode?.toString()),userTypes:this.userTypes,class:"card",isSuperAdmin:this.userTypeCode?.toString()===this.superAdminId,users:this.users}))))}static get watchers(){return{ticket:["ticketChanged"]}}};zi.style=Hi;export{li as igloo_calendar,di as ir_arrivals,gi as ir_booking_email_logs,bi as ir_booking_listing,Di as ir_daily_revenue,Ci as ir_departures,Oi as ir_hk_tasks,Mi as ir_housekeeping,Ri as ir_monthly_bookings_report,Ii as ir_sales_by_channel,ji as ir_sales_by_country,zi as ir_user_management};
//# sourceMappingURL=p-c80f154f.entry.js.map