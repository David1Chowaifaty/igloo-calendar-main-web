import{r as t,c as i,h as s,F as e,H as a,g as o}from"./p-b4b99085.js";import{R as h}from"./p-7f3cdfe0.js";import{B as n}from"./p-c08f706d.js";import{k as l,l as r,n as d,o as c,t as u,p as f,d as g,q as b,f as p,r as m,j as v,s as D,u as k,v as _,w,x as y}from"./p-ccfe88aa.js";import{l as O}from"./p-eb747876.js";import{E}from"./p-6125d5f4.js";import{h as C}from"./p-6c4ba7c0.js";import{T as A}from"./p-48f28eb5.js";import{l as S}from"./p-2fcb9a1f.js";import{c as j}from"./p-a66990e0.js";import{h as T,a as N,r as I}from"./p-4ffdf0bb.js";import{T as M}from"./p-59b1956e.js";import{H as R,h as Y,u as B}from"./p-a436c507.js";import{a as x}from"./p-05d84ef0.js";import{v as L}from"./p-4ed69de7.js";import"./p-bf44a732.js";import"./p-41fabaeb.js";import"./p-7fc0c3ea.js";const U=".sc-igloo-calendar-h{display:block;position:relative;background-color:#ffffff;height:100%;text-align:center}.igl-calendar.sc-igloo-calendar{display:grid;grid-template-columns:1fr;height:100%}.calendarScrollContainer.sc-igloo-calendar{width:100%;height:100%;overflow:auto;position:relative;white-space:nowrap;border-left:2px solid grey}.showToBeAssigned.sc-igloo-calendar,.showLegend.sc-igloo-calendar{grid-template-columns:330px 1fr}#calendarContainer.sc-igloo-calendar{position:absolute}.legendContainer.sc-igloo-calendar,.tobeAssignedContainer.sc-igloo-calendar{display:none;height:100%;overflow-y:auto;padding-left:0.5em !important;padding-right:0.5em !important}.showToBeAssigned.sc-igloo-calendar .tobeAssignedContainer.sc-igloo-calendar{display:block}.showLegend.sc-igloo-calendar .legendContainer.sc-igloo-calendar{display:block}.tobeBooked.sc-igloo-calendar{padding-top:8px;padding-bottom:8px;text-align:left}";const P=U;const H=class{constructor(s){t(this,s);this.dragOverHighlightElement=i(this,"dragOverHighlightElement",7);this.moveBookingTo=i(this,"moveBookingTo",7);this.calculateUnassignedDates=i(this,"calculateUnassignedDates",7);this.reduceAvailableUnitEvent=i(this,"reduceAvailableUnitEvent",7);this.revertBooking=i(this,"revertBooking",7);this.openCalendarSidebar=i(this,"openCalendarSidebar",7);this.ticket="";this.calendarData=new Object;this.days=new Array;this.scrollViewDragging=false;this.dialogData=null;this.bookingItem=null;this.editBookingItem=null;this.showLegend=false;this.showPaymentDetails=false;this.showToBeAssigned=false;this.unassignedDates={};this.roomNightsData=null;this.renderAgain=false;this.showBookProperty=false;this.totalAvailabilityQueue=[];this.isAuthenticated=false;this.bookingService=new n;this.roomService=new h;this.eventsService=new E;this.toBeAssignedService=new A;this.countries=[];this.visibleCalendarCells={x:[],y:[]};this.today="";this.reachedEndOfCalendar=false;this.token=new M;this.scrollViewDragPos={top:0,left:0,x:0,y:0};this.onScrollContentMoveHandler=t=>{if(t.buttons!==1){return}const i=t.clientX-this.scrollViewDragPos.x;const s=t.clientY-this.scrollViewDragPos.y;this.scrollContainer.scrollTop=this.scrollViewDragPos.top-s;this.scrollContainer.scrollLeft=this.scrollViewDragPos.left-i;if(Math.abs(i)>5||Math.abs(s)>5){this.scrollViewDragging=true}};this.onScrollContentMoveEndHandler=()=>{document.removeEventListener("mousemove",this.onScrollContentMoveHandler);document.removeEventListener("mouseup",this.onScrollContentMoveEndHandler)}}componentWillLoad(){this.init()}componentDidLoad(){this.scrollToElement(this.today)}async handleDeleteEvent(t){try{t.stopImmediatePropagation();t.preventDefault();await this.eventsService.deleteEvent(t.detail)}catch(t){}}async handleCalendarSidebarEvents(t){console.log("hit ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥");t.stopImmediatePropagation();t.stopPropagation();this.calendarSidebarState=t.detail}scrollPageToRoom(t){let i=t.detail.refClass;this.scrollContainer=this.scrollContainer||this.element.querySelector(".calendarScrollContainer");const s=this.element.querySelector(".topLeftCell");const e=this.element.querySelector("."+i);if(e){this.scrollContainer.scrollTo({top:0});const t=e.getBoundingClientRect();const i=this.scrollContainer.getBoundingClientRect();const a=s.getBoundingClientRect();this.scrollContainer.scrollTo({top:t.top-i.top-a.height-t.height})}}handleShowDialog(t){var i;t.stopImmediatePropagation();t.stopPropagation();this.dialogData=t.detail;(i=this.calendarModalEl)===null||i===void 0?void 0:i.openModal()}handleShowRoomNightsDialog(t){this.roomNightsData=t.detail}handleBookingDatasChange(t){t.stopPropagation();t.stopImmediatePropagation();let i=[...this.calendarData.bookingEvents];i=i.filter((t=>t.ID!=="NEW_TEMP_EVENT"));i.push(...t.detail.filter((t=>t.STATUS==="PENDING-CONFIRMATION")));this.updateBookingEventsDateRange(t.detail);this.calendarData=Object.assign(Object.assign({},this.calendarData),{bookingEvents:i})}handleUpdateBookingEvent(t){t.stopPropagation();t.stopImmediatePropagation();const i=t.detail;this.calendarData=Object.assign(Object.assign({},this.calendarData),{bookingEvents:this.calendarData.bookingEvents.map((t=>{if(i.ID===t.ID){return i}return t}))})}showBookingPopupEventDataHandler(t){t.preventDefault();t.stopImmediatePropagation();this.onOptionSelect(t)}updateEventDataHandler(t){let i=this.calendarData.bookingEvents.find((i=>i.id===t.detail.id));if(i&&t.detail&&t.detail.data){Object.entries(t.detail.data).forEach((([t,s])=>{i[t]=s}))}}dragOverEventDataHandler(t){if(t.detail.id==="CALCULATE_DRAG_OVER_BOUNDS"){let i=document.querySelector("igl-cal-header .topLeftCell");let s=document.querySelectorAll(".headersContainer .headerCell");let e=document.querySelectorAll(".bodyContainer .roomRow .roomTitle");this.visibleCalendarCells={x:[],y:[]};s.forEach((t=>{const s=t;this.visibleCalendarCells.x.push({left:s.offsetLeft+i.offsetWidth,width:s.offsetWidth,id:s.getAttribute("data-day")})}));e.forEach((t=>{const i=t;this.visibleCalendarCells.y.push({top:i.offsetTop,height:i.offsetHeight,id:i.getAttribute("data-room")})}));this.highlightDragOver(true,t.detail.data)}else if(t.detail.id==="DRAG_OVER"){this.highlightDragOver(true,t.detail.data)}else if(t.detail.id==="DRAG_OVER_END"){this.highlightDragOver(false,t.detail.data)}else if(t.detail.id==="STRETCH_OVER_END"){this.highlightDragOver(false,t.detail.data)}}ticketChanged(t,i){if(t===i){return}this.token.setToken(this.ticket);this.initializeApp()}init(){this.calDates={from:this.from_date,to:this.to_date};if(this.ticket!==""){this.token.setToken(this.ticket);this.initializeApp()}this.calDates={from:this.from_date,to:this.to_date};T("unassigned_dates",(t=>{if(Object.keys(t).length===0&&this.highlightedDate!==""){this.highlightedDate=""}}))}renderModalBody(){var t,i;switch((t=this.dialogData)===null||t===void 0?void 0:t.reason){case"checkin":{return`Are you sure you want to Check In this unit?`}case"checkout":{return"Are you sure you want to Check Out this unit?"}case"reallocate":return((i=this.dialogData)===null||i===void 0?void 0:i.description)||"";default:return"Unknown modal content"}}setUpCalendarData(t,i){console.log(t);this.calendarData.currency=t["My_Result"].currency;this.calendarData.allowedBookingSources=t["My_Result"].allowed_booking_sources;this.calendarData.adultChildConstraints=t["My_Result"].adult_child_constraints;console.log(this.calendarData.allowedBookingSources);this.calendarData.legendData=this.getLegendData(t);this.calendarData.is_vacation_rental=t["My_Result"].is_vacation_rental;this.calendarData.from_date=i.My_Params_Get_Rooming_Data.FROM;this.calendarData.to_date=i.My_Params_Get_Rooming_Data.TO;this.calendarData.startingDate=new Date(i.My_Params_Get_Rooming_Data.FROM).getTime();this.calendarData.endingDate=new Date(i.My_Params_Get_Rooming_Data.TO).getTime();this.calendarData.formattedLegendData=l(this.calendarData.legendData);let s=i.myBookings||[];s=s.filter((t=>{const i=C(t.TO_DATE,"YYYY-MM-DD");const s=C(t.FROM_DATE,"YYYY-MM-DD");return!i.isSame(s)}));this.calendarData.bookingEvents=s;this.calendarData.toBeAssignedEvents=[]}async initializeApp(){try{let t=this.propertyid;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}let i=null;if(!t){console.log(t);const s=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});i=s;t=s.My_Result.id}this.property_id=t;const s=[this.bookingService.getCalendarData(t,this.from_date,this.to_date),this.bookingService.getCountries(this.language),this.roomService.fetchLanguage(this.language)];if(this.propertyid){s.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true,include_units_hk_status:true}))}const e=await Promise.all(s);if(!i){i=e[e.length-1]}const[a,o]=e;r.days=a.days;r.months=a.months;this.setRoomsData(i);this.countries=o;this.setUpCalendarData(i,a);let h=i["My_Result"]["allowed_payment_methods"];this.showPaymentDetails=h.some((t=>t.code==="001"||t.code==="004"));this.updateBookingEventsDateRange(this.calendarData.bookingEvents);this.updateBookingEventsDateRange(this.calendarData.toBeAssignedEvents);this.today=this.transformDateForScroll(new Date);let n=new Date(this.calendarData.startingDate);n.setHours(0,0,0,0);this.days=a.days;this.calendarData.days=this.days;this.calendarData.monthsInfo=a.months;r.fromDate=this.calendarData.from_date;r.toDate=this.calendarData.to_date;setTimeout((()=>{this.scrollToElement(this.today)}),200);if(!this.calendarData.is_vacation_rental){const t=await this.toBeAssignedService.getUnassignedDates(this.property_id,this.from_date,this.to_date);this.unassignedDates={fromDate:this.from_date,toDate:this.to_date,data:Object.assign(Object.assign({},this.unassignedDates),t)};this.calendarData=Object.assign(Object.assign({},this.calendarData),{unassignedDates:t});N(t)}this.socket=O("https://realtime.igloorooms.com/");this.socket.on("MSG",(async t=>{await this.handleSocketMessage(t)}))}catch(t){console.error("Initializing Calendar Error",t)}}async handleSocketMessage(t){const i=JSON.parse(t);if(!i){return}const{REASON:s,KEY:e,PAYLOAD:a}=i;if(e.toString()!==this.property_id.toString()){return}let o;if(["DELETE_CALENDAR_POOL","GET_UNASSIGNED_DATES"].includes(s)){o=a}else{o=JSON.parse(a)}console.log(e,o);const h={DORESERVATION:this.handleDoReservation,BLOCK_EXPOSED_UNIT:this.handleBlockExposedUnit,ASSIGN_EXPOSED_ROOM:this.handleAssignExposedRoom,REALLOCATE_EXPOSED_ROOM_BLOCK:this.handleReallocateExposedRoomBlock,DELETE_CALENDAR_POOL:this.handleDeleteCalendarPool,GET_UNASSIGNED_DATES:this.handleGetUnassignedDates,UPDATE_CALENDAR_AVAILABILITY:this.handleUpdateCalendarAvailability,CHANGE_IN_DUE_AMOUNT:this.handleChangeInDueAmount,CHANGE_IN_BOOK_STATUS:this.handleChangeInBookStatus,NON_TECHNICAL_CHANGE_IN_BOOKING:this.handleNonTechnicalChangeInBooking,ROOM_STATUS_CHANGED:this.handleRoomStatusChanged,UNIT_HK_STATUS_CHANGED:this.handleUnitHKStatusChanged,SHARING_PERSONS_UPDATED:this.handleSharingPersonsUpdated};const n=h[s];if(n){await n.call(this,o)}else{console.warn(`Unhandled REASON: ${s}`)}}handleSharingPersonsUpdated(t){console.log("sharing persons updated",t);this.calendarData=Object.assign(Object.assign({},this.calendarData),{bookingEvents:[...this.calendarData.bookingEvents.map((i=>{var s;if(i.IDENTIFIER===t.identifier){const e=(s=t.guests)===null||s===void 0?void 0:s.find((t=>t.is_main));return Object.assign(Object.assign({},i),{NAME:d(e.first_name,e.last_name),ROOM_INFO:Object.assign(Object.assign({},i.ROOM_INFO),{sharing_persons:t.guests})})}return i}))]})}handleRoomStatusChanged(t){this.calendarData=Object.assign(Object.assign({},this.calendarData),{bookingEvents:[...this.calendarData.bookingEvents.map((i=>{if(i.IDENTIFIER===t.room_identifier){const s=c({from_date:i.FROM_DATE,to_date:i.TO_DATE,in_out:Object.assign(Object.assign({},i.ROOM_INFO.in_out),{code:t.status}),status_code:i.BASE_STATUS_CODE});return Object.assign(Object.assign({},i),{CHECKIN:t.status==="001",CHECKOUT:t.status==="002",STATUS:s})}return i}))]})}handleUnitHKStatusChanged(t){console.log("hk unit change",t);const i=[...this.calendarData.roomsInfo];const s=i.findIndex((i=>i.id===t.ROOM_CATEGORY_ID));if(s!==-1){const e=Object.assign({},i[s]);const a=e.physicalrooms.findIndex((i=>i.id===t.PR_ID));if(a!==-1){const o=[...e.physicalrooms];const h=Object.assign({},o[a]);h.hk_status=t.HKS_CODE;o[a]=h;e.physicalrooms=o;i[s]=e;this.calendarData=Object.assign(Object.assign({},this.calendarData),{roomsInfo:i})}}}async handleDoReservation(t){const i=u(t);this.AddOrUpdateRoomBookings(i)}async handleBlockExposedUnit(t){const i=[await f(t)];this.AddOrUpdateRoomBookings(i)}async handleAssignExposedRoom(t){console.log(t);const i=u(t);this.AddOrUpdateRoomBookings(i)}async handleReallocateExposedRoomBlock(t){await this.handleBlockExposedUnit(t)}async handleDeleteCalendarPool(t){console.log("delete calendar pool");this.calendarData=Object.assign(Object.assign({},this.calendarData),{bookingEvents:this.calendarData.bookingEvents.filter((i=>i.POOL!==t))})}async handleGetUnassignedDates(t){const i=this.parseDateRange(t);if(!this.calendarData.is_vacation_rental&&new Date(i.FROM_DATE).getTime()>=this.calendarData.startingDate&&new Date(i.TO_DATE).getTime()<=this.calendarData.endingDate){const t=await this.toBeAssignedService.getUnassignedDates(this.property_id,g(new Date(i.FROM_DATE)),g(new Date(i.TO_DATE)));N(t);this.unassignedDates={fromDate:g(new Date(i.FROM_DATE)),toDate:g(new Date(i.TO_DATE)),data:t};if(Object.keys(t).length===0){I(g(new Date(i.FROM_DATE)),g(new Date(i.TO_DATE)));this.reduceAvailableUnitEvent.emit({fromDate:g(new Date(i.FROM_DATE)),toDate:g(new Date(i.TO_DATE))})}}}parseDateRange(t){const i={};const s=t.split("|");s.forEach((t=>{const s=t.split(":");i[s[0]]=s[1]}));return i}handleUpdateCalendarAvailability(t){this.totalAvailabilityQueue.push(t);if(this.totalAvailabilityQueue.length>0){clearTimeout(this.availabilityTimeout)}this.availabilityTimeout=setTimeout((()=>{this.updateTotalAvailability()}),1e3)}handleChangeInDueAmount(t){this.calendarData=Object.assign(Object.assign({},this.calendarData),{bookingEvents:this.calendarData.bookingEvents.map((i=>{if(t.pools.includes(i.ID)){return Object.assign(Object.assign({},i),{BALANCE:t.due_amount})}return i}))})}handleChangeInBookStatus(t){this.calendarData=Object.assign(Object.assign({},this.calendarData),{bookingEvents:this.calendarData.bookingEvents.map((i=>{if(t.pools.includes(i.ID)){return Object.assign(Object.assign({},i),{STATUS:i.STATUS!=="IN-HOUSE"?b[t.status_code]:t.status_code==="001"?b[t.status_code]:"IN-HOUSE"})}return i}))})}handleNonTechnicalChangeInBooking(t){this.calendarData=Object.assign(Object.assign({},this.calendarData),{bookingEvents:this.calendarData.bookingEvents.map((i=>{if(i.BOOKING_NUMBER===t.booking_nbr){return Object.assign(Object.assign({},i),{PRIVATE_NOTE:p(t.extras)})}return i}))})}checkBookingAvailability(t){return this.calendarData.bookingEvents.some((i=>i.ID===t.ID||i.FROM_DATE===t.FROM_DATE&&i.TO_DATE===t.TO_DATE&&i.PR_ID===t.PR_ID))}updateBookingEventsDateRange(t){t.forEach((t=>{var i;t.legendData=this.calendarData.formattedLegendData;t.defaultDateRange={};t.defaultDateRange.fromDate=new Date(t.FROM_DATE+"T00:00:00");t.defaultDateRange.fromDateStr=this.getDateStr(t.defaultDateRange.fromDate);t.defaultDateRange.fromDateTimeStamp=t.defaultDateRange.fromDate.getTime();t.defaultDateRange.toDate=new Date(t.TO_DATE+"T00:00:00");t.defaultDateRange.toDateStr=this.getDateStr(t.defaultDateRange.toDate);t.defaultDateRange.toDateTimeStamp=t.defaultDateRange.toDate.getTime();t.defaultDateRange.dateDifference=t.NO_OF_DAYS;t.roomsInfo=[...this.calendarData.roomsInfo];if(!m(t.STATUS_CODE)){t.STATUS=c({in_out:(i=t.ROOM_INFO)===null||i===void 0?void 0:i.in_out,from_date:t.FROM_DATE,to_date:t.TO_DATE,status_code:t.BASE_STATUS_CODE})}}))}updateTotalAvailability(){let t=[...r.days];this.totalAvailabilityQueue.forEach((i=>{let s=new Date(i.date);s.setMilliseconds(0);s.setSeconds(0);s.setMinutes(0);s.setHours(0);const e=t.findIndex((t=>t.currentDate===s.getTime()));if(e!=-1){const s=t[e].rate.findIndex((t=>t.id===i.room_type_id));if(s!=-1){t[e].rate[s].exposed_inventory.rts=i.availability}}}));r.days=[...t]}setRoomsData(t){var i,s;let e=new Array;if((s=(i=t.My_Result)===null||i===void 0?void 0:i.roomtypes)===null||s===void 0?void 0:s.length){e=t.My_Result.roomtypes;t.My_Result.roomtypes.forEach((t=>{t.expanded=true}))}j.roomsInfo=e;this.calendarData.roomsInfo=e}getLegendData(t){return t["My_Result"].calendar_legends}getDateStr(t,i="default"){return t.getDate()+" "+t.toLocaleString(i,{month:"short"})+" "+t.getFullYear()}scrollToElement(t){this.scrollContainer=this.scrollContainer||this.element.querySelector(".calendarScrollContainer");const i=this.element.querySelector(".topLeftCell");const s=this.element.querySelector(".day-"+t);if(s){this.scrollContainer.scrollTo({left:0});const t=s.getBoundingClientRect();const e=this.scrollContainer.getBoundingClientRect();const a=i.getBoundingClientRect();this.scrollContainer.scrollTo({left:t.left-e.left-a.width-t.width})}}AddOrUpdateRoomBookings(t,i=undefined){let s=[...this.calendarData.bookingEvents];t.forEach((t=>{if(!this.checkBookingAvailability(t)){s=s.filter((i=>i.ID!==t.ID))}}));this.updateBookingEventsDateRange(t);if(i){s=s.filter((t=>t.POOL===i))}t.forEach((t=>{if(!s.some((i=>i.ID===t.ID))){s.push(t)}}));this.calendarData=Object.assign(Object.assign({},this.calendarData),{bookingEvents:s})}transformDateForScroll(t){return C(t).format("D_M_YYYY")}shouldRenderCalendarView(){return this.calendarData&&this.calendarData.days&&this.calendarData.days.length}onOptionSelect(t){const i=t.detail;const s=this.element.querySelector("#iglooCalendar");switch(i.key){case"showAssigned":s.classList.remove("showLegend");s.classList.remove("showToBeAssigned");s.classList.toggle("showToBeAssigned");this.showLegend=false;this.showToBeAssigned=true;break;case"showLegend":s.classList.remove("showToBeAssigned");s.classList.remove("showLegend");s.classList.toggle("showLegend");this.showLegend=true;this.showToBeAssigned=false;break;case"calendar":let t=new Date;if(i.data.start!==undefined&&i.data.end!==undefined){t=i.data.start.toDate();this.handleDateSearch(i.data)}else{t=new Date(i.data);t.setDate(t.getDate()+1);if(!(i===null||i===void 0?void 0:i.noScroll)){this.scrollToElement(t.getDate()+"_"+(t.getMonth()+1)+"_"+t.getFullYear())}}this.highlightedDate=this.transformDateForScroll(t);break;case"search":break;case"add":if(i.data.event_type!=="EDIT_BOOKING"){this.bookingItem=i.data}else{this.editBookingItem=i.data}break;case"gotoToday":this.scrollToElement(this.today);break;case"closeSideMenu":this.closeSideMenu();this.highlightedDate="";this.showBookProperty=false;break}}async addDatesToCalendar(t,i){const s=await this.bookingService.getCalendarData(this.property_id,t,i);const e=s.myBookings||[];this.updateBookingEventsDateRange(e);if(new Date(t).getTime()<new Date(this.calendarData.startingDate).getTime()){this.calendarData.startingDate=new Date(t).getTime();this.calendarData.from_date=t;r.fromDate=this.calendarData.from_date;this.days=[...s.days,...this.days];let a=[...s.months];if(this.calendarData.monthsInfo[0].monthName===s.months[s.months.length-1].monthName){this.calendarData.monthsInfo[0].daysCount=this.calendarData.monthsInfo[0].daysCount+s.months[s.months.length-1].daysCount;a.pop()}let o=JSON.parse(JSON.stringify(e));o=o.filter((t=>{const i=this.calendarData.bookingEvents.findIndex((i=>i.ID===t.ID));if(i!==-1){this.calendarData.bookingEvents[i].FROM_DATE=t.FROM_DATE;this.calendarData.bookingEvents[i].NO_OF_DAYS=v(t.FROM_DATE,this.calendarData.bookingEvents[i].TO_DATE);return false}return true}));r.days=this.days;this.calendarData=Object.assign(Object.assign({},this.calendarData),{days:this.days,monthsInfo:[...a,...this.calendarData.monthsInfo],bookingEvents:[...this.calendarData.bookingEvents,...o]});if(Math.abs(C().diff(C(t,"YYYY-MM-DD"),"days"))<=10){const s=await this.toBeAssignedService.getUnassignedDates(this.property_id,t,i);this.calendarData.unassignedDates=Object.assign(Object.assign({},this.calendarData.unassignedDates),s);this.unassignedDates={fromDate:t,toDate:i,data:s};N(s)}}else{this.calendarData.endingDate=new Date(i).getTime();this.calendarData.to_date=i;r.toDate=this.calendarData.to_date;let a=[...s.months];this.days=[...this.days,...s.days];if(this.calendarData.monthsInfo[this.calendarData.monthsInfo.length-1].monthName===s.months[0].monthName){this.calendarData.monthsInfo[this.calendarData.monthsInfo.length-1].daysCount=this.calendarData.monthsInfo[this.calendarData.monthsInfo.length-1].daysCount+s.months[0].daysCount;a.shift()}let o=JSON.parse(JSON.stringify(e));o=o.filter((t=>{const i=this.calendarData.bookingEvents.findIndex((i=>i.ID===t.ID));if(i!==-1){this.calendarData.bookingEvents[i].TO_DATE=t.TO_DATE;this.calendarData.bookingEvents[i].NO_OF_DAYS=v(this.calendarData.bookingEvents[i].FROM_DATE,t.TO_DATE);return false}return true}));r.days=this.days;this.calendarData=Object.assign(Object.assign({},this.calendarData),{days:this.days,monthsInfo:[...this.calendarData.monthsInfo,...a],bookingEvents:[...this.calendarData.bookingEvents,...o]});const h=await this.toBeAssignedService.getUnassignedDates(this.property_id,t,i);this.calendarData.unassignedDates=Object.assign(Object.assign({},this.calendarData.unassignedDates),h);this.unassignedDates={fromDate:t,toDate:i,data:h};N(h)}}async handleDateSearch(t){const i=C(t.start).toDate();const s=C(this.calDates.from).toDate();const e=t.end.toDate();const a=this.calendarData.endingDate;if(i.getTime()<new Date(this.calDates.from).getTime()){await this.addDatesToCalendar(C(i).add(-1,"days").format("YYYY-MM-DD"),C(s).add(-1,"days").format("YYYY-MM-DD"));this.calDates=Object.assign(Object.assign({},this.calDates),{from:t.start.add(-1,"days").format("YYYY-MM-DD")});this.scrollToElement(this.transformDateForScroll(i))}else if(i.getTime()>s.getTime()&&i.getTime()<a&&e.getTime()<a){this.scrollToElement(this.transformDateForScroll(i))}else if(i.getTime()>a){const t=D(new Date(this.calendarData.endingDate));await this.addDatesToCalendar(t,C(e).add(2,"months").format("YYYY-MM-DD"));this.scrollToElement(this.transformDateForScroll(i))}}closeSideMenu(){this.showLegend=false;this.showToBeAssigned=false}dragScrollContent(t){this.scrollViewDragging=false;let i=t&&t.target?this.hasAncestorWithClass(t.target,"preventPageScroll"):false;if(!i&&t.buttons===1){this.scrollViewDragPos={left:this.scrollContainer.scrollLeft,top:this.scrollContainer.scrollTop,x:t.clientX,y:t.clientY};document.addEventListener("mousemove",this.onScrollContentMoveHandler);document.addEventListener("mouseup",this.onScrollContentMoveEndHandler)}}calendarScrolling(){if(this.scrollContainer){if(this.highlightedDate){const t=document.querySelector(`.day-${this.highlightedDate}`);if(t){const{left:i,right:s}=t.getBoundingClientRect();const e=i>=0&&s<=window.innerWidth;if(!e){this.highlightedDate=""}}}const t=this.scrollContainer.getBoundingClientRect();let i=170;let s=t.width-i;let e=t.x+i;let a=t.x+t.width;let o=Array.from(this.element.querySelectorAll(".monthCell"));if(o.length){o.map((async t=>{let i=t.getBoundingClientRect();if(o.indexOf(t)===o.length-1){if(i.x+i.width<=a&&!this.reachedEndOfCalendar){this.reachedEndOfCalendar=true;const t=k(new Date(this.calendarData.endingDate));const i=D(new Date(this.calendarData.endingDate));await this.addDatesToCalendar(i,t);this.reachedEndOfCalendar=false}}if(i.x+i.width<e);else if(i.x>a);else{let o=t.querySelector(".monthTitle");let h=0;let n=i.width;if(i.x<e){h=Math.abs(i.x)-e;h=i.x<0?Math.abs(i.x)+e:Math.abs(h);n=i.x+i.width>a?s:i.x+i.width-e}else{n=s-n>n?n:s-i.x+e}o.style.marginLeft=h+"px";o.style.width=n+"px"}}))}}}hasAncestorWithClass(t,i){let s=t;while(s!==null){if(s.matches(`.${i}`)){return true}s=s.parentElement}return false}async highlightDragOver(t,i){let s,e;if(i){s=this.visibleCalendarCells.x.find((t=>t.left<i.x&&i.x<=t.left+t.width));e=this.visibleCalendarCells.y.find((t=>t.top<i.y&&i.y<=t.top+t.height))}if(t&&s&&e){this.dragOverHighlightElement.emit({dragOverElement:e.id+"_"+s.id})}else{this.dragOverHighlightElement.emit({dragOverElement:""})}if(!t){this.moveBookingTo.emit({bookingId:i.id,fromRoomId:i.fromRoomId,toRoomId:e&&e.id||"revert",moveToDay:s&&s.id||"revert",pool:i.pool,from_date:_(s&&s.id),to_date:w(s&&s.id,i.nbOfDays)})}}handleModalConfirm(){var t;const i=()=>{this.dialogData=null};try{switch((t=this.dialogData)===null||t===void 0?void 0:t.reason){case"checkin":case"checkout":{const{bookingNumber:t,roomIdentifier:s}=this.dialogData;const e=this.dialogData.reason==="checkin"?"001":"002";this.bookingService.handleExposedRoomInOut({booking_nbr:t,room_identifier:s,status:e}).finally(i);if(this.dialogData.reason==="checkin"){this.openCalendarSidebar.emit({type:"room-guests",payload:this.dialogData.sidebarPayload})}break}case"reallocate":{if(!this.dialogData){console.warn("No dialog data available for reallocation.");return}const{pool:t,toRoomId:s,from_date:e,to_date:a}=this.dialogData;this.eventsService.reallocateEvent(t,s,e,a).then(i).catch((()=>{console.error("Reallocation failed. Reverting booking.");this.revertBooking.emit(t)})).finally(i);break}default:i();break}}catch(t){console.error("Error handling modal confirm:",t);i()}}handleModalCancel(){var t;if(((t=this.dialogData)===null||t===void 0?void 0:t.reason)==="reallocate"){this.revertBooking.emit(this.dialogData.pool)}this.dialogData=null}handleRoomNightsDialogClose(t){if(t.detail.type==="cancel"){this.revertBooking.emit(this.roomNightsData.pool)}this.roomNightsData=null}handleSideBarToggle(t){var i;if(t.detail){this.calendarSidebarState=null;if(this.editBookingItem){this.editBookingItem=null}if(this.roomNightsData){this.revertBooking.emit(this.roomNightsData.pool);this.roomNightsData=null}if(((i=this.dialogData)===null||i===void 0?void 0:i.reason)==="reallocate"){this.revertBooking.emit(this.dialogData.pool);this.dialogData=null}}}handleCloseBookingWindow(){this.bookingItem=null}render(){var t,i,o,h,n,l,r,d,c,u,f,g,b,p,m,v;return s(a,{key:"1006c98d3d013839e391aff1271ccaf079b27148"},s("ir-toast",{key:"1795b05c56f7639e23449d85300e2a90aed03a32"}),s("ir-interceptor",{key:"29b772aaa9392293dad26e4d9f7654596ef668ee"}),s("div",{key:"b262dce4d82bcdf5709f69d95de3d0b3ce66dc11",id:"iglooCalendar",class:{"igl-calendar":true,showToBeAssigned:this.showToBeAssigned,showLegend:this.showLegend}},this.shouldRenderCalendarView()?s(e,{"data-testid":"ir-calendar"},this.showToBeAssigned&&s("igl-to-be-assigned",{unassignedDatesProp:this.unassignedDates,to_date:this.to_date,from_date:this.from_date,propertyid:this.property_id,class:"tobeAssignedContainer",calendarData:this.calendarData,onOptionEvent:t=>this.onOptionSelect(t)}),this.showLegend&&s("igl-legends",{class:"legendContainer",legendData:this.calendarData.legendData,onOptionEvent:t=>this.onOptionSelect(t)}),s("div",{class:"calendarScrollContainer",onMouseDown:t=>this.dragScrollContent(t),onScroll:()=>this.calendarScrolling()},s("div",{id:"calendarContainer"},s("igl-cal-header",{unassignedDates:this.unassignedDates,to_date:this.to_date,propertyid:this.property_id,today:this.today,calendarData:this.calendarData,highlightedDate:this.highlightedDate,onOptionEvent:t=>this.onOptionSelect(t)}),s("igl-cal-body",{propertyId:this.property_id,language:this.language,countries:this.countries,currency:this.calendarData.currency,today:this.today,highlightedDate:this.highlightedDate,isScrollViewDragging:this.scrollViewDragging,calendarData:this.calendarData}),s("igl-cal-footer",{highlightedDate:this.highlightedDate,today:this.today,calendarData:this.calendarData,onOptionEvent:t=>this.onOptionSelect(t)})))):s("ir-loading-screen",{message:"Preparing Calendar Data"})),this.bookingItem&&s("igl-book-property",{key:"487024b38080a00abbd29d2976ace2946a4969f1",allowedBookingSources:this.calendarData.allowedBookingSources,adultChildConstraints:this.calendarData.adultChildConstraints,showPaymentDetails:this.showPaymentDetails,countries:this.countries,currency:this.calendarData.currency,language:this.language,propertyid:this.property_id,bookingData:this.bookingItem,onCloseBookingWindow:()=>this.handleCloseBookingWindow()}),s("ir-sidebar",{key:"c6d123c0af4d8b986bbcc0aee901d533fa41ea74",onIrSidebarToggle:this.handleSideBarToggle.bind(this),open:!!this.calendarSidebarState||this.roomNightsData!==null||this.editBookingItem&&this.editBookingItem.event_type==="EDIT_BOOKING",showCloseButton:false,sidebarStyles:{width:((t=this.calendarSidebarState)===null||t===void 0?void 0:t.type)==="room-guests"?"60rem":this.editBookingItem?"80rem":"var(--sidebar-width,40rem)",background:this.editBookingItem?"#F2F3F8":"white"}},this.roomNightsData&&s("ir-room-nights",{key:"4f443a27e850333fff764d1498a29b131af1cc99",slot:"sidebar-body",pool:this.roomNightsData.pool,onCloseRoomNightsDialog:this.handleRoomNightsDialogClose.bind(this),language:this.language,bookingNumber:this.roomNightsData.bookingNumber,identifier:this.roomNightsData.identifier,toDate:this.roomNightsData.to_date,fromDate:this.roomNightsData.from_date,defaultDates:this.roomNightsData.defaultDates,ticket:this.ticket,propertyId:this.property_id}),this.editBookingItem&&this.editBookingItem.event_type==="EDIT_BOOKING"&&s("ir-booking-details",{key:"256e63b61731b30a3c8b40f87ee7aa8a56b0b60a",slot:"sidebar-body",hasPrint:true,hasReceipt:true,hasCloseButton:true,onCloseSidebar:()=>this.editBookingItem=null,is_from_front_desk:true,propertyid:this.property_id,hasRoomEdit:true,hasRoomDelete:true,bookingNumber:this.editBookingItem.BOOKING_NUMBER,ticket:this.ticket,language:this.language,hasRoomAdd:true}),((i=this.calendarSidebarState)===null||i===void 0?void 0:i.type)==="room-guests"&&s("ir-room-guests",{key:"e8709932b71a3003334b08cd9eaa7e8fbd6c576e",countries:this.countries,language:this.language,identifier:(h=(o=this.calendarSidebarState)===null||o===void 0?void 0:o.payload)===null||h===void 0?void 0:h.identifier,bookingNumber:(n=this.calendarSidebarState)===null||n===void 0?void 0:n.payload.bookingNumber,roomName:(r=(l=this.calendarSidebarState)===null||l===void 0?void 0:l.payload)===null||r===void 0?void 0:r.roomName,totalGuests:(c=(d=this.calendarSidebarState)===null||d===void 0?void 0:d.payload)===null||c===void 0?void 0:c.totalGuests,sharedPersons:(f=(u=this.calendarSidebarState)===null||u===void 0?void 0:u.payload)===null||f===void 0?void 0:f.sharing_persons,slot:"sidebar-body",checkIn:(b=(g=this.calendarSidebarState)===null||g===void 0?void 0:g.payload)===null||b===void 0?void 0:b.checkin,onCloseModal:()=>this.calendarSidebarState=null})),s("ir-modal",{key:"6f4b07bf27042f93fa5ca3b008cb17fe47e00e6f",ref:t=>this.calendarModalEl=t,modalTitle:"",rightBtnActive:((p=this.dialogData)===null||p===void 0?void 0:p.reason)==="reallocate"?!this.dialogData.hideConfirmButton:true,leftBtnText:(m=S===null||S===void 0?void 0:S.entries)===null||m===void 0?void 0:m.Lcz_Cancel,rightBtnText:(v=S===null||S===void 0?void 0:S.entries)===null||v===void 0?void 0:v.Lcz_Confirm,modalBody:this.renderModalBody(),onConfirmModal:this.handleModalConfirm.bind(this),onCancelModal:this.handleModalCancel.bind(this)}))}get element(){return o(this)}static get watchers(){return{ticket:["ticketChanged"]}}};H.style=P;const G=".sc-ir-hk-tasks-h{display:block}@media only screen and (max-width: 900px){.table-container.sc-ir-hk-tasks{width:max-content !important}}";const K=G;const F=class{constructor(s){t(this,s);this.clearSelectedHkTasks=i(this,"clearSelectedHkTasks",7);this.language="";this.ticket="";this.isLoading=false;this.selectedDuration="";this.selectedHouseKeeper="0";this.selectedRoom=null;this.archiveOpened=false;this.tasks=[];this.selectedTasks=[];this.hkNameCache={};this.roomService=new h;this.houseKeepingService=new R;this.token=new M;this.table_sorting=new Map}componentWillLoad(){if(this.ticket!==""){this.token.setToken(this.ticket);this.init()}}ticketChanged(t,i){if(t===i){return}this.token.setToken(this.ticket);this.init()}handleCloseSidebar(t){t.stopImmediatePropagation();t.stopPropagation();this.isSidebarOpen=false}handleSortingChanged(t){t.stopImmediatePropagation();t.stopPropagation();const{field:i,direction:s}=t.detail;console.log(t.detail);if(i==="date"){return}this.table_sorting.set(i,s)}async init(){try{this.isLoading=true;let t=this.propertyid;if(!this.propertyid&&!this.p){throw new Error("Property ID or username is required")}if(!t){console.log(t);const i=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});t=i.My_Result.id}this.property_id=t;const i=[this.houseKeepingService.getHkTasks({property_id:this.property_id,from_date:C().format("YYYY-MM-DD"),to_date:C().format("YYYY-MM-DD")}),this.houseKeepingService.getExposedHKSetup(this.property_id),this.roomService.fetchLanguage(this.language)];if(this.propertyid){i.push(this.roomService.getExposedProperty({id:this.propertyid,language:this.language,is_backend:true,include_units_hk_status:true}))}const s=await Promise.all(i);const e=s[0];if(e===null||e===void 0?void 0:e.tasks){this.updateTasks(e.tasks)}}catch(t){console.log(t)}finally{this.isLoading=false}}buildHousekeeperNameCache(){var t,i;this.hkNameCache={};(i=(t=Y.hk_criteria)===null||t===void 0?void 0:t.housekeepers)===null||i===void 0?void 0:i.forEach((t=>{if(t.id!=null&&t.name!=null){this.hkNameCache[t.id]=t.name}}))}updateTasks(t){this.buildHousekeeperNameCache();this.tasks=t.map((t=>Object.assign(Object.assign({},t),{id:L(),housekeeper:(()=>{var i,s,e;const a=this.hkNameCache[t.hkm_id];if(a){return a}const o=(e=(s=(i=Y.hk_criteria)===null||i===void 0?void 0:i.housekeepers)===null||s===void 0?void 0:s.find((i=>i.id===t.hkm_id)))===null||e===void 0?void 0:e.name;this.hkNameCache[t.hkm_id]=o;return o})()})))}async handleHeaderButtonPress(t){var i;t.stopImmediatePropagation();t.stopPropagation();const{name:s}=t.detail;switch(s){case"cleaned":(i=this.modal)===null||i===void 0?void 0:i.openModal();break;case"export":const t=Array.from(this.table_sorting.entries()).map((([t,i])=>({key:t,value:i})));console.log(t);const{url:s}=await this.fetchTasksWithFilters(true);y(s);break;case"archive":this.isSidebarOpen=true;break}}async handleModalConfirmation(t){try{t.stopImmediatePropagation();t.stopPropagation();if(this.selectedTasks.length===0){return}await this.houseKeepingService.executeHKAction({actions:this.selectedTasks.map((t=>({description:"Cleaned",hkm_id:t.hkm_id===0?null:t.hkm_id,unit_id:t.unit.id,booking_nbr:t.booking_nbr})))});await this.fetchTasksWithFilters()}finally{this.selectedTasks=[];this.clearSelectedHkTasks.emit();this.modal.closeModal()}}async applyFilters(t){try{this.isApplyFiltersLoading=true;t.stopImmediatePropagation();t.stopPropagation();this.filters=Object.assign({},t.detail);await this.fetchTasksWithFilters()}catch(t){console.log(t)}finally{this.isApplyFiltersLoading=false}}async fetchTasksWithFilters(t=false){var i;const{cleaning_periods:s,housekeepers:e,cleaning_frequencies:a,dusty_units:o,highlight_check_ins:h}=(i=this.filters)!==null&&i!==void 0?i:{};const{tasks:n,url:l}=await this.houseKeepingService.getHkTasks({housekeepers:e,cleaning_frequency:a===null||a===void 0?void 0:a.code,dusty_window:o===null||o===void 0?void 0:o.code,highlight_window:h===null||h===void 0?void 0:h.code,property_id:this.property_id,from_date:C().format("YYYY-MM-DD"),to_date:(s===null||s===void 0?void 0:s.code)||C().format("YYYY-MM-DD"),is_export_to_excel:t});console.log(n);if(n){this.updateTasks(n)}return{tasks:n,url:l}}render(){if(this.isLoading){return s("ir-loading-screen",null)}return s(a,{"data-testid":"hk_tasks_base"},s("ir-toast",null),s("ir-interceptor",null),s("section",{class:"p-2 d-flex flex-column",style:{gap:"1rem"}},s("ir-tasks-header",{onHeaderButtonPress:this.handleHeaderButtonPress.bind(this),isCleanedEnabled:this.selectedTasks.length>0}),s("div",{class:"d-flex flex-column flex-md-row mt-1 ",style:{gap:"1rem"}},s("ir-tasks-filters",{isLoading:this.isApplyFiltersLoading,onApplyFilters:t=>{this.applyFilters(t)}}),s("ir-tasks-table",{onRowSelectChange:t=>{t.stopImmediatePropagation();t.stopPropagation();this.selectedTasks=t.detail},class:"flex-grow-1 w-100",tasks:this.tasks}))),s("ir-modal",{autoClose:false,ref:t=>this.modal=t,isLoading:x("/Execute_HK_Action"),onConfirmModal:this.handleModalConfirmation.bind(this),iconAvailable:true,icon:"ft-alert-triangle danger h1",leftBtnText:S.entries.Lcz_NO,rightBtnText:S.entries.Lcz_Yes,leftBtnColor:"secondary",rightBtnColor:"primary",modalTitle:S.entries.Lcz_Confirmation,modalBody:"Update selected unit(s) to Clean"}),s("ir-sidebar",{open:this.isSidebarOpen,id:"editGuestInfo",onIrSidebarToggle:t=>{t.stopImmediatePropagation();t.stopPropagation();this.isSidebarOpen=false},showCloseButton:false},this.isSidebarOpen&&s("ir-hk-archive",{ticket:this.token.getToken(),propertyId:this.property_id,slot:"sidebar-body"})))}get el(){return o(this)}static get watchers(){return{ticket:["ticketChanged"]}}};F.style=K;const V=".sc-ir-housekeeping-h{display:block}";const W=V;const J=class{constructor(s){t(this,s);this.toast=i(this,"toast",7);this.language="";this.ticket="";this.isLoading=false;this.roomService=new h;this.houseKeepingService=new R;this.token=new M}componentWillLoad(){if(this.ticket!==""){this.token.setToken(this.ticket);this.initializeApp()}}async handleResetData(t){t.stopImmediatePropagation();t.stopPropagation();await this.houseKeepingService.getExposedHKSetup(this.propertyid)}ticketChanged(t,i){if(t===i){return}this.token.setToken(this.ticket);this.initializeApp()}async initializeApp(){try{this.isLoading=true;let t=this.propertyid;if(!t){const i=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_sales_rate_plans:true});t=i.My_Result.id}B("default_properties",{token:this.ticket,property_id:t,language:this.language});const i=[];if(j.housekeeping_enabled){i.push(this.houseKeepingService.getExposedHKSetup(t))}i.push(this.roomService.fetchLanguage(this.language,["_HK_FRONT","_PMS_FRONT"]));if(this.propertyid){i.push(this.roomService.getExposedProperty({id:t,language:this.language,is_backend:true,include_sales_rate_plans:true}))}await Promise.all(i)}catch(t){console.error(t)}finally{this.isLoading=false}}saveAutomaticCheckInCheckout(t){t.stopImmediatePropagation();t.stopPropagation();try{this.roomService.SetAutomaticCheckInOut({property_id:this.propertyid,flag:t.detail==="auto"});this.toast.emit({position:"top-right",title:"Saved Successfully",description:"",type:"success"})}catch(t){console.log(t)}}render(){if(this.isLoading){return s("ir-loading-screen",null)}return s(a,null,s("ir-interceptor",null),s("ir-toast",null),s("section",{class:"p-1"},s("h3",{class:"mb-2"},S.entries.Lcz_HouseKeepingAndCheckInSetup),s("div",{class:"card p-1"},s("ir-title",{borderShown:true,label:"Check-In Mode"}),s("div",{class:"d-flex align-items-center"},s("p",{class:"my-0 py-0 mr-1  "},S.entries.Lcz_CheckInOutGuestsAutomatically),s("ir-select",{LabelAvailable:false,showFirstOption:false,selectedValue:j.is_automatic_check_in_out?"auto":"manual",onSelectChange:t=>this.saveAutomaticCheckInCheckout(t),data:[{text:S.entries.Lcz_YesAsPerPropertyPolicy,value:"auto"},{text:S.entries.Lcz_NoIWillDoItManually,value:"manual"}]}))),j.housekeeping_enabled&&s("ir-hk-team",{class:"mb-1"})))}static get watchers(){return{ticket:["ticketChanged"]}}};J.style=W;export{H as igloo_calendar,F as ir_hk_tasks,J as ir_housekeeping};
//# sourceMappingURL=p-c90d2b96.entry.js.map