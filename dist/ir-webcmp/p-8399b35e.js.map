{"version":3,"names":["initialState","bookings","filteredBookings","paginatedBookings","futureBookings","needsCheckInBookings","inHouseBookings","searchTerm","pagination","currentPage","pageSize","total","totalPages","showing","from","to","today","getTodayString","state","arrivalsStore","onChange","onArrivalsStoreChange","createStore","initializeArrivalsStore","Array","isArray","runArrivalsPipeline","setArrivalsSearchTerm","term","setArrivalsPage","page","safePage","clampPage","Math","max","calculateShowing","setArrivalsTotal","normalizedTotal","Number","isFinite","floor","calculateTotalPages","setArrivalsPageSize","normalizedPageSize","setArrivalsReferenceDate","date","moment","format","bookingsForToday","getBookingsForDate","searchedBookings","filterBookingsBySearch","split","splitBookingsByStatus","needsCheckIn","inHouse","futureRooms","normalizedTerm","trim","toLowerCase","filter","booking","matchesSearchTerm","bookingNumber","booking_nbr","includes","buildName","guest","rooms","some","room","reduce","acc","needsCheckInRooms","isNeedsCheckIn","length","push","inHouseRooms","isInHouse","futureCheckIns","isFutureCheckIn","unit","canCheckIn","from_date","to_date","isCheckedIn","in_out","code","startOf","isBefore","person","full","first_name","last_name","start","min","ceil","normalizedPage"],"sources":["src/stores/arrivals.store.ts"],"sourcesContent":["import { Booking, Room } from '@/models/booking.dto';\nimport { canCheckIn } from '@/utils/utils';\nimport { createStore } from '@stencil/store';\nimport moment from 'moment';\n\ninterface PaginationRange {\n  from: number;\n  to: number;\n}\n\nexport interface ArrivalsPagination {\n  currentPage: number;\n  pageSize: number;\n  total: number;\n  totalPages: number;\n  showing: PaginationRange;\n}\n\nexport interface ArrivalsStore {\n  bookings: Booking[];\n  filteredBookings: Booking[];\n  paginatedBookings: Booking[];\n  needsCheckInBookings: Booking[];\n  inHouseBookings: Booking[];\n  futureBookings: Booking[];\n  searchTerm: string;\n  pagination: ArrivalsPagination;\n  today: string;\n}\n\nconst initialState: ArrivalsStore = {\n  bookings: [],\n  filteredBookings: [],\n  paginatedBookings: [],\n  futureBookings: [],\n  needsCheckInBookings: [],\n  inHouseBookings: [],\n  searchTerm: '',\n  pagination: {\n    currentPage: 1,\n    pageSize: 20,\n    total: 0,\n    totalPages: 1,\n    showing: { from: 0, to: 0 },\n  },\n  today: getTodayString(),\n};\n\nexport const { state: arrivalsStore, onChange: onArrivalsStoreChange } = createStore<ArrivalsStore>(initialState);\n\nexport function initializeArrivalsStore(bookings: Booking[] = []) {\n  arrivalsStore.bookings = Array.isArray(bookings) ? [...bookings] : [];\n  runArrivalsPipeline();\n}\n\nexport function setArrivalsSearchTerm(term: string) {\n  arrivalsStore.searchTerm = term ?? '';\n  runArrivalsPipeline();\n}\n\nexport function setArrivalsPage(page: number) {\n  const safePage = clampPage(page, Math.max(arrivalsStore.pagination.totalPages, 1));\n  arrivalsStore.pagination = {\n    ...arrivalsStore.pagination,\n    currentPage: safePage,\n    showing: calculateShowing(safePage, arrivalsStore.pagination.pageSize, arrivalsStore.pagination.total),\n  };\n  runArrivalsPipeline();\n}\nexport function setArrivalsTotal(total: number) {\n  const normalizedTotal = Number.isFinite(total) && total > 0 ? Math.floor(total) : 0;\n  const totalPages = calculateTotalPages(normalizedTotal, arrivalsStore.pagination.pageSize);\n  const safePage = clampPage(arrivalsStore.pagination.currentPage, Math.max(totalPages, 1));\n  arrivalsStore.pagination = {\n    ...arrivalsStore.pagination,\n    total: normalizedTotal,\n    totalPages: Math.max(totalPages, 1),\n    currentPage: safePage,\n    showing: calculateShowing(safePage, arrivalsStore.pagination.pageSize, normalizedTotal),\n  };\n}\nexport function setArrivalsPageSize(pageSize: number) {\n  if (!Number.isFinite(pageSize) || pageSize <= 0) {\n    return;\n  }\n  const normalizedPageSize = Math.floor(pageSize);\n  arrivalsStore.pagination = {\n    ...arrivalsStore.pagination,\n    pageSize: normalizedPageSize,\n    currentPage: 1,\n    showing: calculateShowing(1, normalizedPageSize, arrivalsStore.pagination.total),\n  };\n  runArrivalsPipeline();\n}\n\nexport function setArrivalsReferenceDate(date: string) {\n  arrivalsStore.today = moment(date, 'YYYY-MM-DD').format('YYYY-MM-DD');\n  arrivalsStore.pagination = {\n    ...arrivalsStore.pagination,\n    currentPage: 1,\n    showing: calculateShowing(1, arrivalsStore.pagination.pageSize, arrivalsStore.pagination.total),\n  };\n  runArrivalsPipeline();\n}\n\nfunction runArrivalsPipeline() {\n  const bookingsForToday = getBookingsForDate(arrivalsStore.bookings, arrivalsStore.today);\n  const searchedBookings = filterBookingsBySearch(bookingsForToday, arrivalsStore.searchTerm);\n\n  arrivalsStore.filteredBookings = searchedBookings;\n  arrivalsStore.paginatedBookings = searchedBookings;\n  const split = splitBookingsByStatus(searchedBookings);\n  arrivalsStore.needsCheckInBookings = split.needsCheckIn;\n  arrivalsStore.inHouseBookings = split.inHouse;\n  arrivalsStore.futureBookings = split.futureRooms;\n}\n\nfunction getBookingsForDate(bookings: Booking[], date: string) {\n  if (!date) {\n    return [];\n  }\n  return bookings;\n}\n\nfunction filterBookingsBySearch(bookings: Booking[], term: string) {\n  const normalizedTerm = term?.trim().toLowerCase();\n  if (!normalizedTerm) {\n    return bookings;\n  }\n  return bookings.filter(booking => matchesSearchTerm(booking, normalizedTerm));\n}\n\nfunction matchesSearchTerm(booking: Booking, term: string) {\n  if (!term) {\n    return true;\n  }\n  const bookingNumber = booking.booking_nbr?.toLowerCase() ?? '';\n  if (bookingNumber.includes(term)) {\n    return true;\n  }\n  if (buildName(booking.guest).includes(term)) {\n    return true;\n  }\n  return (booking.rooms ?? []).some(room => buildName(room.guest).includes(term));\n}\n\nfunction splitBookingsByStatus(bookings: Booking[]) {\n  return bookings.reduce(\n    (acc, booking) => {\n      const rooms = booking.rooms ?? [];\n      const needsCheckInRooms = rooms.filter(room => isNeedsCheckIn(room));\n      if (needsCheckInRooms.length) {\n        acc.needsCheckIn.push({ ...booking, rooms: needsCheckInRooms });\n      }\n      const inHouseRooms = rooms.filter(room => isInHouse(room));\n      if (inHouseRooms.length) {\n        acc.inHouse.push({ ...booking, rooms: inHouseRooms });\n      }\n      const futureCheckIns = rooms.filter(room => isFutureCheckIn(room));\n      if (futureCheckIns.length) {\n        acc.futureRooms.push({ ...booking, rooms: futureCheckIns });\n      }\n      return acc;\n    },\n    { needsCheckIn: [] as Booking[], inHouse: [] as Booking[], futureRooms: [] as Booking[] },\n  );\n}\n\nfunction isNeedsCheckIn(room: Room) {\n  if (!room.unit) {\n    return false;\n  }\n  return canCheckIn({\n    from_date: room.from_date,\n    to_date: room.to_date,\n    isCheckedIn: room.in_out.code === '001',\n  });\n}\n\nfunction isFutureCheckIn(room: Room) {\n  const code = room.in_out?.code ?? '';\n  return code === '000' && moment().startOf('date').isBefore(moment(room.from_date, 'YYYY-MM-DD').startOf('day'));\n}\n\nfunction isInHouse(room: Room) {\n  return room.in_out?.code === '001';\n}\n\nfunction buildName(person?: { first_name?: string | null; last_name?: string | null } | null) {\n  const full = `${person?.first_name ?? ''} ${person?.last_name ?? ''}`.trim();\n  return full.toLowerCase();\n}\n\nfunction getTodayString() {\n  return moment().format('YYYY-MM-DD');\n}\n\nfunction calculateShowing(page: number, pageSize: number, total: number): PaginationRange {\n  if (!total || !pageSize) {\n    return { from: 0, to: 0 };\n  }\n  const start = (page - 1) * pageSize + 1;\n  return {\n    from: Math.max(start, 1),\n    to: Math.min(start + pageSize - 1, total),\n  };\n}\n\nfunction calculateTotalPages(total: number, pageSize: number) {\n  if (!total || !pageSize) {\n    return 0;\n  }\n  return Math.ceil(total / pageSize);\n}\n\nfunction clampPage(page: number, totalPages: number) {\n  if (!Number.isFinite(page) || page <= 0) {\n    return 1;\n  }\n  const normalizedPage = Math.floor(page);\n  return Math.min(Math.max(normalizedPage, 1), Math.max(totalPages, 1));\n}\n\ninitializeArrivalsStore();\n"],"mappings":"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","ignoreList":[]}