import{r as t,c as i,h as e,H as s}from"./p-53d64953.js";import{T as r}from"./p-a93581f3.js";import{B as o,b as a}from"./p-2b01cc1d.js";import{P as n}from"./p-3ac66401.js";import{R as l}from"./p-429a4d65.js";import{l as h}from"./p-71768c2d.js";import{h as d}from"./p-6c4ba7c0.js";import{v as u}from"./p-4ed69de7.js";import"./p-bf44a732.js";import"./p-61aaf60c.js";import"./p-b859bcd5.js";import"./p-00df8713.js";import"./p-a973aec7.js";const c=".sc-ir-daily-revenue-h{display:block}.daily-revenue__meta.sc-ir-daily-revenue{display:flex;flex-direction:column;gap:1rem}.daily-revenue__table.sc-ir-daily-revenue{flex:1 1 0%}@media (min-width: 768px){.daily-revenue__meta.sc-ir-daily-revenue{flex-direction:row}}";const p=c;const m=class{constructor(e){t(this,e);this.preventPageLoad=i(this,"preventPageLoad",7);this.language="";this.ticket="";this.filters={date:d().format("YYYY-MM-DD"),users:null};this.tokenService=new r;this.roomService=new l;this.propertyService=new n;this.bookingService=new o;this.handleSidebarClose=t=>{t.stopImmediatePropagation();t.stopPropagation();this.sideBarEvent=null}}componentWillLoad(){if(this.ticket){this.tokenService.setToken(this.ticket);this.initializeApp()}}ticketChanged(t,i){if(t===i){return}this.tokenService.setToken(this.ticket);this.initializeApp()}handleOpenSidebar(t){t.stopImmediatePropagation();t.stopPropagation();this.sideBarEvent=t.detail}handleFetchNewReports(t){t.stopImmediatePropagation();t.stopPropagation();this.filters=Object.assign({},t.detail);this.getPaymentReports()}renderSidebarBody(){if(!this.sideBarEvent){return}switch(this.sideBarEvent.type){case"booking":return e("ir-booking-details",{slot:"sidebar-body",hasPrint:true,hasReceipt:true,hasCloseButton:true,onCloseSidebar:this.handleSidebarClose,is_from_front_desk:true,propertyid:this.property_id,hasRoomEdit:true,hasRoomDelete:true,bookingNumber:this.sideBarEvent.payload.bookingNumber.toString(),ticket:this.ticket,language:this.language,hasRoomAdd:true});default:return null}}async initializeApp(){this.isPageLoading=true;try{let t=this.propertyid;if(!t&&!this.p){throw new Error("Property ID or username is required")}if(!t){const i=await this.roomService.getExposedProperty({id:0,aname:this.p,language:this.language,is_backend:true,include_units_hk_status:true});t=i.My_Result.id}this.property_id=t;const i=[this.bookingService.getSetupEntriesByTableNameMulti(["_PAY_TYPE","_PAY_TYPE_GROUP"]),this.getPaymentReports(),this.roomService.fetchLanguage(this.language)];if(t){i.push(this.roomService.getExposedProperty({id:t,language:this.language,is_backend:true,include_units_hk_status:true}))}const[e]=await Promise.all(i);const{pay_type:s,pay_type_group:r}=this.bookingService.groupEntryTablesResult(e);this.payTypes=s;this.payTypeGroup=a(s,r)["PAYMENTS"]}catch(t){console.log(t)}finally{this.isPageLoading=false}}groupPaymentsByName(t){var i;const e=new Map;for(const s of t){const t=(i=e.get(s.payTypeCode))!==null&&i!==void 0?i:[];e.set(s.payTypeCode,[...t,s])}return new Map([...e.entries()].sort((([t],[i])=>{const e=Number(t);const s=Number(i);if(!isNaN(e)&&!isNaN(s)){return e-s}return t.localeCompare(i)})))}async getPaymentReports(t=false){var i,e,s,r;try{const o=t=>({method:t.METHOD,payTypeCode:t.PAY_TYPE_CODE,amount:t.AMOUNT,date:t.DATE,hour:t.HOUR,minute:t.MINUTE,user:t.USER,currency:t.CURRENCY,bookingNbr:t.BOOKING_NBR,id:u()});this.isLoading=t?"export":"filter";const a=[this.propertyService.getDailyRevenueReport({date:this.filters.date,property_id:(i=this.property_id)===null||i===void 0?void 0:i.toString(),is_export_to_excel:t})];if(!t){a.push(this.propertyService.getDailyRevenueReport({date:d(this.filters.date,"YYYY-MM-DD").add(-1,"days").format("YYYY-MM-DD"),property_id:(e=this.property_id)===null||e===void 0?void 0:e.toString(),is_export_to_excel:t}))}const n=await Promise.all(a);if(!t){if(n[0]){this.groupedPayment=this.groupPaymentsByName((s=n[0])===null||s===void 0?void 0:s.map(o))}else{this.groupedPayment=new Map}if(n[1])this.previousDateGroupedPayments=this.groupPaymentsByName((r=n[1])===null||r===void 0?void 0:r.map(o))}}catch(t){console.log(t)}finally{this.isLoading=null}}render(){var t,i,r;if(this.isPageLoading){return e("ir-loading-screen",null)}return e(s,null,e("ir-toast",null),e("ir-interceptor",null),e("section",{class:"p-2 d-flex flex-column",style:{gap:"1rem"}},e("div",{class:"d-flex align-items-center justify-content-between"},e("h3",{class:"mb-1 mb-md-0"},"Daily Revenue"),e("ir-button",{size:"sm",btn_color:"outline",isLoading:this.isLoading==="export",text:(t=h.entries)===null||t===void 0?void 0:t.Lcz_Export,onClickHandler:async t=>{t.stopImmediatePropagation();t.stopPropagation();await this.getPaymentReports(true)},btnStyle:{height:"100%"},iconPosition:"right",icon_name:"file",icon_style:{"--icon-size":"14px"}})),e("ir-revenue-summary",{previousDateGroupedPayments:this.previousDateGroupedPayments,groupedPayments:this.groupedPayment,payTypesGroup:this.payTypeGroup}),e("div",{class:"daily-revenue__meta"},e("ir-daily-revenue-filters",{isLoading:this.isLoading==="filter",payments:this.groupedPayment}),e("ir-revenue-table",{filters:this.filters,class:"daily-revenue__table",payTypes:this.payTypes,payments:this.groupedPayment}))),e("ir-sidebar",{sidebarStyles:{width:((i=this.sideBarEvent)===null||i===void 0?void 0:i.type)==="booking"?"80rem":"var(--sidebar-width,40rem)",background:((r=this.sideBarEvent)===null||r===void 0?void 0:r.type)==="booking"?"#F2F3F8":"white"},open:Boolean(this.sideBarEvent),showCloseButton:false,onIrSidebarToggle:this.handleSidebarClose},this.renderSidebarBody()))}static get watchers(){return{ticket:["ticketChanged"]}}};m.style=p;export{m as ir_daily_revenue};
//# sourceMappingURL=p-d4856aff.entry.js.map