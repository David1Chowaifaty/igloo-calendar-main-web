{"version":3,"names":["irUserFormPanelCss","IrUserFormPanelStyle0","sheetCss","IrUserFormPanelStyle1","IrUserFormPanel","constructor","hostRef","this","isEdit","language","isLoading","autoValidate","userInfo","id","is_active","last_signed_in","created_at","mobile","name","note","password","email","property_id","username","phone_prefix","errors","showPasswordValidation","housekeepingService","HouseKeepingService","disableFields","mobileMask","userSchema","z","object","string","min","max","nullable","refine","user","_a","CONSTANTS","PASSWORD","test","message","async","length","UserService","checkUserExistence","UserName","componentWillLoad","Object","assign","isSuperAdmin","mask","calendar_data","country","lazy","autofix","placeholderChar","updateUserField","key","value","addUser","toValidateUserInfo","console","log","parseAsync","editExposedHKM","resetData","emit","closeSideBar","error","e","ZodError","issues","map","err","path","handleBlur","stopImmediatePropagation","stopPropagation","usermame","generateUserName","render","h","class","onSubmit","preventDefault","displayContext","label","testId","zod","pick","wrapKey","locales","entries","Lcz_Email","placeholder","onTextChange","detail","onInputBlur","bind","maxLength","disabled","_b","asyncParse","_c","data","text","selectedValue","role","onSelectChange","_d","_e","type","_f","onInputFocus","onClickHandler","btn_styles","btn_color","Lcz_Cancel","btn_type","Lcz_Save"],"sources":["src/components/ir-user-management/ir-user-form-panel/ir-user-form-panel.css?tag=ir-user-form-panel&encapsulation=scoped","src/common/sheet.css?tag=ir-user-form-panel&encapsulation=scoped","src/components/ir-user-management/ir-user-form-panel/ir-user-form-panel.tsx"],"sourcesContent":["\n",":host {\n  height: 100%;\n}\n.sheet-container {\n  display: flex !important;\n  flex-direction: column !important;\n  background: white;\n  height: 100% !important;\n  gap: 1rem;\n}\n.sheet-footer {\n  position: sticky;\n  bottom: 0;\n  z-index: 20;\n  background: white;\n  border-top: 1px solid #e4e5ec;\n  display: flex;\n  flex-direction: column;\n  padding: 1rem;\n  gap: 0.5rem;\n}\n.sheet-header {\n  position: sticky;\n  top: 0;\n  z-index: 10;\n  background: white;\n}\n.sheet-body {\n  flex: 1 1 0%;\n}\n@media (min-width: 768px) {\n  .sheet-footer {\n    flex-direction: row;\n    align-items: center;\n  }\n}\n","import { Component, Event, EventEmitter, Prop, State, h } from '@stencil/core';\nimport { User } from '../types';\nimport locales from '@/stores/locales.store';\nimport { z, ZodError } from 'zod';\nimport { HouseKeepingService } from '@/services/housekeeping.service';\nimport { CONSTANTS } from '@/utils/constants';\nimport { UserService } from '@/services/user.service';\nimport calendar_data from '@/stores/calendar-data';\n\n@Component({\n  tag: 'ir-user-form-panel',\n  styleUrls: ['ir-user-form-panel.css', '../../../common/sheet.css'],\n  scoped: true,\n})\nexport class IrUserFormPanel {\n  @Prop() user: User;\n  @Prop() isEdit: boolean = false;\n  @Prop() language: string = 'en';\n  @Prop() property_id: number;\n  @Prop() isSuperAdmin: boolean;\n\n  @State() isLoading: boolean = false;\n  @State() autoValidate = false;\n\n  @State() userInfo: User = {\n    id: -1,\n    is_active: false,\n    last_signed_in: '',\n    created_at: '',\n    mobile: '',\n    name: '',\n    note: '',\n    password: '',\n    email: '',\n    property_id: null,\n    username: null,\n    phone_prefix: null,\n  };\n\n  @State() errors: { [P in keyof User]?: any } | null = null;\n  @State() showPasswordValidation: boolean = false;\n  @State() isUsernameTaken: boolean;\n\n  @Event() resetData: EventEmitter<null>;\n  @Event() closeSideBar: EventEmitter<null>;\n\n  private housekeepingService = new HouseKeepingService();\n  private disableFields = false;\n  private mobileMask = {};\n  private userSchema = z.object({\n    name: z.string().min(2),\n    mobile: z.string().min(1).max(14),\n    email: z.string().email(),\n    password: z\n      .string()\n      .nullable()\n      // .regex(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[!@#$%^&*()\\-_=+]).{8,16}$/)\n      .refine(\n        password => {\n          if (this.user && !this.userInfo?.password) {\n            return true;\n          }\n          return CONSTANTS.PASSWORD.test(password);\n        },\n        { message: 'Password must be at least 8 characters long.' },\n      ),\n    username: z\n      .string()\n      .min(3)\n      .refine(\n        async name => {\n          if (this.user && this.user.username === name) {\n            return true;\n          }\n          if (name.length >= 3) {\n            return !(await new UserService().checkUserExistence({ UserName: name }));\n          }\n          return true;\n        },\n        { message: 'Username already exists.' },\n      ),\n  });\n\n  async componentWillLoad() {\n    if (!this.user) {\n      this.userInfo['property_id'] = this.property_id;\n      // this.showPasswordValidation = true;\n    }\n    if (this.user) {\n      this.autoValidate = true;\n      this.userInfo = { ...this.user, password: '' };\n      this.disableFields = this.isSuperAdmin;\n    }\n    this.mobileMask = {\n      mask: `{${calendar_data.country.phone_prefix}} 000000000000`,\n      lazy: false,\n      autofix: true,\n      placeholderChar: '\\u200B',\n    };\n  }\n\n  private updateUserField(key: keyof User, value: any) {\n    this.userInfo = { ...this.userInfo, [key]: value };\n  }\n\n  private async addUser() {\n    try {\n      this.isLoading = true;\n      if (!this.autoValidate) {\n        this.autoValidate = true;\n      }\n      const toValidateUserInfo = { ...this.userInfo, password: this.user && this.userInfo.password === '' ? this.user.password : this.userInfo.password };\n      console.log('toValidateUserInfo', toValidateUserInfo);\n      await this.userSchema.parseAsync(toValidateUserInfo);\n      if (this.errors) {\n        this.errors = null;\n      }\n      await this.housekeepingService.editExposedHKM(toValidateUserInfo);\n      this.resetData.emit(null);\n      this.closeSideBar.emit(null);\n    } catch (error) {\n      const e: any = {};\n      if (error instanceof ZodError) {\n        error.issues.map(err => {\n          e[err.path[0]] = true;\n        });\n        this.errors = e;\n      }\n      console.error(error);\n    } finally {\n      this.isLoading = false;\n    }\n  }\n  private async handleBlur(e: CustomEvent) {\n    e.stopImmediatePropagation();\n    e.stopPropagation();\n    if (this.user || !this.userInfo.name) {\n      return;\n    }\n    const usermame = await this.housekeepingService.generateUserName(this.userInfo.name);\n    this.updateUserField('username', usermame);\n  }\n\n  render() {\n    return (\n      <form\n        class=\"sheet-container\"\n        onSubmit={async e => {\n          e.preventDefault();\n          await this.addUser();\n        }}\n      >\n        <ir-title class=\"px-1 sheet-header\" displayContext=\"sidebar\" label={this.isEdit ? 'Edit User' : 'Create New User'}></ir-title>\n        <section class=\"px-1 sheet-body\">\n          <ir-input-text\n            testId=\"email\"\n            zod={this.userSchema.pick({ email: true })}\n            wrapKey=\"email\"\n            autoValidate={this.autoValidate}\n            error={this.errors?.email}\n            label={locales.entries.Lcz_Email}\n            placeholder=\"\"\n            onTextChange={e => this.updateUserField('email', e.detail)}\n            value={this.userInfo.email}\n            onInputBlur={this.handleBlur.bind(this)}\n            maxLength={40}\n          />\n          <ir-input-text\n            testId=\"mobile\"\n            disabled={this.disableFields}\n            zod={this.userSchema.pick({ mobile: true })}\n            wrapKey=\"mobile\"\n            error={this.errors?.mobile}\n            asyncParse\n            autoValidate={this.user ? (this.userInfo?.mobile !== this.user.mobile ? true : false) : this.autoValidate}\n            label=\"Mobile\"\n            mask={this.mobileMask}\n            placeholder={''}\n            value={this.userInfo.mobile}\n            onTextChange={e => this.updateUserField('mobile', e.detail)}\n          />\n          <div class=\"mb-1\">\n            <ir-select\n              disabled={this.disableFields}\n              label=\"Role\"\n              data={[\n                { text: 'Admin', value: '1' },\n                { text: 'Frontdesk', value: '2' },\n              ]}\n              selectedValue={this.userInfo.role}\n              onSelectChange={e => this.updateUserField('role', e.detail)}\n            />\n          </div>\n          <ir-input-text\n            testId=\"name\"\n            zod={this.userSchema.pick({ name: true })}\n            wrapKey=\"name\"\n            autoValidate={this.autoValidate}\n            error={this.errors?.name}\n            label=\"Username\"\n            disabled={this.disableFields}\n            placeholder=\"\"\n            onTextChange={e => this.updateUserField('name', e.detail)}\n            value={this.userInfo.name}\n            onInputBlur={this.handleBlur.bind(this)}\n            maxLength={40}\n          />\n          <ir-input-text\n            testId=\"password\"\n            autoValidate={this.user ? (!this.userInfo?.password ? false : true) : this.autoValidate}\n            label={'Password'}\n            value={this.userInfo.password}\n            type=\"password\"\n            maxLength={16}\n            zod={this.userSchema.pick({ password: true })}\n            wrapKey=\"password\"\n            error={this.errors?.password}\n            onInputFocus={() => (this.showPasswordValidation = true)}\n            onInputBlur={() => {\n              // if (this.user) this.showPasswordValidation = false;\n            }}\n            onTextChange={e => this.updateUserField('password', e.detail)}\n          ></ir-input-text>\n          {this.showPasswordValidation && <ir-password-validator class=\"mb-1\" password={this.userInfo.password}></ir-password-validator>}\n        </section>\n        <div class=\"sheet-footer\">\n          <ir-button\n            data-testid=\"cancel\"\n            onClickHandler={() => this.closeSideBar.emit(null)}\n            class=\"flex-fill\"\n            btn_styles=\"w-100 justify-content-center align-items-center\"\n            btn_color=\"secondary\"\n            text={locales.entries.Lcz_Cancel}\n          ></ir-button>\n          <ir-button\n            data-testid=\"save\"\n            isLoading={this.isLoading}\n            class=\"flex-fill\"\n            btn_type=\"submit\"\n            btn_styles=\"w-100 justify-content-center align-items-center\"\n            text={locales.entries.Lcz_Save}\n          ></ir-button>\n        </div>\n      </form>\n    );\n  }\n}\n"],"mappings":"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","ignoreList":[]}