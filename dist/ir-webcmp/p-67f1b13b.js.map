{"version":3,"names":["initialState","bookings","filteredBookings","paginatedBookings","needsCheckOutBookings","outBookings","searchTerm","pagination","page","pageSize","total","totalPages","today","getTodayString","state","departuresStore","onChange","onDeparturesStoreChange","createStore","initializeDeparturesStore","arrivalsMockData","Array","isArray","runDeparturesPipeline","setDeparturesSearchTerm","term","bookingsForToday","getBookingsForDate","searchedBookings","filterBookingsBySearch","length","Math","ceil","safePage","clamp","start","paginated","slice","split","splitBookingsByStatus","needsCheckOut","out","date","map","booking","roomsForToday","rooms","filter","room","normalizeDate","to_date","Boolean","normalizedTerm","trim","toLowerCase","matchesSearchTerm","bookingNumber","booking_nbr","includes","buildName","guest","some","reduce","acc","needsCheckoutRooms","isNeedsCheckOut","push","isOutRooms","isOut","code","in_out","person","full","first_name","last_name","moment","format","value","min","max"],"sources":["src/stores/departures.store.ts"],"sourcesContent":["import { Booking, Room } from '@/models/booking.dto';\nimport { createStore } from '@stencil/store';\nimport { data as arrivalsMockData } from '@/components/ir-arrivals/_data';\nimport moment from 'moment';\n\nexport interface DeparturesPagination {\n  page: number;\n  pageSize: number;\n  total: number;\n  totalPages: number;\n}\n\nexport interface DeparturesStore {\n  bookings: Booking[];\n  filteredBookings: Booking[];\n  paginatedBookings: Booking[];\n  needsCheckOutBookings: Booking[];\n  outBookings: Booking[];\n  searchTerm: string;\n  pagination: DeparturesPagination;\n  today: string;\n}\n\nconst initialState: DeparturesStore = {\n  bookings: [],\n  filteredBookings: [],\n  paginatedBookings: [],\n  needsCheckOutBookings: [],\n  outBookings: [],\n  searchTerm: '',\n  pagination: {\n    page: 1,\n    pageSize: 20,\n    total: 0,\n    totalPages: 1,\n  },\n  today: getTodayString(),\n};\n\nexport const { state: departuresStore, onChange: onDeparturesStoreChange } = createStore<DeparturesStore>(initialState);\n\nexport function initializeDeparturesStore(bookings: Booking[] = arrivalsMockData as any[]) {\n  departuresStore.bookings = Array.isArray(bookings) ? [...bookings] : [];\n  runDeparturesPipeline();\n}\n\nexport function setDeparturesSearchTerm(term: string) {\n  departuresStore.searchTerm = term ?? '';\n  runDeparturesPipeline();\n}\n\nexport function setDeparturesPage(page: number) {\n  const safePage = Number.isFinite(page) && page > 0 ? Math.floor(page) : 1;\n  departuresStore.pagination = { ...departuresStore.pagination, page: safePage };\n  runDeparturesPipeline();\n}\n\nexport function setDeparturesPageSize(pageSize: number) {\n  if (!Number.isFinite(pageSize) || pageSize <= 0) {\n    return;\n  }\n  departuresStore.pagination = { ...departuresStore.pagination, pageSize: Math.floor(pageSize), page: 1 };\n  runDeparturesPipeline();\n}\n\nexport function setDeparturesReferenceDate(date: string | Date) {\n  departuresStore.today = moment(date, 'YYYY-MM-DD').format('YYYY-MM-DD');\n  runDeparturesPipeline();\n}\n\nfunction runDeparturesPipeline() {\n  const bookingsForToday = getBookingsForDate(departuresStore.bookings, departuresStore.today);\n  const searchedBookings = filterBookingsBySearch(bookingsForToday, departuresStore.searchTerm);\n\n  const total = searchedBookings.length;\n  const { pageSize } = departuresStore.pagination;\n  const totalPages = total === 0 ? 1 : Math.ceil(total / pageSize);\n  const safePage = clamp(departuresStore.pagination.page, 1, totalPages);\n  const start = (safePage - 1) * pageSize;\n  const paginated = searchedBookings.slice(start, start + pageSize);\n\n  departuresStore.filteredBookings = searchedBookings;\n  departuresStore.pagination = { ...departuresStore.pagination, total, totalPages, page: safePage };\n  departuresStore.paginatedBookings = paginated;\n\n  const split = splitBookingsByStatus(paginated);\n  departuresStore.needsCheckOutBookings = split.needsCheckOut;\n  departuresStore.outBookings = split.out;\n}\n\nfunction getBookingsForDate(bookings: Booking[], date: string) {\n  if (!date) {\n    return [];\n  }\n  return bookings\n    .map(booking => {\n      const roomsForToday = (booking.rooms ?? []).filter(room => normalizeDate(room.to_date) === date);\n      if (!roomsForToday.length) {\n        return null;\n      }\n      return { ...booking, rooms: roomsForToday };\n    })\n    .filter((booking): booking is Booking => Boolean(booking));\n}\n\nfunction filterBookingsBySearch(bookings: Booking[], term: string) {\n  const normalizedTerm = term?.trim().toLowerCase();\n  if (!normalizedTerm) {\n    return bookings;\n  }\n  return bookings.filter(booking => matchesSearchTerm(booking, normalizedTerm));\n}\n\nfunction matchesSearchTerm(booking: Booking, term: string) {\n  if (!term) {\n    return true;\n  }\n  const bookingNumber = booking.booking_nbr?.toLowerCase() ?? '';\n  if (bookingNumber.includes(term)) {\n    return true;\n  }\n  if (buildName(booking.guest).includes(term)) {\n    return true;\n  }\n  return (booking.rooms ?? []).some(room => buildName(room.guest).includes(term));\n}\n\nfunction splitBookingsByStatus(bookings: Booking[]) {\n  return bookings.reduce(\n    (acc, booking) => {\n      const rooms = booking.rooms ?? [];\n      const needsCheckoutRooms = rooms.filter(room => isNeedsCheckOut(room));\n      if (needsCheckoutRooms.length) {\n        acc.needsCheckOut.push({ ...booking, rooms: needsCheckoutRooms });\n      }\n      const isOutRooms = rooms.filter(room => isOut(room));\n      if (isOutRooms.length) {\n        acc.out.push({ ...booking, rooms: isOutRooms });\n      }\n      return acc;\n    },\n    { needsCheckOut: [] as Booking[], out: [] as Booking[] },\n  );\n}\n\nfunction isNeedsCheckOut(room: Room) {\n  const code = room.in_out?.code ?? '';\n  return code === '001';\n}\n\nfunction isOut(room: Room) {\n  return room.in_out?.code === '002';\n}\n\nfunction buildName(person?: { first_name?: string | null; last_name?: string | null } | null) {\n  const full = `${person?.first_name ?? ''} ${person?.last_name ?? ''}`.trim();\n  return full.toLowerCase();\n}\n\nfunction getTodayString() {\n  return moment().format('YYYY-MM-DD');\n}\n\nfunction normalizeDate(value?: string | null) {\n  if (!value) {\n    return '';\n  }\n  return value.slice(0, 10);\n}\n\nfunction clamp(value: number, min: number, max: number) {\n  return Math.min(Math.max(value, min), max);\n}\n\ninitializeDeparturesStore();\n"],"mappings":"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","ignoreList":[]}