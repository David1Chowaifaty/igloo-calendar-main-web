{"file":"ir-sales-by-channel2.js","mappings":";;;;;;;;;;;;;;;;;;;;;;;AAAA,MAAM,mBAAmB,GAAG,0CAA0C,CAAC;AACvE,+BAAe,mBAAmB;;;;;;;;;;;;;;MCWrB,gBAAgB;IAL7B;;;QAMU,aAAQ,GAAW,EAAE,CAAC;QACtB,WAAM,GAAW,EAAE,CAAC;QAGnB,cAAS,GAA+B,IAAI,CAAC;QAC7C,kBAAa,GAAG,IAAI,CAAC;QAMtB,UAAK,GAAG,IAAI,KAAK,EAAE,CAAC;QACpB,gBAAW,GAAG,IAAI,WAAW,EAAE,CAAC;QAChC,oBAAe,GAAG,IAAI,eAAe,EAAE,CAAC;QAExC,gBAAW,GAAsB;YACvC,SAAS,EAAEA,KAAM,EAAE,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,MAAM,CAAC,CAAC,MAAM,CAAC,YAAY,CAAC;YACxD,OAAO,EAAEA,KAAM,EAAE,CAAC,MAAM,CAAC,YAAY,CAAC;YACtC,SAAS,EAAE,KAAK;YAChB,MAAM,EAAE,CAAC;YACT,qBAAqB,EAAE,KAAK;SAC7B,CAAC;KAmJH;IAjJC,iBAAiB;QACf,IAAI,CAAC,mBAAmB,GAAG,IAAI,CAAC,WAAW,CAAC;QAC5C,IAAI,IAAI,CAAC,MAAM,EAAE;YACf,IAAI,CAAC,KAAK,CAAC,QAAQ,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;YACjC,IAAI,CAAC,aAAa,EAAE,CAAC;SACtB;KACF;IAGD,aAAa,CAAC,QAAgB,EAAE,QAAgB;QAC9C,IAAI,QAAQ,KAAK,QAAQ,EAAE;YACzB,OAAO;SACR;QACD,IAAI,CAAC,KAAK,CAAC,QAAQ,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;QACjC,IAAI,CAAC,aAAa,EAAE,CAAC;KACtB;IAEO,MAAM,aAAa;QACzB,IAAI;YACF,MAAM,QAAQ,GAAG,CAAC,IAAI,CAAC,eAAe,CAAC,2BAA2B,EAAE,EAAE,IAAI,CAAC,WAAW,CAAC,aAAa,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC;YACrH,MAAM,CAAC,UAAU,CAAC,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;YACjD,IAAI,CAAC,iBAAiB,GAAG,CAAC,GAAI,UAAkB,CAAC,CAAC;YAElD,IAAI,CAAC,WAAW,mCAAQ,IAAI,CAAC,WAAW,KAAE,UAAU,EAAE,IAAI,CAAC,iBAAiB,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,CAAC,EAAE,CAAC,GAAE,CAAC;YAC9F,IAAI,CAAC,mBAAmB,qBAAQ,IAAI,CAAC,WAAW,CAAE,CAAC;YAEnD,MAAM,IAAI,CAAC,eAAe,EAAE,CAAC;SAC9B;QAAC,OAAO,KAAK,EAAE;YACd,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;SACpB;gBAAS;YACR,IAAI,CAAC,aAAa,GAAG,KAAK,CAAC;SAC5B;KACF;IAEO,MAAM,eAAe,CAAC,eAAe,GAAG,KAAK;QACnD,IAAI;YACF,MAAM,KAA6C,IAAI,CAAC,mBAAmB,EAArE,EAAE,qBAAqB,OAA8C,EAAzC,YAAY,cAAxC,yBAA0C,CAA2B,CAAC;YAC5E,IAAI,CAAC,SAAS,GAAG,eAAe,GAAG,QAAQ,GAAG,QAAQ,CAAC;YACvD,MAAM,YAAY,GAAG,MAAM,IAAI,CAAC,eAAe,CAAC,eAAe;;gBAE7D,kBAAkB,EAAE,eAAe;eAChC,YAAY,EACf,CAAC;YACH,MAAM,uBAAuB,GAAG,CAAC,eAAe,IAAI,qBAAqB,CAAC;YAC1E,IAAI,aAAa,GAAwB,EAAE,CAAC;YAC5C,IAAI,uBAAuB,EAAE;gBAC3B,MAAM,iBAAiB,GAAG,MAAM,IAAI,CAAC,eAAe,CAAC,eAAe;;oBAElE,kBAAkB,EAAE,eAAe;mBAChC,YAAY,KACf,SAAS,EAAEA,KAAM,CAAC,YAAY,CAAC,SAAS,CAAC,CAAC,QAAQ,CAAC,CAAC,EAAE,MAAM,CAAC,CAAC,MAAM,CAAC,YAAY,CAAC,EAClF,OAAO,EAAEA,KAAM,CAAC,YAAY,CAAC,OAAO,CAAC,CAAC,QAAQ,CAAC,CAAC,EAAE,MAAM,CAAC,CAAC,MAAM,CAAC,YAAY,CAAC,IAC9E,CAAC;gBAEH,aAAa,GAAG,YAAY,CAAC,GAAG,CAAC,OAAO;oBACtC,MAAM,QAAQ,GAAG,iBAAiB,CAAC,IAAI,CAAC,IAAI,IAAI,IAAI,CAAC,MAAM,CAAC,WAAW,EAAE,KAAK,OAAO,CAAC,MAAM,CAAC,WAAW,EAAE,CAAC,CAAC;oBAC5G,uCACK,OAAO,KACV,SAAS,EAAE,QAAQ,GAAG,QAAQ,GAAG,IAAI,IACrC;iBACH,CAAC,CAAC;aACJ;iBAAM;gBACL,aAAa,GAAG,YAAY,CAAC,GAAG,CAAC,MAAM,qCAClC,MAAM,KACT,SAAS,EAAE,IAAI,IACf,CAAC,CAAC;aACL;;YAED,MAAM,gBAAgB,GAA2B,aAAa,CAAC,MAAM,CAAC,CAAC,GAAG,EAAE,CAAC;;gBAC3E,GAAG,CAAC,CAAC,CAAC,WAAW,CAAC,GAAG,CAAC,MAAA,GAAG,CAAC,CAAC,CAAC,WAAW,CAAC,mCAAI,CAAC,IAAI,CAAC,CAAC,OAAO,CAAC;gBAC3D,OAAO,GAAG,CAAC;aACZ,EAAE,EAA4B,CAAC,CAAC;YAEjC,aAAa,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC;;gBACtB,MAAM,EAAE,GAAG,MAAA,gBAAgB,CAAC,CAAC,CAAC,WAAW,CAAC,mCAAI,CAAC,CAAC;gBAChD,MAAM,EAAE,GAAG,MAAA,gBAAgB,CAAC,CAAC,CAAC,WAAW,CAAC,mCAAI,CAAC,CAAC;;gBAGhD,IAAI,EAAE,KAAK,EAAE;oBAAE,OAAO,EAAE,GAAG,EAAE,CAAC;;;gBAI9B,IAAI,CAAC,CAAC,WAAW,KAAK,CAAC,CAAC,WAAW,EAAE;oBACnC,IAAI,CAAC,CAAC,OAAO,KAAK,CAAC,CAAC,OAAO;wBAAE,OAAO,CAAC,CAAC,OAAO,GAAG,CAAC,CAAC,OAAO,CAAC;oBAC1D,OAAO,CAAC,CAAC,MAAM,CAAC,aAAa,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC;iBACzC;;gBAGD,OAAO,MAAM,CAAC,CAAC,CAAC,aAAa,CAAC,CAAC,aAAa,CAAC,MAAM,CAAC,CAAC,CAAC,aAAa,CAAC,CAAC,CAAC;aACvE,CAAC,CAAC;;YAGH,IAAI,CAAC,SAAS,GAAG,CAAC,GAAG,aAAa,CAAC,CAAC;SACrC;QAAC,OAAO,KAAK,EAAE;YACd,OAAO,CAAC,KAAK,CAAC,6BAA6B,EAAE,KAAK,CAAC,CAAC;SACrD;gBAAS;YACR,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;SACvB;KACF;IACD,MAAM;QACJ,IAAI,IAAI,CAAC,aAAa,EAAE;YACtB,OAAO,4BAAuC,CAAC;SAChD;QACD,QACE,EAAC,IAAI,QACH,mBAAqB,EACrB,yBAAiC,EACjC,eAAS,KAAK,EAAC,wBAAwB,EAAC,KAAK,EAAE,EAAE,GAAG,EAAE,MAAM,EAAE,IAC5D,WAAK,KAAK,EAAC,mDAAmD,IAC5D,UAAI,KAAK,EAAC,cAAc,uBAAsB,EAC9C,iBACE,IAAI,EAAC,IAAI,EACT,SAAS,EAAC,SAAS,EACnB,SAAS,EAAE,IAAI,CAAC,SAAS,KAAK,QAAQ,EACtC,IAAI,EAAE,OAAO,CAAC,OAAO,CAAC,UAAU,EAChC,cAAc,EAAE,OAAM,CAAC;gBACrB,CAAC,CAAC,wBAAwB,EAAE,CAAC;gBAC7B,CAAC,CAAC,eAAe,EAAE,CAAC;gBACpB,MAAM,IAAI,CAAC,eAAe,CAAC,IAAI,CAAC,CAAC;aAClC,EACD,QAAQ,EAAE,EAAE,MAAM,EAAE,MAAM,EAAE,EAC5B,YAAY,EAAC,OAAO,EACpB,SAAS,EAAC,MAAM,EAChB,UAAU,EAAE,EAAE,aAAa,EAAE,MAAM,EAAE,GAC1B,CACT,EAEN,WAAK,KAAK,EAAC,sCAAsC,EAAC,KAAK,EAAE,EAAE,GAAG,EAAE,MAAM,EAAE,IACtE,mCACE,SAAS,EAAE,IAAI,CAAC,SAAS,KAAK,QAAQ,EACtC,cAAc,EAAE,CAAC;gBACf,CAAC,CAAC,wBAAwB,EAAE,CAAC;gBAC7B,CAAC,CAAC,eAAe,EAAE,CAAC;gBACpB,IAAI,CAAC,mBAAmB,qBAAQ,CAAC,CAAC,MAAM,CAAE,CAAC;gBAC3C,IAAI,CAAC,eAAe,EAAE,CAAC;aACxB,EACD,iBAAiB,EAAE,IAAI,CAAC,iBAAiB,EACzC,WAAW,EAAE,IAAI,CAAC,WAAW,GACA,EAC/B,iCAA2B,iBAAiB,EAAE,IAAI,CAAC,iBAAiB,EAAE,KAAK,EAAC,WAAW,EAAC,OAAO,EAAE,IAAI,CAAC,SAAS,GAA8B,CACzI,CACE,CACL,EACP;KACH;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","names":["moment"],"sources":["src/components/ir-sales-by-channel/ir-sales-by-channel.css?tag=ir-sales-by-channel&encapsulation=scoped","src/components/ir-sales-by-channel/ir-sales-by-channel.tsx"],"sourcesContent":[":host {\n  display: block;\n}\n","import { Component, Host, Prop, State, Watch, h } from '@stencil/core';\nimport Token from '@/models/Token';\nimport { AllowedProperties, PropertyService } from '@/services/property.service';\nimport { RoomService } from '@/services/room.service';\nimport locales from '@/stores/locales.store';\nimport moment from 'moment';\nimport { ChannelReportResult, ChannelSaleFilter } from './types';\n@Component({\n  tag: 'ir-sales-by-channel',\n  styleUrl: 'ir-sales-by-channel.css',\n  scoped: true,\n})\nexport class IrSalesByChannel {\n  @Prop() language: string = '';\n  @Prop() ticket: string = '';\n  @Prop() propertyid: string;\n\n  @State() isLoading: 'filter' | 'export' | null = null;\n  @State() isPageLoading = true;\n\n  @State() salesData: ChannelReportResult;\n  @State() channelSalesFilters: ChannelSaleFilter;\n  @State() allowedProperties: AllowedProperties;\n\n  private token = new Token();\n  private roomService = new RoomService();\n  private propertyService = new PropertyService();\n\n  private baseFilters: ChannelSaleFilter = {\n    FROM_DATE: moment().add(-7, 'days').format('YYYY-MM-DD'),\n    TO_DATE: moment().format('YYYY-MM-DD'),\n    BOOK_CASE: '001',\n    WINDOW: 7,\n    include_previous_year: false,\n  };\n\n  componentWillLoad() {\n    this.channelSalesFilters = this.baseFilters;\n    if (this.ticket) {\n      this.token.setToken(this.ticket);\n      this.initializeApp();\n    }\n  }\n\n  @Watch('ticket')\n  ticketChanged(newValue: string, oldValue: string) {\n    if (newValue === oldValue) {\n      return;\n    }\n    this.token.setToken(this.ticket);\n    this.initializeApp();\n  }\n\n  private async initializeApp() {\n    try {\n      const requests = [this.propertyService.getExposedAllowedProperties(), this.roomService.fetchLanguage(this.language)];\n      const [properties] = await Promise.all(requests);\n      this.allowedProperties = [...(properties as any)];\n\n      this.baseFilters = { ...this.baseFilters, LIST_AC_ID: this.allowedProperties.map(p => p.id) };\n      this.channelSalesFilters = { ...this.baseFilters };\n\n      await this.getChannelSales();\n    } catch (error) {\n      console.log(error);\n    } finally {\n      this.isPageLoading = false;\n    }\n  }\n\n  private async getChannelSales(isExportToExcel = false) {\n    try {\n      const { include_previous_year, ...filterParams } = this.channelSalesFilters;\n      this.isLoading = isExportToExcel ? 'export' : 'filter';\n      const currentSales = await this.propertyService.getChannelSales({\n        // AC_ID: this.propertyid,\n        is_export_to_excel: isExportToExcel,\n        ...filterParams,\n      });\n      const shouldFetchPreviousYear = !isExportToExcel && include_previous_year;\n      let enrichedSales: ChannelReportResult = [];\n      if (shouldFetchPreviousYear) {\n        const previousYearSales = await this.propertyService.getChannelSales({\n          // AC_ID: this.propertyid.toString(),\n          is_export_to_excel: isExportToExcel,\n          ...filterParams,\n          FROM_DATE: moment(filterParams.FROM_DATE).subtract(1, 'year').format('YYYY-MM-DD'),\n          TO_DATE: moment(filterParams.TO_DATE).subtract(1, 'year').format('YYYY-MM-DD'),\n        });\n\n        enrichedSales = currentSales.map(current => {\n          const previous = previousYearSales.find(prev => prev.SOURCE.toLowerCase() === current.SOURCE.toLowerCase());\n          return {\n            ...current,\n            last_year: previous ? previous : null,\n          };\n        });\n      } else {\n        enrichedSales = currentSales.map(record => ({\n          ...record,\n          last_year: null,\n        }));\n      }\n      // --- Group by PROPERTY_ID and sort so that hotels with most revenue are on top ---\n      const totalsByProperty: Record<number, number> = enrichedSales.reduce((acc, r) => {\n        acc[r.PROPERTY_ID] = (acc[r.PROPERTY_ID] ?? 0) + r.REVENUE;\n        return acc;\n      }, {} as Record<number, number>);\n\n      enrichedSales.sort((a, b) => {\n        const tA = totalsByProperty[a.PROPERTY_ID] ?? 0;\n        const tB = totalsByProperty[b.PROPERTY_ID] ?? 0;\n\n        // 1) Sort groups by total revenue (desc)\n        if (tB !== tA) return tB - tA;\n\n        // 2) Within the same property, sort each channel row by REVENUE (desc),\n        //    then by SOURCE for a stable, readable order\n        if (a.PROPERTY_ID === b.PROPERTY_ID) {\n          if (b.REVENUE !== a.REVENUE) return b.REVENUE - a.REVENUE;\n          return a.SOURCE.localeCompare(b.SOURCE);\n        }\n\n        // 3) Tie-breaker when two different properties have identical totals\n        return String(a.PROPERTY_NAME).localeCompare(String(b.PROPERTY_NAME));\n      });\n      // -------------------------------------------------------------------------------\n\n      this.salesData = [...enrichedSales];\n    } catch (error) {\n      console.error('Failed to fetch sales data:', error);\n    } finally {\n      this.isLoading = null;\n    }\n  }\n  render() {\n    if (this.isPageLoading) {\n      return <ir-loading-screen></ir-loading-screen>;\n    }\n    return (\n      <Host>\n        <ir-toast></ir-toast>\n        <ir-interceptor></ir-interceptor>\n        <section class=\"p-2 d-flex flex-column\" style={{ gap: '1rem' }}>\n          <div class=\"d-flex align-items-center justify-content-between\">\n            <h3 class=\"mb-1 mb-md-0\">Sales by Channel</h3>\n            <ir-button\n              size=\"sm\"\n              btn_color=\"outline\"\n              isLoading={this.isLoading === 'export'}\n              text={locales.entries.Lcz_Export}\n              onClickHandler={async e => {\n                e.stopImmediatePropagation();\n                e.stopPropagation();\n                await this.getChannelSales(true);\n              }}\n              btnStyle={{ height: '100%' }}\n              iconPosition=\"right\"\n              icon_name=\"file\"\n              icon_style={{ '--icon-size': '14px' }}\n            ></ir-button>\n          </div>\n          {/* <ir-sales-by-country-summary salesReports={this.salesData}></ir-sales-by-country-summary> */}\n          <div class=\"d-flex flex-column flex-lg-row mt-1 \" style={{ gap: '1rem' }}>\n            <ir-sales-by-channel-filters\n              isLoading={this.isLoading === 'filter'}\n              onApplyFilters={e => {\n                e.stopImmediatePropagation();\n                e.stopPropagation();\n                this.channelSalesFilters = { ...e.detail };\n                this.getChannelSales();\n              }}\n              allowedProperties={this.allowedProperties}\n              baseFilters={this.baseFilters}\n            ></ir-sales-by-channel-filters>\n            <ir-sales-by-channel-table allowedProperties={this.allowedProperties} class=\"card mb-0\" records={this.salesData}></ir-sales-by-channel-table>\n          </div>\n        </section>\n      </Host>\n    );\n  }\n}\n"],"version":3}