{"version":3,"file":"applicable-policies.service.js","sourceRoot":"","sources":["../../src/services/applicable-policies.service.ts"],"names":[],"mappings":"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","sourcesContent":["import moment from 'moment';\n\nimport { Booking, ExposedApplicablePolicy, Room } from '@/models/booking.dto';\nimport { BookingService } from '@/services/booking.service';\n\nexport type ApplicablePoliciesByType = Partial<Record<ExposedApplicablePolicy['type'], ExposedApplicablePolicy[]>>;\n\nexport interface ApplicablePolicyStatement extends ExposedApplicablePolicy {\n  roomType: Room['roomtype'];\n  ratePlan: Room['rateplan'];\n  checkInDate: Room['from_date'];\n  grossTotal: Room['gross_total'];\n}\n\nexport interface ApplicablePoliciesResult {\n  policiesByType: ApplicablePoliciesByType;\n  cancellationStatements: ApplicablePolicyStatement[];\n  guaranteeAmount: number;\n}\n\ninterface GroupedRoomPayload {\n  identifiers: string[];\n  ratePlanId: number;\n  roomTypeId: number;\n  rooms: Room[];\n}\n\ntype BookingServiceDependency = Readonly<Pick<BookingService, 'getExposedApplicablePolicies'>>;\n\ninterface ApplicablePoliciesRequest {\n  language?: string;\n}\n\ninterface GroupedPoliciesResponse {\n  grouping: GroupedRoomPayload;\n  policies: ExposedApplicablePolicy[] | null;\n}\n\n/**\n * Coordinates retrieval of applicable policies for a booking by delegating to\n * {@link BookingService} while providing light data preparation utilities.\n */\nexport class ApplicablePoliciesService {\n  private _booking: Booking | null = null;\n\n  constructor(private readonly bookingService: BookingServiceDependency) {}\n\n  /**\n   * Returns the booking reference used to scope applicable policy requests.\n   */\n  public get booking(): Booking | null {\n    return this._booking;\n  }\n\n  /**\n   * Assigns the booking reference that downstream requests rely on.\n   */\n  public set booking(value: Booking | null) {\n    this._booking = value;\n  }\n\n  /**\n   * Fetches the exposed applicable policies for the active booking and groups\n   * them by policy type to simplify consumption within UI layers. Requests for\n   * each unique room grouping are executed in parallel. The response includes\n   * the grouped policies alongside prebuilt cancellation statements and the\n   * aggregate guarantee amount.\n   *\n   * @throws If a booking is not configured prior to invocation.\n   */\n  public async fetchGroupedApplicablePolicies(params: ApplicablePoliciesRequest): Promise<ApplicablePoliciesResult> {\n    if (!this._booking) {\n      throw new Error('Booking must be defined before fetching applicable policies.');\n    }\n    if (['003', '004'].includes(this._booking.status.code) || !this._booking.is_direct) {\n      return;\n    }\n    const { rooms, booking_nbr, currency, property } = this._booking;\n    const groupedRooms = this.groupRoomsForRequest(rooms ?? []);\n\n    try {\n      const requests: Promise<GroupedPoliciesResponse>[] = [];\n\n      groupedRooms.forEach(grouping => {\n        const basePayload = {\n          booking_nbr,\n          currency_id: currency.id,\n          language: params.language,\n          property_id: property.id,\n          rate_plan_id: grouping.ratePlanId,\n          room_type_id: grouping.roomTypeId,\n          is_preserve_history: true,\n        };\n\n        if (grouping.identifiers.length > 1) {\n          grouping.identifiers.forEach(roomIdentifier => {\n            requests.push(\n              this.bookingService\n                .getExposedApplicablePolicies({ ...basePayload, room_identifier: roomIdentifier })\n                .then(policies => ({ grouping: { ...grouping, rooms: rooms.filter(r => r.identifier === roomIdentifier) }, policies })),\n            );\n          });\n        } else {\n          requests.push(this.bookingService.getExposedApplicablePolicies(basePayload).then(policies => ({ grouping, policies })));\n        }\n      });\n\n      const groupedPolicies = await Promise.all(requests);\n\n      const policiesByType = this.buildPoliciesByType(groupedPolicies);\n      const cancellationStatements = this.buildCancellationStatements(groupedPolicies);\n      const guaranteeAmount = this.calculateGuaranteeAmount(groupedPolicies);\n\n      return { policiesByType, cancellationStatements, guaranteeAmount };\n    } catch (error) {\n      const detail = error instanceof Error ? error.message : String(error);\n      throw new Error(`Failed to fetch applicable policies: ${detail}`);\n    }\n  }\n\n  /**\n   * Creates a list of unique room groupings keyed by rate plan and room type.\n   * Each grouping tracks the identifiers of the rooms it represents.\n   *\n   * @param rooms - The rooms attached to the active booking.\n   */\n  private groupRoomsForRequest(rooms: Room[]): GroupedRoomPayload[] {\n    if (!rooms.length) {\n      throw new Error('Cannot request applicable policies without booking rooms.');\n    }\n\n    const groupMap = new Map<string, GroupedRoomPayload>();\n\n    rooms.forEach(room => {\n      if (!room.rateplan?.id || !room.roomtype?.id) {\n        throw new Error('Room is missing rate plan or room type information.');\n      }\n\n      const key = `${room.roomtype.id}-${room.rateplan.id}`;\n      const identifier = typeof room.identifier === 'string' ? room.identifier : null;\n\n      if (!groupMap.has(key)) {\n        groupMap.set(key, {\n          ratePlanId: room.rateplan.id,\n          roomTypeId: room.roomtype.id,\n          identifiers: identifier ? [identifier] : [],\n          rooms: [room],\n        });\n        return;\n      }\n\n      const group = groupMap.get(key)!;\n      group.rooms.push(room);\n      if (identifier && !group.identifiers.includes(identifier)) {\n        group.identifiers.push(identifier);\n      }\n    });\n\n    return [...groupMap.values()];\n  }\n\n  private buildPoliciesByType(groupedPolicies: GroupedPoliciesResponse[]): ApplicablePoliciesByType {\n    const flattened = groupedPolicies.flatMap(group => group.policies ?? []);\n    return this.groupPoliciesByType(flattened);\n  }\n\n  /**\n   * Organizes the raw policies returned from the API by their logical type so\n   * consumers can access grouped guarantees or cancellations effortlessly.\n   */\n  private groupPoliciesByType(policies: ExposedApplicablePolicy[]): ApplicablePoliciesByType {\n    return policies.reduce<ApplicablePoliciesByType>((acc, policy) => {\n      acc[policy.type] = acc[policy.type] ? [...acc[policy.type]!, policy] : [policy];\n      return acc;\n    }, {});\n  }\n\n  /**\n   * Builds the cancellation statements derived from the fetched policies and\n   * booking rooms.\n   */\n  private buildCancellationStatements(groupedPolicies: GroupedPoliciesResponse[]): ApplicablePolicyStatement[] {\n    if (!this._booking) {\n      return [];\n    }\n\n    const statements: ApplicablePolicyStatement[] = [];\n\n    groupedPolicies.forEach(({ grouping, policies }) => {\n      if (!policies?.length) {\n        return;\n      }\n\n      const cancellationPolicy = policies.find(policy => policy.type === 'cancelation');\n      if (!cancellationPolicy) {\n        return;\n      }\n\n      grouping.rooms.forEach(room => {\n        const checkInDate = moment(room.from_date, 'YYYY-MM-DD', true);\n        if (!checkInDate.isValid()) {\n          return;\n        }\n        // const checkInDateStr = checkInDate.format('YYYY-MM-DD');\n        //Remove check-in dates and above from brackets\n        const oldBrackets = cancellationPolicy.brackets.filter(bracket => {\n          const bracketDate = moment(bracket.due_on, 'YYYY-MM-DD', true);\n          return bracketDate.isValid() && bracketDate.isBefore(checkInDate, 'day');\n        });\n        // if (!oldBrackets.length) {\n        //   return;\n        // }\n        //check if at least one bracket have a amount > 0\n        const hasPositiveBracket = oldBrackets.some(bracket => bracket.amount > 0);\n\n        let filteredBrackets: typeof oldBrackets;\n\n        if (hasPositiveBracket) {\n          filteredBrackets = oldBrackets\n            .map((bracket, index) => {\n              if (bracket.amount > 0) {\n                return bracket;\n              }\n              const nextBracket = oldBrackets[index + 1];\n              if (nextBracket?.amount && nextBracket.amount > 0) {\n                return bracket;\n              }\n              return undefined;\n            })\n            .filter((bracket): bracket is (typeof oldBrackets)[number] => Boolean(bracket));\n        } else {\n          filteredBrackets = [...oldBrackets];\n        }\n\n        filteredBrackets = [...this.mergeBracketsByAmount(filteredBrackets)];\n\n        if (!room.rateplan.is_non_refundable) {\n          const inDate = moment(room.from_date, 'YYYY-MM-DD', true);\n          const outDate = moment(room.to_date, 'YYYY-MM-DD', true);\n          const stayNights = outDate.isValid() && inDate.isValid() ? outDate.diff(inDate, 'days') : 0;\n          const fullChargeDate = stayNights > 1 ? inDate.clone().add(1, 'day').format('YYYY-MM-DD') : inDate.format('YYYY-MM-DD');\n          filteredBrackets.push({\n            amount: room.total,\n            amount_formatted: '',\n            code: '',\n            currency_id: this._booking.currency.id,\n            due_on: fullChargeDate,\n            due_on_formatted: '',\n            gross_amount: room.gross_total,\n            gross_amount_formatted: '',\n            statement: '100% of total price',\n          });\n\n          filteredBrackets.sort((a, b) => {\n            const aDate = moment(a.due_on, 'YYYY-MM-DD', true);\n            const bDate = moment(b.due_on, 'YYYY-MM-DD', true);\n            return aDate.valueOf() - bDate.valueOf();\n          });\n        }\n\n        statements.push({\n          ...cancellationPolicy,\n          brackets: filteredBrackets,\n          roomType: room.roomtype,\n          ratePlan: room.rateplan,\n          checkInDate: room.from_date,\n          grossTotal: room.gross_total,\n        });\n      });\n    });\n\n    return statements;\n  }\n\n  /**\n   * Aggregates the guarantee commitments across the booking rooms using the\n   * freshly retrieved policy data.\n   */\n  private calculateGuaranteeAmount(groupedPolicies: GroupedPoliciesResponse[]): number {\n    return groupedPolicies.reduce((total, { grouping, policies }) => {\n      if (!policies?.length) {\n        return total;\n      }\n\n      const guaranteePolicy = policies.find(policy => policy.type === 'guarantee');\n      if (!guaranteePolicy) {\n        return total;\n      }\n\n      const currentBracket = this.selectCurrentBracket(guaranteePolicy.brackets);\n      if (!currentBracket) {\n        return total;\n      }\n\n      const roomsTotal = grouping.rooms.length * (currentBracket.gross_amount ?? 0);\n      return total + roomsTotal;\n    }, 0);\n  }\n\n  private selectCurrentBracket(brackets: ExposedApplicablePolicy['brackets']): ExposedApplicablePolicy['brackets'][number] | null {\n    const today = moment().startOf('day');\n\n    for (const bracket of brackets) {\n      const dueDate = moment(bracket.due_on, 'YYYY-MM-DD', true);\n      if (!dueDate.isValid()) {\n        continue;\n      }\n\n      if (today.isSameOrAfter(dueDate, 'day')) {\n        return bracket;\n      }\n    }\n\n    return null;\n  }\n\n  /**\n   * Collapses consecutive brackets that share the same gross amount so only\n   * price changes are surfaced.\n   */\n  private mergeBracketsByAmount(brackets: ExposedApplicablePolicy['brackets']): ExposedApplicablePolicy['brackets'] {\n    if (brackets.length <= 1) {\n      return [...brackets];\n    }\n\n    return brackets.reduce<ExposedApplicablePolicy['brackets']>((acc, bracket) => {\n      const last = acc[acc.length - 1];\n      if (!last || last.gross_amount !== bracket.gross_amount) {\n        acc.push(bracket);\n      }\n      return acc;\n    }, []);\n  }\n}\n"]}