{"version":3,"file":"ir-property-switcher.js","sourceRoot":"","sources":["../../../../src/components/pms-header/ir-property-switcher/ir-property-switcher.tsx"],"names":[],"mappings":"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","sourcesContent":["import { Component, Element, Event, EventEmitter, Host, Prop, State, Watch, h } from '@stencil/core';\nimport axios from 'axios';\n\nimport { FetchedProperty } from '@/services/property.service';\nimport { GetACByACID } from './legacy.types';\nimport Token from '@/models/Token';\n\ntype SwitcherMode = 'dropdown' | 'dialog' | 'read-only';\n\n@Component({\n  tag: 'ir-property-switcher',\n  styleUrl: 'ir-property-switcher.css',\n  scoped: true,\n})\nexport class IrPropertySwitcher {\n  @Element() el: HTMLIrPropertySwitcherElement;\n\n  @Prop() mode: 'dropdown' | 'dialog' = 'dialog';\n  @Prop() ticket: string;\n  @Prop() baseUrl: string;\n\n  @State() open = false;\n  @State() selectedProperty?: FetchedProperty;\n  @State() linkedProperties: FetchedProperty[] = [];\n  @State() displayMode: SwitcherMode = 'read-only';\n\n  private token = new Token();\n\n  /** Emits whenever the user selects a new property */\n  @Event({ bubbles: true, composed: true })\n  propertyChange: EventEmitter<FetchedProperty>;\n\n  private storagePoller?: number;\n  private lastSelectedAcRaw: string | null = null;\n  private lastUserInfoRaw: string | null = null;\n\n  async componentWillLoad() {\n    if (this.baseUrl) this.token.setBaseUrl(this.baseUrl);\n    if (this.ticket) this.token.setToken(this.ticket);\n\n    // Try once immediately\n    await this.pollLocalStorage();\n\n    // Start polling only if data not ready yet\n    if (!this.selectedProperty) {\n      this.startStoragePolling();\n    }\n\n    // Listen for cross-tab updates\n    window.addEventListener('storage', this.handleStorageEvent);\n  }\n\n  disconnectedCallback() {\n    this.stopStoragePolling();\n    window.removeEventListener('storage', this.handleStorageEvent);\n  }\n\n  /* --------------------------------------------\n   * Watchers\n   * -------------------------------------------- */\n\n  @Watch('ticket')\n  async handleTicketChange(newValue: string, oldValue: string) {\n    if (newValue !== oldValue) {\n      this.token.setToken(newValue);\n      await this.pollLocalStorage();\n      this.startStoragePolling();\n    }\n  }\n\n  /* --------------------------------------------\n   * LocalStorage polling logic\n   * -------------------------------------------- */\n\n  private startStoragePolling() {\n    if (this.storagePoller) return;\n\n    this.storagePoller = window.setInterval(this.pollLocalStorage, 300);\n  }\n\n  private stopStoragePolling() {\n    if (this.storagePoller) {\n      clearInterval(this.storagePoller);\n      this.storagePoller = undefined;\n    }\n  }\n\n  private handleStorageEvent = () => {\n    // Cross-tab change â†’ re-enable polling briefly\n    this.startStoragePolling();\n  };\n\n  private pollLocalStorage = async () => {\n    const selectedAcRaw = localStorage.getItem('_Selected_Ac');\n    const userInfoRaw = localStorage.getItem('UserInfo_b');\n\n    // Nothing changed â†’ skip work\n    if (selectedAcRaw === this.lastSelectedAcRaw && userInfoRaw === this.lastUserInfoRaw) {\n      return;\n    }\n\n    this.lastSelectedAcRaw = selectedAcRaw;\n    this.lastUserInfoRaw = userInfoRaw;\n\n    if (!selectedAcRaw || !userInfoRaw) {\n      return;\n    }\n\n    let selectedAc: GetACByACID;\n\n    try {\n      selectedAc = JSON.parse(selectedAcRaw);\n    } catch {\n      return;\n    }\n\n    // âœ… Storage is now valid\n    this.updateSelectedProperty(selectedAc);\n    await this.fetchLinkedProperties(selectedAc.AC_ID);\n    this.resolveDisplayMode(true);\n\n    // ðŸ›‘ Stop polling once initialized\n    this.stopStoragePolling();\n  };\n\n  private updateSelectedProperty(selectedAc: GetACByACID) {\n    this.selectedProperty = {\n      A_NAME: selectedAc.My_User?.USERNAME ?? '',\n      COUNTRY_CODE: selectedAc.COUNTRY_ID as any,\n      COUNTRY_NAME: selectedAc.My_Country?.L1_NAME_REF ?? '',\n      PROPERTY_ID: selectedAc.AC_ID,\n      PROPERTY_NAME: selectedAc.NAME,\n    };\n  }\n\n  private async fetchLinkedProperties(acId: number) {\n    try {\n      const { data } = await axios.post('/Fetch_Linked_Properties', {\n        AC_ID: acId,\n      });\n\n      if (data.ExceptionMsg) {\n        throw new Error(data.ExceptionMsg);\n      }\n\n      this.linkedProperties = Array.isArray(data.My_Result) ? data.My_Result : [];\n    } catch (error) {\n      console.error('Failed to fetch linked properties', error);\n      this.linkedProperties = [];\n    }\n  }\n\n  private resolveDisplayMode(hasSelectedAc: boolean) {\n    const userInfoRaw = localStorage.getItem('UserInfo_b');\n\n    let userInfo: any = null;\n    try {\n      if (userInfoRaw) userInfo = JSON.parse(userInfoRaw);\n    } catch {\n      /* noop */\n    }\n\n    const userTypeCode = String(userInfo?.USER_TYPE_CODE ?? '');\n\n    if (userTypeCode === '1' || userTypeCode === '4') {\n      this.displayMode = 'dialog';\n      return;\n    }\n\n    if (!hasSelectedAc || !this.linkedProperties.length) {\n      this.displayMode = 'read-only';\n      return;\n    }\n\n    this.displayMode = 'dropdown';\n  }\n\n  private handlePropertySelected = async (event: CustomEvent<FetchedProperty>) => {\n    await this.applySelectedProperty(event.detail);\n  };\n\n  private handleDropdownSelect = async (event: CustomEvent<string>) => {\n    const selectedId = Number(event.detail);\n    const property = this.linkedProperties.find(p => p.PROPERTY_ID === selectedId);\n    if (!property) return;\n\n    await this.applySelectedProperty(property);\n  };\n\n  private async applySelectedProperty(property: FetchedProperty) {\n    this.selectedProperty = property;\n    this.open = false;\n\n    try {\n      const { data } = await axios.post('/Get_Ac_By_AC_ID_Adv', {\n        AC_ID: property.PROPERTY_ID,\n        Bypass_Caching: true,\n        IS_BACK_OFFICE: true,\n      });\n\n      if (data.ExceptionMsg) {\n        throw new Error(data.ExceptionMsg);\n      }\n\n      localStorage.setItem('_Selected_Ac', JSON.stringify(data.My_Result ?? data));\n    } catch (error) {\n      console.error('Failed to fetch selected property details', error);\n    }\n\n    this.propertyChange.emit(property);\n\n    // Re-init via polling-safe path\n    this.startStoragePolling();\n  }\n\n  private renderReadOnly() {\n    return <p class=\"property-switcher__trigger\">{this.selectedProperty?.PROPERTY_NAME ?? 'Property'}</p>;\n  }\n\n  private trigger() {\n    return (\n      <ir-custom-button withCaret variant=\"neutral\" appearance=\"plain\" onClickHandler={() => (this.open = !this.open)}>\n        <p class=\"property-switcher__trigger\">{this.selectedProperty?.PROPERTY_NAME ?? 'Select property'}</p>\n      </ir-custom-button>\n    );\n  }\n\n  render() {\n    return (\n      <Host>\n        {this.displayMode === 'read-only' && this.renderReadOnly()}\n\n        {this.displayMode === 'dropdown' && (\n          <ir-select\n            showFirstOption={false}\n            selectedValue={this.selectedProperty?.PROPERTY_ID?.toString() ?? ''}\n            data={this.linkedProperties.map(p => ({\n              value: p.PROPERTY_ID?.toString(),\n              text: `${p.PROPERTY_NAME} ${p.COUNTRY_NAME}`,\n            }))}\n            onSelectChange={this.handleDropdownSelect}\n          />\n        )}\n\n        {this.displayMode === 'dialog' && (\n          <div>\n            {this.trigger()}\n            <ir-dialog\n              withoutHeader\n              open={this.open}\n              label=\"Find property\"\n              class=\"property-switcher__dialog\"\n              onIrDialogAfterHide={e => {\n                e.stopImmediatePropagation();\n                e.stopPropagation();\n                this.open = false;\n              }}\n            >\n              {this.open && (\n                <ir-property-switcher-dialog-content\n                  open={this.open}\n                  selectedPropertyId={this.selectedProperty?.PROPERTY_ID}\n                  properties={this.linkedProperties}\n                  onPropertySelected={this.handlePropertySelected}\n                />\n              )}\n            </ir-dialog>\n          </div>\n        )}\n      </Host>\n    );\n  }\n}\n"]}