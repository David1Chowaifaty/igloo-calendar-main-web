{"version":3,"file":"ir-interceptor.js","sourceRoot":"","sources":["../../../src/components/ir-interceptor/ir-interceptor.tsx"],"names":[],"mappings":"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","sourcesContent":["import { Component, Event, EventEmitter, Host, Listen, Prop, State, h } from '@stencil/core';\nimport axios, { AxiosRequestConfig, AxiosResponse } from 'axios';\nimport { IToast } from '@components/ui/ir-toast/toast';\nimport interceptor_requests from '@/stores/ir-interceptor.store';\nimport { InterceptorError } from './InterceptorError';\n\n@Component({\n  tag: 'ir-interceptor',\n  styleUrl: 'ir-interceptor.css',\n  scoped: true,\n})\nexport class IrInterceptor {\n  @Prop({ reflect: true }) handledEndpoints = ['/Get_Exposed_Calendar', '/ReAllocate_Exposed_Room', '/Get_Exposed_Bookings', '/UnBlock_Exposed_Unit'];\n  @Prop() suppressToastEndpoints: string[] = [];\n\n  @State() isShown = false;\n  @State() isLoading = false;\n  @State() isUnassignedUnit = false;\n  @State() endpointsCount = 0;\n  @State() isPageLoadingStopped: string | null = null;\n  @State() showModal: boolean;\n  @State() requestUrl: string;\n  @State() email: string;\n\n  @Event({ bubbles: true, composed: true }) toast: EventEmitter<IToast>;\n\n  private otpModal: HTMLIrOtpModalElement;\n\n  private pendingConfig?: AxiosRequestConfig;\n  private pendingResolve?: (resp: AxiosResponse) => void;\n  private pendingReject?: (err: any) => void;\n\n  @Listen('preventPageLoad', { target: 'body' })\n  handleStopPageLoading(e: CustomEvent) {\n    this.isLoading = false;\n    this.isPageLoadingStopped = e.detail;\n  }\n  componentWillLoad() {\n    this.setupAxiosInterceptors();\n  }\n\n  private setupAxiosInterceptors() {\n    axios.interceptors.request.use(this.handleRequest.bind(this), this.handleError.bind(this));\n    axios.interceptors.response.use(this.handleResponse.bind(this), this.handleError.bind(this));\n  }\n\n  private extractEndpoint(url: string): string {\n    return url.split('?')[0];\n  }\n\n  private isHandledEndpoint(url: string): boolean {\n    return this.handledEndpoints.includes(url);\n  }\n  private handleRequest(config: AxiosRequestConfig) {\n    const extractedUrl = this.extractEndpoint(config.url);\n    interceptor_requests[extractedUrl] = 'pending';\n    config.params = config.params || {};\n    // if (this.ticket) {\n    //   config.params.Ticket = this.ticket;\n    // }\n    if (this.isHandledEndpoint(extractedUrl) && this.isPageLoadingStopped !== extractedUrl) {\n      if (extractedUrl !== '/Get_Exposed_Calendar') {\n        this.isLoading = true;\n      } else {\n        if (this.endpointsCount > 0) {\n          this.isLoading = true;\n        }\n      }\n    }\n    if (extractedUrl === '/Get_Exposed_Calendar') {\n      this.endpointsCount = this.endpointsCount + 1;\n    }\n    return config;\n  }\n\n  private async handleResponse(response: AxiosResponse) {\n    const extractedUrl = this.extractEndpoint(response.config.url);\n    if (this.isHandledEndpoint(extractedUrl)) {\n      this.isLoading = false;\n      this.isPageLoadingStopped = null;\n    }\n    interceptor_requests[extractedUrl] = 'done';\n    if (extractedUrl === '/Validate_Exposed_OTP') {\n      return response;\n    }\n    if (response.data.ExceptionCode === 'OTP') {\n      this.showModal = true;\n      this.email = response.data.ExceptionMsg;\n      const name = extractedUrl.slice(1);\n      if (name === 'Check_OTP_Necessity') {\n        let methodName: string;\n        try {\n          const body = typeof response.config.data === 'string' ? JSON.parse(response.config.data) : response.config.data;\n          methodName = body.METHOD_NAME;\n        } catch (e) {\n          console.error('Failed to parse request body for METHOD_NAME', e);\n          methodName = name; // fallback\n        }\n        this.requestUrl = methodName;\n      } else {\n        this.requestUrl = name;\n      }\n\n      this.pendingConfig = response.config;\n      return new Promise<AxiosResponse>((resolve, reject) => {\n        this.pendingResolve = resolve;\n        this.pendingReject = reject;\n        setTimeout(() => {\n          this.otpModal?.openModal();\n        }, 10);\n      });\n    }\n    if (response.data.ExceptionMsg?.trim()) {\n      this.handleError(response.data.ExceptionMsg, extractedUrl, response.data.ExceptionCode);\n      throw new InterceptorError(response.data.ExceptionMsg, response.data.ExceptionCode);\n    }\n    return response;\n  }\n\n  private handleError(error: string, url: string, code: string) {\n    const shouldSuppressToast = this.suppressToastEndpoints.includes(url);\n    if (!shouldSuppressToast || (shouldSuppressToast && !code)) {\n      this.toast.emit({\n        type: 'error',\n        title: error,\n        description: '',\n        position: 'top-right',\n      });\n    }\n    return Promise.reject(error);\n  }\n  private async handleOtpFinished(ev: CustomEvent) {\n    if (!this.pendingConfig || !this.pendingResolve || !this.pendingReject) {\n      return;\n    }\n\n    const otp = ev.detail;\n    if (!otp) {\n      this.pendingReject(new Error('OTP cancelled by user'));\n    } else {\n      try {\n        if (this.requestUrl !== 'Check_OTP_Necessity') {\n          const retryConfig: AxiosRequestConfig = {\n            ...this.pendingConfig,\n            data: {\n              ...(typeof this.pendingConfig.data === 'string' ? JSON.parse(this.pendingConfig.data) : this.pendingConfig.data || {}),\n            },\n          };\n          const resp = await axios.request(retryConfig);\n          this.pendingResolve(resp);\n        }\n      } catch (err) {\n        this.pendingReject(err);\n      }\n    }\n    this.pendingConfig = undefined;\n    this.pendingResolve = undefined;\n    this.pendingReject = undefined;\n    this.showModal = false;\n  }\n  render() {\n    return (\n      <Host>\n        {/* {this.isLoading && !this.isPageLoadingStopped && (\n          <div class=\"loadingScreenContainer\">\n            <div class=\"loaderContainer\">\n              <span class=\"loader\"></span>\n              <p>Fetching bookings.</p>\n            </div>\n          </div>\n        )} */}\n        {this.isLoading && !this.isPageLoadingStopped && (\n          <div class=\"loadingScreenContainer\">\n            <div class=\"loaderContainer\">\n              <span class=\"page-loader\"></span>\n            </div>\n          </div>\n        )}\n        {this.showModal && (\n          <ir-otp-modal email={this.email} requestUrl={this.requestUrl} ref={el => (this.otpModal = el)} onOtpFinished={this.handleOtpFinished.bind(this)}></ir-otp-modal>\n        )}\n      </Host>\n    );\n  }\n}\n"]}