{"version":3,"file":"ir-booking-editor.service.js","sourceRoot":"","sources":["../../../../src/components/igloo-calendar/ir-booking-editor/ir-booking-editor.service.ts"],"names":[],"mappings":"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","sourcesContent":["import { Booking, Room } from '@/models/booking.dto';\nimport VariationService from '@/services/variation.service';\nimport booking_store, { IRatePlanSelection, modifyBookingStore, reserveRooms } from '@/stores/booking.store';\nimport { extras } from '@/utils/utils';\nimport moment, { Moment } from 'moment';\nimport { BookingEditorMode } from './types';\nimport calendar_data from '@/stores/calendar-data';\n// import { BookingService } from '@/services/booking-service/booking.service';\n\nexport class IRBookingEditorService {\n  /** Current booking editor mode */\n  private mode: BookingEditorMode;\n\n  /** Lazy-initialized variation service */\n  private variationService?: VariationService;\n\n  // private bookingService = new BookingService();\n\n  constructor(mode?: BookingEditorMode) {\n    this.mode = mode;\n  }\n  public setMode(mode: BookingEditorMode) {\n    this.mode = mode;\n  }\n\n  /**\n   * Syncs room data with the booking store and reserves a room.\n   * Aborts if required room data is missing.\n   */\n  public updateBooking(room?: Room): void {\n    if (!room) return;\n\n    try {\n      const roomtypeId = room.roomtype?.id;\n      const rateplanId = room.rateplan?.id;\n      const guestData = room.guest;\n      const occupancy = room.occupancy;\n\n      if (!roomtypeId || !rateplanId || !guestData || !occupancy) {\n        console.warn('[updateBooking] Missing required room data', room);\n        return;\n      }\n\n      const guest = {\n        bed_preference: room.bed_preference?.toString() ?? null,\n        infant_nbr: occupancy.infant_nbr ?? 0,\n        last_name: guestData.last_name ?? '',\n        first_name: guestData.first_name ?? '',\n        unit: (room.unit as any)?.id?.toString() ?? null,\n        roomtype_id: roomtypeId,\n      };\n\n      modifyBookingStore('guest', guest);\n\n      reserveRooms({\n        roomTypeId: roomtypeId,\n        ratePlanId: rateplanId,\n        rooms: 1,\n        guest: [guest],\n      });\n    } catch (error) {\n      console.error('[updateBooking] Failed', error);\n    }\n  }\n\n  /**\n   * Finds a room by identifier and syncs its guest data to the store.\n   */\n  public getRoom(booking?: Booking, identifier?: string): Room | undefined {\n    if (!booking || !identifier) return;\n\n    const room = booking.rooms?.find(r => r.identifier === identifier);\n    if (!room) return;\n\n    modifyBookingStore('guest', {\n      bed_preference: room.bed_preference?.toString() ?? null,\n      infant_nbr: room.occupancy?.infant_nbr ?? 0,\n      first_name: room.guest?.first_name ?? '',\n      last_name: room.guest?.last_name ?? '',\n      unit: (room.unit as any)?.id?.toString() ?? null,\n    });\n\n    return room;\n  }\n\n  // ─────────────────────────────────────────────\n  // Utility helpers\n  // ─────────────────────────────────────────────\n\n  /**\n   * Checks whether a string contains underscores.\n   * Used to validate phone numbers.\n   */\n  private hasUnderscore(str: string): boolean {\n    return /_+/.test(str);\n  }\n  /**\n   * Generates daily rate entries for a reserved room.\n   */\n  private async calculateAmount({ is_amount_modified, selected_variation, view_mode, rp_amount }: IRatePlanSelection) {\n    if (!is_amount_modified) return null;\n\n    const total_days = selected_variation.nights.length;\n\n    // Gross amount (tax included)\n    const gross = view_mode === '002' ? rp_amount : rp_amount / total_days;\n    return gross;\n    // const tax = await this.bookingService.calculateExclusiveTax({\n    //   property_id: calendar_data.property.id,\n    //   amount: gross,\n    // });\n\n    // if (!tax || tax <= 0) {\n    //   return gross;\n    // }\n\n    // const net = gross / (1 + tax / gross);\n\n    // return Number(net.toFixed(2));\n  }\n  /**\n   * Builds room payloads based on selected rate plans\n   * and booking draft context.\n   */\n  private async generateDailyRates(rate_plan: IRatePlanSelection, i: number) {\n    let variation = rate_plan.selected_variation;\n    const amount = rate_plan.is_amount_modified ? await this.calculateAmount(rate_plan) : null;\n    if (rate_plan.guest[i].infant_nbr > 0 && !rate_plan.is_amount_modified) {\n      if (!this.variationService) {\n        this.variationService = new VariationService();\n      }\n      variation = this.variationService.getVariationBasedOnInfants({\n        variations: rate_plan.ratePlan.variations,\n        baseVariation: rate_plan.selected_variation,\n        infants: rate_plan.guest[i].infant_nbr,\n      });\n    }\n    return variation.nights.map(n => ({\n      date: n.night,\n      amount: amount ?? n.discounted_amount,\n      cost: null,\n    }));\n  }\n\n  private async getBookedRooms({\n    check_in,\n    check_out,\n    notes,\n    identifier,\n    override_unit,\n    unit,\n    auto_check_in,\n  }: {\n    identifier: string | null;\n    check_in: Moment;\n    check_out: Moment;\n    override_unit: boolean;\n    unit: string;\n    notes: string | null;\n    auto_check_in: boolean;\n  }) {\n    const rooms = [];\n\n    for (const roomTypeId in booking_store.ratePlanSelections) {\n      const roomtype = booking_store.ratePlanSelections[roomTypeId];\n      for (const rateplanId in roomtype) {\n        const rateplan = roomtype[rateplanId];\n        if (rateplan.reserved > 0) {\n          for (let i = 0; i < rateplan.reserved; i++) {\n            const { first_name, last_name } = rateplan.guest[i];\n            const days = await this.generateDailyRates(rateplan, i);\n            rooms.push({\n              identifier,\n              roomtype: rateplan.roomtype,\n              rateplan: rateplan.ratePlan,\n              prepayment_amount_gross: 0,\n              unit: override_unit ? { id: unit } : rateplan.guest[i].unit ? { id: rateplan.guest[i].unit } : null,\n              occupancy: {\n                adult_nbr: rateplan.selected_variation.adult_nbr,\n                children_nbr: Number(rateplan.selected_variation.child_nbr ?? 0) - Math.max(Number(rateplan.guest[i].infant_nbr ?? 0), 0),\n                infant_nbr: rateplan.guest[i].infant_nbr,\n              },\n              bed_preference: rateplan.guest[i].bed_preference,\n              from_date: moment(check_in).format('YYYY-MM-DD'),\n              to_date: moment(check_out).format('YYYY-MM-DD'),\n              notes,\n              check_in: auto_check_in,\n              days,\n              guest: {\n                email: null,\n                first_name,\n                last_name,\n                country_id: null,\n                city: null,\n                mobile: null,\n                address: null,\n                dob: null,\n                subscribe_to_news_letter: null,\n                cci: null,\n              },\n            });\n          }\n        }\n      }\n    }\n    return rooms;\n  }\n  public isEventType(mode: BookingEditorMode | BookingEditorMode[]): boolean {\n    if (Array.isArray(mode)) {\n      return mode.includes(this.mode);\n    }\n    return this.mode === mode;\n  }\n  /**\n   * Prepares payload parameters for the booking user service\n   * based on the current editor mode.\n   */\n  public async prepareBookUserServiceParams({ check_in, booking, room, unitId }: { check_in: boolean; booking: Booking; room: Room; unitId: string }) {\n    try {\n      // Validate context structure\n      const { dates } = booking_store.bookingDraft;\n\n      const fromDate = dates.checkIn;\n      const toDate = dates.checkOut;\n\n      const generateNewRooms = async (identifier = null, check_in: boolean = false) => {\n        return await this.getBookedRooms({\n          check_in: fromDate,\n          check_out: toDate,\n          identifier,\n          notes: '',\n          override_unit: this.isEventType(['BAR_BOOKING', 'SPLIT_BOOKING']) ? true : false,\n          unit: this.isEventType(['BAR_BOOKING', 'SPLIT_BOOKING']) ? unitId?.toString() ?? null : null,\n          auto_check_in: check_in,\n        });\n      };\n\n      const modifyBookingDetails = ({ pickup_info, extra_services, is_direct, is_in_loyalty_mode, promo_key, extras, ...rest }: Booking, rooms: Room[]) => {\n        return {\n          assign_units: true,\n          is_pms: true,\n          is_direct,\n          is_backend: true,\n          is_in_loyalty_mode,\n          promo_key,\n          extras,\n          booking: {\n            ...rest,\n            rooms,\n          },\n          extra_services,\n          pickup_info,\n        };\n      };\n\n      let newBooking = null;\n      const sourceOption = booking_store.bookingDraft.source;\n      switch (this.mode) {\n        case 'EDIT_BOOKING': {\n          const filteredRooms = booking.rooms.filter(r => r.identifier !== room.identifier);\n          const newRooms = await generateNewRooms(room.identifier, room.in_out?.code === '001');\n          newBooking = modifyBookingDetails(booking, [...filteredRooms, ...newRooms]);\n          break;\n        }\n        case 'ADD_ROOM':\n        case 'SPLIT_BOOKING': {\n          const newRooms = await generateNewRooms();\n          const previousRooms = booking.rooms;\n          newBooking = modifyBookingDetails(booking, [...previousRooms, ...newRooms]);\n          break;\n        }\n        default: {\n          const newRooms = await generateNewRooms(null, check_in);\n          const { bookedByGuest } = booking_store;\n          const isAgent = sourceOption.type === 'TRAVEL_AGENCY';\n          newBooking = {\n            assign_units: true,\n            is_pms: true,\n            is_direct: true,\n            is_backend: true,\n            is_in_loyalty_mode: false,\n            promo_key: null,\n            extras: [...extras.filter(e => e.key !== 'payment_code'), { key: 'payment_code', value: booking_store.selectedPaymentMethod?.code }],\n            agent: isAgent ? { id: sourceOption.tag } : null,\n            is_email_client: bookedByGuest.emailGuest,\n            booking: {\n              company_name: bookedByGuest.company ?? null,\n              from_date: moment(fromDate).format('YYYY-MM-DD'),\n              to_date: moment(toDate).format('YYYY-MM-DD'),\n              remark: bookedByGuest.note || null,\n              booking_nbr: '',\n              property: {\n                id: calendar_data.property.id,\n              },\n              booked_on: {\n                date: moment().format('YYYY-MM-DD'),\n                hour: new Date().getHours(),\n                minute: new Date().getMinutes(),\n              },\n              source: isAgent ? '' : sourceOption,\n              rooms: newRooms,\n              currency: calendar_data.property.currency,\n              arrival: { code: bookedByGuest.selectedArrivalTime },\n              guest: {\n                email: bookedByGuest.email === '' ? null : bookedByGuest.email || null,\n                first_name: bookedByGuest.firstName,\n                last_name: bookedByGuest.lastName,\n                country_id: bookedByGuest.countryId === '' ? null : bookedByGuest.countryId,\n                city: null,\n                mobile: bookedByGuest.mobile === null ? '' : this.hasUnderscore(bookedByGuest.mobile) ? '' : bookedByGuest.mobile,\n                country_phone_prefix: bookedByGuest?.phone_prefix ?? null,\n                address: '',\n                dob: null,\n                // subscribe_to_news_letter: bookedByGuest.emailGuest || false,\n                cci: bookedByGuest.cardNumber\n                  ? {\n                      nbr: bookedByGuest.cardNumber,\n                      holder_name: bookedByGuest.cardHolderName,\n                      expiry_month: bookedByGuest.expiryMonth,\n                      expiry_year: bookedByGuest.expiryYear,\n                    }\n                  : null,\n              },\n            },\n            pickup_info: null,\n          };\n          break;\n        }\n      }\n      return newBooking;\n    } catch (error) {\n      console.error(error);\n    }\n  }\n}\n"]}