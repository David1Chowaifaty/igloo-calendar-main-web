{"version":3,"file":"ir-otp-modal.js","sourceRoot":"","sources":["../../../src/components/ir-otp-modal/ir-otp-modal.tsx"],"names":[],"mappings":"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","sourcesContent":["import Token from '@/models/Token';\nimport { SystemService } from '@/services/system.service';\nimport { Component, Event, EventEmitter, Fragment, Host, Listen, Method, Prop, State, Watch, h } from '@stencil/core';\nimport { z } from 'zod';\n\n@Component({\n  tag: 'ir-otp-modal',\n  styleUrl: 'ir-otp-modal.css',\n  scoped: false,\n})\nexport class IrOtpModal {\n  /** Number of seconds to wait before allowing OTP resend */\n  @Prop() resendTimer = 60;\n\n  /** URL or endpoint used to validate the OTP */\n  @Prop() requestUrl: string;\n  /** URL or endpoint used to validate the OTP */\n  @Prop() baseOTPUrl: string;\n\n  /** Whether the resend option should be visible */\n  @Prop() showResend: boolean = true;\n\n  /** User's email address to display in the modal and send the OTP to */\n  @Prop() email: string;\n\n  /** Number of digits the OTP should have */\n  @Prop() otpLength: number = 6;\n\n  /** ticket for verifying and resending the verification code */\n  @Prop() ticket: string;\n\n  @State() otp = '';\n  @State() error = '';\n  @State() isLoading = false;\n  @State() timer = 60;\n\n  private dialogRef: HTMLDialogElement;\n\n  private timerInterval: number;\n  private systemService = new SystemService();\n  private tokenService = new Token();\n\n  private otpVerificationSchema = z.object({ email: z.string().nonempty(), requestUrl: z.string().nonempty(), otp: z.string().length(this.otpLength) });\n\n  /** Emits the final OTP (or empty on cancel) */\n  @Event({ bubbles: true, composed: true }) otpFinished: EventEmitter<{\n    otp: string;\n    type: 'success' | 'cancelled';\n  }>;\n\n  componentWillLoad() {\n    if (this.ticket) {\n      this.tokenService.setToken(this.ticket);\n    }\n  }\n  @Watch('ticket')\n  handleTicketChange(newValue: string, oldValue: string) {\n    if (newValue !== oldValue) {\n      this.tokenService.setToken(newValue);\n    }\n  }\n  @Listen('keydown', { target: 'document' })\n  handleKeyDownChange(e: KeyboardEvent) {\n    if (e.key === 'Escape' && this.dialogRef?.open) {\n      e.preventDefault();\n    }\n  }\n  /** Open & reset everything */\n  @Method()\n  async openModal() {\n    this.resetState();\n    // $(this.modalRef).modal({ backdrop: 'static', keyboard: false });\n    // $(this.modalRef).modal('show');\n    if (typeof this.dialogRef.showModal === 'function') {\n      this.dialogRef.showModal();\n    } else {\n      // fallback for browsers without dialog support\n      this.dialogRef.setAttribute('open', '');\n    }\n    if (this.showResend) this.startTimer();\n    await this.focusFirstInput();\n  }\n\n  /** Hide & clear timer */\n  @Method()\n  async closeModal() {\n    // $(this.modalRef).modal('hide');\n    if (typeof this.dialogRef.close === 'function') {\n      this.dialogRef.close();\n    } else {\n      this.dialogRef.removeAttribute('open');\n    }\n    this.otp = null;\n    this.clearTimer();\n  }\n\n  private resetState() {\n    this.otp = '';\n    this.error = '';\n    this.isLoading = false;\n    this.timer = 60;\n    this.clearTimer();\n  }\n\n  private startTimer() {\n    this.clearTimer();\n    this.timerInterval = window.setInterval(() => {\n      if (this.timer > 0) {\n        this.timer--;\n      } else {\n        this.clearTimer();\n      }\n    }, 1000);\n  }\n\n  private clearTimer() {\n    if (this.timerInterval) {\n      clearInterval(this.timerInterval);\n      this.timerInterval = null;\n    }\n  }\n\n  private async focusFirstInput() {\n    await new Promise(r => setTimeout(r, 50));\n    const first = this.dialogRef.querySelector('input');\n    first && (first as HTMLInputElement).focus();\n  }\n\n  private handleOtpComplete = (e: CustomEvent<string>) => {\n    this.error = '';\n    this.otp = e.detail;\n  };\n\n  private async verifyOtp() {\n    if (this.otp.length < this.otpLength) return;\n    this.isLoading = true;\n    this.otpVerificationSchema.parse({\n      otp: this.otp,\n      requestUrl: this.requestUrl,\n      email: this.email,\n    });\n    try {\n      await this.systemService.validateOTP({ METHOD_NAME: this.requestUrl, OTP: this.otp });\n      this.otpFinished.emit({ otp: this.otp, type: 'success' });\n      this.closeModal();\n    } catch (err) {\n      this.error = 'Verification failed. Please try again.';\n    } finally {\n      this.isLoading = false;\n    }\n  }\n\n  private async resendOtp() {\n    if (this.timer > 0) return;\n    // Resend otp\n    try {\n      await this.systemService.resendOTP({ METHOD_NAME: this.requestUrl });\n      this.timer = 60;\n      this.startTimer();\n    } catch (error) {\n      console.log(error);\n    }\n  }\n  private handleCancelClicked() {\n    if (this.baseOTPUrl === 'Check_OTP_Necessity') {\n      this.closeModal();\n      this.otpFinished.emit({\n        otp: null,\n        type: 'cancelled',\n      });\n      return;\n    }\n    window.location.reload();\n  }\n  disconnectedCallback() {\n    this.clearTimer();\n  }\n  render() {\n    return (\n      <Host>\n        <dialog ref={el => (this.dialogRef = el)} class=\"otp-modal\" aria-modal=\"true\">\n          <form method=\"dialog\" class=\"otp-modal-content\">\n            <header class=\"otp-modal-header\">\n              <h5 class=\"otp-modal-title\">Verify Your Identity</h5>\n            </header>\n\n            <section class=\"otp-modal-body d-flex align-items-center flex-column\">\n              <p class=\"verification-message text-truncate\">We sent a verification code to {this.email}</p>\n              <ir-otp autoFocus length={this.otpLength} defaultValue={this.otp} onOtpComplete={this.handleOtpComplete}></ir-otp>\n\n              {this.error && <p class=\"text-danger small mt-1 p-0 mb-0\">{this.error}</p>}\n\n              {this.showResend && (\n                <Fragment>\n                  {this.timer > 0 ? (\n                    <p class=\"small mt-1\">Resend code in 00:{String(this.timer).padStart(2, '0')}</p>\n                  ) : (\n                    <ir-button\n                      class=\"mt-1\"\n                      btn_color=\"link\"\n                      onClickHandler={e => {\n                        e.stopImmediatePropagation();\n                        e.stopPropagation();\n                        this.resendOtp();\n                      }}\n                      size=\"sm\"\n                      text=\"Didnâ€™t receive code? Resend\"\n                    ></ir-button>\n                  )}\n                </Fragment>\n              )}\n            </section>\n\n            <footer class=\"otp-modal-footer justify-content-auto\">\n              <ir-button class=\"w-100\" btn_styles=\"flex-fill\" text=\"Cancel\" btn_color=\"secondary\" onClick={this.handleCancelClicked.bind(this)}></ir-button>\n              <ir-button\n                class=\"w-100\"\n                btn_styles=\"flex-fill\"\n                text=\"Verify now\"\n                isLoading={this.isLoading}\n                btn_disabled={this.otp?.length < this.otpLength || this.isLoading}\n                onClick={() => this.verifyOtp()}\n              ></ir-button>\n            </footer>\n          </form>\n        </dialog>\n      </Host>\n    );\n  }\n}\n"]}