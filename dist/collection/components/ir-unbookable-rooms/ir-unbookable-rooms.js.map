{"version":3,"file":"ir-unbookable-rooms.js","sourceRoot":"","sources":["../../../src/components/ir-unbookable-rooms/ir-unbookable-rooms.tsx"],"names":[],"mappings":"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","sourcesContent":["import { Component, Host, Prop, State, Watch, h } from '@stencil/core';\nimport Token from '@/models/Token';\nimport { AllowedProperties, FetchUnBookableRoomsResult, PropertyService } from '@/services/property.service';\n\ntype UnbookableRoomsMode = 'default' | 'mpo';\ntype UnbookableRoomsFilters = { period_to_check: number; consecutive_period: number; country: string };\n\n@Component({\n  tag: 'ir-unbookable-rooms',\n  styleUrl: 'ir-unbookable-rooms.css',\n  scoped: true,\n})\nexport class IrUnbookableRooms {\n  @Prop() ticket: string = '';\n  @Prop() propertyid: number;\n  @Prop({ reflect: true }) mode: UnbookableRoomsMode = 'default';\n  //number in months\n  @Prop() period_to_check: number = 2;\n  //number in days\n  @Prop() consecutive_period: number = 14;\n\n  @State() isLoading = false;\n  @State() errorMessage: string = '';\n  @State() unbookableRooms: FetchUnBookableRoomsResult = [];\n  @State() allowedProperties: AllowedProperties = null;\n  @State() filters: UnbookableRoomsFilters = { period_to_check: 2, consecutive_period: 14, country: 'all' };\n  @State() progressFilters = { period_to_check: 2, consecutive_period: 14 };\n  @State() lastUpdatedLabel = '';\n  @State() isPageLoading = true;\n\n  private tokenService = new Token();\n  private propertyService = new PropertyService();\n\n  componentWillLoad() {\n    this.filters = {\n      country: 'all',\n      period_to_check: this.normalizePositiveNumber(this.period_to_check, 2),\n      consecutive_period: this.normalizePositiveNumber(this.consecutive_period, 14),\n    };\n\n    if (this.ticket) {\n      this.tokenService.setToken(this.ticket);\n      this.initializeApp();\n    }\n  }\n\n  @Watch('ticket')\n  ticketChanged(newValue: string, oldValue: string) {\n    if (newValue === oldValue) {\n      return;\n    }\n    this.tokenService.setToken(this.ticket);\n    this.initializeApp();\n  }\n\n  @Watch('mode')\n  modeChanged(newValue: UnbookableRoomsMode, oldValue: UnbookableRoomsMode) {\n    if (newValue === oldValue) {\n      return;\n    }\n    this.initializeApp();\n  }\n\n  @Watch('property_id')\n  propertyIdChanged(newValue: number, oldValue: number) {\n    if (newValue === oldValue) {\n      return;\n    }\n    if (this.resolveMode() === 'default') {\n      this.initializeApp();\n    }\n  }\n\n  @Watch('period_to_check')\n  periodToCheckChanged(newValue: number) {\n    this.filters = { ...this.filters, period_to_check: this.normalizePositiveNumber(newValue, this.filters.period_to_check) };\n  }\n\n  @Watch('consecutive_period')\n  consecutivePeriodChanged(newValue: number) {\n    this.filters = { ...this.filters, consecutive_period: this.normalizePositiveNumber(newValue, this.filters.consecutive_period) };\n  }\n\n  private normalizePositiveNumber(value: number, fallback: number) {\n    const parsed = Number(value);\n    if (Number.isFinite(parsed) && parsed > 0) {\n      return Math.floor(parsed);\n    }\n    return fallback;\n  }\n\n  private resolveMode(): UnbookableRoomsMode {\n    return this.mode === 'mpo' ? 'mpo' : 'default';\n  }\n\n  private async initializeApp() {\n    if (!this.ticket) {\n      return;\n    }\n    try {\n      this.errorMessage = '';\n      this.isLoading = true;\n      this.unbookableRooms = [];\n\n      if (this.resolveMode() === 'mpo') {\n        this.allowedProperties = await this.propertyService.getExposedAllowedProperties();\n      } else {\n        this.allowedProperties = null;\n      }\n\n      await this.fetchUnbookableRooms();\n    } catch (error) {\n      console.error('Failed to load unbookable rooms', error);\n      this.errorMessage = 'Unable to load unbookable rooms right now. Please try again.';\n    } finally {\n      this.isLoading = false;\n      if (this.isPageLoading) {\n        this.isPageLoading = false;\n      }\n    }\n  }\n\n  private async fetchUnbookableRooms() {\n    const propertyIds = this.getPropertyIds();\n    if (!propertyIds.length) {\n      this.unbookableRooms = [];\n      this.errorMessage = this.resolveMode() === 'mpo' ? 'No properties available to check.' : 'Property ID is required to load unbookable rooms.';\n      return;\n    }\n\n    const results = await this.propertyService.fetchUnBookableRooms({\n      property_ids: propertyIds,\n      period_to_check: this.filters.period_to_check * 30,\n      consecutive_period: this.filters.consecutive_period,\n    });\n\n    this.unbookableRooms = results ?? [];\n    this.lastUpdatedLabel = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\n  }\n\n  private getPropertyIds(): number[] {\n    if (this.resolveMode() === 'mpo') {\n      return this.allowedProperties?.map(property => property.id) ?? [];\n    }\n    const propertyId = Number(this.propertyid);\n    return Number.isFinite(propertyId) && propertyId > 0 ? [propertyId] : [];\n  }\n\n  private handleFiltersChange = (event: CustomEvent<Partial<UnbookableRoomsFilters>>) => {\n    this.filters = { ...this.filters, ...event.detail };\n  };\n\n  private handleRefresh = async () => {\n    this.isLoading = true;\n    this.errorMessage = '';\n    try {\n      if (this.resolveMode() === 'mpo' && !this.allowedProperties) {\n        this.allowedProperties = await this.propertyService.getExposedAllowedProperties();\n      }\n      await this.fetchUnbookableRooms();\n      this.progressFilters = {\n        period_to_check: this.filters.period_to_check,\n        consecutive_period: this.filters.consecutive_period,\n      };\n    } catch (error) {\n      console.error('Failed to refresh unbookable rooms', error);\n      this.errorMessage = 'Unable to refresh unbookable rooms right now.';\n    } finally {\n      this.isLoading = false;\n    }\n  };\n  private handleFiltersReset = () => {\n    this.filters = {\n      country: 'all',\n      consecutive_period: 14,\n      period_to_check: 2,\n    };\n    this.handleRefresh();\n  };\n\n  render() {\n    if (this.isPageLoading) {\n      return <ir-loading-screen></ir-loading-screen>;\n    }\n    const totalIssues = this.unbookableRooms?.length ?? 0;\n    const propertiesWithIssues = new Set(this.unbookableRooms?.map(entry => entry.property_id)).size;\n    return (\n      <Host>\n        <ir-toast></ir-toast>\n        <ir-interceptor></ir-interceptor>\n        <section class=\"ir-page__container\">\n          <h3 class=\"page-title\">Availability Alert</h3>\n\n          {this.mode === 'mpo' && (\n            <section class=\"summary\" aria-live=\"polite\">\n              <wa-card>\n                <span class=\"summary__value\">{totalIssues}</span>\n                <span class=\"summary__label\">room types affected</span>\n              </wa-card>\n              <wa-card>\n                <span class=\"summary__value\">{propertiesWithIssues}</span>\n                <span class=\"summary__label\">properties impacted</span>\n              </wa-card>\n            </section>\n          )}\n\n          {/* {this.errorMessage && <p class=\"error\">{this.errorMessage}</p>} */}\n\n          <section class=\"unbookable-rooms__content\">\n            <ir-unbookable-rooms-filters\n              mode={this.mode}\n              filters={this.filters}\n              unbookableRooms={this.unbookableRooms}\n              isLoading={this.isLoading}\n              onFiltersChange={this.handleFiltersChange}\n              onFiltersReset={this.handleFiltersReset}\n              onFiltersSave={this.handleRefresh}\n            ></ir-unbookable-rooms-filters>\n            <ir-unbookable-rooms-data\n              mode={this.mode}\n              isLoading={this.isLoading}\n              errorMessage={this.errorMessage}\n              unbookableRooms={this.unbookableRooms}\n              allowedProperties={this.allowedProperties}\n              filters={this.filters}\n              progressFilters={this.progressFilters}\n            ></ir-unbookable-rooms-data>\n          </section>\n        </section>\n      </Host>\n    );\n  }\n}\n"]}